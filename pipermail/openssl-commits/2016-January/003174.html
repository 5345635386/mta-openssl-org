<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [openssl-commits] [openssl]  master update
   </TITLE>
   <LINK REL="Index" HREF="https://mta.openssl.org/pipermail/openssl-commits/2016-January/index.html" >
   <LINK REL="made" HREF="mailto:openssl-commits%40openssl.org?Subject=Re%3A%20%5Bopenssl-commits%5D%20%5Bopenssl%5D%20%20master%20update&In-Reply-To=%3C1453745242.396435.861.nullmailer%40dev.openssl.org%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="003171.html">
   <LINK REL="Next"  HREF="003176.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[openssl-commits] [openssl]  master update</H1>
    <B>Richard Levitte</B> 
    <A HREF="mailto:openssl-commits%40openssl.org?Subject=Re%3A%20%5Bopenssl-commits%5D%20%5Bopenssl%5D%20%20master%20update&In-Reply-To=%3C1453745242.396435.861.nullmailer%40dev.openssl.org%3E"
       TITLE="[openssl-commits] [openssl]  master update">levitte at openssl.org
       </A><BR>
    <I>Mon Jan 25 18:07:22 UTC 2016</I>
    <P><UL>
        <LI>Previous message: <A HREF="003171.html">[openssl-commits] [openssl]  master update
</A></li>
        <LI>Next message: <A HREF="003176.html">[openssl-commits] [openssl]  master update
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3174">[ date ]</a>
              <a href="thread.html#3174">[ thread ]</a>
              <a href="subject.html#3174">[ subject ]</a>
              <a href="author.html#3174">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>The branch master has been updated
       via  9e4d6fbf3d061449b3c42b0b64b511221ba6483b (commit)
       via  107b5792b24ae701df442cd36bda785cbaf1bfdc (commit)
      from  e8cdcd52b33605b44390888e6aaa0548ca877b46 (commit)


- Log -----------------------------------------------------------------
commit 9e4d6fbf3d061449b3c42b0b64b511221ba6483b
Author: Richard Levitte &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">richard at levitte.org</A>&gt;
Date:   Sat Jan 23 22:58:51 2016 +0100

    Remove GOST again
    
    The config for the removed GOST engine reappeared by mistake.  Now
    removed again.
    
    Reviewed-by: Viktor Dukhovni &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">viktor at openssl.org</A>&gt;

commit 107b5792b24ae701df442cd36bda785cbaf1bfdc
Author: Richard Levitte &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">levitte at openssl.org</A>&gt;
Date:   Wed May 20 20:03:20 2015 +0200

    Refactor file writing - Remake Makefile.org into a template
    
    It is time for Makefile.org to fold into the new regime and have a run
    through util/dofile.pl.  This forces some information out of there and
    into Configure, which isn't a bad thing, it makes Configure
    increasingly the center of build information, which is as it should
    be.
    
    A few extra defaults were needed in the BASE template to get rid of
    warnings about missing values.
    
    Reviewed-by: Viktor Dukhovni &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">viktor at openssl.org</A>&gt;

-----------------------------------------------------------------------

Summary of changes:
 Configurations/00-base-templates.conf |   4 +
 Configure                             | 532 ++++++++++++++++------------------
 Makefile.in                           | 126 ++++----
 util/dofile.pl                        |   1 +
 4 files changed, 318 insertions(+), 345 deletions(-)

diff --git a/Configurations/00-base-templates.conf b/Configurations/00-base-templates.conf
index 90633c4..c5ff592 100644
--- a/Configurations/00-base-templates.conf
+++ b/Configurations/00-base-templates.conf
@@ -20,6 +20,10 @@
 	poly1305_obj	=&gt; &quot;&quot;,
 
 	unistd		=&gt; &quot;&lt;unistd.h&gt;&quot;,
+	shared_target	=&gt; &quot;&quot;,
+	shared_cflag	=&gt; &quot;&quot;,
+	shared_ldflag	=&gt; &quot;&quot;,
+	shared_extension	=&gt; &quot;&quot;,
 	build_scheme	=&gt; &quot;unixmake&quot;,
     },
 
diff --git a/Configure b/Configure
index e717eb3..20ee02d 100755
--- a/Configure
+++ b/Configure
@@ -167,6 +167,35 @@ sub read_config;
 sub resolve_config;
 
 
+# Information collection #############################################
+
+# Collect version numbers
+$config{version} = &quot;unknown&quot;;
+$config{version_num} = &quot;unknown&quot;;
+$config{shlib_version_number} = &quot;unknown&quot;;
+$config{shlib_version_history} = &quot;unknown&quot;;
+
+collect_information(
+    '&lt;include/openssl/opensslv.h',
+    undef,
+    qr/OPENSSL.VERSION.TEXT.*OpenSSL (\S+) / =&gt; sub { $config{version} = $1; },
+    qr/OPENSSL.VERSION.NUMBER.*(0x\S+)/	     =&gt; sub { $config{version_num}=$1 },
+    qr/SHLIB_VERSION_NUMBER *&quot;([^&quot;]+)&quot;/	     =&gt; sub { $config{shlib_version_number}=$1 },
+    qr/SHLIB_VERSION_HISTORY *&quot;([^&quot;]*)&quot;/     =&gt; sub { $config{shlib_version_history}=$1 }
+    );
+if ($config{shlib_version_history} ne &quot;&quot;) { $config{shlib_version_history} .= &quot;:&quot;; }
+
+($config{major}, $config{minor})
+    = ($config{version} =~ /^([0-9]+)\.([0-9\.]+)/);
+($config{shlib_major}, $config{shlib_minor})
+    = ($config{shlib_version_number} =~ /^([0-9]+)\.([0-9\.]+)/);
+die &quot;erroneous version information in opensslv.h: &quot;,
+    &quot;$config{major}, $config{minor}, $config{shlib_major}, $config{shlib_minor}\n&quot;
+    if ($config{major} eq &quot;&quot; || $config{minor} eq &quot;&quot;
+	|| $config{shlib_major} eq &quot;&quot; ||  $config{shlib_minor} eq &quot;&quot;);
+
+# Collect target configurations
+
 my ($vol, $dir, $dummy) = File::Spec-&gt;splitpath($0);
 my $pattern = File::Spec-&gt;catpath($vol, $dir, &quot;Configurations/*.conf&quot;);
 foreach (sort glob($pattern) ) {
@@ -174,17 +203,18 @@ foreach (sort glob($pattern) ) {
 }
 
 
+print &quot;Configuring OpenSSL version $config{version} (0x$config{version_num})\n&quot;;
+
 $config{perl};
 $config{prefix}=&quot;&quot;;
 $config{openssldir}=&quot;&quot;;
 $config{processor}=&quot;&quot;;
-my $libdir=&quot;&quot;;
-my $exe_ext=&quot;&quot;;
-my $install_prefix= &quot;$ENV{'INSTALL_PREFIX'}&quot;;
+$config{libdir}=&quot;&quot;;
+$config{install_prefix}= &quot;$ENV{'INSTALL_PREFIX'}&quot;;
 $config{cross_compile_prefix}=&quot;&quot;;
-my $fipslibdir=&quot;/usr/local/ssl/fips-2.0/lib/&quot;;
+$config{fipslibdir}=&quot;/usr/local/ssl/fips-2.0/lib/&quot;;
 my $nofipscanistercheck=0;
-my $baseaddr=&quot;0xFB00000&quot;;
+$config{baseaddr}=&quot;0xFB00000&quot;;
 my $no_threads=0;
 my $threads=0;
 $config{no_shared}=0; # but &quot;no-shared&quot; is default
@@ -192,10 +222,22 @@ my $zlib=1;      # but &quot;no-zlib&quot; is default
 my $no_rfc3779=0;
 my $no_asm=0;
 my $no_dso=0;
-my @skip=();
 my $Makefile=&quot;Makefile&quot;;
 my $default_ranlib;
-my $fips=0;
+$config{fips}=0;
+
+# Top level directories to build
+$config{dirs} = [ &quot;crypto&quot;, &quot;ssl&quot;, &quot;engines&quot;, &quot;apps&quot;, &quot;test&quot;, &quot;tools&quot; ];
+# crypto/ subdirectories to build
+$config{sdirs} = [
+    &quot;objects&quot;,
+    &quot;md2&quot;, &quot;md4&quot;, &quot;md5&quot;, &quot;sha&quot;, &quot;mdc2&quot;, &quot;hmac&quot;, &quot;ripemd&quot;, &quot;whrlpool&quot;, &quot;poly1305&quot;,
+    &quot;des&quot;, &quot;aes&quot;, &quot;rc2&quot;, &quot;rc4&quot;, &quot;rc5&quot;, &quot;idea&quot;, &quot;bf&quot;, &quot;cast&quot;, &quot;camellia&quot;, &quot;seed&quot;, &quot;chacha&quot;, &quot;modes&quot;,
+    &quot;bn&quot;, &quot;ec&quot;, &quot;rsa&quot;, &quot;dsa&quot;, &quot;dh&quot;, &quot;dso&quot;, &quot;engine&quot;,
+    &quot;buffer&quot;, &quot;bio&quot;, &quot;stack&quot;, &quot;lhash&quot;, &quot;rand&quot;, &quot;err&quot;,
+    &quot;evp&quot;, &quot;asn1&quot;, &quot;pem&quot;, &quot;x509&quot;, &quot;x509v3&quot;, &quot;conf&quot;, &quot;txt_db&quot;, &quot;pkcs7&quot;, &quot;pkcs12&quot;, &quot;comp&quot;, &quot;ocsp&quot;, &quot;ui&quot;,
+    &quot;cms&quot;, &quot;ts&quot;, &quot;jpake&quot;, &quot;srp&quot;, &quot;store&quot;, &quot;cmac&quot;, &quot;ct&quot;, &quot;async&quot;, &quot;kdf&quot;
+    ];
 
 # Known TLS and DTLS protocols
 my @tls = qw(ssl3 tls1 tls1_1 tls1_2);
@@ -233,7 +275,6 @@ my @disablables = (
     &quot;ec_nistp_64_gcc_128&quot;,
     &quot;engine&quot;,
     &quot;err&quot;,			# Really???
-    &quot;gost&quot;,
     &quot;heartbeats&quot;,
     &quot;hmac&quot;,
     &quot;hw(-.+)?&quot;,
@@ -316,9 +357,7 @@ my @disable_cascades = (
     &quot;zlib&quot;		=&gt; [ &quot;zlib-dynamic&quot; ],
     &quot;rijndael&quot;		=&gt; [ &quot;aes&quot; ],
     &quot;des&quot;		=&gt; [ &quot;mdc2&quot; ],
-    &quot;ec&quot;		=&gt; [ &quot;ecdsa&quot;, &quot;ecdh&quot;, &quot;gost&quot; ],
-    &quot;dsa&quot;		=&gt; [ &quot;gost&quot; ],
-    &quot;dh&quot;		=&gt; [ &quot;gost&quot; ],
+    &quot;ec&quot;		=&gt; [ &quot;ecdsa&quot;, &quot;ecdh&quot; ],
     &quot;psk&quot;		=&gt; [ &quot;jpake&quot; ],
 
     &quot;dgram&quot;		=&gt; [ &quot;dtls&quot; ],
@@ -366,10 +405,10 @@ while ((my $first, my $second) = (shift @list, shift @list)) {
     unshift @list, $second;
 }
 
-# Construct the string of what $depflags should look like with the defaults
+# Construct the string of what $config{depflags} should look like with the defaults
 # from %disabled above.  (we need this to see if we should advise the user
 # to run &quot;make depend&quot;):
-my $default_depflags = &quot; &quot;.join(&quot; &quot;,
+my $default_depflags = join(&quot; &quot;,
     map { my $x = $_; $x =~ tr{[a-z]-}{[A-Z]_}; &quot;-DOPENSSL_NO_$x&quot;; }
     grep { $disabled{$_} !~ /\(no-depflags\)$/ }
     sort keys %disabled);
@@ -388,7 +427,7 @@ my $no_sse2=0;
 &amp;usage if ($#ARGV &lt; 0);
 
 my $flags=&quot;&quot;;
-my $depflags=&quot;&quot;;
+$config{depflags}=&quot;&quot;;
 $config{openssl_experimental_defines}=[];
 $config{openssl_api_defines}=[];
 $config{openssl_algorithm_defines}=[];
@@ -398,7 +437,6 @@ $config{openssl_other_defines}=[];
 my $libs=&quot;&quot;;
 my $target=&quot;&quot;;
 $config{options}=&quot;&quot;;
-my $api;
 my $make_depend=0;
 my %withargs=();
 my $build_prefix = &quot;release_&quot;;
@@ -544,7 +582,7 @@ foreach (@argvcopy)
 		{ $config{processor}=386; }
 	elsif (/^fips$/)
 		{
-		$fips=1;
+		$config{fips}=1;
 		}
 	elsif (/^rsaref$/)
 		{
@@ -554,7 +592,7 @@ foreach (@argvcopy)
 		}
 	elsif (/^nofipscanistercheck$/)
 		{
-		$fips = 1;
+		$config{fips} = 1;
 		$nofipscanistercheck = 1;
 		}
 	elsif (/^[-+]/)
@@ -565,11 +603,11 @@ foreach (@argvcopy)
 			}
 		elsif (/^--api=(.*)$/)
 			{
-			$api=$1;
+			$config{api}=$1;
 			}
 		elsif (/^--libdir=(.*)$/)
 			{
-			$libdir=$1;
+			$config{libdir}=$1;
 			}
 		elsif (/^--openssldir=(.*)$/)
 			{
@@ -577,7 +615,7 @@ foreach (@argvcopy)
 			}
 		elsif (/^--install.prefix=(.*)$/)
 			{
-			$install_prefix=$1;
+			$config{install_prefix}=$1;
 			}
 		elsif (/^--with-zlib-lib=(.*)$/)
 			{
@@ -589,11 +627,11 @@ foreach (@argvcopy)
 			}
 		elsif (/^--with-fipslibdir=(.*)$/)
 			{
-			$fipslibdir=&quot;$1/&quot;;
+			$config{fipslibdir}=&quot;$1/&quot;;
 			}
 		elsif (/^--with-baseaddr=(.*)$/)
 			{
-			$baseaddr=&quot;$1&quot;;
+			$config{baseaddr}=&quot;$1&quot;;
 			}
 		elsif (/^--cross-compile-prefix=(.*)$/)
 			{
@@ -636,8 +674,8 @@ foreach (@argvcopy)
 			{ $config{options} .= &quot; &quot;.$_; }
 		}
 
-        if (defined($api) &amp;&amp; !exists $apitable-&gt;{$api}) {
-		die &quot;***** Unsupported api compatibility level: $api\n&quot;,
+        if (defined($config{api}) &amp;&amp; !exists $apitable-&gt;{$config{api}}) {
+		die &quot;***** Unsupported api compatibility level: $config{api}\n&quot;,
         }
 
 	if (keys %unsupported_options)
@@ -647,10 +685,14 @@ foreach (@argvcopy)
 		}
 	}
 
-if ($fips)
+if ($config{fips})
 	{
 	delete $disabled{&quot;shared&quot;} if ($disabled{&quot;shared&quot;} =~ /^default/);
 	}
+else
+	{
+	@{$config{dirs}} = grep !/^fips$/, @{$config{dirs}};
+	}
 
 my @tocheckfor = (keys %disabled);
 while (@tocheckfor) {
@@ -714,6 +756,8 @@ foreach (sort (keys %disabled))
 		{ }
 	elsif (/^sse2$/)
 		{ $no_sse2 = 1; }
+	elsif (/^engine$/)
+		{ @{$config{dirs}} = grep !/^engine$/, @{$config{dirs}}; }
 	else
 		{
 		my ($ALGO, $algo);
@@ -732,16 +776,15 @@ foreach (sort (keys %disabled))
 			($ALGO,$algo) = (&quot;RMD160&quot;,&quot;rmd160&quot;) if ($algo eq &quot;ripemd&quot;);
 
 			push @{$config{openssl_algorithm_defines}}, &quot;OPENSSL_NO_$ALGO&quot;;
+			$config{depflags} .= &quot; -DOPENSSL_NO_$ALGO&quot;;
 			print &quot; OPENSSL_NO_$ALGO&quot;;
 
-			push @skip, $algo;
 			# fix-up crypto/directory name(s)
-			$skip[$#skip]=&quot;whrlpool&quot; if $algo eq &quot;whirlpool&quot;;
-			$skip[$#skip]=&quot;ripemd&quot; if $algo eq &quot;rmd160&quot;;
+			$algo=&quot;whrlpool&quot; if $algo eq &quot;whirlpool&quot;;
+			$algo=&quot;ripemd&quot; if $algo eq &quot;rmd160&quot;;
+			@{$config{sdirs}} = grep { $_ ne $algo} @{$config{sdirs}};
 
 			print &quot; (skip dir)&quot;;
-
-			$depflags .= &quot; -DOPENSSL_NO_$ALGO&quot;;
 			}
 		}
 
@@ -778,9 +821,10 @@ my %target = ( %{$table{$base_target}}, resolve_config($target) );
 
 &amp;usage if (!%target || $target{template});
 
-$exe_ext=&quot;.exe&quot; if ($target eq &quot;Cygwin&quot; || $target eq &quot;DJGPP&quot; || $target =~ /^mingw/);
-$exe_ext=&quot;.nlm&quot; if ($target =~ /netware/);
-$exe_ext=&quot;.pm&quot;  if ($target =~ /vos/);
+$target{exe_extension}=&quot;&quot;;
+$target{exe_extension}=&quot;.exe&quot; if ($config{target} eq &quot;Cygwin&quot; || $config{target} eq &quot;DJGPP&quot; || $config{target} =~ /^mingw/);
+$target{exe_extension}=&quot;.nlm&quot; if ($config{target} =~ /netware/);
+$target{exe_extension}=&quot;.pm&quot;  if ($config{target} =~ /vos/);
 
 $default_ranlib	= which(&quot;ranlib&quot;) || &quot;true&quot;;
 $config{perl}	= $ENV{'PERL'} || which(&quot;perl5&quot;) || which(&quot;perl&quot;) || &quot;perl&quot;;
@@ -799,15 +843,17 @@ $target{cc} = $ENV{CC} || $target{cc};
 
 # For cflags and lflags, add the debug_ or release_ attributes
 # Do it in such a way that no spurious space is appended (hence the grep).
-my $cflags = join(&quot; &quot;,
-		  grep { $_ } ($target{cflags},
-			       $target{$build_prefix.&quot;cflags&quot;}));
-my $lflags = join(&quot; &quot;,
-		  grep { $_ } ($target{lflags},
-			       $target{$build_prefix.&quot;lflags&quot;}));
+$config{cflags} = join(&quot; &quot;,
+		       grep { $_ ne &quot;&quot; } ($target{cflags},
+					  $target{$build_prefix.&quot;cflags&quot;}));
+$config{lflags} = join(&quot; &quot;,
+		       grep { $_ ne &quot;&quot; } ($target{lflags},
+					  $target{$build_prefix.&quot;lflags&quot;}));
 
 $target{ranlib} = $ENV{'RANLIB'} || $target{ranlib} || $default_ranlib;
 $target{ar} = $ENV{'AR'} || &quot;ar&quot;;
+$target{arflags} = &quot;&quot; if !defined($target{arflags});
+$target{nm} = &quot;nm&quot;;
 # Make sure build_scheme is consistent.
 $target{build_scheme} = [ $target{build_scheme} ]
     if ref($target{build_scheme}) ne &quot;ARRAY&quot;;
@@ -818,32 +864,32 @@ $target{build_scheme} = [ $target{build_scheme} ]
 # we're ready to tolerate, so don't...
 $target{multilib}=&quot;&quot; if !-d &quot;$config{prefix}/lib$target{multilib}&quot;;
 
-$libdir=&quot;lib$target{multilib}&quot; if $libdir eq &quot;&quot;;
-$config{enginesdir}=$config{prefix} . &quot;/&quot; . $libdir  . &quot;/engines&quot;;
+$config{libdir}=&quot;lib$target{multilib}&quot; if $config{libdir} eq &quot;&quot;;
+$config{enginesdir}=$config{prefix} . &quot;/&quot; . $config{libdir}  . &quot;/engines&quot;;
 
-$cflags = &quot;$cflags$exp_cflags&quot;;
+$config{cflags} .= &quot;$exp_cflags&quot;;
 
-# '%' in $lflags is used to split flags to &quot;pre-&quot; and post-flags
-my ($prelflags,$postlflags)=split('%',$lflags);
-if (defined($postlflags))	{ $lflags=$postlflags;	}
-else				{ $lflags=$prelflags; undef $prelflags;	}
+# '%' in $config{lflags} is used to split flags to &quot;pre-&quot; and post-flags
+my ($pre,$post)=split('%',$config{lflags});
+if (defined($post))	{ $config{prelflags}=$pre; $config{lflags}=$post;	}
+else			{ $config{prelflags}=&quot;&quot;;   $config{lflags}=$pre;	}
 
-if ($target =~ /^mingw/ &amp;&amp; `$target{cc} --target-help 2&gt;&amp;1` !~ m/\-mno\-cygwin/m)
+if ($target =~ /^mingw/ &amp;&amp; `$target{cc} --target-help 2&gt;&amp;1` !~ m/-mno-cygwin/m)
 	{
-	$cflags =~ s/\-mno\-cygwin\s*//;
-	$target{shared_ldflag} =~ s/\-mno\-cygwin\s*//;
+	$config{cflags} =~ s/-mno-cygwin\s*//;
+	$target{shared_ldflag} =~ s/-mno-cygwin\s*//;
 	}
 
-if ($target =~ /linux.*\-mips/ &amp;&amp; !$no_asm &amp;&amp; $flags !~ /\-m(ips|arch=)/) {
+if ($target =~ /linux.*-mips/ &amp;&amp; !$no_asm &amp;&amp; $flags !~ /-m(ips|arch=)/) {
 	# minimally required architecture flags for assembly modules
-	$cflags=&quot;-mips2 $cflags&quot; if ($target =~ /mips32/);
-	$cflags=&quot;-mips3 $cflags&quot; if ($target =~ /mips64/);
+	$config{cflags}=&quot;-mips2 $config{cflags}&quot; if ($target =~ /mips32/);
+	$config{cflags}=&quot;-mips3 $config{cflags}&quot; if ($target =~ /mips64/);
 }
 
 my $no_shared_warn=0;
 my $no_user_cflags=0;
 
-if ($flags ne &quot;&quot;)	{ $cflags=&quot;$flags$cflags&quot;; }
+if ($flags ne &quot;&quot;)	{ $config{cflags}=&quot;$flags$config{cflags}&quot;; }
 else			{ $no_user_cflags=1;       }
 
 # The DSO code currently always implements all functions so that no
@@ -868,7 +914,7 @@ if (!$no_dso &amp;&amp; $target{dso_scheme} ne &quot;&quot;)
 		{
 		$dso_cflags = &quot;-DDSO_$target{dso_scheme}&quot;;
 		}
-	$cflags = &quot;$dso_cflags $cflags&quot;;
+	$config{cflags} = &quot;$dso_cflags $config{cflags}&quot;;
 	}
 
 my $thread_cflags;
@@ -889,12 +935,12 @@ if ($target{thread_cflag} eq &quot;(unknown)&quot; &amp;&amp; $threads)
 		print &quot;provide any system-specific compiler options\n&quot;;
 		exit(1);
 		}
-	$thread_cflags=&quot;-DOPENSSL_THREADS $cflags&quot; ;
+	$thread_cflags=&quot;-DOPENSSL_THREADS $config{cflags}&quot; ;
 	push @thread_defines, &quot;OPENSSL_THREADS&quot;;
 	}
 else
 	{
-	$thread_cflags=&quot;-DOPENSSL_THREADS $target{thread_cflag} $cflags&quot;;
+	$thread_cflags=&quot;-DOPENSSL_THREADS $target{thread_cflag} $config{cflags}&quot;;
 	push @thread_defines, &quot;OPENSSL_THREADS&quot;;
 #	my $def;
 #	foreach $def (split ' ',$target{thread_cflag})
@@ -906,57 +952,55 @@ else
 #		}
 	}
 
-$lflags=&quot;$libs$lflags&quot; if ($libs ne &quot;&quot;);
+$config{lflags}=&quot;$libs$config{lflags}&quot; if ($libs ne &quot;&quot;);
 
 if ($no_asm)
 	{
-	$cflags=~s/\-D[BL]_ENDIAN//		if ($fips);
-	$thread_cflags=~s/\-D[BL]_ENDIAN//	if ($fips);
+	$config{cflags}=~s/-D[BL]_ENDIAN//		if ($config{fips});
+	$thread_cflags=~s/-D[BL]_ENDIAN//	if ($config{fips});
 	}
 
 if ($threads)
 	{
-	$cflags=$thread_cflags;
+	$config{cflags}=$thread_cflags;
 	push @{$config{openssl_thread_defines}}, @thread_defines;
 	}
 
 if ($zlib)
 	{
-	$cflags = &quot;-DZLIB $cflags&quot;;
+	$config{cflags} = &quot;-DZLIB $config{cflags}&quot;;
 	if (defined($disabled{&quot;zlib-dynamic&quot;}))
 		{
 		if (defined($withargs{&quot;zlib-lib&quot;}))
 			{
-			$lflags = &quot;$lflags -L&quot; . $withargs{&quot;zlib-lib&quot;} . &quot; -lz&quot;;
+			$config{lflags} .= &quot; -L&quot; . $withargs{&quot;zlib-lib&quot;} . &quot; -lz&quot;;
 			}
 		else
 			{
-			$lflags = &quot;$lflags -lz&quot;;
+			$config{lflags} .= &quot; -lz&quot;;
 			}
 		}
 	else
 		{
-		$cflags = &quot;-DZLIB_SHARED $cflags&quot;;
+		$config{cflags} = &quot;-DZLIB_SHARED $config{cflags}&quot;;
 		}
 	}
 
 # With &quot;deprecated&quot; disable all deprecated features.
 if (defined($disabled{&quot;deprecated&quot;})) {
-        $api = $maxapi;
+        $config{api} = $maxapi;
 }
 
-# You will find shlib_mark1 and shlib_mark2 explained in Makefile.in
-my $shared_mark = &quot;&quot;;
 if ($target{shared_target} eq &quot;&quot;)
 	{
-	$no_shared_warn = 1 if !$config{no_shared} &amp;&amp; !$fips;
+	$no_shared_warn = 1 if !$config{no_shared} &amp;&amp; !$config{fips};
 	$config{no_shared} = 1;
 	}
 if (!$config{no_shared})
 	{
 	if ($target{shared_cflag} ne &quot;&quot;)
 		{
-		$cflags = &quot;$target{shared_cflag} -DOPENSSL_PIC $cflags&quot;;
+		$config{cflags} = &quot;$target{shared_cflag} -DOPENSSL_PIC $config{cflags}&quot;;
 		}
 	}
 
@@ -978,7 +1022,7 @@ if ($target{build_scheme}-&gt;[0] ne &quot;mk1mf&quot;)
 #
 # Platform fix-ups
 #
-if ($target =~ /\-icc$/)	# Intel C compiler
+if ($target =~ /-icc$/)	# Intel C compiler
 	{
 	my $iccver=0;
 	if (open(FD,&quot;$target{cc} -V 2&gt;&amp;1 |&quot;))
@@ -988,25 +1032,25 @@ if ($target =~ /\-icc$/)	# Intel C compiler
 		}
 	if ($iccver&gt;=8)
 		{
-		$cflags=~s/\-KPIC/-fPIC/;
+		$config{cflags}=~s/-KPIC/-fPIC/;
 		# Eliminate unnecessary dependency from libirc.a. This is
 		# essential for shared library support, as otherwise
 		# apps/openssl can end up in endless loop upon startup...
-		$cflags.=&quot; -Dmemcpy=__builtin_memcpy -Dmemset=__builtin_memset&quot;;
+		$config{cflags}.=&quot; -Dmemcpy=__builtin_memcpy -Dmemset=__builtin_memset&quot;;
 		}
 	if ($iccver&gt;=9)
 		{
-		$lflags.=&quot; -i-static&quot;;
-		$lflags=~s/\-no_cpprt/-no-cpprt/;
+		$config{lflags}.=&quot; -i-static&quot;;
+		$config{lflags}=~s/-no_cpprt/-no-cpprt/;
 		}
 	if ($iccver&gt;=10)
 		{
-		$lflags=~s/\-i\-static/-static-intel/;
+		$config{lflags}=~s/-i-static/-static-intel/;
 		}
 	if ($iccver&gt;=11)
 		{
-		$cflags.=&quot; -no-intel-extensions&quot;;	# disable Cilk
-		$lflags=~s/\-no\-cpprt/-no-cxxlib/;
+		$config{cflags}.=&quot; -no-intel-extensions&quot;;	# disable Cilk
+		$config{lflags}=~s/-no-cpprt/-no-cxxlib/;
 		}
 	}
 
@@ -1018,14 +1062,14 @@ if ($target =~ /\-icc$/)	# Intel C compiler
 # should engrave this into Makefile.shared rules or into BSD-* config
 # lines above. Meanwhile let's try to be cautious and pass -rpath to
 # linker only when --prefix is not /usr.
-if ($target =~ /^BSD\-/)
+if ($target =~ /^BSD-/)
 	{
 	$target{shared_ldflag}.=&quot; -Wl,-rpath,\$\$(LIBRPATH)&quot; if ($config{prefix} !~ m|^/usr[/]*$|);
 	}
 
 if ($target{sys_id} ne &quot;&quot;)
 	{
-	#$cflags=&quot;-DOPENSSL_SYS_$target{sys_id} $cflags&quot;;
+	#$config{cflags}=&quot;-DOPENSSL_SYS_$target{sys_id} $config{cflags}&quot;;
 	push @{$config{openssl_sys_defines}}, &quot;OPENSSL_SYS_$target{sys_id}&quot;;
 	}
 
@@ -1036,68 +1080,95 @@ if ($target{ranlib} eq &quot;&quot;)
 
 if (!$no_asm) {
     $target{cpuid_obj}=$table{BASE}-&gt;{cpuid_obj} if ($config{processor} eq &quot;386&quot;);
-    $target{cpuid_obj}.=&quot; uplink.o uplink-x86.o&quot; if ($cflags =~ /\-DOPENSSL_USE_APPLINK/);
+    $target{cpuid_obj}.=&quot; uplink.o uplink-x86.o&quot; if ($config{cflags} =~ /-DOPENSSL_USE_APPLINK/);
 
     $target{bn_obj} =~ s/\w+-gf2m.o// if (defined($disabled{ec2m}));
 
     # bn-586 is the only one implementing bn_*_part_words
-    $cflags.=&quot; -DOPENSSL_BN_ASM_PART_WORDS&quot; if ($target{bn_obj} =~ /bn-586/);
-    $cflags.=&quot; -DOPENSSL_IA32_SSE2&quot; if (!$no_sse2 &amp;&amp; $target{bn_obj} =~ /86/);
+    $config{cflags}.=&quot; -DOPENSSL_BN_ASM_PART_WORDS&quot; if ($target{bn_obj} =~ /bn-586/);
+    $config{cflags}.=&quot; -DOPENSSL_IA32_SSE2&quot; if (!$no_sse2 &amp;&amp; $target{bn_obj} =~ /86/);
 
-    $cflags.=&quot; -DOPENSSL_BN_ASM_MONT&quot; if ($target{bn_obj} =~ /-mont/);
-    $cflags.=&quot; -DOPENSSL_BN_ASM_MONT5&quot; if ($target{bn_obj} =~ /-mont5/);
-    $cflags.=&quot; -DOPENSSL_BN_ASM_GF2m&quot; if ($target{bn_obj} =~ /-gf2m/);
+    $config{cflags}.=&quot; -DOPENSSL_BN_ASM_MONT&quot; if ($target{bn_obj} =~ /-mont/);
+    $config{cflags}.=&quot; -DOPENSSL_BN_ASM_MONT5&quot; if ($target{bn_obj} =~ /-mont5/);
+    $config{cflags}.=&quot; -DOPENSSL_BN_ASM_GF2m&quot; if ($target{bn_obj} =~ /-gf2m/);
 
-    if ($fips) {
+    if ($config{fips}) {
 	push @{$config{openssl_other_defines}}, &quot;OPENSSL_FIPS&quot;;
     }
 
     if ($target{sha1_obj} =~ /\.o$/) {
-	$cflags.=&quot; -DSHA1_ASM&quot;   if ($target{sha1_obj} =~ /sx86/ || $target{sha1_obj} =~ /sha1/);
-	$cflags.=&quot; -DSHA256_ASM&quot; if ($target{sha1_obj} =~ /sha256/);
-	$cflags.=&quot; -DSHA512_ASM&quot; if ($target{sha1_obj} =~ /sha512/);
+	$config{cflags}.=&quot; -DSHA1_ASM&quot;   if ($target{sha1_obj} =~ /sx86/ || $target{sha1_obj} =~ /sha1/);
+	$config{cflags}.=&quot; -DSHA256_ASM&quot; if ($target{sha1_obj} =~ /sha256/);
+	$config{cflags}.=&quot; -DSHA512_ASM&quot; if ($target{sha1_obj} =~ /sha512/);
 	if ($target{sha1_obj} =~ /sse2/) {
 	    if ($no_sse2) {
 		$target{sha1_obj} =~ s/\S*sse2\S+//;
-	    } elsif ($cflags !~ /OPENSSL_IA32_SSE2/) {
-		$cflags.=&quot; -DOPENSSL_IA32_SSE2&quot;;
+	    } elsif ($config{cflags} !~ /OPENSSL_IA32_SSE2/) {
+		$config{cflags}.=&quot; -DOPENSSL_IA32_SSE2&quot;;
 	    }
 	}
     }
     if ($target{md5_obj} =~ /\.o$/) {
-	$cflags.=&quot; -DMD5_ASM&quot;;
+	$config{cflags}.=&quot; -DMD5_ASM&quot;;
     }
     $target{cast_obj}=$table{BASE}-&gt;{cast_obj} if (!$config{no_shared}); # CAST assembler is not PIC
     if ($target{rmd160_obj} =~ /\.o$/) {
-	$cflags.=&quot; -DRMD160_ASM&quot;;
+	$config{cflags}.=&quot; -DRMD160_ASM&quot;;
     }
     if ($target{aes_obj} =~ /\.o$/) {
-	$cflags.=&quot; -DAES_ASM&quot; if ($target{aes_obj} =~ m/\baes\-/);;
+	$config{cflags}.=&quot; -DAES_ASM&quot; if ($target{aes_obj} =~ m/\baes-/);;
 	# aes-ctr.o is not a real file, only indication that assembler
 	# module implements AES_ctr32_encrypt...
-	$cflags.=&quot; -DAES_CTR_ASM&quot; if ($target{aes_obj} =~ s/\s*aes\-ctr\.o//);
+	$config{cflags}.=&quot; -DAES_CTR_ASM&quot; if ($target{aes_obj} =~ s/\s*aes-ctr\.o//);
 	# aes-xts.o indicates presence of AES_xts_[en|de]crypt...
-	$cflags.=&quot; -DAES_XTS_ASM&quot; if ($target{aes_obj} =~ s/\s*aes\-xts\.o//);
-	$target{aes_obj} =~ s/\s*(vpaes|aesni)\-x86\.o//g if ($no_sse2);
-	$cflags.=&quot; -DVPAES_ASM&quot; if ($target{aes_obj} =~ m/vpaes/);
-	$cflags.=&quot; -DBSAES_ASM&quot; if ($target{aes_obj} =~ m/bsaes/);
+	$config{cflags}.=&quot; -DAES_XTS_ASM&quot; if ($target{aes_obj} =~ s/\s*aes-xts\.o//);
+	$target{aes_obj} =~ s/\s*(vpaes|aesni)-x86\.o//g if ($no_sse2);
+	$config{cflags}.=&quot; -DVPAES_ASM&quot; if ($target{aes_obj} =~ m/vpaes/);
+	$config{cflags}.=&quot; -DBSAES_ASM&quot; if ($target{aes_obj} =~ m/bsaes/);
     }
     if ($target{wp_obj} =~ /mmx/ &amp;&amp; $config{processor} eq &quot;386&quot;) {
 	$target{wp_obj}=$table{BASE}-&gt;{wp_obj};
     } elsif (!$disabled{&quot;whirlpool&quot;}) {
-	$cflags.=&quot; -DWHIRLPOOL_ASM&quot;;
+	$config{cflags}.=&quot; -DWHIRLPOOL_ASM&quot;;
     }
-    if ($target{modes_obj} =~ /ghash\-/) {
-	$cflags.=&quot; -DGHASH_ASM&quot;;
+    if ($target{modes_obj} =~ /ghash-/) {
+	$config{cflags}.=&quot; -DGHASH_ASM&quot;;
     }
     if ($target{ec_obj} =~ /ecp_nistz256/) {
-	$cflags.=&quot; -DECP_NISTZ256_ASM&quot;;
+	$config{cflags}.=&quot; -DECP_NISTZ256_ASM&quot;;
     }
     if ($target{poly1305_obj} =~ /\.o$/) {
-	$cflags.=&quot; -DPOLY1305_ASM&quot;;
+	$config{cflags}.=&quot; -DPOLY1305_ASM&quot;;
     }
 }
 
+$config{makedepprog} = &quot;makedepend&quot;;
+if ($target{cc} eq &quot;gcc&quot; || ($target{cc} eq 'cc' &amp;&amp; $config{target} =~ /darwin/)) {
+    $config{makedepprog} = $target{cc};
+}
+# On different platforms, shared library suffixes takes interesting forms.
+# On Most Unixen, it's .so.{version} or .sl.{version}, while on MacOS X,
+# it's .{version}.dylib.  We're want to separate the two so we can calculate
+# symlinks.
+# FIXME: is this actually needed any more?  Makefile.shared seems to just
+# symlink a file name without SOVER to the file with full SOVER, nothing in
+# between.
+if ($target{shared_extension} =~ /^(|(?&lt;e&gt;\.s[ol])(?&lt;v&gt;\..*)|(?&lt;v&gt;\..*)(?&lt;e&gt;\.dylib))$/) {
+    my @vernums = split /\./, $+{v};
+    shift @vernums;             # Because the initial period in shlib_extension.
+    my @s = ();
+    while (@vernums) {
+	pop @vernums;
+	push @s, join(&quot;.&quot;, $+{e} eq &quot;.dylib&quot; ? &quot;&quot; : $+{e},
+		      @vernums,
+		      $+{e} eq &quot;.dylib&quot; ? $+{e} : () );
+    }
+    $config{shared_link_extensions} = join(&quot; &quot;, @s);
+} else {
+    $config{shared_link_extensions} = &quot;&quot;;
+}
+$config{depflags} =~ s/^\s*//;
+
 
 # Deal with bn_ops ###################################################
 
@@ -1157,45 +1228,13 @@ foreach (sort split(/\s+/,$target{bn_ops})) {
 
 # &quot;Stringify&quot; the C flags string.  This permits it to be made part of a string
 # and works as well on command lines.
-$cflags =~ s/([\\\&quot;])/\\\1/g;
-
-$config{version} = &quot;unknown&quot;;
-$config{version_num} = &quot;unknown&quot;;
-$config{major} = &quot;unknown&quot;;
-$config{minor} = &quot;unknown&quot;;
-$config{shlib_version_number} = &quot;unknown&quot;;
-$config{shlib_version_history} = &quot;unknown&quot;;
-$config{shlib_major} = &quot;unknown&quot;;
-$config{shlib_minor} = &quot;unknown&quot;;
-
-open(IN,'&lt;include/openssl/opensslv.h') || die &quot;unable to read opensslv.h:$!\n&quot;;
-while (&lt;IN&gt;)
-	{
-	$config{version}=$1 if /OPENSSL.VERSION.TEXT.*OpenSSL (\S+) /;
-	$config{version_num}=$1 if /OPENSSL.VERSION.NUMBER.*(0x\S+)/;
-	$config{shlib_version_number}=$1 if /SHLIB_VERSION_NUMBER *&quot;([^&quot;]+)&quot;/;
-	$config{shlib_version_history}=$1 if /SHLIB_VERSION_HISTORY *&quot;([^&quot;]*)&quot;/;
-	}
-close(IN);
-if ($config{shlib_version_history} ne &quot;&quot;) { $config{shlib_version_history} .= &quot;:&quot;; }
-
-if ($config{version} =~ /(^[0-9]*)\.([0-9\.]*)/)
-	{
-	$config{major}=$1;
-	$config{minor}=$2;
-	}
-
-if ($config{shlib_version_number} =~ /(^[0-9]*)\.([0-9\.]*)/)
-	{
-	$config{shlib_major}=$1;
-	$config{shlib_minor}=$2;
-	}
+$config{cflags} =~ s/([\\\&quot;])/\\\1/g;
 
-if (defined($api)) {
-    $config{openssl_api_defines} = [ &quot;OPENSSL_MIN_API=&quot;.$apitable-&gt;{$api} ];
-    my $apiflag = sprintf(&quot;-DOPENSSL_API_COMPAT=%s&quot;, $apitable-&gt;{$api});
+if (defined($config{api})) {
+    $config{openssl_api_defines} = [ &quot;OPENSSL_MIN_API=&quot;.$apitable-&gt;{$config{api}} ];
+    my $apiflag = sprintf(&quot;-DOPENSSL_API_COMPAT=%s&quot;, $apitable-&gt;{$config{api}});
     $default_depflags .= &quot; $apiflag&quot;;
-    $cflags .= &quot; $apiflag&quot;;
+    $config{cflags} .= &quot; $apiflag&quot;;
 }
 
 my $ecc = $target{cc};
@@ -1207,24 +1246,24 @@ if ($strict_warnings)
 	die &quot;ERROR --strict-warnings requires gcc or clang&quot; unless ($ecc =~ /gcc(-\d(\.\d)*)?$/ or $ecc =~ /clang$/);
 	foreach $wopt (split /\s+/, $gcc_devteam_warn)
 		{
-		$cflags .= &quot; $wopt&quot; unless ($cflags =~ /(^|\s)$wopt(\s|$)/)
+		$config{cflags} .= &quot; $wopt&quot; unless ($config{cflags} =~ /(^|\s)$wopt(\s|$)/)
 		}
 	if ($ecc eq &quot;clang&quot;)
 		{
 		foreach $wopt (split /\s+/, $clang_devteam_warn)
 			{
-			$cflags .= &quot; $wopt&quot; unless ($cflags =~ /(^|\s)$wopt(\s|$)/)
+			$config{cflags} .= &quot; $wopt&quot; unless ($config{cflags} =~ /(^|\s)$wopt(\s|$)/)
 			}
 		}
 	if ($target !~ /^mingw/)
 		{
 		foreach $wopt (split /\s+/, $memleak_devteam_backtrace)
 			{
-			$cflags .= &quot; $wopt&quot; unless ($cflags =~ /(^|\s)$wopt(\s|$)/)
+			$config{cflags} .= &quot; $wopt&quot; unless ($config{cflags} =~ /(^|\s)$wopt(\s|$)/)
 			}
 		if ($target =~ /^BSD-/)
 			{
-			$lflags .= &quot; -lexecinfo&quot;;
+			$config{lflags} .= &quot; -lexecinfo&quot;;
 			}
 		}
 	}
@@ -1241,7 +1280,7 @@ use warnings;
 use Exporter;
 #use vars qw(\@ISA \@EXPORT);
 our \@ISA = qw(Exporter);
-our \@EXPORT = qw(\%config \%target);
+our \@EXPORT = qw(\%config \%target %withargs);
 
 EOF
 print OUT &quot;our %config = (\n&quot;;
@@ -1271,126 +1310,28 @@ foreach (sort keys %target) {
 print OUT &lt;&lt;&quot;EOF&quot;;
 );
 
-1;
 EOF
-close(OUT);
-
-open(IN,&quot;&lt;Makefile.in&quot;) || die &quot;unable to read Makefile.in: $!\n&quot;;
-open(OUT,&quot;&gt;$Makefile.new&quot;) || die &quot;unable to create $Makefile.new:$!\n&quot;;
-print OUT &quot;### Generated automatically from Makefile.in by Configure.\n\n&quot;;
-my $sdirs=0;
+print OUT &quot;our %withargs = (\n&quot;;
+foreach (sort keys %withargs) {
+    if (ref($withargs{$_}) eq &quot;ARRAY&quot;) {
+	print OUT &quot;  &quot;, $_, &quot; =&gt; [ &quot;, join(&quot;, &quot;,
+					   map { quotify(&quot;perl&quot;, $_) }
+					   @{$withargs{$_}}), &quot; ],\n&quot;;
+    } else {
+	print OUT &quot;  &quot;, $_, &quot; =&gt; &quot;, quotify(&quot;perl&quot;, $withargs{$_}), &quot;,\n&quot;
+    }
+}
+print OUT &lt;&lt;&quot;EOF&quot;;
+);
 
-while (&lt;IN&gt;)
-	{
-	chomp;
-	$sdirs = 1 if /^SDIRS=/;
-	if ($sdirs) {
-		my $dir;
-		foreach $dir (@skip) {
-			s/(\s)$dir /$1/;
-			s/\s$dir$//;
-			}
-		}
-	$sdirs = 0 unless /\\$/;
-        s/fips // if (/^DIRS=/ &amp;&amp; !$fips);
-        s/engines // if (/^DIRS=/ &amp;&amp; $disabled{&quot;engine&quot;});
-	s/^VERSION=.*/VERSION=$config{version}/;
-	s/^MAJOR=.*/MAJOR=$config{major}/;
-	s/^MINOR=.*/MINOR=$config{minor}/;
-	s/^SHLIB_VERSION_NUMBER=.*/SHLIB_VERSION_NUMBER=$config{shlib_version_number}/;
-	s/^SHLIB_VERSION_HISTORY=.*/SHLIB_VERSION_HISTORY=$config{shlib_version_history}/;
-	s/^SHLIB_MAJOR=.*/SHLIB_MAJOR=$config{shlib_major}/;
-	s/^SHLIB_MINOR=.*/SHLIB_MINOR=$config{shlib_minor}/;
-	s/^SHLIB_EXT=.*/SHLIB_EXT=$target{shared_extension}/;
-	s/^INSTALLTOP=.*$/INSTALLTOP=$config{prefix}/;
-	s/^MULTILIB=.*$/MULTILIB=$target{multilib}/;
-	s/^OPENSSLDIR=.*$/OPENSSLDIR=$config{openssldir}/;
-	s/^LIBDIR=.*$/LIBDIR=$libdir/;
-	s/^INSTALL_PREFIX=.*$/INSTALL_PREFIX=$install_prefix/;
-	s/^PLATFORM=.*$/PLATFORM=$target/;
-	s/^OPTIONS=.*$/OPTIONS=$config{options}/;
-	my $argvstring = &quot;(&quot;.join(&quot;, &quot;, map { quotify(&quot;perl&quot;, $_) } @argvcopy).&quot;)&quot;;
-	s/^CONFIGURE_ARGS=.*$/CONFIGURE_ARGS=$argvstring/;
-	if ($config{cross_compile_prefix})
-		{
-		s/^CC=.*$/CROSS_COMPILE= $config{cross_compile_prefix}\nCC= \$\(CROSS_COMPILE\)$target{cc}/;
-		s/^AR=\s*/AR= \$\(CROSS_COMPILE\)/;
-		s/^NM=\s*/NM= \$\(CROSS_COMPILE\)/;
-		s/^RANLIB=\s*/RANLIB= \$\(CROSS_COMPILE\)/;
-		s/^MAKEDEPPROG=.*$/MAKEDEPPROG= \$\(CROSS_COMPILE\)$target{cc}/ if $target{cc} eq &quot;gcc&quot;;
-		}
-	else	{
-		s/^CC=.*$/CC= $target{cc}/;
-		s/^AR=\s*ar/AR= $target{ar}/;
-		s/^RANLIB=.*/RANLIB= $target{ranlib}/;
-		s/^MAKEDEPPROG=.*$/MAKEDEPPROG= $target{cc}/ if $ecc eq &quot;gcc&quot; || $ecc eq &quot;clang&quot;;
-		}
-	s/^CFLAG=.*$/CFLAG= $cflags/;
-	s/^DEPFLAG=.*$/DEPFLAG=$depflags/;
-	s/^PEX_LIBS=.*$/PEX_LIBS= $prelflags/;
-	s/^EX_LIBS=.*$/EX_LIBS= $lflags/;
-	s/^EXE_EXT=.*$/EXE_EXT= $exe_ext/;
-	s/^CPUID_OBJ=.*$/CPUID_OBJ= $target{cpuid_obj}/;
-	s/^BN_ASM=.*$/BN_ASM= $target{bn_obj}/;
-	s/^EC_ASM=.*$/EC_ASM= $target{ec_obj}/;
-	s/^DES_ENC=.*$/DES_ENC= $target{des_obj}/;
-	s/^AES_ENC=.*$/AES_ENC= $target{aes_obj}/;
-	s/^BF_ENC=.*$/BF_ENC= $target{bf_obj}/;
-	s/^CAST_ENC=.*$/CAST_ENC= $target{cast_obj}/;
-	s/^RC4_ENC=.*$/RC4_ENC= $target{rc4_obj}/;
-	s/^RC5_ENC=.*$/RC5_ENC= $target{rc5_obj}/;
-	s/^MD5_ASM_OBJ=.*$/MD5_ASM_OBJ= $target{md5_obj}/;
-	s/^SHA1_ASM_OBJ=.*$/SHA1_ASM_OBJ= $target{sha1_obj}/;
-	s/^RMD160_ASM_OBJ=.*$/RMD160_ASM_OBJ= $target{rmd160_obj}/;
-	s/^WP_ASM_OBJ=.*$/WP_ASM_OBJ= $target{wp_obj}/;
-	s/^CMLL_ENC=.*$/CMLL_ENC= $target{cmll_obj}/;
-	s/^MODES_ASM_OBJ.=*$/MODES_ASM_OBJ= $target{modes_obj}/;
-	s/^ENGINES_ASM_OBJ.=*$/ENGINES_ASM_OBJ= $target{engines_obj}/;
-	s/^CHACHA_ENC=.*$/CHACHA_ENC= $target{chacha_obj}/;
-	s/^POLY1305_ASM_OBJ=.*$/POLY1305_ASM_OBJ= $target{poly1305_obj}/;
-	s/^PERLASM_SCHEME=.*$/PERLASM_SCHEME= $target{perlasm_scheme}/;
-	s/^PROCESSOR=.*/PROCESSOR= $config{processor}/;
-	s/^ARFLAGS=.*/ARFLAGS= $target{arflags}/;
-	s/^PERL=.*/PERL= $config{perl}/;
-	s/^LIBZLIB=.*/LIBZLIB=$withargs{&quot;zlib-lib&quot;}/;
-	s/^ZLIB_INCLUDE=.*/ZLIB_INCLUDE=$withargs{&quot;zlib-include&quot;}/;
-	s/^FIPSLIBDIR=.*/FIPSLIBDIR=$fipslibdir/;
-	s/^FIPSCANLIB=.*/FIPSCANLIB=libcrypto/ if $fips;
-	s/^SHARED_FIPS=.*/SHARED_FIPS=/;
-	s/^SHLIBDIRS=.*/SHLIBDIRS= crypto ssl/;
-	s/^BASEADDR=.*/BASEADDR=$baseaddr/;
-	s/^SHLIB_TARGET=.*/SHLIB_TARGET=$target{shared_target}/;
-	s/^SHLIB_MARK=.*/SHLIB_MARK=$shared_mark/;
-	s/^SHARED_LIBS=.*/SHARED_LIBS=\$(SHARED_CRYPTO) \$(SHARED_SSL)/ if (!$config{no_shared});
-	if ($target{shared_extension} ne &quot;&quot; &amp;&amp; $target{shared_extension} =~ /^\.s([ol])\.[^\.]*$/)
-		{
-		my $sotmp = $1;
-		s/^SHARED_LIBS_LINK_EXTS=.*/SHARED_LIBS_LINK_EXTS=.s$sotmp/;
-		}
-	elsif ($target{shared_extension} ne &quot;&quot; &amp;&amp; $target{shared_extension} =~ /^\.[^\.]*\.dylib$/)
-		{
-		s/^SHARED_LIBS_LINK_EXTS=.*/SHARED_LIBS_LINK_EXTS=.dylib/;
-		}
-	elsif ($target{shared_extension} ne &quot;&quot; &amp;&amp; $target{shared_extension} =~ /^\.s([ol])\.[^\.]*\.[^\.]*$/)
-		{
-		my $sotmp = $1;
-		s/^SHARED_LIBS_LINK_EXTS=.*/SHARED_LIBS_LINK_EXTS=.s$sotmp.\$(SHLIB_MAJOR) .s$sotmp/;
-		}
-	elsif ($target{shared_extension} ne &quot;&quot; &amp;&amp; $target{shared_extension} =~ /^\.[^\.]*\.[^\.]*\.dylib$/)
-		{
-		s/^SHARED_LIBS_LINK_EXTS=.*/SHARED_LIBS_LINK_EXTS=.\$(SHLIB_MAJOR).dylib .dylib/;
-		}
-	s/^SHARED_LDFLAGS=.*/SHARED_LDFLAGS=$target{shared_ldflag}/;
-	print OUT $_.&quot;\n&quot;;
-	}
-close(IN);
+1;
+EOF
 close(OUT);
-rename(&quot;$Makefile.new&quot;,$Makefile) || die &quot;unable to rename $Makefile.new\n&quot;;
 
 print &quot;IsMK1MF       =&quot;, ($target{build_scheme}-&gt;[0] eq &quot;mk1mf&quot; ? &quot;yes&quot; : &quot;no&quot;), &quot;\n&quot;;
 print &quot;CC            =$target{cc}\n&quot;;
-print &quot;CFLAG         =$cflags\n&quot;;
-print &quot;EX_LIBS       =$lflags\n&quot;;
+print &quot;CFLAG         =$config{cflags}\n&quot;;
+print &quot;EX_LIBS       =$config{lflags}\n&quot;;
 print &quot;CPUID_OBJ     =$target{cpuid_obj}\n&quot;;
 print &quot;BN_ASM        =$target{bn_obj}\n&quot;;
 print &quot;EC_ASM        =$target{ec_obj}\n&quot;;
@@ -1413,23 +1354,15 @@ print &quot;RANLIB        =$target{ranlib}\n&quot;;
 print &quot;ARFLAGS       =$target{arflags}\n&quot;;
 print &quot;PERL          =$config{perl}\n&quot;;
 
-sub
-run_dofile()
-{
-    my $in = shift;
-    my $out = shift;
+run_dofile(&quot;$Makefile.in&quot;,&quot;$Makefile.new&quot;);
 
-    # should we remove $out ?
-    system(&quot;$config{perl} -I. -Mconfigdata util/dofile.pl &lt;$in &gt;$out.new&quot;);
-    exit 1 if $? != 0;
-    rename(&quot;$out.new&quot;, $out) || die &quot;Can't rename $out.new, $!&quot;;
-}
+run_dofile(&quot;include/openssl/opensslconf.h.in&quot;, &quot;include/openssl/opensslconf.h&quot;);
 
-&amp;run_dofile(&quot;include/openssl/opensslconf.h.in&quot;, &quot;include/openssl/opensslconf.h&quot;);
+run_dofile(&quot;include/openssl/opensslconf.h.in&quot;, &quot;include/openssl/opensslconf.h&quot;);
 
 foreach my $alg ( 'bf', 'bn', 'des', 'rc4' ) {
-    &amp;run_dofile(&quot;crypto/include/internal/${alg}_conf.h.in&quot;,
-        &quot;crypto/include/internal/${alg}_conf.h&quot;);
+    run_dofile(&quot;crypto/include/internal/${alg}_conf.h.in&quot;,
+	       &quot;crypto/include/internal/${alg}_conf.h&quot;);
 }
 
 # Fix the date
@@ -1480,10 +1413,10 @@ my %builders = (
     unixmake =&gt; sub {
 	my $make_command = &quot;$make PERL=\'$config{perl}\'&quot;;
 	my $make_targets = &quot;&quot;;
-	$make_targets .= &quot; depend&quot; if $depflags ne $default_depflags &amp;&amp; $make_depend;
+	$make_targets .= &quot; depend&quot; if $config{depflags} ne $default_depflags &amp;&amp; $make_depend;
 	(system $make_command.$make_targets) == 0 or die &quot;make $make_targets failed&quot;
 	    if $make_targets ne &quot;&quot;;
-	if ($depflags ne $default_depflags &amp;&amp; !$make_depend) {
+	if ($config{depflags} ne $default_depflags &amp;&amp; !$make_depend) {
             $warn_make_depend++;
         }
     },
@@ -1815,6 +1748,17 @@ sub usage
 	exit(1);
 	}
 
+sub run_dofile()
+{
+    my $in = shift;
+    my $out = shift;
+
+    # should we remove $out ?
+    system(&quot;$config{perl} -I. -Mconfigdata util/dofile.pl &lt;$in &gt;$out.new&quot;);
+    exit 1 if $? != 0;
+    rename(&quot;$out.new&quot;, $out) || die &quot;Can't rename $out.new, $!&quot;;
+}
+
 # Configuration printer ##############################################
 
 sub print_table_entry
@@ -1890,10 +1834,10 @@ sub which
 	my $path;
 	foreach $path (split /:/, $ENV{PATH})
 		{
-		if (-f &quot;$path/$name$exe_ext&quot; and -x _)
+		if (-f &quot;$path/$name$target{exe_extension}&quot; and -x _)
 			{
-			return &quot;$path/$name$exe_ext&quot; unless ($name eq &quot;perl&quot; and
-			 system(&quot;$path/$name$exe_ext -e &quot; . '\'exit($]&lt;5.0);\''));
+			return &quot;$path/$name$target{exe_extension}&quot; unless ($name eq &quot;perl&quot; and
+			 system(&quot;$path/$name$target{exe_extension} -e &quot; . '\'exit($]&lt;5.0);\''));
 			}
 		}
 	}
@@ -2015,3 +1959,35 @@ sub quotify {
 
     map { $processor-&gt;($_); } @_;
 }
+
+# collect_information($filename, $line_continue, $regexp =&gt; $CODEref, ...)
+# $filename is the file to read.
+# $line_continue is either undef (which is a noop), or two arguments, where
+# the first is a regexp detecting a line continuation ending, and the
+# following argument is a CODEref that takes care of concatenating two
+# lines.
+# All following arguments are regex/CODEref pairs, where the regexp detects a
+# line and the CODEref does something with the result of the regexp.
+sub collect_information {
+    my $filename = shift;
+    my $line_continue_re = shift;
+    my $line_concat = defined($line_continue_re) ? shift : undef;
+    my %collectors = @_;
+
+    my $saved_line = &quot;&quot;;
+    open IN, $filename || die &quot;unable to read $filename: $!\n&quot;;
+    while(&lt;IN&gt;) {
+	chomp;
+	if (defined $line_concat) {
+	    $_ = $line_concat-&gt;($saved_line, $_);
+	}
+	if (defined $line_continue_re &amp;&amp; /$line_continue_re/) {
+	    $saved_line = $_;
+	    next;
+	}
+	foreach my $re (keys %collectors) {
+	    if (/$re/) { $collectors{$re}-&gt;() };
+	}
+    }
+    close IN;
+}
diff --git a/Makefile.in b/Makefile.in
index 9278783..e875f43 100644
--- a/Makefile.in
+++ b/Makefile.in
@@ -2,18 +2,18 @@
 ## Makefile for OpenSSL
 ##
 
-VERSION=
-MAJOR=
-MINOR=
-SHLIB_VERSION_NUMBER=
-SHLIB_VERSION_HISTORY=
-SHLIB_MAJOR=
-SHLIB_MINOR=
-SHLIB_EXT=
-PLATFORM=dist
-OPTIONS=
-CONFIGURE_ARGS=
-SHLIB_TARGET=
+VERSION={- $config{version} -}
+MAJOR={- $config{major} -}
+MINOR={- $config{minor} -}
+SHLIB_VERSION_NUMBER={- $config{shlib_version_number} -}
+SHLIB_VERSION_HISTORY={- $config{shlib_version_history} -}
+SHLIB_MAJOR={- $config{shlib_major} -}
+SHLIB_MINOR={- $config{shlib_minor} -}
+SHLIB_EXT={- $target{shared_extension} -}
+PLATFORM={- $config{target} -}
+OPTIONS={- $config{options} -}
+CONFIGURE_ARGS=({- join(&quot;, &quot;,quotify_l(@{$config{perlargv}})) -})
+SHLIB_TARGET={- $target{shared_target} -}
 
 # HERE indicates where this Makefile lives.  This can be used to indicate
 # where sub-Makefiles are expected to be.  Currently has very limited usage,
@@ -23,12 +23,12 @@ HERE=.
 # INSTALL_PREFIX is for package builders so that they can configure
 # for, say, /usr/ and yet have everything installed to /tmp/somedir/usr/.
 # Normally it is left empty.
-INSTALL_PREFIX=
+INSTALL_PREFIX={- $config{install_prefix} -}
 
 # Do not edit these manually. Use Configure with --prefix or --openssldir
 # to change this!  Short explanation in the top comment in Configure
-INSTALLTOP=/usr/local
-OPENSSLDIR=$(INSTALLTOP)/ssl
+INSTALLTOP={- $config{prefix} -}
+OPENSSLDIR={- $config{openssldir} -}
 
 # NO_IDEA - Define to build without the IDEA algorithm
 # NO_RC4  - Define to build without the RC4 algorithm
@@ -57,23 +57,24 @@ OPENSSLDIR=$(INSTALLTOP)/ssl
 # equal 4.
 # PKCS1_CHECK - pkcs1 tests.
 
-CC= cc
-CFLAG= -O
-DEPFLAG= 
-PEX_LIBS= 
-EX_LIBS= 
-EXE_EXT= 
-ARFLAGS=
-AR=ar $(ARFLAGS) r
-RANLIB= ranlib
-NM= nm
-PERL= perl
+CROSS_COMPILE= {- $config{cross_compile_prefix} -}
+CC= $(CROSS_COMPILE){- $target{cc} -}
+CFLAG= {- $config{cflags} -}
+DEPFLAG= {- $config{depflags} -}
+PEX_LIBS= {- $config{prelflags} -}
+EX_LIBS= {- $config{lflags} -}
+EXE_EXT= {- $target{exe_extension} -}
+ARFLAGS= {- $target{arflags} -}
+AR=$(CROSS_COMPILE){- $target{ar} -} $(ARFLAGS) r
+RANLIB= {- $target{ranlib} -}
+NM= $(CROSS_COMPILE){- $target{nm} -}
+PERL= {- $config{perl} -}
 #RM= echo --
 RM= rm -f
 TAR= tar
 TARFLAGS= --no-recursion
-MAKEDEPPROG=makedepend
-LIBDIR=lib
+MAKEDEPPROG=$(CROSS_COMPILE){- $config{makedepprog} -}
+LIBDIR={- $config{libdir} -}
 
 # We let the C compiler driver to take care of .s files. This is done in
 # order to be excused from maintaining a separate set of architecture
@@ -85,32 +86,32 @@ ASFLAG=$(CFLAG)
 
 # For x86 assembler: Set PROCESSOR to 386 if you want to support
 # the 80386.
-PROCESSOR=
+PROCESSOR= {- $config{processor} -}
 
 # CPUID module collects small commonly used assembler snippets
-CPUID_OBJ= 
-BN_ASM= bn_asm.o
-EC_ASM=
-DES_ENC= des_enc.o fcrypt_b.o
-AES_ENC= aes_core.o aes_cbc.o
-BF_ENC= bf_enc.o
-CAST_ENC= c_enc.o
-RC4_ENC= rc4_enc.o
-RC5_ENC= rc5_enc.o
-MD5_ASM_OBJ= 
-SHA1_ASM_OBJ= 
-RMD160_ASM_OBJ= 
-WP_ASM_OBJ=
-CMLL_ENC=
-MODES_ASM_OBJ=
-ENGINES_ASM_OBJ=
-CHACHA_ENC= chacha_enc.o
-POLY1305_ASM_OBJ=
-PERLASM_SCHEME=
+CPUID_OBJ= {- $target{cpuid_obj} -}
+BN_ASM= {- $target{bn_obj} -}
+EC_ASM= {- $target{ec_obj} -}
+DES_ENC= {- $target{des_obj} -}
+AES_ENC= {- $target{aes_obj} -}
+BF_ENC= {- $target{bf_obj} -}
+CAST_ENC= {- $target{cast_obj} -}
+RC4_ENC= {- $target{rc4_obj} -}
+RC5_ENC= {- $target{rc5_obj} -}
+MD5_ASM_OBJ= {- $target{md5_obj} -}
+SHA1_ASM_OBJ= {- $target{sha1_obj} -}
+RMD160_ASM_OBJ= {- $target{rmd160_obj} -}
+WP_ASM_OBJ= {- $target{wp_obj} -}
+CMLL_ENC= {- $target{cmll_obj} -}
+MODES_ASM_OBJ= {- $target{modes_obj} -}
+ENGINES_ASM_OBJ= {- $target{engines_obj} -}
+CHACHA_ENC= {- $target{chacha_obj} -}
+POLY1305_ASM_OBJ= {- $target{poly1305_obj} -}
+PERLASM_SCHEME= {- $target{perlasm_scheme} -}
 
 # Zlib stuff
-ZLIB_INCLUDE=
-LIBZLIB=
+ZLIB_INCLUDE={- $withargs{zlib-include} -}
+LIBZLIB={- $withargs{zlib-lib} -}
 
 # This is the location of fipscanister.o and friends.
 # The FIPS module build will place it $(INSTALLTOP)/lib
@@ -119,34 +120,25 @@ LIBZLIB=
 # $(INSTALLTOP) for this build may be different so hard
 # code the path.
 
-FIPSLIBDIR=/usr/local/ssl/$(LIBDIR)/
+FIPSLIBDIR={- $config{fipslibdir} -}
 
 # The location of the library which contains fipscanister.o
 # normally it will be libcrypto. If not compiling in FIPS mode
 # at all this is empty making it a useful test for a FIPS compile.
 
-FIPSCANLIB=
+FIPSCANLIB={- $config{fips} ? &quot;libcrypto&quot; : &quot;&quot; -}
 
 # Shared library base address. Currently only used on Windows.
 #
 
-BASEADDR=
+BASEADDR={- $config{baseaddr} -}
 
-DIRS=   crypto ssl engines apps test tools
+DIRS=   {- join(&quot; &quot;, @{$config{dirs}}) -}
 SHLIBDIRS= crypto ssl
 INSTALL_SUBS= engines apps tools
 
 # dirs in crypto to build
-SDIRS=  \
-	objects \
-	md2 md4 md5 sha mdc2 hmac ripemd whrlpool poly1305 \
-	des aes rc2 rc4 rc5 idea bf cast camellia seed chacha modes \
-	bn ec rsa dsa dh dso engine \
-	buffer bio stack lhash rand err \
-	evp asn1 pem x509 x509v3 conf txt_db pkcs7 pkcs12 comp ocsp ui \
-	cms ts jpake srp store cmac ct async kdf
-# keep in mind that the above list is adjusted by ./Configure
-# according to no-xxx arguments...
+SDIRS=  {- join(&quot; &quot;, @{$config{sdirs}}) -}
 
 # tests to perform.  &quot;alltests&quot; is a special word indicating that all tests
 # should be performed.
@@ -166,9 +158,9 @@ TOP=    .
 LIBS=   libcrypto.a libssl.a
 SHARED_CRYPTO=libcrypto$(SHLIB_EXT)
 SHARED_SSL=libssl$(SHLIB_EXT)
-SHARED_LIBS=
-SHARED_LIBS_LINK_EXTS=
-SHARED_LDFLAGS=
+SHARED_LIBS={- '$(SHARED_CRYPTO) $(SHARED_SSL)' if (!$config{no_shared}) -}
+SHARED_LIBS_LINK_EXTS={- $config{shared_link_extensions} -}
+SHARED_LDFLAGS={- $target{shared_ldflag} -}
 
 GENERAL=        Makefile
 BASENAME=       openssl
diff --git a/util/dofile.pl b/util/dofile.pl
index 617c09c..a6b0905 100644
--- a/util/dofile.pl
+++ b/util/dofile.pl
@@ -99,6 +99,7 @@ my $template = Text::Template-&gt;new(TYPE =&gt; 'STRING', SOURCE =&gt; $text );
 $template-&gt;fill_in(OUTPUT =&gt; \*STDOUT,
                    HASH =&gt; { config =&gt; \%config,
                              target =&gt; \%target,
+                             withargs =&gt; \%withargs,
                              quotify1 =&gt; \&amp;quotify1,
                              quotify_l =&gt; \&amp;quotify_l },
                    DELIMITERS =&gt; [ &quot;{-&quot;, &quot;-}&quot; ],
</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="003171.html">[openssl-commits] [openssl]  master update
</A></li>
	<LI>Next message: <A HREF="003176.html">[openssl-commits] [openssl]  master update
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3174">[ date ]</a>
              <a href="thread.html#3174">[ thread ]</a>
              <a href="subject.html#3174">[ subject ]</a>
              <a href="author.html#3174">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="../../../mailman/listinfo/openssl-commits.html">More information about the openssl-commits
mailing list</a><br>
</body></html>
