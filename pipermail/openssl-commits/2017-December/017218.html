<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [openssl-commits] [openssl]  master update
   </TITLE>
   <LINK REL="Index" HREF="https://mta.openssl.org/pipermail/openssl-commits/2017-December/index.html" >
   <LINK REL="made" HREF="mailto:openssl-commits%40openssl.org?Subject=Re%3A%20%5Bopenssl-commits%5D%20%5Bopenssl%5D%20%20master%20update&In-Reply-To=%3C1513095582.660922.31256.nullmailer%40dev.openssl.org%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="017215.html">
   <LINK REL="Next"  HREF="017219.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[openssl-commits] [openssl]  master update</H1>
    <B>Richard Levitte</B> 
    <A HREF="mailto:openssl-commits%40openssl.org?Subject=Re%3A%20%5Bopenssl-commits%5D%20%5Bopenssl%5D%20%20master%20update&In-Reply-To=%3C1513095582.660922.31256.nullmailer%40dev.openssl.org%3E"
       TITLE="[openssl-commits] [openssl]  master update">levitte at openssl.org
       </A><BR>
    <I>Tue Dec 12 16:19:42 UTC 2017</I>
    <P><UL>
        <LI>Previous message: <A HREF="017215.html">[openssl-commits] [openssl]  master update
</A></li>
        <LI>Next message: <A HREF="017219.html">[openssl-commits] [openssl]  master update
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#17218">[ date ]</a>
              <a href="thread.html#17218">[ thread ]</a>
              <a href="subject.html#17218">[ subject ]</a>
              <a href="author.html#17218">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>The branch master has been updated
       via  5f0e171a10325ec4502c2ce41b56d46f3c121fcb (commit)
       via  6e0e432cf287332cb0de43f301cdc99befdaa530 (commit)
       via  8dd0ff1c55972241040a8570b85632058c80b9ef (commit)
       via  7a061312038ce909a214edc4e21c8981c77bc650 (commit)
       via  81183680797f16bc05d39c1e9c1bf007fdbe4e19 (commit)
       via  ccce3e1db5132e472d1871c6a02caec5c71db72a (commit)
       via  793077d0beccfa20c9962546393128b92a7e68e4 (commit)
       via  3b6c4b07364797566c2c1fd75e499b2d9dd73506 (commit)
      from  cbade36108267fc551d0ec50d897a954b55672ac (commit)


- Log -----------------------------------------------------------------
commit 5f0e171a10325ec4502c2ce41b56d46f3c121fcb
Author: Richard Levitte &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">levitte at openssl.org</A>&gt;
Date:   Mon Dec 4 16:57:36 2017 +0100

    Note the removal of Makefile.shared in CHANGES
    
    Reviewed-by: Andy Polyakov &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">appro at openssl.org</A>&gt;
    Reviewed-by: Rich Salz &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">rsalz at openssl.org</A>&gt;
    (Merged from <A HREF="https://github.com/openssl/openssl/pull/4840">https://github.com/openssl/openssl/pull/4840</A>)

commit 6e0e432cf287332cb0de43f301cdc99befdaa530
Author: Richard Levitte &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">levitte at openssl.org</A>&gt;
Date:   Mon Dec 4 16:33:59 2017 +0100

    Remove Makefile.shared, as it's now entirely unused
    
    Reviewed-by: Andy Polyakov &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">appro at openssl.org</A>&gt;
    Reviewed-by: Rich Salz &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">rsalz at openssl.org</A>&gt;
    (Merged from <A HREF="https://github.com/openssl/openssl/pull/4840">https://github.com/openssl/openssl/pull/4840</A>)

commit 8dd0ff1c55972241040a8570b85632058c80b9ef
Author: Richard Levitte &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">levitte at openssl.org</A>&gt;
Date:   Mon Dec 4 16:31:26 2017 +0100

    Configure et al: cleanups
    
    Remove some config attributes that just duplicate values that are
    already there in other attributes.
    
    Remove the special runs of mkdef.pl and mkrc.pl from build file
    templates, as these are now done via GENERATE statements in
    build.info.
    
    Remove all references to ordinal files from build file templates, as
    these are now treated via the GENERATE statements in build.info.
    
    Also remove -shared flags and similar that are there in shared-info.pl
    anyway.  (in the case of darwin, it's mandatory, as -bundle and
    -dynamiclib don't mix)
    
    Reviewed-by: Andy Polyakov &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">appro at openssl.org</A>&gt;
    Reviewed-by: Rich Salz &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">rsalz at openssl.org</A>&gt;
    (Merged from <A HREF="https://github.com/openssl/openssl/pull/4840">https://github.com/openssl/openssl/pull/4840</A>)

commit 7a061312038ce909a214edc4e21c8981c77bc650
Author: Richard Levitte &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">levitte at openssl.org</A>&gt;
Date:   Mon Dec 4 14:59:27 2017 +0100

    build.info: adapt to the new handling of .rc / .def / .map / .opt files
    
    Reviewed-by: Andy Polyakov &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">appro at openssl.org</A>&gt;
    Reviewed-by: Rich Salz &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">rsalz at openssl.org</A>&gt;
    (Merged from <A HREF="https://github.com/openssl/openssl/pull/4840">https://github.com/openssl/openssl/pull/4840</A>)

commit 81183680797f16bc05d39c1e9c1bf007fdbe4e19
Author: Richard Levitte &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">levitte at openssl.org</A>&gt;
Date:   Mon Dec 4 14:27:58 2017 +0100

    Build file templates: Replace the use of Makefile.shared
    
    Because this also includes handling all sorts of non-object files when
    linking a program, shared library or DSO, this also includes allowing
    general recognition of files such as .res files (compiled from .rc
    files), or .def / .map / .opt files (for export and possibly
    versioning of public symbols only).
    
    This does mean that there's a tangible change for all build file
    templates: they must now recognise and handle the `.o` extension,
    which is used internally to recognise object files internally.  This
    extension was removed by common.tmpl before this change, but would
    mean that the platform specific templates wouldn't know if &quot;foo.map&quot;
    was originally &quot;foo.map.o&quot; (i.e. an object file in its own right) or
    &quot;foo.map&quot; (an export definition file that should be treated as such,
    not as an object file).
    
    For the sake of simplifying things, we also modify util/mkdef.pl to
    produce .def (Windows) and .opt (VMS) files that don't need additional
    hackery.
    
    Reviewed-by: Andy Polyakov &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">appro at openssl.org</A>&gt;
    Reviewed-by: Rich Salz &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">rsalz at openssl.org</A>&gt;
    (Merged from <A HREF="https://github.com/openssl/openssl/pull/4840">https://github.com/openssl/openssl/pull/4840</A>)

commit ccce3e1db5132e472d1871c6a02caec5c71db72a
Author: Richard Levitte &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">levitte at openssl.org</A>&gt;
Date:   Fri Dec 1 15:43:43 2017 +0100

    Configure: Recognise .rc and .def / .map / .opt as source files
    
    This makes it possible to add build.info statements for using resource
    files as well as linker scripts (.def for Windows, .map for Unix, and
    .opt for VMS) is if they were source files.  This requires changes in
    the build file templates.
    
    Reviewed-by: Andy Polyakov &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">appro at openssl.org</A>&gt;
    Reviewed-by: Rich Salz &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">rsalz at openssl.org</A>&gt;
    (Merged from <A HREF="https://github.com/openssl/openssl/pull/4840">https://github.com/openssl/openssl/pull/4840</A>)

commit 793077d0beccfa20c9962546393128b92a7e68e4
Author: Richard Levitte &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">levitte at openssl.org</A>&gt;
Date:   Fri Dec 1 15:40:43 2017 +0100

    Configure: Read in extra information to help create shared libraries
    
    This will replace the use of Makefile.shared
    
    This also means a small adjustment on how the attributes dso_cflags,
    dso_cxxflags and dso_lflags are treated.  They were previously treated
    as an extension to shared_cflag, shared_cxxflag and shared_ldflag, but
    they should really be regarded as alternatives instead, for example
    for darwin, where -dynamiclib is used for shared libraries and -bundle
    for DSOs.
    
    We take the opportunity to clean out things that are redundant or
    otherwise superfluous (for example the check of GNU ld on platforms
    where it never existed).
    
    Reviewed-by: Andy Polyakov &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">appro at openssl.org</A>&gt;
    Reviewed-by: Rich Salz &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">rsalz at openssl.org</A>&gt;
    (Merged from <A HREF="https://github.com/openssl/openssl/pull/4840">https://github.com/openssl/openssl/pull/4840</A>)

commit 3b6c4b07364797566c2c1fd75e499b2d9dd73506
Author: Richard Levitte &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">levitte at openssl.org</A>&gt;
Date:   Fri Dec 1 15:29:05 2017 +0100

    Configure: Add read_eval_file, a general purpose perl file reader/evaluator
    
    It will return the last expression from the input file.
    
    We also use this in read_config, which slightly changes what's
    expected of Configurations/*.conf.  They do not have to assign
    %targets specifically.  On the other hand, the table of configs MUST
    be the last expression in each of those files.
    
    Reviewed-by: Andy Polyakov &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">appro at openssl.org</A>&gt;
    Reviewed-by: Rich Salz &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">rsalz at openssl.org</A>&gt;
    (Merged from <A HREF="https://github.com/openssl/openssl/pull/4840">https://github.com/openssl/openssl/pull/4840</A>)

-----------------------------------------------------------------------

Summary of changes:
 CHANGES                               |   6 +
 Configurations/00-base-templates.conf |   2 +-
 Configurations/10-main.conf           |  51 +---
 Configurations/50-djgpp.conf          |   2 +-
 Configurations/50-haiku.conf          |   2 +-
 Configurations/50-masm.conf           |   2 +-
 Configurations/90-team.conf           |   2 +-
 Configurations/common.tmpl            |  36 ++-
 Configurations/descrip.mms.tmpl       |  47 ++-
 Configurations/shared-info.pl         | 102 +++++++
 Configurations/unix-Makefile.tmpl     | 157 +++++-----
 Configurations/windows-makefile.tmpl  |  85 +++---
 Configure                             |  98 ++++++-
 Makefile.shared                       | 521 ----------------------------------
 build.info                            |  48 +++-
 util/mkdef.pl                         |  19 +-
 16 files changed, 419 insertions(+), 761 deletions(-)
 create mode 100644 Configurations/shared-info.pl
 delete mode 100644 Makefile.shared

diff --git a/CHANGES b/CHANGES
index 691cbcd..92ae965 100644
--- a/CHANGES
+++ b/CHANGES
@@ -9,6 +9,12 @@
 
  Changes between 1.1.0f and 1.1.1 [xx XXX xxxx]
 
+  *) Get rid of Makefile.shared, and in the process, make the processing
+     of certain files (rc.obj, or the .def/.map/.opt files produced from
+     the ordinal files) more visible and hopefully easier to trace and
+     debug (or make silent).
+     [Richard Levitte]
+
   *) Make it possible to have environment variable assignments as
      arguments to config / Configure.
      [Richard Levitte]
diff --git a/Configurations/00-base-templates.conf b/Configurations/00-base-templates.conf
index f2d7f6a..ce59fbf 100644
--- a/Configurations/00-base-templates.conf
+++ b/Configurations/00-base-templates.conf
@@ -1,5 +1,5 @@
 # -*- Mode: perl -*-
-%targets=(
+my %targets=(
     DEFAULTS =&gt; {
 	template	=&gt; 1,
 
diff --git a/Configurations/10-main.conf b/Configurations/10-main.conf
index 28cfd30..1bdb723 100644
--- a/Configurations/10-main.conf
+++ b/Configurations/10-main.conf
@@ -144,7 +144,7 @@ sub vms_info {
     return $vms_info;
 }
 
-%targets = (
+my %targets = (
 
 #### Basic configs that should work on any 32-bit box
     &quot;gcc&quot; =&gt; {
@@ -218,7 +218,7 @@ sub vms_info {
         bn_ops           =&gt; &quot;SIXTY_FOUR_BIT_LONG&quot;,
         perlasm_scheme   =&gt; &quot;elf&quot;,
         shared_cflag     =&gt; &quot;-fPIC&quot;,
-        shared_ldflag    =&gt; &quot;-m64 -shared -static-libgcc&quot;,
+        shared_ldflag    =&gt; &quot;-shared -static-libgcc&quot;,
         multilib         =&gt; &quot;/64&quot;,
     },
 
@@ -243,12 +243,12 @@ sub vms_info {
                                               release =&gt; &quot;-xO5 -xdepend -xbuiltin&quot;),
                                        threads(&quot;-D_REENTRANT&quot;)),
         thread_scheme    =&gt; &quot;pthreads&quot;,
-        lflags           =&gt; add(&quot;-xarch=generic64&quot;,threads(&quot;-mt&quot;)),
+        lflags           =&gt; add(threads(&quot;-mt&quot;)),
         ex_libs          =&gt; add(threads(&quot;-lpthread&quot;)),
         bn_ops           =&gt; &quot;SIXTY_FOUR_BIT_LONG&quot;,
         perlasm_scheme   =&gt; &quot;elf&quot;,
         shared_cflag     =&gt; &quot;-KPIC&quot;,
-        shared_ldflag    =&gt; &quot;-xarch=generic64 -G -dy -z text&quot;,
+        shared_ldflag    =&gt; &quot;-G -dy -z text&quot;,
         multilib         =&gt; &quot;/64&quot;,
     },
 
@@ -278,7 +278,6 @@ sub vms_info {
         inherit_from     =&gt; [ &quot;solaris-sparcv9-gcc&quot; ],
         cflags           =&gt; sub { my $f=join(&quot; &quot;<A HREF="../../../mailman/listinfo/openssl-commits.html">, at _</A>); $f =~ s/\-m32/-m64/; $f; },
         bn_ops           =&gt; &quot;BN_LLONG RC4_CHAR&quot;,
-        shared_ldflag    =&gt; &quot;-m64 -shared&quot;,
         multilib         =&gt; &quot;/64&quot;,
     },
 
@@ -311,9 +310,7 @@ sub vms_info {
     &quot;solaris64-sparcv9-cc&quot; =&gt; {
         inherit_from     =&gt; [ &quot;solaris-sparcv7-cc&quot;, asm(&quot;sparcv9_asm&quot;) ],
         cflags           =&gt; add_before(&quot;-xarch=v9&quot;),
-        lflags           =&gt; add_before(&quot;-xarch=v9&quot;),
         bn_ops           =&gt; &quot;BN_LLONG RC4_CHAR&quot;,
-        shared_ldflag    =&gt; &quot;-xarch=v9 -G -dy -z text&quot;,
         multilib         =&gt; &quot;/64&quot;,
     },
 
@@ -332,7 +329,6 @@ sub vms_info {
         perlasm_scheme   =&gt; &quot;n32&quot;,
         dso_scheme       =&gt; &quot;dlfcn&quot;,
         shared_target    =&gt; &quot;irix-shared&quot;,
-        shared_ldflag    =&gt; &quot;-mabi=n32&quot;,
         shared_extension =&gt; &quot;.so.\$(SHLIB_VERSION_NUMBER)&quot;,
         multilib         =&gt; &quot;32&quot;,
     },
@@ -349,7 +345,6 @@ sub vms_info {
         perlasm_scheme   =&gt; &quot;n32&quot;,
         dso_scheme       =&gt; &quot;dlfcn&quot;,
         shared_target    =&gt; &quot;irix-shared&quot;,
-        shared_ldflag    =&gt; &quot;-n32&quot;,
         shared_extension =&gt; &quot;.so.\$(SHLIB_VERSION_NUMBER)&quot;,
         multilib         =&gt; &quot;32&quot;,
     },
@@ -367,7 +362,6 @@ sub vms_info {
         perlasm_scheme   =&gt; &quot;64&quot;,
         dso_scheme       =&gt; &quot;dlfcn&quot;,
         shared_target    =&gt; &quot;irix-shared&quot;,
-        shared_ldflag    =&gt; &quot;-mabi=64&quot;,
         shared_extension =&gt; &quot;.so.\$(SHLIB_VERSION_NUMBER)&quot;,
         multilib         =&gt; &quot;64&quot;,
     },
@@ -384,7 +378,6 @@ sub vms_info {
         perlasm_scheme   =&gt; &quot;64&quot;,
         dso_scheme       =&gt; &quot;dlfcn&quot;,
         shared_target    =&gt; &quot;irix-shared&quot;,
-        shared_ldflag    =&gt; &quot;-64&quot;,
         shared_extension =&gt; &quot;.so.\$(SHLIB_VERSION_NUMBER)&quot;,
         multilib         =&gt; &quot;64&quot;,
     },
@@ -489,7 +482,7 @@ sub vms_info {
         dso_scheme       =&gt; &quot;dlfcn&quot;,
         shared_target    =&gt; &quot;hpux-shared&quot;,
         shared_cflag     =&gt; &quot;+Z&quot;,
-        shared_ldflag    =&gt; &quot;+DD64 -b&quot;,
+        shared_ldflag    =&gt; &quot;-b&quot;,
         shared_extension =&gt; &quot;.sl.\$(SHLIB_VERSION_NUMBER)&quot;,
         multilib         =&gt; &quot;/pa20_64&quot;,
     },
@@ -508,7 +501,7 @@ sub vms_info {
         dso_scheme       =&gt; &quot;dlfcn&quot;,
         shared_target    =&gt; &quot;hpux-shared&quot;,
         shared_cflag     =&gt; &quot;+Z&quot;,
-        shared_ldflag    =&gt; &quot;+DD32 -b&quot;,
+        shared_ldflag    =&gt; &quot;-b&quot;,
         shared_extension =&gt; &quot;.so.\$(SHLIB_VERSION_NUMBER)&quot;,
         multilib         =&gt; &quot;/hpux32&quot;,
     },
@@ -525,7 +518,7 @@ sub vms_info {
         dso_scheme       =&gt; &quot;dlfcn&quot;,
         shared_target    =&gt; &quot;hpux-shared&quot;,
         shared_cflag     =&gt; &quot;+Z&quot;,
-        shared_ldflag    =&gt; &quot;+DD64 -b&quot;,
+        shared_ldflag    =&gt; &quot;-b&quot;,
         shared_extension =&gt; &quot;.so.\$(SHLIB_VERSION_NUMBER)&quot;,
         multilib         =&gt; &quot;/hpux64&quot;,
     },
@@ -560,7 +553,7 @@ sub vms_info {
         dso_scheme       =&gt; &quot;dlfcn&quot;,
         shared_target    =&gt; &quot;hpux-shared&quot;,
         shared_cflag     =&gt; &quot;-fpic&quot;,
-        shared_ldflag    =&gt; &quot;-mlp64 -shared&quot;,
+        shared_ldflag    =&gt; &quot;-shared&quot;,
         shared_extension =&gt; &quot;.so.\$(SHLIB_VERSION_NUMBER)&quot;,
         multilib         =&gt; &quot;/hpux64&quot;,
     },
@@ -641,14 +634,12 @@ sub vms_info {
         inherit_from     =&gt; [ &quot;linux-generic64&quot;, asm(&quot;ppc64_asm&quot;) ],
         cflags           =&gt; add(&quot;-m64 -DB_ENDIAN&quot;),
         perlasm_scheme   =&gt; &quot;linux64&quot;,
-        shared_ldflag    =&gt; add(&quot;-m64&quot;),
         multilib         =&gt; &quot;64&quot;,
     },
     &quot;linux-ppc64le&quot; =&gt; {
         inherit_from     =&gt; [ &quot;linux-generic64&quot;, asm(&quot;ppc64_asm&quot;) ],
         cflags           =&gt; add(&quot;-m64 -DL_ENDIAN&quot;),
         perlasm_scheme   =&gt; &quot;linux64le&quot;,
-        shared_ldflag    =&gt; add(&quot;-m64&quot;),
     },
 
     &quot;linux-armv4&quot; =&gt; {
@@ -695,7 +686,6 @@ sub vms_info {
         cflags           =&gt; add(&quot;-mabi=ilp32&quot;),
         bn_ops           =&gt; &quot;SIXTY_FOUR_BIT RC4_CHAR&quot;,
         perlasm_scheme   =&gt; &quot;linux64&quot;,
-        shared_ldflag    =&gt; add(&quot;-mabi=ilp32&quot;),
     },
 
     &quot;linux-mips32&quot; =&gt; {
@@ -704,7 +694,6 @@ sub vms_info {
         inherit_from     =&gt; [ &quot;linux-generic32&quot;, asm(&quot;mips32_asm&quot;) ],
         cflags           =&gt; add(&quot;-mabi=32 -DBN_DIV3W&quot;),
         perlasm_scheme   =&gt; &quot;o32&quot;,
-        shared_ldflag    =&gt; add(&quot;-mabi=32&quot;),
     },
     # mips32 and mips64 below refer to contemporary MIPS Architecture
     # specifications, MIPS32 and MIPS64, rather than to kernel bitness.
@@ -713,14 +702,12 @@ sub vms_info {
         cflags           =&gt; add(&quot;-mabi=n32 -DBN_DIV3W&quot;),
         bn_ops           =&gt; &quot;SIXTY_FOUR_BIT RC4_CHAR&quot;,
         perlasm_scheme   =&gt; &quot;n32&quot;,
-        shared_ldflag    =&gt; add(&quot;-mabi=n32&quot;),
         multilib         =&gt; &quot;32&quot;,
     },
     &quot;linux64-mips64&quot; =&gt; {
         inherit_from     =&gt; [ &quot;linux-generic64&quot;, asm(&quot;mips64_asm&quot;) ],
         cflags           =&gt; add(&quot;-mabi=64 -DBN_DIV3W&quot;),
         perlasm_scheme   =&gt; &quot;64&quot;,
-        shared_ldflag    =&gt; add(&quot;-mabi=64&quot;),
         multilib         =&gt; &quot;64&quot;,
     },
 
@@ -751,7 +738,6 @@ sub vms_info {
                                        release =&gt; &quot;-fomit-frame-pointer&quot;)),
         bn_ops           =&gt; &quot;BN_LLONG&quot;,
         perlasm_scheme   =&gt; &quot;elf&quot;,
-        shared_ldflag    =&gt; add(&quot;-m32&quot;),
     },
     &quot;linux-x86-clang&quot; =&gt; {
         inherit_from     =&gt; [ &quot;linux-x86&quot; ],
@@ -764,7 +750,6 @@ sub vms_info {
         cflags           =&gt; add(&quot;-m64 -DL_ENDIAN&quot;),
         bn_ops           =&gt; &quot;SIXTY_FOUR_BIT_LONG&quot;,
         perlasm_scheme   =&gt; &quot;elf&quot;,
-        shared_ldflag    =&gt; add(&quot;-m64&quot;),
         multilib         =&gt; &quot;64&quot;,
     },
     &quot;linux-x86_64-clang&quot; =&gt; {
@@ -778,7 +763,6 @@ sub vms_info {
         cflags           =&gt; add(&quot;-mx32 -DL_ENDIAN&quot;),
         bn_ops           =&gt; &quot;SIXTY_FOUR_BIT&quot;,
         perlasm_scheme   =&gt; &quot;elf32&quot;,
-        shared_ldflag    =&gt; add(&quot;-mx32&quot;),
         multilib         =&gt; &quot;x32&quot;,
     },
 
@@ -791,7 +775,6 @@ sub vms_info {
         inherit_from     =&gt; [ &quot;linux-generic64&quot;, asm(&quot;s390x_asm&quot;) ],
         cflags           =&gt; add(&quot;-m64 -DB_ENDIAN&quot;),
         perlasm_scheme   =&gt; &quot;64&quot;,
-        shared_ldflag    =&gt; add(&quot;-m64&quot;),
         multilib         =&gt; &quot;64&quot;,
     },
     &quot;linux32-s390x&quot; =&gt; {
@@ -815,7 +798,6 @@ sub vms_info {
         cflags           =&gt; add(&quot;-m31 -Wa,-mzarch -DB_ENDIAN&quot;),
         bn_asm_src       =&gt; sub { my $r=join(&quot; &quot;<A HREF="../../../mailman/listinfo/openssl-commits.html">, at _</A>); $r=~s|asm/s390x\.S|bn_asm.c|; $r; },
         perlasm_scheme   =&gt; &quot;31&quot;,
-        shared_ldflag    =&gt; add(&quot;-m31&quot;),
         multilib         =&gt; &quot;/highgprs&quot;,
     },
 
@@ -829,14 +811,12 @@ sub vms_info {
         # but -Wa,-Av8plus should do the trick no matter what.
         inherit_from     =&gt; [ &quot;linux-generic32&quot;, asm(&quot;sparcv9_asm&quot;) ],
         cflags           =&gt; add(&quot;-m32 -mcpu=ultrasparc -Wa,-Av8plus -DB_ENDIAN -DBN_DIV2W&quot;),
-        shared_ldflag    =&gt; add(&quot;-m32&quot;),
     },
     &quot;linux64-sparcv9&quot; =&gt; {
         # GCC 3.1 is a requirement
         inherit_from     =&gt; [ &quot;linux-generic64&quot;, asm(&quot;sparcv9_asm&quot;) ],
         cflags           =&gt; add(&quot;-m64 -mcpu=ultrasparc -DB_ENDIAN&quot;),
         bn_ops           =&gt; &quot;BN_LLONG RC4_CHAR&quot;,
-        shared_ldflag    =&gt; add(&quot;-m64&quot;),
         multilib         =&gt; &quot;64&quot;,
     },
 
@@ -1203,7 +1183,7 @@ sub vms_info {
         perlasm_scheme   =&gt; &quot;aix64&quot;,
         dso_scheme       =&gt; &quot;dlfcn&quot;,
         shared_target    =&gt; &quot;aix-shared&quot;,
-        shared_ldflag    =&gt; &quot;-maix64 -shared -static-libgcc -Wl,-G&quot;,
+        shared_ldflag    =&gt; &quot;-shared -static-libgcc -Wl,-G&quot;,
         shared_extension =&gt; &quot;.so.\$(SHLIB_VERSION_NUMBER)&quot;,
         arflags          =&gt; &quot;-X64&quot;,
     },
@@ -1221,7 +1201,7 @@ sub vms_info {
         perlasm_scheme   =&gt; &quot;aix32&quot;,
         dso_scheme       =&gt; &quot;dlfcn&quot;,
         shared_target    =&gt; &quot;aix-shared&quot;,
-        shared_ldflag    =&gt; &quot;-q32 -G&quot;,
+        shared_ldflag    =&gt; &quot;-G&quot;,
         shared_extension =&gt; &quot;.so.\$(SHLIB_VERSION_NUMBER)&quot;,
         arflags          =&gt; &quot;-X 32&quot;,
     },
@@ -1239,7 +1219,7 @@ sub vms_info {
         perlasm_scheme   =&gt; &quot;aix64&quot;,
         dso_scheme       =&gt; &quot;dlfcn&quot;,
         shared_target    =&gt; &quot;aix-shared&quot;,
-        shared_ldflag    =&gt; &quot;-q64 -G&quot;,
+        shared_ldflag    =&gt; &quot;-G&quot;,
         shared_extension =&gt; &quot;.so.\$(SHLIB_VERSION_NUMBER)&quot;,
         arflags          =&gt; &quot;-X 64&quot;,
     },
@@ -1529,7 +1509,6 @@ sub vms_info {
         dso_scheme       =&gt; &quot;dlfcn&quot;,
         shared_target    =&gt; &quot;cygwin-shared&quot;,
         shared_cflag     =&gt; &quot;-D_WINDLL&quot;,
-        shared_ldflag    =&gt; &quot;-shared&quot;,
         shared_extension =&gt; &quot;.dll&quot;,
     },
     &quot;Cygwin-x86_64&quot; =&gt; {
@@ -1545,7 +1524,6 @@ sub vms_info {
         dso_scheme       =&gt; &quot;dlfcn&quot;,
         shared_target    =&gt; &quot;cygwin-shared&quot;,
         shared_cflag     =&gt; &quot;-D_WINDLL&quot;,
-        shared_ldflag    =&gt; &quot;-shared&quot;,
         shared_extension =&gt; &quot;.dll&quot;,
     },
     # Backward compatibility for those using this target
@@ -1584,7 +1562,6 @@ sub vms_info {
         ranlib           =&gt; &quot;ranlib -c&quot;,
         shared_target    =&gt; &quot;darwin-shared&quot;,
         shared_cflag     =&gt; &quot;-fPIC&quot;,
-        shared_ldflag    =&gt; &quot;-dynamiclib&quot;,
         shared_extension =&gt; &quot;.\$(SHLIB_VERSION_NUMBER).dylib&quot;,
     },
     # Option &quot;freeze&quot; such as -std=gnu9x can't negatively interfere
@@ -1594,14 +1571,12 @@ sub vms_info {
         inherit_from     =&gt; [ &quot;darwin-common&quot;, asm(&quot;ppc32_asm&quot;) ],
         cflags           =&gt; add(&quot;-arch ppc -std=gnu9x -DB_ENDIAN -Wa,-force_cpusubtype_ALL&quot;),
         perlasm_scheme   =&gt; &quot;osx32&quot;,
-        shared_ldflag    =&gt; &quot;-arch ppc -dynamiclib&quot;,
     },
     &quot;darwin64-ppc-cc&quot; =&gt; {
         inherit_from     =&gt; [ &quot;darwin-common&quot;, asm(&quot;ppc64_asm&quot;) ],
         cflags           =&gt; add(&quot;-arch ppc64 -std=gnu9x -DB_ENDIAN&quot;),
         bn_ops           =&gt; &quot;SIXTY_FOUR_BIT_LONG RC4_CHAR&quot;,
         perlasm_scheme   =&gt; &quot;osx64&quot;,
-        shared_ldflag    =&gt; &quot;-arch ppc64 -dynamiclib&quot;,
     },
     &quot;darwin-i386-cc&quot; =&gt; {
         inherit_from     =&gt; [ &quot;darwin-common&quot;, asm(&quot;x86_asm&quot;) ],
@@ -1609,14 +1584,12 @@ sub vms_info {
                                        release =&gt; &quot;-fomit-frame-pointer&quot;)),
         bn_ops           =&gt; &quot;BN_LLONG RC4_INT&quot;,
         perlasm_scheme   =&gt; &quot;macosx&quot;,
-        shared_ldflag    =&gt; &quot;-arch i386 -dynamiclib&quot;,
     },
     &quot;darwin64-x86_64-cc&quot; =&gt; {
         inherit_from     =&gt; [ &quot;darwin-common&quot;, asm(&quot;x86_64_asm&quot;) ],
         cflags           =&gt; add(&quot;-arch x86_64 -DL_ENDIAN -Wall&quot;),
         bn_ops           =&gt; &quot;SIXTY_FOUR_BIT_LONG&quot;,
         perlasm_scheme   =&gt; &quot;macosx&quot;,
-        shared_ldflag    =&gt; &quot;-arch x86_64 -dynamiclib&quot;,
     },
 
 #### iPhoneOS/iOS
@@ -1748,7 +1721,6 @@ sub vms_info {
         dso_scheme       =&gt; sub { env('LIBSSL_dlfcn') },
         shared_target    =&gt; &quot;linux-shared&quot;,
         shared_cflag     =&gt; &quot;-fPIC&quot;,
-        shared_ldflag    =&gt; &quot;-shared&quot;,
         shared_extension =&gt; &quot;.so.\$(SHLIB_VERSION_NUMBER)&quot;,
         ranlib           =&gt; sub { env('RANLIB') },
     },
@@ -1764,7 +1736,6 @@ sub vms_info {
         dso_scheme       =&gt; sub { env('LIBSSL_dlfcn') },
         shared_target    =&gt; &quot;linux-shared&quot;,
         shared_cflag     =&gt; &quot;-fPIC&quot;,
-        shared_ldflag    =&gt; &quot;-shared&quot;,
         shared_extension =&gt; &quot;.so.\$(SHLIB_VERSION_NUMBER)&quot;,
         ranlib           =&gt; sub { env('RANLIB') },
     },
diff --git a/Configurations/50-djgpp.conf b/Configurations/50-djgpp.conf
index f532bd1..fa8e662 100644
--- a/Configurations/50-djgpp.conf
+++ b/Configurations/50-djgpp.conf
@@ -2,7 +2,7 @@
 # and rely entirely on the OpenSSL community to help is fine
 # tune and test.
 
-%targets = (
+my %targets = (
     &quot;DJGPP&quot; =&gt; {
         inherit_from     =&gt; [ asm(&quot;x86_asm&quot;) ],
         cc               =&gt; &quot;gcc&quot;,
diff --git a/Configurations/50-haiku.conf b/Configurations/50-haiku.conf
index aea5b2b..b57e148 100644
--- a/Configurations/50-haiku.conf
+++ b/Configurations/50-haiku.conf
@@ -1,4 +1,4 @@
-%targets = (
+my %targets = (
     &quot;haiku-common&quot; =&gt; {
         template         =&gt; 1,
         cc               =&gt; &quot;cc&quot;,
diff --git a/Configurations/50-masm.conf b/Configurations/50-masm.conf
index 0ec5e95..e2b54e3 100644
--- a/Configurations/50-masm.conf
+++ b/Configurations/50-masm.conf
@@ -7,7 +7,7 @@
 # proven to be daunting task. This is experimental target, for
 # production builds stick with [up-to-date version of] nasm.
 
-%targets = (
+my %targets = (
     &quot;VC-WIN64A-masm&quot; =&gt; {
         inherit_from    =&gt; [ &quot;VC-WIN64-common&quot;, asm(&quot;x86_64_asm&quot;),
                              sub { $disabled{shared} ? () : &quot;x86_64_uplink&quot; } ],
diff --git a/Configurations/90-team.conf b/Configurations/90-team.conf
index beb6ad8..4d57f3f 100644
--- a/Configurations/90-team.conf
+++ b/Configurations/90-team.conf
@@ -1,7 +1,7 @@
 ## -*- mode: perl; -*-
 ## Build configuration targets for openssl-team members
 
-%targets = (
+my %targets = (
     &quot;purify&quot; =&gt; {
         cc               =&gt; &quot;purify gcc&quot;,
         cflags           =&gt; &quot;-g -Wall&quot;,
diff --git a/Configurations/common.tmpl b/Configurations/common.tmpl
index a03beb6..b9937bd 100644
--- a/Configurations/common.tmpl
+++ b/Configurations/common.tmpl
@@ -97,11 +97,10 @@
  sub doobj {
      my $obj = shift;
      return &quot;&quot; if $cache{$obj};
-     (my $obj_no_o = $obj) =~ s|\.o$||;
      my $bin = shift;
      my %opts = @_;
      if (@{$unified_info{sources}-&gt;{$obj}}) {
-         $OUT .= src2obj(obj =&gt; $obj_no_o,
+         $OUT .= src2obj(obj =&gt; $obj,
                          product =&gt; $bin,
                          srcs =&gt; $unified_info{sources}-&gt;{$obj},
                          deps =&gt; $unified_info{depends}-&gt;{$obj},
@@ -124,24 +123,25 @@
      my $lib = shift;
      return &quot;&quot; if $cache{$lib};
      unless ($disabled{shared} || $lib =~ /\.a$/) {
-         my %ordinals =
-             $unified_info{ordinals}-&gt;{$lib}
-             ? (ordinals =&gt; $unified_info{ordinals}-&gt;{$lib}) : ();
          $OUT .= libobj2shlib(shlib =&gt; $unified_info{sharednames}-&gt;{$lib},
                               lib =&gt; $lib,
-                              objs =&gt; [ map { (my $x = $_) =~ s|\.o$||; $x }
-                                        (@{$unified_info{sources}-&gt;{$lib}},
-                                         @{$unified_info{shared_sources}-&gt;{$lib}}) ],
+                              objs =&gt; [ @{$unified_info{shared_sources}-&gt;{$lib}},
+                                        @{$unified_info{sources}-&gt;{$lib}} ],
                               deps =&gt; [ reducedepends(resolvedepends($lib)) ],
-                              installed =&gt; is_installed($lib),
-                              %ordinals);
-         foreach (@{$unified_info{shared_sources}-&gt;{$lib}}) {
-             doobj($_, $lib, intent =&gt; &quot;lib&quot;, installed =&gt; is_installed($lib));
+                              installed =&gt; is_installed($lib));
+         foreach ((@{$unified_info{shared_sources}-&gt;{$lib}},
+                   @{$unified_info{sources}-&gt;{$lib}})) {
+             # If this is somehow a compiled object, take care of it that way
+             # Otherwise, it might simply be generated
+             if (defined $unified_info{sources}-&gt;{$_}) {
+                 doobj($_, $lib, intent =&gt; &quot;lib&quot;, installed =&gt; is_installed($lib));
+             } else {
+                 dogenerate($_, undef, undef, intent =&gt; &quot;lib&quot;);
+             }
          }
      }
      $OUT .= obj2lib(lib =&gt; $lib,
-                     objs =&gt; [ map { (my $x = $_) =~ s|\.o$||; $x }
-                               @{$unified_info{sources}-&gt;{$lib}} ]);
+                     objs =&gt; [ @{$unified_info{sources}-&gt;{$lib}} ]);
      foreach (@{$unified_info{sources}-&gt;{$lib}}) {
          doobj($_, $lib, intent =&gt; &quot;lib&quot;, installed =&gt; is_installed($lib));
      }
@@ -155,9 +155,8 @@
      my $lib = shift;
      return &quot;&quot; if $cache{$lib};
      $OUT .= obj2dso(lib =&gt; $lib,
-                     objs =&gt; [ map { (my $x = $_) =~ s|\.o$||; $x }
-                               (@{$unified_info{sources}-&gt;{$lib}},
-                                @{$unified_info{shared_sources}-&gt;{$lib}}) ],
+                     objs =&gt; [ @{$unified_info{sources}-&gt;{$lib}},
+                               @{$unified_info{shared_sources}-&gt;{$lib}} ],
                      deps =&gt; [ resolvedepends($lib) ],
                      installed =&gt; is_installed($lib));
      foreach ((@{$unified_info{sources}-&gt;{$lib}},
@@ -174,8 +173,7 @@
      return &quot;&quot; if $cache{$bin};
      my $deps = [ reducedepends(resolvedepends($bin)) ];
      $OUT .= obj2bin(bin =&gt; $bin,
-                     objs =&gt; [ map { (my $x = $_) =~ s|\.o$||; $x }
-                               @{$unified_info{sources}-&gt;{$bin}} ],
+                     objs =&gt; [ @{$unified_info{sources}-&gt;{$bin}} ],
                      deps =&gt; $deps,
                      installed =&gt; is_installed($bin));
      foreach (@{$unified_info{sources}-&gt;{$bin}}) {
diff --git a/Configurations/descrip.mms.tmpl b/Configurations/descrip.mms.tmpl
index cfa055b..2bd9ad4 100644
--- a/Configurations/descrip.mms.tmpl
+++ b/Configurations/descrip.mms.tmpl
@@ -337,7 +337,7 @@ uninstall : uninstall_docs uninstall_sw
 # use $(LIBS), $(PROGRAMS), $(GENERATED) and $(ENGINES)directly.
 libclean :
         {- join(&quot;\n\t&quot;, map { &quot;- DELETE $_.OLB;*&quot; } @libs) || &quot;@ !&quot; -}
-        {- join(&quot;\n\t&quot;, map { &quot;- DELETE $_.EXE;*,$_.MAP;*,$_.OPT;*&quot; } @shlibs) || &quot;@ !&quot; -}
+        {- join(&quot;\n\t&quot;, map { &quot;- DELETE $_.EXE;*,$_.MAP;*&quot; } @shlibs) || &quot;@ !&quot; -}
 
 clean : libclean
         {- join(&quot;\n\t&quot;, map { &quot;- DELETE $_.EXE;*,$_.OPT;*&quot; } @{$unified_info{programs}}) || &quot;@ !&quot; -}
@@ -589,7 +589,7 @@ EOF
 
   sub src2obj {
       my %args = @_;
-      my $obj = $args{obj};
+      (my $obj = $args{obj}) =~ s|\.o$||;
       my $deps = join(&quot;, -\n\t\t&quot;, @{$args{srcs}}, @{$args{deps}});
 
       # Because VMS C isn't very good at combining a /INCLUDE path with
@@ -661,17 +661,12 @@ EOF
       my $shlib = $args{shlib};
       my $libd = dirname($lib);
       my $libn = basename($lib);
-      (my $mkdef_key = $libn) =~ s/^${osslprefix_q}lib([^0-9]*)\d*/$1/i;
+      my @defs = grep { $_ =~ /\.opt$/ } @{$args{objs}};
       my @deps = compute_lib_depends(@{$args{deps}});
-      my $deps = join(&quot;, -\n\t\t&quot;, @deps);
+      die &quot;More than one symbol vector&quot; if scalar @defs &gt; 1;
+      my $deps = join(&quot;, -\n\t\t&quot;, @defs, @deps);
       my $shlib_target = $disabled{shared} ? &quot;&quot; : $target{shared_target};
-      my $ordinalsfile = defined($args{ordinals}) ? $args{ordinals}-&gt;[1] : &quot;&quot;;
-      my $engine_opt = abs2rel(rel2abs(catfile($config{sourcedir},
-                                               &quot;VMS&quot;, &quot;engine.opt&quot;)),
-                               rel2abs($config{builddir}));
-      my $mkdef_pl = abs2rel(rel2abs(catfile($config{sourcedir},
-                                             &quot;util&quot;, &quot;mkdef.pl&quot;)),
-                             rel2abs($config{builddir}));
+      my $shared_def = join(&quot;,&quot;, map { &quot;$_/OPT&quot; } @defs);
       my $translatesyms_pl = abs2rel(rel2abs(catfile($config{sourcedir},
                                                      &quot;VMS&quot;, &quot;translatesyms.pl&quot;)),
                                      rel2abs($config{builddir}));
@@ -686,19 +681,12 @@ EOF
                              &quot;WRITE OPT_FILE \&quot;$x\&quot;&quot; } @deps)
           || &quot;\@ !&quot;;
       return &lt;&lt;&quot;EOF&quot;
-$shlib.EXE : $lib.OLB $deps $ordinalsfile
-        \$(PERL) $mkdef_pl &quot;$mkdef_key&quot; &quot;VMS&quot; &gt; $shlib.SYMVEC-tmp
-        \$(PERL) $translatesyms_pl \$(BLDDIR)CXX\$DEMANGLER_DB. &lt; $shlib.SYMVEC-tmp &gt; $shlib.SYMVEC
-        DELETE $shlib.SYMVEC-tmp;*
-        OPEN/WRITE/SHARE=READ OPT_FILE $shlib.OPT
-        WRITE OPT_FILE &quot;IDENTIFICATION=&quot;&quot;V$config{version}&quot;&quot;&quot;
-        TYPE $shlib.SYMVEC /OUTPUT=OPT_FILE:
-        WRITE OPT_FILE &quot;$lib.OLB/LIBRARY&quot;
-        $write_opt
-        CLOSE OPT_FILE
-        LINK \$(LDFLAGS)/SHARE=\$\@ $shlib.OPT/OPT \$(EX_LIBS)
-        DELETE $shlib.SYMVEC;*
-        PURGE $shlib.EXE,$shlib.OPT,$shlib.MAP
+$shlib.EXE : $lib.OLB $deps
+        \$(PERL) $translatesyms_pl \$(BLDDIR)CXX\$DEMANGLER_DB. &lt; $defs[0] &gt; $defs[0]-translated
+        LINK \$(LDFLAGS)/SHARE=\$\@ $defs[0]-translated/OPT,$lib.OLB/LIBRARY
+             \$(EX_LIBS)
+        DELETE $defs[0]-translated;*
+        PURGE $shlib.EXE,$shlib.MAP
 EOF
         . ($config{target} =~ m|alpha| ? &quot;&quot; : &lt;&lt;&quot;EOF&quot;
         SET IMAGE/FLAGS=(NOCALL_DEBUG) \$\@
@@ -711,7 +699,7 @@ EOF
       my $libd = dirname($lib);
       my $libn = basename($lib);
       (my $libn_nolib = $libn) =~ s/^lib//;
-      my @objs = map { &quot;$_.OBJ&quot; } @{$args{objs}};
+      my @objs = map { (my $x = $_) =~ s|\.o$|.OBJ|; $x } @{$args{objs}};
       my @deps = compute_lib_depends(@{$args{deps}});
       my $deps = join(&quot;, -\n\t\t&quot;, @objs, @deps);
       my $shlib_target = $disabled{shared} ? &quot;&quot; : $target{shared_target};
@@ -750,9 +738,10 @@ EOF
   sub obj2lib {
       my %args = @_;
       (my $lib = $args{lib}) =~ s/\.a$//;
-      my $objs = join(&quot;, -\n\t\t&quot;, map { $_.&quot;.OBJ&quot; } (@{$args{objs}}));
-      my $fill_lib = join(&quot;\n\t&quot;, (map { &quot;LIBRARY/REPLACE $lib.OLB $_.OBJ&quot; }
-                                    @{$args{objs}}));
+      my @objs = map { (my $x = $_) =~ s|\.o$|.OBJ|; $x } @{$args{objs}};
+      my $objs = join(&quot;, -\n\t\t&quot;, @objs);
+      my $fill_lib = join(&quot;\n\t&quot;, (map { &quot;LIBRARY/REPLACE $lib.OLB $_&quot; }
+                                   @objs));
       return &lt;&lt;&quot;EOF&quot;;
 $lib.OLB : $objs
         LIBRARY/CREATE/OBJECT $lib.OLB
@@ -765,7 +754,7 @@ EOF
       my $bin = $args{bin};
       my $bind = dirname($bin);
       my $binn = basename($bin);
-      my @objs = map { &quot;$_.OBJ&quot; } @{$args{objs}};
+      my @objs = map { (my $x = $_) =~ s|\.o$|.OBJ|; $x } @{$args{objs}};
       my $objs = join(&quot;,&quot;, @objs);
       my @deps = compute_lib_depends(@{$args{deps}});
       my $deps = join(&quot;, -\n\t\t&quot;, @objs, @deps);
diff --git a/Configurations/shared-info.pl b/Configurations/shared-info.pl
new file mode 100644
index 0000000..c5ebfc6
--- /dev/null
+++ b/Configurations/shared-info.pl
@@ -0,0 +1,102 @@
+#! /usr/bin/env perl
+# -*- mode: perl; -*-
+# Copyright 2016-2017 The OpenSSL Project Authors. All Rights Reserved.
+#
+# Licensed under the OpenSSL license (the &quot;License&quot;).  You may not use
+# this file except in compliance with the License.  You can obtain a copy
+# in the file LICENSE in the source distribution or at
+# <A HREF="https://www.openssl.org/source/license.html">https://www.openssl.org/source/license.html</A>
+
+# This is a collection of extra attributes to be used as input for creating
+# shared libraries, currently on any Unix variant, including Unix like
+# environments on Windows.
+
+sub detect_gnu_ld {
+    my @lines =
+        `$config{cross_compile_prefix}$target{cc} -Wl,-V /dev/null 2&gt;&amp;1`;
+    return grep /^GNU ld/, @lines;
+}
+sub detect_gnu_cc {
+    my @lines =
+        `$config{cross_compile_prefix}$target{cc} -v 2&gt;&amp;1`;
+    return grep /gcc/, @lines;
+}
+
+my %shared_info;
+%shared_info = (
+    'gnu-shared' =&gt; {
+        shared_ldflag         =&gt; '-shared -Wl,-Bsymbolic',
+        shared_sonameflag     =&gt; '-Wl,-soname=',
+    },
+    'linux-shared' =&gt; sub {
+        return {
+            %{$shared_info{'gnu-shared'}},
+            shared_defflag    =&gt; '-Wl,--version-script=',
+        };
+    },
+    'bsd-gcc-shared' =&gt; sub { return $shared_info{'linux-shared'}; },
+    'bsd-shared' =&gt; sub {
+        return $shared_info{'gnu-shared'} if detect_gnu_ld();
+        return {
+            shared_ldflag     =&gt; '-shared -nostdlib',
+        };
+    },
+    'darwin-shared' =&gt; {
+        dso_lflags            =&gt; '-bundle',
+        shared_ldflag         =&gt; '-dynamiclib -current_version $(SHLIB_VERSION_NUMBER) -compatibility_version $(SHLIB_VERSION_NUMBER)',
+        shared_sonameflag     =&gt; '-install_name $(INSTALLTOP)/$(LIBDIR)/',
+    },
+    'cygwin-shared' =&gt; {
+        shared_ldflag         =&gt; '-shared -Wl,--enable-auto-image-base',
+        shared_impflag        =&gt; '-Wl,--out-implib=',
+    },
+    'mingw-shared' =&gt; sub {
+        return {
+            %{$shared_info{'cygwin-shared'}},
+            # def_flag made to empty string so  it still generates
+            # something
+            shared_defflag    =&gt; '',
+        };
+    },
+    'alpha-osf1-shared' =&gt; sub {
+        return $shared_info{'gnu-shared'} if detect_gnu_ld();
+        return {
+            dso_lflags        =&gt; '-shared -Wl,-Bsymbolic',
+            shared_ldflag     =&gt; '-shared -Wl,-Bsymbolic -set_version $(SHLIB_VERSION_NUMBER)',
+        };
+    },
+    'solaris-shared' =&gt; {
+        shared_ldflag     =&gt; '-Wl,-Bsymbolic',
+        shared_defflag    =&gt; '-Wl,-M,',
+    },
+    'svr3-shared' =&gt; sub {
+        return $shared_info{'gnu-shared'} if detect_gnu_ld();
+        return {
+            shared_ldflag     =&gt; '-G',
+            shared_sonameflag =&gt; '-h ',
+        };
+    },
+    'svr5-shared' =&gt; sub {
+        return $shared_info{'gnu-shared'} if detect_gnu_ld();
+        return {
+            shared_ldflag     =&gt; detect_gnu_cc() ? '-shared' : '-G',
+            shared_sonameflag =&gt; '-h ',
+        };
+    },
+    'irix-shared' =&gt; sub {
+        return $shared_info{'gnu-shared'} if detect_gnu_ld();
+        return {
+            shared_ldflag     =&gt; '-shared -Wl,-Bsymbolic',
+            shared_sonameflag =&gt; '-Wl,-soname=',
+        };
+    },
+    'hpux-shared' =&gt; {
+        bin_lflags        =&gt; '-Wl,+s,+cdp,../:,+cdp,./:',
+        shared_ldflag     =&gt; '-Wl,-B,symbolic,+vnocompatwarnings,-z,+s,+cdp,../:,+cdp,./:',
+        shared_sonameflag =&gt; '-Wl,+h,',
+    },
+    'aix-shared' =&gt; {
+        bin_lflags            =&gt; '-Wl,-bsvr4',
+        shared_ldflag         =&gt; '-Wl,-bexpall,-bnolibpath,-bM:SRE',
+    },
+);
diff --git a/Configurations/unix-Makefile.tmpl b/Configurations/unix-Makefile.tmpl
index d66160f..7f8a322 100644
--- a/Configurations/unix-Makefile.tmpl
+++ b/Configurations/unix-Makefile.tmpl
@@ -195,11 +195,12 @@ EX_LIBS= {- $target{ex_libs} -} {- $config{ex_libs} -}
 LIB_CFLAGS={- $target{shared_cflag} || &quot;&quot; -}
 LIB_CXXFLAGS={- $target{shared_cxxflag} || &quot;&quot; -}
 LIB_LDFLAGS={- $target{shared_ldflag}.&quot; &quot;.$config{shared_ldflag} -}
-DSO_CFLAGS={- $target{shared_cflag} || &quot;&quot; -}
-DSO_CXXFLAGS={- $target{shared_cxxflag} || &quot;&quot; -}
-DSO_LDFLAGS=$(LIB_LDFLAGS)
-BIN_CFLAGS={- $target{bin_cflags} -}
-BIN_CXXFLAGS={- $target{bin_cxxflag} || &quot;&quot; -}
+DSO_CFLAGS={- $target{dso_cflags} || &quot;&quot; -}
+DSO_CXXFLAGS={- $target{dso_cxxflags} || &quot;&quot; -}
+DSO_LDFLAGS={- $target{dso_lflags} || &quot;&quot; -}
+BIN_CFLAGS={- $target{bin_cflags} || &quot;&quot; -}
+BIN_CXXFLAGS={- $target{bin_cxxflags} || &quot;&quot; -}
+BIN_LDFLAGS={- $target{bin_lflags} || &quot;&quot; -}
 
 PERL={- $config{perl} -}
 
@@ -868,7 +869,7 @@ EOF
   # last in the line.  We may therefore need to put back a line ending.
   sub src2obj {
       my %args = @_;
-      my $obj = $args{obj};
+      (my $obj = $args{obj}) =~ s|\.o$||;
       my @srcs = map { if ($unified_info{generate}-&gt;{$_}) {
                            (my $x = $_) =~ s/\.S$/.s/; $x
                        } else {
@@ -883,26 +884,30 @@ EOF
               $incs .= &quot; -I&quot;.$withargs{zlib_include};
           }
       }
-      my $cc = '$(CC)';
-      my $cflags = '$(CFLAGS)';
-      if (grep /\.(cc|cpp)$/, @srcs) {
-          $cc = '$(CXX)';
-          $cflags = '$(CXXFLAGS)';
-          $cflags .= ' ' . { lib =&gt; '$(LIB_CXXFLAGS)',
-                             dso =&gt; '$(DSO_CXXFLAGS)',
-                             bin =&gt; '$(BIN_CXXFLAGS)' } -&gt; {$args{intent}};
+      my $cmd = '$(CC)';
+      my $cmdflags = '$(CFLAGS) -c';
+      my $makedepprog = $disabled{makedepend} ? undef : $config{makedepprog};
+      if (grep /\.rc$/, @srcs) {
+          $cmd = '$(RC)';
+          $cmdflags = '$(RCFLAGS)';
+          $makedepprog = undef;
+      } elsif (grep /\.(cc|cpp)$/, @srcs) {
+          $cmd = '$(CXX)';
+          $cmdflags = '$(CXXFLAGS) -c';
+          $cmdflags .= ' ' . { lib =&gt; '$(LIB_CXXFLAGS)',
+                               dso =&gt; '$(DSO_CXXFLAGS)',
+                               bin =&gt; '$(BIN_CXXFLAGS)' } -&gt; {$args{intent}};
       } else {
-          $cflags .= ' ' . { lib =&gt; '$(LIB_CFLAGS)',
-                             dso =&gt; '$(DSO_CFLAGS)',
-                             bin =&gt; '$(BIN_CFLAGS)' } -&gt; {$args{intent}};
+          $cmdflags .= ' ' . { lib =&gt; '$(LIB_CFLAGS)',
+                               dso =&gt; '$(DSO_CFLAGS)',
+                               bin =&gt; '$(BIN_CFLAGS)' } -&gt; {$args{intent}};
       }
-      my $makedepprog = $config{makedepprog};
       my $recipe = &lt;&lt;&quot;EOF&quot;;
 $obj$objext: $deps
 EOF
-      if (!$disabled{makedepend} &amp;&amp; $makedepprog !~ /\/makedepend/) {
+      if (defined $makedepprog &amp;&amp; $makedepprog !~ /\/makedepend/) {
           $recipe .= &lt;&lt;&quot;EOF&quot;;
-	$cc $incs $cflags -MMD -MF $obj$depext.tmp -MT \$\@ -c -o \$\@ $srcs
+	$cmd $incs $cmdflags -MMD -MF $obj$depext.tmp -MT \$\@ -c -o \$\@ $srcs
 	\@touch $obj$depext.tmp
 	\@if cmp $obj$depext.tmp $obj$depext &gt; /dev/null 2&gt; /dev/null; then \\
 		rm -f $obj$depext.tmp; \\
@@ -912,11 +917,11 @@ EOF
 EOF
       } else {
           $recipe .= &lt;&lt;&quot;EOF&quot;;
-	$cc $incs $cflags -c -o \$\@ $srcs
+	$cmd $incs $cmdflags -o \$\@ $srcs
 EOF
-          if (!$disabled{makedepend} &amp;&amp; $makedepprog =~ /\/makedepend/) {
+          if (defined $makedepprog  &amp;&amp; $makedepprog =~ /\/makedepend/) {
               $recipe .= &lt;&lt;&quot;EOF&quot;;
-	-\$(MAKEDEPEND) -f- -o&quot;|\$\@&quot; -- $incs $cflags -- $srcs \\
+	-\$(MAKEDEPEND) -f- -o&quot;|\$\@&quot; -- $incs $cmdflags -- $srcs \\
 	    &gt;$obj$depext.tmp 2&gt;/dev/null
 	-\$(PERL) -i -pe 's/^.*\\|//; s/ \\/(\\\\.|[^ ])*//; \$\$_ = undef if (/: *\$\$/ || /^(#.*| *)\$\$/); \$\$_.=&quot;\\n&quot; unless !defined(\$\$_) or /\\R\$\$/g;' $obj$depext.tmp
 	\@if cmp $obj$depext.tmp $obj$depext &gt; /dev/null 2&gt; /dev/null; then \\
@@ -943,71 +948,78 @@ EOF
                                     my $f = basename($_);
                                     (my $l = $f) =~ s/^lib//;
                                     &quot; -L$d -l$l&quot; } @{$args{deps}});
-      my $deps = join(&quot; &quot;,compute_lib_depends(@{$args{deps}}));
-      my $shlib_target = $target{shared_target};
-      my $ordinalsfile = defined($args{ordinals}) ? $args{ordinals}-&gt;[1] : &quot;&quot;;
+      my @objs = map { (my $x = $_) =~ s|\.o$|$objext|; $x }
+                 grep { $_ =~ m|\.o$| }
+                 @{$args{objs}};
+      my @defs = grep { $_ =~ /\.(def|map)$/ } @{$args{objs}};
+      my @deps = compute_lib_depends(@{$args{deps}});
+      die &quot;More than one exported symbol map&quot; if scalar @defs &gt; 1;
+      my $objs = join(&quot; &quot;, @objs);
+      my $deps = join(&quot; &quot;, @objs, @defs, @deps);
       my $target = shlib_simple($lib);
       my $target_full = shlib($lib);
-      return &lt;&lt;&quot;EOF&quot;
-# With a build on a Windows POSIX layer (Cygwin or Mingw), we know for a fact
+      my $shared_soname = &quot;&quot;;
+      $shared_soname .= ' '.$target{shared_sonameflag}.basename($target_full)
+          if defined $target{shared_sonameflag};
+      my $shared_imp = &quot;&quot;;
+      $shared_imp .= ' '.$target{shared_impflag}.basename($target)
+          if defined $target{shared_impflag};
+      my $shared_def = join(&quot;&quot;, map { ' '.$target{shared_defflag}.$_ } @defs);
+      my $recipe = &lt;&lt;&quot;EOF&quot;;
+# When building on a Windows POSIX layer (Cygwin or Mingw), we know for a fact
 # that two files get produced, {shlibname}.dll and {libname}.dll.a.
 # With all other Unix platforms, we often build a shared library with the
 # SO version built into the file name and a symlink without the SO version
 # It's not necessary to have both as targets.  The choice falls on the
 # simplest, {libname}\$(SHLIB_EXT_IMPORT) for Windows POSIX layers and
 # {libname}\$(SHLIB_EXT_SIMPLE) for the Unix platforms.
-$target: $lib$libext $deps $ordinalsfile
-	\$(MAKE) -f \$(SRCDIR)/Makefile.shared -e \\
-		ECHO=\$(ECHO) \\
-		PLATFORM=\$(PLATFORM) \\
-		PERL=&quot;\$(PERL)&quot; SRCDIR='\$(SRCDIR)' DSTDIR=&quot;$libd&quot; \\
-		INSTALLTOP='\$(INSTALLTOP)' LIBDIR='\$(LIBDIR)' \\
-		LIBDEPS='\$(PLIB_LDFLAGS) '&quot;$linklibs&quot;' \$(EX_LIBS)' \\
-		LIBNAME=$libname SHLIBVERSION=\$(SHLIB_VERSION_NUMBER) \\
-		STLIBNAME=$lib$libext \\
-		SHLIBNAME=$target SHLIBNAME_FULL=$target_full \\
-		CC='\$(CC)' CFLAGS='\$(CFLAGS) \$(LIB_CFLAGS)' \\
-		LDFLAGS='\$(LDFLAGS)' SHARED_LDFLAGS='\$(LIB_LDFLAGS)' \\
-		RC='\$(RC)' SHARED_RCFLAGS='\$(RCFLAGS)' \\
-		link_shlib.$shlib_target
+$target: $deps
+	\$(CC) \$(CFLAGS) \$(LIB_CFLAGS) \$(LIB_LDFLAGS)$shared_soname$shared_imp \\
+		-o $target_full$shared_def $objs \\
+                \$(PLIB_LDFLAGS) $linklibs \$(EX_LIBS)
 EOF
-	  . (windowsdll() ? &lt;&lt;&quot;EOF&quot; : &quot;&quot;);
+      if (windowsdll()) {
+          $recipe .= &lt;&lt;&quot;EOF&quot;;
 	rm -f apps/$shlib'\$(SHLIB_EXT)'
 	rm -f test/$shlib'\$(SHLIB_EXT)'
+	rm -f fuzz/$shlib'\$(SHLIB_EXT)'
 	cp -p $shlib'\$(SHLIB_EXT)' apps/
 	cp -p $shlib'\$(SHLIB_EXT)' test/
+	cp -p $shlib'\$(SHLIB_EXT)' fuzz/
 EOF
+      } else {
+          $recipe .= &lt;&lt;&quot;EOF&quot;;
+	rm -f $target
+	ln -s $target_full $target
+EOF
+      }
   }
   sub obj2dso {
       my %args = @_;
       my $dso = $args{lib};
       my $dsod = dirname($dso);
       my $dson = basename($dso);
-      my $shlibdeps = join(&quot;&quot;, map { my $d = dirname($_);
-                                     my $f = basename($_);
-                                     (my $l = $f) =~ s/^lib//;
-                                     &quot; -L$d -l$l&quot; } @{$args{deps}});
-      my $deps = join(&quot; &quot;,compute_lib_depends(@{$args{deps}}));
-      my $shlib_target = $target{shared_target};
-      my $objs = join(&quot; &quot;, map { $_.$objext } @{$args{objs}});
+      my $linklibs = join(&quot;&quot;, map { my $d = dirname($_);
+                                    my $f = basename($_);
+                                    (my $l = $f) =~ s/^lib//;
+                                    &quot; -L$d -l$l&quot; } @{$args{deps}});
+      my @objs = map { (my $x = $_) =~ s|\.o$|$objext|; $x } @{$args{objs}};
+      my @deps = compute_lib_depends(@{$args{deps}});
+      my $objs = join(&quot; &quot;, @objs);
+      my $deps = join(&quot; &quot;, @deps);
       my $target = dso($dso);
       return &lt;&lt;&quot;EOF&quot;;
 $target: $objs $deps
-	\$(MAKE) -f \$(SRCDIR)/Makefile.shared -e \\
-		PLATFORM=\$(PLATFORM) \\
-		PERL=&quot;\$(PERL)&quot; SRCDIR='\$(SRCDIR)' DSTDIR=&quot;$dsod&quot; \\
-		LIBDEPS='\$(PLIB_LDFLAGS) '&quot;$shlibdeps&quot;' \$(EX_LIBS)' \\
-		SHLIBNAME_FULL=$target LDFLAGS='\$(LDFLAGS)' \\
-		CC='\$(CC)' CFLAGS='\$(CFLAGS) \$(DSO_CFLAGS)' \\
-		SHARED_LDFLAGS='\$(DSO_LDFLAGS)' \\
-		LIBEXTRAS=&quot;$objs&quot; \\
-		link_dso.$shlib_target
+	\$(CC) \$(CFLAGS) \$(DSO_CFLAGS) \$(DSO_LDFLAGS) \\
+		-o $target $objs \\
+                \$(PLIB_LDFLAGS) $linklibs \$(EX_LIBS)
 EOF
   }
   sub obj2lib {
       my %args = @_;
       (my $lib = $args{lib}) =~ s/\.a$//;
-      my $objs = join(&quot; &quot;, map { $_.$objext } @{$args{objs}});
+      my @objs = map { (my $x = $_) =~ s|\.o$|$objext|; $x } @{$args{objs}};
+      my $objs = join(&quot; &quot;, @objs);
       return &lt;&lt;&quot;EOF&quot;;
 $lib$libext: $objs
 	\$(AR) \$\@ \$\?
@@ -1019,7 +1031,8 @@ EOF
       my $bin = $args{bin};
       my $bind = dirname($bin);
       my $binn = basename($bin);
-      my $objs = join(&quot; &quot;, map { $_.$objext } @{$args{objs}});
+      my $objs = join(&quot; &quot;, map { (my $x = $_) =~ s|\.o$|$objext|; $x }
+                           @{$args{objs}});
       my $deps = join(&quot; &quot;,compute_lib_depends(@{$args{deps}}));
       my $linklibs = join(&quot;&quot;, map { if ($_ =~ /\.a$/) {
                                         &quot; $_&quot;;
@@ -1031,23 +1044,17 @@ EOF
                                         &quot; -L$d -l$l&quot;
                                     }
                                   } @{$args{deps}});
-      my $shlib_target = $disabled{shared} ? &quot;&quot; : $target{shared_target};
-      my $cc = '$(CC)';
-      my $cflags = '$(CFLAGS) $(BIN_CFLAGS)';
-      if (grep /_cc$/, @{$args{objs}}) {
-          $cc = '$(CXX)';
-          $cflags = '$(CXXFLAGS) $(BIN_CXXFLAGS)';
+      my $cmd = '$(CC)';
+      my $cmdflags = '$(CFLAGS) $(BIN_CFLAGS)';
+      if (grep /_cc\.o$/, @{$args{objs}}) {
+          $cmd = '$(CXX)';
+          $cmdflags = '$(CXXFLAGS) $(BIN_CXXFLAGS)';
       }
       return &lt;&lt;&quot;EOF&quot;;
 $bin$exeext: $objs $deps
-	\$(RM) $bin$exeext
-	\$(MAKE) -f \$(SRCDIR)/Makefile.shared -e \\
-		PERL=&quot;\$(PERL)&quot; SRCDIR=\$(SRCDIR) \\
-		APPNAME=$bin$exeext OBJECTS=&quot;$objs&quot; \\
-		LIBDEPS='\$(PLIB_LDFLAGS) '&quot;$linklibs&quot;' \$(EX_LIBS)' \\
-		CC='$cc' CFLAGS='$cflags' \\
-		LDFLAGS='\$(LDFLAGS)' \\
-		link_app.$shlib_target
+	rm -f $bin$exeext
+	$cmd $cmdflags \$(LDFLAGS) \$(BIN_LDFLAGS) -o $bin$exeext $objs \\
+		\$(PLIB_LDFLAGS) $linklibs \$(EX_LIBS)
 EOF
   }
   sub in2script {
diff --git a/Configurations/windows-makefile.tmpl b/Configurations/windows-makefile.tmpl
index 0ea1bba..51094f7 100644
--- a/Configurations/windows-makefile.tmpl
+++ b/Configurations/windows-makefile.tmpl
@@ -4,6 +4,7 @@
 ## {- join(&quot;\n## &quot;, @autowarntext) -}
 {-
  our $objext = $target{obj_extension} || &quot;.obj&quot;;
+ our $resext = $target{res_extension} || &quot;.res&quot;;
  our $depext = $target{dep_extension} || &quot;.d&quot;;
  our $exeext = $target{exe_extension} || &quot;.exe&quot;;
  our $libext = $target{lib_extension} || &quot;.lib&quot;;
@@ -169,8 +170,8 @@ LDOUTFLAG={- $target{loutflag} || &quot;/out:&quot; -}$(OSSL_EMPTY)
 EX_LIBS={- $target{ex_libs} -}
 LIB_CFLAGS={- join(&quot; &quot;, $target{lib_cflags}, $target{shared_cflag}) || &quot;&quot; -}
 LIB_LDFLAGS={- $target{shared_ldflag} || &quot;&quot; -}
-DSO_CFLAGS={- join(&quot; &quot;, $target{dso_cflags}, $target{shared_cflag}) || &quot;&quot; -}
-DSO_LDFLAGS={- join(&quot; &quot;, $target{dso_lflags}, $target{shared_ldflag}) || &quot;&quot; -}
+DSO_CFLAGS={- $target{dso_cflags} || &quot;&quot; -}
+DSO_LDFLAGS={- $target{dso_ldflag} || &quot;&quot; -}
 BIN_CFLAGS={- $target{bin_cflags} -}
 BIN_LDFLAGS={- $target{bin_lflags} -}
 
@@ -445,7 +446,6 @@ EOF
 
  sub src2obj {
      my %args = @_;
-     my $obj = $args{obj};
      my @srcs = map { (my $x = $_) =~ s/\.s$/.asm/; $x
                     } ( @{$args{srcs}} );
      my $srcs = '&quot;'.join('&quot; &quot;',  @srcs).'&quot;';
@@ -460,6 +460,13 @@ EOF
 		     dso =&gt; '$(DSO_CFLAGS)',
 		     bin =&gt; '$(BIN_CFLAGS)' } -&gt; {$args{intent}};
      my $makedepprog = $config{makedepprog};
+     if ($srcs[0] =~ /\.rc$/) {
+         return &lt;&lt;&quot;EOF&quot;;
+$args{obj}: $deps
+	\$(RC) \$(RCOUTFLAG)\$\@ $srcs
+EOF
+     }
+     (my $obj = $args{obj}) =~ s|\.o$||;
      if ($srcs[0] =~ /\.asm$/) {
          return &lt;&lt;&quot;EOF&quot;;
 $obj$objext: $deps
@@ -493,32 +500,24 @@ EOF
      my %args = @_;
      my $lib = $args{lib};
      my $shlib = $args{shlib};
-     (my $mkdef_key = $lib) =~ s/^lib//i;
-     my $objs = join(&quot;\n&quot;, map { $_.$objext } @{$args{objs}});
-     my $linklibs = join(&quot;&quot;,
-			 map { &quot;\n$_&quot; } compute_lib_depends(@{$args{deps}}));
-     my $deps = join(&quot; &quot;,
-		     (map { $_.$objext } @{$args{objs}}),
-		     compute_lib_depends(@{$args{deps}}));
-     my $ordinalsfile = defined($args{ordinals}) ? $args{ordinals}-&gt;[1] : &quot;&quot;;
-     my $mkdef_pl = abs2rel(rel2abs(catfile($config{sourcedir},
-					    &quot;util&quot;, &quot;mkdef.pl&quot;)),
-			    rel2abs($config{builddir}));
-     my $mkrc_pl = abs2rel(rel2abs(catfile($config{sourcedir},
-					   &quot;util&quot;, &quot;mkrc.pl&quot;)),
-			   rel2abs($config{builddir}));
+     my @objs = map { (my $x = $_) =~ s|\.o$|$objext|; $x }
+                grep { $_ =~ m|\.o$| }
+                @{$args{objs}};
+     my @defs = grep { $_ =~ /\.def$/ } @{$args{objs}};
+     my @deps = compute_lib_depends(@{$args{deps}});
+     die &quot;More than one exported symbols list&quot; if scalar @defs &gt; 1;
+     my $linklibs = join(&quot;&quot;, map { &quot;$_\n&quot; } @deps);
+     my $objs = join(&quot;\n&quot;, @objs);
+     my $deps = join(&quot; &quot;, @objs, @defs, @deps);
      my $target = shlib_import($lib);
+     my $shared_def = join(&quot;&quot;, map { &quot; /def:$_&quot; } @defs);
      return &lt;&lt;&quot;EOF&quot;
-$target: $deps &quot;$ordinalsfile&quot; &quot;$mkdef_pl&quot;
-	&quot;\$(PERL)&quot; &quot;$mkdef_pl&quot; &quot;$mkdef_key&quot; 32 &gt; $shlib.def
-	&quot;\$(PERL)&quot; -i.tmp -pe &quot;s|^LIBRARY\\s+${mkdef_key}32|LIBRARY $shlib|;&quot; $shlib.def
-	DEL $shlib.def.tmp
-	&quot;\$(PERL)&quot; &quot;$mkrc_pl&quot; $shlib$shlibext &gt; $shlib.rc
-	\$(RC) \$(RCOUTFLAG)$shlib.res $shlib.rc
+$target: $deps
 	IF EXIST $shlib$shlibext.manifest DEL /F /Q $shlib$shlibext.manifest
 	\$(LD) \$(LDFLAGS) \$(LIB_LDFLAGS) \\
-		/implib:\$@ \$(LDOUTFLAG)$shlib$shlibext /def:$shlib.def @&lt;&lt; || (DEL /Q \$(\@B).* $shlib.* &amp;&amp; EXIT 1)
-$objs $shlib.res$linklibs \$(EX_LIBS)
+		/implib:\$@ \$(LDOUTFLAG)$shlib$shlibext$shared_def @&lt;&lt; || (DEL /Q \$(\@B).* $shlib.* &amp;&amp; EXIT 1)
+$objs
+$linklibs\$(EX_LIBS)
 &lt;&lt;
 	IF EXIST $shlib$shlibext.manifest \\
 	   \$(MT) \$(MTFLAGS) \$(MTINFLAG)$shlib$shlibext.manifest \$(MTOUTFLAG)$shlib$shlibext
@@ -534,12 +533,11 @@ EOF
      my %args = @_;
      my $dso = $args{lib};
      my $dso_n = basename($dso);
-     my $objs = join(&quot;\n&quot;, map { $_.$objext } @{$args{objs}});
-     my $linklibs = join(&quot;&quot;,
-			 map { &quot;\n$_&quot; } compute_lib_depends(@{$args{deps}}));
-     my $deps = join(&quot; &quot;,
-		     (map { $_.$objext } @{$args{objs}}),
-		     compute_lib_depends(@{$args{deps}}));
+     my @objs = map { (my $x = $_) =~ s|\.o$|$objext|; $x } @{$args{objs}};
+     my @deps = compute_lib_depends(@{$args{deps}});
+     my $objs = join(&quot;\n&quot;, @objs);
+     my $linklibs = join(&quot;&quot;, map { &quot;$_\n&quot; } @deps);
+     my $deps = join(&quot; &quot;, @objs, @deps);
      return &lt;&lt;&quot;EOF&quot;;
 $dso$dsoext: $deps
 	IF EXIST $dso$dsoext.manifest DEL /F /Q $dso$dsoext.manifest
@@ -549,7 +547,8 @@ EXPORTS
     bind_engine		@1
     v_check		@2
 &lt;&lt;
-$objs$linklibs \$(EX_LIBS)
+$objs
+$linklibs \$(EX_LIBS)
 &lt;&lt;
 	IF EXIST $dso$dsoext.manifest \\
 	   \$(MT) \$(MTFLAGS) \$(MTINFLAG)$dso$dsoext.manifest \$(MTOUTFLAG)$dso$dsoext
@@ -565,29 +564,31 @@ EOF
      return &quot;&quot; unless $disabled{&quot;shared&quot;} || $lib =~ /\.a$/;
 
      $lib =~ s/\.a$//;
-     my $objs = join(&quot;\n&quot;, map { $_.$objext } @{$args{objs}});
-     my $deps = join(&quot; &quot;, map { $_.$objext } @{$args{objs}});
+     my @objs = map { (my $x = $_) =~ s|\.o$|$objext|; $x } @{$args{objs}};
+     my $objs = join(&quot;\n&quot;, @objs);
+     my $deps = join(&quot; &quot;, @objs);
      return &lt;&lt;&quot;EOF&quot;;
 $lib$libext: $deps
 	\$(AR) \$(ARFLAGS) \$(AROUTFLAG)$lib$libext @&lt;&lt;
-\$**
+$objs
 &lt;&lt;
 EOF
  }
  sub obj2bin {
      my %args = @_;
      my $bin = $args{bin};
-     my $objs = join(&quot;\n&quot;, map { $_.$objext } @{$args{objs}});
-     my $linklibs = join(&quot;&quot;,
-			 map { &quot;\n$_&quot; } compute_lib_depends(@{$args{deps}}));
-     my $deps = join(&quot; &quot;,
-		     (map { $_.$objext } @{$args{objs}}),
-		     compute_lib_depends(@{$args{deps}}));
+     my @objs = map { (my $x = $_) =~ s|\.o$|$objext|; $x } @{$args{objs}};
+     my @deps = compute_lib_depends(@{$args{deps}});
+     my $objs = join(&quot;\n&quot;, @objs);
+     my $linklibs = join(&quot;&quot;, map { &quot;$_\n&quot; } @deps);
+     my $deps = join(&quot; &quot;, @objs, @deps);
      return &lt;&lt;&quot;EOF&quot;;
 $bin$exeext: $deps
 	IF EXIST $bin$exeext.manifest DEL /F /Q $bin$exeext.manifest
 	\$(LD) \$(LDFLAGS) \$(BIN_LDFLAGS) \$(LDOUTFLAG)$bin$exeext @&lt;&lt;
-$objs setargv.obj$linklibs \$(EX_LIBS)
+$objs
+setargv.obj
+$linklibs\$(EX_LIBS)
 &lt;&lt;
 	IF EXIST $bin$exeext.manifest \\
 	   \$(MT) \$(MTFLAGS) \$(MTINFLAG)$bin$exeext.manifest \$(MTOUTFLAG)$bin$exeext
diff --git a/Configure b/Configure
index db19121..5abbd72 100755
--- a/Configure
+++ b/Configure
@@ -879,9 +879,48 @@ my %target = resolve_config($target);
 
 &amp;usage if (!%target || $target{template});
 
+%target = ( %{$table{DEFAULTS}}, %target );
+
+# Make the flags to build DSOs the same as for shared libraries unless they
+# are already defined
+$target{dso_cflags} = $target{shared_cflag} unless defined $target{dso_cflags};
+$target{dso_cxxflags} = $target{shared_cxxflag} unless defined $target{dso_cxxflags};
+$target{dso_lflags} = $target{shared_ldflag} unless defined $target{dso_lflags};
+{
+    my $shared_info_pl =
+        catfile(dirname($0), &quot;Configurations&quot;, &quot;shared-info.pl&quot;);
+    my %shared_info = read_eval_file($shared_info_pl);
+    push @{$target{_conf_fname_int}}, $shared_info_pl;
+    my $si = $target{shared_target};
+    while (ref $si ne &quot;HASH&quot;) {
+        last if ! defined $si;
+        if (ref $si eq &quot;CODE&quot;) {
+            $si = $si-&gt;();
+        } else {
+            $si = $shared_info{$si};
+        }
+    }
+
+    # Some of the 'shared_target' values don't have any entried in
+    # %shared_info.  That's perfectly fine, AS LONG AS the build file
+    # template knows how to handle this.  That is currently the case for
+    # Windows and VMS.
+    if (defined $si) {
+        # Just as above, copy certain shared_* attributes to the corresponding
+        # dso_ attribute unless the latter is already defined
+        $si-&gt;{dso_cflags} = $si-&gt;{shared_cflag} unless defined $si-&gt;{dso_cflags};
+        $si-&gt;{dso_cxxflags} = $si-&gt;{shared_cxxflag} unless defined $si-&gt;{dso_cxxflags};
+        $si-&gt;{dso_lflags} = $si-&gt;{shared_ldflag} unless defined $si-&gt;{dso_lflags};
+        foreach (sort keys %$si) {
+            $target{$_} = defined $target{$_}
+                ? add($si-&gt;{$_})-&gt;($target{$_})
+                : $si-&gt;{$_};
+        }
+    }
+}
+
 my %conf_files = map { $_ =&gt; 1 } (@{$target{_conf_fname_int}});
 $config{conf_files} = [ sort keys %conf_files ];
-%target = ( %{$table{DEFAULTS}}, %target );
 
 foreach my $feature (@{$target{disable}}) {
     if (exists $deprecated_disablables{$feature}) {
@@ -1163,8 +1202,11 @@ unless ($disabled{&quot;fuzz-libfuzzer&quot;} &amp;&amp; $disabled{&quot;fuzz-afl&quot;}
 # This saves the build files from having to check
 if ($disabled{pic})
 	{
-	$target{shared_cflag} = $target{shared_ldflag} =
-		$target{shared_rcflag} = &quot;&quot;;
+	foreach (qw(shared_cflag shared_cxxflag shared_ldflag
+		    dso_cflags dso_cxxflags dso_lflags))
+		{
+		$target{$_} = &quot;&quot;;
+		}
 	}
 else
 	{
@@ -1833,14 +1875,27 @@ EOF
                 if (! -f $s) {
                     $s = cleanfile($buildd, $_, $blddir);
                 }
-                # We recognise C++, C and asm files
+
                 if ($s =~ /\.(cc|cpp|c|s|S)$/) {
+                    # We recognise C++, C and asm files
                     my $o = $_;
                     $o =~ s/\.[csS]$/.o/; # C and assembler
                     $o =~ s/\.(cc|cpp)$/_cc.o/; # C++
                     $o = cleanfile($buildd, $o, $blddir);
                     $unified_info{shared_sources}-&gt;{$ddest}-&gt;{$o} = 1;
                     $unified_info{sources}-&gt;{$o}-&gt;{$s} = 1;
+                } elsif ($s =~ /\.rc$/) {
+                    # We also recognise resource files
+                    my $o = $_;
+                    $o =~ s/\.rc$/.res/; # Resource configuration
+                    my $o = cleanfile($buildd, $o, $blddir);
+                    $unified_info{shared_sources}-&gt;{$ddest}-&gt;{$o} = 1;
+                    $unified_info{sources}-&gt;{$o}-&gt;{$s} = 1;
+                } elsif ($s =~ /\.(def|map|opt)$/) {
+                    # We also recognise .def / .map / .opt files
+                    # We know they are generated files
+                    my $def = cleanfile($buildd, $s, $blddir);
+                    $unified_info{shared_sources}-&gt;{$ddest}-&gt;{$def} = 1;
                 } else {
                     die &quot;unrecognised source file type for shared library: $s\n&quot;;
                 }
@@ -2292,25 +2347,38 @@ sub add {
     sub { _add($separator, @_, @x) };
 }
 
+sub read_eval_file {
+    my $fname = shift;
+    my $content;
+    my @result;
+
+    open F, &quot;&lt; $fname&quot; or die &quot;Can't open '$fname': $!\n&quot;;
+    {
+        undef local $/;
+        $content = &lt;F&gt;;
+    }
+    close F;
+    {
+        local $@;
+
+        @result = ( eval $content );
+        warn $@ if $@;
+    }
+    return wantarray ? @result : $result[0];
+}
+
 # configuration reader, evaluates the input file as a perl script and expects
 # it to fill %targets with target configurations.  Those are then added to
 # %table.
 sub read_config {
     my $fname = shift;
-    open(CONFFILE, &quot;&lt; $fname&quot;)
-	or die &quot;Can't open configuration file '$fname'!\n&quot;;
-    my $x = $/;
-    undef $/;
-    my $content = &lt;CONFFILE&gt;;
-    $/ = $x;
-    close(CONFFILE);
-    my %targets = ();
+    my %targets;
+
     {
 	# Protect certain tables from tampering
-	local %table = %::table;
+	local %table = ();
 
-	eval $content;
-	warn $@ if $@;
+	%targets = read_eval_file($fname);
     }
 
     # For each target, check that it's configured with a hash table.
diff --git a/Makefile.shared b/Makefile.shared
deleted file mode 100644
index 1053989..0000000
--- a/Makefile.shared
+++ /dev/null
@@ -1,521 +0,0 @@
-#
-# Helper makefile to link shared libraries in a portable way.
-# This is much simpler than libtool, and hopefully not too error-prone.
-#
-# The following variables need to be set on the command line to build
-# properly
-
-# CC contains the current compiler.  This one MUST be defined
-CC=cc
-CFLAGS=$(CFLAG)
-# LDFLAGS contains flags to be used when temporary object files (when building
-# shared libraries) are created, or when an application is linked.
-# SHARED_LDFLAGS contains flags to be used when the shared library is created.
-LDFLAGS=$(LDFLAG)
-SHARED_LDFLAGS=$(SHARED_LDFLAG)
-
-RC=windres
-# SHARED_RCFLAGS are flags used with windres, i.e. when build for Cygwin
-# or Mingw.
-SHARED_RCFLAGS=$(SHARED_RCFLAG)
-
-NM=nm
-ECHO=echo
-
-# LIBNAME contains just the name of the library, without prefix (&quot;lib&quot;
-# on Unix, &quot;cyg&quot; for certain forms under Cygwin...) or suffix (.a, .so,
-# .dll, ...).  This one MUST have a value when using this makefile to
-# build shared libraries.
-# For example, to build libfoo.so, you need to do the following:
-#LIBNAME=foo
-LIBNAME=
-
-# STLIBNAME contains the path of the static library to build the shared
-# library from, for example:
-#STLIBNAME=libfoo.a
-STLIBNAME=
-
-# On most Unix platforms, SHLIBNAME contains the path of the short name of
-# the shared library to build, for example
-#SHLIBNAME=libfoo.so
-# On Windows POSIX layers (cygwin and mingw), SHLIBNAME contains the import
-# library name for the shared library to be built, for example:
-#SHLIBNAME=libfoo.dll.a
-
-# SHLIBNAME_FULL contains the path of the full name of the shared library to
-# build, for example:
-#SHLIBNAME_FULL=libfoo.so.1.2
-# When building DSOs, SHLIBNAME_FULL contains path of the full DSO name, for
-# example:
-#SHLIBNAME_FULL=dir/dso.so
-SHLIBNAME_FULL=
-
-# SHLIBVERSION contains the current version of the shared library (not to
-# be confused with the project version)
-#SHLIBVERSION=1.2
-SHLIBVERSION=
-
-# NOTE: to build shared libraries, LIBNAME, STLIBNAME, SHLIBNAME and
-# SHLIBNAME_FULL MUST have values when using this makefile, and in some
-# cases, SHLIBVERSION as well.  To build DSOs, SHLIBNAME_FULL MUST have
-# a value, the rest can be left alone.
-
-
-# APPNAME contains just the name of the application, without suffix (&quot;&quot;
-# on Unix, &quot;.exe&quot; on Windows, ...).  This one MUST have a value when using
-# this makefile to build applications.
-# For example, to build foo, you need to do the following:
-#APPNAME=foo
-APPNAME=
-
-# SRCDIR is the top directory of the source tree.
-SRCDIR=.
-
-# OBJECTS contains all the object files to link together into the application.
-# This must contain at least one object file.
-#OBJECTS=foo.o
-OBJECTS=
-
-# LIBEXTRAS contains extra modules to link together with the library.
-# For example, if a second library, say libbar.a needs to be linked into
-# libfoo.so, you need to do the following:
-#LIBEXTRAS=libbar.a
-# Note that this MUST be used when using the link_dso targets, to hold the
-# names of all object files that go into the target shared object.
-LIBEXTRAS=
-
-# LIBDEPS contains all the flags necessary to cover all necessary
-# dependencies to other libraries.
-LIBDEPS=
-
-#------------------------------------------------------------------------------
-# The rest is private to this makefile.
-
-SET_X=:
-#SET_X=set -x
-
-top:
-	echo &quot;Trying to use this makefile interactively?  Don't.&quot; ; exit 1
-
-LINK_APP=	\
-  ( $(SET_X);   \
-    LIBDEPS=&quot;$${LIBDEPS:-$(LIBDEPS)}&quot;; \
-    LDCMD=&quot;$${LDCMD:-$(CC)}&quot;; LDFLAGS=&quot;$${LDFLAGS:-$(CFLAGS) $(LDFLAGS)}&quot;; \
-    LIBPATH=`for x in $$LIBDEPS; do echo $$x; done | sed -e 's/^ *-L//;t' -e d | uniq`; \
-    LIBPATH=`echo $$LIBPATH | sed -e 's/ /:/g'`; \
-    $(ECHO) LD_LIBRARY_PATH=$$LIBPATH:$$LD_LIBRARY_PATH \
-        $${LDCMD} $${LDFLAGS} -o $${APPNAME:=$(APPNAME)} $(OBJECTS) $${LIBDEPS}; \
-    LD_LIBRARY_PATH=$$LIBPATH:$$LD_LIBRARY_PATH \
-    $${LDCMD} $${LDFLAGS} -o $${APPNAME:=$(APPNAME)} $(OBJECTS) $${LIBDEPS} )
-
-LINK_SO=	\
-  ( $(SET_X);   \
-    LIBDEPS=&quot;$${LIBDEPS:-$(LIBDEPS)}&quot;; \
-    SHAREDCMD=&quot;$${SHAREDCMD:-$(CC)}&quot;; \
-    SHAREDFLAGS=&quot;$${SHAREDFLAGS:-$(CFLAGS) $(SHARED_LDFLAGS)}&quot;; \
-    LIBPATH=`for x in $$LIBDEPS; do echo $$x; done | sed -e 's/^ *-L//;t' -e d | uniq`; \
-    LIBPATH=`echo $$LIBPATH | sed -e 's/ /:/g'`; \
-    $(ECHO) LD_LIBRARY_PATH=$$LIBPATH:$$LD_LIBRARY_PATH \
-         $${SHAREDCMD} $${SHAREDFLAGS} \
-	     -o $(SHLIBNAME_FULL) \
-	     $$ALLSYMSFLAGS $$SHOBJECTS $$NOALLSYMSFLAGS $$LIBDEPS; \
-    LD_LIBRARY_PATH=$$LIBPATH:$$LD_LIBRARY_PATH \
-    $${SHAREDCMD} $${SHAREDFLAGS} \
-	-o $(SHLIBNAME_FULL) \
-	$$ALLSYMSFLAGS $$SHOBJECTS $$NOALLSYMSFLAGS $$LIBDEPS \
-  ) &amp;&amp; $(SYMLINK_SO)
-
-SYMLINK_SO=	\
-	if [ -n &quot;$$INHIBIT_SYMLINKS&quot; ]; then :; else \
-		if [ -n &quot;$(SHLIBNAME_FULL)&quot; -a -n &quot;$(SHLIBNAME)&quot; -a \
-		     &quot;$(SHLIBNAME_FULL)&quot; != &quot;$(SHLIBNAME)&quot; ]; then \
-			( $(SET_X); \
-			  rm -f $(SHLIBNAME); \
-			  ln -s $(SHLIBNAME_FULL) $(SHLIBNAME) ); \
-		fi; \
-	fi
-
-LINK_SO_SHLIB=	SHOBJECTS=&quot;$(STLIBNAME) $(LIBEXTRAS)&quot;; $(LINK_SO)
-LINK_SO_DSO=	INHIBIT_SYMLINKS=yes; SHOBJECTS=&quot;$(LIBEXTRAS)&quot;; $(LINK_SO)
-
-LINK_SO_SHLIB_VIA_O=	\
-  SHOBJECTS=$(STLIBNAME).o; \
-  ALL=$$ALLSYMSFLAGS; ALLSYMSFLAGS=; NOALLSYMSFLAGS=; \
-  ( $(ECHO) ld $(LDFLAGS) -r -o $$SHOBJECTS $$ALL $(STLIBNAME) $(LIBEXTRAS); \
-    ld $(LDFLAGS) -r -o $$SHOBJECTS $$ALL $(STLIBNAME) $(LIBEXTRAS) ); \
-  $(LINK_SO) &amp;&amp; ( $(ECHO) rm -f $$SHOBJECTS; rm -f $$SHOBJECTS )
-
-LINK_SO_SHLIB_UNPACKED=	\
-  UNPACKDIR=link_tmp.$$$$; rm -rf $$UNPACKDIR; mkdir $$UNPACKDIR; \
-  (cd $$UNPACKDIR; ar x ../$(STLIBNAME)) &amp;&amp; \
-  ([ -z &quot;$(LIBEXTRAS)&quot; ] || cp $(LIBEXTRAS) $$UNPACKDIR) &amp;&amp; \
-  SHOBJECTS=$$UNPACKDIR/*.o; \
-  $(LINK_SO) &amp;&amp; rm -rf $$UNPACKDIR
-
-DETECT_GNU_LD=($(CC) -Wl,-V /dev/null 2&gt;&amp;1 | grep '^GNU ld' )&gt;/dev/null
-
-DO_GNU_SO_COMMON=\
-	SHAREDFLAGS=&quot;$(CFLAGS) $(SHARED_LDFLAGS) -shared -Wl,-Bsymbolic -Wl,-soname=$(SHLIBNAME_FULL)&quot;
-DO_GNU_DSO=\
-	$(DO_GNU_SO_COMMON)
-DO_GNU_SO=\
-	ALLSYMSFLAGS='-Wl,--whole-archive'; \
-	NOALLSYMSFLAGS='-Wl,--no-whole-archive'; \
-	$(DO_GNU_SO_COMMON)
-DO_GNU_APP=LDFLAGS=&quot;$(CFLAGS) $(LDFLAGS)&quot;
-
-#This is rather special.  It's a special target with which one can link
-#applications without bothering with any features that have anything to
-#do with shared libraries, for example when linking against static
-#libraries.  It's mostly here to avoid a lot of conditionals everywhere
-#else...
-link_app.:
-	$(LINK_APP)
-
-link_dso.gnu:
-	@ $(DO_GNU_DSO); $(LINK_SO_DSO)
-link_shlib.gnu:
-	@ $(DO_GNU_SO); $(LINK_SO_SHLIB)
-link_app.gnu:
-	@ $(DO_GNU_APP); $(LINK_APP)
-
-link_shlib.linux-shared:
-	@$(PERL) $(SRCDIR)/util/mkdef.pl $(LIBNAME) linux &gt;$(LIBNAME).map; \
-	$(DO_GNU_SO); \
-	ALLSYMSFLAGS='-Wl,--whole-archive,--version-script=$(LIBNAME).map'; \
-	$(LINK_SO_SHLIB)
-
-link_dso.bsd:
-	@if $(DETECT_GNU_LD); then $(DO_GNU_DSO); else \
-	LIBDEPS=&quot; &quot;; \
-	ALLSYMSFLAGS=; \
-	NOALLSYMSFLAGS=; \
-	SHAREDFLAGS=&quot;$(CFLAGS) $(SHARED_LDFLAGS) -shared -nostdlib&quot;; \
-	fi; $(LINK_SO_DSO)
-link_shlib.bsd:
-	@if $(DETECT_GNU_LD); then $(DO_GNU_SO); else \
-	LIBDEPS=&quot; &quot;; \
-	ALLSYMSFLAGS=&quot;-Wl,-Bforcearchive&quot;; \
-	NOALLSYMSFLAGS=; \
-	SHAREDFLAGS=&quot;$(CFLAGS) $(SHARED_LDFLAGS) -shared -nostdlib&quot;; \
-	fi; $(LINK_SO_SHLIB)
-link_app.bsd:
-	@if $(DETECT_GNU_LD); then $(DO_GNU_APP); else \
-	LDFLAGS=&quot;$(CFLAGS) $(LDFLAGS)&quot;; \
-	fi; $(LINK_APP)
-
-# For Darwin AKA Mac OS/X (dyld)
-# Originally link_dso.darwin produced .so, because it was hard-coded
-# in dso_dlfcn module. At later point dso_dlfcn switched to .dylib
-# extension in order to allow for run-time linking with vendor-
-# supplied shared libraries such as libz, so that link_dso.darwin had
-# to be harmonized with it. This caused minor controversy, because
-# it was believed that dlopen can't be used to dynamically load
-# .dylib-s, only so called bundle modules (ones linked with -bundle
-# flag). The belief seems to be originating from pre-10.4 release,
-# where dlfcn functionality was emulated by dlcompat add-on. In
-# 10.4 dlopen was rewritten as native part of dyld and is documented
-# to be capable of loading both dynamic libraries and bundles. In
-# order to provide compatibility with pre-10.4 dlopen, modules are
-# linked with -bundle flag, which makes .dylib extension misleading.
-# It works, because dlopen is [and always was] extension-agnostic.
-# Alternative to this heuristic approach is to develop specific
-# MacOS X dso module relying on whichever &quot;native&quot; dyld interface.
-link_dso.darwin:
-	@ ALLSYMSFLAGS=''; \
-	NOALLSYMSFLAGS=''; \
-	SHAREDFLAGS=&quot;$(CFLAGS) `echo $(SHARED_LDFLAGS) | sed s/dynamiclib/bundle/`&quot;; \
-	$(LINK_SO_DSO)
-link_shlib.darwin:
-	@ ALLSYMSFLAGS='-all_load'; \
-	NOALLSYMSFLAGS=''; \
-	SHAREDFLAGS=&quot;$(CFLAGS) $(SHARED_LDFLAGS) -current_version $(SHLIBVERSION) -compatibility_version $(SHLIBVERSION) -install_name $(INSTALLTOP)/$(LIBDIR)/$(SHLIBNAME_FULL)&quot;; \
-	$(LINK_SO_SHLIB)
-link_app.darwin:	# is there run-path on darwin?
-	$(LINK_APP)
-
-link_dso.cygwin:
-	@ALLSYMSFLAGS=''; \
-	NOALLSYMSFLAGS=''; \
-	base=-Wl,--enable-auto-image-base; \
-	SHAREDFLAGS=&quot;$(CFLAGS) $(SHARED_LDFLAGS) -shared $$base -Wl,-Bsymbolic&quot;; \
-	$(LINK_SO_DSO)
-link_shlib.cygwin:
-	@ INHIBIT_SYMLINKS=yes; \
-	$(ECHO) &quot;$(PERL) $(SRCDIR)/util/mkrc.pl $(SHLIBNAME_FULL) |&quot; \
-		     &quot;$(RC) $(SHARED_RCFLAGS) -o rc.o&quot;; \
-	$(PERL) $(SRCDIR)/util/mkrc.pl $(SHLIBNAME_FULL) | \
-		$(RC) $(SHARED_RCFLAGS) -o rc.o; \
-	ALLSYMSFLAGS='-Wl,--whole-archive'; \
-	NOALLSYMSFLAGS='-Wl,--no-whole-archive'; \
-	SHAREDFLAGS=&quot;$(CFLAGS) $(SHARED_LDFLAGS) -shared -Wl,--enable-auto-image-base -Wl,-Bsymbolic -Wl,--out-implib,$(SHLIBNAME) rc.o&quot;; \
-	$(LINK_SO_SHLIB) || exit 1; \
-	rm rc.o
-link_app.cygwin:
-	$(LINK_APP)
-
-# link_dso.mingw-shared and link_app.mingw-shared are mapped to the
-# corresponding cygwin targets, as they do the exact same thing.
-link_shlib.mingw:
-	@ INHIBIT_SYMLINKS=yes; \
-	$(PERL) $(SRCDIR)/util/mkdef.pl 32 $(LIBNAME) \
-		| sed -e 's|^\(LIBRARY  *\)$(LIBNAME)32|\1$(SHLIBNAME_FULL)|' \
-		&gt; $(LIBNAME).def; \
-	echo &quot;$(PERL) $(SRCDIR)/util/mkrc.pl $(SHLIBNAME_FULL) |&quot; \
-		&quot;$(RC) $(SHARED_RCFLAGS) -o rc.o&quot;; \
-	$(PERL) $(SRCDIR)/util/mkrc.pl $(SHLIBNAME_FULL) | \
-		$(RC) $(SHARED_RCFLAGS) -o rc.o; \
-	ALLSYMSFLAGS='-Wl,--whole-archive'; \
-	NOALLSYMSFLAGS='-Wl,--no-whole-archive'; \
-	SHAREDFLAGS=&quot;$(CFLAGS) $(SHARED_LDFLAGS) -shared -Wl,-Bsymbolic -Wl,--out-implib,$(SHLIBNAME) $(LIBNAME).def rc.o&quot;; \
-	$(LINK_SO_SHLIB) || exit 1; \
-	rm $(LIBNAME).def rc.o
-
-link_dso.alpha-osf1:
-	@ if $(DETECT_GNU_LD); then \
-		$(DO_GNU_DSO); \
-	else \
-		ALLSYMSFLAGS=''; \
-		NOALLSYMSFLAGS=''; \
-		SHAREDFLAGS=&quot;$(CFLAGS) $(SHARED_LDFLAGS) -shared -Wl,-B,symbolic&quot;; \
-	fi; \
-	$(LINK_SO_DSO)
-link_shlib.alpha-osf1:
-	@ if $(DETECT_GNU_LD); then \
-		$(DO_GNU_SO); \
-	else \
-		ALLSYMSFLAGS='-all'; \
-		NOALLSYMSFLAGS='-none'; \
-		SHAREDFLAGS=&quot;$(CFLAGS) $(SHARED_LDFLAGS) -shared -Wl,-B,symbolic -set_version $(SHLIBVERSION)&quot;; \
-	fi; \
-	$(LINK_SO_SHLIB)
-link_app.alpha-osf1:
-	@if $(DETECT_GNU_LD); then \
-		$(DO_GNU_APP); \
-	else \
-		LDFLAGS=&quot;$(CFLAGS) $(LDFLAGS)&quot;; \
-	fi; \
-	$(LINK_APP)
-
-link_dso.solaris:
-	@ if $(DETECT_GNU_LD); then \
-		$(DO_GNU_DSO); \
-	else \
-		ALLSYMSFLAGS=&quot;&quot;; \
-		NOALLSYMSFLAGS=&quot;&quot;; \
-		SHAREDFLAGS=&quot;$(CFLAGS) $(SHARED_LDFLAGS) -h $(SHLIBNAME_FULL) -Wl,-Bsymbolic&quot;; \
-	fi; \
-	$(LINK_SO_DSO)
-link_shlib.solaris:
-	@ if $(DETECT_GNU_LD); then \
-		$(DO_GNU_SO); \
-	else \
-		$(PERL) $(SRCDIR)/util/mkdef.pl $(LIBNAME) linux &gt;$(LIBNAME).map; \
-		ALLSYMSFLAGS=&quot;-Wl,-z,allextract,-M,$(LIBNAME).map&quot;; \
-		NOALLSYMSFLAGS=&quot;-Wl,-z,defaultextract&quot;; \
-		SHAREDFLAGS=&quot;$(CFLAGS) $(SHARED_LDFLAGS) -h $(SHLIBNAME_FULL) -Wl,-Bsymbolic&quot;; \
-	fi; \
-	$(LINK_SO_SHLIB)
-link_app.solaris:
-	@ if $(DETECT_GNU_LD); then \
-		$(DO_GNU_APP); \
-	else \
-		LDFLAGS=&quot;$(CFLAGS) $(LDFLAGS)&quot;; \
-	fi; \
-	$(LINK_APP)
-
-# OpenServer 5 native compilers used
-link_dso.svr3:
-	@ if $(DETECT_GNU_LD); then \
-		$(DO_GNU_DSO); \
-	else \
-		ALLSYMSFLAGS=''; \
-		NOALLSYMSFLAGS=''; \
-		SHAREDFLAGS=&quot;$(CFLAGS) -G -h $(SHLIBNAME_FULL)&quot;; \
-	fi; \
-	$(LINK_SO_DSO)
-link_shlib.svr3:
-	@ if $(DETECT_GNU_LD); then \
-		$(DO_GNU_SO); \
-	else \
-		ALLSYMSFLAGS=''; \
-		NOALLSYMSFLAGS=''; \
-		SHAREDFLAGS=&quot;$(CFLAGS) -G -h $(SHLIBNAME_FULL)&quot;; \
-	fi; \
-	$(LINK_SO_SHLIB_UNPACKED)
-link_app.svr3:
-	@$(DETECT_GNU_LD) &amp;&amp; $(DO_GNU_APP); \
-	$(LINK_APP)
-
-# UnixWare 7 and OpenUNIX 8 native compilers used
-link_dso.svr5:
-	@ if $(DETECT_GNU_LD); then \
-		$(DO_GNU_DSO); \
-	else \
-		SHARE_FLAG='-G'; \
-		($(CC) -v 2&gt;&amp;1 | grep gcc) &gt; /dev/null &amp;&amp; SHARE_FLAG='-shared'; \
-		ALLSYMSFLAGS=''; \
-		NOALLSYMSFLAGS=''; \
-		SHAREDFLAGS=&quot;$(CFLAGS) $${SHARE_FLAG} -h $(SHLIBNAME_FULL)&quot;; \
-	fi; \
-	$(LINK_SO_DSO)
-link_shlib.svr5:
-	@ if $(DETECT_GNU_LD); then \
-		$(DO_GNU_SO); \
-	else \
-		SHARE_FLAG='-G'; \
-		($(CC) -v 2&gt;&amp;1 | grep gcc) &gt; /dev/null &amp;&amp; SHARE_FLAG='-shared'; \
-		ALLSYMSFLAGS=''; \
-		NOALLSYMSFLAGS=''; \
-		SHAREDFLAGS=&quot;$(CFLAGS) $${SHARE_FLAG} -h $(SHLIBNAME_FULL)&quot;; \
-	fi; \
-	$(LINK_SO_SHLIB_UNPACKED)
-link_app.svr5:
-	@$(DETECT_GNU_LD) &amp;&amp; $(DO_GNU_APP); \
-	$(LINK_APP)
-
-link_dso.irix:
-	@ if $(DETECT_GNU_LD); then \
-		$(DO_GNU_DSO); \
-	else \
-		ALLSYMSFLAGS=&quot;&quot;; \
-		NOALLSYMSFLAGS=&quot;&quot;; \
-		SHAREDFLAGS=&quot;$(CFLAGS) $(SHARED_LDFLAGS) -shared -Wl,-soname,$(SHLIBNAME_FULL),-B,symbolic&quot;; \
-	fi; \
-	$(LINK_SO_DSO)
-link_shlib.irix:
-	@ if $(DETECT_GNU_LD); then \
-		$(DO_GNU_SO); \
-	else \
-		MINUSWL=&quot;&quot;; \
-		($(CC) -v 2&gt;&amp;1 | grep gcc) &gt; /dev/null &amp;&amp; MINUSWL=&quot;-Wl,&quot;; \
-		ALLSYMSFLAGS=&quot;$${MINUSWL}-all&quot;; \
-		NOALLSYMSFLAGS=&quot;$${MINUSWL}-none&quot;; \
-		SHAREDFLAGS=&quot;$(CFLAGS) $(SHARED_LDFLAGS) -shared -Wl,-soname,$(SHLIBNAME_FULL),-B,symbolic&quot;; \
-	fi; \
-	$(LINK_SO_SHLIB)
-link_app.irix:
-	@LDFLAGS=&quot;$(CFLAGS) $(LDFLAGS)&quot;; \
-	$(LINK_APP)
-
-# 32-bit PA-RISC HP-UX embeds the -L pathname of libs we link with, so
-# we compensate for it with +cdp ../: and +cdp ./:. Yes, these rewrite
-# rules imply that we can only link one level down in catalog structure,
-# but that's what takes place for the moment of this writing. +cdp option
-# was introduced in HP-UX 11.x and applies in 32-bit PA-RISC link
-# editor context only [it's simply ignored in other cases, which are all
-# ELFs by the way].
-#
-link_dso.hpux:
-	@if $(DETECT_GNU_LD); then $(DO_GNU_DSO); else \
-	ALLSYMSFLAGS=''; \
-	NOALLSYMSFLAGS=''; \
-	expr $(PLATFORM) : 'hpux64' &gt; /dev/null &amp;&amp; ALLSYMSFLAGS='-Wl,+forceload'; \
-	SHAREDFLAGS=&quot;$(CFLAGS) $(SHARED_LDFLAGS) -Wl,-B,symbolic,+vnocompatwarnings,-z,+s,+h,$(SHLIBNAME_FULL),+cdp,../:,+cdp,./:&quot;; \
-	fi; \
-	rm -f $(SHLIBNAME_FULL) || :; \
-	$(LINK_SO_DSO) &amp;&amp; chmod a=rx $(SHLIBNAME_FULL)
-link_shlib.hpux:
-	@if $(DETECT_GNU_LD); then $(DO_GNU_SO); else \
-	ALLSYMSFLAGS='-Wl,-Fl'; \
-	NOALLSYMSFLAGS=''; \
-	expr $(PLATFORM) : 'hpux64' &gt; /dev/null &amp;&amp; ALLSYMSFLAGS='-Wl,+forceload'; \
-	SHAREDFLAGS=&quot;$(CFLAGS) $(SHARED_LDFLAGS) -Wl,-B,symbolic,+vnocompatwarnings,-z,+s,+h,$(SHLIBNAME_FULL),+cdp,../:,+cdp,./:&quot;; \
-	fi; \
-	rm -f $(SHLIBNAME_FULL) || :; \
-	$(LINK_SO_SHLIB) &amp;&amp; chmod a=rx $(SHLIBNAME_FULL)
-link_app.hpux:
-	@if $(DETECT_GNU_LD); then $(DO_GNU_APP); else \
-	LDFLAGS=&quot;$(CFLAGS) $(LDFLAGS) -Wl,+s,+cdp,../:,+cdp,./:&quot;; \
-	fi; \
-	$(LINK_APP)
-
-link_dso.aix:
-	@OBJECT_MODE=`expr &quot;x$(SHARED_LDFLAGS)&quot; : 'x\-[a-z]*\(64\)'` || :; \
-	OBJECT_MODE=$${OBJECT_MODE:-32}; export OBJECT_MODE; \
-	ALLSYMSFLAGS=''; \
-	NOALLSYMSFLAGS=''; \
-	SHAREDFLAGS='$(CFLAGS) $(SHARED_LDFLAGS) -Wl,-bexpall,-bnolibpath,-bM:SRE'; \
-	rm -f $(SHLIBNAME_FULL) 2&gt;&amp;1 &gt; /dev/null ; \
-	$(LINK_SO_DSO);
-link_shlib.aix:
-	@ OBJECT_MODE=`expr &quot;x$(SHARED_LDFLAGS)&quot; : 'x\-[a-z]*\(64\)'` || : ; \
-	OBJECT_MODE=$${OBJECT_MODE:-32}; export OBJECT_MODE; \
-	ALLSYMSFLAGS='-bnogc'; \
-	NOALLSYMSFLAGS=''; \
-	SHAREDFLAGS='$(CFLAGS) $(SHARED_LDFLAGS) -Wl,-bexpall,-bnolibpath,-bM:SRE'; \
-	rm -f $(SHLIBNAME_FULL) 2&gt;&amp;1 &gt; /dev/null ; \
-	$(LINK_SO_SHLIB_VIA_O)
-link_app.aix:
-	LDFLAGS=&quot;$(CFLAGS) -Wl,-bsvr4 $(LDFLAGS)&quot;; \
-	$(LINK_APP)
-
-
-# Targets to build symbolic links when needed
-symlink.gnu symlink.solaris symlink.svr3 symlink.svr5 symlink.irix \
-symlink.aix:
-	@ $(SYMLINK_SO)
-symlink.darwin:
-	@ $(SYMLINK_SO)
-symlink.hpux:
-	@ $(SYMLINK_SO)
-# The following lines means those specific architectures do no symlinks
-symlink.cygwin symlink.alpha-osf1 symlink.tru64 symlink.tru64-rpath:
-
-# Compatibility targets
-link_dso.bsd-gcc-shared link_dso.linux-shared link_dso.gnu-shared: link_dso.gnu
-link_shlib.bsd-gcc-shared: link_shlib.linux-shared
-link_shlib.gnu-shared: link_shlib.gnu
-link_app.bsd-gcc-shared link_app.linux-shared link_app.gnu-shared: link_app.gnu
-symlink.bsd-gcc-shared symlink.bsd-shared symlink.linux-shared symlink.gnu-shared: symlink.gnu
-link_dso.bsd-shared: link_dso.bsd
-link_shlib.bsd-shared: link_shlib.bsd
-link_app.bsd-shared: link_app.bsd
-link_dso.darwin-shared: link_dso.darwin
-link_shlib.darwin-shared: link_shlib.darwin
-link_app.darwin-shared: link_app.darwin
-symlink.darwin-shared: symlink.darwin
-link_dso.cygwin-shared: link_dso.cygwin
-link_shlib.cygwin-shared: link_shlib.cygwin
-link_app.cygwin-shared: link_app.cygwin
-symlink.cygwin-shared: symlink.cygwin
-link_dso.mingw-shared: link_dso.cygwin
-link_shlib.mingw-shared: link_shlib.mingw
-link_app.mingw-shared: link_app.cygwin
-symlink.mingw-shared: symlink.cygwin
-link_dso.alpha-osf1-shared: link_dso.alpha-osf1
-link_shlib.alpha-osf1-shared: link_shlib.alpha-osf1
-link_app.alpha-osf1-shared: link_app.alpha-osf1
-symlink.alpha-osf1-shared: symlink.alpha-osf1
-link_dso.tru64-shared: link_dso.tru64
-link_shlib.tru64-shared: link_shlib.tru64
-link_app.tru64-shared: link_app.tru64
-symlink.tru64-shared: symlink.tru64
-link_dso.tru64-shared-rpath: link_dso.tru64-rpath
-link_shlib.tru64-shared-rpath: link_shlib.tru64-rpath
-link_app.tru64-shared-rpath: link_app.tru64-rpath
-symlink.tru64-shared-rpath: symlink.tru64-rpath
-link_dso.solaris-shared: link_dso.solaris
-link_shlib.solaris-shared: link_shlib.solaris
-link_app.solaris-shared: link_app.solaris
-symlink.solaris-shared: symlink.solaris
-link_dso.svr3-shared: link_dso.svr3
-link_shlib.svr3-shared: link_shlib.svr3
-link_app.svr3-shared: link_app.svr3
-symlink.svr3-shared: symlink.svr3
-link_dso.svr5-shared: link_dso.svr5
-link_shlib.svr5-shared: link_shlib.svr5
-link_app.svr5-shared: link_app.svr5
-symlink.svr5-shared: symlink.svr5
-link_dso.irix-shared: link_dso.irix
-link_shlib.irix-shared: link_shlib.irix
-link_app.irix-shared: link_app.irix
-symlink.irix-shared: symlink.irix
-link_dso.hpux-shared: link_dso.hpux
-link_shlib.hpux-shared: link_shlib.hpux
-link_app.hpux-shared: link_app.hpux
-symlink.hpux-shared: symlink.hpux
-link_dso.aix-shared: link_dso.aix
-link_shlib.aix-shared: link_shlib.aix
-link_app.aix-shared: link_app.aix
-symlink.aix-shared: symlink.aix
diff --git a/build.info b/build.info
index d00673f..fdf1d10 100644
--- a/build.info
+++ b/build.info
@@ -9,8 +9,6 @@
      &quot;&quot;;
 -}
 LIBS=libcrypto libssl
-ORDINALS[libcrypto]=crypto
-ORDINALS[libssl]=ssl
 INCLUDE[libcrypto]=. crypto/include include
 INCLUDE[libssl]=. include
 DEPEND[libssl]=libcrypto
@@ -26,6 +24,52 @@ GENERATE[crypto/include/internal/bn_conf.h]=crypto/include/internal/bn_conf.h.in
 DEPEND[crypto/include/internal/dso_conf.h]=configdata.pm
 GENERATE[crypto/include/internal/dso_conf.h]=crypto/include/internal/dso_conf.h.in
 
+IF[{- defined $target{shared_defflag} -}]
+  IF[{- $config{target} =~ /^mingw/ -}]
+    GENERATE[libcrypto.def]=util/mkdef.pl crypto 32
+    DEPEND[libcrypto.def]=util/libcrypto.num
+    GENERATE[libssl.def]=util/mkdef.pl ssl 32
+    DEPEND[libssl.def]=util/libssl.num
+
+    SHARED_SOURCE[libcrypto]=libcrypto.def
+    SHARED_SOURCE[libssl]=libssl.def
+  ELSE
+    GENERATE[libcrypto.map]=util/mkdef.pl crypto linux
+    DEPEND[libcrypto.map]=util/libcrypto.num
+    GENERATE[libssl.map]=util/mkdef.pl ssl linux
+    DEPEND[libssl.map]=util/libssl.num
+
+    SHARED_SOURCE[libcrypto]=libcrypto.map
+    SHARED_SOURCE[libssl]=libssl.map
+  ENDIF
+ENDIF
+# VMS and VC don't have parametrised .def / .symvec generation, so they get
+# special treatment, since we know they do use these files
+IF[{- $config{target} =~ /^VC-/ -}]
+  GENERATE[libcrypto.def]=util/mkdef.pl crypto 32
+  DEPEND[libcrypto.def]=util/libcrypto.num
+  GENERATE[libssl.def]=util/mkdef.pl ssl 32
+  DEPEND[libssl.def]=util/libssl.num
+
+  SHARED_SOURCE[libcrypto]=libcrypto.def
+  SHARED_SOURCE[libssl]=libssl.def
+ELSIF[{- $config{target} =~ /^vms/ -}]
+  GENERATE[libcrypto.opt]=util/mkdef.pl crypto 32
+  DEPEND[libcrypto.opt]=util/libcrypto.num
+  GENERATE[libssl.opt]=util/mkdef.pl ssl 32
+  DEPEND[libssl.opt]=util/libssl.num
+
+  SHARED_SOURCE[libcrypto]=libcrypto.opt
+  SHARED_SOURCE[libssl]=libssl.opt
+ENDIF
+
+IF[{- $config{target} =~ /^(?:Cygwin|mingw|VC-)/ -}]
+  GENERATE[libcrypto.rc]=util/mkrc.pl libcrypto
+  GENERATE[libssl.rc]=util/mkrc.pl libssl
+
+  SHARED_SOURCE[libcrypto]=libcrypto.rc
+  SHARED_SOURCE[libssl]=libssl.rc
+ENDIF
 
 IF[{- $config{target} =~ /^Cygwin/ -}]
  SHARED_NAME[libcrypto]=cygcrypto-{- $sover_filename -}
diff --git a/util/mkdef.pl b/util/mkdef.pl
index 1e0da1c..828ddc0 100755
--- a/util/mkdef.pl
+++ b/util/mkdef.pl
@@ -228,16 +228,9 @@ foreach (@ARGV, split(/ /, $config{options}))
 		$zlib = 1;
 	}
 
-	$do_ssl=1 if $_ eq &quot;libssl&quot;;
-	if ($_ eq &quot;ssl&quot;) {
-		$do_ssl=1;
-		$libname=$_
-	}
-	$do_crypto=1 if $_ eq &quot;libcrypto&quot;;
-	if ($_ eq &quot;crypto&quot;) {
-		$do_crypto=1;
-		$libname=$_;
-	}
+	$do_crypto=1 if $_ eq &quot;libcrypto&quot; || $_ eq &quot;crypto&quot;;
+	$do_ssl=1 if $_ eq &quot;libssl&quot; || $_ eq &quot;ssl&quot;;
+
 	$do_update=1 if $_ eq &quot;update&quot;;
 	$do_rewrite=1 if $_ eq &quot;rewrite&quot;;
 	$do_ctest=1 if $_ eq &quot;ctest&quot;;
@@ -252,6 +245,8 @@ foreach (@ARGV, split(/ /, $config{options}))
 	}
 
 	}
+$libname = $unified_info{sharednames}-&gt;{libcrypto} if $do_crypto;
+$libname = $unified_info{sharednames}-&gt;{libssl} if $do_ssl;
 
 if (!$libname) {
 	if ($do_ssl) {
@@ -1210,9 +1205,6 @@ sub print_def_file
         my $prevnum = 0;
         my $symvtextcount = 0;
 
-	if ($W32)
-		{ $libname.=&quot;32&quot;; }
-
         if ($W32)
                 {
                 print OUT &lt;&lt;&quot;EOF&quot;;
@@ -1229,6 +1221,7 @@ EOF
         elsif ($VMS)
                 {
                 print OUT &lt;&lt;&quot;EOF&quot;;
+IDENTIFICATION=$version
 CASE_SENSITIVE=YES
 SYMBOL_VECTOR=(-
 EOF
</PRE>





















<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="017215.html">[openssl-commits] [openssl]  master update
</A></li>
	<LI>Next message: <A HREF="017219.html">[openssl-commits] [openssl]  master update
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#17218">[ date ]</a>
              <a href="thread.html#17218">[ thread ]</a>
              <a href="subject.html#17218">[ subject ]</a>
              <a href="author.html#17218">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="../../../mailman/listinfo/openssl-commits.html">More information about the openssl-commits
mailing list</a><br>
</body></html>
