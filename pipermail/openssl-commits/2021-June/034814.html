<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [openssl]  master update
   </TITLE>
   <LINK REL="Index" HREF="https://mta.openssl.org/pipermail/openssl-commits/2021-June/index.html" >
   <LINK REL="made" HREF="mailto:openssl-commits%40openssl.org?Subject=Re%3A%20%5Bopenssl%5D%20%20master%20update&In-Reply-To=%3C1624682674.994016.13466.nullmailer%40dev.openssl.org%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="034813.html">
   <LINK REL="Next"  HREF="034815.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[openssl]  master update</H1>
    <B>Richard Levitte</B> 
    <A HREF="mailto:openssl-commits%40openssl.org?Subject=Re%3A%20%5Bopenssl%5D%20%20master%20update&In-Reply-To=%3C1624682674.994016.13466.nullmailer%40dev.openssl.org%3E"
       TITLE="[openssl]  master update">levitte at openssl.org
       </A><BR>
    <I>Sat Jun 26 04:44:34 UTC 2021</I>
    <P><UL>
        <LI>Previous message: <A HREF="034813.html">[openssl]  master update
</A></li>
        <LI>Next message: <A HREF="034815.html">[openssl]  master update
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#34814">[ date ]</a>
              <a href="thread.html#34814">[ thread ]</a>
              <a href="subject.html#34814">[ subject ]</a>
              <a href="author.html#34814">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>The branch master has been updated
       via  32a56ebab2ed77bd342ab85da7e3ce9d49eb9e71 (commit)
       via  f49b42e6eec9b7abee940a10e8e1125edcb61481 (commit)
       via  ed0bd67d4b7a61e864e9f71fbb62ba2a9dff0c28 (commit)
       via  bb4f826272712b7c57edefa9b920e9f7c31778d8 (commit)
       via  01b093aaeeb15d0a2ca0b5f8c100109821f884fb (commit)
       via  511fb47264df8333a5e2096fb5ef49436a965a63 (commit)
       via  46399d9db2c1a1afdfebac1a7fe64276c7f677de (commit)
       via  e7137c8497234e442f0a2639c43453b5baea7695 (commit)
      from  89fe295257f374647122f73776ddb34555c543f0 (commit)


- Log -----------------------------------------------------------------
commit 32a56ebab2ed77bd342ab85da7e3ce9d49eb9e71
Author: Richard Levitte &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">levitte at openssl.org</A>&gt;
Date:   Tue Jun 22 11:08:24 2021 +0200

    test/recipes/90-test_includes_data/vms-includes.cnf: correct the directory
    
    ... to mimic includes.cnf
    
    Reviewed-by: Paul Dale &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">pauli at openssl.org</A>&gt;
    (Merged from <A HREF="https://github.com/openssl/openssl/pull/15823">https://github.com/openssl/openssl/pull/15823</A>)

commit f49b42e6eec9b7abee940a10e8e1125edcb61481
Author: Richard Levitte &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">levitte at openssl.org</A>&gt;
Date:   Tue Jun 22 10:52:09 2021 +0200

    apps/CA.pl.in: restore the quotes around -CAfile, they were there for a reason
    
    Reviewed-by: Paul Dale &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">pauli at openssl.org</A>&gt;
    (Merged from <A HREF="https://github.com/openssl/openssl/pull/15823">https://github.com/openssl/openssl/pull/15823</A>)

commit ed0bd67d4b7a61e864e9f71fbb62ba2a9dff0c28
Author: Richard Levitte &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">levitte at openssl.org</A>&gt;
Date:   Tue Jun 22 10:38:55 2021 +0200

    test/recipes/80-test_ca.t: Don't force quotes around the config file in $cnf
    
    However, when passing it through the OPENSSL_CONFIG environment
    variable, we still need the quotes, just to make sure.
    
    Reviewed-by: Paul Dale &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">pauli at openssl.org</A>&gt;
    (Merged from <A HREF="https://github.com/openssl/openssl/pull/15823">https://github.com/openssl/openssl/pull/15823</A>)

commit bb4f826272712b7c57edefa9b920e9f7c31778d8
Author: Richard Levitte &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">levitte at openssl.org</A>&gt;
Date:   Tue Jun 22 08:04:12 2021 +0200

    test/recipes/66-test_ossl_store.t: ensure native paths
    
    Reviewed-by: Paul Dale &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">pauli at openssl.org</A>&gt;
    (Merged from <A HREF="https://github.com/openssl/openssl/pull/15823">https://github.com/openssl/openssl/pull/15823</A>)

commit 01b093aaeeb15d0a2ca0b5f8c100109821f884fb
Author: Richard Levitte &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">levitte at openssl.org</A>&gt;
Date:   Tue Jun 22 08:03:47 2021 +0200

    testutil: teach test_mk_file_path() how to merge VMS file specs
    
    This isn't a full solution, it only handles current use cases.
    
    Reviewed-by: Paul Dale &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">pauli at openssl.org</A>&gt;
    (Merged from <A HREF="https://github.com/openssl/openssl/pull/15823">https://github.com/openssl/openssl/pull/15823</A>)

commit 511fb47264df8333a5e2096fb5ef49436a965a63
Author: Richard Levitte &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">levitte at openssl.org</A>&gt;
Date:   Tue Jun 22 07:28:26 2021 +0200

    test/ossl_store_test.c: Adapt the use of datadir for VMS paths
    
    Reviewed-by: Paul Dale &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">pauli at openssl.org</A>&gt;
    (Merged from <A HREF="https://github.com/openssl/openssl/pull/15823">https://github.com/openssl/openssl/pull/15823</A>)

commit 46399d9db2c1a1afdfebac1a7fe64276c7f677de
Author: Richard Levitte &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">levitte at openssl.org</A>&gt;
Date:   Wed Jun 16 06:47:58 2021 +0200

    UTF-8 not easily supported on VMS command line yet
    
    Some tests are designed to test UTF-8 on the command line.
    We simply disable those on VMS.
    
    Reviewed-by: Paul Dale &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">pauli at openssl.org</A>&gt;
    (Merged from <A HREF="https://github.com/openssl/openssl/pull/15823">https://github.com/openssl/openssl/pull/15823</A>)

commit e7137c8497234e442f0a2639c43453b5baea7695
Author: Richard Levitte &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">levitte at openssl.org</A>&gt;
Date:   Wed Jun 16 06:46:45 2021 +0200

    Fix test_errstr for VMS
    
    Occasionally, we get an error code on VMS that doesn't translate
    into POSIX, and the error string reflects that
    
    Reviewed-by: Paul Dale &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">pauli at openssl.org</A>&gt;
    (Merged from <A HREF="https://github.com/openssl/openssl/pull/15823">https://github.com/openssl/openssl/pull/15823</A>)

-----------------------------------------------------------------------

Summary of changes:
 apps/CA.pl.in                                      |  4 +++-
 test/ossl_store_test.c                             | 14 +++++++++--
 test/recipes/02-test_errstr.t                      |  8 ++++++-
 test/recipes/25-test_x509.t                        |  1 +
 test/recipes/66-test_ossl_store.t                  |  3 ++-
 test/recipes/80-test_ca.t                          | 10 ++++----
 test/recipes/80-test_pkcs12.t                      | 17 +++++++++-----
 .../recipes/90-test_includes_data/vms-includes.cnf |  2 +-
 test/testutil/driver.c                             | 27 ++++++++++++++++++++--
 9 files changed, 67 insertions(+), 19 deletions(-)

diff --git a/apps/CA.pl.in b/apps/CA.pl.in
index 7087f55d27..f029470005 100644
--- a/apps/CA.pl.in
+++ b/apps/CA.pl.in
@@ -209,7 +209,9 @@ if ($WHAT eq '-newcert' ) {
 } elsif ($WHAT eq '-verify' ) {
     my @files = @ARGV ? @ARGV : ( $NEWCERT );
     foreach my $file (@files) {
-        my $status = run(&quot;$VERIFY -CAfile ${CATOP}/$CACERT $file $EXTRA{verify}&quot;);
+        # -CAfile quoted for VMS, since the C RTL downcases all unquoted
+        # arguments to C programs
+        my $status = run(&quot;$VERIFY \&quot;-CAfile\&quot; ${CATOP}/$CACERT $file $EXTRA{verify}&quot;);
         $RET = $status if $status != 0;
     }
 } elsif ($WHAT eq '-crl' ) {
diff --git a/test/ossl_store_test.c b/test/ossl_store_test.c
index b9135cfcb3..b45d1d548f 100644
--- a/test/ossl_store_test.c
+++ b/test/ossl_store_test.c
@@ -7,6 +7,7 @@
  * <A HREF="https://www.openssl.org/source/license.html">https://www.openssl.org/source/license.html</A>
  */
 
+#include &lt;string.h&gt;
 #include &lt;limits.h&gt;
 #include &lt;openssl/store.h&gt;
 #include &lt;openssl/ui.h&gt;
@@ -101,6 +102,7 @@ static int get_params(const char *uri, const char *type)
 static int test_store_get_params(int idx)
 {
     const char *type;
+    const char *urifmt;
     char uri[PATH_MAX];
 
     switch(idx) {
@@ -128,8 +130,16 @@ static int test_store_get_params(int idx)
         return 0;
     }
 
-    if (!TEST_true(BIO_snprintf(uri, sizeof(uri), &quot;%s/%s-params.pem&quot;,
-                                datadir, type)))
+    urifmt = &quot;%s/%s-params.pem&quot;;
+#ifdef __VMS
+    {
+        char datadir_end = datadir[strlen(datadir) - 1];
+
+        if (datadir_end == ':' || datadir_end == ']' || datadir_end == '&gt;')
+            urifmt = &quot;%s%s-params.pem&quot;;
+    }
+#endif
+    if (!TEST_true(BIO_snprintf(uri, sizeof(uri), urifmt, datadir, type)))
         return 0;
 
     TEST_info(&quot;Testing uri: %s&quot;, uri);
diff --git a/test/recipes/02-test_errstr.t b/test/recipes/02-test_errstr.t
index c7ada64c46..9427601292 100644
--- a/test/recipes/02-test_errstr.t
+++ b/test/recipes/02-test_errstr.t
@@ -122,7 +122,10 @@ sub match_any {
         $desc = &quot;match '$first' ($desc) with '$strings[0]'&quot;;
     }
 
-    return ( scalar( grep { $first eq $_ } @strings ) &gt; 0,
+    return ( scalar(
+                 grep { ref $_ eq 'Regexp' ? $first =~ $_ : $first eq $_ }
+                 @strings
+             ) &gt; 0,
              $desc );
 }
 
@@ -150,6 +153,9 @@ sub match_syserr_reason {
           # ... and $! will give you the error string back
           $!
     };
+    # Occasionally, we get an error code that is simply not translatable
+    # to POSIX semantics on VMS, and we get an error string saying so.
+    push @strings, qr/^non-translatable vms error code:/ if $^O eq 'VMS';
     # The OpenSSL fallback string
     push @strings, &quot;reason($errcode)&quot;;
 
diff --git a/test/recipes/25-test_x509.t b/test/recipes/25-test_x509.t
index 5b6f8279e7..7e8ce2408e 100644
--- a/test/recipes/25-test_x509.t
+++ b/test/recipes/25-test_x509.t
@@ -40,6 +40,7 @@ is(cmp_text($out_utf8, $utf),
 
 SKIP: {
     skip &quot;DES disabled&quot;, 1 if disabled(&quot;des&quot;);
+    skip &quot;VMS doesn't support command line UTF-8&quot;, 1 if $^O eq 'VMS';
 
     my $p12 = srctop_file(&quot;test&quot;, &quot;shibboleth.pfx&quot;);
     my $p12pass = &quot;&#963;&#973;&#957;&#952;&#951;&#956;&#945; &#947;&#957;&#974;&#961;&#953;&#963;&#956;&#945;&quot;;
diff --git a/test/recipes/66-test_ossl_store.t b/test/recipes/66-test_ossl_store.t
index 21bec4395c..3740bee804 100644
--- a/test/recipes/66-test_ossl_store.t
+++ b/test/recipes/66-test_ossl_store.t
@@ -9,6 +9,7 @@
 use strict;
 use warnings;
 
+use File::Spec::Functions;
 use OpenSSL::Test::Simple;
 use OpenSSL::Test qw/:DEFAULT srctop_dir data_dir/;
 
@@ -17,5 +18,5 @@ setup(&quot;test_ossl_store&quot;);
 plan tests =&gt; 1;
 
 ok(run(test([&quot;ossl_store_test&quot;, &quot;-dir&quot;, srctop_dir(&quot;test&quot;),
-             &quot;-in&quot;, &quot;testrsa.pem&quot;, &quot;-sm2&quot;, &quot;certs/sm2-root.crt&quot;,
+             &quot;-in&quot;, &quot;testrsa.pem&quot;, &quot;-sm2&quot;, canonpath(&quot;certs/sm2-root.crt&quot;),
              &quot;-data&quot;, data_dir()])));
diff --git a/test/recipes/80-test_ca.t b/test/recipes/80-test_ca.t
index c1e09032de..eb025f4d59 100644
--- a/test/recipes/80-test_ca.t
+++ b/test/recipes/80-test_ca.t
@@ -20,7 +20,7 @@ setup(&quot;test_ca&quot;);
 
 $ENV{OPENSSL} = cmdstr(app([&quot;openssl&quot;]), display =&gt; 1);
 
-my $cnf = '&quot;' . srctop_file(&quot;test&quot;,&quot;ca-and-certs.cnf&quot;) . '&quot;';;
+my $cnf = srctop_file(&quot;test&quot;,&quot;ca-and-certs.cnf&quot;);
 my $std_openssl_cnf = '&quot;'
     . srctop_file(&quot;apps&quot;, $^O eq &quot;VMS&quot; ? &quot;openssl-vms.cnf&quot; : &quot;openssl.cnf&quot;)
     . '&quot;';
@@ -30,19 +30,19 @@ rmtree(&quot;demoCA&quot;, { safe =&gt; 0 });
 plan tests =&gt; 15;
  SKIP: {
      my $cakey = srctop_file(&quot;test&quot;, &quot;certs&quot;, &quot;ca-key.pem&quot;);
-     $ENV{OPENSSL_CONFIG} = '-config ' . $cnf;
+     $ENV{OPENSSL_CONFIG} = qq(-config &quot;$cnf&quot;);
      skip &quot;failed creating CA structure&quot;, 4
          if !ok(run(perlapp([&quot;CA.pl&quot;,&quot;-newca&quot;,
                              &quot;-extra-req&quot;, &quot;-key $cakey&quot;], stdin =&gt; undef)),
                 'creating CA structure');
 
      my $eekey = srctop_file(&quot;test&quot;, &quot;certs&quot;, &quot;ee-key.pem&quot;);
-     $ENV{OPENSSL_CONFIG} = '-config ' . $cnf;
+     $ENV{OPENSSL_CONFIG} = qq(-config &quot;$cnf&quot;);
      skip &quot;failed creating new certificate request&quot;, 3
          if !ok(run(perlapp([&quot;CA.pl&quot;,&quot;-newreq&quot;,
                              '-extra-req', &quot;-outform DER -section userreq -key $eekey&quot;])),
                 'creating certificate request');
-     $ENV{OPENSSL_CONFIG} = '-rand_serial -inform DER -config '.$std_openssl_cnf;
+     $ENV{OPENSSL_CONFIG} = qq(-rand_serial -inform DER -config &quot;$std_openssl_cnf&quot;);
      skip &quot;failed to sign certificate request&quot;, 2
          if !is(yes(cmdstr(perlapp([&quot;CA.pl&quot;, &quot;-sign&quot;]))), 0,
                 'signing certificate request');
@@ -54,7 +54,7 @@ plan tests =&gt; 15;
          if disabled(&quot;ct&quot;);
 
      my $eekey2 = srctop_file(&quot;test&quot;, &quot;certs&quot;, &quot;ee-key-3072.pem&quot;);
-     $ENV{OPENSSL_CONFIG} = '-config ' . $cnf;
+     $ENV{OPENSSL_CONFIG} = qq(-config &quot;$cnf&quot;);
      ok(run(perlapp([&quot;CA.pl&quot;, &quot;-precert&quot;, '-extra-req', &quot;-section userreq -key $eekey2&quot;], stderr =&gt; undef)),
         'creating new pre-certificate');
 }
diff --git a/test/recipes/80-test_pkcs12.t b/test/recipes/80-test_pkcs12.t
index e03c197e20..c85437f1a8 100644
--- a/test/recipes/80-test_pkcs12.t
+++ b/test/recipes/80-test_pkcs12.t
@@ -40,7 +40,7 @@ if (eval { require Win32::API; 1; }) {
     }
 } elsif ($^O eq &quot;MSWin32&quot;) {
     plan skip_all =&gt; &quot;Win32::API unavailable&quot;;
-} else {
+} elsif ($^O ne &quot;VMS&quot;) {
     # Running MinGW tests transparently under Wine apparently requires
     # UTF-8 locale...
 
@@ -63,11 +63,16 @@ ok(run(test([&quot;pkcs12_format_test&quot;, &quot;-legacy&quot;])), &quot;test pkcs12 formats using lega
 # Test with a non-default library context (and no loaded providers in the default context)
 ok(run(test([&quot;pkcs12_format_test&quot;, &quot;-context&quot;])), &quot;test pkcs12 formats using a non-default library context&quot;);
 
-# just see that we can read shibboleth.pfx protected with $pass
-ok(run(app([&quot;openssl&quot;, &quot;pkcs12&quot;, &quot;-noout&quot;,
-            &quot;-password&quot;, &quot;pass:$pass&quot;,
-            &quot;-in&quot;, srctop_file(&quot;test&quot;, &quot;shibboleth.pfx&quot;)])),
-   &quot;test_load_cert_pkcs12&quot;);
+SKIP: {
+     skip &quot;VMS doesn't have command line UTF-8 support yet in DCL&quot;, 1
+         if $^O eq &quot;VMS&quot;;
+
+     # just see that we can read shibboleth.pfx protected with $pass
+     ok(run(app([&quot;openssl&quot;, &quot;pkcs12&quot;, &quot;-noout&quot;,
+                 &quot;-password&quot;, &quot;pass:$pass&quot;,
+                 &quot;-in&quot;, srctop_file(&quot;test&quot;, &quot;shibboleth.pfx&quot;)])),
+        &quot;test_load_cert_pkcs12&quot;);
+}
 
 my @path = qw(test certs);
 my $outfile1 = &quot;out1.p12&quot;;
diff --git a/test/recipes/90-test_includes_data/vms-includes.cnf b/test/recipes/90-test_includes_data/vms-includes.cnf
index 30fc4ef8e1..ed4367bcf0 100644
--- a/test/recipes/90-test_includes_data/vms-includes.cnf
+++ b/test/recipes/90-test_includes_data/vms-includes.cnf
@@ -2,4 +2,4 @@
 # Example configuration file using includes.
 #
 
-.include [.cnf-includes]
+.include [.conf-includes]
diff --git a/test/testutil/driver.c b/test/testutil/driver.c
index 702f7b2caa..f91d1ab932 100644
--- a/test/testutil/driver.c
+++ b/test/testutil/driver.c
@@ -436,13 +436,36 @@ char *test_mk_file_path(const char *dir, const char *file)
     const char *sep = &quot;/&quot;;
 # else
     const char *sep = &quot;&quot;;
+    char *dir_end;
+    char dir_end_sep;
 # endif
     size_t len = strlen(dir) + strlen(sep) + strlen(file) + 1;
     char *full_file = OPENSSL_zalloc(len);
 
     if (full_file != NULL) {
-        OPENSSL_strlcpy(full_file, dir, len);
-        OPENSSL_strlcat(full_file, sep, len);
+        if (dir != NULL &amp;&amp; dir[0] != '\0') {
+            OPENSSL_strlcpy(full_file, dir, len);
+# ifdef OPENSSL_SYS_VMS
+            /*
+             * If |file| contains a directory spec, we need to do some
+             * careful merging.
+             * &quot;vol:[dir.dir]&quot; + &quot;[.certs]sm2-root.crt&quot; should become
+             * &quot;vol:[dir.dir.certs]sm2-root.crt&quot;
+             */
+            dir_end = &amp;full_file[strlen(full_file) - 1];
+            dir_end_sep = *dir_end;
+            if ((dir_end_sep == ']' || dir_end_sep == '&gt;')
+                &amp;&amp; (file[0] == '[' || file[0] == '&lt;')) {
+                file++;
+                if (file[0] == '.')
+                    *dir_end = '\0';
+                else
+                    *dir_end = '.';
+            }
+#else
+            OPENSSL_strlcat(full_file, sep, len);
+#endif
+        }
         OPENSSL_strlcat(full_file, file, len);
     }
 
</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="034813.html">[openssl]  master update
</A></li>
	<LI>Next message: <A HREF="034815.html">[openssl]  master update
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#34814">[ date ]</a>
              <a href="thread.html#34814">[ thread ]</a>
              <a href="subject.html#34814">[ subject ]</a>
              <a href="author.html#34814">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="../../../mailman/listinfo/openssl-commits.html">More information about the openssl-commits
mailing list</a><br>
</body></html>
