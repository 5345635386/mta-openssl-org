<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [openssl]  master update
   </TITLE>
   <LINK REL="Index" HREF="https://mta.openssl.org/pipermail/openssl-commits/2020-April/index.html" >
   <LINK REL="made" HREF="mailto:openssl-commits%40openssl.org?Subject=Re%3A%20%5Bopenssl%5D%20%20master%20update&In-Reply-To=%3C1587038065.431794.11624.nullmailer%40dev.openssl.org%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="028290.html">
   <LINK REL="Next"  HREF="028296.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[openssl]  master update</H1>
    <B>Richard Levitte</B> 
    <A HREF="mailto:openssl-commits%40openssl.org?Subject=Re%3A%20%5Bopenssl%5D%20%20master%20update&In-Reply-To=%3C1587038065.431794.11624.nullmailer%40dev.openssl.org%3E"
       TITLE="[openssl]  master update">levitte at openssl.org
       </A><BR>
    <I>Thu Apr 16 11:54:25 UTC 2020</I>
    <P><UL>
        <LI>Previous message: <A HREF="028290.html">[openssl]  master update
</A></li>
        <LI>Next message: <A HREF="028296.html">[openssl]  master update
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#28294">[ date ]</a>
              <a href="thread.html#28294">[ thread ]</a>
              <a href="subject.html#28294">[ subject ]</a>
              <a href="author.html#28294">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>The branch master has been updated
       via  b27ed819431fb7f50ded6fcddfd25de079d7e808 (commit)
       via  705536e2b5c4167dbda2e0046d83f9e0f4a65514 (commit)
      from  7165593ce5a07a6860d4d408ad640ee707172936 (commit)


- Log -----------------------------------------------------------------
commit b27ed819431fb7f50ded6fcddfd25de079d7e808
Author: Rich Salz &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">rsalz at akamai.com</A>&gt;
Date:   Thu Mar 5 12:58:00 2020 -0500

    Put sys-specific files in build.info
    
    Don't wrap whole files in if[n]def, test in build.info if they
    should be compiled.  rand_win isn't done as there are multiple
    ways to say &quot;this is windows.&quot;
    
    Reviewed-by: Tomas Mraz &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">tmraz at fedoraproject.org</A>&gt;
    Reviewed-by: Paul Dale &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">paul.dale at oracle.com</A>&gt;
    Reviewed-by: Richard Levitte &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">levitte at openssl.org</A>&gt;
    (Merged from <A HREF="https://github.com/openssl/openssl/pull/11263">https://github.com/openssl/openssl/pull/11263</A>)

commit 705536e2b5c4167dbda2e0046d83f9e0f4a65514
Author: Rich Salz &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">rsalz at akamai.com</A>&gt;
Date:   Thu Mar 5 12:50:31 2020 -0500

    Use build.info, not ifdef for crypto modules
    
    Don't wrap conditionally-compiled files in global ifndef tests.
    Instead, test if the feature is disabled and, if so, do not
    compile it.
    
    Reviewed-by: Tomas Mraz &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">tmraz at fedoraproject.org</A>&gt;
    Reviewed-by: Paul Dale &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">paul.dale at oracle.com</A>&gt;
    Reviewed-by: Richard Levitte &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">levitte at openssl.org</A>&gt;
    (Merged from <A HREF="https://github.com/openssl/openssl/pull/11263">https://github.com/openssl/openssl/pull/11263</A>)

-----------------------------------------------------------------------

Summary of changes:
 crypto/aes/aes_ige.c       |  5 ----
 crypto/aes/build.info      |  5 +++-
 crypto/asn1/build.info     | 10 +++++--
 crypto/asn1/n_pkey.c       | 27 ++++++------------
 crypto/asn1/x_long.c       |  5 ----
 crypto/bn/bn_depr.c        | 13 +++------
 crypto/bn/build.info       |  5 +++-
 crypto/dh/build.info       |  5 +++-
 crypto/dh/dh_depr.c        | 12 +++-----
 crypto/dsa/build.info      |  6 ++--
 crypto/dsa/dsa_depr.c      | 18 +++++-------
 crypto/ec/build.info       |  6 +++-
 crypto/ec/ecp_nistp224.c   | 21 ++++++--------
 crypto/ec/ecp_nistp256.c   | 48 ++++++++++++++-----------------
 crypto/ec/ecp_nistp521.c   | 21 ++++++--------
 crypto/ec/ecp_nistputil.c  | 16 ++++-------
 crypto/evp/build.info      | 23 +++++++++++----
 crypto/evp/e_camellia.c    | 52 ++++++++++++++++-----------------
 crypto/evp/e_old.c         | 53 ++++++++++++++++------------------
 crypto/evp/e_seed.c        | 17 ++++-------
 crypto/evp/p_open.c        | 14 ++++-----
 crypto/rand/build.info     | 15 ++++++++--
 crypto/rand/rand_egd.c     | 61 ++++++++++++++++++---------------------
 crypto/rand/rand_vms.c     | 71 ++++++++++++++++++++++------------------------
 crypto/rand/rand_vxworks.c | 51 +++++++++++++++------------------
 crypto/rsa/build.info      |  6 +++-
 crypto/rsa/rsa_depr.c      | 15 ++++------
 27 files changed, 280 insertions(+), 321 deletions(-)

diff --git a/crypto/aes/aes_ige.c b/crypto/aes/aes_ige.c
index b40f4e53a6..6e72d2f7f4 100644
--- a/crypto/aes/aes_ige.c
+++ b/crypto/aes/aes_ige.c
@@ -15,10 +15,6 @@
 
 #include &quot;internal/cryptlib.h&quot;
 
-#ifdef OPENSSL_NO_DEPRECATED_3_0
-NON_EMPTY_TRANSLATION_UNIT
-#else
-
 #include &lt;openssl/aes.h&gt;
 #include &quot;aes_local.h&quot;
 
@@ -301,4 +297,3 @@ void AES_bi_ige_encrypt(const unsigned char *in, unsigned char *out,
         }
     }
 }
-#endif
diff --git a/crypto/aes/build.info b/crypto/aes/build.info
index dc00df0cda..2b2053031f 100644
--- a/crypto/aes/build.info
+++ b/crypto/aes/build.info
@@ -60,7 +60,10 @@ IF[{- !$disabled{asm} -}]
 ENDIF
 
 $COMMON=aes_misc.c aes_ecb.c $AESASM
-SOURCE[../../libcrypto]=$COMMON aes_cfb.c aes_ofb.c aes_ige.c aes_wrap.c
+SOURCE[../../libcrypto]=$COMMON aes_cfb.c aes_ofb.c aes_wrap.c
+IF[{- !$disabled{'deprecated-3.0'} -}]
+  SOURCE[../../libcrypto]=aes_ige.c
+ENDIF
 SOURCE[../../providers/libfips.a]=$COMMON
 
 # Implementations are now spread across several libraries, so the defines
diff --git a/crypto/asn1/build.info b/crypto/asn1/build.info
index 32fdaaa1a9..a66c3084ce 100644
--- a/crypto/asn1/build.info
+++ b/crypto/asn1/build.info
@@ -4,14 +4,20 @@ SOURCE[../../libcrypto]=\
         a_print.c a_type.c a_dup.c a_d2i_fp.c a_i2d_fp.c \
         a_utf8.c a_sign.c a_digest.c a_verify.c a_mbstr.c a_strex.c \
         x_algor.c x_val.c x_sig.c x_bignum.c \
-        x_long.c x_int64.c x_info.c x_spki.c nsseq.c \
+        x_int64.c x_info.c x_spki.c nsseq.c \
         d2i_pu.c d2i_pr.c i2d_pu.c i2d_pr.c\
         t_pkey.c t_spki.c t_bitst.c \
         tasn_new.c tasn_fre.c tasn_enc.c tasn_dec.c tasn_utl.c tasn_typ.c \
         tasn_prn.c tasn_scn.c ameth_lib.c \
-        f_int.c f_string.c n_pkey.c \
+        f_int.c f_string.c \
         x_pkey.c bio_asn1.c bio_ndef.c asn_mime.c \
         asn1_gen.c asn1_par.c asn1_lib.c asn1_err.c a_strnid.c \
         evp_asn1.c asn_pack.c p5_pbe.c p5_pbev2.c p5_scrypt.c p8_pkey.c \
         asn_moid.c asn_mstbl.c asn1_item_list.c \
         d2i_param.c i2d_param.c
+IF[{- !$disabled{'rsa'} and !$disabled{'rc4'} -}]
+  SOURCE[../../libcrypto]=n_pkey.c
+ENDIF
+IF[{- !$disabled{'deprecated-3.0'} -}]
+  SOURCE[../../libcrypto]=x_long.c
+ENDIF
diff --git a/crypto/asn1/n_pkey.c b/crypto/asn1/n_pkey.c
index 71f78f7b26..88dabd265d 100644
--- a/crypto/asn1/n_pkey.c
+++ b/crypto/asn1/n_pkey.c
@@ -8,24 +8,19 @@
  */
 
 #include &quot;openssl/opensslconf.h&quot;
-#ifdef OPENSSL_NO_RSA
-NON_EMPTY_TRANSLATION_UNIT
-#else
 
-# include &quot;internal/cryptlib.h&quot;
-# include &lt;stdio.h&gt;
-# include &lt;openssl/rsa.h&gt;
-# include &lt;openssl/objects.h&gt;
-# include &lt;openssl/asn1t.h&gt;
-# include &lt;openssl/evp.h&gt;
-# include &lt;openssl/x509.h&gt;
+#include &quot;internal/cryptlib.h&quot;
+#include &lt;stdio.h&gt;
+#include &lt;openssl/rsa.h&gt;
+#include &lt;openssl/objects.h&gt;
+#include &lt;openssl/asn1t.h&gt;
+#include &lt;openssl/evp.h&gt;
+#include &lt;openssl/x509.h&gt;
 
-# ifndef OPENSSL_NO_RC4
-
-# define ASN1_BROKEN_SEQUENCE(tname) \
+#define ASN1_BROKEN_SEQUENCE(tname) \
         static const ASN1_AUX tname##_aux = {NULL, ASN1_AFLG_BROKEN, 0, 0, 0, 0}; \
         ASN1_SEQUENCE(tname)
-# define static_ASN1_BROKEN_SEQUENCE_END(stname) \
+#define static_ASN1_BROKEN_SEQUENCE_END(stname) \
         static_ASN1_SEQUENCE_END_ref(stname, stname)
 
 typedef struct netscape_pkey_st {
@@ -62,7 +57,3 @@ ASN1_SEQUENCE(NETSCAPE_PKEY) = {
 DECLARE_ASN1_FUNCTIONS(NETSCAPE_PKEY)
 DECLARE_ASN1_ENCODE_FUNCTIONS_name(NETSCAPE_PKEY, NETSCAPE_PKEY)
 IMPLEMENT_ASN1_FUNCTIONS(NETSCAPE_PKEY)
-
-# endif                         /* OPENSSL_NO_RC4 */
-
-#endif
diff --git a/crypto/asn1/x_long.c b/crypto/asn1/x_long.c
index 76d6674b50..414fd06e5e 100644
--- a/crypto/asn1/x_long.c
+++ b/crypto/asn1/x_long.c
@@ -11,10 +11,6 @@
 #include &quot;internal/cryptlib.h&quot;
 #include &lt;openssl/asn1t.h&gt;
 
-#ifdef OPENSSL_NO_DEPRECATED_3_0
-NON_EMPTY_TRANSLATION_UNIT
-#else
-
 #define COPY_SIZE(a, b) (sizeof(a) &lt; sizeof(b) ? sizeof(a) : sizeof(b))
 
 /*
@@ -198,4 +194,3 @@ static int long_print(BIO *out, const ASN1_VALUE **pval, const ASN1_ITEM *it,
     memcpy(&amp;l, pval, COPY_SIZE(*pval, l));
     return BIO_printf(out, &quot;%ld\n&quot;, l);
 }
-#endif
diff --git a/crypto/bn/bn_depr.c b/crypto/bn/bn_depr.c
index 9c1c3d57c8..9a7a87e952 100644
--- a/crypto/bn/bn_depr.c
+++ b/crypto/bn/bn_depr.c
@@ -13,14 +13,11 @@
  */
 
 #include &lt;openssl/opensslconf.h&gt;
-#ifdef OPENSSL_NO_DEPRECATED_0_9_8
-NON_EMPTY_TRANSLATION_UNIT
-#else
 
-# include &lt;stdio.h&gt;
-# include &lt;time.h&gt;
-# include &quot;internal/cryptlib.h&quot;
-# include &quot;bn_local.h&quot;
+#include &lt;stdio.h&gt;
+#include &lt;time.h&gt;
+#include &quot;internal/cryptlib.h&quot;
+#include &quot;bn_local.h&quot;
 
 BIGNUM *BN_generate_prime(BIGNUM *ret, int bits, int safe,
                           const BIGNUM *add, const BIGNUM *rem,
@@ -64,5 +61,3 @@ int BN_is_prime_fasttest(const BIGNUM *a, int checks,
     BN_GENCB_set_old(&amp;cb, callback, cb_arg);
     return bn_check_prime_int(a, checks, ctx_passed, do_trial_division, &amp;cb);
 }
-
-#endif
diff --git a/crypto/bn/build.info b/crypto/bn/build.info
index bc3fb9b05b..5e04ed00ad 100644
--- a/crypto/bn/build.info
+++ b/crypto/bn/build.info
@@ -113,7 +113,10 @@ $COMMON=bn_add.c bn_div.c bn_exp.c bn_lib.c bn_ctx.c bn_mul.c \
         bn_recp.c bn_mont.c bn_mpi.c bn_exp2.c bn_gf2m.c bn_nist.c \
         bn_x931p.c bn_intern.c bn_dh.c \
         bn_rsa_fips186_4.c $BNDH $BNASM
-SOURCE[../../libcrypto]=$COMMON bn_print.c bn_err.c bn_depr.c bn_srp.c
+SOURCE[../../libcrypto]=$COMMON bn_print.c bn_err.c bn_srp.c
+IF[{- !$disabled{'deprecated-3.0'} -}]
+  SOURCE[../../libcrypto]=bn_depr.c
+ENDIF
 SOURCE[../../providers/libfips.a]=$COMMON
 # Implementations are now spread across several libraries, so the defines
 # need to be applied to all affected libraries and modules.
diff --git a/crypto/dh/build.info b/crypto/dh/build.info
index f4498f4d2b..656e6ea828 100644
--- a/crypto/dh/build.info
+++ b/crypto/dh/build.info
@@ -3,7 +3,10 @@ LIBS=../../libcrypto
 $COMMON=dh_lib.c dh_key.c dh_group_params.c dh_check.c dh_backend.c dh_gen.c
 
 SOURCE[../../libcrypto]=$COMMON\
-        dh_asn1.c dh_err.c dh_depr.c \
+        dh_asn1.c dh_err.c \
         dh_ameth.c dh_pmeth.c dh_prn.c dh_rfc5114.c dh_kdf.c dh_meth.c
+IF[{- !$disabled{'deprecated-0.9.8'} -}]
+  SOURCE[../../libcrypto]=dh_depr.c
+ENDIF
 
 SOURCE[../../providers/libfips.a]=$COMMON
diff --git a/crypto/dh/dh_depr.c b/crypto/dh/dh_depr.c
index 33689d8e1c..0d21d97269 100644
--- a/crypto/dh/dh_depr.c
+++ b/crypto/dh/dh_depr.c
@@ -16,14 +16,11 @@
 #include &quot;internal/deprecated.h&quot;
 
 #include &lt;openssl/opensslconf.h&gt;
-#ifdef OPENSSL_NO_DEPRECATED_0_9_8
-NON_EMPTY_TRANSLATION_UNIT
-#else
 
-# include &lt;stdio.h&gt;
-# include &quot;internal/cryptlib.h&quot;
-# include &lt;openssl/bn.h&gt;
-# include &lt;openssl/dh.h&gt;
+#include &lt;stdio.h&gt;
+#include &quot;internal/cryptlib.h&quot;
+#include &lt;openssl/bn.h&gt;
+#include &lt;openssl/dh.h&gt;
 
 DH *DH_generate_parameters(int prime_len, int generator,
                            void (*callback) (int, int, void *), void *cb_arg)
@@ -49,4 +46,3 @@ DH *DH_generate_parameters(int prime_len, int generator,
     DH_free(ret);
     return NULL;
 }
-#endif
diff --git a/crypto/dsa/build.info b/crypto/dsa/build.info
index 7f621cb56b..9a7d275c35 100644
--- a/crypto/dsa/build.info
+++ b/crypto/dsa/build.info
@@ -4,7 +4,9 @@ $COMMON=dsa_sign.c dsa_vrf.c dsa_lib.c dsa_ossl.c dsa_check.c \
         dsa_key.c dsa_backend.c dsa_gen.c
 
 SOURCE[../../libcrypto]=$COMMON\
-        dsa_asn1.c \
-        dsa_err.c dsa_depr.c dsa_ameth.c dsa_pmeth.c dsa_prn.c \
+        dsa_asn1.c dsa_err.c dsa_ameth.c dsa_pmeth.c dsa_prn.c \
         dsa_meth.c
+IF[{- !$disabled{'deprecated-0.9.8'} -}]
+  SOURCE[../../libcrypto]=dsa_depr.c
+ENDIF
 SOURCE[../../providers/libfips.a]=$COMMON
diff --git a/crypto/dsa/dsa_depr.c b/crypto/dsa/dsa_depr.c
index 5c8f9af2b9..93f5ad41e3 100644
--- a/crypto/dsa/dsa_depr.c
+++ b/crypto/dsa/dsa_depr.c
@@ -26,17 +26,14 @@
 #define xxxHASH    EVP_sha1()
 
 #include &lt;openssl/opensslconf.h&gt;
-#ifdef OPENSSL_NO_DEPRECATED_0_9_8
-NON_EMPTY_TRANSLATION_UNIT
-#else
 
-# include &lt;stdio.h&gt;
-# include &lt;time.h&gt;
-# include &quot;internal/cryptlib.h&quot;
-# include &lt;openssl/evp.h&gt;
-# include &lt;openssl/bn.h&gt;
-# include &lt;openssl/dsa.h&gt;
-# include &lt;openssl/sha.h&gt;
+#include &lt;stdio.h&gt;
+#include &lt;time.h&gt;
+#include &quot;internal/cryptlib.h&quot;
+#include &lt;openssl/evp.h&gt;
+#include &lt;openssl/bn.h&gt;
+#include &lt;openssl/dsa.h&gt;
+#include &lt;openssl/sha.h&gt;
 
 DSA *DSA_generate_parameters(int bits,
                              unsigned char *seed_in, int seed_len,
@@ -65,4 +62,3 @@ err:
     DSA_free(ret);
     return NULL;
 }
-#endif
diff --git a/crypto/ec/build.info b/crypto/ec/build.info
index 590bbbde53..a802beaa68 100644
--- a/crypto/ec/build.info
+++ b/crypto/ec/build.info
@@ -46,12 +46,16 @@ ENDIF
 $COMMON=ec_lib.c ecp_smpl.c ecp_mont.c ecp_nist.c ec_cvt.c ec_mult.c \
         ec_curve.c ec_check.c ec_print.c ec_key.c ec_asn1.c \
         ec2_smpl.c \
-        ecp_nistp224.c ecp_nistp256.c ecp_nistp521.c ecp_nistputil.c \
         ecp_oct.c ec2_oct.c ec_oct.c ec_kmeth.c ecdh_ossl.c \
         ecdsa_ossl.c ecdsa_sign.c ecdsa_vrf.c curve25519.c \
         curve448/arch_32/f_impl.c curve448/f_generic.c curve448/scalar.c \
         curve448/curve448_tables.c curve448/eddsa.c curve448/curve448.c \
         $ECASM ec_backend.c ecx_backend.c
+
+IF[{- !$disabled{'ec_nistp_64_gcc_128'} -}]
+  $COMMON=$COMMON ecp_nistp224.c ecp_nistp256.c ecp_nistp521.c ecp_nistputil.c
+ENDIF
+
 SOURCE[../../libcrypto]=$COMMON ec_ameth.c ec_pmeth.c ecx_meth.c ecx_key.c \
                         ec_err.c ecdh_kdf.c eck_prn.c ec_ctrl.c
 SOURCE[../../providers/libfips.a]=$COMMON
diff --git a/crypto/ec/ecp_nistp224.c b/crypto/ec/ecp_nistp224.c
index f52e55b7ed..bf8e5db614 100644
--- a/crypto/ec/ecp_nistp224.c
+++ b/crypto/ec/ecp_nistp224.c
@@ -37,22 +37,19 @@
  */
 
 #include &lt;openssl/opensslconf.h&gt;
-#ifdef OPENSSL_NO_EC_NISTP_64_GCC_128
-NON_EMPTY_TRANSLATION_UNIT
-#else
 
-# include &lt;stdint.h&gt;
-# include &lt;string.h&gt;
-# include &lt;openssl/err.h&gt;
-# include &quot;ec_local.h&quot;
+#include &lt;stdint.h&gt;
+#include &lt;string.h&gt;
+#include &lt;openssl/err.h&gt;
+#include &quot;ec_local.h&quot;
 
-# if defined(__SIZEOF_INT128__) &amp;&amp; __SIZEOF_INT128__==16
+#if defined(__SIZEOF_INT128__) &amp;&amp; __SIZEOF_INT128__==16
   /* even with gcc, the typedef won't work for 32-bit platforms */
 typedef __uint128_t uint128_t;  /* nonstandard; implemented by gcc on 64-bit
                                  * platforms */
-# else
-#  error &quot;Your compiler doesn't appear to support 128-bit integer types&quot;
-# endif
+#else
+# error &quot;Your compiler doesn't appear to support 128-bit integer types&quot;
+#endif
 
 typedef uint8_t u8;
 typedef uint64_t u64;
@@ -1755,5 +1752,3 @@ int ec_GFp_nistp224_have_precompute_mult(const EC_GROUP *group)
 {
     return HAVEPRECOMP(group, nistp224);
 }
-
-#endif
diff --git a/crypto/ec/ecp_nistp256.c b/crypto/ec/ecp_nistp256.c
index 624909d894..dd3c5d5878 100644
--- a/crypto/ec/ecp_nistp256.c
+++ b/crypto/ec/ecp_nistp256.c
@@ -38,23 +38,20 @@
  */
 
 #include &lt;openssl/opensslconf.h&gt;
-#ifdef OPENSSL_NO_EC_NISTP_64_GCC_128
-NON_EMPTY_TRANSLATION_UNIT
-#else
 
-# include &lt;stdint.h&gt;
-# include &lt;string.h&gt;
-# include &lt;openssl/err.h&gt;
-# include &quot;ec_local.h&quot;
+#include &lt;stdint.h&gt;
+#include &lt;string.h&gt;
+#include &lt;openssl/err.h&gt;
+#include &quot;ec_local.h&quot;
 
-# if defined(__SIZEOF_INT128__) &amp;&amp; __SIZEOF_INT128__==16
+#if defined(__SIZEOF_INT128__) &amp;&amp; __SIZEOF_INT128__==16
   /* even with gcc, the typedef won't work for 32-bit platforms */
 typedef __uint128_t uint128_t;  /* nonstandard; implemented by gcc on 64-bit
                                  * platforms */
 typedef __int128_t int128_t;
-# else
-#  error &quot;Your compiler doesn't appear to support 128-bit integer types&quot;
-# endif
+#else
+# error &quot;Your compiler doesn't appear to support 128-bit integer types&quot;
+#endif
 
 typedef uint8_t u8;
 typedef uint32_t u32;
@@ -116,7 +113,7 @@ static const felem_bytearray nistp256_curve_params[5] = {
  * values are used as intermediate values before multiplication.
  */
 
-# define NLIMBS 4
+#define NLIMBS 4
 
 typedef uint128_t limb;
 typedef limb felem[NLIMBS];
@@ -248,9 +245,9 @@ static void longfelem_scalar(longfelem out, const u64 scalar)
     out[7] *= scalar;
 }
 
-# define two105m41m9 (((limb)1) &lt;&lt; 105) - (((limb)1) &lt;&lt; 41) - (((limb)1) &lt;&lt; 9)
-# define two105 (((limb)1) &lt;&lt; 105)
-# define two105m41p9 (((limb)1) &lt;&lt; 105) - (((limb)1) &lt;&lt; 41) + (((limb)1) &lt;&lt; 9)
+#define two105m41m9 (((limb)1) &lt;&lt; 105) - (((limb)1) &lt;&lt; 41) - (((limb)1) &lt;&lt; 9)
+#define two105 (((limb)1) &lt;&lt; 105)
+#define two105m41p9 (((limb)1) &lt;&lt; 105) - (((limb)1) &lt;&lt; 41) + (((limb)1) &lt;&lt; 9)
 
 /* zero105 is 0 mod p */
 static const felem zero105 =
@@ -293,9 +290,9 @@ static void felem_diff(felem out, const felem in)
     out[3] -= in[3];
 }
 
-# define two107m43m11 (((limb)1) &lt;&lt; 107) - (((limb)1) &lt;&lt; 43) - (((limb)1) &lt;&lt; 11)
-# define two107 (((limb)1) &lt;&lt; 107)
-# define two107m43p11 (((limb)1) &lt;&lt; 107) - (((limb)1) &lt;&lt; 43) + (((limb)1) &lt;&lt; 11)
+#define two107m43m11 (((limb)1) &lt;&lt; 107) - (((limb)1) &lt;&lt; 43) - (((limb)1) &lt;&lt; 11)
+#define two107 (((limb)1) &lt;&lt; 107)
+#define two107m43p11 (((limb)1) &lt;&lt; 107) - (((limb)1) &lt;&lt; 43) + (((limb)1) &lt;&lt; 11)
 
 /* zero107 is 0 mod p */
 static const felem zero107 =
@@ -364,10 +361,10 @@ static void longfelem_diff(longfelem out, const longfelem in)
     out[7] -= in[7];
 }
 
-# define two64m0 (((limb)1) &lt;&lt; 64) - 1
-# define two110p32m0 (((limb)1) &lt;&lt; 110) + (((limb)1) &lt;&lt; 32) - 1
-# define two64m46 (((limb)1) &lt;&lt; 64) - (((limb)1) &lt;&lt; 46)
-# define two64m32 (((limb)1) &lt;&lt; 64) - (((limb)1) &lt;&lt; 32)
+#define two64m0 (((limb)1) &lt;&lt; 64) - 1
+#define two110p32m0 (((limb)1) &lt;&lt; 110) + (((limb)1) &lt;&lt; 32) - 1
+#define two64m46 (((limb)1) &lt;&lt; 64) - (((limb)1) &lt;&lt; 46)
+#define two64m32 (((limb)1) &lt;&lt; 64) - (((limb)1) &lt;&lt; 32)
 
 /* zero110 is 0 mod p */
 static const felem zero110 = { two64m0, two110p32m0, two64m46, two64m32 };
@@ -717,9 +714,9 @@ static void felem_small_mul(longfelem out, const smallfelem small1,
     smallfelem_mul(out, small1, small2);
 }
 
-# define two100m36m4 (((limb)1) &lt;&lt; 100) - (((limb)1) &lt;&lt; 36) - (((limb)1) &lt;&lt; 4)
-# define two100 (((limb)1) &lt;&lt; 100)
-# define two100m36p4 (((limb)1) &lt;&lt; 100) - (((limb)1) &lt;&lt; 36) + (((limb)1) &lt;&lt; 4)
+#define two100m36m4 (((limb)1) &lt;&lt; 100) - (((limb)1) &lt;&lt; 36) - (((limb)1) &lt;&lt; 4)
+#define two100 (((limb)1) &lt;&lt; 100)
+#define two100m36p4 (((limb)1) &lt;&lt; 100) - (((limb)1) &lt;&lt; 36) + (((limb)1) &lt;&lt; 4)
 /* zero100 is 0 mod p */
 static const felem zero100 =
     { two100m36m4, two100, two100m36p4, two100m36p4 };
@@ -2387,4 +2384,3 @@ int ec_GFp_nistp256_have_precompute_mult(const EC_GROUP *group)
 {
     return HAVEPRECOMP(group, nistp256);
 }
-#endif
diff --git a/crypto/ec/ecp_nistp521.c b/crypto/ec/ecp_nistp521.c
index d09553fec8..9d22da6572 100644
--- a/crypto/ec/ecp_nistp521.c
+++ b/crypto/ec/ecp_nistp521.c
@@ -38,21 +38,18 @@
  */
 
 #include &lt;openssl/e_os2.h&gt;
-#ifdef OPENSSL_NO_EC_NISTP_64_GCC_128
-NON_EMPTY_TRANSLATION_UNIT
-#else
 
-# include &lt;string.h&gt;
-# include &lt;openssl/err.h&gt;
-# include &quot;ec_local.h&quot;
+#include &lt;string.h&gt;
+#include &lt;openssl/err.h&gt;
+#include &quot;ec_local.h&quot;
 
-# if defined(__SIZEOF_INT128__) &amp;&amp; __SIZEOF_INT128__==16
+#if defined(__SIZEOF_INT128__) &amp;&amp; __SIZEOF_INT128__==16
   /* even with gcc, the typedef won't work for 32-bit platforms */
 typedef __uint128_t uint128_t;  /* nonstandard; implemented by gcc on 64-bit
                                  * platforms */
-# else
-#  error &quot;Your compiler doesn't appear to support 128-bit integer types&quot;
-# endif
+#else
+# error &quot;Your compiler doesn't appear to support 128-bit integer types&quot;
+#endif
 
 typedef uint8_t u8;
 typedef uint64_t u64;
@@ -131,7 +128,7 @@ static const felem_bytearray nistp521_curve_params[5] = {
  * A field element with 64-bit limbs is an 'felem'. One with 128-bit limbs is a
  * 'largefelem' */
 
-# define NLIMBS 9
+#define NLIMBS 9
 
 typedef uint64_t limb;
 typedef limb felem[NLIMBS];
@@ -2193,5 +2190,3 @@ int ec_GFp_nistp521_have_precompute_mult(const EC_GROUP *group)
 {
     return HAVEPRECOMP(group, nistp521);
 }
-
-#endif
diff --git a/crypto/ec/ecp_nistputil.c b/crypto/ec/ecp_nistputil.c
index d3739a108c..52ce6ee879 100644
--- a/crypto/ec/ecp_nistputil.c
+++ b/crypto/ec/ecp_nistputil.c
@@ -30,16 +30,13 @@
 #include &quot;internal/deprecated.h&quot;
 
 #include &lt;openssl/opensslconf.h&gt;
-#ifdef OPENSSL_NO_EC_NISTP_64_GCC_128
-NON_EMPTY_TRANSLATION_UNIT
-#else
 
 /*
  * Common utility functions for ecp_nistp224.c, ecp_nistp256.c, ecp_nistp521.c.
  */
 
-# include &lt;stddef.h&gt;
-# include &quot;ec_local.h&quot;
+#include &lt;stddef.h&gt;
+#include &quot;ec_local.h&quot;
 
 /*
  * Convert an array of points into affine coordinates. (If the point at
@@ -80,10 +77,10 @@ void ec_GFp_nistp_points_make_affine_internal(size_t num, void *point_array,
 {
     int i = 0;
 
-# define tmp_felem(I) (&amp;((char *)tmp_felems)[(I) * felem_size])
-# define X(I) (&amp;((char *)point_array)[3*(I) * felem_size])
-# define Y(I) (&amp;((char *)point_array)[(3*(I) + 1) * felem_size])
-# define Z(I) (&amp;((char *)point_array)[(3*(I) + 2) * felem_size])
+#define tmp_felem(I) (&amp;((char *)tmp_felems)[(I) * felem_size])
+#define X(I) (&amp;((char *)point_array)[3*(I) * felem_size])
+#define Y(I) (&amp;((char *)point_array)[(3*(I) + 1) * felem_size])
+#define Z(I) (&amp;((char *)point_array)[(3*(I) + 2) * felem_size])
 
     if (!felem_is_zero(Z(0)))
         felem_assign(tmp_felem(0), Z(0));
@@ -226,4 +223,3 @@ void ec_GFp_nistp_recode_scalar_bits(unsigned char *sign,
     *sign = s &amp; 1;
     *digit = d;
 }
-#endif
diff --git a/crypto/evp/build.info b/crypto/evp/build.info
index 846cd65513..82669c1816 100644
--- a/crypto/evp/build.info
+++ b/crypto/evp/build.info
@@ -6,14 +6,14 @@ $COMMON=digest.c evp_enc.c evp_lib.c evp_fetch.c cmeth_lib.c evp_utils.c \
 
 SOURCE[../../libcrypto]=$COMMON\
         encode.c evp_key.c evp_cnf.c \
-        e_des.c e_bf.c e_idea.c e_des3.c e_camellia.c\
-        e_rc4.c e_aes.c names.c e_seed.c e_aria.c e_sm4.c \
+        e_des.c e_bf.c e_idea.c e_des3.c \
+        e_rc4.c e_aes.c names.c e_aria.c e_sm4.c \
         e_xcbc_d.c e_rc2.c e_cast.c e_rc5.c m_null.c \
-        p_open.c p_seal.c p_sign.c p_verify.c \
+        p_seal.c p_sign.c p_verify.c \
         bio_md.c bio_b64.c bio_enc.c evp_err.c e_null.c \
         c_allc.c c_alld.c bio_ok.c \
         evp_pkey.c evp_pbe.c p5_crpt.c p5_crpt2.c pbe_scrypt.c \
-        pkey_kdf.c e_old.c pmeth_fn.c\
+        pkey_kdf.c pmeth_fn.c\
         e_aes_cbc_hmac_sha1.c e_aes_cbc_hmac_sha256.c e_rc4_hmac_md5.c \
         e_chacha20_poly1305.c \
         pkey_mac.c \
@@ -22,7 +22,12 @@ SOURCE[../../libcrypto]=$COMMON\
 IF[{- !$disabled{'deprecated-3.0'} -}]
   SOURCE[../../libcrypto]=p_enc.c p_dec.c
 ENDIF
-
+IF[{- !$disabled{'deprecated-0.9.8'} -}]
+  SOURCE[../../libcrypto]=e_old.c
+ENDIF
+IF[{- !$disabled{'rsa'} -}]
+  SOURCE[../../libcrypto]=p_open.c
+ENDIF
 IF[{- !$disabled{md2} -}]
   SOURCE[../../libcrypto]=legacy_md2.c
 ENDIF
@@ -44,6 +49,13 @@ ENDIF
 IF[{- !$disabled{rmd160} -}]
   SOURCE[../../libcrypto]=legacy_ripemd.c
 ENDIF
+IF[{- !$disabled{seed} -}]
+  SOURCE[../../libcrypto]=e_seed.c
+ENDIF
+IF[{- !$disabled{camellia} -}]
+  SOURCE[../../libcrypto]=e_camellia.c
+  INCLUDE[e_camellia.o]=.. ../modes
+ENDIF
 
 SOURCE[../../providers/libfips.a]=$COMMON
 
@@ -51,7 +63,6 @@ INCLUDE[e_aes.o]=.. ../modes
 INCLUDE[e_aes_cbc_hmac_sha1.o]=../modes
 INCLUDE[e_aes_cbc_hmac_sha256.o]=../modes
 INCLUDE[e_aria.o]=.. ../modes
-INCLUDE[e_camellia.o]=.. ../modes
 INCLUDE[e_sm4.o]=.. ../modes
 INCLUDE[e_des.o]=..
 INCLUDE[e_des3.o]=..
diff --git a/crypto/evp/e_camellia.c b/crypto/evp/e_camellia.c
index b063821924..26dbe0ecae 100644
--- a/crypto/evp/e_camellia.c
+++ b/crypto/evp/e_camellia.c
@@ -14,18 +14,15 @@
 #include &quot;internal/deprecated.h&quot;
 
 #include &lt;openssl/opensslconf.h&gt;
-#ifdef OPENSSL_NO_CAMELLIA
-NON_EMPTY_TRANSLATION_UNIT
-#else
 
-# include &lt;openssl/evp.h&gt;
-# include &lt;openssl/err.h&gt;
-# include &lt;string.h&gt;
-# include &lt;assert.h&gt;
-# include &lt;openssl/camellia.h&gt;
-# include &quot;crypto/evp.h&quot;
-# include &quot;crypto/modes.h&quot;
-# include &quot;crypto/cmll_platform.h&quot;
+#include &lt;openssl/evp.h&gt;
+#include &lt;openssl/err.h&gt;
+#include &lt;string.h&gt;
+#include &lt;assert.h&gt;
+#include &lt;openssl/camellia.h&gt;
+#include &quot;crypto/evp.h&quot;
+#include &quot;crypto/modes.h&quot;
+#include &quot;crypto/cmll_platform.h&quot;
 
 static int camellia_init_key(EVP_CIPHER_CTX *ctx, const unsigned char *key,
                              const unsigned char *iv, int enc);
@@ -40,15 +37,15 @@ typedef struct {
     } stream;
 } EVP_CAMELLIA_KEY;
 
-# define MAXBITCHUNK     ((size_t)1&lt;&lt;(sizeof(size_t)*8-4))
+#define MAXBITCHUNK     ((size_t)1&lt;&lt;(sizeof(size_t)*8-4))
 
 /* Attribute operation for Camellia */
-# define data(ctx)       EVP_C_DATA(EVP_CAMELLIA_KEY,ctx)
+#define data(ctx)       EVP_C_DATA(EVP_CAMELLIA_KEY,ctx)
 
-# if defined(AES_ASM) &amp;&amp; (defined(__sparc) || defined(__sparc__))
+#if defined(AES_ASM) &amp;&amp; (defined(__sparc) || defined(__sparc__))
 /* ---------^^^ this is not a typo, just a way to detect that
  * assembler support was in general requested... */
-#  include &quot;sparc_arch.h&quot;
+# include &quot;sparc_arch.h&quot;
 
 
 static int cmll_t4_init_key(EVP_CIPHER_CTX *ctx, const unsigned char *key,
@@ -114,35 +111,35 @@ static int cmll_t4_init_key(EVP_CIPHER_CTX *ctx, const unsigned char *key,
     return 1;
 }
 
-#  define cmll_t4_cbc_cipher camellia_cbc_cipher
+# define cmll_t4_cbc_cipher camellia_cbc_cipher
 static int cmll_t4_cbc_cipher(EVP_CIPHER_CTX *ctx, unsigned char *out,
                               const unsigned char *in, size_t len);
 
-#  define cmll_t4_ecb_cipher camellia_ecb_cipher
+# define cmll_t4_ecb_cipher camellia_ecb_cipher
 static int cmll_t4_ecb_cipher(EVP_CIPHER_CTX *ctx, unsigned char *out,
                               const unsigned char *in, size_t len);
 
-#  define cmll_t4_ofb_cipher camellia_ofb_cipher
+# define cmll_t4_ofb_cipher camellia_ofb_cipher
 static int cmll_t4_ofb_cipher(EVP_CIPHER_CTX *ctx, unsigned char *out,
                               const unsigned char *in, size_t len);
 
-#  define cmll_t4_cfb_cipher camellia_cfb_cipher
+# define cmll_t4_cfb_cipher camellia_cfb_cipher
 static int cmll_t4_cfb_cipher(EVP_CIPHER_CTX *ctx, unsigned char *out,
                               const unsigned char *in, size_t len);
 
-#  define cmll_t4_cfb8_cipher camellia_cfb8_cipher
+# define cmll_t4_cfb8_cipher camellia_cfb8_cipher
 static int cmll_t4_cfb8_cipher(EVP_CIPHER_CTX *ctx, unsigned char *out,
                                const unsigned char *in, size_t len);
 
-#  define cmll_t4_cfb1_cipher camellia_cfb1_cipher
+# define cmll_t4_cfb1_cipher camellia_cfb1_cipher
 static int cmll_t4_cfb1_cipher(EVP_CIPHER_CTX *ctx, unsigned char *out,
                                const unsigned char *in, size_t len);
 
-#  define cmll_t4_ctr_cipher camellia_ctr_cipher
+# define cmll_t4_ctr_cipher camellia_ctr_cipher
 static int cmll_t4_ctr_cipher(EVP_CIPHER_CTX *ctx, unsigned char *out,
                               const unsigned char *in, size_t len);
 
-#  define BLOCK_CIPHER_generic(nid,keylen,blocksize,ivlen,nmode,mode,MODE,flags) \
+# define BLOCK_CIPHER_generic(nid,keylen,blocksize,ivlen,nmode,mode,MODE,flags) \
 static const EVP_CIPHER cmll_t4_##keylen##_##mode = { \
         nid##_##keylen##_##nmode,blocksize,keylen/8,ivlen, \
         flags|EVP_CIPH_##MODE##_MODE,   \
@@ -163,9 +160,9 @@ static const EVP_CIPHER camellia_##keylen##_##mode = { \
 const EVP_CIPHER *EVP_camellia_##keylen##_##mode(void) \
 { return SPARC_CMLL_CAPABLE?&amp;cmll_t4_##keylen##_##mode:&amp;camellia_##keylen##_##mode; }
 
-# else
+#else
 
-#  define BLOCK_CIPHER_generic(nid,keylen,blocksize,ivlen,nmode,mode,MODE,flags) \
+# define BLOCK_CIPHER_generic(nid,keylen,blocksize,ivlen,nmode,mode,MODE,flags) \
 static const EVP_CIPHER camellia_##keylen##_##mode = { \
         nid##_##keylen##_##nmode,blocksize,keylen/8,ivlen, \
         flags|EVP_CIPH_##MODE##_MODE,   \
@@ -177,9 +174,9 @@ static const EVP_CIPHER camellia_##keylen##_##mode = { \
 const EVP_CIPHER *EVP_camellia_##keylen##_##mode(void) \
 { return &amp;camellia_##keylen##_##mode; }
 
-# endif
+#endif
 
-# define BLOCK_CIPHER_generic_pack(nid,keylen,flags)             \
+#define BLOCK_CIPHER_generic_pack(nid,keylen,flags)             \
         BLOCK_CIPHER_generic(nid,keylen,16,16,cbc,cbc,CBC,flags|EVP_CIPH_FLAG_DEFAULT_ASN1)     \
         BLOCK_CIPHER_generic(nid,keylen,16,0,ecb,ecb,ECB,flags|EVP_CIPH_FLAG_DEFAULT_ASN1)      \
         BLOCK_CIPHER_generic(nid,keylen,1,16,ofb128,ofb,OFB,flags|EVP_CIPH_FLAG_DEFAULT_ASN1)   \
@@ -342,4 +339,3 @@ static int camellia_ctr_cipher(EVP_CIPHER_CTX *ctx, unsigned char *out,
 BLOCK_CIPHER_generic_pack(NID_camellia, 128, 0)
     BLOCK_CIPHER_generic_pack(NID_camellia, 192, 0)
     BLOCK_CIPHER_generic_pack(NID_camellia, 256, 0)
-#endif
diff --git a/crypto/evp/e_old.c b/crypto/evp/e_old.c
index 82e0c1282c..0a74b050c9 100644
--- a/crypto/evp/e_old.c
+++ b/crypto/evp/e_old.c
@@ -8,11 +8,8 @@
  */
 
 #include &lt;openssl/opensslconf.h&gt;
-#ifdef OPENSSL_NO_DEPRECATED_0_9_8
-NON_EMPTY_TRANSLATION_UNIT
-#else
 
-# include &lt;openssl/evp.h&gt;
+#include &lt;openssl/evp.h&gt;
 
 /*
  * Define some deprecated functions, so older programs don't crash and burn
@@ -21,93 +18,91 @@ NON_EMPTY_TRANSLATION_UNIT
  * location, not by name.
  */
 
-# ifndef OPENSSL_NO_BF
-#  undef EVP_bf_cfb
+#ifndef OPENSSL_NO_BF
+# undef EVP_bf_cfb
 const EVP_CIPHER *EVP_bf_cfb(void);
 const EVP_CIPHER *EVP_bf_cfb(void)
 {
     return EVP_bf_cfb64();
 }
-# endif
+#endif
 
-# ifndef OPENSSL_NO_DES
-#  undef EVP_des_cfb
+#ifndef OPENSSL_NO_DES
+# undef EVP_des_cfb
 const EVP_CIPHER *EVP_des_cfb(void);
 const EVP_CIPHER *EVP_des_cfb(void)
 {
     return EVP_des_cfb64();
 }
 
-#  undef EVP_des_ede3_cfb
+# undef EVP_des_ede3_cfb
 const EVP_CIPHER *EVP_des_ede3_cfb(void);
 const EVP_CIPHER *EVP_des_ede3_cfb(void)
 {
     return EVP_des_ede3_cfb64();
 }
 
-#  undef EVP_des_ede_cfb
+# undef EVP_des_ede_cfb
 const EVP_CIPHER *EVP_des_ede_cfb(void);
 const EVP_CIPHER *EVP_des_ede_cfb(void)
 {
     return EVP_des_ede_cfb64();
 }
-# endif
+#endif
 
-# ifndef OPENSSL_NO_IDEA
-#  undef EVP_idea_cfb
+#ifndef OPENSSL_NO_IDEA
+# undef EVP_idea_cfb
 const EVP_CIPHER *EVP_idea_cfb(void);
 const EVP_CIPHER *EVP_idea_cfb(void)
 {
     return EVP_idea_cfb64();
 }
-# endif
+#endif
 
-# ifndef OPENSSL_NO_RC2
-#  undef EVP_rc2_cfb
+#ifndef OPENSSL_NO_RC2
+# undef EVP_rc2_cfb
 const EVP_CIPHER *EVP_rc2_cfb(void);
 const EVP_CIPHER *EVP_rc2_cfb(void)
 {
     return EVP_rc2_cfb64();
 }
-# endif
+#endif
 
-# ifndef OPENSSL_NO_CAST
-#  undef EVP_cast5_cfb
+#ifndef OPENSSL_NO_CAST
+# undef EVP_cast5_cfb
 const EVP_CIPHER *EVP_cast5_cfb(void);
 const EVP_CIPHER *EVP_cast5_cfb(void)
 {
     return EVP_cast5_cfb64();
 }
-# endif
+#endif
 
-# ifndef OPENSSL_NO_RC5
-#  undef EVP_rc5_32_12_16_cfb
+#ifndef OPENSSL_NO_RC5
+# undef EVP_rc5_32_12_16_cfb
 const EVP_CIPHER *EVP_rc5_32_12_16_cfb(void);
 const EVP_CIPHER *EVP_rc5_32_12_16_cfb(void)
 {
     return EVP_rc5_32_12_16_cfb64();
 }
-# endif
+#endif
 
-# undef EVP_aes_128_cfb
+#undef EVP_aes_128_cfb
 const EVP_CIPHER *EVP_aes_128_cfb(void);
 const EVP_CIPHER *EVP_aes_128_cfb(void)
 {
     return EVP_aes_128_cfb128();
 }
 
-# undef EVP_aes_192_cfb
+#undef EVP_aes_192_cfb
 const EVP_CIPHER *EVP_aes_192_cfb(void);
 const EVP_CIPHER *EVP_aes_192_cfb(void)
 {
     return EVP_aes_192_cfb128();
 }
 
-# undef EVP_aes_256_cfb
+#undef EVP_aes_256_cfb
 const EVP_CIPHER *EVP_aes_256_cfb(void);
 const EVP_CIPHER *EVP_aes_256_cfb(void)
 {
     return EVP_aes_256_cfb128();
 }
-
-#endif
diff --git a/crypto/evp/e_seed.c b/crypto/evp/e_seed.c
index 224003d9dd..e66abdbc71 100644
--- a/crypto/evp/e_seed.c
+++ b/crypto/evp/e_seed.c
@@ -14,15 +14,12 @@
 #include &quot;internal/deprecated.h&quot;
 
 #include &lt;openssl/opensslconf.h&gt;
-#ifdef OPENSSL_NO_SEED
-NON_EMPTY_TRANSLATION_UNIT
-#else
-# include &lt;openssl/evp.h&gt;
-# include &lt;openssl/err.h&gt;
-# include &lt;string.h&gt;
-# include &lt;assert.h&gt;
-# include &lt;openssl/seed.h&gt;
-# include &quot;crypto/evp.h&quot;
+#include &lt;openssl/evp.h&gt;
+#include &lt;openssl/err.h&gt;
+#include &lt;string.h&gt;
+#include &lt;assert.h&gt;
+#include &lt;openssl/seed.h&gt;
+#include &quot;crypto/evp.h&quot;
 
 static int seed_init_key(EVP_CIPHER_CTX *ctx, const unsigned char *key,
                          const unsigned char *iv, int enc);
@@ -41,5 +38,3 @@ static int seed_init_key(EVP_CIPHER_CTX *ctx, const unsigned char *key,
     SEED_set_key(key, &amp;EVP_C_DATA(EVP_SEED_KEY,ctx)-&gt;ks);
     return 1;
 }
-
-#endif
diff --git a/crypto/evp/p_open.c b/crypto/evp/p_open.c
index bcc01a7817..14b8065424 100644
--- a/crypto/evp/p_open.c
+++ b/crypto/evp/p_open.c
@@ -8,15 +8,12 @@
  */
 
 #include &quot;internal/cryptlib.h&quot;
-#ifdef OPENSSL_NO_RSA
-NON_EMPTY_TRANSLATION_UNIT
-#else
 
-# include &lt;stdio.h&gt;
-# include &lt;openssl/evp.h&gt;
-# include &lt;openssl/objects.h&gt;
-# include &lt;openssl/x509.h&gt;
-# include &lt;openssl/rsa.h&gt;
+#include &lt;stdio.h&gt;
+#include &lt;openssl/evp.h&gt;
+#include &lt;openssl/objects.h&gt;
+#include &lt;openssl/x509.h&gt;
+#include &lt;openssl/rsa.h&gt;
 
 int EVP_OpenInit(EVP_CIPHER_CTX *ctx, const EVP_CIPHER *type,
                  const unsigned char *ek, int ekl, const unsigned char *iv,
@@ -73,4 +70,3 @@ int EVP_OpenFinal(EVP_CIPHER_CTX *ctx, unsigned char *out, int *outl)
         i = EVP_DecryptInit_ex(ctx, NULL, NULL, NULL, NULL);
     return i;
 }
-#endif
diff --git a/crypto/rand/build.info b/crypto/rand/build.info
index 0925c4b2de..c4e7476ef7 100644
--- a/crypto/rand/build.info
+++ b/crypto/rand/build.info
@@ -1,7 +1,16 @@
 LIBS=../../libcrypto
 
-$COMMON=rand_lib.c rand_crng_test.c rand_win.c rand_unix.c  rand_vms.c \
-        drbg_lib.c drbg_ctr.c rand_vxworks.c drbg_hash.c drbg_hmac.c
+$COMMON=rand_lib.c rand_crng_test.c rand_unix.c rand_win.c \
+        drbg_lib.c drbg_ctr.c drbg_hash.c drbg_hmac.c
+IF[{- !$disabled{'egd'} -}]
+  $COMMON=$COMMON rand_egd.c
+ENDIF
+IF[{- $config{target} =~ /vxworks/i -}]
+  $COMMON=$COMMON rand_vxworks.c
+ENDIF
+IF[{- $config{target} =~ /vms/i -}]
+  $COMMON=$COMMON rand_vms.c
+ENDIF
 
-SOURCE[../../libcrypto]=$COMMON randfile.c rand_err.c rand_egd.c
+SOURCE[../../libcrypto]=$COMMON randfile.c rand_err.c
 SOURCE[../../providers/libfips.a]=$COMMON
diff --git a/crypto/rand/rand_egd.c b/crypto/rand/rand_egd.c
index bac8d609c4..dfed1453d7 100644
--- a/crypto/rand/rand_egd.c
+++ b/crypto/rand/rand_egd.c
@@ -8,19 +8,16 @@
  */
 
 #include &lt;openssl/opensslconf.h&gt;
-#ifdef OPENSSL_NO_EGD
-NON_EMPTY_TRANSLATION_UNIT
-#else
 
-# include &lt;openssl/crypto.h&gt;
-# include &lt;openssl/e_os2.h&gt;
-# include &lt;openssl/rand.h&gt;
+#include &lt;openssl/crypto.h&gt;
+#include &lt;openssl/e_os2.h&gt;
+#include &lt;openssl/rand.h&gt;
 
 /*
  * Query an EGD
  */
 
-# if defined(OPENSSL_SYS_WIN32) || defined(OPENSSL_SYS_VMS) || defined(OPENSSL_SYS_MSDOS) || defined(OPENSSL_SYS_VXWORKS) || defined(OPENSSL_SYS_VOS) || defined(OPENSSL_SYS_UEFI)
+#if defined(OPENSSL_SYS_WIN32) || defined(OPENSSL_SYS_VMS) || defined(OPENSSL_SYS_MSDOS) || defined(OPENSSL_SYS_VXWORKS) || defined(OPENSSL_SYS_VOS) || defined(OPENSSL_SYS_UEFI)
 int RAND_query_egd_bytes(const char *path, unsigned char *buf, int bytes)
 {
     return -1;
@@ -36,26 +33,26 @@ int RAND_egd_bytes(const char *path, int bytes)
     return -1;
 }
 
-# else
+#else
 
-#  include &lt;unistd.h&gt;
-#  include &lt;stddef.h&gt;
-#  include &lt;sys/types.h&gt;
-#  include &lt;sys/socket.h&gt;
-#  ifndef NO_SYS_UN_H
-#   ifdef OPENSSL_SYS_VXWORKS
-#    include &lt;streams/un.h&gt;
-#   else
-#    include &lt;sys/un.h&gt;
-#   endif
+# include &lt;unistd.h&gt;
+# include &lt;stddef.h&gt;
+# include &lt;sys/types.h&gt;
+# include &lt;sys/socket.h&gt;
+# ifndef NO_SYS_UN_H
+#  ifdef OPENSSL_SYS_VXWORKS
+#   include &lt;streams/un.h&gt;
 #  else
+#   include &lt;sys/un.h&gt;
+#  endif
+# else
 struct sockaddr_un {
     short sun_family;           /* AF_UNIX */
     char sun_path[108];         /* path name (gag) */
 };
-#  endif                         /* NO_SYS_UN_H */
-#  include &lt;string.h&gt;
-#  include &lt;errno.h&gt;
+# endif                         /* NO_SYS_UN_H */
+# include &lt;string.h&gt;
+# include &lt;errno.h&gt;
 
 int RAND_query_egd_bytes(const char *path, unsigned char *buf, int bytes)
 {
@@ -83,23 +80,23 @@ int RAND_query_egd_bytes(const char *path, unsigned char *buf, int bytes)
     for ( ; ; ) {
         if (connect(fd, (struct sockaddr *)&amp;addr, i) == 0)
             break;
-#  ifdef EISCONN
+# ifdef EISCONN
         if (errno == EISCONN)
             break;
-#  endif
+# endif
         switch (errno) {
-#  ifdef EINTR
+# ifdef EINTR
         case EINTR:
-#  endif
-#  ifdef EAGAIN
+# endif
+# ifdef EAGAIN
         case EAGAIN:
-#  endif
-#  ifdef EINPROGRESS
+# endif
+# ifdef EINPROGRESS
         case EINPROGRESS:
-#  endif
-#  ifdef EALREADY
+# endif
+# ifdef EALREADY
         case EALREADY:
-#  endif
+# endif
             /* No error, try again */
             break;
         default:
@@ -153,6 +150,4 @@ int RAND_egd(const char *path)
     return RAND_egd_bytes(path, 255);
 }
 
-# endif
-
 #endif
diff --git a/crypto/rand/rand_vms.c b/crypto/rand/rand_vms.c
index 13d913bc28..d798f55e49 100644
--- a/crypto/rand/rand_vms.c
+++ b/crypto/rand/rand_vms.c
@@ -9,34 +9,33 @@
 
 #include &quot;e_os.h&quot;
 
-#if defined(OPENSSL_SYS_VMS)
-# define __NEW_STARLET 1         /* New starlet definitions since VMS 7.0 */
-# include &lt;unistd.h&gt;
-# include &quot;internal/cryptlib.h&quot;
-# include &lt;openssl/rand.h&gt;
-# include &quot;crypto/rand.h&quot;
-# include &quot;rand_local.h&quot;
-# include &lt;descrip.h&gt;
-# include &lt;dvidef.h&gt;
-# include &lt;jpidef.h&gt;
-# include &lt;rmidef.h&gt;
-# include &lt;syidef.h&gt;
-# include &lt;ssdef.h&gt;
-# include &lt;starlet.h&gt;
-# include &lt;efndef.h&gt;
-# include &lt;gen64def.h&gt;
-# include &lt;iosbdef.h&gt;
-# include &lt;iledef.h&gt;
-# include &lt;lib$routines.h&gt;
-# ifdef __DECC
-#  pragma message disable DOLLARID
-# endif
-
-# include &lt;dlfcn.h&gt;              /* SYS$GET_ENTROPY presence */
-
-# ifndef OPENSSL_RAND_SEED_OS
-#  error &quot;Unsupported seeding method configured; must be os&quot;
-# endif
+#define __NEW_STARLET 1         /* New starlet definitions since VMS 7.0 */
+#include &lt;unistd.h&gt;
+#include &quot;internal/cryptlib.h&quot;
+#include &lt;openssl/rand.h&gt;
+#include &quot;crypto/rand.h&quot;
+#include &quot;rand_local.h&quot;
+#include &lt;descrip.h&gt;
+#include &lt;dvidef.h&gt;
+#include &lt;jpidef.h&gt;
+#include &lt;rmidef.h&gt;
+#include &lt;syidef.h&gt;
+#include &lt;ssdef.h&gt;
+#include &lt;starlet.h&gt;
+#include &lt;efndef.h&gt;
+#include &lt;gen64def.h&gt;
+#include &lt;iosbdef.h&gt;
+#include &lt;iledef.h&gt;
+#include &lt;lib$routines.h&gt;
+#ifdef __DECC
+# pragma message disable DOLLARID
+#endif
+
+#include &lt;dlfcn.h&gt;              /* SYS$GET_ENTROPY presence */
+
+#ifndef OPENSSL_RAND_SEED_OS
+# error &quot;Unsupported seeding method configured; must be os&quot;
+#endif
 
 /*
  * DATA COLLECTION METHOD
@@ -48,14 +47,14 @@
  */
 
 /* We need to make sure we have the right size pointer in some cases */
-# if __INITIAL_POINTER_SIZE == 64
-#  pragma pointer_size save
-#  pragma pointer_size 32
-# endif
+#if __INITIAL_POINTER_SIZE == 64
+# pragma pointer_size save
+# pragma pointer_size 32
+#endif
 typedef uint32_t *uint32_t__ptr32;
-# if __INITIAL_POINTER_SIZE == 64
-#  pragma pointer_size restore
-# endif
+#if __INITIAL_POINTER_SIZE == 64
+# pragma pointer_size restore
+#endif
 
 struct item_st {
     short length, code;         /* length is number of bytes */
@@ -613,5 +612,3 @@ void rand_pool_cleanup(void)
 void rand_pool_keep_random_devices_open(int keep)
 {
 }
-
-#endif
diff --git a/crypto/rand/rand_vxworks.c b/crypto/rand/rand_vxworks.c
index d67469898e..bb0dcb87ad 100644
--- a/crypto/rand/rand_vxworks.c
+++ b/crypto/rand/rand_vxworks.c
@@ -9,35 +9,32 @@
 
 #include &lt;openssl/opensslconf.h&gt;
 
-#ifndef OPENSSL_SYS_VXWORKS
-NON_EMPTY_TRANSLATION_UNIT
-#else
-# include &lt;openssl/rand.h&gt;
-# include &quot;rand_local.h&quot;
-# include &quot;crypto/rand.h&quot;
-# include &quot;internal/cryptlib.h&quot;
-# include &lt;version.h&gt;
-# include &lt;taskLib.h&gt;
-
-# if defined(OPENSSL_RAND_SEED_NONE)
+#include &lt;openssl/rand.h&gt;
+#include &quot;rand_local.h&quot;
+#include &quot;crypto/rand.h&quot;
+#include &quot;internal/cryptlib.h&quot;
+#include &lt;version.h&gt;
+#include &lt;taskLib.h&gt;
+
+#if defined(OPENSSL_RAND_SEED_NONE)
 /* none means none */
-#  undef OPENSSL_RAND_SEED_OS
-# endif
+# undef OPENSSL_RAND_SEED_OS
+#endif
 
-# if defined(OPENSSL_RAND_SEED_OS)
-#  if _WRS_VXWORKS_MAJOR &gt;= 7
-#    define RAND_SEED_VXRANDLIB
-#  else
-#    error &quot;VxWorks &lt;7 only support RAND_SEED_NONE&quot;
-#  endif
+#if defined(OPENSSL_RAND_SEED_OS)
+# if _WRS_VXWORKS_MAJOR &gt;= 7
+#   define RAND_SEED_VXRANDLIB
+# else
+#   error &quot;VxWorks &lt;7 only support RAND_SEED_NONE&quot;
 # endif
+#endif
 
-# if defined(RAND_SEED_VXRANDLIB)
-#  include &lt;randomNumGen.h&gt;
-# endif
+#if defined(RAND_SEED_VXRANDLIB)
+# include &lt;randomNumGen.h&gt;
+#endif
 
 /* Macro to convert two thirty two bit values into a sixty four bit one */
-# define TWO32TO64(a, b) ((((uint64_t)(a)) &lt;&lt; 32) + (b))
+#define TWO32TO64(a, b) ((((uint64_t)(a)) &lt;&lt; 32) + (b))
 
 static uint64_t get_time_stamp(void)
 {
@@ -122,7 +119,7 @@ int rand_pool_add_nonce_data(RAND_POOL *pool)
 
 size_t rand_pool_acquire_entropy(RAND_POOL *pool)
 {
-# if defined(RAND_SEED_VXRANDLIB)
+#if defined(RAND_SEED_VXRANDLIB)
     /* vxRandLib based entropy method */
     size_t bytes_needed;
 
@@ -159,13 +156,11 @@ size_t rand_pool_acquire_entropy(RAND_POOL *pool)
         }
     }
     return rand_pool_entropy_available(pool);
-# else
+#else
     /*
      * SEED_NONE means none, without randlib we dont have entropy and
      * rely on it being added externally
      */
     return rand_pool_entropy_available(pool);
-# endif /* defined(RAND_SEED_VXRANDLIB) */
+#endif /* defined(RAND_SEED_VXRANDLIB) */
 }
-
-#endif /* OPENSSL_SYS_VXWORKS */
diff --git a/crypto/rsa/build.info b/crypto/rsa/build.info
index 0c9e46684c..970c493560 100644
--- a/crypto/rsa/build.info
+++ b/crypto/rsa/build.info
@@ -6,6 +6,10 @@ $COMMON=rsa_ossl.c rsa_gen.c rsa_lib.c rsa_sign.c rsa_pk1.c \
         rsa_mp_names.c
 
 SOURCE[../../libcrypto]=$COMMON\
-        rsa_saos.c rsa_err.c rsa_asn1.c rsa_depr.c rsa_ameth.c rsa_prn.c \
+        rsa_saos.c rsa_err.c rsa_asn1.c rsa_ameth.c rsa_prn.c \
         rsa_pmeth.c rsa_meth.c rsa_mp.c rsa_ssl.c
+IF[{- !$disabled{'deprecated-0.9.8'} -}]
+  SOURCE[../../libcrypto]=rsa_depr.c
+ENDIF
+
 SOURCE[../../providers/libfips.a]=$COMMON
diff --git a/crypto/rsa/rsa_depr.c b/crypto/rsa/rsa_depr.c
index 8ba6e8c2ee..38b445e2d2 100644
--- a/crypto/rsa/rsa_depr.c
+++ b/crypto/rsa/rsa_depr.c
@@ -19,16 +19,12 @@
 #include &quot;internal/deprecated.h&quot;
 
 #include &lt;openssl/opensslconf.h&gt;
-#ifdef OPENSSL_NO_DEPRECATED_0_9_8
-NON_EMPTY_TRANSLATION_UNIT
 
-#else
-
-# include &lt;stdio.h&gt;
-# include &lt;time.h&gt;
-# include &quot;internal/cryptlib.h&quot;
-# include &lt;openssl/bn.h&gt;
-# include &lt;openssl/rsa.h&gt;
+#include &lt;stdio.h&gt;
+#include &lt;time.h&gt;
+#include &quot;internal/cryptlib.h&quot;
+#include &lt;openssl/bn.h&gt;
+#include &lt;openssl/rsa.h&gt;
 
 RSA *RSA_generate_key(int bits, unsigned long e_value,
                       void (*callback) (int, int, void *), void *cb_arg)
@@ -64,4 +60,3 @@ RSA *RSA_generate_key(int bits, unsigned long e_value,
     BN_GENCB_free(cb);
     return 0;
 }
-#endif
</PRE>





<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="028290.html">[openssl]  master update
</A></li>
	<LI>Next message: <A HREF="028296.html">[openssl]  master update
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#28294">[ date ]</a>
              <a href="thread.html#28294">[ thread ]</a>
              <a href="subject.html#28294">[ subject ]</a>
              <a href="author.html#28294">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="../../../mailman/listinfo/openssl-commits.html">More information about the openssl-commits
mailing list</a><br>
</body></html>
