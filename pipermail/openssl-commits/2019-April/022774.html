<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [openssl]  master update
   </TITLE>
   <LINK REL="Index" HREF="https://mta.openssl.org/pipermail/openssl-commits/2019-April/index.html" >
   <LINK REL="made" HREF="mailto:openssl-commits%40openssl.org?Subject=Re%3A%20%5Bopenssl%5D%20%20master%20update&In-Reply-To=%3C1554936771.251798.17346.nullmailer%40dev.openssl.org%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="022772.html">
   <LINK REL="Next"  HREF="022778.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[openssl]  master update</H1>
    <B>Dr. Paul Dale</B> 
    <A HREF="mailto:openssl-commits%40openssl.org?Subject=Re%3A%20%5Bopenssl%5D%20%20master%20update&In-Reply-To=%3C1554936771.251798.17346.nullmailer%40dev.openssl.org%3E"
       TITLE="[openssl]  master update">pauli at openssl.org
       </A><BR>
    <I>Wed Apr 10 22:52:51 UTC 2019</I>
    <P><UL>
        <LI>Previous message: <A HREF="022772.html">[openssl]  master update
</A></li>
        <LI>Next message: <A HREF="022778.html">[openssl]  master update
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#22774">[ date ]</a>
              <a href="thread.html#22774">[ thread ]</a>
              <a href="subject.html#22774">[ subject ]</a>
              <a href="author.html#22774">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>The branch master has been updated
       via  6c7d80ab3b2a13074ca270a6d056c59ac431155a (commit)
      from  3a86f1db282569c538273cc48462a3fa5fcffa39 (commit)


- Log -----------------------------------------------------------------
commit 6c7d80ab3b2a13074ca270a6d056c59ac431155a
Author: Pauli &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">paul.dale at oracle.com</A>&gt;
Date:   Thu Apr 11 08:52:22 2019 +1000

    Reseeding without derivation function is not supported in FIPS mode.
    
    Reviewed-by: Matthias St. Pierre &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">Matthias.St.Pierre at ncp-e.com</A>&gt;
    (Merged from <A HREF="https://github.com/openssl/openssl/pull/8648">https://github.com/openssl/openssl/pull/8648</A>)

-----------------------------------------------------------------------

Summary of changes:
 crypto/err/openssl.txt    | 3 +++
 crypto/rand/drbg_ctr.c    | 6 ++++++
 crypto/rand/rand_err.c    | 5 ++++-
 include/openssl/randerr.h | 2 ++
 test/drbg_cavs_test.c     | 5 +++++
 test/drbgtest.c           | 9 +++++++--
 6 files changed, 27 insertions(+), 3 deletions(-)

diff --git a/crypto/err/openssl.txt b/crypto/err/openssl.txt
index a3d15c9..18aa16c 100644
--- a/crypto/err/openssl.txt
+++ b/crypto/err/openssl.txt
@@ -1103,6 +1103,7 @@ PROP_F_PARSE_OCT:105:parse_oct
 PROP_F_PARSE_STRING:106:parse_string
 PROP_F_PARSE_UNQUOTED:107:parse_unquoted
 RAND_F_DRBG_BYTES:101:drbg_bytes
+RAND_F_DRBG_CTR_INIT:125:drbg_ctr_init
 RAND_F_DRBG_GET_ENTROPY:105:drbg_get_entropy
 RAND_F_DRBG_SETUP:117:drbg_setup
 RAND_F_GET_ENTROPY:106:get_entropy
@@ -2607,6 +2608,8 @@ RAND_R_ADDITIONAL_INPUT_TOO_LONG:102:additional input too long
 RAND_R_ALREADY_INSTANTIATED:103:already instantiated
 RAND_R_ARGUMENT_OUT_OF_RANGE:105:argument out of range
 RAND_R_CANNOT_OPEN_FILE:121:Cannot open file
+RAND_R_DERIVATION_FUNCTION_MANDATORY_FOR_FIPS:137:\
+	derivation function mandatory for fips
 RAND_R_DRBG_ALREADY_INITIALIZED:129:drbg already initialized
 RAND_R_DRBG_NOT_INITIALISED:104:drbg not initialised
 RAND_R_ENTROPY_INPUT_TOO_LONG:106:entropy input too long
diff --git a/crypto/rand/drbg_ctr.c b/crypto/rand/drbg_ctr.c
index 0f99925..4c11e65 100644
--- a/crypto/rand/drbg_ctr.c
+++ b/crypto/rand/drbg_ctr.c
@@ -422,6 +422,11 @@ int drbg_ctr_init(RAND_DRBG *drbg)
         drbg-&gt;max_perslen = DRBG_MAX_LENGTH;
         drbg-&gt;max_adinlen = DRBG_MAX_LENGTH;
     } else {
+#ifdef FIPS_MODE
+        RANDerr(RAND_F_DRBG_CTR_INIT,
+                RAND_R_DERIVATION_FUNCTION_MANDATORY_FOR_FIPS);
+        return 0;
+#else
         drbg-&gt;min_entropylen = drbg-&gt;seedlen;
         drbg-&gt;max_entropylen = drbg-&gt;seedlen;
         /* Nonce not used */
@@ -429,6 +434,7 @@ int drbg_ctr_init(RAND_DRBG *drbg)
         drbg-&gt;max_noncelen = 0;
         drbg-&gt;max_perslen = drbg-&gt;seedlen;
         drbg-&gt;max_adinlen = drbg-&gt;seedlen;
+#endif
     }
 
     drbg-&gt;max_request = 1 &lt;&lt; 16;
diff --git a/crypto/rand/rand_err.c b/crypto/rand/rand_err.c
index c899613..5c0dc3d 100644
--- a/crypto/rand/rand_err.c
+++ b/crypto/rand/rand_err.c
@@ -1,6 +1,6 @@
 /*
  * Generated by util/mkerr.pl DO NOT EDIT
- * Copyright 1995-2018 The OpenSSL Project Authors. All Rights Reserved.
+ * Copyright 1995-2019 The OpenSSL Project Authors. All Rights Reserved.
  *
  * Licensed under the Apache License 2.0 (the &quot;License&quot;).  You may not use
  * this file except in compliance with the License.  You can obtain a copy
@@ -15,6 +15,7 @@
 
 static const ERR_STRING_DATA RAND_str_functs[] = {
     {ERR_PACK(ERR_LIB_RAND, RAND_F_DRBG_BYTES, 0), &quot;drbg_bytes&quot;},
+    {ERR_PACK(ERR_LIB_RAND, RAND_F_DRBG_CTR_INIT, 0), &quot;drbg_ctr_init&quot;},
     {ERR_PACK(ERR_LIB_RAND, RAND_F_DRBG_GET_ENTROPY, 0), &quot;drbg_get_entropy&quot;},
     {ERR_PACK(ERR_LIB_RAND, RAND_F_DRBG_SETUP, 0), &quot;drbg_setup&quot;},
     {ERR_PACK(ERR_LIB_RAND, RAND_F_GET_ENTROPY, 0), &quot;get_entropy&quot;},
@@ -60,6 +61,8 @@ static const ERR_STRING_DATA RAND_str_reasons[] = {
     {ERR_PACK(ERR_LIB_RAND, 0, RAND_R_ARGUMENT_OUT_OF_RANGE),
     &quot;argument out of range&quot;},
     {ERR_PACK(ERR_LIB_RAND, 0, RAND_R_CANNOT_OPEN_FILE), &quot;Cannot open file&quot;},
+    {ERR_PACK(ERR_LIB_RAND, 0, RAND_R_DERIVATION_FUNCTION_MANDATORY_FOR_FIPS),
+    &quot;derivation function mandatory for fips&quot;},
     {ERR_PACK(ERR_LIB_RAND, 0, RAND_R_DRBG_ALREADY_INITIALIZED),
     &quot;drbg already initialized&quot;},
     {ERR_PACK(ERR_LIB_RAND, 0, RAND_R_DRBG_NOT_INITIALISED),
diff --git a/include/openssl/randerr.h b/include/openssl/randerr.h
index 26c20ae..bc1c063 100644
--- a/include/openssl/randerr.h
+++ b/include/openssl/randerr.h
@@ -24,6 +24,7 @@ int ERR_load_RAND_strings(void);
  * RAND function codes.
  */
 # define RAND_F_DRBG_BYTES                                101
+# define RAND_F_DRBG_CTR_INIT                             125
 # define RAND_F_DRBG_GET_ENTROPY                          105
 # define RAND_F_DRBG_SETUP                                117
 # define RAND_F_GET_ENTROPY                               106
@@ -56,6 +57,7 @@ int ERR_load_RAND_strings(void);
 # define RAND_R_ALREADY_INSTANTIATED                      103
 # define RAND_R_ARGUMENT_OUT_OF_RANGE                     105
 # define RAND_R_CANNOT_OPEN_FILE                          121
+# define RAND_R_DERIVATION_FUNCTION_MANDATORY_FOR_FIPS    137
 # define RAND_R_DRBG_ALREADY_INITIALIZED                  129
 # define RAND_R_DRBG_NOT_INITIALISED                      104
 # define RAND_R_ENTROPY_INPUT_TOO_LONG                    106
diff --git a/test/drbg_cavs_test.c b/test/drbg_cavs_test.c
index 99d4472..8138269 100644
--- a/test/drbg_cavs_test.c
+++ b/test/drbg_cavs_test.c
@@ -254,6 +254,11 @@ static int test_cavs_kats(const struct drbg_kat *test[], int i)
     const struct drbg_kat *td = test[i];
     int rv = 0;
 
+#ifdef FIPS_MODE
+    /* FIPS mode doesn't support instantiating without a derivation function */
+    if ((td-&gt;flags &amp; USE_DF) == 0)
+        return 1;
+#endif
     switch (td-&gt;type) {
     case NO_RESEED:
         if (!single_kat_no_reseed(td))
diff --git a/test/drbgtest.c b/test/drbgtest.c
index 652b93a..ca45a8f 100644
--- a/test/drbgtest.c
+++ b/test/drbgtest.c
@@ -104,9 +104,12 @@ typedef struct drbg_selftest_data_st {
     make_drbg_test_data(nid, 0, pr, p)
 
 static DRBG_SELFTEST_DATA drbg_test[] = {
+#ifndef FIPS_MODE
+    /* FIPS mode doesn't support CTR DRBG without a derivation function */
     make_drbg_test_data_no_df (NID_aes_128_ctr, aes_128_no_df,  0),
     make_drbg_test_data_no_df (NID_aes_192_ctr, aes_192_no_df,  0),
     make_drbg_test_data_no_df (NID_aes_256_ctr, aes_256_no_df,  1),
+#endif
     make_drbg_test_data_use_df(NID_aes_128_ctr, aes_128_use_df, 0),
     make_drbg_test_data_use_df(NID_aes_192_ctr, aes_192_use_df, 0),
     make_drbg_test_data_use_df(NID_aes_256_ctr, aes_256_use_df, 1),
@@ -1107,14 +1110,16 @@ static int test_set_defaults(void)
            &amp;&amp; TEST_int_eq(public-&gt;type, NID_sha256)
            &amp;&amp; TEST_int_eq(public-&gt;flags, RAND_DRBG_FLAG_PUBLIC)
 
-           /* Change DRBG defaults and change master and check again */
+          /* FIPS mode doesn't support CTR DRBG without a derivation function */
+#ifndef FIPS_MODE
+          /* Change DRBG defaults and change master and check again */
            &amp;&amp; TEST_true(RAND_DRBG_set_defaults(NID_aes_256_ctr,
                                                RAND_DRBG_FLAG_CTR_NO_DF))
            &amp;&amp; TEST_true(RAND_DRBG_uninstantiate(master))
            &amp;&amp; TEST_int_eq(master-&gt;type, NID_aes_256_ctr)
            &amp;&amp; TEST_int_eq(master-&gt;flags,
                           RAND_DRBG_FLAG_MASTER|RAND_DRBG_FLAG_CTR_NO_DF)
-
+#endif
            /* Reset back to the standard defaults */
            &amp;&amp; TEST_true(RAND_DRBG_set_defaults(RAND_DRBG_TYPE,
                                                RAND_DRBG_FLAGS
</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="022772.html">[openssl]  master update
</A></li>
	<LI>Next message: <A HREF="022778.html">[openssl]  master update
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#22774">[ date ]</a>
              <a href="thread.html#22774">[ thread ]</a>
              <a href="subject.html#22774">[ subject ]</a>
              <a href="author.html#22774">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="../../../mailman/listinfo/openssl-commits.html">More information about the openssl-commits
mailing list</a><br>
</body></html>
