<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [openssl]  master update
   </TITLE>
   <LINK REL="Index" HREF="https://mta.openssl.org/pipermail/openssl-commits/2019-April/index.html" >
   <LINK REL="made" HREF="mailto:openssl-commits%40openssl.org?Subject=Re%3A%20%5Bopenssl%5D%20%20master%20update&In-Reply-To=%3C1555579376.804375.31204.nullmailer%40dev.openssl.org%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="022845.html">
   <LINK REL="Next"  HREF="022854.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[openssl]  master update</H1>
    <B>Richard Levitte</B> 
    <A HREF="mailto:openssl-commits%40openssl.org?Subject=Re%3A%20%5Bopenssl%5D%20%20master%20update&In-Reply-To=%3C1555579376.804375.31204.nullmailer%40dev.openssl.org%3E"
       TITLE="[openssl]  master update">levitte at openssl.org
       </A><BR>
    <I>Thu Apr 18 09:22:56 UTC 2019</I>
    <P><UL>
        <LI>Previous message: <A HREF="022845.html">[openssl]  master update
</A></li>
        <LI>Next message: <A HREF="022854.html">[openssl]  master update
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#22851">[ date ]</a>
              <a href="thread.html#22851">[ thread ]</a>
              <a href="subject.html#22851">[ subject ]</a>
              <a href="author.html#22851">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>The branch master has been updated
       via  86a7ac5e76fd3df9a5c3422153ae5a3e4f99b3a8 (commit)
       via  d6e4287c9726691e800bff221be71edd894a3c6a (commit)
       via  6465321e40cad2434501f0e8382e31a50a4f2e0b (commit)
      from  ad7e17dd6c8a3931da0fa9a06e80cf498278ef27 (commit)


- Log -----------------------------------------------------------------
commit 86a7ac5e76fd3df9a5c3422153ae5a3e4f99b3a8
Author: Andy Polyakov &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">appro at openssl.org</A>&gt;
Date:   Wed Apr 17 21:31:01 2019 +0200

    chacha/asm/chacha-armv8.pl: replace 3+1 code paths with 4+1.
    
    The change is triggered by ThunderX2 where 3+1 was slower than scalar
    code path, but it helps all processors [to handle &lt;512 inputs].
    
    Reviewed-by: Tim Hudson &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">tjh at openssl.org</A>&gt;
    Reviewed-by: Richard Levitte &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">levitte at openssl.org</A>&gt;
    (Merged from <A HREF="https://github.com/openssl/openssl/pull/8776">https://github.com/openssl/openssl/pull/8776</A>)

commit d6e4287c9726691e800bff221be71edd894a3c6a
Author: Andy Polyakov &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">appro at openssl.org</A>&gt;
Date:   Wed Apr 17 21:30:39 2019 +0200

    aes/asm/aesv8-armx.pl: ~20% improvement on ThunderX2.
    
    Reviewed-by: Tim Hudson &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">tjh at openssl.org</A>&gt;
    Reviewed-by: Richard Levitte &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">levitte at openssl.org</A>&gt;
    (Merged from <A HREF="https://github.com/openssl/openssl/pull/8776">https://github.com/openssl/openssl/pull/8776</A>)

commit 6465321e40cad2434501f0e8382e31a50a4f2e0b
Author: Andy Polyakov &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">appro at openssl.org</A>&gt;
Date:   Wed Apr 17 21:08:13 2019 +0200

    ARM64 assembly pack: add ThunderX2 results.
    
    Reviewed-by: Tim Hudson &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">tjh at openssl.org</A>&gt;
    Reviewed-by: Richard Levitte &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">levitte at openssl.org</A>&gt;
    (Merged from <A HREF="https://github.com/openssl/openssl/pull/8776">https://github.com/openssl/openssl/pull/8776</A>)

-----------------------------------------------------------------------

Summary of changes:
 crypto/aes/asm/aesv8-armx.pl          | 394 +++++++++++++++++++++++-
 crypto/aes/asm/vpaes-armv8.pl         |   1 +
 crypto/chacha/asm/chacha-armv8.pl     | 553 ++++++++++++++++++++++------------
 crypto/modes/asm/ghashv8-armx.pl      |   1 +
 crypto/poly1305/asm/poly1305-armv8.pl |   1 +
 crypto/sha/asm/keccak1600-armv8.pl    |   1 +
 crypto/sha/asm/sha1-armv8.pl          |   1 +
 crypto/sha/asm/sha512-armv8.pl        |   1 +
 8 files changed, 748 insertions(+), 205 deletions(-)

diff --git a/crypto/aes/asm/aesv8-armx.pl b/crypto/aes/asm/aesv8-armx.pl
index 81bc1cb..3b3a53b 100755
--- a/crypto/aes/asm/aesv8-armx.pl
+++ b/crypto/aes/asm/aesv8-armx.pl
@@ -27,18 +27,34 @@
 # CBC encrypt case. On Cortex-A57 parallelizable mode performance
 # seems to be limited by sheer amount of NEON instructions...
 #
+# April 2019
+#
+# Key to performance of parallelize-able modes is round instruction
+# interleaving. But which factor to use? There is optimal one for
+# each combination of instruction latency and issue rate, beyond
+# which increasing interleave factor doesn't pay off. While on cons
+# side we have code size increase and resource waste on platforms for
+# which interleave factor is too high. In other words you want it to
+# be just right. So far interleave factor of 3x was serving well all
+# platforms. But for ThunderX2 optimal interleave factor was measured
+# to be 5x...
+#
 # Performance in cycles per byte processed with 128-bit key:
 #
 #		CBC enc		CBC dec		CTR
 # Apple A7	2.39		1.20		1.20
-# Cortex-A53	1.32		1.29		1.46
-# Cortex-A57(*)	1.95		0.85		0.93
-# Denver	1.96		0.86		0.80
-# Mongoose	1.33		1.20		1.20
-# Kryo		1.26		0.94		1.00
+# Cortex-A53	1.32		1.17/1.29(**)	1.36/1.46
+# Cortex-A57(*)	1.95		0.82/0.85	0.89/0.93
+# Cortex-A72	1.33		0.85/0.88	0.92/0.96
+# Denver	1.96		0.65/0.86	0.76/0.80
+# Mongoose	1.33		1.23/1.20	1.30/1.20
+# Kryo		1.26		0.87/0.94	1.00/1.00
+# ThunderX2	5.95		1.25		1.30
 #
 # (*)	original 3.64/1.34/1.32 results were for r0p0 revision
 #	and are still same even for updated module;
+# (**)	numbers after slash are for 32-bit code, which is 3x-
+#	interleaved;
 
 $flavour = shift;
 $output  = shift;
@@ -523,6 +539,13 @@ $code.=&lt;&lt;___;
 ___
 {
 my ($dat2,$in2,$tmp2)=map(&quot;q$_&quot;,(10,11,9));
+
+my ($dat3,$in3,$tmp3);	# used only in 64-bit mode
+my ($dat4,$in4,$tmp4);
+if ($flavour =~ /64/) {
+    ($dat2,$dat3,$dat4,$in2,$in3,$in4,$tmp3,$tmp4)=map(&quot;q$_&quot;,(16..23));
+}
+
 $code.=&lt;&lt;___;
 .align	5
 .Lcbc_dec:
@@ -539,7 +562,196 @@ $code.=&lt;&lt;___;
 	vorr	$in0,$dat,$dat
 	vorr	$in1,$dat1,$dat1
 	vorr	$in2,$dat2,$dat2
+___
+$code.=&lt;&lt;___	if ($flavour =~ /64/);
+	cmp	$len,#32
+	b.lo	.Loop3x_cbc_dec
+
+	vld1.8	{$dat3},[$inp],#16
+	vld1.8	{$dat4},[$inp],#16
+	sub	$len,$len,#32		// bias
+	mov	$cnt,$rounds
+	vorr	$in3,$dat3,$dat3
+	vorr	$in4,$dat4,$dat4
+
+.Loop5x_cbc_dec:
+	aesd	$dat0,q8
+	aesimc	$dat0,$dat0
+	aesd	$dat1,q8
+	aesimc	$dat1,$dat1
+	aesd	$dat2,q8
+	aesimc	$dat2,$dat2
+	aesd	$dat3,q8
+	aesimc	$dat3,$dat3
+	aesd	$dat4,q8
+	aesimc	$dat4,$dat4
+	vld1.32	{q8},[$key_],#16
+	subs	$cnt,$cnt,#2
+	aesd	$dat0,q9
+	aesimc	$dat0,$dat0
+	aesd	$dat1,q9
+	aesimc	$dat1,$dat1
+	aesd	$dat2,q9
+	aesimc	$dat2,$dat2
+	aesd	$dat3,q9
+	aesimc	$dat3,$dat3
+	aesd	$dat4,q9
+	aesimc	$dat4,$dat4
+	vld1.32	{q9},[$key_],#16
+	b.gt	.Loop5x_cbc_dec
+
+	aesd	$dat0,q8
+	aesimc	$dat0,$dat0
+	aesd	$dat1,q8
+	aesimc	$dat1,$dat1
+	aesd	$dat2,q8
+	aesimc	$dat2,$dat2
+	aesd	$dat3,q8
+	aesimc	$dat3,$dat3
+	aesd	$dat4,q8
+	aesimc	$dat4,$dat4
+	 cmp	$len,#0x40		// because .Lcbc_tail4x
+	 sub	$len,$len,#0x50
+
+	aesd	$dat0,q9
+	aesimc	$dat0,$dat0
+	aesd	$dat1,q9
+	aesimc	$dat1,$dat1
+	aesd	$dat2,q9
+	aesimc	$dat2,$dat2
+	aesd	$dat3,q9
+	aesimc	$dat3,$dat3
+	aesd	$dat4,q9
+	aesimc	$dat4,$dat4
+	 csel	x6,xzr,$len,gt		// borrow x6, $cnt, &quot;gt&quot; is not typo
+	 mov	$key_,$key
+
+	aesd	$dat0,q10
+	aesimc	$dat0,$dat0
+	aesd	$dat1,q10
+	aesimc	$dat1,$dat1
+	aesd	$dat2,q10
+	aesimc	$dat2,$dat2
+	aesd	$dat3,q10
+	aesimc	$dat3,$dat3
+	aesd	$dat4,q10
+	aesimc	$dat4,$dat4
+	 add	$inp,$inp,x6		// $inp is adjusted in such way that
+					// at exit from the loop $dat1-$dat4
+					// are loaded with last &quot;words&quot;
+	 add	x6,$len,#0x60		// because .Lcbc_tail4x
+
+	aesd	$dat0,q11
+	aesimc	$dat0,$dat0
+	aesd	$dat1,q11
+	aesimc	$dat1,$dat1
+	aesd	$dat2,q11
+	aesimc	$dat2,$dat2
+	aesd	$dat3,q11
+	aesimc	$dat3,$dat3
+	aesd	$dat4,q11
+	aesimc	$dat4,$dat4
 
+	aesd	$dat0,q12
+	aesimc	$dat0,$dat0
+	aesd	$dat1,q12
+	aesimc	$dat1,$dat1
+	aesd	$dat2,q12
+	aesimc	$dat2,$dat2
+	aesd	$dat3,q12
+	aesimc	$dat3,$dat3
+	aesd	$dat4,q12
+	aesimc	$dat4,$dat4
+
+	aesd	$dat0,q13
+	aesimc	$dat0,$dat0
+	aesd	$dat1,q13
+	aesimc	$dat1,$dat1
+	aesd	$dat2,q13
+	aesimc	$dat2,$dat2
+	aesd	$dat3,q13
+	aesimc	$dat3,$dat3
+	aesd	$dat4,q13
+	aesimc	$dat4,$dat4
+
+	aesd	$dat0,q14
+	aesimc	$dat0,$dat0
+	aesd	$dat1,q14
+	aesimc	$dat1,$dat1
+	aesd	$dat2,q14
+	aesimc	$dat2,$dat2
+	aesd	$dat3,q14
+	aesimc	$dat3,$dat3
+	aesd	$dat4,q14
+	aesimc	$dat4,$dat4
+
+	 veor	$tmp0,$ivec,$rndlast
+	aesd	$dat0,q15
+	 veor	$tmp1,$in0,$rndlast
+	 vld1.8	{$in0},[$inp],#16
+	aesd	$dat1,q15
+	 veor	$tmp2,$in1,$rndlast
+	 vld1.8	{$in1},[$inp],#16
+	aesd	$dat2,q15
+	 veor	$tmp3,$in2,$rndlast
+	 vld1.8	{$in2},[$inp],#16
+	aesd	$dat3,q15
+	 veor	$tmp4,$in3,$rndlast
+	 vld1.8	{$in3},[$inp],#16
+	aesd	$dat4,q15
+	 vorr	$ivec,$in4,$in4
+	 vld1.8	{$in4},[$inp],#16
+	cbz	x6,.Lcbc_tail4x
+	 vld1.32 {q8},[$key_],#16	// re-pre-load rndkey[0]
+	veor	$tmp0,$tmp0,$dat0
+	 vorr	$dat0,$in0,$in0
+	veor	$tmp1,$tmp1,$dat1
+	 vorr	$dat1,$in1,$in1
+	veor	$tmp2,$tmp2,$dat2
+	 vorr	$dat2,$in2,$in2
+	veor	$tmp3,$tmp3,$dat3
+	 vorr	$dat3,$in3,$in3
+	veor	$tmp4,$tmp4,$dat4
+	vst1.8	{$tmp0},[$out],#16
+	 vorr	$dat4,$in4,$in4
+	vst1.8	{$tmp1},[$out],#16
+	 mov	$cnt,$rounds
+	vst1.8	{$tmp2},[$out],#16
+	 vld1.32 {q9},[$key_],#16	// re-pre-load rndkey[1]
+	vst1.8	{$tmp3},[$out],#16
+	vst1.8	{$tmp4},[$out],#16
+	b.hs	.Loop5x_cbc_dec
+
+	add	$len,$len,#0x50
+	cbz	$len,.Lcbc_done
+
+	add	$cnt,$rounds,#2
+	subs	$len,$len,#0x30
+	vorr	$dat0,$in2,$in2
+	vorr	$in0,$in2,$in2
+	vorr	$dat1,$in3,$in3
+	vorr	$in1,$in3,$in3
+	vorr	$dat2,$in4,$in4
+	vorr	$in2,$in4,$in4
+	b.lo	.Lcbc_dec_tail
+
+	b	.Loop3x_cbc_dec
+
+.align	4
+.Lcbc_tail4x:
+	veor	$tmp1,$tmp0,$dat1
+	veor	$tmp2,$tmp2,$dat2
+	veor	$tmp3,$tmp3,$dat3
+	veor	$tmp4,$tmp4,$dat4
+	vst1.8	{$tmp1},[$out],#16
+	vst1.8	{$tmp2},[$out],#16
+	vst1.8	{$tmp3},[$out],#16
+	vst1.8	{$tmp4},[$out],#16
+
+	b	.Lcbc_done
+.align	4
+___
+$code.=&lt;&lt;___;
 .Loop3x_cbc_dec:
 	aesd	$dat0,q8
 	aesimc	$dat0,$dat0
@@ -700,6 +912,9 @@ my $step=&quot;x12&quot;;		# aliases with $tctr2
 my ($dat0,$dat1,$in0,$in1,$tmp0,$tmp1,$ivec,$rndlast)=map(&quot;q$_&quot;,(0..7));
 my ($dat2,$in2,$tmp2)=map(&quot;q$_&quot;,(10,11,9));
 
+# used only in 64-bit mode...
+my ($dat3,$dat4,$in3,$in4)=map(&quot;q$_&quot;,(16..23));
+
 my ($dat,$tmp)=($dat0,$tmp0);
 
 ### q8-q15	preloaded key schedule
@@ -752,6 +967,175 @@ $code.=&lt;&lt;___;
 	rev		$tctr2, $ctr
 	sub		$len,$len,#3		// bias
 	vmov.32		${dat2}[3],$tctr2
+___
+$code.=&lt;&lt;___	if ($flavour =~ /64/);
+	cmp		$len,#2
+	b.lo		.Loop3x_ctr32
+
+	add		w13,$ctr,#1
+	add		w14,$ctr,#2
+	vorr		$dat3,$dat0,$dat0
+	rev		w13,w13
+	vorr		$dat4,$dat0,$dat0
+	rev		w14,w14
+	vmov.32		${dat3}[3],w13
+	sub		$len,$len,#2		// bias
+	vmov.32		${dat4}[3],w14
+	add		$ctr,$ctr,#2
+	b		.Loop5x_ctr32
+
+.align	4
+.Loop5x_ctr32:
+	aese		$dat0,q8
+	aesmc		$dat0,$dat0
+	aese		$dat1,q8
+	aesmc		$dat1,$dat1
+	aese		$dat2,q8
+	aesmc		$dat2,$dat2
+	aese		$dat3,q8
+	aesmc		$dat3,$dat3
+	aese		$dat4,q8
+	aesmc		$dat4,$dat4
+	vld1.32		{q8},[$key_],#16
+	subs		$cnt,$cnt,#2
+	aese		$dat0,q9
+	aesmc		$dat0,$dat0
+	aese		$dat1,q9
+	aesmc		$dat1,$dat1
+	aese		$dat2,q9
+	aesmc		$dat2,$dat2
+	aese		$dat3,q9
+	aesmc		$dat3,$dat3
+	aese		$dat4,q9
+	aesmc		$dat4,$dat4
+	vld1.32		{q9},[$key_],#16
+	b.gt		.Loop5x_ctr32
+
+	mov		$key_,$key
+	aese		$dat0,q8
+	aesmc		$dat0,$dat0
+	aese		$dat1,q8
+	aesmc		$dat1,$dat1
+	aese		$dat2,q8
+	aesmc		$dat2,$dat2
+	aese		$dat3,q8
+	aesmc		$dat3,$dat3
+	aese		$dat4,q8
+	aesmc		$dat4,$dat4
+	vld1.32	 	{q8},[$key_],#16	// re-pre-load rndkey[0]
+
+	aese		$dat0,q9
+	aesmc		$dat0,$dat0
+	aese		$dat1,q9
+	aesmc		$dat1,$dat1
+	aese		$dat2,q9
+	aesmc		$dat2,$dat2
+	aese		$dat3,q9
+	aesmc		$dat3,$dat3
+	aese		$dat4,q9
+	aesmc		$dat4,$dat4
+	vld1.32	 	{q9},[$key_],#16	// re-pre-load rndkey[1]
+
+	aese		$dat0,q12
+	aesmc		$dat0,$dat0
+	 add		$tctr0,$ctr,#1
+	 add		$tctr1,$ctr,#2
+	aese		$dat1,q12
+	aesmc		$dat1,$dat1
+	 add		$tctr2,$ctr,#3
+	 add		w13,$ctr,#4
+	aese		$dat2,q12
+	aesmc		$dat2,$dat2
+	 add		w14,$ctr,#5
+	 rev		$tctr0,$tctr0
+	aese		$dat3,q12
+	aesmc		$dat3,$dat3
+	 rev		$tctr1,$tctr1
+	 rev		$tctr2,$tctr2
+	aese		$dat4,q12
+	aesmc		$dat4,$dat4
+	 rev		w13,w13
+	 rev		w14,w14
+
+	aese		$dat0,q13
+	aesmc		$dat0,$dat0
+	aese		$dat1,q13
+	aesmc		$dat1,$dat1
+	aese		$dat2,q13
+	aesmc		$dat2,$dat2
+	aese		$dat3,q13
+	aesmc		$dat3,$dat3
+	aese		$dat4,q13
+	aesmc		$dat4,$dat4
+
+	aese		$dat0,q14
+	aesmc		$dat0,$dat0
+	 vld1.8		{$in0},[$inp],#16
+	aese		$dat1,q14
+	aesmc		$dat1,$dat1
+	 vld1.8		{$in1},[$inp],#16
+	aese		$dat2,q14
+	aesmc		$dat2,$dat2
+	 vld1.8		{$in2},[$inp],#16
+	aese		$dat3,q14
+	aesmc		$dat3,$dat3
+	 vld1.8		{$in3},[$inp],#16
+	aese		$dat4,q14
+	aesmc		$dat4,$dat4
+	 vld1.8		{$in4},[$inp],#16
+
+	aese		$dat0,q15
+	 veor		$in0,$in0,$rndlast
+	aese		$dat1,q15
+	 veor		$in1,$in1,$rndlast
+	aese		$dat2,q15
+	 veor		$in2,$in2,$rndlast
+	aese		$dat3,q15
+	 veor		$in3,$in3,$rndlast
+	aese		$dat4,q15
+	 veor		$in4,$in4,$rndlast
+
+	veor		$in0,$in0,$dat0
+	 vorr		$dat0,$ivec,$ivec
+	veor		$in1,$in1,$dat1
+	 vorr		$dat1,$ivec,$ivec
+	veor		$in2,$in2,$dat2
+	 vorr		$dat2,$ivec,$ivec
+	veor		$in3,$in3,$dat3
+	 vorr		$dat3,$ivec,$ivec
+	veor		$in4,$in4,$dat4
+	 vorr		$dat4,$ivec,$ivec
+
+	vst1.8		{$in0},[$out],#16
+	 vmov.32	${dat0}[3],$tctr0
+	vst1.8		{$in1},[$out],#16
+	 vmov.32	${dat1}[3],$tctr1
+	vst1.8		{$in2},[$out],#16
+	 vmov.32	${dat2}[3],$tctr2
+	vst1.8		{$in3},[$out],#16
+	 vmov.32	${dat3}[3],w13
+	vst1.8		{$in4},[$out],#16
+	 vmov.32	${dat4}[3],w14
+
+	mov		$cnt,$rounds
+	cbz		$len,.Lctr32_done
+
+	add		$ctr,$ctr,#5
+	subs		$len,$len,#5
+	b.hs		.Loop5x_ctr32
+
+	add		$len,$len,#5
+	sub		$ctr,$ctr,#5
+
+	cmp		$len,#2
+	mov		$step,#16
+	cclr		$step,lo
+	b.ls		.Lctr32_tail
+
+	sub		$len,$len,#3		// bias
+	add		$ctr,$ctr,#3
+___
+$code.=&lt;&lt;___;
 	b		.Loop3x_ctr32
 
 .align	4
diff --git a/crypto/aes/asm/vpaes-armv8.pl b/crypto/aes/asm/vpaes-armv8.pl
index f08ae58..c7839b3 100755
--- a/crypto/aes/asm/vpaes-armv8.pl
+++ b/crypto/aes/asm/vpaes-armv8.pl
@@ -30,6 +30,7 @@
 # Denver(***)       16.6(**)    15.1/17.8(**)    [8.80/9.93         ]
 # Apple A7(***)     22.7(**)    10.9/14.3        [8.45/10.0         ]
 # Mongoose(***)     26.3(**)    21.0/25.0(**)    [13.3/16.8         ]
+# ThunderX2(***)    39.4(**)    33.8/48.6(**)
 #
 # (*)	ECB denotes approximate result for parallelizable modes
 #	such as CBC decrypt, CTR, etc.;
diff --git a/crypto/chacha/asm/chacha-armv8.pl b/crypto/chacha/asm/chacha-armv8.pl
index 56ba1c3..1f51017 100755
--- a/crypto/chacha/asm/chacha-armv8.pl
+++ b/crypto/chacha/asm/chacha-armv8.pl
@@ -18,22 +18,31 @@
 #
 # ChaCha20 for ARMv8.
 #
+# April 2019
+#
+# Replace 3xNEON+1xIALU code path with 4+1. 4+1 is actually fastest
+# option on most(*), but not all, processors, yet 6+2 is retained.
+# This is because penalties are considered tolerable in comparison to
+# improvement on processors where 6+2 helps. Most notably +37% on
+# ThunderX2. It's server-oriented processor which will have to serve
+# as many requests as possible. While others are mostly clients, when
+# performance doesn't have to be absolute top-notch, just fast enough,
+# as majority of time is spent &quot;entertaining&quot; relatively slow human.
+#
 # Performance in cycles per byte out of large buffer.
 #
-#			IALU/gcc-4.9    3xNEON+1xIALU	6xNEON+2xIALU
+#			IALU/gcc-4.9	4xNEON+1xIALU	6xNEON+2xIALU
 #
-# Apple A7		5.50/+49%       3.33            1.70
-# Cortex-A53		8.40/+80%       4.72		4.72(*)
-# Cortex-A57		8.06/+43%       4.90            4.43(**)
-# Denver		4.50/+82%       2.63		2.67(*)
-# X-Gene		9.50/+46%       8.82		8.89(*)
-# Mongoose		8.00/+44%	3.64		3.25
-# Kryo			8.17/+50%	4.83		4.65
+# Apple A7		5.50/+49%	2.72		1.60
+# Cortex-A53		8.40/+80%	4.06		4.45(*)
+# Cortex-A57		8.06/+43%	4.15		4.40(*)
+# Denver		4.50/+82%	2.30		2.70(*)
+# X-Gene		9.50/+46%	8.20		8.90(*)
+# Mongoose		8.00/+44%	2.74		3.12(*)
+# Kryo			8.17/+50%	4.47		4.65(*)
+# ThunderX2		7.22/+48%	5.64		4.10
 #
-# (*)	it's expected that doubling interleave factor doesn't help
-#	all processors, only those with higher NEON latency and
-#	higher instruction issue rate;
-# (**)	expected improvement was actually higher;
+# (*)	slower than 4+1:-(
 
 $flavour=shift;
 $output=shift;
@@ -120,18 +129,21 @@ my ($a3,$b3,$c3,$d3)=map(($_&amp;~3)+(($_+1)&amp;3),($a2,$b2,$c2,$d2));
 }
 
 $code.=&lt;&lt;___;
-#include &quot;arm_arch.h&quot;
+#ifndef	__KERNEL__
+# include &quot;arm_arch.h&quot;
+.extern	OPENSSL_armcap_P
+#endif
 
 .text
 
-.extern	OPENSSL_armcap_P
-
 .align	5
 .Lsigma:
 .quad	0x3320646e61707865,0x6b20657479622d32		// endian-neutral
 .Lone:
-.long	1,0,0,0
-.asciz	&quot;ChaCha20 for ARMv8, CRYPTOGAMS by &lt;appro\@openssl.org&gt;&quot;
+.long	1,2,3,4
+.Lrot24:
+.long	0x02010003,0x06050407,0x0a09080b,0x0e0d0c0f
+.asciz	&quot;ChaCha20 for ARMv8, CRYPTOGAMS by \@dot-asm&quot;
 
 .globl	ChaCha20_ctr32
 .type	ChaCha20_ctr32,%function
@@ -141,10 +153,12 @@ ChaCha20_ctr32:
 	cmp	$len,#192
 	b.lo	.Lshort
 
+#ifndef	__KERNEL__
 	adrp	x17,OPENSSL_armcap_P
 	ldr	w17,[x17,#:lo12:OPENSSL_armcap_P]
 	tst	w17,#ARMV7_NEON
 	b.ne	.LChaCha20_neon
+#endif
 
 .Lshort:
 	.inst	0xd503233f			// paciasp
@@ -163,7 +177,7 @@ ChaCha20_ctr32:
 	ldp	@d[2]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at d</A>[3],[$key]		// load key
 	ldp	@d[4]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at d</A>[5],[$key,#16]
 	ldp	@d[6]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at d</A>[7],[$ctr]		// load counter
-#ifdef	__ARMEB__
+#ifdef	__AARCH64EB__
 	ror	@d[2]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at d</A>[2],#32
 	ror	@d[3]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at d</A>[3],#32
 	ror	@d[4]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at d</A>[4],#32
@@ -232,7 +246,7 @@ $code.=&lt;&lt;___;
 	add	@x[14]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[14]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[15],lsl#32
 	ldp	@x[13]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[15],[$inp,#48]
 	add	$inp,$inp,#64
-#ifdef	__ARMEB__
+#ifdef	__AARCH64EB__
 	rev	@x[0]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[0]
 	rev	@x[2]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[2]
 	rev	@x[4]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[4]
@@ -289,7 +303,7 @@ $code.=&lt;&lt;___;
 	add	@x[10]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[10]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[11],lsl#32
 	add	@x[12]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[12]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[13],lsl#32
 	add	@x[14]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[14]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[15],lsl#32
-#ifdef	__ARMEB__
+#ifdef	__AARCH64EB__
 	rev	@x[0]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[0]
 	rev	@x[2]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[2]
 	rev	@x[4]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[4]
@@ -330,43 +344,87 @@ $code.=&lt;&lt;___;
 ___
 
 {{{
-my ($A0,$B0,$C0,$D0,$A1,$B1,$C1,$D1,$A2,$B2,$C2,$D2,$T0,$T1,$T2,$T3) =
-    map(&quot;v$_.4s&quot;,(0..7,16..23));
-my (@K)=map(&quot;v$_.4s&quot;,(24..30));
-my $ONE=&quot;v31.4s&quot;;
+my @K = map(&quot;v$_.4s&quot;,(0..3));
+my ($xt0,$xt1,$xt2,$xt3, $CTR,$ROT24) = map(&quot;v$_.4s&quot;,(4..9));
+my @X = map(&quot;v$_.4s&quot;,(16,20,24,28, 17,21,25,29, 18,22,26,30, 19,23,27,31));
+my ($xa0,$xa1,$xa2,$xa3, $xb0,$xb1,$xb2,$xb3,
+    $xc0,$xc1,$xc2,$xc3, $xd0,$xd1,$xd2,$xd3) = @X;
 
-sub NEONROUND {
-my $odd = pop;
-my ($a,$b,$c,$d,$t)=@_;
+sub NEON_lane_ROUND {
+my ($a0,$b0,$c0,$d0)=@_;
+my ($a1,$b1,$c1,$d1)=map(($_&amp;~3)+(($_+1)&amp;3),($a0,$b0,$c0,$d0));
+my ($a2,$b2,$c2,$d2)=map(($_&amp;~3)+(($_+1)&amp;3),($a1,$b1,$c1,$d1));
+my ($a3,$b3,$c3,$d3)=map(($_&amp;~3)+(($_+1)&amp;3),($a2,$b2,$c2,$d2));
+my @x=map(&quot;'$_'&quot;<A HREF="../../../mailman/listinfo/openssl-commits.html">, at X</A>);
 
 	(
-	&quot;&amp;add		('$a','$a','$b')&quot;,
-	&quot;&amp;eor		('$d','$d','$a')&quot;,
-	&quot;&amp;rev32_16	('$d','$d')&quot;,		# vrot ($d,16)
-
-	&quot;&amp;add		('$c','$c','$d')&quot;,
-	&quot;&amp;eor		('$t','$b','$c')&quot;,
-	&quot;&amp;ushr		('$b','$t',20)&quot;,
-	&quot;&amp;sli		('$b','$t',12)&quot;,
-
-	&quot;&amp;add		('$a','$a','$b')&quot;,
-	&quot;&amp;eor		('$t','$d','$a')&quot;,
-	&quot;&amp;ushr		('$d','$t',24)&quot;,
-	&quot;&amp;sli		('$d','$t',8)&quot;,
-
-	&quot;&amp;add		('$c','$c','$d')&quot;,
-	&quot;&amp;eor		('$t','$b','$c')&quot;,
-	&quot;&amp;ushr		('$b','$t',25)&quot;,
-	&quot;&amp;sli		('$b','$t',7)&quot;,
-
-	&quot;&amp;ext		('$c','$c','$c',8)&quot;,
-	&quot;&amp;ext		('$d','$d','$d',$odd?4:12)&quot;,
-	&quot;&amp;ext		('$b','$b','$b',$odd?12:4)&quot;
+	&quot;&amp;add		(@x[$a0]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$a0]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$b0])&quot;,	# Q1
+	 &quot;&amp;add		(@x[$a1]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$a1]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$b1])&quot;,	# Q2
+	  &quot;&amp;add		(@x[$a2]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$a2]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$b2])&quot;,	# Q3
+	   &quot;&amp;add	(@x[$a3]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$a3]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$b3])&quot;,	# Q4
+	&quot;&amp;eor		(@x[$d0]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$d0]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$a0])&quot;,
+	 &quot;&amp;eor		(@x[$d1]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$d1]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$a1])&quot;,
+	  &quot;&amp;eor		(@x[$d2]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$d2]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$a2])&quot;,
+	   &quot;&amp;eor	(@x[$d3]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$d3]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$a3])&quot;,
+	&quot;&amp;rev32_16	(@x[$d0]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$d0])&quot;,
+	 &quot;&amp;rev32_16	(@x[$d1]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$d1])&quot;,
+	  &quot;&amp;rev32_16	(@x[$d2]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$d2])&quot;,
+	   &quot;&amp;rev32_16	(@x[$d3]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$d3])&quot;,
+
+	&quot;&amp;add		(@x[$c0]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$c0]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$d0])&quot;,
+	 &quot;&amp;add		(@x[$c1]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$c1]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$d1])&quot;,
+	  &quot;&amp;add		(@x[$c2]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$c2]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$d2])&quot;,
+	   &quot;&amp;add	(@x[$c3]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$c3]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$d3])&quot;,
+	&quot;&amp;eor		('$xt0'<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$b0]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$c0])&quot;,
+	 &quot;&amp;eor		('$xt1'<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$b1]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$c1])&quot;,
+	  &quot;&amp;eor		('$xt2'<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$b2]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$c2])&quot;,
+	   &quot;&amp;eor	('$xt3'<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$b3]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$c3])&quot;,
+	&quot;&amp;ushr		(@x[$b0],'$xt0',20)&quot;,
+	 &quot;&amp;ushr		(@x[$b1],'$xt1',20)&quot;,
+	  &quot;&amp;ushr	(@x[$b2],'$xt2',20)&quot;,
+	   &quot;&amp;ushr	(@x[$b3],'$xt3',20)&quot;,
+	&quot;&amp;sli		(@x[$b0],'$xt0',12)&quot;,
+	 &quot;&amp;sli		(@x[$b1],'$xt1',12)&quot;,
+	  &quot;&amp;sli		(@x[$b2],'$xt2',12)&quot;,
+	   &quot;&amp;sli	(@x[$b3],'$xt3',12)&quot;,
+
+	&quot;&amp;add		(@x[$a0]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$a0]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$b0])&quot;,
+	 &quot;&amp;add		(@x[$a1]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$a1]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$b1])&quot;,
+	  &quot;&amp;add		(@x[$a2]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$a2]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$b2])&quot;,
+	   &quot;&amp;add	(@x[$a3]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$a3]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$b3])&quot;,
+	&quot;&amp;eor		('$xt0'<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$d0]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$a0])&quot;,
+	 &quot;&amp;eor		('$xt1'<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$d1]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$a1])&quot;,
+	  &quot;&amp;eor		('$xt2'<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$d2]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$a2])&quot;,
+	   &quot;&amp;eor	('$xt3'<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$d3]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$a3])&quot;,
+	&quot;&amp;tbl		(@x[$d0],'{$xt0}','$ROT24')&quot;,
+	 &quot;&amp;tbl		(@x[$d1],'{$xt1}','$ROT24')&quot;,
+	  &quot;&amp;tbl		(@x[$d2],'{$xt2}','$ROT24')&quot;,
+	   &quot;&amp;tbl	(@x[$d3],'{$xt3}','$ROT24')&quot;,
+
+	&quot;&amp;add		(@x[$c0]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$c0]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$d0])&quot;,
+	 &quot;&amp;add		(@x[$c1]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$c1]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$d1])&quot;,
+	  &quot;&amp;add		(@x[$c2]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$c2]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$d2])&quot;,
+	   &quot;&amp;add	(@x[$c3]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$c3]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$d3])&quot;,
+	&quot;&amp;eor		('$xt0'<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$b0]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$c0])&quot;,
+	 &quot;&amp;eor		('$xt1'<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$b1]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$c1])&quot;,
+	  &quot;&amp;eor		('$xt2'<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$b2]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$c2])&quot;,
+	   &quot;&amp;eor	('$xt3'<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$b3]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$c3])&quot;,
+	&quot;&amp;ushr		(@x[$b0],'$xt0',25)&quot;,
+	 &quot;&amp;ushr		(@x[$b1],'$xt1',25)&quot;,
+	  &quot;&amp;ushr	(@x[$b2],'$xt2',25)&quot;,
+	   &quot;&amp;ushr	(@x[$b3],'$xt3',25)&quot;,
+	&quot;&amp;sli		(@x[$b0],'$xt0',7)&quot;,
+	 &quot;&amp;sli		(@x[$b1],'$xt1',7)&quot;,
+	  &quot;&amp;sli		(@x[$b2],'$xt2',7)&quot;,
+	   &quot;&amp;sli	(@x[$b3],'$xt3',7)&quot;
 	);
 }
 
 $code.=&lt;&lt;___;
 
+#ifdef	__KERNEL__
+.globl	ChaCha20_neon
+#endif
 .type	ChaCha20_neon,%function
 .align	5
 ChaCha20_neon:
@@ -393,8 +451,9 @@ ChaCha20_neon:
 	ld1	{@K[1]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at K</A>[2]},[$key]
 	ldp	@d[6]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at d</A>[7],[$ctr]		// load counter
 	ld1	{@K[3]},[$ctr]
-	ld1	{$ONE},[@x[0]]
-#ifdef	__ARMEB__
+	stp	d8,d9,[sp]			// meet ABI requirements
+	ld1	{$CTR,$ROT24},[@x[0]]
+#ifdef	__AARCH64EB__
 	rev64	@K[0]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at K</A>[0]
 	ror	@d[2]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at d</A>[2],#32
 	ror	@d[3]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at d</A>[3],#32
@@ -403,115 +462,129 @@ ChaCha20_neon:
 	ror	@d[6]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at d</A>[6],#32
 	ror	@d[7]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at d</A>[7],#32
 #endif
-	add	@K[3]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at K</A>[3],$ONE		// += 1
-	add	@K[4]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at K</A>[3],$ONE
-	add	@K[5]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at K</A>[4],$ONE
-	shl	$ONE,$ONE,#2			// 1 -&gt; 4
 
 .Loop_outer_neon:
-	mov.32	@x[0]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at d</A>[0]			// unpack key block
-	lsr	@x[1]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at d</A>[0],#32
-	 mov	$<A HREF="../../../mailman/listinfo/openssl-commits.html">A0, at K</A>[0]
-	mov.32	@x[2]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at d</A>[1]
-	lsr	@x[3]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at d</A>[1],#32
-	 mov	$<A HREF="../../../mailman/listinfo/openssl-commits.html">A1, at K</A>[0]
-	mov.32	@x[4]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at d</A>[2]
-	lsr	@x[5]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at d</A>[2],#32
-	 mov	$<A HREF="../../../mailman/listinfo/openssl-commits.html">A2, at K</A>[0]
-	mov.32	@x[6]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at d</A>[3]
-	 mov	$<A HREF="../../../mailman/listinfo/openssl-commits.html">B0, at K</A>[1]
-	lsr	@x[7]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at d</A>[3],#32
-	 mov	$<A HREF="../../../mailman/listinfo/openssl-commits.html">B1, at K</A>[1]
-	mov.32	@x[8]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at d</A>[4]
-	 mov	$<A HREF="../../../mailman/listinfo/openssl-commits.html">B2, at K</A>[1]
-	lsr	@x[9]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at d</A>[4],#32
-	 mov	$<A HREF="../../../mailman/listinfo/openssl-commits.html">D0, at K</A>[3]
-	mov.32	@x[10]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at d</A>[5]
-	 mov	$<A HREF="../../../mailman/listinfo/openssl-commits.html">D1, at K</A>[4]
-	lsr	@x[11]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at d</A>[5],#32
-	 mov	$<A HREF="../../../mailman/listinfo/openssl-commits.html">D2, at K</A>[5]
-	mov.32	@x[12]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at d</A>[6]
-	 mov	$<A HREF="../../../mailman/listinfo/openssl-commits.html">C0, at K</A>[2]
-	lsr	@x[13]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at d</A>[6],#32
-	 mov	$<A HREF="../../../mailman/listinfo/openssl-commits.html">C1, at K</A>[2]
-	mov.32	@x[14]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at d</A>[7]
-	 mov	$<A HREF="../../../mailman/listinfo/openssl-commits.html">C2, at K</A>[2]
-	lsr	@x[15]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at d</A>[7],#32
+	dup	$xa0,@{K[0]}[0]			// unpack key block
+	 mov.32	@x[0]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at d</A>[0]
+	dup	$xa1,@{K[0]}[1]
+	 lsr	@x[1]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at d</A>[0],#32
+	dup	$xa2,@{K[0]}[2]
+	 mov.32	@x[2]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at d</A>[1]
+	dup	$xa3,@{K[0]}[3]
+	 lsr	@x[3]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at d</A>[1],#32
+	dup	$xb0,@{K[1]}[0]
+	 mov.32	@x[4]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at d</A>[2]
+	dup	$xb1,@{K[1]}[1]
+	 lsr	@x[5]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at d</A>[2],#32
+	dup	$xb2,@{K[1]}[2]
+	 mov.32	@x[6]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at d</A>[3]
+	dup	$xb3,@{K[1]}[3]
+	 lsr	@x[7]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at d</A>[3],#32
+	dup	$xd0,@{K[3]}[0]
+	 mov.32	@x[8]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at d</A>[4]
+	dup	$xd1,@{K[3]}[1]
+	 lsr	@x[9]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at d</A>[4],#32
+	dup	$xd2,@{K[3]}[2]
+	 mov.32	@x[10]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at d</A>[5]
+	dup	$xd3,@{K[3]}[3]
+	 lsr	@x[11]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at d</A>[5],#32
+	add	$xd0,$xd0,$CTR
+	 mov.32	@x[12]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at d</A>[6]
+	dup	$xc0,@{K[2]}[0]
+	 lsr	@x[13]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at d</A>[6],#32
+	dup	$xc1,@{K[2]}[1]
+	 mov.32	@x[14]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at d</A>[7]
+	dup	$xc2,@{K[2]}[2]
+	 lsr	@x[15]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at d</A>[7],#32
+	dup	$xc3,@{K[2]}[3]
 
 	mov	$ctr,#10
-	subs	$len,$len,#256
+	subs	$len,$len,#320
 .Loop_neon:
 	sub	$ctr,$ctr,#1
 ___
-	my @thread0=&amp;NEONROUND($A0,$B0,$C0,$D0,$T0,0);
-	my @thread1=&amp;NEONROUND($A1,$B1,$C1,$D1,$T1,0);
-	my @thread2=&amp;NEONROUND($A2,$B2,$C2,$D2,$T2,0);
-	my @thread3=&amp;ROUND(0,4,8,12);
-
-	foreach (@thread0) {
-		eval;			eval(shift(@thread3));
-		eval(shift(@thread1));	eval(shift(@thread3));
-		eval(shift(@thread2));	eval(shift(@thread3));
-	}
+	my @plus_one=&amp;ROUND(0,4,8,12);
+	foreach (&amp;NEON_lane_ROUND(0,4,8,12))  { eval; eval(shift(@plus_one)); }
 
-	@thread0=&amp;NEONROUND($A0,$B0,$C0,$D0,$T0,1);
-	@thread1=&amp;NEONROUND($A1,$B1,$C1,$D1,$T1,1);
-	@thread2=&amp;NEONROUND($A2,$B2,$C2,$D2,$T2,1);
-	@thread3=&amp;ROUND(0,5,10,15);
-
-	foreach (@thread0) {
-		eval;			eval(shift(@thread3));
-		eval(shift(@thread1));	eval(shift(@thread3));
-		eval(shift(@thread2));	eval(shift(@thread3));
-	}
+	@plus_one=&amp;ROUND(0,5,10,15);
+	foreach (&amp;NEON_lane_ROUND(0,5,10,15)) { eval; eval(shift(@plus_one)); }
 $code.=&lt;&lt;___;
 	cbnz	$ctr,.Loop_neon
 
-	add.32	@x[0]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[0]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at d</A>[0]		// accumulate key block
-	 add	$A0,$<A HREF="../../../mailman/listinfo/openssl-commits.html">A0, at K</A>[0]
-	add	@x[1]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[1]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at d</A>[0],lsr#32
-	 add	$A1,$<A HREF="../../../mailman/listinfo/openssl-commits.html">A1, at K</A>[0]
-	add.32	@x[2]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[2]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at d</A>[1]
-	 add	$A2,$<A HREF="../../../mailman/listinfo/openssl-commits.html">A2, at K</A>[0]
-	add	@x[3]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[3]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at d</A>[1],lsr#32
-	 add	$C0,$<A HREF="../../../mailman/listinfo/openssl-commits.html">C0, at K</A>[2]
-	add.32	@x[4]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[4]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at d</A>[2]
-	 add	$C1,$<A HREF="../../../mailman/listinfo/openssl-commits.html">C1, at K</A>[2]
-	add	@x[5]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[5]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at d</A>[2],lsr#32
-	 add	$C2,$<A HREF="../../../mailman/listinfo/openssl-commits.html">C2, at K</A>[2]
-	add.32	@x[6]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[6]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at d</A>[3]
-	 add	$D0,$<A HREF="../../../mailman/listinfo/openssl-commits.html">D0, at K</A>[3]
-	add	@x[7]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[7]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at d</A>[3],lsr#32
-	add.32	@x[8]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[8]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at d</A>[4]
-	 add	$D1,$<A HREF="../../../mailman/listinfo/openssl-commits.html">D1, at K</A>[4]
-	add	@x[9]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[9]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at d</A>[4],lsr#32
-	add.32	@x[10]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[10]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at d</A>[5]
-	 add	$D2,$<A HREF="../../../mailman/listinfo/openssl-commits.html">D2, at K</A>[5]
-	add	@x[11]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[11]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at d</A>[5],lsr#32
-	add.32	@x[12]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[12]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at d</A>[6]
-	 add	$B0,$<A HREF="../../../mailman/listinfo/openssl-commits.html">B0, at K</A>[1]
-	add	@x[13]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[13]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at d</A>[6],lsr#32
-	add.32	@x[14]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[14]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at d</A>[7]
-	 add	$B1,$<A HREF="../../../mailman/listinfo/openssl-commits.html">B1, at K</A>[1]
-	add	@x[15]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[15]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at d</A>[7],lsr#32
-	 add	$B2,$<A HREF="../../../mailman/listinfo/openssl-commits.html">B2, at K</A>[1]
+	add	$xd0,$xd0,$CTR
+
+	zip1	$xt0,$xa0,$xa1			// transpose data
+	zip1	$xt1,$xa2,$xa3
+	zip2	$xt2,$xa0,$xa1
+	zip2	$xt3,$xa2,$xa3
+	zip1.64	$xa0,$xt0,$xt1
+	zip2.64	$xa1,$xt0,$xt1
+	zip1.64	$xa2,$xt2,$xt3
+	zip2.64	$xa3,$xt2,$xt3
+
+	zip1	$xt0,$xb0,$xb1
+	zip1	$xt1,$xb2,$xb3
+	zip2	$xt2,$xb0,$xb1
+	zip2	$xt3,$xb2,$xb3
+	zip1.64	$xb0,$xt0,$xt1
+	zip2.64	$xb1,$xt0,$xt1
+	zip1.64	$xb2,$xt2,$xt3
+	zip2.64	$xb3,$xt2,$xt3
+
+	zip1	$xt0,$xc0,$xc1
+	 add.32	@x[0]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[0]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at d</A>[0]		// accumulate key block
+	zip1	$xt1,$xc2,$xc3
+	 add	@x[1]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[1]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at d</A>[0],lsr#32
+	zip2	$xt2,$xc0,$xc1
+	 add.32	@x[2]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[2]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at d</A>[1]
+	zip2	$xt3,$xc2,$xc3
+	 add	@x[3]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[3]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at d</A>[1],lsr#32
+	zip1.64	$xc0,$xt0,$xt1
+	 add.32	@x[4]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[4]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at d</A>[2]
+	zip2.64	$xc1,$xt0,$xt1
+	 add	@x[5]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[5]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at d</A>[2],lsr#32
+	zip1.64	$xc2,$xt2,$xt3
+	 add.32	@x[6]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[6]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at d</A>[3]
+	zip2.64	$xc3,$xt2,$xt3
+	 add	@x[7]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[7]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at d</A>[3],lsr#32
+
+	zip1	$xt0,$xd0,$xd1
+	 add.32	@x[8]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[8]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at d</A>[4]
+	zip1	$xt1,$xd2,$xd3
+	 add	@x[9]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[9]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at d</A>[4],lsr#32
+	zip2	$xt2,$xd0,$xd1
+	 add.32	@x[10]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[10]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at d</A>[5]
+	zip2	$xt3,$xd2,$xd3
+	 add	@x[11]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[11]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at d</A>[5],lsr#32
+	zip1.64	$xd0,$xt0,$xt1
+	 add.32	@x[12]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[12]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at d</A>[6]
+	zip2.64	$xd1,$xt0,$xt1
+	 add	@x[13]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[13]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at d</A>[6],lsr#32
+	zip1.64	$xd2,$xt2,$xt3
+	 add.32	@x[14]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[14]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at d</A>[7]
+	zip2.64	$xd3,$xt2,$xt3
+	 add	@x[15]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[15]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at d</A>[7],lsr#32
 
 	b.lo	.Ltail_neon
 
 	add	@x[0]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[0]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[1],lsl#32	// pack
 	add	@x[2]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[2]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[3],lsl#32
 	ldp	@x[1]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[3],[$inp,#0]		// load input
+	 add	$xa0,$<A HREF="../../../mailman/listinfo/openssl-commits.html">xa0, at K</A>[0]			// accumulate key block
 	add	@x[4]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[4]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[5],lsl#32
 	add	@x[6]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[6]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[7],lsl#32
 	ldp	@x[5]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[7],[$inp,#16]
+	 add	$xb0,$<A HREF="../../../mailman/listinfo/openssl-commits.html">xb0, at K</A>[1]
 	add	@x[8]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[8]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[9],lsl#32
 	add	@x[10]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[10]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[11],lsl#32
 	ldp	@x[9]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[11],[$inp,#32]
+	 add	$xc0,$<A HREF="../../../mailman/listinfo/openssl-commits.html">xc0, at K</A>[2]
 	add	@x[12]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[12]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[13],lsl#32
 	add	@x[14]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[14]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[15],lsl#32
 	ldp	@x[13]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[15],[$inp,#48]
+	 add	$xd0,$<A HREF="../../../mailman/listinfo/openssl-commits.html">xd0, at K</A>[3]
 	add	$inp,$inp,#64
-#ifdef	__ARMEB__
+#ifdef	__AARCH64EB__
 	rev	@x[0]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[0]
 	rev	@x[2]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[2]
 	rev	@x[4]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[4]
@@ -521,48 +594,68 @@ $code.=&lt;&lt;___;
 	rev	@x[12]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[12]
 	rev	@x[14]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[14]
 #endif
-	ld1.8	{$T0-$T3},[$inp],#64
+	ld1.8	{$xt0-$xt3},[$inp],#64
 	eor	@x[0]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[0]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[1]
+	 add	$xa1,$<A HREF="../../../mailman/listinfo/openssl-commits.html">xa1, at K</A>[0]
 	eor	@x[2]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[2]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[3]
+	 add	$xb1,$<A HREF="../../../mailman/listinfo/openssl-commits.html">xb1, at K</A>[1]
 	eor	@x[4]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[4]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[5]
+	 add	$xc1,$<A HREF="../../../mailman/listinfo/openssl-commits.html">xc1, at K</A>[2]
 	eor	@x[6]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[6]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[7]
+	 add	$xd1,$<A HREF="../../../mailman/listinfo/openssl-commits.html">xd1, at K</A>[3]
 	eor	@x[8]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[8]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[9]
-	 eor	$A0,$A0,$T0
+	 eor	$xa0,$xa0,$xt0
+	 movi	$xt0,#5
 	eor	@x[10]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[10]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[11]
-	 eor	$B0,$B0,$T1
+	 eor	$xb0,$xb0,$xt1
 	eor	@x[12]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[12]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[13]
-	 eor	$C0,$C0,$T2
+	 eor	$xc0,$xc0,$xt2
 	eor	@x[14]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[14]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[15]
-	 eor	$D0,$D0,$T3
-	 ld1.8	{$T0-$T3},[$inp],#64
+	 eor	$xd0,$xd0,$xt3
+	 add	$CTR,$CTR,$xt0			// += 5
+	 ld1.8	{$xt0-$xt3},[$inp],#64
 
 	stp	@x[0]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[2],[$out,#0]		// store output
-	 add	@d[6]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at d</A>[6],#4			// increment counter
+	 add	@d[6]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at d</A>[6],#5			// increment counter
 	stp	@x[4]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[6],[$out,#16]
-	 add	@K[3]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at K</A>[3],$ONE		// += 4
 	stp	@x[8]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[10],[$out,#32]
-	 add	@K[4]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at K</A>[4],$ONE
 	stp	@x[12]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[14],[$out,#48]
-	 add	@K[5]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at K</A>[5],$ONE
 	add	$out,$out,#64
 
-	st1.8	{$A0-$D0},[$out],#64
-	ld1.8	{$A0-$D0},[$inp],#64
-
-	eor	$A1,$A1,$T0
-	eor	$B1,$B1,$T1
-	eor	$C1,$C1,$T2
-	eor	$D1,$D1,$T3
-	st1.8	{$A1-$D1},[$out],#64
-
-	eor	$A2,$A2,$A0
-	eor	$B2,$B2,$B0
-	eor	$C2,$C2,$C0
-	eor	$D2,$D2,$D0
-	st1.8	{$A2-$D2},[$out],#64
+	st1.8	{$xa0-$xd0},[$out],#64
+	 add	$xa2,$<A HREF="../../../mailman/listinfo/openssl-commits.html">xa2, at K</A>[0]
+	 add	$xb2,$<A HREF="../../../mailman/listinfo/openssl-commits.html">xb2, at K</A>[1]
+	 add	$xc2,$<A HREF="../../../mailman/listinfo/openssl-commits.html">xc2, at K</A>[2]
+	 add	$xd2,$<A HREF="../../../mailman/listinfo/openssl-commits.html">xd2, at K</A>[3]
+	ld1.8	{$xa0-$xd0},[$inp],#64
+
+	eor	$xa1,$xa1,$xt0
+	eor	$xb1,$xb1,$xt1
+	eor	$xc1,$xc1,$xt2
+	eor	$xd1,$xd1,$xt3
+	st1.8	{$xa1-$xd1},[$out],#64
+	 add	$xa3,$<A HREF="../../../mailman/listinfo/openssl-commits.html">xa3, at K</A>[0]
+	 add	$xb3,$<A HREF="../../../mailman/listinfo/openssl-commits.html">xb3, at K</A>[1]
+	 add	$xc3,$<A HREF="../../../mailman/listinfo/openssl-commits.html">xc3, at K</A>[2]
+	 add	$xd3,$<A HREF="../../../mailman/listinfo/openssl-commits.html">xd3, at K</A>[3]
+	ld1.8	{$xa1-$xd1},[$inp],#64
+
+	eor	$xa2,$xa2,$xa0
+	eor	$xb2,$xb2,$xb0
+	eor	$xc2,$xc2,$xc0
+	eor	$xd2,$xd2,$xd0
+	st1.8	{$xa2-$xd2},[$out],#64
+
+	eor	$xa3,$xa3,$xa1
+	eor	$xb3,$xb3,$xb1
+	eor	$xc3,$xc3,$xc1
+	eor	$xd3,$xd3,$xd1
+	st1.8	{$xa3-$xd3},[$out],#64
 
 	b.hi	.Loop_outer_neon
 
+	ldp	d8,d9,[sp]			// meet ABI requirements
+
 	ldp	x19,x20,[x29,#16]
 	add	sp,sp,#64
 	ldp	x21,x22,[x29,#32]
@@ -573,8 +666,10 @@ $code.=&lt;&lt;___;
 	.inst	0xd50323bf			// autiasp
 	ret
 
+.align	4
 .Ltail_neon:
-	add	$len,$len,#256
+	add	$len,$len,#320
+	ldp	d8,d9,[sp]			// meet ABI requirements
 	cmp	$len,#64
 	b.lo	.Less_than_64
 
@@ -591,7 +686,7 @@ $code.=&lt;&lt;___;
 	add	@x[14]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[14]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[15],lsl#32
 	ldp	@x[13]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[15],[$inp,#48]
 	add	$inp,$inp,#64
-#ifdef	__ARMEB__
+#ifdef	__AARCH64EB__
 	rev	@x[0]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[0]
 	rev	@x[2]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[2]
 	rev	@x[4]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[4]
@@ -611,48 +706,68 @@ $code.=&lt;&lt;___;
 	eor	@x[14]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[14]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[15]
 
 	stp	@x[0]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[2],[$out,#0]		// store output
-	 add	@d[6]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at d</A>[6],#4			// increment counter
+	 add	$xa0,$<A HREF="../../../mailman/listinfo/openssl-commits.html">xa0, at K</A>[0]			// accumulate key block
 	stp	@x[4]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[6],[$out,#16]
+	 add	$xb0,$<A HREF="../../../mailman/listinfo/openssl-commits.html">xb0, at K</A>[1]
 	stp	@x[8]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[10],[$out,#32]
+	 add	$xc0,$<A HREF="../../../mailman/listinfo/openssl-commits.html">xc0, at K</A>[2]
 	stp	@x[12]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[14],[$out,#48]
+	 add	$xd0,$<A HREF="../../../mailman/listinfo/openssl-commits.html">xd0, at K</A>[3]
 	add	$out,$out,#64
 	b.eq	.Ldone_neon
 	sub	$len,$len,#64
 	cmp	$len,#64
-	b.lo	.Less_than_128
-
-	ld1.8	{$T0-$T3},[$inp],#64
-	eor	$A0,$A0,$T0
-	eor	$B0,$B0,$T1
-	eor	$C0,$C0,$T2
-	eor	$D0,$D0,$T3
-	st1.8	{$A0-$D0},[$out],#64
+	b.lo	.Last_neon
+
+	ld1.8	{$xt0-$xt3},[$inp],#64
+	eor	$xa0,$xa0,$xt0
+	eor	$xb0,$xb0,$xt1
+	eor	$xc0,$xc0,$xt2
+	eor	$xd0,$xd0,$xt3
+	st1.8	{$xa0-$xd0},[$out],#64
 	b.eq	.Ldone_neon
+
+	add	$xa0,$<A HREF="../../../mailman/listinfo/openssl-commits.html">xa1, at K</A>[0]
+	add	$xb0,$<A HREF="../../../mailman/listinfo/openssl-commits.html">xb1, at K</A>[1]
 	sub	$len,$len,#64
+	add	$xc0,$<A HREF="../../../mailman/listinfo/openssl-commits.html">xc1, at K</A>[2]
 	cmp	$len,#64
-	b.lo	.Less_than_192
-
-	ld1.8	{$T0-$T3},[$inp],#64
-	eor	$A1,$A1,$T0
-	eor	$B1,$B1,$T1
-	eor	$C1,$C1,$T2
-	eor	$D1,$D1,$T3
-	st1.8	{$A1-$D1},[$out],#64
+	add	$xd0,$<A HREF="../../../mailman/listinfo/openssl-commits.html">xd1, at K</A>[3]
+	b.lo	.Last_neon
+
+	ld1.8	{$xt0-$xt3},[$inp],#64
+	eor	$xa1,$xa0,$xt0
+	eor	$xb1,$xb0,$xt1
+	eor	$xc1,$xc0,$xt2
+	eor	$xd1,$xd0,$xt3
+	st1.8	{$xa1-$xd1},[$out],#64
 	b.eq	.Ldone_neon
-	sub	$len,$len,#64
 
-	st1.8	{$A2-$D2},[sp]
-	b	.Last_neon
+	add	$xa0,$<A HREF="../../../mailman/listinfo/openssl-commits.html">xa2, at K</A>[0]
+	add	$xb0,$<A HREF="../../../mailman/listinfo/openssl-commits.html">xb2, at K</A>[1]
+	sub	$len,$len,#64
+	add	$xc0,$<A HREF="../../../mailman/listinfo/openssl-commits.html">xc2, at K</A>[2]
+	cmp	$len,#64
+	add	$xd0,$<A HREF="../../../mailman/listinfo/openssl-commits.html">xd2, at K</A>[3]
+	b.lo	.Last_neon
+
+	ld1.8	{$xt0-$xt3},[$inp],#64
+	eor	$xa2,$xa0,$xt0
+	eor	$xb2,$xb0,$xt1
+	eor	$xc2,$xc0,$xt2
+	eor	$xd2,$xd0,$xt3
+	st1.8	{$xa2-$xd2},[$out],#64
+	b.eq	.Ldone_neon
 
-.Less_than_128:
-	st1.8	{$A0-$D0},[sp]
-	b	.Last_neon
-.Less_than_192:
-	st1.8	{$A1-$D1},[sp]
-	b	.Last_neon
+	add	$xa0,$<A HREF="../../../mailman/listinfo/openssl-commits.html">xa3, at K</A>[0]
+	add	$xb0,$<A HREF="../../../mailman/listinfo/openssl-commits.html">xb3, at K</A>[1]
+	add	$xc0,$<A HREF="../../../mailman/listinfo/openssl-commits.html">xc3, at K</A>[2]
+	add	$xd0,$<A HREF="../../../mailman/listinfo/openssl-commits.html">xd3, at K</A>[3]
+	sub	$len,$len,#64
 
-.align	4
 .Last_neon:
+	st1.8	{$xa0-$xd0},[sp]
+
 	sub	$out,$out,#1
 	add	$inp,$inp,$len
 	add	$out,$out,$len
@@ -685,9 +800,41 @@ $code.=&lt;&lt;___;
 .size	ChaCha20_neon,.-ChaCha20_neon
 ___
 {
+my @K = map(&quot;v$_.4s&quot;,(0..6));
 my ($T0,$T1,$T2,$T3,$T4,$T5)=@K;
 my ($A0,$B0,$C0,$D0,$A1,$B1,$C1,$D1,$A2,$B2,$C2,$D2,
-    $A3,$B3,$C3,$D3,$A4,$B4,$C4,$D4,$A5,$B5,$C5,$D5) = map(&quot;v$_.4s&quot;,(0..23));
+    $A3,$B3,$C3,$D3,$A4,$B4,$C4,$D4,$A5,$B5,$C5,$D5) = map(&quot;v$_.4s&quot;,(8..31));
+my $rot24 = @K[6];
+my $ONE = &quot;v7.4s&quot;;
+
+sub NEONROUND {
+my $odd = pop;
+my ($a,$b,$c,$d,$t)=@_;
+
+	(
+	&quot;&amp;add		('$a','$a','$b')&quot;,
+	&quot;&amp;eor		('$d','$d','$a')&quot;,
+	&quot;&amp;rev32_16	('$d','$d')&quot;,		# vrot ($d,16)
+
+	&quot;&amp;add		('$c','$c','$d')&quot;,
+	&quot;&amp;eor		('$t','$b','$c')&quot;,
+	&quot;&amp;ushr		('$b','$t',20)&quot;,
+	&quot;&amp;sli		('$b','$t',12)&quot;,
+
+	&quot;&amp;add		('$a','$a','$b')&quot;,
+	&quot;&amp;eor		('$d','$d','$a')&quot;,
+	&quot;&amp;tbl		('$d','{$d}','$rot24')&quot;,
+
+	&quot;&amp;add		('$c','$c','$d')&quot;,
+	&quot;&amp;eor		('$t','$b','$c')&quot;,
+	&quot;&amp;ushr		('$b','$t',25)&quot;,
+	&quot;&amp;sli		('$b','$t',7)&quot;,
+
+	&quot;&amp;ext		('$c','$c','$c',8)&quot;,
+	&quot;&amp;ext		('$d','$d','$d',$odd?4:12)&quot;,
+	&quot;&amp;ext		('$b','$b','$b',$odd?12:4)&quot;
+	);
+}
 
 $code.=&lt;&lt;___;
 .type	ChaCha20_512_neon,%function
@@ -707,6 +854,7 @@ ChaCha20_512_neon:
 .L512_or_more_neon:
 	sub	sp,sp,#128+64
 
+	eor	$ONE,$ONE,$ONE
 	ldp	@d[0]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at d</A>[1],[@x[0]]		// load sigma
 	ld1	{@K[0]},[@x[0]],#16
 	ldp	@d[2]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at d</A>[3],[$key]		// load key
@@ -714,8 +862,9 @@ ChaCha20_512_neon:
 	ld1	{@K[1]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at K</A>[2]},[$key]
 	ldp	@d[6]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at d</A>[7],[$ctr]		// load counter
 	ld1	{@K[3]},[$ctr]
-	ld1	{$ONE},[@x[0]]
-#ifdef	__ARMEB__
+	ld1	{$ONE}[0],[@x[0]]
+	add	$<A HREF="../../../mailman/listinfo/openssl-commits.html">key, at x</A>[0],#16			// .Lrot24
+#ifdef	__AARCH64EB__
 	rev64	@K[0]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at K</A>[0]
 	ror	@d[2]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at d</A>[2],#32
 	ror	@d[3]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at d</A>[3],#32
@@ -782,9 +931,10 @@ ChaCha20_512_neon:
 	 mov	$<A HREF="../../../mailman/listinfo/openssl-commits.html">C4, at K</A>[2]
 	 stp	@K[3]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at K</A>[4],[sp,#48]		// off-load key block, variable part
 	 mov	$<A HREF="../../../mailman/listinfo/openssl-commits.html">C5, at K</A>[2]
-	 str	@K[5],[sp,#80]
+	 stp	@K[5]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at K</A>[6],[sp,#80]
 
 	mov	$ctr,#5
+	ld1	{$rot24},[$key]
 	subs	$len,$len,#512
 .Loop_upper_neon:
 	sub	$ctr,$ctr,#1
@@ -857,7 +1007,7 @@ $code.=&lt;&lt;___;
 	add	@x[14]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[14]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[15],lsl#32
 	ldp	@x[13]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[15],[$inp,#48]
 	add	$inp,$inp,#64
-#ifdef	__ARMEB__
+#ifdef	__AARCH64EB__
 	rev	@x[0]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[0]
 	rev	@x[2]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[2]
 	rev	@x[4]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[4]
@@ -946,6 +1096,7 @@ $code.=&lt;&lt;___;
 	add.32	@x[2]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[2]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at d</A>[1]
 	 ldp	@K[4]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at K</A>[5],[sp,#64]
 	add	@x[3]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[3]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at d</A>[1],lsr#32
+	 ldr	@K[6],[sp,#96]
 	 add	$A0,$<A HREF="../../../mailman/listinfo/openssl-commits.html">A0, at K</A>[0]
 	add.32	@x[4]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[4]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at d</A>[2]
 	 add	$A1,$<A HREF="../../../mailman/listinfo/openssl-commits.html">A1, at K</A>[0]
@@ -998,7 +1149,7 @@ $code.=&lt;&lt;___;
 	add	$inp,$inp,#64
 	 add	$B5,$<A HREF="../../../mailman/listinfo/openssl-commits.html">B5, at K</A>[1]
 
-#ifdef	__ARMEB__
+#ifdef	__AARCH64EB__
 	rev	@x[0]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[0]
 	rev	@x[2]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[2]
 	rev	@x[4]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[4]
@@ -1076,24 +1227,24 @@ $code.=&lt;&lt;___;
 	b.hs	.Loop_outer_512_neon
 
 	adds	$len,$len,#512
-	ushr	$A0,$ONE,#2			// 4 -&gt; 1
+	ushr	$ONE,$ONE,#1			// 4 -&gt; 2
 
 	ldp	d8,d9,[sp,#128+0]		// meet ABI requirements
 	ldp	d10,d11,[sp,#128+16]
 	ldp	d12,d13,[sp,#128+32]
 	ldp	d14,d15,[sp,#128+48]
 
-	stp	@K[0],$ONE,[sp,#0]		// wipe off-load area
-	stp	@K[0],$ONE,[sp,#32]
-	stp	@K[0],$ONE,[sp,#64]
+	stp	@K[0]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at K</A>[0],[sp,#0]		// wipe off-load area
+	stp	@K[0]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at K</A>[0],[sp,#32]
+	stp	@K[0]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at K</A>[0],[sp,#64]
 
 	b.eq	.Ldone_512_neon
 
+	sub	$key,$key,#16			// .Lone
 	cmp	$len,#192
-	sub	@K[3]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at K</A>[3],$A0			// -= 1
-	sub	@K[4]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at K</A>[4],$A0
-	sub	@K[5]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at K</A>[5],$A0
 	add	sp,sp,#128
+	sub	@K[3]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at K</A>[3],$ONE		// -= 2
+	ld1	{$CTR,$ROT24},[$key]
 	b.hs	.Loop_outer_neon
 
 	eor	@K[1]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at K</A>[1]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at K</A>[1]
@@ -1123,9 +1274,11 @@ foreach (split(&quot;\n&quot;,$code)) {
 	s/\`([^\`]*)\`/eval $1/geo;
 
 	(s/\b([a-z]+)\.32\b/$1/ and (s/x([0-9]+)/w$1/g or 1))	or
-	(m/\b(eor|ext|mov)\b/ and (s/\.4s/\.16b/g or 1))	or
+	(m/\b(eor|ext|mov|tbl)\b/ and (s/\.4s/\.16b/g or 1))	or
 	(s/\b((?:ld|st)1)\.8\b/$1/ and (s/\.4s/\.16b/g or 1))	or
 	(m/\b(ld|st)[rp]\b/ and (s/v([0-9]+)\.4s/q$1/g or 1))	or
+	(m/\b(dup|ld1)\b/ and (s/\.4(s}?\[[0-3]\])/.$1/g or 1))	or
+	(s/\b(zip[12])\.64\b/$1/ and (s/\.4s/\.2d/g or 1))	or
 	(s/\brev32\.16\b/rev32/ and (s/\.4s/\.8h/g or 1));
 
 	#s/\bq([0-9]+)#(lo|hi)/sprintf &quot;d%d&quot;,2*$1+($2 eq &quot;hi&quot;)/geo;
diff --git a/crypto/modes/asm/ghashv8-armx.pl b/crypto/modes/asm/ghashv8-armx.pl
index e891583..fbc49d1 100644
--- a/crypto/modes/asm/ghashv8-armx.pl
+++ b/crypto/modes/asm/ghashv8-armx.pl
@@ -42,6 +42,7 @@
 # Denver	0.51		0.65		6.02
 # Mongoose	0.65		1.10		8.06
 # Kryo		0.76		1.16		8.00
+# ThunderX2	1.05
 #
 # (*)	presented for reference/comparison purposes;
 
diff --git a/crypto/poly1305/asm/poly1305-armv8.pl b/crypto/poly1305/asm/poly1305-armv8.pl
index b7aa7dc..b5dd61e 100755
--- a/crypto/poly1305/asm/poly1305-armv8.pl
+++ b/crypto/poly1305/asm/poly1305-armv8.pl
@@ -29,6 +29,7 @@
 # X-Gene	2.13/+68%	2.27
 # Mongoose	1.77/+75%	1.12
 # Kryo		2.70/+55%	1.13
+# ThunderX2	1.17/+95%	1.36
 #
 # (*)	estimate based on resources availability is less than 1.0,
 #	i.e. measured result is worse than expected, presumably binary
diff --git a/crypto/sha/asm/keccak1600-armv8.pl b/crypto/sha/asm/keccak1600-armv8.pl
index bd15a52..dc72f18 100755
--- a/crypto/sha/asm/keccak1600-armv8.pl
+++ b/crypto/sha/asm/keccak1600-armv8.pl
@@ -51,6 +51,7 @@
 # Kryo		12
 # Denver	7.8
 # Apple A7	7.2
+# ThunderX2	9.7
 #
 # (*)	Corresponds to SHA3-256. No improvement coefficients are listed
 #	because they vary too much from compiler to compiler. Newer
diff --git a/crypto/sha/asm/sha1-armv8.pl b/crypto/sha/asm/sha1-armv8.pl
index 7a0cbf5..12403eb 100644
--- a/crypto/sha/asm/sha1-armv8.pl
+++ b/crypto/sha/asm/sha1-armv8.pl
@@ -27,6 +27,7 @@
 # X-Gene				8.80 (+200%)
 # Mongoose	2.05			6.50 (+160%)
 # Kryo		1.88			8.00 (+90%)
+# ThunderX2	2.64			6.36 (+150%)
 #
 # (*)	Software results are presented mostly for reference purposes.
 # (**)	Keep in mind that Denver relies on binary translation, which
diff --git a/crypto/sha/asm/sha512-armv8.pl b/crypto/sha/asm/sha512-armv8.pl
index f7c6721..b9ba05b 100644
--- a/crypto/sha/asm/sha512-armv8.pl
+++ b/crypto/sha/asm/sha512-armv8.pl
@@ -28,6 +28,7 @@
 # X-Gene			20.0 (+100%)	12.8 (+300%(***))
 # Mongoose	2.36		13.0 (+50%)	8.36 (+33%)
 # Kryo		1.92		17.4 (+30%)	11.2 (+8%)
+# ThunderX2	2.54		13.2 (+40%)	8.40 (+18%)
 #
 # (*)	Software SHA256 results are of lesser relevance, presented
 #	mostly for informational purposes.
</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="022845.html">[openssl]  master update
</A></li>
	<LI>Next message: <A HREF="022854.html">[openssl]  master update
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#22851">[ date ]</a>
              <a href="thread.html#22851">[ thread ]</a>
              <a href="subject.html#22851">[ subject ]</a>
              <a href="author.html#22851">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="../../../mailman/listinfo/openssl-commits.html">More information about the openssl-commits
mailing list</a><br>
</body></html>
