<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [openssl-commits] [openssl]  master update
   </TITLE>
   <LINK REL="Index" HREF="https://mta.openssl.org/pipermail/openssl-commits/2015-December/index.html" >
   <LINK REL="made" HREF="mailto:openssl-commits%40openssl.org?Subject=Re%3A%20%5Bopenssl-commits%5D%20%5Bopenssl%5D%20%20master%20update&In-Reply-To=%3C1450300530.389461.29451.nullmailer%40dev.openssl.org%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="002482.html">
   <LINK REL="Next"  HREF="002487.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[openssl-commits] [openssl]  master update</H1>
    <B>Rich Salz</B> 
    <A HREF="mailto:openssl-commits%40openssl.org?Subject=Re%3A%20%5Bopenssl-commits%5D%20%5Bopenssl%5D%20%20master%20update&In-Reply-To=%3C1450300530.389461.29451.nullmailer%40dev.openssl.org%3E"
       TITLE="[openssl-commits] [openssl]  master update">rsalz at openssl.org
       </A><BR>
    <I>Wed Dec 16 21:15:30 UTC 2015</I>
    <P><UL>
        <LI>Previous message: <A HREF="002482.html">[openssl-commits] [openssl]  master update
</A></li>
        <LI>Next message: <A HREF="002487.html">[openssl-commits] [openssl]  master update
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2485">[ date ]</a>
              <a href="thread.html#2485">[ thread ]</a>
              <a href="subject.html#2485">[ subject ]</a>
              <a href="author.html#2485">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>The branch master has been updated
       via  7644a9aef8932ed4d1c3f25ed776c997702982be (commit)
      from  e4cf866322a4549c55153f9f135f9dadf4d3fc31 (commit)


- Log -----------------------------------------------------------------
commit 7644a9aef8932ed4d1c3f25ed776c997702982be
Author: Rich Salz &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">rsalz at akamai.com</A>&gt;
Date:   Wed Dec 16 16:12:24 2015 -0500

    Rename some BUF_xxx to OPENSSL_xxx
    
    Rename BUF_{strdup,strlcat,strlcpy,memdup,strndup,strnlen}
    to OPENSSL_{strdup,strlcat,strlcpy,memdup,strndup,strnlen}
    Add #define's for the old names.
    Add CRYPTO_{memdup,strndup}, called by OPENSSL_{memdup,strndup} macros.
    
    Reviewed-by: Tim Hudson &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">tjh at openssl.org</A>&gt;

-----------------------------------------------------------------------

Summary of changes:
 apps/apps.c                      |  10 +--
 apps/ca.c                        |  43 ++++--------
 apps/cms.c                       |   2 +-
 apps/engine.c                    |   4 +-
 apps/ocsp.c                      |   2 +-
 apps/openssl.c                   |   2 +-
 apps/passwd.c                    |   6 +-
 apps/pkcs12.c                    |   4 +-
 apps/rehash.c                    |   4 +-
 apps/req.c                       |  18 ++---
 apps/s_server.c                  |   2 +-
 apps/s_socket.c                  |   2 +-
 apps/srp.c                       |  12 ++--
 apps/x509.c                      |   6 +-
 crypto/Makefile                  |   9 ++-
 crypto/asn1/a_time.c             |   6 +-
 crypto/asn1/ameth_lib.c          |   4 +-
 crypto/asn1/asn_mime.c           |   8 +--
 crypto/bio/b_dump.c              |  14 ++--
 crypto/bio/b_sock.c              |   2 +-
 crypto/bio/bss_acpt.c            |   2 +-
 crypto/bio/bss_conn.c            |  10 +--
 crypto/bio/bss_file.c            |  10 +--
 crypto/buffer/Makefile           |  12 +---
 crypto/buffer/buf_err.c          |   3 -
 crypto/buffer/buf_str.c          | 137 ---------------------------------------
 crypto/conf/conf_def.c           |   4 +-
 crypto/conf/conf_mod.c           |  14 ++--
 crypto/cpt_err.c                 |   1 +
 crypto/dh/dh_ameth.c             |   6 +-
 crypto/dh/dh_pmeth.c             |   2 +-
 crypto/dso/dso_lib.c             |   4 +-
 crypto/ec/ec_pmeth.c             |   2 +-
 crypto/engine/eng_dyn.c          |   6 +-
 crypto/err/err.c                 |   2 +-
 crypto/evp/e_chacha20_poly1305.c |   2 +-
 crypto/evp/evp_pbe.c             |   2 +-
 crypto/lock.c                    |   2 +-
 crypto/mem.c                     |   9 ---
 crypto/mem_dbg.c                 |   2 +-
 crypto/o_str.c                   |  81 +++++++++++++++++++++++
 crypto/objects/obj_dat.c         |   6 +-
 crypto/ocsp/ocsp_lib.c           |  10 +--
 crypto/pem/pem_lib.c             |  12 ++--
 crypto/rand/Makefile             |   6 +-
 crypto/rand/rand_egd.c           |   4 +-
 crypto/rand/randfile.c           |  12 ++--
 crypto/rsa/rsa_pmeth.c           |   2 +-
 crypto/srp/srp_vfy.c             |  10 +--
 crypto/store/str_lib.c           |   4 +-
 crypto/store/str_meth.c          |   2 +-
 crypto/ui/ui_lib.c               |  30 ++++-----
 crypto/x509/x509_trs.c           |   2 +-
 crypto/x509/x509_vpm.c           |   8 +--
 crypto/x509v3/v3_addr.c          |   6 +-
 crypto/x509v3/v3_asid.c          |   2 +-
 crypto/x509v3/v3_enum.c          |   2 +-
 crypto/x509v3/v3_info.c          |   6 +-
 crypto/x509v3/v3_purp.c          |   4 +-
 crypto/x509v3/v3_utl.c           |  14 ++--
 doc/crypto/buffer.pod            |  25 -------
 engines/ccgost/gost_ctl.c        |   4 +-
 engines/e_capi.c                 |   6 +-
 engines/e_chil.c                 |   2 +-
 engines/e_ubsec.c                |   2 +-
 include/openssl/buffer.h         |  35 +++++-----
 include/openssl/crypto.h         |  22 +++++--
 ssl/packet_locl.h                |   5 +-
 ssl/s3_lib.c                     |   6 +-
 ssl/ssl_asn1.c                   |   4 +-
 ssl/ssl_cert.c                   |   2 +-
 ssl/ssl_conf.c                   |   4 +-
 ssl/ssl_lib.c                    |  12 ++--
 ssl/ssl_sess.c                   |  16 ++---
 ssl/statem/statem_clnt.c         |   8 +--
 ssl/statem/statem_srvr.c         |   4 +-
 ssl/t1_ext.c                     |   2 +-
 ssl/t1_lib.c                     |   2 +-
 ssl/tls_srp.c                    |   2 +-
 test/dummytest.c                 |   2 +-
 test/enginetest.c                |   4 +-
 test/evp_test.c                  |  14 ++--
 test/exptest.c                   |   2 +
 test/heartbeat_test.c            |   2 +-
 test/ssltest.c                   |   2 +-
 util/libeay.num                  |  18 +++--
 86 files changed, 362 insertions(+), 460 deletions(-)
 delete mode 100644 crypto/buffer/buf_str.c

diff --git a/apps/apps.c b/apps/apps.c
index c6b70d6..685536a 100644
--- a/apps/apps.c
+++ b/apps/apps.c
@@ -432,14 +432,14 @@ static char *app_get_pass(char *arg, int keepbio)
     int i;
 
     if (strncmp(arg, &quot;pass:&quot;, 5) == 0)
-        return BUF_strdup(arg + 5);
+        return OPENSSL_strdup(arg + 5);
     if (strncmp(arg, &quot;env:&quot;, 4) == 0) {
         tmp = getenv(arg + 4);
         if (!tmp) {
             BIO_printf(bio_err, &quot;Can't read environment variable %s\n&quot;, arg + 4);
             return NULL;
         }
-        return BUF_strdup(tmp);
+        return OPENSSL_strdup(tmp);
     }
     if (!keepbio || !pwdbio) {
         if (strncmp(arg, &quot;file:&quot;, 5) == 0) {
@@ -495,7 +495,7 @@ static char *app_get_pass(char *arg, int keepbio)
     tmp = strchr(tpass, '\n');
     if (tmp)
         *tmp = 0;
-    return BUF_strdup(tpass);
+    return OPENSSL_strdup(tpass);
 }
 
 static CONF *app_load_config_(BIO *in, const char *filename)
@@ -1444,7 +1444,7 @@ int save_serial(char *serialfile, char *suffix, BIGNUM *serial,
     }
 
     if (suffix == NULL)
-        BUF_strlcpy(buf[0], serialfile, BSIZE);
+        OPENSSL_strlcpy(buf[0], serialfile, BSIZE);
     else {
 #ifndef OPENSSL_SYS_VMS
         j = BIO_snprintf(buf[0], sizeof buf[0], &quot;%s.%s&quot;, serialfile, suffix);
@@ -1930,7 +1930,7 @@ int pkey_ctrl_string(EVP_PKEY_CTX *ctx, char *value)
 {
     int rv;
     char *stmp, *vtmp = NULL;
-    stmp = BUF_strdup(value);
+    stmp = OPENSSL_strdup(value);
     if (!stmp)
         return -1;
     vtmp = strchr(stmp, ':');
diff --git a/apps/ca.c b/apps/ca.c
index 6404e48..59fcea2 100644
--- a/apps/ca.c
+++ b/apps/ca.c
@@ -1067,7 +1067,7 @@ end_of_options:
             strcpy(buf[2], outdir);
 
 #ifndef OPENSSL_SYS_VMS
-            BUF_strlcat(buf[2], &quot;/&quot;, sizeof(buf[2]));
+            OPENSSL_strlcat(buf[2], &quot;/&quot;, sizeof(buf[2]));
 #endif
 
             n = (char *)&amp;(buf[2][strlen(buf[2])]);
@@ -1679,7 +1679,7 @@ static int do_body(X509 **xret, EVP_PKEY *pkey, X509 *x509,
     }
 
     if (BN_is_zero(serial))
-        row[DB_serial] = BUF_strdup(&quot;00&quot;);
+        row[DB_serial] = OPENSSL_strdup(&quot;00&quot;);
     else
         row[DB_serial] = BN_bn2hex(serial);
     if (row[DB_serial] == NULL) {
@@ -1898,17 +1898,13 @@ static int do_body(X509 **xret, EVP_PKEY *pkey, X509 *x509,
         goto end;
 
     /* We now just add it to the database */
-    row[DB_type] = app_malloc(2, &quot;row db type&quot;);
-
+    row[DB_type] = OPENSSL_strdup(&quot;V&quot;);
     tm = X509_get_notAfter(ret);
     row[DB_exp_date] = app_malloc(tm-&gt;length + 1, &quot;row expdate&quot;);
     memcpy(row[DB_exp_date], tm-&gt;data, tm-&gt;length);
     row[DB_exp_date][tm-&gt;length] = '\0';
-
     row[DB_rev_date] = NULL;
-
-    /* row[DB_serial] done already */
-    row[DB_file] = app_malloc(8, &quot;row file&quot;);
+    row[DB_file] = OPENSSL_strdup(&quot;unknown&quot;);
     row[DB_name] = X509_NAME_oneline(X509_get_subject_name(ret), NULL, 0);
 
     if ((row[DB_type] == NULL) || (row[DB_exp_date] == NULL) ||
@@ -1916,9 +1912,6 @@ static int do_body(X509 **xret, EVP_PKEY *pkey, X509 *x509,
         BIO_printf(bio_err, &quot;Memory allocation failure\n&quot;);
         goto end;
     }
-    BUF_strlcpy(row[DB_file], &quot;unknown&quot;, 8);
-    row[DB_type][0] = 'V';
-    row[DB_type][1] = '\0';
 
     irow = app_malloc(sizeof(*irow) * (DB_NUMBER + 1), &quot;row space&quot;);
     for (i = 0; i &lt; DB_NUMBER; i++) {
@@ -2118,7 +2111,7 @@ static int do_revoke(X509 *x509, CA_DB *db, int type, char *value)
     if (!bn)
         goto end;
     if (BN_is_zero(bn))
-        row[DB_serial] = BUF_strdup(&quot;00&quot;);
+        row[DB_serial] = OPENSSL_strdup(&quot;00&quot;);
     else
         row[DB_serial] = BN_bn2hex(bn);
     BN_free(bn);
@@ -2137,23 +2130,13 @@ static int do_revoke(X509 *x509, CA_DB *db, int type, char *value)
                    row[DB_serial], row[DB_name]);
 
         /* We now just add it to the database */
-        row[DB_type] = app_malloc(2, &quot;row type&quot;);
-
+        row[DB_type] = OPENSSL_strdup(&quot;V&quot;);
         tm = X509_get_notAfter(x509);
         row[DB_exp_date] = app_malloc(tm-&gt;length + 1, &quot;row exp_data&quot;);
         memcpy(row[DB_exp_date], tm-&gt;data, tm-&gt;length);
         row[DB_exp_date][tm-&gt;length] = '\0';
-
         row[DB_rev_date] = NULL;
-
-        /* row[DB_serial] done already */
-        row[DB_file] = app_malloc(8, &quot;row filename&quot;);
-
-        /* row[DB_name] done already */
-
-        BUF_strlcpy(row[DB_file], &quot;unknown&quot;, 8);
-        row[DB_type][0] = 'V';
-        row[DB_type][1] = '\0';
+        row[DB_file] = OPENSSL_strdup(&quot;unknown&quot;);
 
         irow = app_malloc(sizeof(*irow) * (DB_NUMBER + 1), &quot;row ptr&quot;);
         for (i = 0; i &lt; DB_NUMBER; i++) {
@@ -2428,14 +2411,14 @@ char *make_revocation_str(int rev_type, char *rev_arg)
         i += strlen(other) + 1;
 
     str = app_malloc(i, &quot;revocation reason&quot;);
-    BUF_strlcpy(str, (char *)revtm-&gt;data, i);
+    OPENSSL_strlcpy(str, (char *)revtm-&gt;data, i);
     if (reason) {
-        BUF_strlcat(str, &quot;,&quot;, i);
-        BUF_strlcat(str, reason, i);
+        OPENSSL_strlcat(str, &quot;,&quot;, i);
+        OPENSSL_strlcat(str, reason, i);
     }
     if (other) {
-        BUF_strlcat(str, &quot;,&quot;, i);
-        BUF_strlcat(str, other, i);
+        OPENSSL_strlcat(str, &quot;,&quot;, i);
+        OPENSSL_strlcat(str, other, i);
     }
     ASN1_UTCTIME_free(revtm);
     return str;
@@ -2553,7 +2536,7 @@ int unpack_revinfo(ASN1_TIME **prevtm, int *preason, ASN1_OBJECT **phold,
     ASN1_OBJECT *hold = NULL;
     ASN1_GENERALIZEDTIME *comp_time = NULL;
 
-    tmp = BUF_strdup(str);
+    tmp = OPENSSL_strdup(str);
     if (!tmp) {
         BIO_printf(bio_err, &quot;memory allocation failure\n&quot;);
         goto end;
diff --git a/apps/cms.c b/apps/cms.c
index 14f8f55..8cf99de 100644
--- a/apps/cms.c
+++ b/apps/cms.c
@@ -902,7 +902,7 @@ int cms_main(int argc, char **argv)
             secret_keyid = NULL;
         }
         if (pwri_pass) {
-            pwri_tmp = (unsigned char *)BUF_strdup((char *)pwri_pass);
+            pwri_tmp = (unsigned char *)OPENSSL_strdup((char *)pwri_pass);
             if (!pwri_tmp)
                 goto end;
             if (!CMS_add0_recipient_password(cms,
diff --git a/apps/engine.c b/apps/engine.c
index 17e6f78..c373df5 100644
--- a/apps/engine.c
+++ b/apps/engine.c
@@ -109,8 +109,8 @@ static int append_buf(char **buf, const char *s, int *size, int step)
         return 0;
 
     if (**buf != '\0')
-        BUF_strlcat(*buf, &quot;, &quot;, *size);
-    BUF_strlcat(*buf, s, *size);
+        OPENSSL_strlcat(*buf, &quot;, &quot;, *size);
+    OPENSSL_strlcat(*buf, s, *size);
 
     return 1;
 }
diff --git a/apps/ocsp.c b/apps/ocsp.c
index ef7d62a..ceda592 100644
--- a/apps/ocsp.c
+++ b/apps/ocsp.c
@@ -1007,7 +1007,7 @@ static char **lookup_serial(CA_DB *db, ASN1_INTEGER *ser)
     OPENSSL_assert(bn);         /* FIXME: should report an error at this
                                  * point and abort */
     if (BN_is_zero(bn))
-        itmp = BUF_strdup(&quot;00&quot;);
+        itmp = OPENSSL_strdup(&quot;00&quot;);
     else
         itmp = BN_bn2hex(bn);
     row[DB_serial] = itmp;
diff --git a/apps/openssl.c b/apps/openssl.c
index 592095e..5ce04ce 100644
--- a/apps/openssl.c
+++ b/apps/openssl.c
@@ -218,7 +218,7 @@ static char *make_config_name()
     char *p;
 
     if ((t = getenv(&quot;OPENSSL_CONF&quot;)) != NULL)
-        return BUF_strdup(t);
+        return OPENSSL_strdup(t);
 
     t = X509_get_default_cert_area();
     len = strlen(t) + 1 + strlen(OPENSSL_CONF) + 1;
diff --git a/apps/passwd.c b/apps/passwd.c
index 2a32111..f0ab243 100644
--- a/apps/passwd.c
+++ b/apps/passwd.c
@@ -314,9 +314,9 @@ static char *md5crypt(const char *passwd, const char *magic, const char *salt)
     out_buf[0] = '$';
     out_buf[1] = 0;
     assert(strlen(magic) &lt;= 4); /* &quot;1&quot; or &quot;apr1&quot; */
-    strncat(out_buf, magic, 4);
-    strncat(out_buf, &quot;$&quot;, 1);
-    strncat(out_buf, salt, 8);
+    OPENSSL_strlcat(out_buf, magic, sizeof out_buf);
+    OPENSSL_strlcat(out_buf, &quot;$&quot;, sizeof out_buf);
+    OPENSSL_strlcat(out_buf, salt, sizeof out_buf);
     assert(strlen(out_buf) &lt;= 6 + 8); /* &quot;$apr1$..salt..&quot; */
     salt_out = out_buf + 2 + strlen(magic);
     salt_len = strlen(salt_out);
diff --git a/apps/pkcs12.c b/apps/pkcs12.c
index 11930e9..3d566f3 100644
--- a/apps/pkcs12.c
+++ b/apps/pkcs12.c
@@ -484,7 +484,7 @@ int pkcs12_main(int argc, char **argv)
             goto export_end;
         }
         if (!twopass)
-            BUF_strlcpy(macpass, pass, sizeof macpass);
+            OPENSSL_strlcpy(macpass, pass, sizeof macpass);
 
         p12 = PKCS12_create(cpass, name, key, ucert, certs,
                             key_pbe, cert_pbe, iter, -1, keytype);
@@ -542,7 +542,7 @@ int pkcs12_main(int argc, char **argv)
     }
 
     if (!twopass)
-        BUF_strlcpy(macpass, pass, sizeof macpass);
+        OPENSSL_strlcpy(macpass, pass, sizeof macpass);
 
     if ((options &amp; INFO) &amp;&amp; p12-&gt;mac)
         BIO_printf(bio_err, &quot;MAC Iteration %ld\n&quot;,
diff --git a/apps/rehash.c b/apps/rehash.c
index e85265d..38084a2 100644
--- a/apps/rehash.c
+++ b/apps/rehash.c
@@ -175,7 +175,7 @@ static int add_entry(enum Type type, unsigned int hash, const char *filename,
         ep = app_malloc(sizeof(*ep), &quot;collision bucket&quot;);
         *ep = nilhentry;
         ep-&gt;old_id = ~0;
-        ep-&gt;filename = BUF_strdup(filename);
+        ep-&gt;filename = OPENSSL_strdup(filename);
         if (bp-&gt;last_entry)
             bp-&gt;last_entry-&gt;next = ep;
         if (bp-&gt;first_entry == NULL)
@@ -468,7 +468,7 @@ int rehash_main(int argc, char **argv)
         while (*argv)
             errs += do_dir(*argv++, h);
     } else if ((env = getenv(&quot;SSL_CERT_DIR&quot;)) != NULL) {
-        m = BUF_strdup(env);
+        m = OPENSSL_strdup(env);
         for (e = strtok(m, &quot;:&quot;); e != NULL; e = strtok(NULL, &quot;:&quot;))
             errs += do_dir(e, h);
         OPENSSL_free(m);
diff --git a/apps/req.c b/apps/req.c
index c275763..a0da788 100644
--- a/apps/req.c
+++ b/apps/req.c
@@ -1189,8 +1189,8 @@ static int add_DN_object(X509_NAME *n, char *text, const char *def,
         BIO_printf(bio_err, &quot;%s [%s]:&quot;, text, def);
     (void)BIO_flush(bio_err);
     if (value != NULL) {
-        BUF_strlcpy(buf, value, sizeof buf);
-        BUF_strlcat(buf, &quot;\n&quot;, sizeof buf);
+        OPENSSL_strlcpy(buf, value, sizeof buf);
+        OPENSSL_strlcat(buf, &quot;\n&quot;, sizeof buf);
         BIO_printf(bio_err, &quot;%s\n&quot;, value);
     } else {
         buf[0] = '\0';
@@ -1208,8 +1208,8 @@ static int add_DN_object(X509_NAME *n, char *text, const char *def,
     else if (buf[0] == '\n') {
         if ((def == NULL) || (def[0] == '\0'))
             return (1);
-        BUF_strlcpy(buf, def, sizeof buf);
-        BUF_strlcat(buf, &quot;\n&quot;, sizeof buf);
+        OPENSSL_strlcpy(buf, def, sizeof buf);
+        OPENSSL_strlcat(buf, &quot;\n&quot;, sizeof buf);
     } else if ((buf[0] == '.') &amp;&amp; (buf[1] == '\n'))
         return (1);
 
@@ -1248,8 +1248,8 @@ static int add_attribute_object(X509_REQ *req, char *text, const char *def,
         BIO_printf(bio_err, &quot;%s [%s]:&quot;, text, def);
     (void)BIO_flush(bio_err);
     if (value != NULL) {
-        BUF_strlcpy(buf, value, sizeof buf);
-        BUF_strlcat(buf, &quot;\n&quot;, sizeof buf);
+        OPENSSL_strlcpy(buf, value, sizeof buf);
+        OPENSSL_strlcat(buf, &quot;\n&quot;, sizeof buf);
         BIO_printf(bio_err, &quot;%s\n&quot;, value);
     } else {
         buf[0] = '\0';
@@ -1267,8 +1267,8 @@ static int add_attribute_object(X509_REQ *req, char *text, const char *def,
     else if (buf[0] == '\n') {
         if ((def == NULL) || (def[0] == '\0'))
             return (1);
-        BUF_strlcpy(buf, def, sizeof buf);
-        BUF_strlcat(buf, &quot;\n&quot;, sizeof buf);
+        OPENSSL_strlcpy(buf, def, sizeof buf);
+        OPENSSL_strlcat(buf, &quot;\n&quot;, sizeof buf);
     } else if ((buf[0] == '.') &amp;&amp; (buf[1] == '\n'))
         return (1);
 
@@ -1428,7 +1428,7 @@ static EVP_PKEY_CTX *set_keygen_ctx(const char *gstr,
             return NULL;
         }
         EVP_PKEY_asn1_get0_info(NULL, NULL, NULL, NULL, &amp;anam, ameth);
-        *palgnam = BUF_strdup(anam);
+        *palgnam = OPENSSL_strdup(anam);
 #ifndef OPENSSL_NO_ENGINE
         if (tmpeng)
             ENGINE_finish(tmpeng);
diff --git a/apps/s_server.c b/apps/s_server.c
index 698dd1c..84a640e 100644
--- a/apps/s_server.c
+++ b/apps/s_server.c
@@ -3165,7 +3165,7 @@ static int add_session(SSL *ssl, SSL_SESSION *session)
         return 0;
     }
 
-    sess-&gt;id = BUF_memdup(SSL_SESSION_get_id(session, NULL), sess-&gt;idlen);
+    sess-&gt;id = OPENSSL_memdup(SSL_SESSION_get_id(session, NULL), sess-&gt;idlen);
     sess-&gt;der = app_malloc(sess-&gt;derlen, &quot;get session buffer&quot;);
     if (!sess-&gt;id) {
         BIO_printf(bio_err, &quot;Out of memory adding to external cache\n&quot;);
diff --git a/apps/s_socket.c b/apps/s_socket.c
index 9d1f04a..75053e9 100644
--- a/apps/s_socket.c
+++ b/apps/s_socket.c
@@ -560,7 +560,7 @@ static int do_accept(int acc_sock, int *sock, char **host)
         /* return(0); */
     } else {
         *host = app_malloc(strlen(h1-&gt;h_name) + 1, &quot;copy hostname&quot;);
-        BUF_strlcpy(*host, h1-&gt;h_name, strlen(h1-&gt;h_name) + 1);
+        OPENSSL_strlcpy(*host, h1-&gt;h_name, strlen(h1-&gt;h_name) + 1);
 
         h2 = gethostbyname(*host);
         if (h2 == NULL) {
diff --git a/apps/srp.c b/apps/srp.c
index 24fb798..1c9a9be 100644
--- a/apps/srp.c
+++ b/apps/srp.c
@@ -486,9 +486,9 @@ int srp_main(int argc, char **argv)
                     errors++;
                     goto end;
                 }
-                row[DB_srpid] = BUF_strdup(user);
-                row[DB_srptype] = BUF_strdup(&quot;v&quot;);
-                row[DB_srpgN] = BUF_strdup(gNid);
+                row[DB_srpid] = OPENSSL_strdup(user);
+                row[DB_srptype] = OPENSSL_strdup(&quot;v&quot;);
+                row[DB_srpgN] = OPENSSL_strdup(gNid);
 
                 if ((row[DB_srpid] == NULL)
                     || (row[DB_srpgN] == NULL)
@@ -496,7 +496,7 @@ int srp_main(int argc, char **argv)
                     || (row[DB_srpverifier] == NULL)
                     || (row[DB_srpsalt] == NULL)
                     || (userinfo
-                        &amp;&amp; ((row[DB_srpinfo] = BUF_strdup(userinfo)) == NULL))
+                        &amp;&amp; ((row[DB_srpinfo] = OPENSSL_strdup(userinfo)) == NULL))
                     || !update_index(db, row)) {
                     OPENSSL_free(row[DB_srpid]);
                     OPENSSL_free(row[DB_srpgN]);
@@ -571,7 +571,7 @@ int srp_main(int argc, char **argv)
                     }
 
                     row[DB_srptype][0] = 'v';
-                    row[DB_srpgN] = BUF_strdup(gNid);
+                    row[DB_srpgN] = OPENSSL_strdup(gNid);
 
                     if (row[DB_srpid] == NULL
                         || row[DB_srpgN] == NULL
@@ -579,7 +579,7 @@ int srp_main(int argc, char **argv)
                         || row[DB_srpverifier] == NULL
                         || row[DB_srpsalt] == NULL
                         || (userinfo
-                            &amp;&amp; ((row[DB_srpinfo] = BUF_strdup(userinfo))
+                            &amp;&amp; ((row[DB_srpinfo] = OPENSSL_strdup(userinfo))
                                 == NULL)))
                         goto end;
 
diff --git a/apps/x509.c b/apps/x509.c
index 1677ba5..283d055 100644
--- a/apps/x509.c
+++ b/apps/x509.c
@@ -949,15 +949,15 @@ static ASN1_INTEGER *x509_load_serial(char *CAfile, char *serialfile,
            : (strlen(serialfile))) + 1;
     buf = app_malloc(len, &quot;serial# buffer&quot;);
     if (serialfile == NULL) {
-        BUF_strlcpy(buf, CAfile, len);
+        OPENSSL_strlcpy(buf, CAfile, len);
         for (p = buf; *p; p++)
             if (*p == '.') {
                 *p = '\0';
                 break;
             }
-        BUF_strlcat(buf, POSTFIX, len);
+        OPENSSL_strlcat(buf, POSTFIX, len);
     } else
-        BUF_strlcpy(buf, serialfile, len);
+        OPENSSL_strlcpy(buf, serialfile, len);
 
     serial = load_serial(buf, create, NULL);
     if (serial == NULL)
diff --git a/crypto/Makefile b/crypto/Makefile
index b2cf528..43cb71f 100644
--- a/crypto/Makefile
+++ b/crypto/Makefile
@@ -202,8 +202,13 @@ o_init.o: ../include/openssl/lhash.h ../include/openssl/opensslconf.h
 o_init.o: ../include/openssl/opensslv.h ../include/openssl/ossl_typ.h
 o_init.o: ../include/openssl/safestack.h ../include/openssl/stack.h
 o_init.o: ../include/openssl/symhacks.h o_init.c
-o_str.o: ../e_os.h ../include/internal/o_str.h ../include/openssl/e_os2.h
-o_str.o: ../include/openssl/opensslconf.h o_str.c
+o_str.o: ../e_os.h ../include/internal/o_str.h ../include/openssl/bio.h
+o_str.o: ../include/openssl/buffer.h ../include/openssl/crypto.h
+o_str.o: ../include/openssl/e_os2.h ../include/openssl/err.h
+o_str.o: ../include/openssl/lhash.h ../include/openssl/opensslconf.h
+o_str.o: ../include/openssl/opensslv.h ../include/openssl/ossl_typ.h
+o_str.o: ../include/openssl/safestack.h ../include/openssl/stack.h
+o_str.o: ../include/openssl/symhacks.h include/internal/cryptlib.h o_str.c
 o_time.o: ../include/openssl/crypto.h ../include/openssl/e_os2.h
 o_time.o: ../include/openssl/opensslconf.h ../include/openssl/opensslv.h
 o_time.o: ../include/openssl/ossl_typ.h ../include/openssl/safestack.h
diff --git a/crypto/asn1/a_time.c b/crypto/asn1/a_time.c
index ff82beb..c5e632e 100644
--- a/crypto/asn1/a_time.c
+++ b/crypto/asn1/a_time.c
@@ -139,11 +139,11 @@ ASN1_GENERALIZEDTIME *ASN1_TIME_to_generalizedtime(ASN1_TIME *t,
     str = (char *)ret-&gt;data;
     /* Work out the century and prepend */
     if (t-&gt;data[0] &gt;= '5')
-        BUF_strlcpy(str, &quot;19&quot;, newlen);
+        OPENSSL_strlcpy(str, &quot;19&quot;, newlen);
     else
-        BUF_strlcpy(str, &quot;20&quot;, newlen);
+        OPENSSL_strlcpy(str, &quot;20&quot;, newlen);
 
-    BUF_strlcat(str, (char *)t-&gt;data, newlen);
+    OPENSSL_strlcat(str, (char *)t-&gt;data, newlen);
 
     return ret;
 }
diff --git a/crypto/asn1/ameth_lib.c b/crypto/asn1/ameth_lib.c
index 05f0a80..85115bc 100644
--- a/crypto/asn1/ameth_lib.c
+++ b/crypto/asn1/ameth_lib.c
@@ -285,13 +285,13 @@ EVP_PKEY_ASN1_METHOD *EVP_PKEY_asn1_new(int id, int flags,
     ameth-&gt;pkey_flags = flags | ASN1_PKEY_DYNAMIC;
 
     if (info) {
-        ameth-&gt;info = BUF_strdup(info);
+        ameth-&gt;info = OPENSSL_strdup(info);
         if (!ameth-&gt;info)
             goto err;
     }
 
     if (pem_str) {
-        ameth-&gt;pem_str = BUF_strdup(pem_str);
+        ameth-&gt;pem_str = OPENSSL_strdup(pem_str);
         if (!ameth-&gt;pem_str)
             goto err;
     }
diff --git a/crypto/asn1/asn_mime.c b/crypto/asn1/asn_mime.c
index 5369099..ed9d8d6 100644
--- a/crypto/asn1/asn_mime.c
+++ b/crypto/asn1/asn_mime.c
@@ -829,7 +829,7 @@ static MIME_HEADER *mime_hdr_new(char *name, char *value)
     int c;
 
     if (name) {
-        if ((tmpname = BUF_strdup(name)) == NULL)
+        if ((tmpname = OPENSSL_strdup(name)) == NULL)
             return NULL;
         for (p = tmpname; *p; p++) {
             c = (unsigned char)*p;
@@ -840,7 +840,7 @@ static MIME_HEADER *mime_hdr_new(char *name, char *value)
         }
     }
     if (value) {
-        if ((tmpval = BUF_strdup(value)) == NULL)
+        if ((tmpval = OPENSSL_strdup(value)) == NULL)
             goto err;
         for (p = tmpval; *p; p++) {
             c = (unsigned char)*p;
@@ -872,7 +872,7 @@ static int mime_hdr_addparam(MIME_HEADER *mhdr, char *name, char *value)
     int c;
     MIME_PARAM *mparam = NULL;
     if (name) {
-        tmpname = BUF_strdup(name);
+        tmpname = OPENSSL_strdup(name);
         if (!tmpname)
             goto err;
         for (p = tmpname; *p; p++) {
@@ -884,7 +884,7 @@ static int mime_hdr_addparam(MIME_HEADER *mhdr, char *name, char *value)
         }
     }
     if (value) {
-        tmpval = BUF_strdup(value);
+        tmpval = OPENSSL_strdup(value);
         if (!tmpval)
             goto err;
     }
diff --git a/crypto/bio/b_dump.c b/crypto/bio/b_dump.c
index 55792b9..3d005e3 100644
--- a/crypto/bio/b_dump.c
+++ b/crypto/bio/b_dump.c
@@ -104,20 +104,20 @@ int BIO_dump_indent_cb(int (*cb) (const void *data, size_t len, void *u),
     if ((rows * dump_width) &lt; len)
         rows++;
     for (i = 0; i &lt; rows; i++) {
-        BUF_strlcpy(buf, str, sizeof buf);
+        OPENSSL_strlcpy(buf, str, sizeof buf);
         BIO_snprintf(tmp, sizeof tmp, &quot;%04x - &quot;, i * dump_width);
-        BUF_strlcat(buf, tmp, sizeof buf);
+        OPENSSL_strlcat(buf, tmp, sizeof buf);
         for (j = 0; j &lt; dump_width; j++) {
             if (((i * dump_width) + j) &gt;= len) {
-                BUF_strlcat(buf, &quot;   &quot;, sizeof buf);
+                OPENSSL_strlcat(buf, &quot;   &quot;, sizeof buf);
             } else {
                 ch = ((unsigned char)*(s + i * dump_width + j)) &amp; 0xff;
                 BIO_snprintf(tmp, sizeof tmp, &quot;%02x%c&quot;, ch,
                              j == 7 ? '-' : ' ');
-                BUF_strlcat(buf, tmp, sizeof buf);
+                OPENSSL_strlcat(buf, tmp, sizeof buf);
             }
         }
-        BUF_strlcat(buf, &quot;  &quot;, sizeof buf);
+        OPENSSL_strlcat(buf, &quot;  &quot;, sizeof buf);
         for (j = 0; j &lt; dump_width; j++) {
             if (((i * dump_width) + j) &gt;= len)
                 break;
@@ -131,9 +131,9 @@ int BIO_dump_indent_cb(int (*cb) (const void *data, size_t len, void *u),
                          ? os_toebcdic[ch]
                          : '.');
 #endif
-            BUF_strlcat(buf, tmp, sizeof buf);
+            OPENSSL_strlcat(buf, tmp, sizeof buf);
         }
-        BUF_strlcat(buf, &quot;\n&quot;, sizeof buf);
+        OPENSSL_strlcat(buf, &quot;\n&quot;, sizeof buf);
         /*
          * if this is the last call then update the ddt_dump thing so that we
          * will move the selection point in the debug window
diff --git a/crypto/bio/b_sock.c b/crypto/bio/b_sock.c
index e536eda..cc09072 100644
--- a/crypto/bio/b_sock.c
+++ b/crypto/bio/b_sock.c
@@ -402,7 +402,7 @@ int BIO_get_accept_socket(char *host, int bind_mode)
     if (BIO_sock_init() != 1)
         return ((int)INVALID_SOCKET);
 
-    if ((str = BUF_strdup(host)) == NULL)
+    if ((str = OPENSSL_strdup(host)) == NULL)
         return ((int)INVALID_SOCKET);
 
     h = p = NULL;
diff --git a/crypto/bio/bss_acpt.c b/crypto/bio/bss_acpt.c
index c549c87..f65ee1a 100644
--- a/crypto/bio/bss_acpt.c
+++ b/crypto/bio/bss_acpt.c
@@ -350,7 +350,7 @@ static long acpt_ctrl(BIO *b, int cmd, long num, void *ptr)
             if (num == 0) {
                 b-&gt;init = 1;
                 OPENSSL_free(data-&gt;param_addr);
-                data-&gt;param_addr = BUF_strdup(ptr);
+                data-&gt;param_addr = OPENSSL_strdup(ptr);
             } else if (num == 1) {
                 data-&gt;accept_nbio = (ptr != NULL);
             } else if (num == 2) {
diff --git a/crypto/bio/bss_conn.c b/crypto/bio/bss_conn.c
index ba009aa..929656c 100644
--- a/crypto/bio/bss_conn.c
+++ b/crypto/bio/bss_conn.c
@@ -149,7 +149,7 @@ static int conn_state(BIO *b, BIO_CONNECT *c)
                             break;
                         }
                     OPENSSL_free(c-&gt;param_port);
-                    c-&gt;param_port = BUF_strdup(p);
+                    c-&gt;param_port = OPENSSL_strdup(p);
                 }
             }
 
@@ -455,10 +455,10 @@ static long conn_ctrl(BIO *b, int cmd, long num, void *ptr)
             b-&gt;init = 1;
             if (num == 0) {
                 OPENSSL_free(data-&gt;param_hostname);
-                data-&gt;param_hostname = BUF_strdup(ptr);
+                data-&gt;param_hostname = OPENSSL_strdup(ptr);
             } else if (num == 1) {
                 OPENSSL_free(data-&gt;param_port);
-                data-&gt;param_port = BUF_strdup(ptr);
+                data-&gt;param_port = OPENSSL_strdup(ptr);
             } else if (num == 2) {
                 char buf[16];
                 unsigned char *p = ptr;
@@ -466,14 +466,14 @@ static long conn_ctrl(BIO *b, int cmd, long num, void *ptr)
                 BIO_snprintf(buf, sizeof buf, &quot;%d.%d.%d.%d&quot;,
                              p[0], p[1], p[2], p[3]);
                 OPENSSL_free(data-&gt;param_hostname);
-                data-&gt;param_hostname = BUF_strdup(buf);
+                data-&gt;param_hostname = OPENSSL_strdup(buf);
                 memcpy(&amp;(data-&gt;ip[0]), ptr, 4);
             } else if (num == 3) {
                 char buf[DECIMAL_SIZE(int) + 1];
 
                 BIO_snprintf(buf, sizeof buf, &quot;%d&quot;, *(int *)ptr);
                 OPENSSL_free(data-&gt;param_port);
-                data-&gt;param_port = BUF_strdup(buf);
+                data-&gt;param_port = OPENSSL_strdup(buf);
                 data-&gt;port = *(int *)ptr;
             }
         }
diff --git a/crypto/bio/bss_file.c b/crypto/bio/bss_file.c
index 7692ee2..c09a9a9 100644
--- a/crypto/bio/bss_file.c
+++ b/crypto/bio/bss_file.c
@@ -367,15 +367,15 @@ static long file_ctrl(BIO *b, int cmd, long num, void *ptr)
         b-&gt;shutdown = (int)num &amp; BIO_CLOSE;
         if (num &amp; BIO_FP_APPEND) {
             if (num &amp; BIO_FP_READ)
-                BUF_strlcpy(p, &quot;a+&quot;, sizeof p);
+                OPENSSL_strlcpy(p, &quot;a+&quot;, sizeof p);
             else
-                BUF_strlcpy(p, &quot;a&quot;, sizeof p);
+                OPENSSL_strlcpy(p, &quot;a&quot;, sizeof p);
         } else if ((num &amp; BIO_FP_READ) &amp;&amp; (num &amp; BIO_FP_WRITE))
-            BUF_strlcpy(p, &quot;r+&quot;, sizeof p);
+            OPENSSL_strlcpy(p, &quot;r+&quot;, sizeof p);
         else if (num &amp; BIO_FP_WRITE)
-            BUF_strlcpy(p, &quot;w&quot;, sizeof p);
+            OPENSSL_strlcpy(p, &quot;w&quot;, sizeof p);
         else if (num &amp; BIO_FP_READ)
-            BUF_strlcpy(p, &quot;r&quot;, sizeof p);
+            OPENSSL_strlcpy(p, &quot;r&quot;, sizeof p);
         else {
             BIOerr(BIO_F_FILE_CTRL, BIO_R_BAD_FOPEN_MODE);
             ret = 0;
diff --git a/crypto/buffer/Makefile b/crypto/buffer/Makefile
index f9d52fe..e0b6ffd 100644
--- a/crypto/buffer/Makefile
+++ b/crypto/buffer/Makefile
@@ -15,8 +15,8 @@ CFLAGS= $(INCLUDES) $(CFLAG)
 GENERAL=Makefile
 
 LIB=$(TOP)/libcrypto.a
-LIBSRC= buffer.c buf_str.c buf_err.c
-LIBOBJ= buffer.o buf_str.o buf_err.o
+LIBSRC= buffer.c buf_err.c
+LIBOBJ= buffer.o buf_err.o
 
 SRC= $(LIBSRC)
 
@@ -67,14 +67,6 @@ buf_err.o: ../../include/openssl/opensslconf.h ../../include/openssl/opensslv.h
 buf_err.o: ../../include/openssl/ossl_typ.h ../../include/openssl/safestack.h
 buf_err.o: ../../include/openssl/stack.h ../../include/openssl/symhacks.h
 buf_err.o: buf_err.c
-buf_str.o: ../../e_os.h ../../include/openssl/bio.h
-buf_str.o: ../../include/openssl/buffer.h ../../include/openssl/crypto.h
-buf_str.o: ../../include/openssl/e_os2.h ../../include/openssl/err.h
-buf_str.o: ../../include/openssl/lhash.h ../../include/openssl/opensslconf.h
-buf_str.o: ../../include/openssl/opensslv.h ../../include/openssl/ossl_typ.h
-buf_str.o: ../../include/openssl/safestack.h ../../include/openssl/stack.h
-buf_str.o: ../../include/openssl/symhacks.h ../include/internal/cryptlib.h
-buf_str.o: buf_str.c
 buffer.o: ../../e_os.h ../../include/openssl/bio.h
 buffer.o: ../../include/openssl/buffer.h ../../include/openssl/crypto.h
 buffer.o: ../../include/openssl/e_os2.h ../../include/openssl/err.h
diff --git a/crypto/buffer/buf_err.c b/crypto/buffer/buf_err.c
index 34671aa..e126edd 100644
--- a/crypto/buffer/buf_err.c
+++ b/crypto/buffer/buf_err.c
@@ -70,12 +70,9 @@
 # define ERR_REASON(reason) ERR_PACK(ERR_LIB_BUF,0,reason)
 
 static ERR_STRING_DATA BUF_str_functs[] = {
-    {ERR_FUNC(BUF_F_BUF_MEMDUP), &quot;BUF_memdup&quot;},
     {ERR_FUNC(BUF_F_BUF_MEM_GROW), &quot;BUF_MEM_grow&quot;},
     {ERR_FUNC(BUF_F_BUF_MEM_GROW_CLEAN), &quot;BUF_MEM_grow_clean&quot;},
     {ERR_FUNC(BUF_F_BUF_MEM_NEW), &quot;BUF_MEM_new&quot;},
-    {ERR_FUNC(BUF_F_BUF_STRDUP), &quot;BUF_strdup&quot;},
-    {ERR_FUNC(BUF_F_BUF_STRNDUP), &quot;BUF_strndup&quot;},
     {0, NULL}
 };
 
diff --git a/crypto/buffer/buf_str.c b/crypto/buffer/buf_str.c
deleted file mode 100644
index 1f3e8a4..0000000
--- a/crypto/buffer/buf_str.c
+++ /dev/null
@@ -1,137 +0,0 @@
-/* crypto/buffer/buffer.c */
-/* Copyright (C) 1995-1998 Eric Young (<A HREF="../../../mailman/listinfo/openssl-commits.html">eay at cryptsoft.com</A>)
- * All rights reserved.
- *
- * This package is an SSL implementation written
- * by Eric Young (<A HREF="../../../mailman/listinfo/openssl-commits.html">eay at cryptsoft.com</A>).
- * The implementation was written so as to conform with Netscapes SSL.
- *
- * This library is free for commercial and non-commercial use as long as
- * the following conditions are aheared to.  The following conditions
- * apply to all code found in this distribution, be it the RC4, RSA,
- * lhash, DES, etc., code; not just the SSL code.  The SSL documentation
- * included with this distribution is covered by the same copyright terms
- * except that the holder is Tim Hudson (<A HREF="../../../mailman/listinfo/openssl-commits.html">tjh at cryptsoft.com</A>).
- *
- * Copyright remains Eric Young's, and as such any Copyright notices in
- * the code are not to be removed.
- * If this package is used in a product, Eric Young should be given attribution
- * as the author of the parts of the library used.
- * This can be in the form of a textual message at program startup or
- * in documentation (online or textual) provided with the package.
- *
- * Redistribution and use in source and binary forms, with or without
- * modification, are permitted provided that the following conditions
- * are met:
- * 1. Redistributions of source code must retain the copyright
- *    notice, this list of conditions and the following disclaimer.
- * 2. Redistributions in binary form must reproduce the above copyright
- *    notice, this list of conditions and the following disclaimer in the
- *    documentation and/or other materials provided with the distribution.
- * 3. All advertising materials mentioning features or use of this software
- *    must display the following acknowledgement:
- *    &quot;This product includes cryptographic software written by
- *     Eric Young (<A HREF="../../../mailman/listinfo/openssl-commits.html">eay at cryptsoft.com</A>)&quot;
- *    The word 'cryptographic' can be left out if the rouines from the library
- *    being used are not cryptographic related :-).
- * 4. If you include any Windows specific code (or a derivative thereof) from
- *    the apps directory (application code) you must include an acknowledgement:
- *    &quot;This product includes software written by Tim Hudson (<A HREF="../../../mailman/listinfo/openssl-commits.html">tjh at cryptsoft.com</A>)&quot;
- *
- * THIS SOFTWARE IS PROVIDED BY ERIC YOUNG ``AS IS'' AND
- * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
- * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE
- * ARE DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE
- * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL
- * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS
- * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)
- * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT
- * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY
- * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
- * SUCH DAMAGE.
- *
- * The licence and distribution terms for any publically available version or
- * derivative of this code cannot be changed.  i.e. this code cannot simply be
- * copied and put under another distribution licence
- * [including the GNU Public Licence.]
- */
-
-#include &lt;stdio.h&gt;
-#include &lt;limits.h&gt;
-#include &quot;internal/cryptlib.h&quot;
-#include &lt;openssl/buffer.h&gt;
-
-size_t BUF_strnlen(const char *str, size_t maxlen)
-{
-    const char *p;
-
-    for (p = str; maxlen-- != 0 &amp;&amp; *p != '\0'; ++p) ;
-
-    return p - str;
-}
-
-char *BUF_strdup(const char *str)
-{
-    if (str == NULL)
-        return NULL;
-    return BUF_strndup(str, strlen(str));
-}
-
-char *BUF_strndup(const char *str, size_t siz)
-{
-    char *ret;
-
-    if (str == NULL)
-        return NULL;
-
-    siz = BUF_strnlen(str, siz);
-
-    if (siz &gt;= INT_MAX)
-        return NULL;
-
-    ret = OPENSSL_malloc(siz + 1);
-    if (ret == NULL) {
-        BUFerr(BUF_F_BUF_STRNDUP, ERR_R_MALLOC_FAILURE);
-        return NULL;
-    }
-
-    memcpy(ret, str, siz);
-    ret[siz] = '\0';
-
-    return (ret);
-}
-
-void *BUF_memdup(const void *data, size_t siz)
-{
-    void *ret;
-
-    if (data == NULL || siz &gt;= INT_MAX)
-        return NULL;
-
-    ret = OPENSSL_malloc(siz);
-    if (ret == NULL) {
-        BUFerr(BUF_F_BUF_MEMDUP, ERR_R_MALLOC_FAILURE);
-        return NULL;
-    }
-    return memcpy(ret, data, siz);
-}
-
-size_t BUF_strlcpy(char *dst, const char *src, size_t size)
-{
-    size_t l = 0;
-    for (; size &gt; 1 &amp;&amp; *src; size--) {
-        *dst++ = *src++;
-        l++;
-    }
-    if (size)
-        *dst = '\0';
-    return l + strlen(src);
-}
-
-size_t BUF_strlcat(char *dst, const char *src, size_t size)
-{
-    size_t l = 0;
-    for (; size &gt; 0 &amp;&amp; *dst; size--, dst++)
-        l++;
-    return l + BUF_strlcpy(dst, src, size);
-}
diff --git a/crypto/conf/conf_def.c b/crypto/conf/conf_def.c
index 1ff49aa..ac07405 100644
--- a/crypto/conf/conf_def.c
+++ b/crypto/conf/conf_def.c
@@ -223,7 +223,7 @@ static int def_load_bio(CONF *conf, BIO *in, long *line)
         goto err;
     }
 
-    section = BUF_strdup(&quot;default&quot;);
+    section = OPENSSL_strdup(&quot;default&quot;);
     if (section == NULL) {
         CONFerr(CONF_F_DEF_LOAD_BIO, ERR_R_MALLOC_FAILURE);
         goto err;
@@ -366,7 +366,7 @@ static int def_load_bio(CONF *conf, BIO *in, long *line)
                 CONFerr(CONF_F_DEF_LOAD_BIO, ERR_R_MALLOC_FAILURE);
                 goto err;
             }
-            BUF_strlcpy(v-&gt;name, pname, strlen(pname) + 1);
+            OPENSSL_strlcpy(v-&gt;name, pname, strlen(pname) + 1);
             if (!str_copy(conf, psection, &amp;(v-&gt;value), start))
                 goto err;
 
diff --git a/crypto/conf/conf_mod.c b/crypto/conf/conf_mod.c
index c1fbb60..4fafded 100644
--- a/crypto/conf/conf_mod.c
+++ b/crypto/conf/conf_mod.c
@@ -286,7 +286,7 @@ static CONF_MODULE *module_add(DSO *dso, const char *name,
         return NULL;
 
     tmod-&gt;dso = dso;
-    tmod-&gt;name = BUF_strdup(name);
+    tmod-&gt;name = OPENSSL_strdup(name);
     tmod-&gt;init = ifunc;
     tmod-&gt;finish = ffunc;
 
@@ -340,8 +340,8 @@ static int module_init(CONF_MODULE *pmod, char *name, char *value,
         goto err;
 
     imod-&gt;pmod = pmod;
-    imod-&gt;name = BUF_strdup(name);
-    imod-&gt;value = BUF_strdup(value);
+    imod-&gt;name = OPENSSL_strdup(name);
+    imod-&gt;value = OPENSSL_strdup(value);
     imod-&gt;usr_data = NULL;
 
     if (!imod-&gt;name || !imod-&gt;value)
@@ -525,7 +525,7 @@ char *CONF_get1_default_config_file(void)
 
     file = getenv(&quot;OPENSSL_CONF&quot;);
     if (file)
-        return BUF_strdup(file);
+        return OPENSSL_strdup(file);
 
     len = strlen(X509_get_default_cert_area());
 #ifndef OPENSSL_SYS_VMS
@@ -537,11 +537,11 @@ char *CONF_get1_default_config_file(void)
 
     if (file == NULL)
         return NULL;
-    BUF_strlcpy(file, X509_get_default_cert_area(), len + 1);
+    OPENSSL_strlcpy(file, X509_get_default_cert_area(), len + 1);
 #ifndef OPENSSL_SYS_VMS
-    BUF_strlcat(file, &quot;/&quot;, len + 1);
+    OPENSSL_strlcat(file, &quot;/&quot;, len + 1);
 #endif
-    BUF_strlcat(file, OPENSSL_CONF, len + 1);
+    OPENSSL_strlcat(file, OPENSSL_CONF, len + 1);
 
     return file;
 }
diff --git a/crypto/cpt_err.c b/crypto/cpt_err.c
index b8d3fa4..af505ac 100644
--- a/crypto/cpt_err.c
+++ b/crypto/cpt_err.c
@@ -75,6 +75,7 @@ static ERR_STRING_DATA CRYPTO_str_functs[] = {
     {ERR_FUNC(CRYPTO_F_CRYPTO_GET_EX_NEW_INDEX), &quot;CRYPTO_get_ex_new_index&quot;},
     {ERR_FUNC(CRYPTO_F_CRYPTO_GET_NEW_DYNLOCKID), &quot;CRYPTO_get_new_dynlockid&quot;},
     {ERR_FUNC(CRYPTO_F_CRYPTO_GET_NEW_LOCKID), &quot;CRYPTO_get_new_lockid&quot;},
+    {ERR_FUNC(CRYPTO_F_CRYPTO_MEMDUP), &quot;CRYPTO_memdup&quot;},
     {ERR_FUNC(CRYPTO_F_CRYPTO_NEW_EX_DATA), &quot;CRYPTO_new_ex_data&quot;},
     {ERR_FUNC(CRYPTO_F_CRYPTO_SET_EX_DATA), &quot;CRYPTO_set_ex_data&quot;},
     {ERR_FUNC(CRYPTO_F_DEF_ADD_INDEX), &quot;DEF_ADD_INDEX&quot;},
diff --git a/crypto/dh/dh_ameth.c b/crypto/dh/dh_ameth.c
index 7a3d923..64eaf4c 100644
--- a/crypto/dh/dh_ameth.c
+++ b/crypto/dh/dh_ameth.c
@@ -482,7 +482,7 @@ static int int_dh_param_copy(DH *to, const DH *from, int is_x942)
         to-&gt;seed = NULL;
         to-&gt;seedlen = 0;
         if (from-&gt;seed) {
-            to-&gt;seed = BUF_memdup(from-&gt;seed, from-&gt;seedlen);
+            to-&gt;seed = OPENSSL_memdup(from-&gt;seed, from-&gt;seedlen);
             if (!to-&gt;seed)
                 return 0;
             to-&gt;seedlen = from-&gt;seedlen;
@@ -770,7 +770,7 @@ static int dh_cms_set_shared_info(EVP_PKEY_CTX *pctx, CMS_RecipientInfo *ri)
 
     if (ukm) {
         dukmlen = ASN1_STRING_length(ukm);
-        dukm = BUF_memdup(ASN1_STRING_data(ukm), dukmlen);
+        dukm = OPENSSL_memdup(ASN1_STRING_data(ukm), dukmlen);
         if (!dukm)
             goto err;
     }
@@ -914,7 +914,7 @@ static int dh_cms_encrypt(CMS_RecipientInfo *ri)
 
     if (ukm) {
         dukmlen = ASN1_STRING_length(ukm);
-        dukm = BUF_memdup(ASN1_STRING_data(ukm), dukmlen);
+        dukm = OPENSSL_memdup(ASN1_STRING_data(ukm), dukmlen);
         if (!dukm)
             goto err;
     }
diff --git a/crypto/dh/dh_pmeth.c b/crypto/dh/dh_pmeth.c
index 1e12c3e..a760ff5 100644
--- a/crypto/dh/dh_pmeth.c
+++ b/crypto/dh/dh_pmeth.c
@@ -134,7 +134,7 @@ static int pkey_dh_copy(EVP_PKEY_CTX *dst, EVP_PKEY_CTX *src)
         return 0;
     dctx-&gt;kdf_md = sctx-&gt;kdf_md;
     if (dctx-&gt;kdf_ukm) {
-        dctx-&gt;kdf_ukm = BUF_memdup(sctx-&gt;kdf_ukm, sctx-&gt;kdf_ukmlen);
+        dctx-&gt;kdf_ukm = OPENSSL_memdup(sctx-&gt;kdf_ukm, sctx-&gt;kdf_ukmlen);
         dctx-&gt;kdf_ukmlen = sctx-&gt;kdf_ukmlen;
     }
     dctx-&gt;kdf_outlen = sctx-&gt;kdf_outlen;
diff --git a/crypto/dso/dso_lib.c b/crypto/dso/dso_lib.c
index 17d1732..56e7657 100644
--- a/crypto/dso/dso_lib.c
+++ b/crypto/dso/dso_lib.c
@@ -353,7 +353,7 @@ int DSO_set_filename(DSO *dso, const char *filename)
         DSOerr(DSO_F_DSO_SET_FILENAME, ERR_R_MALLOC_FAILURE);
         return (0);
     }
-    BUF_strlcpy(copied, filename, strlen(filename) + 1);
+    OPENSSL_strlcpy(copied, filename, strlen(filename) + 1);
     OPENSSL_free(dso-&gt;filename);
     dso-&gt;filename = copied;
     return (1);
@@ -402,7 +402,7 @@ char *DSO_convert_filename(DSO *dso, const char *filename)
             DSOerr(DSO_F_DSO_CONVERT_FILENAME, ERR_R_MALLOC_FAILURE);
             return (NULL);
         }
-        BUF_strlcpy(result, filename, strlen(filename) + 1);
+        OPENSSL_strlcpy(result, filename, strlen(filename) + 1);
     }
     return (result);
 }
diff --git a/crypto/ec/ec_pmeth.c b/crypto/ec/ec_pmeth.c
index cbdf4e2..bcb5063 100644
--- a/crypto/ec/ec_pmeth.c
+++ b/crypto/ec/ec_pmeth.c
@@ -124,7 +124,7 @@ static int pkey_ec_copy(EVP_PKEY_CTX *dst, EVP_PKEY_CTX *src)
     dctx-&gt;kdf_md = sctx-&gt;kdf_md;
     dctx-&gt;kdf_outlen = sctx-&gt;kdf_outlen;
     if (sctx-&gt;kdf_ukm) {
-        dctx-&gt;kdf_ukm = BUF_memdup(sctx-&gt;kdf_ukm, sctx-&gt;kdf_ukmlen);
+        dctx-&gt;kdf_ukm = OPENSSL_memdup(sctx-&gt;kdf_ukm, sctx-&gt;kdf_ukmlen);
         if (!dctx-&gt;kdf_ukm)
             return 0;
     } else
diff --git a/crypto/engine/eng_dyn.c b/crypto/engine/eng_dyn.c
index aed50f6..23f01cf 100644
--- a/crypto/engine/eng_dyn.c
+++ b/crypto/engine/eng_dyn.c
@@ -352,7 +352,7 @@ static int dynamic_ctrl(ENGINE *e, int cmd, long i, void *p, void (*f) (void))
             p = NULL;
         OPENSSL_free(ctx-&gt;DYNAMIC_LIBNAME);
         if (p)
-            ctx-&gt;DYNAMIC_LIBNAME = BUF_strdup(p);
+            ctx-&gt;DYNAMIC_LIBNAME = OPENSSL_strdup(p);
         else
             ctx-&gt;DYNAMIC_LIBNAME = NULL;
         return (ctx-&gt;DYNAMIC_LIBNAME ? 1 : 0);
@@ -365,7 +365,7 @@ static int dynamic_ctrl(ENGINE *e, int cmd, long i, void *p, void (*f) (void))
             p = NULL;
         OPENSSL_free(ctx-&gt;engine_id);
         if (p)
-            ctx-&gt;engine_id = BUF_strdup(p);
+            ctx-&gt;engine_id = OPENSSL_strdup(p);
         else
             ctx-&gt;engine_id = NULL;
         return (ctx-&gt;engine_id ? 1 : 0);
@@ -392,7 +392,7 @@ static int dynamic_ctrl(ENGINE *e, int cmd, long i, void *p, void (*f) (void))
             return 0;
         }
         {
-            char *tmp_str = BUF_strdup(p);
+            char *tmp_str = OPENSSL_strdup(p);
             if (!tmp_str) {
                 ENGINEerr(ENGINE_F_DYNAMIC_CTRL, ERR_R_MALLOC_FAILURE);
                 return 0;
diff --git a/crypto/err/err.c b/crypto/err/err.c
index b7ca3de..236f8ac 100644
--- a/crypto/err/err.c
+++ b/crypto/err/err.c
@@ -968,7 +968,7 @@ void ERR_add_error_vdata(int num, va_list args)
                 }
                 str = p;
             }
-            BUF_strlcat(str, a, (size_t)s + 1);
+            OPENSSL_strlcat(str, a, (size_t)s + 1);
         }
     }
     ERR_set_error_data(str, ERR_TXT_MALLOCED | ERR_TXT_STRING);
diff --git a/crypto/evp/e_chacha20_poly1305.c b/crypto/evp/e_chacha20_poly1305.c
index 0d80f95..c3c72a1 100644
--- a/crypto/evp/e_chacha20_poly1305.c
+++ b/crypto/evp/e_chacha20_poly1305.c
@@ -383,7 +383,7 @@ static int chacha20_poly1305_ctrl(EVP_CIPHER_CTX *ctx, int type, int arg,
     case EVP_CTRL_COPY:
         if (actx) {
             if ((((EVP_CIPHER_CTX *)ptr)-&gt;cipher_data =
-                   BUF_memdup(actx,sizeof(*actx) + Poly1305_ctx_size()))
+                   OPENSSL_memdup(actx,sizeof(*actx) + Poly1305_ctx_size()))
                 == NULL) {
                 EVPerr(EVP_F_CHACHA20_POLY1305_CTRL, EVP_R_COPY_ERROR);
                 return 0;
diff --git a/crypto/evp/evp_pbe.c b/crypto/evp/evp_pbe.c
index e5b1739..563634e 100644
--- a/crypto/evp/evp_pbe.c
+++ b/crypto/evp/evp_pbe.c
@@ -141,7 +141,7 @@ int EVP_PBE_CipherInit(ASN1_OBJECT *pbe_obj, const char *pass, int passlen,
         char obj_tmp[80];
         EVPerr(EVP_F_EVP_PBE_CIPHERINIT, EVP_R_UNKNOWN_PBE_ALGORITHM);
         if (!pbe_obj)
-            BUF_strlcpy(obj_tmp, &quot;NULL&quot;, sizeof obj_tmp);
+            OPENSSL_strlcpy(obj_tmp, &quot;NULL&quot;, sizeof obj_tmp);
         else
             i2t_ASN1_OBJECT(obj_tmp, sizeof obj_tmp, pbe_obj);
         ERR_add_error_data(2, &quot;TYPE=&quot;, obj_tmp);
diff --git a/crypto/lock.c b/crypto/lock.c
index d24527a..f337c0d 100644
--- a/crypto/lock.c
+++ b/crypto/lock.c
@@ -215,7 +215,7 @@ int CRYPTO_get_new_lockid(char *name)
         CRYPTOerr(CRYPTO_F_CRYPTO_GET_NEW_LOCKID, ERR_R_MALLOC_FAILURE);
         return (0);
     }
-    if ((str = BUF_strdup(name)) == NULL) {
+    if ((str = OPENSSL_strdup(name)) == NULL) {
         CRYPTOerr(CRYPTO_F_CRYPTO_GET_NEW_LOCKID, ERR_R_MALLOC_FAILURE);
         return (0);
     }
diff --git a/crypto/mem.c b/crypto/mem.c
index 33a76d2..83a1547 100644
--- a/crypto/mem.c
+++ b/crypto/mem.c
@@ -321,15 +321,6 @@ void *CRYPTO_zalloc(int num, const char *file, int line)
     return ret;
 }
 
-char *CRYPTO_strdup(const char *str, const char *file, int line)
-{
-    char *ret = CRYPTO_malloc(strlen(str) + 1, file, line);
-
-    if (ret != NULL)
-        strcpy(ret, str);
-    return ret;
-}
-
 void *CRYPTO_realloc(void *str, int num, const char *file, int line)
 {
     void *ret = NULL;
diff --git a/crypto/mem_dbg.c b/crypto/mem_dbg.c
index c2fe8af..9a48410 100644
--- a/crypto/mem_dbg.c
+++ b/crypto/mem_dbg.c
@@ -704,7 +704,7 @@ static void print_leak_doall_arg(const MEM *m, MEM_LEAK *l)
                 memcpy(buf + buf_len, amip-&gt;info, 128 - buf_len - 3);
                 buf_len = 128 - 3;
             } else {
-                BUF_strlcpy(buf + buf_len, amip-&gt;info, sizeof buf - buf_len);
+                OPENSSL_strlcpy(buf + buf_len, amip-&gt;info, sizeof buf - buf_len);
                 buf_len = strlen(buf);
             }
             BIO_snprintf(buf + buf_len, sizeof buf - buf_len, &quot;\&quot;\n&quot;);
diff --git a/crypto/o_str.c b/crypto/o_str.c
index f2f9404..e96f62a 100644
--- a/crypto/o_str.c
+++ b/crypto/o_str.c
@@ -58,7 +58,10 @@
  */
 
 #include &lt;ctype.h&gt;
+#include &lt;limits.h&gt;
 #include &lt;e_os.h&gt;
+#include &lt;openssl/crypto.h&gt;
+#include &quot;internal/cryptlib.h&quot;
 #include &quot;internal/o_str.h&quot;
 
 #if !defined(OPENSSL_IMPLEMENTS_strncasecmp) &amp;&amp; \
@@ -114,3 +117,81 @@ int OPENSSL_memcmp(const void *v1, const void *v2, size_t n)
 
     return ret;
 }
+
+char *CRYPTO_strdup(const char *str, const char* file, int line)
+{
+    char *ret;
+
+    if (str == NULL)
+        return NULL;
+    ret = CRYPTO_malloc(strlen(str) + 1, file, line);
+    if (ret != NULL)
+        strcpy(ret, str);
+    return ret;
+}
+
+char *CRYPTO_strndup(const char *str, size_t s, const char* file, int line)
+{
+    const char *cp;
+    size_t maxlen;
+    char *ret;
+
+    if (str == NULL)
+        return NULL;
+
+    /* Get length. */
+    for (cp = str, maxlen = s; maxlen-- != 0 &amp;&amp; *cp != '\0'; ++cp)
+        continue;
+    maxlen = cp - str;
+
+    ret = CRYPTO_malloc(maxlen + 1, file, line);
+    if (ret) {
+        memcpy(ret, str, maxlen);
+        ret[maxlen] = '\0';
+    }
+    return ret;
+}
+
+void *CRYPTO_memdup(const void *data, size_t siz, const char* file, int line)
+{
+    void *ret;
+
+    if (data == NULL || siz &gt;= INT_MAX)
+        return NULL;
+
+    ret = CRYPTO_malloc(siz, file, line);
+    if (ret == NULL) {
+        CRYPTOerr(CRYPTO_F_CRYPTO_MEMDUP, ERR_R_MALLOC_FAILURE);
+        return NULL;
+    }
+    return memcpy(ret, data, siz);
+}
+
+size_t OPENSSL_strnlen(const char *str, size_t maxlen)
+{
+    const char *p;
+
+    for (p = str; maxlen-- != 0 &amp;&amp; *p != '\0'; ++p) ;
+
+    return p - str;
+}
+
+size_t OPENSSL_strlcpy(char *dst, const char *src, size_t size)
+{
+    size_t l = 0;
+    for (; size &gt; 1 &amp;&amp; *src; size--) {
+        *dst++ = *src++;
+        l++;
+    }
+    if (size)
+        *dst = '\0';
+    return l + strlen(src);
+}
+
+size_t OPENSSL_strlcat(char *dst, const char *src, size_t size)
+{
+    size_t l = 0;
+    for (; size &gt; 0 &amp;&amp; *dst; size--, dst++)
+        l++;
+    return l + OPENSSL_strlcpy(dst, src, size);
+}
diff --git a/crypto/objects/obj_dat.c b/crypto/objects/obj_dat.c
index e8a6b13..bda9556 100644
--- a/crypto/objects/obj_dat.c
+++ b/crypto/objects/obj_dat.c
@@ -484,7 +484,7 @@ int OBJ_obj2txt(char *buf, int buf_len, const ASN1_OBJECT *a, int no_name)
             s = OBJ_nid2sn(nid);
         if (s) {
             if (buf)
-                BUF_strlcpy(buf, s, buf_len);
+                OPENSSL_strlcpy(buf, s, buf_len);
             n = strlen(s);
             return n;
         }
@@ -558,7 +558,7 @@ int OBJ_obj2txt(char *buf, int buf_len, const ASN1_OBJECT *a, int no_name)
                     *buf = '\0';
                     buf_len--;
                 }
-                BUF_strlcpy(buf, bndec, buf_len);
+                OPENSSL_strlcpy(buf, bndec, buf_len);
                 if (i &gt; buf_len) {
                     buf += buf_len;
                     buf_len = 0;
@@ -574,7 +574,7 @@ int OBJ_obj2txt(char *buf, int buf_len, const ASN1_OBJECT *a, int no_name)
             BIO_snprintf(tbuf, sizeof tbuf, &quot;.%lu&quot;, l);
             i = strlen(tbuf);
             if (buf &amp;&amp; (buf_len &gt; 0)) {
-                BUF_strlcpy(buf, tbuf, buf_len);
+                OPENSSL_strlcpy(buf, tbuf, buf_len);
                 if (i &gt; buf_len) {
                     buf += buf_len;
                     buf_len = 0;
diff --git a/crypto/ocsp/ocsp_lib.c b/crypto/ocsp/ocsp_lib.c
index 9784294..092cc37 100644
--- a/crypto/ocsp/ocsp_lib.c
+++ b/crypto/ocsp/ocsp_lib.c
@@ -183,7 +183,7 @@ int OCSP_parse_url(const char *url, char **phost, char **pport, char **ppath,
     *ppath = NULL;
 
     /* dup the buffer since we are going to mess with it */
-    buf = BUF_strdup(url);
+    buf = OPENSSL_strdup(url);
     if (!buf)
         goto mem_err;
 
@@ -217,9 +217,9 @@ int OCSP_parse_url(const char *url, char **phost, char **pport, char **ppath,
     p = strchr(p, '/');
 
     if (!p)
-        *ppath = BUF_strdup(&quot;/&quot;);
+        *ppath = OPENSSL_strdup(&quot;/&quot;);
     else {
-        *ppath = BUF_strdup(p);
+        *ppath = OPENSSL_strdup(p);
         /* Set start of path to 0 so hostname is valid */
         *p = '\0';
     }
@@ -244,11 +244,11 @@ int OCSP_parse_url(const char *url, char **phost, char **pport, char **ppath,
         port = p + 1;
     }
 
-    *pport = BUF_strdup(port);
+    *pport = OPENSSL_strdup(port);
     if (!*pport)
         goto mem_err;
 
-    *phost = BUF_strdup(host);
+    *phost = OPENSSL_strdup(host);
 
     if (!*phost)
         goto mem_err;
diff --git a/crypto/pem/pem_lib.c b/crypto/pem/pem_lib.c
index 42a8583..465e2ee 100644
--- a/crypto/pem/pem_lib.c
+++ b/crypto/pem/pem_lib.c
@@ -134,9 +134,9 @@ void PEM_proc_type(char *buf, int type)
     else
         str = &quot;BAD-TYPE&quot;;
 
-    BUF_strlcat(buf, &quot;Proc-Type: 4,&quot;, PEM_BUFSIZE);
-    BUF_strlcat(buf, str, PEM_BUFSIZE);
-    BUF_strlcat(buf, &quot;\n&quot;, PEM_BUFSIZE);
+    OPENSSL_strlcat(buf, &quot;Proc-Type: 4,&quot;, PEM_BUFSIZE);
+    OPENSSL_strlcat(buf, str, PEM_BUFSIZE);
+    OPENSSL_strlcat(buf, &quot;\n&quot;, PEM_BUFSIZE);
 }
 
 void PEM_dek_info(char *buf, const char *type, int len, char *str)
@@ -145,9 +145,9 @@ void PEM_dek_info(char *buf, const char *type, int len, char *str)
     long i;
     int j;
 
-    BUF_strlcat(buf, &quot;DEK-Info: &quot;, PEM_BUFSIZE);
-    BUF_strlcat(buf, type, PEM_BUFSIZE);
-    BUF_strlcat(buf, &quot;,&quot;, PEM_BUFSIZE);
+    OPENSSL_strlcat(buf, &quot;DEK-Info: &quot;, PEM_BUFSIZE);
+    OPENSSL_strlcat(buf, type, PEM_BUFSIZE);
+    OPENSSL_strlcat(buf, &quot;,&quot;, PEM_BUFSIZE);
     j = strlen(buf);
     if (j + (len * 2) + 1 &gt; PEM_BUFSIZE)
         return;
diff --git a/crypto/rand/Makefile b/crypto/rand/Makefile
index adcbb82..bc8c624 100644
--- a/crypto/rand/Makefile
+++ b/crypto/rand/Makefile
@@ -72,9 +72,11 @@ md_rand.o: ../../include/openssl/opensslv.h ../../include/openssl/ossl_typ.h
 md_rand.o: ../../include/openssl/rand.h ../../include/openssl/safestack.h
 md_rand.o: ../../include/openssl/sha.h ../../include/openssl/stack.h
 md_rand.o: ../../include/openssl/symhacks.h md_rand.c rand_lcl.h
-rand_egd.o: ../../include/openssl/buffer.h ../../include/openssl/e_os2.h
+rand_egd.o: ../../include/openssl/crypto.h ../../include/openssl/e_os2.h
 rand_egd.o: ../../include/openssl/opensslconf.h
-rand_egd.o: ../../include/openssl/ossl_typ.h ../../include/openssl/rand.h
+rand_egd.o: ../../include/openssl/opensslv.h ../../include/openssl/ossl_typ.h
+rand_egd.o: ../../include/openssl/rand.h ../../include/openssl/safestack.h
+rand_egd.o: ../../include/openssl/stack.h ../../include/openssl/symhacks.h
 rand_egd.o: rand_egd.c
 rand_err.o: ../../include/openssl/bio.h ../../include/openssl/crypto.h
 rand_err.o: ../../include/openssl/e_os2.h ../../include/openssl/err.h
diff --git a/crypto/rand/rand_egd.c b/crypto/rand/rand_egd.c
index d062dd6..ea3621c 100644
--- a/crypto/rand/rand_egd.c
+++ b/crypto/rand/rand_egd.c
@@ -54,9 +54,9 @@
  *
  */
 
+#include &lt;openssl/crypto.h&gt;
 #include &lt;openssl/e_os2.h&gt;
 #include &lt;openssl/rand.h&gt;
-#include &lt;openssl/buffer.h&gt;
 
 /*-
  * Query the EGD &lt;URL: <A HREF="http://www.lothar.com/tech/crypto/">http://www.lothar.com/tech/crypto/</A>&gt;.
@@ -144,7 +144,7 @@ int RAND_query_egd_bytes(const char *path, unsigned char *buf, int bytes)
     addr.sun_family = AF_UNIX;
     if (strlen(path) &gt;= sizeof(addr.sun_path))
         return (-1);
-    BUF_strlcpy(addr.sun_path, path, sizeof addr.sun_path);
+    OPENSSL_strlcpy(addr.sun_path, path, sizeof addr.sun_path);
     len = offsetof(struct sockaddr_un, sun_path) + strlen(path);
     fd = socket(AF_UNIX, SOCK_STREAM, 0);
     if (fd == -1)
diff --git a/crypto/rand/randfile.c b/crypto/rand/randfile.c
index e154646..a1b0c4d 100644
--- a/crypto/rand/randfile.c
+++ b/crypto/rand/randfile.c
@@ -294,7 +294,7 @@ const char *RAND_file_name(char *buf, size_t size)
     if (OPENSSL_issetugid() == 0)
         s = getenv(&quot;RANDFILE&quot;);
     if (s != NULL &amp;&amp; *s &amp;&amp; strlen(s) + 1 &lt; size) {
-        if (BUF_strlcpy(buf, s, size) &gt;= size)
+        if (OPENSSL_strlcpy(buf, s, size) &gt;= size)
             return NULL;
     } else {
         if (OPENSSL_issetugid() == 0)
@@ -305,11 +305,11 @@ const char *RAND_file_name(char *buf, size_t size)
         }
 #endif
         if (s &amp;&amp; *s &amp;&amp; strlen(s) + strlen(RFILE) + 2 &lt; size) {
-            BUF_strlcpy(buf, s, size);
+            OPENSSL_strlcpy(buf, s, size);
 #ifndef OPENSSL_SYS_VMS
-            BUF_strlcat(buf, &quot;/&quot;, size);
+            OPENSSL_strlcat(buf, &quot;/&quot;, size);
 #endif
-            BUF_strlcat(buf, RFILE, size);
+            OPENSSL_strlcat(buf, RFILE, size);
         } else
             buf[0] = '\0';      /* no file name */
     }
@@ -324,11 +324,11 @@ const char *RAND_file_name(char *buf, size_t size)
      */
 
     if (!buf[0])
-        if (BUF_strlcpy(buf, &quot;/dev/arandom&quot;, size) &gt;= size) {
+        if (OPENSSL_strlcpy(buf, &quot;/dev/arandom&quot;, size) &gt;= size) {
             return (NULL);
         }
     if (stat(buf, &amp;sb) == -1)
-        if (BUF_strlcpy(buf, &quot;/dev/arandom&quot;, size) &gt;= size) {
+        if (OPENSSL_strlcpy(buf, &quot;/dev/arandom&quot;, size) &gt;= size) {
             return (NULL);
         }
 #endif
diff --git a/crypto/rsa/rsa_pmeth.c b/crypto/rsa/rsa_pmeth.c
index 8c8e0e8..f5f8c1f 100644
--- a/crypto/rsa/rsa_pmeth.c
+++ b/crypto/rsa/rsa_pmeth.c
@@ -128,7 +128,7 @@ static int pkey_rsa_copy(EVP_PKEY_CTX *dst, EVP_PKEY_CTX *src)
     dctx-&gt;mgf1md = sctx-&gt;mgf1md;
     if (sctx-&gt;oaep_label) {
         OPENSSL_free(dctx-&gt;oaep_label);
-        dctx-&gt;oaep_label = BUF_memdup(sctx-&gt;oaep_label, sctx-&gt;oaep_labellen);
+        dctx-&gt;oaep_label = OPENSSL_memdup(sctx-&gt;oaep_label, sctx-&gt;oaep_labellen);
         if (!dctx-&gt;oaep_label)
             return 0;
         dctx-&gt;oaep_labellen = sctx-&gt;oaep_labellen;
diff --git a/crypto/srp/srp_vfy.c b/crypto/srp/srp_vfy.c
index 1be68f2..65c763c 100644
--- a/crypto/srp/srp_vfy.c
+++ b/crypto/srp/srp_vfy.c
@@ -220,9 +220,9 @@ static void SRP_user_pwd_set_gN(SRP_user_pwd *vinfo, const BIGNUM *g,
 static int SRP_user_pwd_set_ids(SRP_user_pwd *vinfo, const char *id,
                                 const char *info)
 {
-    if (id != NULL &amp;&amp; NULL == (vinfo-&gt;id = BUF_strdup(id)))
+    if (id != NULL &amp;&amp; NULL == (vinfo-&gt;id = OPENSSL_strdup(id)))
         return 0;
-    return (info == NULL || NULL != (vinfo-&gt;info = BUF_strdup(info)));
+    return (info == NULL || NULL != (vinfo-&gt;info = OPENSSL_strdup(info)));
 }
 
 static int SRP_user_pwd_set_sv(SRP_user_pwd *vinfo, const char *s,
@@ -261,7 +261,7 @@ SRP_VBASE *SRP_VBASE_new(char *seed_key)
     vb-&gt;default_g = NULL;
     vb-&gt;default_N = NULL;
     vb-&gt;seed_key = NULL;
-    if ((seed_key != NULL) &amp;&amp; (vb-&gt;seed_key = BUF_strdup(seed_key)) == NULL) {
+    if ((seed_key != NULL) &amp;&amp; (vb-&gt;seed_key = OPENSSL_strdup(seed_key)) == NULL) {
         sk_SRP_user_pwd_free(vb-&gt;users_pwd);
         sk_SRP_gN_cache_free(vb-&gt;gN_cache);
         OPENSSL_free(vb);
@@ -289,7 +289,7 @@ static SRP_gN_cache *SRP_gN_new_init(const char *ch)
     if (newgN == NULL)
         return NULL;
 
-    if ((newgN-&gt;b64_bn = BUF_strdup(ch)) == NULL)
+    if ((newgN-&gt;b64_bn = OPENSSL_strdup(ch)) == NULL)
         goto err;
 
     len = t_fromb64(tmp, ch);
@@ -394,7 +394,7 @@ int SRP_VBASE_init(SRP_VBASE *vb, char *verifier_file)
             if ((gN = OPENSSL_malloc(sizeof(*gN))) == NULL)
                 goto err;
 
-            if ((gN-&gt;id = BUF_strdup(pp[DB_srpid])) == NULL
+            if ((gN-&gt;id = OPENSSL_strdup(pp[DB_srpid])) == NULL
                 || (gN-&gt;N = SRP_gN_place_bn(vb-&gt;gN_cache, pp[DB_srpverifier]))
                         == NULL
                 || (gN-&gt;g = SRP_gN_place_bn(vb-&gt;gN_cache, pp[DB_srpsalt]))
diff --git a/crypto/store/str_lib.c b/crypto/store/str_lib.c
index d5ecdbd..301d0c0 100644
--- a/crypto/store/str_lib.c
+++ b/crypto/store/str_lib.c
@@ -1305,7 +1305,7 @@ int STORE_ATTR_INFO_set_cstr(STORE_ATTR_INFO *attrs, STORE_ATTR_TYPES code,
         return 0;
     }
     if (!ATTR_IS_SET(attrs, code)) {
-        if ((attrs-&gt;values[code].cstring = BUF_strndup(cstr, cstr_size)))
+        if ((attrs-&gt;values[code].cstring = OPENSSL_strndup(cstr, cstr_size)))
             return 1;
         STOREerr(STORE_F_STORE_ATTR_INFO_SET_CSTR, ERR_R_MALLOC_FAILURE);
         return 0;
@@ -1324,7 +1324,7 @@ int STORE_ATTR_INFO_set_sha1str(STORE_ATTR_INFO *attrs, STORE_ATTR_TYPES code,
     }
     if (!ATTR_IS_SET(attrs, code)) {
         if ((attrs-&gt;values[code].sha1string =
-             (unsigned char *)BUF_memdup(sha1str, sha1str_size)))
+             (unsigned char *)OPENSSL_memdup(sha1str, sha1str_size)))
             return 1;
         STOREerr(STORE_F_STORE_ATTR_INFO_SET_SHA1STR, ERR_R_MALLOC_FAILURE);
         return 0;
diff --git a/crypto/store/str_meth.c b/crypto/store/str_meth.c
index f9ce8bb..5e0f4bd 100644
--- a/crypto/store/str_meth.c
+++ b/crypto/store/str_meth.c
@@ -66,7 +66,7 @@ STORE_METHOD *STORE_create_method(char *name)
     STORE_METHOD *store_method = OPENSSL_zalloc(sizeof(*store_method));
 
     if (store_method != NULL)
-        store_method-&gt;name = BUF_strdup(name);
+        store_method-&gt;name = OPENSSL_strdup(name);
     return store_method;
 }
 
diff --git a/crypto/ui/ui_lib.c b/crypto/ui/ui_lib.c
index d2ac28b..ea3ec13 100644
--- a/crypto/ui/ui_lib.c
+++ b/crypto/ui/ui_lib.c
@@ -238,7 +238,7 @@ int UI_dup_input_string(UI *ui, const char *prompt, int flags,
     char *prompt_copy = NULL;
 
     if (prompt) {
-        prompt_copy = BUF_strdup(prompt);
+        prompt_copy = OPENSSL_strdup(prompt);
         if (prompt_copy == NULL) {
             UIerr(UI_F_UI_DUP_INPUT_STRING, ERR_R_MALLOC_FAILURE);
             return 0;
@@ -266,7 +266,7 @@ int UI_dup_verify_string(UI *ui, const char *prompt, int flags,
     char *prompt_copy = NULL;
 
     if (prompt) {
-        prompt_copy = BUF_strdup(prompt);
+        prompt_copy = OPENSSL_strdup(prompt);
         if (prompt_copy == NULL) {
             UIerr(UI_F_UI_DUP_VERIFY_STRING, ERR_R_MALLOC_FAILURE);
             return -1;
@@ -297,7 +297,7 @@ int UI_dup_input_boolean(UI *ui, const char *prompt, const char *action_desc,
     char *cancel_chars_copy = NULL;
 
     if (prompt) {
-        prompt_copy = BUF_strdup(prompt);
+        prompt_copy = OPENSSL_strdup(prompt);
         if (prompt_copy == NULL) {
             UIerr(UI_F_UI_DUP_INPUT_BOOLEAN, ERR_R_MALLOC_FAILURE);
             goto err;
@@ -305,7 +305,7 @@ int UI_dup_input_boolean(UI *ui, const char *prompt, const char *action_desc,
     }
 
     if (action_desc) {
-        action_desc_copy = BUF_strdup(action_desc);
+        action_desc_copy = OPENSSL_strdup(action_desc);
         if (action_desc_copy == NULL) {
             UIerr(UI_F_UI_DUP_INPUT_BOOLEAN, ERR_R_MALLOC_FAILURE);
             goto err;
@@ -313,7 +313,7 @@ int UI_dup_input_boolean(UI *ui, const char *prompt, const char *action_desc,
     }
 
     if (ok_chars) {
-        ok_chars_copy = BUF_strdup(ok_chars);
+        ok_chars_copy = OPENSSL_strdup(ok_chars);
         if (ok_chars_copy == NULL) {
             UIerr(UI_F_UI_DUP_INPUT_BOOLEAN, ERR_R_MALLOC_FAILURE);
             goto err;
@@ -321,7 +321,7 @@ int UI_dup_input_boolean(UI *ui, const char *prompt, const char *action_desc,
     }
 
     if (cancel_chars) {
-        cancel_chars_copy = BUF_strdup(cancel_chars);
+        cancel_chars_copy = OPENSSL_strdup(cancel_chars);
         if (cancel_chars_copy == NULL) {
             UIerr(UI_F_UI_DUP_INPUT_BOOLEAN, ERR_R_MALLOC_FAILURE);
             goto err;
@@ -350,7 +350,7 @@ int UI_dup_info_string(UI *ui, const char *text)
     char *text_copy = NULL;
 
     if (text) {
-        text_copy = BUF_strdup(text);
+        text_copy = OPENSSL_strdup(text);
         if (text_copy == NULL) {
             UIerr(UI_F_UI_DUP_INFO_STRING, ERR_R_MALLOC_FAILURE);
             return -1;
@@ -372,7 +372,7 @@ int UI_dup_error_string(UI *ui, const char *text)
     char *text_copy = NULL;
 
     if (text) {
-        text_copy = BUF_strdup(text);
+        text_copy = OPENSSL_strdup(text);
         if (text_copy == NULL) {
             UIerr(UI_F_UI_DUP_ERROR_STRING, ERR_R_MALLOC_FAILURE);
             return -1;
@@ -405,13 +405,13 @@ char *UI_construct_prompt(UI *ui, const char *object_desc,
         prompt = OPENSSL_malloc(len + 1);
         if (prompt == NULL)
             return NULL;
-        BUF_strlcpy(prompt, prompt1, len + 1);
-        BUF_strlcat(prompt, object_desc, len + 1);
+        OPENSSL_strlcpy(prompt, prompt1, len + 1);
+        OPENSSL_strlcat(prompt, object_desc, len + 1);
         if (object_name) {
-            BUF_strlcat(prompt, prompt2, len + 1);
-            BUF_strlcat(prompt, object_name, len + 1);
+            OPENSSL_strlcat(prompt, prompt2, len + 1);
+            OPENSSL_strlcat(prompt, object_name, len + 1);
         }
-        BUF_strlcat(prompt, prompt3, len + 1);
+        OPENSSL_strlcat(prompt, prompt3, len + 1);
     }
     return prompt;
 }
@@ -575,7 +575,7 @@ UI_METHOD *UI_create_method(char *name)
     UI_METHOD *ui_method = OPENSSL_zalloc(sizeof(*ui_method));
 
     if (ui_method != NULL)
-        ui_method-&gt;name = BUF_strdup(name);
+        ui_method-&gt;name = OPENSSL_strdup(name);
     return ui_method;
 }
 
@@ -822,7 +822,7 @@ int UI_set_result(UI *ui, UI_STRING *uis, const char *result)
             return -1;
         }
 
-        BUF_strlcpy(uis-&gt;result_buf, result,
+        OPENSSL_strlcpy(uis-&gt;result_buf, result,
                     uis-&gt;_.string_data.result_maxsize + 1);
         break;
     case UIT_BOOLEAN:
diff --git a/crypto/x509/x509_trs.c b/crypto/x509/x509_trs.c
index 6e3616e..27ee475 100644
--- a/crypto/x509/x509_trs.c
+++ b/crypto/x509/x509_trs.c
@@ -201,7 +201,7 @@ int X509_TRUST_add(int id, int flags, int (*ck) (X509_TRUST *, X509 *, int),
     if (trtmp-&gt;flags &amp; X509_TRUST_DYNAMIC_NAME)
         OPENSSL_free(trtmp-&gt;name);
     /* dup supplied name */
-    if ((trtmp-&gt;name = BUF_strdup(name)) == NULL) {
+    if ((trtmp-&gt;name = OPENSSL_strdup(name)) == NULL) {
         X509err(X509_F_X509_TRUST_ADD, ERR_R_MALLOC_FAILURE);
         return 0;
     }
diff --git a/crypto/x509/x509_vpm.c b/crypto/x509/x509_vpm.c
index 0188114..2a15f82 100644
--- a/crypto/x509/x509_vpm.c
+++ b/crypto/x509/x509_vpm.c
@@ -106,7 +106,7 @@ static int int_x509_param_set_hosts(X509_VERIFY_PARAM *vpm, int mode,
     if (name == NULL || namelen == 0)
         return 1;
 
-    copy = BUF_strndup(name, namelen);
+    copy = OPENSSL_strndup(name, namelen);
     if (copy == NULL)
         return 0;
 
@@ -308,10 +308,10 @@ static int int_x509_param_set1(char **pdest, size_t *pdestlen,
     void *tmp;
     if (src) {
         if (srclen == 0) {
-            tmp = BUF_strdup(src);
+            tmp = OPENSSL_strdup(src);
             srclen = strlen(src);
         } else
-            tmp = BUF_memdup(src, srclen);
+            tmp = OPENSSL_memdup(src, srclen);
         if (!tmp)
             return 0;
     } else {
@@ -328,7 +328,7 @@ static int int_x509_param_set1(char **pdest, size_t *pdestlen,
 int X509_VERIFY_PARAM_set1_name(X509_VERIFY_PARAM *param, const char *name)
 {
     OPENSSL_free(param-&gt;name);
-    param-&gt;name = BUF_strdup(name);
+    param-&gt;name = OPENSSL_strdup(name);
     if (param-&gt;name)
         return 1;
     return 0;
diff --git a/crypto/x509v3/v3_addr.c b/crypto/x509v3/v3_addr.c
index f4a3bcb..13aa7a8 100644
--- a/crypto/x509v3/v3_addr.c
+++ b/crypto/x509v3/v3_addr.c
@@ -980,7 +980,7 @@ static void *v2i_IPAddrBlocks(const struct v3_ext_method *method,
         length = length_from_afi(afi);
 
         /*
-         * Handle SAFI, if any, and BUF_strdup() so we can null-terminate
+         * Handle SAFI, if any, and OPENSSL_strdup() so we can null-terminate
          * the other input values.
          */
         if (safi != NULL) {
@@ -992,9 +992,9 @@ static void *v2i_IPAddrBlocks(const struct v3_ext_method *method,
                 goto err;
             }
             t += strspn(t, &quot; \t&quot;);
-            s = BUF_strdup(t);
+            s = OPENSSL_strdup(t);
         } else {
-            s = BUF_strdup(val-&gt;value);
+            s = OPENSSL_strdup(val-&gt;value);
         }
         if (s == NULL) {
             X509V3err(X509V3_F_V2I_IPADDRBLOCKS, ERR_R_MALLOC_FAILURE);
diff --git a/crypto/x509v3/v3_asid.c b/crypto/x509v3/v3_asid.c
index af527eb..3e10d7e 100644
--- a/crypto/x509v3/v3_asid.c
+++ b/crypto/x509v3/v3_asid.c
@@ -619,7 +619,7 @@ static void *v2i_ASIdentifiers(const struct v3_ext_method *method,
                 goto err;
             }
         } else {
-            char *s = BUF_strdup(val-&gt;value);
+            char *s = OPENSSL_strdup(val-&gt;value);
             if (s == NULL) {
                 X509V3err(X509V3_F_V2I_ASIDENTIFIERS, ERR_R_MALLOC_FAILURE);
                 goto err;
diff --git a/crypto/x509v3/v3_enum.c b/crypto/x509v3/v3_enum.c
index d2f895d..dcdd0c6 100644
--- a/crypto/x509v3/v3_enum.c
+++ b/crypto/x509v3/v3_enum.c
@@ -95,7 +95,7 @@ char *i2s_ASN1_ENUMERATED_TABLE(X509V3_EXT_METHOD *method, ASN1_ENUMERATED *e)
     strval = ASN1_ENUMERATED_get(e);
     for (enam = method-&gt;usr_data; enam-&gt;lname; enam++) {
         if (strval == enam-&gt;bitnum)
-            return BUF_strdup(enam-&gt;lname);
+            return OPENSSL_strdup(enam-&gt;lname);
     }
     return i2s_ASN1_ENUMERATED(method, e);
 }
diff --git a/crypto/x509v3/v3_info.c b/crypto/x509v3/v3_info.c
index 4e38ad3..f8888c2 100644
--- a/crypto/x509v3/v3_info.c
+++ b/crypto/x509v3/v3_info.c
@@ -131,9 +131,9 @@ static STACK_OF(CONF_VALUE) *i2v_AUTHORITY_INFO_ACCESS(X509V3_EXT_METHOD
                       ERR_R_MALLOC_FAILURE);
             return NULL;
         }
-        BUF_strlcpy(ntmp, objtmp, nlen);
-        BUF_strlcat(ntmp, &quot; - &quot;, nlen);
-        BUF_strlcat(ntmp, vtmp-&gt;name, nlen);
+        OPENSSL_strlcpy(ntmp, objtmp, nlen);
+        OPENSSL_strlcat(ntmp, &quot; - &quot;, nlen);
+        OPENSSL_strlcat(ntmp, vtmp-&gt;name, nlen);
         OPENSSL_free(vtmp-&gt;name);
         vtmp-&gt;name = ntmp;
 
diff --git a/crypto/x509v3/v3_purp.c b/crypto/x509v3/v3_purp.c
index 90b3abc..3724e66 100644
--- a/crypto/x509v3/v3_purp.c
+++ b/crypto/x509v3/v3_purp.c
@@ -225,8 +225,8 @@ int X509_PURPOSE_add(int id, int trust, int flags,
         OPENSSL_free(ptmp-&gt;sname);
     }
     /* dup supplied name */
-    ptmp-&gt;name = BUF_strdup(name);
-    ptmp-&gt;sname = BUF_strdup(sname);
+    ptmp-&gt;name = OPENSSL_strdup(name);
+    ptmp-&gt;sname = OPENSSL_strdup(sname);
     if (!ptmp-&gt;name || !ptmp-&gt;sname) {
         X509V3err(X509V3_F_X509_PURPOSE_ADD, ERR_R_MALLOC_FAILURE);
         return 0;
diff --git a/crypto/x509v3/v3_utl.c b/crypto/x509v3/v3_utl.c
index 8481749..c9e74f4 100644
--- a/crypto/x509v3/v3_utl.c
+++ b/crypto/x509v3/v3_utl.c
@@ -86,9 +86,9 @@ int X509V3_add_value(const char *name, const char *value,
     CONF_VALUE *vtmp = NULL;
     char *tname = NULL, *tvalue = NULL;
 
-    if (name &amp;&amp; (tname = BUF_strdup(name)) == NULL)
+    if (name &amp;&amp; (tname = OPENSSL_strdup(name)) == NULL)
         goto err;
-    if (value &amp;&amp; (tvalue = BUF_strdup(value)) == NULL)
+    if (value &amp;&amp; (tvalue = OPENSSL_strdup(value)) == NULL)
         goto err;
     if ((vtmp = OPENSSL_malloc(sizeof(*vtmp))) == NULL)
         goto err;
@@ -296,7 +296,7 @@ STACK_OF(CONF_VALUE) *X509V3_parse_list(const char *line)
     char *linebuf;
     int state;
     /* We are going to modify the line so copy it first */
-    linebuf = BUF_strdup(line);
+    linebuf = OPENSSL_strdup(line);
     if (linebuf == NULL) {
         X509V3err(X509V3_F_X509V3_PARSE_LIST, ERR_R_MALLOC_FAILURE);
         goto err;
@@ -617,7 +617,7 @@ static int append_ia5(STACK_OF(OPENSSL_STRING) **sk, ASN1_IA5STRING *email)
     /* Don't add duplicates */
     if (sk_OPENSSL_STRING_find(*sk, (char *)email-&gt;data) != -1)
         return 1;
-    emtmp = BUF_strdup((char *)email-&gt;data);
+    emtmp = OPENSSL_strdup((char *)email-&gt;data);
     if (emtmp == NULL || !sk_OPENSSL_STRING_push(*sk, emtmp)) {
         X509_email_free(*sk);
         *sk = NULL;
@@ -899,7 +899,7 @@ static int do_check_string(ASN1_STRING *a, int cmp_type, equal_fn equal,
         else if (a-&gt;length == (int)blen &amp;&amp; !memcmp(a-&gt;data, b, blen))
             rv = 1;
         if (rv &gt; 0 &amp;&amp; peername)
-            *peername = BUF_strndup((char *)a-&gt;data, a-&gt;length);
+            *peername = OPENSSL_strndup((char *)a-&gt;data, a-&gt;length);
     } else {
         int astrlen;
         unsigned char *astr;
@@ -913,7 +913,7 @@ static int do_check_string(ASN1_STRING *a, int cmp_type, equal_fn equal,
         }
         rv = equal(astr, astrlen, (unsigned char *)b, blen, flags);
         if (rv &gt; 0 &amp;&amp; peername)
-            *peername = BUF_strndup((char *)astr, astrlen);
+            *peername = OPENSSL_strndup((char *)astr, astrlen);
         OPENSSL_free(astr);
     }
     return rv;
@@ -1099,7 +1099,7 @@ ASN1_OCTET_STRING *a2i_IPADDRESS_NC(const char *ipasc)
     p = strchr(ipasc, '/');
     if (!p)
         return NULL;
-    iptmp = BUF_strdup(ipasc);
+    iptmp = OPENSSL_strdup(ipasc);
     if (!iptmp)
         return NULL;
     p = iptmp + (p - ipasc);
diff --git a/doc/crypto/buffer.pod b/doc/crypto/buffer.pod
index 1351635..a2543e8 100644
--- a/doc/crypto/buffer.pod
+++ b/doc/crypto/buffer.pod
@@ -5,7 +5,6 @@
 BUF_MEM_new, BUF_MEM_new_ex, BUF_MEM_free, BUF_MEM_grow - simple
 character array structure
 
-BUF_strdup, BUF_strndup, BUF_memdup, BUF_strlcpy, BUF_strlcat -
 standard C library equivalents
 
 =head1 SYNOPSIS
@@ -22,18 +21,6 @@ standard C library equivalents
 
  int	BUF_MEM_grow(BUF_MEM *str, int len);
 
- char *BUF_strdup(const char *str);
-
- char *BUF_strndup(const char *str, size_t siz);
-
- void *BUF_memdup(const void *data, size_t siz);
-
- size_t BUF_strlcpy(char *dst, const char *src, size_t size);
-
- size_t BUF_strlcat(char *dst, const char *src, size_t size);
-
- size_t BUF_strnlen(const char *str, size_t maxlen);
-
 =head1 DESCRIPTION
 
 The buffer library handles simple character arrays. Buffers are used for
@@ -52,18 +39,6 @@ BUF_MEM_grow() changes the size of an already existing buffer to
 B&lt;len&gt;. Any data already in the buffer is preserved if it increases in
 size.
 
-BUF_strdup(), BUF_strndup(), BUF_memdup(), BUF_strlcpy(),
-BUF_strlcat() and BUF_strnlen are equivalents of the standard C
-library functions. The dup() functions use OPENSSL_malloc() underneath
-and so should be used in preference to the standard library for memory
-leak checking or replacing the malloc() function.
-
-Memory allocated from these functions should be freed up using the
-OPENSSL_free() function.
-
-BUF_strndup makes the explicit guarantee that it will never read past
-the first B&lt;siz&gt; bytes of B&lt;str&gt;.
-
 =head1 RETURN VALUES
 
 BUF_MEM_new() returns the buffer or NULL on error.
diff --git a/engines/ccgost/gost_ctl.c b/engines/ccgost/gost_ctl.c
index 31b95a0..20a07df 100644
--- a/engines/ccgost/gost_ctl.c
+++ b/engines/ccgost/gost_ctl.c
@@ -67,7 +67,7 @@ const char *get_gost_engine_param(int param)
     tmp = getenv(gost_envnames[param]);
     if (tmp) {
         OPENSSL_free(gost_params[param]);
-        gost_params[param] = BUF_strdup(tmp);
+        gost_params[param] = OPENSSL_strdup(tmp);
         return gost_params[param];
     }
     return NULL;
@@ -85,7 +85,7 @@ int gost_set_default_param(int param, const char *value)
     if (!tmp)
         tmp = value;
     OPENSSL_free(gost_params[param]);
-    gost_params[param] = BUF_strdup(tmp);
+    gost_params[param] = OPENSSL_strdup(tmp);
 
     return 1;
 }
diff --git a/engines/e_capi.c b/engines/e_capi.c
index 1e41b26..8ef986f 100644
--- a/engines/e_capi.c
+++ b/engines/e_capi.c
@@ -361,7 +361,7 @@ static int capi_ctrl(ENGINE *e, int cmd, long i, void *p, void (*f) (void))
 
     case CAPI_CMD_STORE_NAME:
         OPENSSL_free(ctx-&gt;storename);
-        ctx-&gt;storename = BUF_strdup(p);
+        ctx-&gt;storename = OPENSSL_strdup(p);
         CAPI_trace(ctx, &quot;Setting store name to %s\n&quot;, p);
         break;
 
@@ -382,7 +382,7 @@ static int capi_ctrl(ENGINE *e, int cmd, long i, void *p, void (*f) (void))
         break;
 
     case CAPI_CMD_DEBUG_FILE:
-        ctx-&gt;debug_file = BUF_strdup(p);
+        ctx-&gt;debug_file = OPENSSL_strdup(p);
         CAPI_trace(ctx, &quot;Setting debug file to %s\n&quot;, ctx-&gt;debug_file);
         break;
 
@@ -1635,7 +1635,7 @@ static int capi_ctx_set_provname(CAPI_CTX * ctx, LPSTR pname, DWORD type,
         CryptReleaseContext(hprov, 0);
     }
     OPENSSL_free(ctx-&gt;cspname);
-    ctx-&gt;cspname = BUF_strdup(pname);
+    ctx-&gt;cspname = OPENSSL_strdup(pname);
     ctx-&gt;csptype = type;
     return 1;
 }
diff --git a/engines/e_chil.c b/engines/e_chil.c
index 8696c9a..924de8c 100644
--- a/engines/e_chil.c
+++ b/engines/e_chil.c
@@ -476,7 +476,7 @@ static const char *get_HWCRHK_LIBNAME(void)
 static long set_HWCRHK_LIBNAME(const char *name)
 {
     free_HWCRHK_LIBNAME();
-    return (((HWCRHK_LIBNAME = BUF_strdup(name)) != NULL) ? 1 : 0);
+    return (((HWCRHK_LIBNAME = OPENSSL_strdup(name)) != NULL) ? 1 : 0);
 }
 
 static const char *n_hwcrhk_Init = &quot;HWCryptoHook_Init&quot;;
diff --git a/engines/e_ubsec.c b/engines/e_ubsec.c
index eefd37f..f59dfa6 100644
--- a/engines/e_ubsec.c
+++ b/engines/e_ubsec.c
@@ -346,7 +346,7 @@ static void free_UBSEC_LIBNAME(void)
 static long set_UBSEC_LIBNAME(const char *name)
 {
     free_UBSEC_LIBNAME();
-    return (((UBSEC_LIBNAME = BUF_strdup(name)) != NULL) ? 1 : 0);
+    return (((UBSEC_LIBNAME = OPENSSL_strdup(name)) != NULL) ? 1 : 0);
 }
 
 static const char *UBSEC_F1 = &quot;ubsec_bytes_to_bits&quot;;
diff --git a/include/openssl/buffer.h b/include/openssl/buffer.h
index f22ed09..47d68f8 100644
--- a/include/openssl/buffer.h
+++ b/include/openssl/buffer.h
@@ -60,6 +60,10 @@
 # define HEADER_BUFFER_H
 
 # include &lt;openssl/ossl_typ.h&gt;
+# ifndef HEADER_CRYPTO_H
+#  include &lt;openssl/crypto.h&gt;
+# endif
+
 
 #ifdef  __cplusplus
 extern &quot;C&quot; {
@@ -71,9 +75,17 @@ extern &quot;C&quot; {
 #  include &lt;sys/types.h&gt;
 # endif
 
-/* Already declared in ossl_typ.h */
-/* typedef struct buf_mem_st BUF_MEM; */
-
+/*
+ * These names are outdated as of OpenSSL 1.1; a future release
+ * will move them to be deprecated.
+ */
+# define BUF_strdup(s) OPENSSL_strdup(s)
+# define BUF_strndup(s, size) OPENSSL_strndup(s, size)
+# define BUF_memdup(data, size) OPENSSL_memdup(data, size)
+# define BUF_strlcpy(dst, src, size)  OPENSSL_strlcpy(dst, src, size)
+# define BUF_strlcat(dst, src, size) OPENSSL_strlcat(dst, src, size)
+# define BUF_strnlen(str, maxlen) OPENSSL_strnlen(str, maxlen)
+ 
 struct buf_mem_st {
     size_t length;              /* current number of bytes */
     char *data;
@@ -88,22 +100,8 @@ BUF_MEM *BUF_MEM_new_ex(unsigned long flags);
 void BUF_MEM_free(BUF_MEM *a);
 size_t BUF_MEM_grow(BUF_MEM *str, size_t len);
 size_t BUF_MEM_grow_clean(BUF_MEM *str, size_t len);
-size_t BUF_strnlen(const char *str, size_t maxlen);
-char *BUF_strdup(const char *str);
-
-/*
- * Like strndup, but in addition, explicitly guarantees to never read past the
- * first |siz| bytes of |str|.
- */
-char *BUF_strndup(const char *str, size_t siz);
-
-void *BUF_memdup(const void *data, size_t siz);
 void BUF_reverse(unsigned char *out, unsigned char *in, size_t siz);
 
-/* safe string functions */
-size_t BUF_strlcpy(char *dst, const char *src, size_t siz);
-size_t BUF_strlcat(char *dst, const char *src, size_t siz);
-
 /* BEGIN ERROR CODES */
 /*
  * The following lines are auto generated by the script mkerr.pl. Any changes
@@ -114,12 +112,9 @@ void ERR_load_BUF_strings(void);
 /* Error codes for the BUF functions. */
 
 /* Function codes. */
-# define BUF_F_BUF_MEMDUP                                 103
 # define BUF_F_BUF_MEM_GROW                               100
 # define BUF_F_BUF_MEM_GROW_CLEAN                         105
 # define BUF_F_BUF_MEM_NEW                                101
-# define BUF_F_BUF_STRDUP                                 102
-# define BUF_F_BUF_STRNDUP                                104
 
 /* Reason codes. */
 
diff --git a/include/openssl/crypto.h b/include/openssl/crypto.h
index 78d86b1..977481b 100644
--- a/include/openssl/crypto.h
+++ b/include/openssl/crypto.h
@@ -319,18 +319,25 @@ int CRYPTO_is_mem_check_on(void);
 # define MemCheck_off()  CRYPTO_mem_ctrl(CRYPTO_MEM_CHECK_DISABLE)
 # define is_MemCheck_on() CRYPTO_is_mem_check_on()
 
-# define OPENSSL_malloc(num)     CRYPTO_malloc((int)num,__FILE__,__LINE__)
-# define OPENSSL_zalloc(num)     CRYPTO_zalloc((int)num,__FILE__,__LINE__)
-# define OPENSSL_strdup(str)     CRYPTO_strdup((str),__FILE__,__LINE__)
+# define OPENSSL_malloc(num)     CRYPTO_malloc((int)num, __FILE__, __LINE__)
+# define OPENSSL_zalloc(num)     CRYPTO_zalloc((int)num, __FILE__, __LINE__)
+# define OPENSSL_memdup(str, s)  CRYPTO_memdup((str), s, __FILE__, __LINE__)
+# define OPENSSL_strdup(str)     CRYPTO_strdup((str), __FILE__, __LINE__)
+# define OPENSSL_strndup(str, s) CRYPTO_strndup((str), (s), __FILE__, __LINE__)
 # define OPENSSL_realloc(addr,num) \
-        CRYPTO_realloc((char *)addr,(int)num,__FILE__,__LINE__)
+        CRYPTO_realloc((char *)addr, (int)num, __FILE__, __LINE__)
 # define OPENSSL_realloc_clean(addr,old_num,num) \
-        CRYPTO_realloc_clean(addr,old_num,num,__FILE__,__LINE__)
+        CRYPTO_realloc_clean(addr, old_num, num, __FILE__, __LINE__)
 # define OPENSSL_remalloc(addr,num) \
-        CRYPTO_remalloc((char **)addr,(int)num,__FILE__,__LINE__)
+        CRYPTO_remalloc((char **)addr, (int)num, __FILE__, __LINE__)
 # define OPENSSL_clear_free(addr, num) CRYPTO_clear_free(addr, num)
 # define OPENSSL_free(addr)      CRYPTO_free(addr)
 
+size_t OPENSSL_strlcpy(char *dst, const char *src, size_t siz);
+size_t OPENSSL_strlcpy(char *dst, const char *src, size_t siz);
+size_t OPENSSL_strlcat(char *dst, const char *src, size_t siz);
+size_t OPENSSL_strnlen(const char *str, size_t maxlen);
+
 # define OPENSSL_MALLOC_MAX_NELEMS(type)  (((1U&lt;&lt;(sizeof(int)*8-1))-1)/sizeof(type))
 
 unsigned long OpenSSL_version_num(void);
@@ -469,7 +476,9 @@ void CRYPTO_get_mem_debug_functions(void (**m)
 
 void *CRYPTO_malloc(int num, const char *file, int line);
 void *CRYPTO_zalloc(int num, const char *file, int line);
+void *CRYPTO_memdup(const void *str, size_t siz, const char *file, int line);
 char *CRYPTO_strdup(const char *str, const char *file, int line);
+char *CRYPTO_strndup(const char *str, size_t s, const char *file, int line);
 void CRYPTO_free(void *ptr);
 void CRYPTO_clear_free(void *ptr, size_t num);
 void *CRYPTO_realloc(void *addr, int num, const char *file, int line);
@@ -585,6 +594,7 @@ void ERR_load_CRYPTO_strings(void);
 # define CRYPTO_F_CRYPTO_GET_EX_NEW_INDEX                 100
 # define CRYPTO_F_CRYPTO_GET_NEW_DYNLOCKID                103
 # define CRYPTO_F_CRYPTO_GET_NEW_LOCKID                   101
+# define CRYPTO_F_CRYPTO_MEMDUP                           115
 # define CRYPTO_F_CRYPTO_NEW_EX_DATA                      112
 # define CRYPTO_F_CRYPTO_SET_EX_DATA                      102
 # define CRYPTO_F_DEF_ADD_INDEX                           104
diff --git a/ssl/packet_locl.h b/ssl/packet_locl.h
index cb61a93..c0ab825 100644
--- a/ssl/packet_locl.h
+++ b/ssl/packet_locl.h
@@ -408,8 +408,7 @@ __owur static inline int PACKET_memdup(const PACKET *pkt, unsigned char **data,
     if (length == 0)
         return 1;
 
-    *data = BUF_memdup(pkt-&gt;curr, length);
-
+    *data = OPENSSL_memdup(pkt-&gt;curr, length);
     if (*data == NULL)
         return 0;
 
@@ -432,7 +431,7 @@ __owur static inline int PACKET_strndup(const PACKET *pkt, char **data)
     OPENSSL_free(*data);
 
     /* This will succeed on an empty packet, unless pkt-&gt;curr == NULL. */
-    *data = BUF_strndup((const char*)pkt-&gt;curr, PACKET_remaining(pkt));
+    *data = OPENSSL_strndup((const char*)pkt-&gt;curr, PACKET_remaining(pkt));
     return (*data != NULL);
 }
 
diff --git a/ssl/s3_lib.c b/ssl/s3_lib.c
index a61ca62..54ba298 100644
--- a/ssl/s3_lib.c
+++ b/ssl/s3_lib.c
@@ -3836,7 +3836,7 @@ void ssl3_clear(SSL *s)
 #ifndef OPENSSL_NO_SRP
 static char *srp_password_from_info_cb(SSL *s, void *arg)
 {
-    return BUF_strdup(s-&gt;srp_ctx.info);
+    return OPENSSL_strdup(s-&gt;srp_ctx.info);
 }
 #endif
 
@@ -3940,7 +3940,7 @@ long ssl3_ctrl(SSL *s, int cmd, long larg, void *parg)
                 SSLerr(SSL_F_SSL3_CTRL, SSL_R_SSL3_EXT_INVALID_SERVERNAME);
                 return 0;
             }
-            if ((s-&gt;tlsext_hostname = BUF_strdup((char *)parg)) == NULL) {
+            if ((s-&gt;tlsext_hostname = OPENSSL_strdup((char *)parg)) == NULL) {
                 SSLerr(SSL_F_SSL3_CTRL, ERR_R_INTERNAL_ERROR);
                 return 0;
             }
@@ -4359,7 +4359,7 @@ long ssl3_ctx_ctrl(SSL_CTX *ctx, int cmd, long larg, void *parg)
             SSLerr(SSL_F_SSL3_CTX_CTRL, SSL_R_INVALID_SRP_USERNAME);
             return 0;
         }
-        if ((ctx-&gt;srp_ctx.login = BUF_strdup((char *)parg)) == NULL) {
+        if ((ctx-&gt;srp_ctx.login = OPENSSL_strdup((char *)parg)) == NULL) {
             SSLerr(SSL_F_SSL3_CTX_CTRL, ERR_R_INTERNAL_ERROR);
             return 0;
         }
diff --git a/ssl/ssl_asn1.c b/ssl/ssl_asn1.c
index 1d11b21..69c4d12 100644
--- a/ssl/ssl_asn1.c
+++ b/ssl/ssl_asn1.c
@@ -255,7 +255,7 @@ int i2d_SSL_SESSION(SSL_SESSION *in, unsigned char **pp)
 
 /* Utility functions for d2i_SSL_SESSION */
 
-/* BUF_strndup an OCTET STRING */
+/* OPENSSL_strndup an OCTET STRING */
 
 static int ssl_session_strndup(char **pdst, ASN1_OCTET_STRING *src)
 {
@@ -263,7 +263,7 @@ static int ssl_session_strndup(char **pdst, ASN1_OCTET_STRING *src)
     *pdst = NULL;
     if (src == NULL)
         return 1;
-    *pdst = BUF_strndup((char *)src-&gt;data, src-&gt;length);
+    *pdst = OPENSSL_strndup((char *)src-&gt;data, src-&gt;length);
     if (*pdst == NULL)
         return 0;
     return 1;
diff --git a/ssl/ssl_cert.c b/ssl/ssl_cert.c
index 80dc409..41e34ce 100644
--- a/ssl/ssl_cert.c
+++ b/ssl/ssl_cert.c
@@ -315,7 +315,7 @@ CERT *ssl_cert_dup(CERT *cert)
         goto err;
 #ifndef OPENSSL_NO_PSK
     if (cert-&gt;psk_identity_hint) {
-        ret-&gt;psk_identity_hint = BUF_strdup(cert-&gt;psk_identity_hint);
+        ret-&gt;psk_identity_hint = OPENSSL_strdup(cert-&gt;psk_identity_hint);
         if (ret-&gt;psk_identity_hint == NULL)
             goto err;
     }
diff --git a/ssl/ssl_conf.c b/ssl/ssl_conf.c
index ce52569..21aa265 100644
--- a/ssl/ssl_conf.c
+++ b/ssl/ssl_conf.c
@@ -368,7 +368,7 @@ static int cmd_Certificate(SSL_CONF_CTX *cctx, const char *value)
     if (rv &gt; 0 &amp;&amp; c &amp;&amp; cctx-&gt;flags &amp; SSL_CONF_FLAG_REQUIRE_PRIVATE) {
         char **pfilename = &amp;cctx-&gt;cert_filename[c-&gt;key - c-&gt;pkeys];
         OPENSSL_free(*pfilename);
-        *pfilename = BUF_strdup(value);
+        *pfilename = OPENSSL_strdup(value);
         if (!*pfilename)
             rv = 0;
     }
@@ -812,7 +812,7 @@ int SSL_CONF_CTX_set1_prefix(SSL_CONF_CTX *cctx, const char *pre)
 {
     char *tmp = NULL;
     if (pre) {
-        tmp = BUF_strdup(pre);
+        tmp = OPENSSL_strdup(pre);
         if (tmp == NULL)
             return 0;
     }
diff --git a/ssl/ssl_lib.c b/ssl/ssl_lib.c
index e9da27e..909b23e 100644
--- a/ssl/ssl_lib.c
+++ b/ssl/ssl_lib.c
@@ -344,8 +344,8 @@ SSL *SSL_new(SSL_CTX *ctx)
 # ifndef OPENSSL_NO_EC
     if (ctx-&gt;tlsext_ecpointformatlist) {
         s-&gt;tlsext_ecpointformatlist =
-            BUF_memdup(ctx-&gt;tlsext_ecpointformatlist,
-                       ctx-&gt;tlsext_ecpointformatlist_length);
+            OPENSSL_memdup(ctx-&gt;tlsext_ecpointformatlist,
+                           ctx-&gt;tlsext_ecpointformatlist_length);
         if (!s-&gt;tlsext_ecpointformatlist)
             goto err;
         s-&gt;tlsext_ecpointformatlist_length =
@@ -353,8 +353,8 @@ SSL *SSL_new(SSL_CTX *ctx)
     }
     if (ctx-&gt;tlsext_ellipticcurvelist) {
         s-&gt;tlsext_ellipticcurvelist =
-            BUF_memdup(ctx-&gt;tlsext_ellipticcurvelist,
-                       ctx-&gt;tlsext_ellipticcurvelist_length);
+            OPENSSL_memdup(ctx-&gt;tlsext_ellipticcurvelist,
+                           ctx-&gt;tlsext_ellipticcurvelist_length);
         if (!s-&gt;tlsext_ellipticcurvelist)
             goto err;
         s-&gt;tlsext_ellipticcurvelist_length =
@@ -3042,7 +3042,7 @@ int SSL_CTX_use_psk_identity_hint(SSL_CTX *ctx, const char *identity_hint)
     }
     OPENSSL_free(ctx-&gt;cert-&gt;psk_identity_hint);
     if (identity_hint != NULL) {
-        ctx-&gt;cert-&gt;psk_identity_hint = BUF_strdup(identity_hint);
+        ctx-&gt;cert-&gt;psk_identity_hint = OPENSSL_strdup(identity_hint);
         if (ctx-&gt;cert-&gt;psk_identity_hint == NULL)
             return 0;
     } else
@@ -3061,7 +3061,7 @@ int SSL_use_psk_identity_hint(SSL *s, const char *identity_hint)
     }
     OPENSSL_free(s-&gt;cert-&gt;psk_identity_hint);
     if (identity_hint != NULL) {
-        s-&gt;cert-&gt;psk_identity_hint = BUF_strdup(identity_hint);
+        s-&gt;cert-&gt;psk_identity_hint = OPENSSL_strdup(identity_hint);
         if (s-&gt;cert-&gt;psk_identity_hint == NULL)
             return 0;
     } else
diff --git a/ssl/ssl_sess.c b/ssl/ssl_sess.c
index aff615e..baf846d 100644
--- a/ssl/ssl_sess.c
+++ b/ssl/ssl_sess.c
@@ -249,13 +249,13 @@ SSL_SESSION *ssl_session_dup(SSL_SESSION *src, int ticket)
 
 #ifndef OPENSSL_NO_PSK
     if (src-&gt;psk_identity_hint) {
-        dest-&gt;psk_identity_hint = BUF_strdup(src-&gt;psk_identity_hint);
+        dest-&gt;psk_identity_hint = OPENSSL_strdup(src-&gt;psk_identity_hint);
         if (dest-&gt;psk_identity_hint == NULL) {
             goto err;
         }
     }
     if (src-&gt;psk_identity) {
-        dest-&gt;psk_identity = BUF_strdup(src-&gt;psk_identity);
+        dest-&gt;psk_identity = OPENSSL_strdup(src-&gt;psk_identity);
         if (dest-&gt;psk_identity == NULL) {
             goto err;
         }
@@ -274,7 +274,7 @@ SSL_SESSION *ssl_session_dup(SSL_SESSION *src, int ticket)
     }
 
     if (src-&gt;tlsext_hostname) {
-        dest-&gt;tlsext_hostname = BUF_strdup(src-&gt;tlsext_hostname);
+        dest-&gt;tlsext_hostname = OPENSSL_strdup(src-&gt;tlsext_hostname);
         if (dest-&gt;tlsext_hostname == NULL) {
             goto err;
         }
@@ -282,14 +282,14 @@ SSL_SESSION *ssl_session_dup(SSL_SESSION *src, int ticket)
 #ifndef OPENSSL_NO_EC
     if (src-&gt;tlsext_ecpointformatlist) {
         dest-&gt;tlsext_ecpointformatlist =
-            BUF_memdup(src-&gt;tlsext_ecpointformatlist,
+            OPENSSL_memdup(src-&gt;tlsext_ecpointformatlist,
                        src-&gt;tlsext_ecpointformatlist_length);
         if (dest-&gt;tlsext_ecpointformatlist == NULL)
             goto err;
     }
     if (src-&gt;tlsext_ellipticcurvelist) {
         dest-&gt;tlsext_ellipticcurvelist =
-            BUF_memdup(src-&gt;tlsext_ellipticcurvelist,
+            OPENSSL_memdup(src-&gt;tlsext_ellipticcurvelist,
                        src-&gt;tlsext_ellipticcurvelist_length);
         if (dest-&gt;tlsext_ellipticcurvelist == NULL)
             goto err;
@@ -297,7 +297,7 @@ SSL_SESSION *ssl_session_dup(SSL_SESSION *src, int ticket)
 #endif
 
     if (ticket != 0) {
-        dest-&gt;tlsext_tick = BUF_memdup(src-&gt;tlsext_tick, src-&gt;tlsext_ticklen);
+        dest-&gt;tlsext_tick = OPENSSL_memdup(src-&gt;tlsext_tick, src-&gt;tlsext_ticklen);
         if(dest-&gt;tlsext_tick == NULL)
             goto err;
     } else {
@@ -307,7 +307,7 @@ SSL_SESSION *ssl_session_dup(SSL_SESSION *src, int ticket)
 
 #ifndef OPENSSL_NO_SRP
     if (src-&gt;srp_username) {
-        dest-&gt;srp_username = BUF_strdup(src-&gt;srp_username);
+        dest-&gt;srp_username = OPENSSL_strdup(src-&gt;srp_username);
         if (dest-&gt;srp_username == NULL) {
             goto err;
         }
@@ -475,7 +475,7 @@ int ssl_get_new_session(SSL *s, int session)
 
  sess_id_done:
         if (s-&gt;tlsext_hostname) {
-            ss-&gt;tlsext_hostname = BUF_strdup(s-&gt;tlsext_hostname);
+            ss-&gt;tlsext_hostname = OPENSSL_strdup(s-&gt;tlsext_hostname);
             if (ss-&gt;tlsext_hostname == NULL) {
                 SSLerr(SSL_F_SSL_GET_NEW_SESSION, ERR_R_INTERNAL_ERROR);
                 SSL_SESSION_free(ss);
diff --git a/ssl/statem/statem_clnt.c b/ssl/statem/statem_clnt.c
index 2c2a521..56f6eaf 100644
--- a/ssl/statem/statem_clnt.c
+++ b/ssl/statem/statem_clnt.c
@@ -2289,9 +2289,8 @@ int tls_construct_client_key_exchange(SSL *s)
                    SSL_R_PSK_IDENTITY_NOT_FOUND);
             goto psk_err;
         }
-
         OPENSSL_free(s-&gt;s3-&gt;tmp.psk);
-        s-&gt;s3-&gt;tmp.psk = BUF_memdup(psk, psklen);
+        s-&gt;s3-&gt;tmp.psk = OPENSSL_memdup(psk, psklen);
         OPENSSL_cleanse(psk, psklen);
 
         if (s-&gt;s3-&gt;tmp.psk == NULL) {
@@ -2300,7 +2299,6 @@ int tls_construct_client_key_exchange(SSL *s)
         }
 
         s-&gt;s3-&gt;tmp.psklen = psklen;
-
         identitylen = strlen(identity);
         if (identitylen &gt; PSK_MAX_IDENTITY_LEN) {
             SSLerr(SSL_F_TLS_CONSTRUCT_CLIENT_KEY_EXCHANGE,
@@ -2308,7 +2306,7 @@ int tls_construct_client_key_exchange(SSL *s)
             goto psk_err;
         }
         OPENSSL_free(s-&gt;session-&gt;psk_identity);
-        s-&gt;session-&gt;psk_identity = BUF_strdup(identity);
+        s-&gt;session-&gt;psk_identity = OPENSSL_strdup(identity);
         if (s-&gt;session-&gt;psk_identity == NULL) {
             OPENSSL_cleanse(identity, sizeof(identity));
             goto memerr;
@@ -2658,7 +2656,7 @@ psk_err:
             goto err;
         }
         OPENSSL_free(s-&gt;session-&gt;srp_username);
-        s-&gt;session-&gt;srp_username = BUF_strdup(s-&gt;srp_ctx.login);
+        s-&gt;session-&gt;srp_username = OPENSSL_strdup(s-&gt;srp_ctx.login);
         if (s-&gt;session-&gt;srp_username == NULL) {
             SSLerr(SSL_F_TLS_CONSTRUCT_CLIENT_KEY_EXCHANGE,
                    ERR_R_MALLOC_FAILURE);
diff --git a/ssl/statem/statem_srvr.c b/ssl/statem/statem_srvr.c
index f4c5e8c..83e56ea 100644
--- a/ssl/statem/statem_srvr.c
+++ b/ssl/statem/statem_srvr.c
@@ -2181,7 +2181,7 @@ MSG_PROCESS_RETURN tls_process_client_key_exchange(SSL *s, PACKET *pkt)
         }
 
         OPENSSL_free(s-&gt;s3-&gt;tmp.psk);
-        s-&gt;s3-&gt;tmp.psk = BUF_memdup(psk, psklen);
+        s-&gt;s3-&gt;tmp.psk = OPENSSL_memdup(psk, psklen);
         OPENSSL_cleanse(psk, psklen);
 
         if (s-&gt;s3-&gt;tmp.psk == NULL) {
@@ -2534,7 +2534,7 @@ MSG_PROCESS_RETURN tls_process_client_key_exchange(SSL *s, PACKET *pkt)
             goto f_err;
         }
         OPENSSL_free(s-&gt;session-&gt;srp_username);
-        s-&gt;session-&gt;srp_username = BUF_strdup(s-&gt;srp_ctx.login);
+        s-&gt;session-&gt;srp_username = OPENSSL_strdup(s-&gt;srp_ctx.login);
         if (s-&gt;session-&gt;srp_username == NULL) {
             SSLerr(SSL_F_TLS_PROCESS_CLIENT_KEY_EXCHANGE, ERR_R_MALLOC_FAILURE);
             goto err;
diff --git a/ssl/t1_ext.c b/ssl/t1_ext.c
index 396ad7e..2ffe271 100644
--- a/ssl/t1_ext.c
+++ b/ssl/t1_ext.c
@@ -183,7 +183,7 @@ int custom_exts_copy(custom_ext_methods *dst, const custom_ext_methods *src)
 {
     if (src-&gt;meths_count) {
         dst-&gt;meths =
-            BUF_memdup(src-&gt;meths,
+            OPENSSL_memdup(src-&gt;meths,
                        sizeof(custom_ext_method) * src-&gt;meths_count);
         if (dst-&gt;meths == NULL)
             return 0;
diff --git a/ssl/t1_lib.c b/ssl/t1_lib.c
index 571a891..efa0441 100644
--- a/ssl/t1_lib.c
+++ b/ssl/t1_lib.c
@@ -2577,7 +2577,7 @@ static int ssl_scan_serverhello_tlsext(SSL *s, PACKET *pkt, int *al)
     if (!s-&gt;hit &amp;&amp; tlsext_servername == 1) {
         if (s-&gt;tlsext_hostname) {
             if (s-&gt;session-&gt;tlsext_hostname == NULL) {
-                s-&gt;session-&gt;tlsext_hostname = BUF_strdup(s-&gt;tlsext_hostname);
+                s-&gt;session-&gt;tlsext_hostname = OPENSSL_strdup(s-&gt;tlsext_hostname);
                 if (!s-&gt;session-&gt;tlsext_hostname) {
                     *al = SSL_AD_UNRECOGNIZED_NAME;
                     return 0;
diff --git a/ssl/tls_srp.c b/ssl/tls_srp.c
index 64a3f23..e3763b0 100644
--- a/ssl/tls_srp.c
+++ b/ssl/tls_srp.c
@@ -179,7 +179,7 @@ int SSL_SRP_CTX_init(struct ssl_st *s)
         goto err;
     }
     if ((ctx-&gt;srp_ctx.login != NULL) &amp;&amp;
-        ((s-&gt;srp_ctx.login = BUF_strdup(ctx-&gt;srp_ctx.login)) == NULL)) {
+        ((s-&gt;srp_ctx.login = OPENSSL_strdup(ctx-&gt;srp_ctx.login)) == NULL)) {
         SSLerr(SSL_F_SSL_SRP_CTX_INIT, ERR_R_INTERNAL_ERROR);
         goto err;
     }
diff --git a/test/dummytest.c b/test/dummytest.c
index 5569db0..25ce77b 100644
--- a/test/dummytest.c
+++ b/test/dummytest.c
@@ -34,7 +34,7 @@ int main(int argc, char *argv[])
         q = p + strlen(p);
 
     if (!p)
-        program = BUF_strdup(&quot;(unknown)&quot;);
+        program = OPENSSL_strdup(&quot;(unknown)&quot;);
     else {
         program = OPENSSL_malloc((q - p) + 1);
         strncpy(program, p, q - p);
diff --git a/test/enginetest.c b/test/enginetest.c
index 54e6ead..bbe40e6 100644
--- a/test/enginetest.c
+++ b/test/enginetest.c
@@ -205,9 +205,9 @@ int main(int argc, char *argv[])
     printf(&quot;About to beef up the engine-type list\n&quot;);
     for (loop = 0; loop &lt; 512; loop++) {
         sprintf(buf, &quot;id%i&quot;, loop);
-        id = BUF_strdup(buf);
+        id = OPENSSL_strdup(buf);
         sprintf(buf, &quot;Fake engine type %i&quot;, loop);
-        name = BUF_strdup(buf);
+        name = OPENSSL_strdup(buf);
         if (((block[loop] = ENGINE_new()) == NULL) ||
             !ENGINE_set_id(block[loop], id) ||
             !ENGINE_set_name(block[loop], name)) {
diff --git a/test/evp_test.c b/test/evp_test.c
index f24494b..91caa4f 100644
--- a/test/evp_test.c
+++ b/test/evp_test.c
@@ -487,7 +487,7 @@ static int process_test(struct evp_test *t, char *buf, int verbose)
         key = OPENSSL_malloc(sizeof(*key));
         if (!key)
             return 0;
-        key-&gt;name = BUF_strdup(value);
+        key-&gt;name = OPENSSL_strdup(value);
         key-&gt;key = pk;
         key-&gt;next = *lst;
         *lst = key;
@@ -521,7 +521,7 @@ static int process_test(struct evp_test *t, char *buf, int verbose)
             fprintf(stderr, &quot;Line %d: multiple result lines\n&quot;, t-&gt;line);
             return 0;
         }
-        t-&gt;expected_err = BUF_strdup(value);
+        t-&gt;expected_err = OPENSSL_strdup(value);
         if (!t-&gt;expected_err)
             return 0;
     } else {
@@ -554,9 +554,9 @@ static int check_var_length_output(struct evp_test *t,
     }
 
     /* The result printing code expects a non-NULL buffer. */
-    t-&gt;out_expected = BUF_memdup(expected, expected_len ? expected_len : 1);
+    t-&gt;out_expected = OPENSSL_memdup(expected, expected_len ? expected_len : 1);
     t-&gt;out_expected_len = expected_len;
-    t-&gt;out_received = BUF_memdup(received, received_len ? received_len : 1);
+    t-&gt;out_received = OPENSSL_memdup(received, received_len ? received_len : 1);
     t-&gt;out_received_len = received_len;
     if (t-&gt;out_expected == NULL || t-&gt;out_received == NULL) {
         fprintf(stderr, &quot;Memory allocation error!\n&quot;);
@@ -610,7 +610,9 @@ int main(int argc, char **argv)
     CRYPTO_cleanup_all_ex_data();
     ERR_remove_thread_state(NULL);
     ERR_free_strings();
+#ifdef CRYPTO_MDEBUG
     CRYPTO_mem_leaks_fp(stderr);
+#endif
     if (t.errors)
         return 1;
     return 0;
@@ -1052,7 +1054,7 @@ static int mac_test_parse(struct evp_test *t,
     if (strcmp(keyword, &quot;Key&quot;) == 0)
         return test_bin(value, &amp;mdata-&gt;key, &amp;mdata-&gt;key_len);
     if (strcmp(keyword, &quot;Algorithm&quot;) == 0) {
-        mdata-&gt;alg = BUF_strdup(value);
+        mdata-&gt;alg = OPENSSL_strdup(value);
         if (!mdata-&gt;alg)
             return 0;
         return 1;
@@ -1554,7 +1556,7 @@ static int encode_test_init(struct evp_test *t, const char *encoding)
         edata-&gt;encoding = BASE64_VALID_ENCODING;
     } else if (strcmp(encoding, &quot;invalid&quot;) == 0) {
         edata-&gt;encoding = BASE64_INVALID_ENCODING;
-        t-&gt;expected_err = BUF_strdup(&quot;DECODE_ERROR&quot;);
+        t-&gt;expected_err = OPENSSL_strdup(&quot;DECODE_ERROR&quot;);
         if (t-&gt;expected_err == NULL)
             return 0;
     } else {
diff --git a/test/exptest.c b/test/exptest.c
index 170de09..53286d8 100644
--- a/test/exptest.c
+++ b/test/exptest.c
@@ -300,7 +300,9 @@ int main(int argc, char *argv[])
     BN_free(m);
     BN_CTX_free(ctx);
     ERR_remove_thread_state(NULL);
+#ifdef CRYPTO_MDEBUG
     CRYPTO_mem_leaks(out);
+#endif
     BIO_free(out);
     printf(&quot;\n&quot;);
 
diff --git a/test/heartbeat_test.c b/test/heartbeat_test.c
index 42cbc02..2fa82e3 100644
--- a/test/heartbeat_test.c
+++ b/test/heartbeat_test.c
@@ -240,7 +240,7 @@ static int execute_heartbeat(HEARTBEAT_TEST_FIXTURE fixture)
         result = 1;
     } else {
         char *actual_payload =
-            BUF_strndup((const char *)p, actual_payload_len);
+            OPENSSL_strndup((const char *)p, actual_payload_len);
         if (strcmp(actual_payload, fixture.expected_return_payload) != 0) {
             printf
                 (&quot;%s failed:\n  expected payload: \&quot;%s\&quot;\n  received: \&quot;%s\&quot;\n&quot;,
diff --git a/test/ssltest.c b/test/ssltest.c
index 0912392..fd356c7 100644
--- a/test/ssltest.c
+++ b/test/ssltest.c
@@ -253,7 +253,7 @@ typedef struct srp_client_arg_st {
 static char *ssl_give_srp_client_pwd_cb(SSL *s, void *arg)
 {
     SRP_CLIENT_ARG *srp_client_arg = (SRP_CLIENT_ARG *)arg;
-    return BUF_strdup((char *)srp_client_arg-&gt;srppassin);
+    return OPENSSL_strdup((char *)srp_client_arg-&gt;srppassin);
 }
 
 /* SRP server */
diff --git a/util/libeay.num b/util/libeay.num
index 98e0ca8..2b5a622 100755
--- a/util/libeay.num
+++ b/util/libeay.num
@@ -159,7 +159,7 @@ BN_value_one                            166	1_1_0	EXIST::FUNCTION:
 BUF_MEM_free                            167	1_1_0	EXIST::FUNCTION:
 BUF_MEM_grow                            168	1_1_0	EXIST::FUNCTION:
 BUF_MEM_new                             169	1_1_0	EXIST::FUNCTION:
-BUF_strdup                              170	1_1_0	EXIST::FUNCTION:
+BUF_strdup                              170	1_1_0	NOEXIST::FUNCTION:
 CONF_free                               171	1_1_0	EXIST::FUNCTION:
 CONF_get_number                         172	1_1_0	EXIST::FUNCTION:
 CONF_get_section                        173	1_1_0	EXIST::FUNCTION:
@@ -2798,9 +2798,9 @@ X509_REQ_print_ex                       3237	1_1_0	EXIST::FUNCTION:
 ENGINE_up_ref                           3238	1_1_0	EXIST::FUNCTION:ENGINE
 BUF_MEM_grow_clean                      3239	1_1_0	EXIST::FUNCTION:
 CRYPTO_realloc_clean                    3240	1_1_0	EXIST::FUNCTION:
-BUF_strlcat                             3241	1_1_0	EXIST::FUNCTION:
+BUF_strlcat                             3241	1_1_0	NOEXIST::FUNCTION:
 BIO_indent                              3242	1_1_0	EXIST::FUNCTION:
-BUF_strlcpy                             3243	1_1_0	EXIST::FUNCTION:
+BUF_strlcpy                             3243	1_1_0	NOEXIST::FUNCTION:
 OpenSSLDie                              3244	1_1_0	EXIST::FUNCTION:
 OPENSSL_cleanse                         3245	1_1_0	EXIST::FUNCTION:
 ENGINE_setup_bsd_cryptodev              3246	1_1_0	EXIST:__FreeBSD__:FUNCTION:ENGINE
@@ -3062,7 +3062,7 @@ STORE_meth_set_delete_fn                3486	1_1_0	NOEXIST::FUNCTION:
 STORE_method_set_delete_function        3486	1_1_0	NOEXIST::FUNCTION:
 STORE_list_certificate_next             3487	1_1_0	NOEXIST::FUNCTION:
 ASN1_generate_nconf                     3488	1_1_0	EXIST::FUNCTION:
-BUF_memdup                              3489	1_1_0	EXIST::FUNCTION:
+BUF_memdup                              3489	1_1_0	NOEXIST::FUNCTION:
 BN_GF2m_mod_mul                         3490	1_1_0	EXIST::FUNCTION:EC2M
 STORE_meth_get_list_next_fn             3491	1_1_0	NOEXIST::FUNCTION:
 STORE_method_get_list_next_function     3491	1_1_0	NOEXIST::FUNCTION:
@@ -3088,7 +3088,7 @@ ECDSA_get_ex_data                       3509	1_1_0	NOEXIST::FUNCTION:
 SHA224                                  3510	1_1_0	EXIST::FUNCTION:
 BIO_dump_indent_fp                      3511	1_1_0	EXIST::FUNCTION:STDIO
 EC_KEY_set_group                        3512	1_1_0	EXIST::FUNCTION:EC
-BUF_strndup                             3513	1_1_0	EXIST::FUNCTION:
+BUF_strndup                             3513	1_1_0	NOEXIST::FUNCTION:
 STORE_list_certificate_start            3514	1_1_0	NOEXIST::FUNCTION:
 BN_GF2m_mod                             3515	1_1_0	EXIST::FUNCTION:EC2M
 X509_REQ_check_private_key              3516	1_1_0	EXIST::FUNCTION:
@@ -4406,7 +4406,7 @@ X509_VERIFY_PARAM_get0                  4762	1_1_0	EXIST::FUNCTION:
 X509V3_EXT_free                         4763	1_1_0	NOEXIST::FUNCTION:
 BIO_hex_string                          4764	1_1_0	EXIST::FUNCTION:
 X509_VERIFY_PARAM_set_hostflags         4765	1_1_0	EXIST::FUNCTION:
-BUF_strnlen                             4766	1_1_0	EXIST::FUNCTION:
+BUF_strnlen                             4766	1_1_0	NOEXIST::FUNCTION:
 X509_VERIFY_PARAM_get0_peername         4767	1_1_0	EXIST::FUNCTION:
 ECDSA_METHOD_set_app_data               4768	1_1_0	NOEXIST::FUNCTION:
 sk_deep_copy                            4769	1_1_0	EXIST::FUNCTION:
@@ -4742,3 +4742,9 @@ EVP_PKEY_get0_RSA                       5104	1_1_0	EXIST::FUNCTION:RSA
 EC_POINT_point2buf                      5105	1_1_0	EXIST::FUNCTION:EC
 EC_KEY_key2buf                          5106	1_1_0	EXIST::FUNCTION:EC
 EC_KEY_oct2key                          5107	1_1_0	EXIST::FUNCTION:EC
+OPENSSL_strlcpy                         5108	1_1_0	EXIST::FUNCTION:
+OPENSSL_strnlen                         5109	1_1_0	EXIST::FUNCTION:
+OPENSSL_strlcat                         5110	1_1_0	EXIST::FUNCTION:
+OPENSSL_memdup                          5111	1_1_0	NOEXIST::FUNCTION:
+CRYPTO_memdup                           5112	1_1_0	EXIST::FUNCTION:
+CRYPTO_strndup                          5113	1_1_0	EXIST::FUNCTION:
</PRE>



















<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="002482.html">[openssl-commits] [openssl]  master update
</A></li>
	<LI>Next message: <A HREF="002487.html">[openssl-commits] [openssl]  master update
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2485">[ date ]</a>
              <a href="thread.html#2485">[ thread ]</a>
              <a href="subject.html#2485">[ subject ]</a>
              <a href="author.html#2485">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="../../../mailman/listinfo/openssl-commits.html">More information about the openssl-commits
mailing list</a><br>
</body></html>
