<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [openssl]  master update
   </TITLE>
   <LINK REL="Index" HREF="https://mta.openssl.org/pipermail/openssl-commits/2020-November/index.html" >
   <LINK REL="made" HREF="mailto:openssl-commits%40openssl.org?Subject=Re%3A%20%5Bopenssl%5D%20%20master%20update&In-Reply-To=%3C1605782348.148548.30301.nullmailer%40dev.openssl.org%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="032099.html">
   <LINK REL="Next"  HREF="032106.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[openssl]  master update</H1>
    <B>dev at ddvo.net</B> 
    <A HREF="mailto:openssl-commits%40openssl.org?Subject=Re%3A%20%5Bopenssl%5D%20%20master%20update&In-Reply-To=%3C1605782348.148548.30301.nullmailer%40dev.openssl.org%3E"
       TITLE="[openssl]  master update">dev at ddvo.net
       </A><BR>
    <I>Thu Nov 19 10:39:08 UTC 2020</I>
    <P><UL>
        <LI>Previous message: <A HREF="032099.html">[openssl]  master update
</A></li>
        <LI>Next message: <A HREF="032106.html">[openssl]  master update
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#32105">[ date ]</a>
              <a href="thread.html#32105">[ thread ]</a>
              <a href="subject.html#32105">[ subject ]</a>
              <a href="author.html#32105">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>The branch master has been updated
       via  908c9fc7ed86d8fab4edc1431433509bc18ac935 (commit)
       via  09afbec94bacac7be9fbeab8fa0a9dfd5cb19b1d (commit)
       via  61dd4168f5d98cd914a65b7357e4df06a65693ab (commit)
       via  3a6df6bd5cf64005682da6ec18ef58b929baa452 (commit)
       via  0c2c560cb96346737bace83eb01f8e8aa5970f81 (commit)
       via  852feb3bd8a42ab441bd726ffc96c5757b7a936c (commit)
       via  b84965aff0451dd914d54d3fbb6b9d347e1cd947 (commit)
       via  bb57c90e6cdc8400219673ff32dad95361f3c291 (commit)
       via  279b61d0cade44964956c5c39da462fe43414cc1 (commit)
       via  9c73e48a081278f18f3203efca980ddfa873e71f (commit)
       via  c1097eecdfe438bcb18b3f556ca4e5dec0748cfc (commit)
      from  d7e498ac55f12bc2f4e7f948cbb8de2e3eeafc74 (commit)


- Log -----------------------------------------------------------------
commit 908c9fc7ed86d8fab4edc1431433509bc18ac935
Author: Dr. David von Oheimb &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">David.von.Oheimb at siemens.com</A>&gt;
Date:   Mon Aug 10 14:23:46 2020 +0200

    apps/pkcs12: Clean up the order in which many options are presented
    
    Also do a minor extension on the documentation of the -passcerts option
    
    Reviewed-by: Tomas Mraz &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">tmraz at fedoraproject.org</A>&gt;
    (Merged from <A HREF="https://github.com/openssl/openssl/pull/4930">https://github.com/openssl/openssl/pull/4930</A>)

commit 09afbec94bacac7be9fbeab8fa0a9dfd5cb19b1d
Author: Dr. David von Oheimb &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">David.von.Oheimb at siemens.com</A>&gt;
Date:   Sat Jun 6 13:59:25 2020 +0200

    e_loader_attic.c: Improve result handling of file_load_try_decode()
    
    Reviewed-by: Tomas Mraz &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">tmraz at fedoraproject.org</A>&gt;
    (Merged from <A HREF="https://github.com/openssl/openssl/pull/4930">https://github.com/openssl/openssl/pull/4930</A>)

commit 61dd4168f5d98cd914a65b7357e4df06a65693ab
Author: Dr. David von Oheimb &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">David.von.Oheimb at siemens.com</A>&gt;
Date:   Mon May 11 15:51:34 2020 +0200

    Allow for PKCS#12 input without MAC in p12_kiss.c and e_loader_attic.c
    
    Reviewed-by: Tomas Mraz &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">tmraz at fedoraproject.org</A>&gt;
    (Merged from <A HREF="https://github.com/openssl/openssl/pull/4930">https://github.com/openssl/openssl/pull/4930</A>)

commit 3a6df6bd5cf64005682da6ec18ef58b929baa452
Author: Dr. David von Oheimb &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">David.von.Oheimb at siemens.com</A>&gt;
Date:   Sat Jun 6 14:00:21 2020 +0200

    e_loader_attic.c: Remove redundant 'pass phrase' sub-string from try_decode_PKCS12()
    
    Reviewed-by: Tomas Mraz &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">tmraz at fedoraproject.org</A>&gt;
    (Merged from <A HREF="https://github.com/openssl/openssl/pull/4930">https://github.com/openssl/openssl/pull/4930</A>)

commit 0c2c560cb96346737bace83eb01f8e8aa5970f81
Author: Dr. David von Oheimb &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">David.von.Oheimb at siemens.com</A>&gt;
Date:   Mon May 11 15:50:36 2020 +0200

    apps/storeutl: Add error output in case of parse/decryption/mac errors in input files
    
    Reviewed-by: Tomas Mraz &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">tmraz at fedoraproject.org</A>&gt;
    (Merged from <A HREF="https://github.com/openssl/openssl/pull/4930">https://github.com/openssl/openssl/pull/4930</A>)

commit 852feb3bd8a42ab441bd726ffc96c5757b7a936c
Author: Dr. David von Oheimb &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">David.von.Oheimb at siemens.com</A>&gt;
Date:   Mon May 11 15:49:34 2020 +0200

    apps/pkcs12: Really do not perform MAC in case -nomac
    
    Reviewed-by: Tomas Mraz &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">tmraz at fedoraproject.org</A>&gt;
    (Merged from <A HREF="https://github.com/openssl/openssl/pull/4930">https://github.com/openssl/openssl/pull/4930</A>)

commit b84965aff0451dd914d54d3fbb6b9d347e1cd947
Author: Dr. David von Oheimb &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">David.von.Oheimb at siemens.com</A>&gt;
Date:   Mon May 11 15:48:52 2020 +0200

    apps/pkcs12: Do not prompt for password in case -nomac and -noenc/-nodes
    
    Reviewed-by: Tomas Mraz &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">tmraz at fedoraproject.org</A>&gt;
    (Merged from <A HREF="https://github.com/openssl/openssl/pull/4930">https://github.com/openssl/openssl/pull/4930</A>)

commit bb57c90e6cdc8400219673ff32dad95361f3c291
Author: Dr. David von Oheimb &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">David.von.Oheimb at siemens.com</A>&gt;
Date:   Mon Sep 14 19:17:28 2020 +0200

    Minor improvements of doc for ca and x509 app
    
    Reviewed-by: Tomas Mraz &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">tmraz at fedoraproject.org</A>&gt;
    (Merged from <A HREF="https://github.com/openssl/openssl/pull/4930">https://github.com/openssl/openssl/pull/4930</A>)

commit 279b61d0cade44964956c5c39da462fe43414cc1
Author: David von Oheimb &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">David.von.Oheimb at siemens.com</A>&gt;
Date:   Thu Dec 14 14:02:27 2017 +0100

    apps/pkcs12: Retain test output files
    
    Reviewed-by: Tomas Mraz &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">tmraz at fedoraproject.org</A>&gt;
    (Merged from <A HREF="https://github.com/openssl/openssl/pull/4930">https://github.com/openssl/openssl/pull/4930</A>)

commit 9c73e48a081278f18f3203efca980ddfa873e71f
Author: David von Oheimb &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">David.von.Oheimb at siemens.com</A>&gt;
Date:   Thu Dec 14 11:10:33 2017 +0100

    Minor cleanup of error output for various apps
    
    Reviewed-by: Tomas Mraz &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">tmraz at fedoraproject.org</A>&gt;
    (Merged from <A HREF="https://github.com/openssl/openssl/pull/4930">https://github.com/openssl/openssl/pull/4930</A>)

commit c1097eecdfe438bcb18b3f556ca4e5dec0748cfc
Author: David von Oheimb &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">David.von.Oheimb at siemens.com</A>&gt;
Date:   Thu Dec 14 08:04:00 2017 +0100

    apps/ca: Minor code and doc cleanup
    
    Reviewed-by: Tomas Mraz &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">tmraz at fedoraproject.org</A>&gt;
    (Merged from <A HREF="https://github.com/openssl/openssl/pull/4930">https://github.com/openssl/openssl/pull/4930</A>)

-----------------------------------------------------------------------

Summary of changes:
 apps/ca.c                      | 47 +++++++++++++---------------------
 apps/pkcs12.c                  | 57 +++++++++++++++++++++++-------------------
 apps/s_server.c                |  3 ++-
 apps/storeutl.c                |  8 +++---
 crypto/pkcs12/p12_kiss.c       |  3 ++-
 doc/man1/openssl-ca.pod.in     | 12 ++++-----
 doc/man1/openssl-pkcs12.pod.in |  5 ++--
 engines/e_loader_attic.c       | 10 +++++---
 test/recipes/80-test_pkcs12.t  | 18 ++++++-------
 9 files changed, 82 insertions(+), 81 deletions(-)

diff --git a/apps/ca.c b/apps/ca.c
index b2866f63d6..0f21b4fa1c 100755
--- a/apps/ca.c
+++ b/apps/ca.c
@@ -100,7 +100,7 @@ static int certify(X509 **xret, const char *infile, int informat,
                    long days, int batch, const char *ext_sect, CONF *conf,
                    int verbose, unsigned long certopt, unsigned long nameopt,
                    int default_op, int ext_copy, int selfsign);
-static int certify_cert(X509 **xret, const char *infile, int informat,
+static int certify_cert(X509 **xret, const char *infile, int certformat,
                         const char *passin, EVP_PKEY *pkey, X509 *x509,
                         const EVP_MD *dgst,
                         STACK_OF(OPENSSL_STRING) *sigopts,
@@ -211,9 +211,11 @@ const OPTIONS ca_options[] = {
     OPT_SECTION(&quot;Signing&quot;),
     {&quot;md&quot;, OPT_MD, 's', &quot;md to use; one of md2, md5, sha or sha1&quot;},
     {&quot;keyfile&quot;, OPT_KEYFILE, 's', &quot;The CA private key&quot;},
-    {&quot;keyform&quot;, OPT_KEYFORM, 'f', &quot;Private key file format (ENGINE, other values ignored)&quot;},
+    {&quot;keyform&quot;, OPT_KEYFORM, 'f',
+     &quot;Private key file format (ENGINE, other values ignored)&quot;},
     {&quot;passin&quot;, OPT_PASSIN, 's', &quot;Key and cert input file pass phrase source&quot;},
-    {&quot;key&quot;, OPT_KEY, 's', &quot;Key to decrypt key or cert files. Better use -passin&quot;},
+    {&quot;key&quot;, OPT_KEY, 's',
+     &quot;Key to decrypt the private key or cert files if encrypted. Better use -passin&quot;},
     {&quot;cert&quot;, OPT_CERT, '&lt;', &quot;The CA cert&quot;},
     {&quot;certform&quot;, OPT_CERTFORM, 'F',
      &quot;Certificate input format (DER/PEM/P12); has no effect&quot;},
@@ -515,10 +517,8 @@ end_of_options:
             BIO_free(oid_bio);
         }
     }
-    if (!add_oid_section(conf)) {
-        ERR_print_errors(bio_err);
+    if (!add_oid_section(conf))
         goto end;
-    }
 
     app_RAND_load_conf(conf, BASE_SECTION);
 
@@ -580,6 +580,7 @@ end_of_options:
         }
     }
     pkey = load_key(keyfile, keyformat, 0, passin, e, &quot;CA private key&quot;);
+    cleanse(passin);
     if (pkey == NULL)
         /* load_key() has already printed an appropriate message */
         goto end;
@@ -1344,38 +1345,32 @@ static int certify(X509 **xret, const char *infile, int informat,
     req = load_csr(infile, informat, &quot;certificate request&quot;);
     if (req == NULL)
         goto end;
+    if ((pktmp = X509_REQ_get0_pubkey(req)) == NULL) {
+        BIO_printf(bio_err, &quot;Error unpacking public key\n&quot;);
+        goto end;
+    }
     if (verbose)
         X509_REQ_print_ex(bio_err, req, nameopt, X509_FLAG_COMPAT);
 
     BIO_printf(bio_err, &quot;Check that the request matches the signature\n&quot;);
+    ok = 0;
 
     if (selfsign &amp;&amp; !X509_REQ_check_private_key(req, pkey)) {
         BIO_printf(bio_err,
                    &quot;Certificate request and CA private key do not match\n&quot;);
-        ok = 0;
-        goto end;
-    }
-    if ((pktmp = X509_REQ_get0_pubkey(req)) == NULL) {
-        BIO_printf(bio_err, &quot;error unpacking public key\n&quot;);
         goto end;
     }
     i = do_X509_REQ_verify(req, pktmp, vfyopts);
-    pktmp = NULL;
     if (i &lt; 0) {
-        ok = 0;
-        BIO_printf(bio_err, &quot;Signature verification problems....\n&quot;);
-        ERR_print_errors(bio_err);
+        BIO_printf(bio_err, &quot;Signature verification problems...\n&quot;);
         goto end;
     }
     if (i == 0) {
-        ok = 0;
         BIO_printf(bio_err,
                    &quot;Signature did not match the certificate request\n&quot;);
-        ERR_print_errors(bio_err);
         goto end;
-    } else {
-        BIO_printf(bio_err, &quot;Signature ok\n&quot;);
     }
+    BIO_printf(bio_err, &quot;Signature ok\n&quot;);
 
     ok = do_body(xret, pkey, x509, dgst, sigopts, policy, db, serial, subj,
                  chtype, multirdn, email_dn, startdate, enddate, days, batch,
@@ -1383,6 +1378,7 @@ static int certify(X509 **xret, const char *infile, int informat,
                  ext_copy, selfsign);
 
  end:
+    ERR_print_errors(bio_err);
     X509_REQ_free(req);
     return ok;
 }
@@ -1475,10 +1471,8 @@ static int do_body(X509 **xret, EVP_PKEY *pkey, X509 *x509,
     if (subj) {
         X509_NAME *n = parse_name(subj, chtype, multirdn, &quot;subject&quot;);
 
-        if (!n) {
-            ERR_print_errors(bio_err);
+        if (!n)
             goto end;
-        }
         X509_REQ_set_subject_name(req, n);
         X509_NAME_free(n);
     }
@@ -1716,7 +1710,6 @@ static int do_body(X509 **xret, EVP_PKEY *pkey, X509 *x509,
                 BIO_printf(bio_err,
                            &quot;ERROR: adding extensions in section %s\n&quot;,
                            ext_sect);
-                ERR_print_errors(bio_err);
                 goto end;
             }
             if (verbose)
@@ -1730,7 +1723,6 @@ static int do_body(X509 **xret, EVP_PKEY *pkey, X509 *x509,
                 BIO_printf(bio_err,
                            &quot;ERROR: adding extensions in section %s\n&quot;,
                            ext_sect);
-                ERR_print_errors(bio_err);
                 goto end;
             }
 
@@ -1744,7 +1736,6 @@ static int do_body(X509 **xret, EVP_PKEY *pkey, X509 *x509,
 
     if (!copy_extensions(ret, req, ext_copy)) {
         BIO_printf(bio_err, &quot;ERROR: adding extensions from request\n&quot;);
-        ERR_print_errors(bio_err);
         goto end;
     }
 
@@ -2002,7 +1993,6 @@ static int certify_spkac(X509 **xret, const char *infile, EVP_PKEY *pkey,
     parms = CONF_load(NULL, infile, &amp;errline);
     if (parms == NULL) {
         BIO_printf(bio_err, &quot;error on line %ld of %s\n&quot;, errline, infile);
-        ERR_print_errors(bio_err);
         goto end;
     }
 
@@ -2020,10 +2010,8 @@ static int certify_spkac(X509 **xret, const char *infile, EVP_PKEY *pkey,
      * and we can use the same code as if you had a real X509 request.
      */
     req = X509_REQ_new();
-    if (req == NULL) {
-        ERR_print_errors(bio_err);
+    if (req == NULL)
         goto end;
-    }
 
     /*
      * Build up the subject name set.
@@ -2054,7 +2042,6 @@ static int certify_spkac(X509 **xret, const char *infile, EVP_PKEY *pkey,
                 if (spki == NULL) {
                     BIO_printf(bio_err,
                                &quot;unable to load Netscape SPKAC structure\n&quot;);
-                    ERR_print_errors(bio_err);
                     goto end;
                 }
             }
diff --git a/apps/pkcs12.c b/apps/pkcs12.c
index 1432d2b930..6bc06e370f 100644
--- a/apps/pkcs12.c
+++ b/apps/pkcs12.c
@@ -68,6 +68,17 @@ const OPTIONS pkcs12_options[] = {
 #ifndef OPENSSL_NO_ENGINE
     {&quot;engine&quot;, OPT_ENGINE, 's', &quot;Use engine, possibly a hardware device&quot;},
 #endif
+    {&quot;password&quot;, OPT_PASSWORD, 's', &quot;Set import/export password source&quot;},
+    {&quot;twopass&quot;, OPT_TWOPASS, '-', &quot;Separate MAC, encryption passwords&quot;},
+
+    OPT_SECTION(&quot;Input&quot;),
+    {&quot;in&quot;, OPT_IN, '&lt;', &quot;Input file for PKCS12 parsing or certs and possibly key&quot;},
+    {&quot;passin&quot;, OPT_PASSIN, 's', &quot;Input file pass phrase source&quot;},
+    {&quot;inkey&quot;, OPT_INKEY, 's', &quot;Private key, else read from -in input file&quot;},
+    {&quot;certfile&quot;, OPT_CERTFILE, '&lt;', &quot;Extra certificates for PKCS12 output&quot;},
+    {&quot;untrusted&quot;, OPT_UNTRUSTED, '&lt;', &quot;Untrusted certificates for chain building&quot;},
+    {&quot;passcerts&quot;, OPT_PASSCERTS, 's', &quot;Certificate file pass phrase source&quot;},
+    {&quot;nomacver&quot;, OPT_NOMACVER, '-', &quot;Don't verify MAC&quot;},
 
     OPT_SECTION(&quot;CA input for export with the -chain option&quot;),
     {&quot;CApath&quot;, OPT_CAPATH, '/', &quot;PEM-format directory of CA's&quot;},
@@ -80,39 +91,27 @@ const OPTIONS pkcs12_options[] = {
     {&quot;no-CAstore&quot;, OPT_NOCASTORE, '-',
      &quot;Do not load certificates from the default certificates store&quot;},
 
-    OPT_SECTION(&quot;Input&quot;),
-    {&quot;in&quot;, OPT_IN, '&lt;', &quot;Input file for PKCS12 parsing or certs and possibly key&quot;},
-    {&quot;passin&quot;, OPT_PASSIN, 's', &quot;Input file pass phrase source&quot;},
-    {&quot;inkey&quot;, OPT_INKEY, 's', &quot;Private key, else read from -in input file&quot;},
-    {&quot;certfile&quot;, OPT_CERTFILE, '&lt;', &quot;Extra certificates for PKCS12 output&quot;},
-    {&quot;untrusted&quot;, OPT_UNTRUSTED, '&lt;', &quot;Untrusted certificates for chain building&quot;},
-    {&quot;passcerts&quot;, OPT_PASSCERTS, 's', &quot;Certificate file pass phrase source&quot;},
-    {&quot;name&quot;, OPT_NAME, 's', &quot;Use name as friendly name&quot;},
-    {&quot;CSP&quot;, OPT_CSP, 's', &quot;Microsoft CSP name&quot;},
-    {&quot;caname&quot;, OPT_CANAME, 's',
-     &quot;Use name as CA friendly name (can be repeated)&quot;},
-
     OPT_SECTION(&quot;Output&quot;),
-    {&quot;export&quot;, OPT_EXPORT, '-', &quot;Output PKCS12 file&quot;},
-    {&quot;LMK&quot;, OPT_LMK, '-',
-     &quot;Add local machine keyset attribute to private key&quot;},
-    {&quot;macalg&quot;, OPT_MACALG, 's',
-     &quot;Digest algorithm to use in MAC (default SHA1)&quot;},
-    {&quot;keypbe&quot;, OPT_KEYPBE, 's', &quot;Private key PBE algorithm (default 3DES)&quot;},
     {&quot;out&quot;, OPT_OUT, '&gt;', &quot;Output filename&quot;},
     {&quot;passout&quot;, OPT_PASSOUT, 's', &quot;Output pass phrase source&quot;},
-    {&quot;password&quot;, OPT_PASSWORD, 's', &quot;Set import/export password source&quot;},
+    {&quot;info&quot;, OPT_INFO, '-', &quot;Print info about PKCS#12 structure&quot;},
+    {&quot;nokeys&quot;, OPT_NOKEYS, '-', &quot;Don't output private keys&quot;},
     {&quot;nocerts&quot;, OPT_NOCERTS, '-', &quot;Don't output certificates&quot;},
     {&quot;clcerts&quot;, OPT_CLCERTS, '-', &quot;Only output client certificates&quot;},
     {&quot;cacerts&quot;, OPT_CACERTS, '-', &quot;Only output CA certificates&quot;},
     {&quot;noout&quot;, OPT_NOOUT, '-', &quot;Don't output anything, just verify PKCS#12 input&quot;},
+
+    OPT_SECTION(&quot;PKCS12 output&quot;),
+    {&quot;export&quot;, OPT_EXPORT, '-', &quot;Output PKCS12 file&quot;},
     {&quot;chain&quot;, OPT_CHAIN, '-', &quot;Build and add certificate chain for EE cert,&quot;},
     {OPT_MORE_STR, 0, 0,
-     &quot;which is the 1st cert from -in matching the private key (if given)&quot;},
-    {&quot;twopass&quot;, OPT_TWOPASS, '-', &quot;Separate MAC, encryption passwords&quot;},
-    {&quot;nomacver&quot;, OPT_NOMACVER, '-', &quot;Don't verify MAC&quot;},
-    {&quot;info&quot;, OPT_INFO, '-', &quot;Print info about PKCS#12 structure&quot;},
-    {&quot;nokeys&quot;, OPT_NOKEYS, '-', &quot;Don't output private keys&quot;},
+     &quot;which is the 1st cert from -in matching the privte key (if given)&quot;},
+    {&quot;name&quot;, OPT_NAME, 's', &quot;Use name as friendly name&quot;},
+    {&quot;CSP&quot;, OPT_CSP, 's', &quot;Microsoft CSP name&quot;},
+    {&quot;caname&quot;, OPT_CANAME, 's',
+     &quot;Use name as CA friendly name (can be repeated)&quot;},
+    {&quot;LMK&quot;, OPT_LMK, '-',
+     &quot;Add local machine keyset attribute to private key&quot;},
     {&quot;keyex&quot;, OPT_KEYEX, '-', &quot;Set key type to MS key exchange&quot;},
     {&quot;keysig&quot;, OPT_KEYSIG, '-', &quot;Set key type to MS key signature&quot;},
 
@@ -126,10 +125,13 @@ const OPTIONS pkcs12_options[] = {
     {&quot;descert&quot;, OPT_DESCERT, '-', &quot;Encrypt output with 3DES (the default)&quot;},
     {&quot;certpbe&quot;, OPT_CERTPBE, 's', &quot;Certificate PBE algorithm (default 3DES)&quot;},
 #endif
+    {&quot;keypbe&quot;, OPT_KEYPBE, 's', &quot;Private key PBE algorithm (default 3DES)&quot;},
     {&quot;iter&quot;, OPT_ITER, 'p', &quot;Specify the iteration count for encryption key and MAC&quot;},
     {&quot;noiter&quot;, OPT_NOITER, '-', &quot;Don't use encryption key iteration&quot;},
     {&quot;maciter&quot;, OPT_MACITER, '-', &quot;Unused, kept for backwards compatibility&quot;},
     {&quot;nomaciter&quot;, OPT_NOMACITER, '-', &quot;Don't use MAC iteration&quot;},
+    {&quot;macalg&quot;, OPT_MACALG, 's',
+     &quot;Digest algorithm to use in MAC (default SHA1)&quot;},
     {&quot;nomac&quot;, OPT_NOMAC, '-', &quot;Don't generate MAC&quot;},
     {&quot;noenc&quot;, OPT_NOENC, '-', &quot;Don't encrypt private keys&quot;},
     {&quot;nodes&quot;, OPT_NODES, '-', &quot;Don't encrypt private keys; deprecated&quot;},
@@ -235,6 +237,7 @@ int pkcs12_main(int argc, char **argv)
             maciter = 1;
             break;
         case OPT_NOMAC:
+            cert_pbe = -1;
             maciter = -1;
             break;
         case OPT_MACALG:
@@ -573,7 +576,7 @@ int pkcs12_main(int argc, char **argv)
         if (add_lmk &amp;&amp; key != NULL)
             EVP_PKEY_add1_attr_by_NID(key, NID_LocalKeySet, 0, NULL, -1);
 
-        if (!noprompt) {
+        if (!noprompt &amp;&amp; !(enc == NULL &amp;&amp; maciter == -1)) {
             /* To avoid bit rot */
             if (1) {
 #ifndef OPENSSL_NO_UI_CONSOLE
@@ -596,7 +599,8 @@ int pkcs12_main(int argc, char **argv)
                             key_pbe, cert_pbe, iter, -1, keytype);
 
         if (p12 == NULL) {
-            ERR_print_errors(bio_err);
+            BIO_printf(bio_err, &quot;Error creating PKCS12 structure for %s\n&quot;,
+                       outfile);
             goto export_end;
         }
 
@@ -625,6 +629,7 @@ int pkcs12_main(int argc, char **argv)
         sk_X509_pop_free(untrusted_certs, X509_free);
         X509_free(ee_cert);
 
+        ERR_print_errors(bio_err);
         goto end;
 
     }
diff --git a/apps/s_server.c b/apps/s_server.c
index 1e4bb4f639..24dffeab01 100644
--- a/apps/s_server.c
+++ b/apps/s_server.c
@@ -827,7 +827,8 @@ const OPTIONS s_server_options[] = {
      &quot;Second private key file to use (usually for DSA)&quot;},
     {&quot;dkeyform&quot;, OPT_DKEYFORM, 'F',
      &quot;Second key file format (ENGINE, other values ignored)&quot;},
-    {&quot;dpass&quot;, OPT_DPASS, 's', &quot;Second private key and cert file pass phrase source&quot;},
+    {&quot;dpass&quot;, OPT_DPASS, 's',
+     &quot;Second private key and cert file pass phrase source&quot;},
     {&quot;dhparam&quot;, OPT_DHPARAM, '&lt;', &quot;DH parameters file to use&quot;},
     {&quot;servername&quot;, OPT_SERVERNAME, 's',
      &quot;Servername for HostName TLS extension&quot;},
diff --git a/apps/storeutl.c b/apps/storeutl.c
index fcd874ea5d..facbf63333 100644
--- a/apps/storeutl.c
+++ b/apps/storeutl.c
@@ -395,18 +395,20 @@ static int process(const char *uri, const UI_METHOD *uimeth, PW_CB_DATA *uidata,
             info == NULL ? NULL : OSSL_STORE_INFO_type_string(type);
 
         if (info == NULL) {
-            if (OSSL_STORE_eof(store_ctx))
-                break;
-
             if (OSSL_STORE_error(store_ctx)) {
                 if (recursive)
                     ERR_clear_error();
                 else
                     ERR_print_errors(bio_err);
+                if (OSSL_STORE_eof(store_ctx))
+                    break;
                 ret++;
                 continue;
             }
 
+            if (OSSL_STORE_eof(store_ctx))
+                break;
+
             BIO_printf(bio_err,
                        &quot;ERROR: OSSL_STORE_load() returned NULL without &quot;
                        &quot;eof or error indications\n&quot;);
diff --git a/crypto/pkcs12/p12_kiss.c b/crypto/pkcs12/p12_kiss.c
index 894520be39..9b2e8a55c5 100644
--- a/crypto/pkcs12/p12_kiss.c
+++ b/crypto/pkcs12/p12_kiss.c
@@ -58,7 +58,8 @@ int PKCS12_parse(PKCS12 *p12, const char *pass, EVP_PKEY **pkey, X509 **cert,
      */
 
     if (pass == NULL || *pass == '\0') {
-        if (PKCS12_verify_mac(p12, NULL, 0))
+        if (!PKCS12_mac_present(p12)
+            || PKCS12_verify_mac(p12, NULL, 0))
             pass = NULL;
         else if (PKCS12_verify_mac(p12, &quot;&quot;, 0))
             pass = &quot;&quot;;
diff --git a/doc/man1/openssl-ca.pod.in b/doc/man1/openssl-ca.pod.in
index bfb8f1a30d..b1d437a5c0 100644
--- a/doc/man1/openssl-ca.pod.in
+++ b/doc/man1/openssl-ca.pod.in
@@ -182,6 +182,12 @@ L&lt;ps(1)&gt; on Unix),
 this option should be used with caution.
 Better use B&lt;-passin&gt;.
 
+=item B&lt;-passin&gt; I&lt;arg&gt;
+
+The key password source for key files and certificate PKCS#12 files.
+For more information about the format of B&lt;arg&gt;
+see L&lt;openssl(1)/Pass Phrase Options&gt;.
+
 =item B&lt;-selfsign&gt;
 
 Indicates the issued certificates are to be signed with the key
@@ -196,12 +202,6 @@ certificate appears among the entries in the certificate database
 serial number counter as all other certificates sign with the
 self-signed certificate.
 
-=item B&lt;-passin&gt; I&lt;arg&gt;
-
-The key and certificate password source.
-For more information about the format of B&lt;arg&gt;
-see L&lt;openssl(1)/Pass Phrase Options&gt;.
-
 =item B&lt;-notext&gt;
 
 Don't output the text form of a certificate to the output file.
diff --git a/doc/man1/openssl-pkcs12.pod.in b/doc/man1/openssl-pkcs12.pod.in
index adcdc7c1a4..6c4fbfb563 100644
--- a/doc/man1/openssl-pkcs12.pod.in
+++ b/doc/man1/openssl-pkcs12.pod.in
@@ -11,9 +11,9 @@ B&lt;openssl&gt; B&lt;pkcs12&gt;
 [B&lt;-help&gt;]
 [B&lt;-export&gt;]
 [B&lt;-chain&gt;]
+[B&lt;-untrusted&gt; I&lt;filename&gt;]
 [B&lt;-inkey&gt; I&lt;file_or_id&gt;]
 [B&lt;-certfile&gt; I&lt;filename&gt;]
-[B&lt;-untrusted&gt; I&lt;filename&gt;]
 [B&lt;-passcerts&gt; I&lt;arg&gt;]
 [B&lt;-name&gt; I&lt;name&gt;]
 [B&lt;-caname&gt; I&lt;name&gt;]
@@ -231,7 +231,8 @@ Any certificates that are actually part of the chain are added to the output.
 
 =item B&lt;-passcerts&gt; I&lt;arg&gt;
 
-The password source for certificate input such as B&lt;-certfile&gt;.
+The password source for certificate input such as B&lt;-certfile&gt;
+and B&lt;-untrusted&gt;.
 For more information about the format of B&lt;arg&gt;
 see the B&lt;PASS PHRASE ARGUMENTS&gt; section in L&lt;openssl(1)&gt;.
 
diff --git a/engines/e_loader_attic.c b/engines/e_loader_attic.c
index 176c159c8c..936faa98b3 100644
--- a/engines/e_loader_attic.c
+++ b/engines/e_loader_attic.c
@@ -322,12 +322,13 @@ static OSSL_STORE_INFO *try_decode_PKCS12(const char *pem_name,
 
             *matchcount = 1;
 
-            if (PKCS12_verify_mac(p12, &quot;&quot;, 0)
+            if (!PKCS12_mac_present(p12)
+                || PKCS12_verify_mac(p12, &quot;&quot;, 0)
                 || PKCS12_verify_mac(p12, NULL, 0)) {
                 pass = &quot;&quot;;
             } else {
                 if ((pass = file_get_pass(ui_method, tpass, PEM_BUFSIZE,
-                                          &quot;PKCS12 import pass phrase&quot;, uri,
+                                          &quot;PKCS12 import&quot;, uri,
                                           ui_data)) == NULL) {
                     ATTICerr(0, ATTIC_R_PASSPHRASE_CALLBACK_ERROR);
                     goto p12_end;
@@ -1232,10 +1233,13 @@ static OSSL_STORE_INFO *file_load_try_decode(OSSL_STORE_LOADER_CTX *ctx,
                 }
                 if (result == NULL)
                     result = tmp_result;
+                if (result == NULL) /* e.g., PKCS#12 file decryption error */
+                    break;
             }
         }
 
-        if (*matchcount == 1 &amp;&amp; matching_handlers[0]-&gt;repeatable) {
+        if (result != NULL
+                &amp;&amp; *matchcount == 1 &amp;&amp; matching_handlers[0]-&gt;repeatable) {
             ctx-&gt;_.file.last_handler = matching_handlers[0];
             ctx-&gt;_.file.last_handler_ctx = handler_ctx;
         }
diff --git a/test/recipes/80-test_pkcs12.t b/test/recipes/80-test_pkcs12.t
index 07cd91f196..0f977d7755 100644
--- a/test/recipes/80-test_pkcs12.t
+++ b/test/recipes/80-test_pkcs12.t
@@ -66,17 +66,19 @@ ok(run(test([&quot;pkcs12_format_test&quot;])), &quot;test pkcs12 formats&quot;);
 ok(run(app([&quot;openssl&quot;, &quot;pkcs12&quot;, &quot;-noout&quot;,
             &quot;-password&quot;, &quot;pass:$pass&quot;,
             &quot;-in&quot;, srctop_file(&quot;test&quot;, &quot;shibboleth.pfx&quot;)])),
-   &quot;test_pkcs12&quot;);
+   &quot;test_load_cert_pkcs12&quot;);
 
 my @path = qw(test certs);
-my $tmpfile = &quot;tmp.p12&quot;;
+my $outfile1 = &quot;out1.p12&quot;;
+my $outfile2 = &quot;out2.p12&quot;;
+my $outfile3 = &quot;out3.p12&quot;;
 
 # Test the -chain option with -untrusted
 ok(run(app([&quot;openssl&quot;, &quot;pkcs12&quot;, &quot;-export&quot;, &quot;-chain&quot;,
             &quot;-CAfile&quot;,  srctop_file(@path,  &quot;sroot-cert.pem&quot;),
             &quot;-untrusted&quot;, srctop_file(@path, &quot;ca-cert.pem&quot;),
             &quot;-in&quot;, srctop_file(@path, &quot;ee-cert.pem&quot;),
-            &quot;-nokeys&quot;, &quot;-passout&quot;, &quot;pass:&quot;, &quot;-out&quot;, $tmpfile])),
+            &quot;-nokeys&quot;, &quot;-passout&quot;, &quot;pass:&quot;, &quot;-out&quot;, $outfile1])),
    &quot;test_pkcs12_chain_untrusted&quot;);
 
 # Test the -passcerts option
@@ -85,9 +87,8 @@ ok(run(app([&quot;openssl&quot;, &quot;pkcs12&quot;, &quot;-export&quot;,
             &quot;-certfile&quot;, srctop_file(@path, &quot;v3-certs-TDES.p12&quot;),
             &quot;-passcerts&quot;, &quot;pass:v3-certs&quot;,
             &quot;-nokeys&quot;, &quot;-passout&quot;, &quot;pass:v3-certs&quot;, &quot;-descert&quot;,
-            &quot;-out&quot;, $tmpfile])),
-   &quot;test_pkcs12_passcert&quot;);
-unlink $tmpfile;
+            &quot;-out&quot;, $outfile2])),
+   &quot;test_pkcs12_passcerts&quot;);
 
 # Test reading legacy PKCS#12 file
 ok(run(app([&quot;openssl&quot;, &quot;pkcs12&quot;, &quot;-export&quot;,
@@ -95,8 +96,7 @@ ok(run(app([&quot;openssl&quot;, &quot;pkcs12&quot;, &quot;-export&quot;,
             &quot;-passin&quot;, &quot;pass:v3-certs&quot;,
             &quot;-provider&quot;, &quot;default&quot;, &quot;-provider&quot;, &quot;legacy&quot;,
             &quot;-nokeys&quot;, &quot;-passout&quot;, &quot;pass:v3-certs&quot;, &quot;-descert&quot;,
-            &quot;-out&quot;, $tmpfile])),
-   &quot;test_pkcs12_passcert&quot;);
-unlink $tmpfile;
+            &quot;-out&quot;, $outfile3])),
+   &quot;test_pkcs12_passcerts_legacy&quot;);
 
 SetConsoleOutputCP($savedcp) if (defined($savedcp));
</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="032099.html">[openssl]  master update
</A></li>
	<LI>Next message: <A HREF="032106.html">[openssl]  master update
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#32105">[ date ]</a>
              <a href="thread.html#32105">[ thread ]</a>
              <a href="subject.html#32105">[ subject ]</a>
              <a href="author.html#32105">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="../../../mailman/listinfo/openssl-commits.html">More information about the openssl-commits
mailing list</a><br>
</body></html>
