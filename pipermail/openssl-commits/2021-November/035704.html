<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [tools]  master update
   </TITLE>
   <LINK REL="Index" HREF="https://mta.openssl.org/pipermail/openssl-commits/2021-November/index.html" >
   <LINK REL="made" HREF="mailto:openssl-commits%40openssl.org?Subject=Re%3A%20%5Btools%5D%20%20master%20update&In-Reply-To=%3C1637589314.359816.2538514.nullmailer%40dev.openssl.org%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="035615.html">
   <LINK REL="Next"  HREF="035705.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[tools]  master update</H1>
    <B>tomas at openssl.org</B> 
    <A HREF="mailto:openssl-commits%40openssl.org?Subject=Re%3A%20%5Btools%5D%20%20master%20update&In-Reply-To=%3C1637589314.359816.2538514.nullmailer%40dev.openssl.org%3E"
       TITLE="[tools]  master update">tomas at openssl.org
       </A><BR>
    <I>Mon Nov 22 13:55:14 UTC 2021</I>
    <P><UL>
        <LI>Previous message: <A HREF="035615.html">[tools]  master update
</A></li>
        <LI>Next message: <A HREF="035705.html">[tools]  master update
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#35704">[ date ]</a>
              <a href="thread.html#35704">[ thread ]</a>
              <a href="subject.html#35704">[ subject ]</a>
              <a href="author.html#35704">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>The branch master has been updated
       via  debabf50f5f2d7d0de575c69f8af642e9e84ae77 (commit)
       via  c728b5e389a29e30759acc1baa7dcf0d05b6f0d0 (commit)
       via  3bfc3b4bc4fbc9026afed38335f15b1b0cbbfd4c (commit)
       via  41d7c0e63bf92b762f0369f0a56e25dfc51b2061 (commit)
       via  9ce7e5fb4ed7546ba412d14422e4bf2713bc1440 (commit)
      from  b57692c1f0b653ba5e4cbb2ae581b6f9def2bb45 (commit)


- Log -----------------------------------------------------------------
commit debabf50f5f2d7d0de575c69f8af642e9e84ae77
Author: Dr. David von Oheimb &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">David.von.Oheimb at siemens.com</A>&gt;
Date:   Mon Nov 22 13:37:50 2021 +0100

    ghmerge: restore to original commit HEAD of target on error/abort
    
    Also add an empty line before the git log output for readability.
    
    Reviewed-by: Tomas Mraz &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">tomas at openssl.org</A>&gt;
    (Merged from <A HREF="https://github.com/openssl/tools/pull/97">https://github.com/openssl/tools/pull/97</A>)

commit c728b5e389a29e30759acc1baa7dcf0d05b6f0d0
Author: Dr. David von Oheimb &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">David.von.Oheimb at siemens.com</A>&gt;
Date:   Mon Nov 22 12:52:44 2021 +0100

    ghmerge: correct assignment to WORK_USED
    
    Reviewed-by: Tomas Mraz &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">tomas at openssl.org</A>&gt;
    (Merged from <A HREF="https://github.com/openssl/tools/pull/97">https://github.com/openssl/tools/pull/97</A>)

commit 3bfc3b4bc4fbc9026afed38335f15b1b0cbbfd4c
Author: Dr. David von Oheimb &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">David.von.Oheimb at siemens.com</A>&gt;
Date:   Mon Nov 22 12:31:18 2021 +0100

    ghmerge: Rename --ref to --target for clarity
    
    We are keeping --ref for backward compat.
    
    Reviewed-by: Tomas Mraz &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">tomas at openssl.org</A>&gt;
    (Merged from <A HREF="https://github.com/openssl/tools/pull/97">https://github.com/openssl/tools/pull/97</A>)

commit 41d7c0e63bf92b762f0369f0a56e25dfc51b2061
Author: Dr. David von Oheimb &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">David.von.Oheimb at siemens.com</A>&gt;
Date:   Wed Nov 17 14:14:36 2021 +0100

    ghmerge: extend --cherry-pick with the number of commits to pick
    
    Reviewed-by: Paul Dale &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">pauli at openssl.org</A>&gt;
    Reviewed-by: Tomas Mraz &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">tomas at openssl.org</A>&gt;
    (Merged from <A HREF="https://github.com/openssl/tools/pull/97">https://github.com/openssl/tools/pull/97</A>)

commit 9ce7e5fb4ed7546ba412d14422e4bf2713bc1440
Author: Dr. David von Oheimb &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">David.von.Oheimb at siemens.com</A>&gt;
Date:   Mon Oct 25 14:45:17 2021 +0200

    ghmerge: Fix behavior on failed cherry-pick, rebase, and pull
    
    Reviewed-by: Paul Dale &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">pauli at openssl.org</A>&gt;
    Reviewed-by: Tomas Mraz &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">tomas at openssl.org</A>&gt;
    (Merged from <A HREF="https://github.com/openssl/tools/pull/97">https://github.com/openssl/tools/pull/97</A>)

-----------------------------------------------------------------------

Summary of changes:
 review-tools/ghmerge | 106 +++++++++++++++++++++++++++++++++------------------
 1 file changed, 68 insertions(+), 38 deletions(-)

diff --git a/review-tools/ghmerge b/review-tools/ghmerge
index 7d1fc25..1371bfb 100755
--- a/review-tools/ghmerge
+++ b/review-tools/ghmerge
@@ -11,8 +11,9 @@ Option style arguments:
 --tools             Merge a tools PR (rather than openssl PR)
 --web               Merge a web PR (rather than openssl PR)
 --remote &lt;remote&gt;   Repo to merge with (rather than git.openssl.org), usually 'upstream'
---ref &lt;branch&gt;      Branch to merge with (rather than current branch), usually 'master'
---cherry-pick       Use cherry-pick (rather than pull --rebase)
+--target &lt;branch&gt;   Merge target (rather than current branch), usually 'master'
+--ref &lt;branch&gt;      A synonym for --target
+--cherry-pick [&lt;n&gt;] Cherry-pick the last n (1 &lt;= n &lt;= 99, default: 1) commits, rather than rebasing
 --squash            Squash new commits non-interactively (allows editing msg)
 --noautosquash      Do not automatically squash fixups in interactive rebase
 --nobuild           Do not call 'openssbuild' before merging
@@ -22,7 +23,8 @@ Examples:
   ghmerge 12345 mattcaswell
   ghmerge 12345 paulidale t8m --nobuild --myemail=<A HREF="../../../mailman/listinfo/openssl-commits.html">dev at ddvo.net</A>
   ghmerge edd05b7^^^^..19692bb2c32 --squash -- 12345 levitte
-  ghmerge 12345 slontis --ref openssl-3.0&quot;
+  ghmerge 12345 slontis --target openssl-3.0
+  ghmerge --nobuild --target openssl-3.0 --cherry-pick 3 16051 paulidale&quot;
     exit 9
 }
 
@@ -33,7 +35,7 @@ PICK=no
 INTERACTIVE=yes
 AUTOSQUASH=&quot;--autosquash&quot;
 REMOTE=&quot;&quot;
-REF=&quot;&quot;
+TARGET=&quot;&quot;
 BUILD=yes
 [ -z ${CC+x} ] &amp;&amp; CC=&quot;ccache gcc&quot; # opensslbuild will otherwise use &quot;ccache clang-3.6&quot;
 
@@ -59,7 +61,11 @@ while [ $# -ne 0 ]; do
         WHAT=web ; BUILD=no ; shift
         ;;
     --cherry-pick)
-        PICK=yes ; shift
+        shift;
+        PICK=1;
+        if [ &quot;$1&quot; != &quot;&quot; ] &amp;&amp; [ $1 -ge 1 ] 2&gt;/dev/null &amp;&amp; [ $1 -le 99 ]; then
+            PICK=$1 ; shift
+        fi
         ;;
     --noautosquash)
         AUTOSQUASH=&quot;&quot; ; shift
@@ -77,12 +83,12 @@ while [ $# -ne 0 ]; do
         fi
         shift; REMOTE=$1; shift
         ;;
-    --ref)
+    --target|--ref)
         if [ $# -lt 2 ] ; then
             echo &quot;Missing argument of '$1'&quot;
             usage_exit
         fi
-        shift; REF=$1; shift
+        shift; TARGET=$1; shift
         ;;
     --)
         if [ $# -lt 3 ] ; then
@@ -165,7 +171,18 @@ function cleanup {
     rv=$?
     echo # make sure to enter new line, needed, e.g., after Ctrl-C
     [ $rv -ne 0 ] &amp;&amp; echo -e &quot;\nghmerge failed&quot;
-    if [ &quot;$REF&quot; != &quot;$ORIG_REF&quot; ] || [ &quot;$WORK_USED&quot; != &quot;&quot; ]; then
+    if [ &quot;$REBASING&quot; == 1 ] ; then
+        git rebase --abort 2&gt;/dev/null || true
+    fi
+    if [ &quot;$CHERRYPICKING&quot; == 1 ] ; then
+        echo &quot;Hint: maybe --cherry-pick was not given a suitable &lt;n&gt; parameter.&quot;
+        git cherry-pick --abort 2&gt;/dev/null || true
+    fi
+    if [ &quot;$ORIG_TARGET_HEAD&quot; != &quot;&quot; ]; then
+        echo Restoring original commit HEAD of $TARGET
+        git reset --hard &quot;$ORIG_TARGET_HEAD&quot;
+    fi
+    if [ &quot;$TARGET&quot; != &quot;$ORIG_REF&quot; ] || [ &quot;$WORK_USED&quot; != &quot;&quot; ]; then
         echo Returning to previous branch $ORIG_REF
         git checkout -q $ORIG_REF
     fi
@@ -173,61 +190,73 @@ function cleanup {
         git branch -qD $WORK_USED
     fi
     if [ &quot;$STASH_OUT&quot; != &quot;No local changes to save&quot; ]; then
-        git stash pop -q # restore original state, pruning any leftover commits added locally
+        git stash pop -q # restore original state of $ORIG_REF, pruning any leftover commits added locally
     fi
 }
 trap 'cleanup' EXIT
 
-[ &quot;$REF&quot; = &quot;&quot; ] &amp;&amp; REF=$ORIG_REF
-if [ &quot;$REF&quot; != &quot;$ORIG_REF&quot; ]; then    
-    echo -n &quot;Press Enter to checkout $REF: &quot;; read foo
-    git checkout $REF
+[ &quot;$TARGET&quot; = &quot;&quot; ] &amp;&amp; TARGET=$ORIG_REF
+if [ &quot;$TARGET&quot; != &quot;$ORIG_REF&quot; ]; then
+    echo -n &quot;Press Enter to checkout $TARGET: &quot;; read foo
+    git checkout $TARGET
 fi
 
-echo -n &quot;Press Enter to pull the latest $REMOTE/$REF: &quot;; read foo
-git pull $REMOTE $REF || (git rebase --abort; exit 1)
+echo -n &quot;Press Enter to pull the latest $REMOTE/$TARGET: &quot;; read foo
+REBASING=1
+git pull $REMOTE $TARGET || exit 1
+REBASING=
 
-WORK_USED=$WORK
 # append new commits from $REPO/$BRANCH
-if [ &quot;$PICK&quot; != &quot;yes&quot; ]; then
-    echo Rebasing $REPO/$BRANCH on $REF...
+if [ &quot;$PICK&quot; == &quot;no&quot; ]; then
+    echo Rebasing $REPO/$BRANCH on $TARGET...
     git fetch $REPO $BRANCH &amp;&amp; git checkout -b $WORK FETCH_HEAD
     WORK_USED=$WORK
-    git rebase $REF || (echo 'Fix or Ctrl-d to abort' ; read || (git rebase --abort; exit 1))
+    REBASING=1
+    git rebase $TARGET || (echo 'Fix or Ctrl-d to abort' ; read || exit 1)
+    REBASING=
 else
-    echo Cherry-picking $REPO/$BRANCH to $REF...
-    git checkout -b $WORK $REF
+    echo Cherry-picking $REPO/$BRANCH to $TARGET...
+    git checkout -b $WORK $TARGET
     WORK_USED=$WORK
-    git fetch $REPO $BRANCH &amp;&amp; git cherry-pick FETCH_HEAD
+    CHERRYPICKING=1
+    git fetch $REPO $BRANCH &amp;&amp; (git cherry-pick FETCH_HEAD~$PICK..FETCH_HEAD || exit 1)
+    CHERRYPICKING=
 fi
 
-echo Diff against $REMOTE/$REF
-git diff $REMOTE/$REF
+echo Diff against $REMOTE/$TARGET
+git diff $REMOTE/$TARGET
 
 if [ &quot;$INTERACTIVE&quot; == &quot;yes&quot; ] ; then
-    echo -n &quot;Press Enter to interactively rebase $AUTOSQUASH on $REMOTE/$REF: &quot;; read foo
-    git rebase -i $AUTOSQUASH $REMOTE/$REF || (git rebase --abort; exit 1)
-    echo &quot;Calling addrev $ADDREVOPTS --prnum=$PRNUM $TEAM $REMOTE/$REF..&quot;
-    addrev $ADDREVOPTS --prnum=$PRNUM $TEAM $REMOTE/$REF..
+    echo -n &quot;Press Enter to interactively rebase $AUTOSQUASH on $REMOTE/$TARGET: &quot;; read foo
+    REBASING=1
+    git rebase -i $AUTOSQUASH $REMOTE/$TARGET || exit 1
+    REBASING=
+    echo &quot;Calling addrev $ADDREVOPTS --prnum=$PRNUM $TEAM $REMOTE/$TARGET..&quot;
+    addrev $ADDREVOPTS --prnum=$PRNUM $TEAM $REMOTE/$TARGET..
 fi
 
-echo Log since $REMOTE/$REF
-git log $REMOTE/$REF..
+echo
+echo Log since $REMOTE/$TARGET
+git log $REMOTE/$TARGET..
 
-git checkout $REF
+git checkout $TARGET
 if [ &quot;$INTERACTIVE&quot; != &quot;yes&quot; ] ; then
-    echo -n &quot;Press Enter to non-interactively merge --squash $BRANCH to $REMOTE/$REF: &quot;; read foo
+    echo -n &quot;Press Enter to non-interactively merge --squash $BRANCH to $REMOTE/$TARGET: &quot;; read foo
+    ORIG_TARGET_HEAD=`git show -s --format=&quot;%H&quot;`
     git merge --ff-only --no-commit --squash $WORK
     AUTHOR=`git show --no-patch --pretty=&quot;format:%an &lt;%ae&gt;&quot; $WORK`
     git commit --author=&quot;$AUTHOR&quot;
-    addrev $ADDREVOPTS --prnum=$PRNUM $TEAM $REMOTE/${REF}..
+    addrev $ADDREVOPTS --prnum=$PRNUM $TEAM $REMOTE/${TARGET}..
 else
-    # echo -n &quot;Press Enter to merge to $REMOTE/$REF: &quot;; read foo
+    # echo -n &quot;Press Enter to merge to $TARGET: &quot;; read foo
+    echo
+    echo &quot;Merging to $TARGET&quot;
+    ORIG_TARGET_HEAD=`git show -s --format=&quot;%H&quot;`
     git merge --ff-only $WORK
 fi
 
-echo New log since $REMOTE/$REF
-git log $REMOTE/$REF..
+echo New log since $REMOTE/$TARGET
+git log $REMOTE/$TARGET..
 
 if [ &quot;$BUILD&quot; == &quot;yes&quot; ] ; then
     echo Rebuilding...
@@ -235,7 +264,7 @@ if [ &quot;$BUILD&quot; == &quot;yes&quot; ] ; then
 fi
 
 while true ; do
-    echo -n &quot;Enter 'y'/'yes' to push to $REMOTE/$REF or 'n'/'no' to abort: &quot;
+    echo -n &quot;Enter 'y'/'yes' to push to $REMOTE/$TARGET or 'n'/'no' to abort: &quot;
     read x
     x=&quot;`echo $x | tr A-Z a-z`&quot;
     if [ &quot;$x&quot; = &quot;y&quot; -o &quot;$x&quot; = &quot;yes&quot; -o &quot;$x&quot; = &quot;n&quot; -o &quot;$x&quot; = &quot;no&quot; ] ; then
@@ -244,5 +273,6 @@ while true ; do
 done
 
 if [ &quot;$x&quot; = &quot;y&quot; -o &quot;$x&quot; = &quot;yes&quot; ] ; then
-    git push -v $REMOTE $REF
+    git push -v $REMOTE $TARGET
+    ORIG_TARGET_HEAD=
 fi
</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="035615.html">[tools]  master update
</A></li>
	<LI>Next message: <A HREF="035705.html">[tools]  master update
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#35704">[ date ]</a>
              <a href="thread.html#35704">[ thread ]</a>
              <a href="subject.html#35704">[ subject ]</a>
              <a href="author.html#35704">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="../../../mailman/listinfo/openssl-commits.html">More information about the openssl-commits
mailing list</a><br>
</body></html>
