<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [tools]  master update
   </TITLE>
   <LINK REL="Index" HREF="https://mta.openssl.org/pipermail/openssl-commits/2021-November/index.html" >
   <LINK REL="made" HREF="mailto:openssl-commits%40openssl.org?Subject=Re%3A%20%5Btools%5D%20%20master%20update&In-Reply-To=%3C1635772162.061974.4544.nullmailer%40dev.openssl.org%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="035566.html">
   <LINK REL="Next"  HREF="035568.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[tools]  master update</H1>
    <B>tomas at openssl.org</B> 
    <A HREF="mailto:openssl-commits%40openssl.org?Subject=Re%3A%20%5Btools%5D%20%20master%20update&In-Reply-To=%3C1635772162.061974.4544.nullmailer%40dev.openssl.org%3E"
       TITLE="[tools]  master update">tomas at openssl.org
       </A><BR>
    <I>Mon Nov  1 13:09:22 UTC 2021</I>
    <P><UL>
        <LI>Previous message: <A HREF="035566.html">[tools]  master update
</A></li>
        <LI>Next message: <A HREF="035568.html">[tools]  master update
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#35567">[ date ]</a>
              <a href="thread.html#35567">[ thread ]</a>
              <a href="subject.html#35567">[ subject ]</a>
              <a href="author.html#35567">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>The branch master has been updated
       via  4a5441d5602435cd801aeee4add5908cfc86acab (commit)
       via  522710ebddbc2b17ad949174c3b30900be36e79c (commit)
       via  fb3ea4fea8a625bbf36516d0e329bf4790a12641 (commit)
       via  f6ecc7fef076779d1dde76fc6c7e4719aa685cb6 (commit)
       via  b92201c5a37ae8ef57298899464fc6c9eac0e70a (commit)
       via  e2c1ff33aaa776b465f23989107e2a72d3d2804f (commit)
      from  3189d5753970fa290365b02acb535ea5ef09e995 (commit)


- Log -----------------------------------------------------------------
commit 4a5441d5602435cd801aeee4add5908cfc86acab
Author: Dr. David von Oheimb &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">David.von.Oheimb at siemens.com</A>&gt;
Date:   Mon Oct 25 10:01:19 2021 +0200

    pick-to-branch: Further improve user guidance on commit id
    
    Reviewed-by: Paul Dale &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">pauli at openssl.org</A>&gt;
    Reviewed-by: Tomas Mraz &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">tomas at openssl.org</A>&gt;
    (Merged from <A HREF="https://github.com/openssl/tools/pull/95">https://github.com/openssl/tools/pull/95</A>)

commit 522710ebddbc2b17ad949174c3b30900be36e79c
Author: Dr. David von Oheimb &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">David.von.Oheimb at siemens.com</A>&gt;
Date:   Mon Oct 25 09:47:18 2021 +0200

    pick-to-branch: Fix behavior on failed cherry-pick
    
    Reviewed-by: Paul Dale &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">pauli at openssl.org</A>&gt;
    Reviewed-by: Tomas Mraz &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">tomas at openssl.org</A>&gt;
    (Merged from <A HREF="https://github.com/openssl/tools/pull/95">https://github.com/openssl/tools/pull/95</A>)

commit fb3ea4fea8a625bbf36516d0e329bf4790a12641
Author: Dr. David von Oheimb &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">David.von.Oheimb at siemens.com</A>&gt;
Date:   Mon Oct 25 09:36:51 2021 +0200

    pick-to-branch: Improve diagnostics on bad target branch
    
    Reviewed-by: Paul Dale &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">pauli at openssl.org</A>&gt;
    Reviewed-by: Tomas Mraz &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">tomas at openssl.org</A>&gt;
    (Merged from <A HREF="https://github.com/openssl/tools/pull/95">https://github.com/openssl/tools/pull/95</A>)

commit f6ecc7fef076779d1dde76fc6c7e4719aa685cb6
Author: Dr. David von Oheimb &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">David.von.Oheimb at siemens.com</A>&gt;
Date:   Sat Oct 23 13:10:41 2021 +0200

    pick-to-branch: Fix the case that commit id is derived from HEAD of master
    
    Reviewed-by: Paul Dale &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">pauli at openssl.org</A>&gt;
    Reviewed-by: Tomas Mraz &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">tomas at openssl.org</A>&gt;
    (Merged from <A HREF="https://github.com/openssl/tools/pull/95">https://github.com/openssl/tools/pull/95</A>)

commit b92201c5a37ae8ef57298899464fc6c9eac0e70a
Author: Dr. David von Oheimb &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">David.von.Oheimb at siemens.com</A>&gt;
Date:   Sat Oct 23 12:49:30 2021 +0200

    pick-to-branch: Preserve current branch and its state if it is not the target
    
    Reviewed-by: Paul Dale &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">pauli at openssl.org</A>&gt;
    Reviewed-by: Tomas Mraz &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">tomas at openssl.org</A>&gt;
    (Merged from <A HREF="https://github.com/openssl/tools/pull/95">https://github.com/openssl/tools/pull/95</A>)

commit e2c1ff33aaa776b465f23989107e2a72d3d2804f
Author: Dr. David von Oheimb &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">David.von.Oheimb at siemens.com</A>&gt;
Date:   Sat Oct 23 12:32:35 2021 +0200

    pick-to-branch: Improve user guidance
    
    Reviewed-by: Paul Dale &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">pauli at openssl.org</A>&gt;
    Reviewed-by: Tomas Mraz &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">tomas at openssl.org</A>&gt;
    (Merged from <A HREF="https://github.com/openssl/tools/pull/95">https://github.com/openssl/tools/pull/95</A>)

-----------------------------------------------------------------------

Summary of changes:
 review-tools/pick-to-branch | 61 ++++++++++++++++++++++++++++++++++-----------
 1 file changed, 47 insertions(+), 14 deletions(-)

diff --git a/review-tools/pick-to-branch b/review-tools/pick-to-branch
index c446763..6513a36 100755
--- a/review-tools/pick-to-branch
+++ b/review-tools/pick-to-branch
@@ -1,6 +1,15 @@
 #! /bin/bash
 
-# If one arg, intuit commit id from master
+function usage {
+    echo &quot;Usage: pick-to-branch [&lt;id&gt;] &lt;branch&gt;
+    Cherry-pick a commit on the given release target branch.
+    If this is not the current branch, the current branch and its state are preserved.
+
+    The commit can be given in the form of a branch name.
+    If no &lt;id&gt; arg is given, intuit commit id from master.
+    The &lt;branch&gt; arg must match a release branch or start with 'm' for master.
+    A release branch may be given simply as 102, 110, 111, 30, 31.&quot;
+}
 
 case $# in
 2)
@@ -8,11 +17,11 @@ case $# in
     b=$2
     ;;
 1)
-    id=`git branch -v | awk '$2==&quot;master&quot; { print $3; }'`
+    id=`git branch -v | awk '$1==&quot;master&quot; { print $2; }'`
     b=$1
     ;;
 *)
-    echo &quot;Usage $0 [commitid] branch&quot;
+    usage
     exit 1
     ;;
 esac
@@ -31,22 +40,27 @@ case $b in
 *3*0*)
     branch=openssl-3.0
     ;;
+*3*1*)
+    branch=openssl-3.1
+    ;;
 m*)
     branch=master
     ;;
 *)
-    echo Unknown branch
+    echo Unknown release target branch \'$b\'
     exit 1
     ;;
 esac
 
-echo &quot;id is $id&quot;
-echo &quot;branch is $branch&quot;
-echo &quot;Are these correct?&quot;
+echo &quot;Commit to chery-pick is:&quot;
+git show $id | head -n 5
+echo
+echo &quot;Target branch is: $branch&quot;
+echo &quot;Are both of these correct?&quot;
 
 while true
 do
-    echo -n &quot;Enter 'yes' to continue or 'no' to abort: &quot;
+    echo -n &quot;Enter 'y'/'yes' to continue or 'n'/'no' to abort: &quot;
     read x
     x=&quot;`echo $x | tr A-Z a-z`&quot;
     if [ &quot;$x&quot; = &quot;y&quot; -o &quot;$x&quot; = &quot;yes&quot; -o &quot;$x&quot; = &quot;n&quot; -o &quot;$x&quot; = &quot;no&quot; ]
@@ -60,13 +74,34 @@ then
     exit 1
 fi
 
-git checkout --quiet master || exit 1
-git checkout $branch || exit 1
-git cherry-pick -e -x $id
+
+ORIG_REF=`git rev-parse --abbrev-ref HEAD` # usually this will be 'master'
+if [ &quot;$branch&quot; != &quot;$ORIG_REF&quot; ]; then
+    STASH_OUT=`git stash`
+fi
+
+function cleanup {
+    rv=$?
+    echo # make sure to enter new line, needed, e.g., after Ctrl-C
+    [ $rv -ne 0 ] &amp;&amp; echo -e &quot;pick-to-branch failed&quot;
+    if [ &quot;$branch&quot; != &quot;$ORIG_REF&quot; ]; then
+        echo Returning to previous branch $ORIG_REF
+        git checkout -q $ORIG_REF
+        if [ &quot;$STASH_OUT&quot; != &quot;No local changes to save&quot; ]; then
+            git stash pop -q # restore original state, pruning any leftover commits added locally
+        fi
+    fi
+}
+set -o errexit
+trap 'cleanup' EXIT
+
+git checkout --quiet master
+git checkout $branch
+git cherry-pick -e -x $id || (git cherry-pick --abort; exit 1)
 
 while true
 do
-    echo -n &quot;Enter 'yes' to push or 'no' to abort: &quot;
+    echo -n &quot;Enter 'y'/'yes' to push or 'n'/'no' to abort: &quot;
     read x
     x=&quot;`echo $x | tr A-Z a-z`&quot;
     if [ &quot;$x&quot; = &quot;y&quot; -o &quot;$x&quot; = &quot;yes&quot; -o &quot;$x&quot; = &quot;n&quot; -o &quot;$x&quot; = &quot;no&quot; ]
@@ -79,5 +114,3 @@ if [ &quot;$x&quot; = &quot;y&quot; -o &quot;$x&quot; = &quot;yes&quot; ]
 then
     git push
 fi
-
-git checkout master
</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="035566.html">[tools]  master update
</A></li>
	<LI>Next message: <A HREF="035568.html">[tools]  master update
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#35567">[ date ]</a>
              <a href="thread.html#35567">[ thread ]</a>
              <a href="subject.html#35567">[ subject ]</a>
              <a href="author.html#35567">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="../../../mailman/listinfo/openssl-commits.html">More information about the openssl-commits
mailing list</a><br>
</body></html>
