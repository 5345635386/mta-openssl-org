<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [openssl]  master update
   </TITLE>
   <LINK REL="Index" HREF="https://mta.openssl.org/pipermail/openssl-commits/2021-April/index.html" >
   <LINK REL="made" HREF="mailto:openssl-commits%40openssl.org?Subject=Re%3A%20%5Bopenssl%5D%20%20master%20update&In-Reply-To=%3C1619459540.919325.13032.nullmailer%40dev.openssl.org%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="034018.html">
   <LINK REL="Next"  HREF="034024.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[openssl]  master update</H1>
    <B>tomas at openssl.org</B> 
    <A HREF="mailto:openssl-commits%40openssl.org?Subject=Re%3A%20%5Bopenssl%5D%20%20master%20update&In-Reply-To=%3C1619459540.919325.13032.nullmailer%40dev.openssl.org%3E"
       TITLE="[openssl]  master update">tomas at openssl.org
       </A><BR>
    <I>Mon Apr 26 17:52:20 UTC 2021</I>
    <P><UL>
        <LI>Previous message: <A HREF="034018.html">[openssl]  master update
</A></li>
        <LI>Next message: <A HREF="034024.html">[openssl]  master update
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#34022">[ date ]</a>
              <a href="thread.html#34022">[ thread ]</a>
              <a href="subject.html#34022">[ subject ]</a>
              <a href="author.html#34022">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>The branch master has been updated
       via  f1ffaaeece5efb7d2f4859a59e3164edf9b4b769 (commit)
      from  6c9bc258d2e9e7b500236a1c696da1f384f0b907 (commit)


- Log -----------------------------------------------------------------
commit f1ffaaeece5efb7d2f4859a59e3164edf9b4b769
Author: Shane Lontis &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">shane.lontis at oracle.com</A>&gt;
Date:   Thu Apr 15 18:25:17 2021 +1000

    Fixes related to separation of DH and DHX types
    
    Fix dh_rfc5114 option in genpkey.
    
    Fixes #14145
    Fixes #13956
    Fixes #13952
    Fixes #13871
    Fixes #14054
    Fixes #14444
    
    Updated documentation for app to indicate what options are available for
    DH and DHX keys.
    
    DH and DHX now have different keymanager gen_set_params() methods.
    
    Added CHANGES entry to indicate the breaking change.
    
    Reviewed-by: Tomas Mraz &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">tomas at openssl.org</A>&gt;
    (Merged from <A HREF="https://github.com/openssl/openssl/pull/14883">https://github.com/openssl/openssl/pull/14883</A>)

-----------------------------------------------------------------------

Summary of changes:
 CHANGES.md                                         |   7 +
 crypto/dh/dh_pmeth.c                               |  43 ++---
 crypto/evp/ctrl_params_translate.c                 | 104 +++++++-----
 crypto/evp/dh_support.c                            |  29 +++-
 crypto/evp/p_lib.c                                 |  33 +++-
 crypto/ffc/ffc_dh.c                                |   4 +-
 doc/man1/openssl-genpkey.pod.in                    | 186 +++++++++++++++++----
 doc/man7/EVP_PKEY-DH.pod                           |  60 ++++---
 doc/man7/EVP_PKEY-FFC.pod                          |  36 ++--
 include/crypto/dh.h                                |   2 +-
 providers/implementations/keymgmt/dh_kmgmt.c       | 125 ++++++++++----
 test/recipes/15-test_gendh.t                       |  33 +---
 test/recipes/15-test_gendhparam.t                  | 170 +++++++++++++++++++
 test/recipes/20-test_dhparam_check.t               |  14 +-
 .../dh5114_1_pkcs3.pem =&gt; valid/dh_5114_1.pem}     |   0
 .../dh5114_2_pkcs3.pem =&gt; valid/dh_5114_2.pem}     |   0
 .../dh5114_3_pkcs3.pem =&gt; valid/dh_5114_3.pem}     |   0
 .../dh5114_2_pkcs3.pem =&gt; valid/dhx_5114_2.pem}    |  10 +-
 18 files changed, 629 insertions(+), 227 deletions(-)
 create mode 100644 test/recipes/15-test_gendhparam.t
 rename test/recipes/20-test_dhparam_check_data/{invalid/dh5114_1_pkcs3.pem =&gt; valid/dh_5114_1.pem} (100%)
 copy test/recipes/20-test_dhparam_check_data/{invalid/dh5114_2_pkcs3.pem =&gt; valid/dh_5114_2.pem} (100%)
 rename test/recipes/20-test_dhparam_check_data/{invalid/dh5114_3_pkcs3.pem =&gt; valid/dh_5114_3.pem} (100%)
 rename test/recipes/20-test_dhparam_check_data/{invalid/dh5114_2_pkcs3.pem =&gt; valid/dhx_5114_2.pem} (71%)

diff --git a/CHANGES.md b/CHANGES.md
index d2d9e01f35..480c4091a9 100644
--- a/CHANGES.md
+++ b/CHANGES.md
@@ -23,6 +23,13 @@ OpenSSL 3.0
 
 ### Changes between 1.1.1 and 3.0 [xx XXX xxxx]
 
+ * For the key types DH and DHX the allowed settable parameters are now different.
+   Previously (in 1.1.1) these conflicting parameters were allowed, but will now
+   result in errors. See EVP_PKEY-DH(7) for further details. This affects the
+   behaviour of openssl-genpkey(1) for DH parameter generation.
+
+   *Shane Lontis*
+
  * The default manual page suffix ($MANSUFFIX) has been changed to &quot;ossl&quot;
 
    *Matt Caswell*
diff --git a/crypto/dh/dh_pmeth.c b/crypto/dh/dh_pmeth.c
index affe40a53c..78d46aba22 100644
--- a/crypto/dh/dh_pmeth.c
+++ b/crypto/dh/dh_pmeth.c
@@ -35,7 +35,6 @@ typedef struct {
     int pad;
     /* message digest used for parameter generation */
     const EVP_MD *md;
-    int rfc5114_param;
     int param_nid;
     /* Keygen callback info */
     int gentmp[2];
@@ -98,7 +97,6 @@ static int pkey_dh_copy(EVP_PKEY_CTX *dst, const EVP_PKEY_CTX *src)
     dctx-&gt;paramgen_type = sctx-&gt;paramgen_type;
     dctx-&gt;pad = sctx-&gt;pad;
     dctx-&gt;md = sctx-&gt;md;
-    dctx-&gt;rfc5114_param = sctx-&gt;rfc5114_param;
     dctx-&gt;param_nid = sctx-&gt;param_nid;
 
     dctx-&gt;kdf_type = sctx-&gt;kdf_type;
@@ -156,11 +154,11 @@ static int pkey_dh_ctrl(EVP_PKEY_CTX *ctx, int type, int p1, void *p2)
     case EVP_PKEY_CTRL_DH_RFC5114:
         if (p1 &lt; 1 || p1 &gt; 3 || dctx-&gt;param_nid != NID_undef)
             return -2;
-        dctx-&gt;rfc5114_param = p1;
+        dctx-&gt;param_nid = p1;
         return 1;
 
     case EVP_PKEY_CTRL_DH_NID:
-        if (p1 &lt;= 0 || dctx-&gt;rfc5114_param != 0)
+        if (p1 &lt;= 0 || dctx-&gt;param_nid != NID_undef)
             return -2;
         dctx-&gt;param_nid = p1;
         return 1;
@@ -233,11 +231,12 @@ static int pkey_dh_ctrl_str(EVP_PKEY_CTX *ctx,
     }
     if (strcmp(type, &quot;dh_rfc5114&quot;) == 0) {
         DH_PKEY_CTX *dctx = ctx-&gt;data;
-        int len;
-        len = atoi(value);
-        if (len &lt; 0 || len &gt; 3)
+        int id;
+
+        id = atoi(value);
+        if (id &lt; 0 || id &gt; 3)
             return -2;
-        dctx-&gt;rfc5114_param = len;
+        dctx-&gt;param_nid = id;
         return 1;
     }
     if (strcmp(type, &quot;dh_param&quot;) == 0) {
@@ -331,36 +330,16 @@ static int pkey_dh_paramgen(EVP_PKEY_CTX *ctx,
     /*
      * Look for a safe prime group for key establishment. Which uses
      * either RFC_3526 (modp_XXXX) or RFC_7919 (ffdheXXXX).
+     * RFC_5114 is also handled here for param_nid = (1..3)
      */
     if (dctx-&gt;param_nid != NID_undef) {
+        int type = dctx-&gt;param_nid &lt;= 3 ? EVP_PKEY_DHX : EVP_PKEY_DH;
+
         if ((dh = DH_new_by_nid(dctx-&gt;param_nid)) == NULL)
             return 0;
-        EVP_PKEY_assign(pkey, EVP_PKEY_DH, dh);
-        return 1;
-    }
-
-#ifndef FIPS_MODULE
-    if (dctx-&gt;rfc5114_param) {
-        switch (dctx-&gt;rfc5114_param) {
-        case 1:
-            dh = DH_get_1024_160();
-            break;
-
-        case 2:
-            dh = DH_get_2048_224();
-            break;
-
-        case 3:
-            dh = DH_get_2048_256();
-            break;
-
-        default:
-            return -2;
-        }
-        EVP_PKEY_assign(pkey, EVP_PKEY_DHX, dh);
+        EVP_PKEY_assign(pkey, type, dh);
         return 1;
     }
-#endif /* FIPS_MODULE */
 
     if (ctx-&gt;pkey_gencb != NULL) {
         pcb = BN_GENCB_new();
diff --git a/crypto/evp/ctrl_params_translate.c b/crypto/evp/ctrl_params_translate.c
index 8f4ffd3bc4..f48e723c33 100644
--- a/crypto/evp/ctrl_params_translate.c
+++ b/crypto/evp/ctrl_params_translate.c
@@ -977,7 +977,7 @@ static int fix_oid(enum state state,
     return ret;
 }
 
-/* EVP_PKEY_CTRL_DH_NID, ...??? */
+/* EVP_PKEY_CTRL_DH_NID */
 static int fix_dh_nid(enum state state,
                       const struct translation_st *translation,
                       struct translation_ctx_st *ctx)
@@ -987,7 +987,7 @@ static int fix_dh_nid(enum state state,
     if ((ret = default_check(state, translation, ctx)) &lt;= 0)
         return ret;
 
-    /* This is currently only settable */
+    /* This is only settable */
     if (ctx-&gt;action_type != SET)
         return 0;
 
@@ -997,16 +997,30 @@ static int fix_dh_nid(enum state state,
         ctx-&gt;p1 = 0;
     }
 
-    if ((ret = default_fixup_args(state, translation, ctx)) &lt;= 0)
+    return default_fixup_args(state, translation, ctx);
+}
+
+/* EVP_PKEY_CTRL_DH_RFC5114 */
+static int fix_dh_nid5114(enum state state,
+                          const struct translation_st *translation,
+                          struct translation_ctx_st *ctx)
+{
+    int ret;
+
+    if ((ret = default_check(state, translation, ctx)) &lt;= 0)
         return ret;
 
-    if (state == PRE_PARAMS_TO_CTRL) {
-        ctx-&gt;p1 =
-            ossl_ffc_named_group_get_uid(ossl_ffc_name_to_dh_named_group(ctx-&gt;p2));
-        ctx-&gt;p2 = NULL;
+    /* This is only settable */
+    if (ctx-&gt;action_type != SET)
+        return 0;
+
+    if (state == PRE_CTRL_STR_TO_PARAMS) {
+        ctx-&gt;p2 = (char *)ossl_ffc_named_group_get_name
+            (ossl_ffc_uid_to_dh_named_group(atoi(ctx-&gt;p2)));
+        ctx-&gt;p1 = 0;
     }
 
-    return ret;
+    return default_fixup_args(state, translation, ctx);
 }
 
 /* EVP_PKEY_CTRL_DH_PARAMGEN_TYPE */
@@ -1019,24 +1033,16 @@ static int fix_dh_paramgen_type(enum state state,
     if ((ret = default_check(state, translation, ctx)) &lt;= 0)
         return ret;
 
-    /* This is currently only settable */
+    /* This is only settable */
     if (ctx-&gt;action_type != SET)
         return 0;
 
-    if (state == PRE_CTRL_TO_PARAMS) {
-        ctx-&gt;p2 = (char *)ossl_dh_gen_type_id2name(ctx-&gt;p1);
-        ctx-&gt;p1 = 0;
-    }
-
-    if ((ret = default_fixup_args(state, translation, ctx)) &lt;= 0)
-        return ret;
-
-    if (state == PRE_PARAMS_TO_CTRL) {
-        ctx-&gt;p1 = ossl_dh_gen_type_name2id(ctx-&gt;p2);
-        ctx-&gt;p2 = NULL;
+    if (state == PRE_CTRL_STR_TO_PARAMS) {
+        ctx-&gt;p2 = (char *)ossl_dh_gen_type_id2name(atoi(ctx-&gt;p2));
+        ctx-&gt;p1 = strlen(ctx-&gt;p2);
     }
 
-    return ret;
+    return default_fixup_args(state, translation, ctx);
 }
 
 /* EVP_PKEY_CTRL_EC_PARAM_ENC */
@@ -1927,35 +1933,47 @@ static const struct translation_st evp_pkey_ctx_translations[] = {
       EVP_PKEY_CTRL_GET_DH_KDF_OID, NULL, NULL,
       OSSL_KDF_PARAM_CEK_ALG, OSSL_PARAM_UTF8_STRING, fix_oid },
 
-    { SET, EVP_PKEY_DH, 0, EVP_PKEY_OP_DERIVE,
-      EVP_PKEY_CTRL_DH_PAD, &quot;dh_pad&quot;, NULL,
-      OSSL_EXCHANGE_PARAM_PAD, OSSL_PARAM_UNSIGNED_INTEGER, NULL },
+    /* DHX Keygen Parameters that are shared with DH */
+    { SET, EVP_PKEY_DHX, 0, EVP_PKEY_OP_PARAMGEN,
+      EVP_PKEY_CTRL_DH_PARAMGEN_TYPE, &quot;dh_paramgen_type&quot;, NULL,
+      OSSL_PKEY_PARAM_FFC_TYPE, OSSL_PARAM_UTF8_STRING, fix_dh_paramgen_type },
+    { SET, EVP_PKEY_DHX, 0, EVP_PKEY_OP_PARAMGEN,
+      EVP_PKEY_CTRL_DH_PARAMGEN_PRIME_LEN, &quot;dh_paramgen_prime_len&quot;, NULL,
+      OSSL_PKEY_PARAM_FFC_PBITS, OSSL_PARAM_UNSIGNED_INTEGER, NULL },
+    { SET, EVP_PKEY_DHX, 0, EVP_PKEY_OP_PARAMGEN  | EVP_PKEY_OP_KEYGEN,
+      EVP_PKEY_CTRL_DH_NID, &quot;dh_param&quot;, NULL,
+      OSSL_PKEY_PARAM_GROUP_NAME, OSSL_PARAM_UTF8_STRING, NULL },
+    { SET, EVP_PKEY_DHX, 0, EVP_PKEY_OP_PARAMGEN  | EVP_PKEY_OP_KEYGEN,
+      EVP_PKEY_CTRL_DH_RFC5114, &quot;dh_rfc5114&quot;, NULL,
+      OSSL_PKEY_PARAM_GROUP_NAME, OSSL_PARAM_UTF8_STRING, fix_dh_nid5114 },
 
+    /* DH Keygen Parameters that are shared with DHX */
+    { SET, EVP_PKEY_DH, 0, EVP_PKEY_OP_PARAMGEN,
+      EVP_PKEY_CTRL_DH_PARAMGEN_TYPE, &quot;dh_paramgen_type&quot;, NULL,
+      OSSL_PKEY_PARAM_FFC_TYPE, OSSL_PARAM_UTF8_STRING, fix_dh_paramgen_type },
+    { SET, EVP_PKEY_DH, 0, EVP_PKEY_OP_PARAMGEN,
+      EVP_PKEY_CTRL_DH_PARAMGEN_PRIME_LEN, &quot;dh_paramgen_prime_len&quot;, NULL,
+      OSSL_PKEY_PARAM_FFC_PBITS, OSSL_PARAM_UNSIGNED_INTEGER, NULL },
     { SET, EVP_PKEY_DH, 0, EVP_PKEY_OP_PARAMGEN | EVP_PKEY_OP_KEYGEN,
       EVP_PKEY_CTRL_DH_NID, &quot;dh_param&quot;, NULL,
       OSSL_PKEY_PARAM_GROUP_NAME, OSSL_PARAM_UTF8_STRING, fix_dh_nid },
-    { SET, EVP_PKEY_DH, 0, EVP_PKEY_OP_PARAMGEN,
-      EVP_PKEY_CTRL_DH_PARAMGEN_PRIME_LEN, NULL, NULL,
-      OSSL_PKEY_PARAM_FFC_PBITS, OSSL_PARAM_UNSIGNED_INTEGER, NULL },
-    { SET, EVP_PKEY_DH, 0, EVP_PKEY_OP_PARAMGEN,
-      EVP_PKEY_CTRL_DH_PARAMGEN_SUBPRIME_LEN, &quot;dh_paramgen_subprime_len&quot;, NULL,
-      OSSL_PKEY_PARAM_FFC_QBITS, OSSL_PARAM_UNSIGNED_INTEGER, NULL },
+    { SET, EVP_PKEY_DH, 0, EVP_PKEY_OP_PARAMGEN  | EVP_PKEY_OP_KEYGEN,
+      EVP_PKEY_CTRL_DH_RFC5114, &quot;dh_rfc5114&quot;, NULL,
+      OSSL_PKEY_PARAM_GROUP_NAME, OSSL_PARAM_UTF8_STRING, fix_dh_nid5114 },
+
+    /* DH specific Keygen Parameters */
     { SET, EVP_PKEY_DH, 0, EVP_PKEY_OP_PARAMGEN,
       EVP_PKEY_CTRL_DH_PARAMGEN_GENERATOR, &quot;dh_paramgen_generator&quot;, NULL,
       OSSL_PKEY_PARAM_DH_GENERATOR, OSSL_PARAM_INTEGER, NULL },
-    { SET, EVP_PKEY_DH, 0, EVP_PKEY_OP_PARAMGEN,
-      EVP_PKEY_CTRL_DH_PARAMGEN_TYPE, &quot;dh_paramgen_type&quot;, NULL,
-      OSSL_PKEY_PARAM_FFC_TYPE, OSSL_PARAM_UTF8_STRING, fix_dh_paramgen_type },
- /*
-  * This is know to be incorrect, will be fixed and enabled when the
-  * underlying code is corrected.
-  * Until then, we simply don't support it here.
-  */
-#if 0
-    { SET, EVP_PKEY_DH, 0, EVP_PKEY_OP_PARAMGEN,
-      EVP_PKEY_CTRL_DH_RFC5114, &quot;dh_rfc5114&quot;, NULL,
-      OSSL_PKEY_PARAM_GROUP_NAME, OSSL_PARAM_INTEGER, NULL },
-#endif
+
+    /* DHX specific Keygen Parameters */
+    { SET, EVP_PKEY_DHX, 0, EVP_PKEY_OP_PARAMGEN,
+      EVP_PKEY_CTRL_DH_PARAMGEN_SUBPRIME_LEN, &quot;dh_paramgen_subprime_len&quot;, NULL,
+      OSSL_PKEY_PARAM_FFC_QBITS, OSSL_PARAM_UNSIGNED_INTEGER, NULL },
+
+    { SET, EVP_PKEY_DH, 0, EVP_PKEY_OP_DERIVE,
+      EVP_PKEY_CTRL_DH_PAD, &quot;dh_pad&quot;, NULL,
+      OSSL_EXCHANGE_PARAM_PAD, OSSL_PARAM_UNSIGNED_INTEGER, NULL },
 
     /*-
      * DSA
diff --git a/crypto/evp/dh_support.c b/crypto/evp/dh_support.c
index 7e0256bd00..87296ffbee 100644
--- a/crypto/evp/dh_support.c
+++ b/crypto/evp/dh_support.c
@@ -15,14 +15,25 @@
 typedef struct dh_name2id_st{
     const char *name;
     int id;
+    int type;
 } DH_GENTYPE_NAME2ID;
 
-static const DH_GENTYPE_NAME2ID dhtype2id[]=
+/* Indicates that the paramgen_type can be used for either DH or DHX */
+#define TYPE_ANY -1
+#ifndef OPENSSL_NO_DH
+# define TYPE_DH    DH_FLAG_TYPE_DH
+# define TYPE_DHX   DH_FLAG_TYPE_DHX
+#else
+# define TYPE_DH    0
+# define TYPE_DHX   0
+#endif
+
+static const DH_GENTYPE_NAME2ID dhtype2id[] =
 {
-    { &quot;fips186_4&quot;, DH_PARAMGEN_TYPE_FIPS_186_4 },
-    { &quot;fips186_2&quot;, DH_PARAMGEN_TYPE_FIPS_186_2 },
-    { &quot;group&quot;, DH_PARAMGEN_TYPE_GROUP },
-    { &quot;generator&quot;, DH_PARAMGEN_TYPE_GENERATOR }
+    { &quot;group&quot;, DH_PARAMGEN_TYPE_GROUP, TYPE_ANY },
+    { &quot;generator&quot;, DH_PARAMGEN_TYPE_GENERATOR, TYPE_DH },
+    { &quot;fips186_4&quot;, DH_PARAMGEN_TYPE_FIPS_186_4, TYPE_DHX },
+    { &quot;fips186_2&quot;, DH_PARAMGEN_TYPE_FIPS_186_2, TYPE_DHX },
 };
 
 const char *ossl_dh_gen_type_id2name(int id)
@@ -36,13 +47,17 @@ const char *ossl_dh_gen_type_id2name(int id)
     return NULL;
 }
 
-int ossl_dh_gen_type_name2id(const char *name)
+#ifndef OPENSSL_NO_DH
+int ossl_dh_gen_type_name2id(const char *name, int type)
 {
     size_t i;
 
     for (i = 0; i &lt; OSSL_NELEM(dhtype2id); ++i) {
-        if (strcmp(dhtype2id[i].name, name) == 0)
+        if ((dhtype2id[i].type == TYPE_ANY
+             || type == dhtype2id[i].type)
+            &amp;&amp; strcmp(dhtype2id[i].name, name) == 0)
             return dhtype2id[i].id;
     }
     return -1;
 }
+#endif
diff --git a/crypto/evp/p_lib.c b/crypto/evp/p_lib.c
index daa0f617d8..3af7e17bee 100644
--- a/crypto/evp/p_lib.c
+++ b/crypto/evp/p_lib.c
@@ -890,13 +890,38 @@ IMPLEMENT_ECX_VARIANT(ED448)
 
 # if !defined(OPENSSL_NO_DH) &amp;&amp; !defined(OPENSSL_NO_DEPRECATED_3_0)
 
-int EVP_PKEY_set1_DH(EVP_PKEY *pkey, DH *key)
+int EVP_PKEY_set1_DH(EVP_PKEY *pkey, DH *dhkey)
 {
-    int type = DH_get0_q(key) == NULL ? EVP_PKEY_DH : EVP_PKEY_DHX;
-    int ret = EVP_PKEY_assign(pkey, type, key);
+    int ret, type;
+
+    /*
+     * ossl_dh_is_named_safe_prime_group() returns 1 for named safe prime groups
+     * related to ffdhe and modp (which cache q = (p - 1) / 2),
+     * and returns 0 for all other dh parameter generation types including
+     * RFC5114 named groups.
+     *
+     * The EVP_PKEY_DH type is used for dh parameter generation types:
+     *  - named safe prime groups related to ffdhe and modp
+     *  - safe prime generator
+     *
+     * The type EVP_PKEY_DHX is used for dh parameter generation types
+     *  - fips186-4 and fips186-2
+     *  - rfc5114 named groups.
+     *
+     * The EVP_PKEY_DH type is used to save PKCS#3 data than can be stored
+     * without a q value.
+     * The EVP_PKEY_DHX type is used to save X9.42 data that requires the
+     * q value to be stored.
+     */
+    if (ossl_dh_is_named_safe_prime_group(dhkey))
+        type = EVP_PKEY_DH;
+    else
+        type = DH_get0_q(dhkey) == NULL ? EVP_PKEY_DH : EVP_PKEY_DHX;
+
+    ret = EVP_PKEY_assign(pkey, type, dhkey);
 
     if (ret)
-        DH_up_ref(key);
+        DH_up_ref(dhkey);
     return ret;
 }
 
diff --git a/crypto/ffc/ffc_dh.c b/crypto/ffc/ffc_dh.c
index 17888e9291..e9f597c46c 100644
--- a/crypto/ffc/ffc_dh.c
+++ b/crypto/ffc/ffc_dh.c
@@ -113,9 +113,7 @@ const DH_NAMED_GROUP *ossl_ffc_numbers_to_dh_named_group(const BIGNUM *p,
         if (BN_cmp(p, dh_named_groups[i].p) == 0
             &amp;&amp; BN_cmp(g, dh_named_groups[i].g) == 0
             /* Verify q is correct if it exists */
-            &amp;&amp; ((q != NULL &amp;&amp; BN_cmp(q, dh_named_groups[i].q) == 0)
-                /* Do not match RFC 5114 groups without q */
-                || (q == NULL &amp;&amp; dh_named_groups[i].uid &gt; 3)))
+            &amp;&amp; (q == NULL || BN_cmp(q, dh_named_groups[i].q) == 0))
             return &amp;dh_named_groups[i];
     }
     return NULL;
diff --git a/doc/man1/openssl-genpkey.pod.in b/doc/man1/openssl-genpkey.pod.in
index 7f4ebef439..aa08b01f4f 100644
--- a/doc/man1/openssl-genpkey.pod.in
+++ b/doc/man1/openssl-genpkey.pod.in
@@ -63,7 +63,7 @@ name accepted by EVP_get_cipherbyname() is acceptable such as B&lt;des3&gt;.
 
 =item B&lt;-algorithm&gt; I&lt;alg&gt;
 
-Public key algorithm to use such as RSA, DSA or DH. If used this option must
+Public key algorithm to use such as RSA, DSA, DH or DHX. If used this option must
 precede any B&lt;-pkeyopt&gt; options. The options B&lt;-paramfile&gt; and B&lt;-algorithm&gt;
 are mutually exclusive. Engines may add algorithms in addition to the standard
 built-in ones.
@@ -74,11 +74,8 @@ X25519, X448, ED25519 and ED448.
 Valid built-in algorithm names for parameter generation (see the B&lt;-genparam&gt;
 option) are DH, DSA and EC.
 
-Note that the algorithm name X9.42 DH may be used as a synonym for the DH
-algorithm. These are identical and do not indicate the type of parameters that
-will be generated. Use the B&lt;dh_paramgen_type&gt; option to indicate whether PKCS#3
-or X9.42 DH parameters are required. See L&lt;/DH Parameter Generation Options&gt;
-below for more details.
+Note that the algorithm name X9.42 DH may be used as a synonym for DHX keys and
+PKCS#3 refers to DH Keys. Some options are not shared between DH and DHX keys.
 
 =item B&lt;-pkeyopt&gt; I&lt;opt&gt;:I&lt;value&gt;
 
@@ -182,6 +179,18 @@ B&lt;named_curve&gt; or B&lt;explicit&gt;. The default value is B&lt;named_curve&gt;.
 
 =back
 
+=head2 DH Key Generation Options
+
+=over 4
+
+=item B&lt;group&gt;:I&lt;name&gt;
+
+The B&lt;paramfile&gt; option is not required if a named group is used here.
+See the L&lt;/DH Parameter Generation Options&gt; section below.
+
+=back
+
+
 =head1 PARAMETER GENERATION OPTIONS
 
 The options supported by each algorithm and indeed each implementation of an
@@ -214,7 +223,6 @@ ignored. If not set, then a digest will be used that gives an output matching
 the number of bits in B&lt;q&gt;, i.e. B&lt;sha1&gt; if q length is 160, B&lt;sha224&gt; if it 224
 or B&lt;sha256&gt; if it is 256.
 
-
 =item B&lt;properties&gt;:I&lt;query&gt;
 
 The I&lt;digest&gt; property I&lt;query&gt; string to use when fetching a digest from a provider.
@@ -243,36 +251,128 @@ generate valid primes.
 
 =head2 DH Parameter Generation Options
 
+For most use cases it is recommended to use the B&lt;group&gt; option rather than
+the B&lt;type&gt; options. Note that the B&lt;group&gt; option is not used by default if
+no parameter generation options are specified.
+
 =over 4
 
+=item B&lt;group&gt;:I&lt;name&gt;
+
+=item B&lt;dh_param&gt;:I&lt;name&gt;
+
+Use a named DH group to select constant values for the DH parameters.
+All other options will be ignored if this value is set.
+
+Valid values that are associated with the B&lt;algorithm&gt; of B&lt;&quot;DH&quot;&gt; are:
+&quot;ffdhe2048&quot;, &quot;ffdhe3072&quot;, &quot;ffdhe4096&quot;, &quot;ffdhe6144&quot;, &quot;ffdhe8192&quot;,
+&quot;modp_1536&quot;, &quot;modp_2048&quot;, &quot;modp_3072&quot;, &quot;modp_4096&quot;, &quot;modp_6144&quot;, &quot;modp_8192&quot;.
+
+Valid values that are associated with the B&lt;algorithm&gt; of B&lt;&quot;DHX&quot;&gt; are the
+RFC5114 names &quot;dh_1024_160&quot;, &quot;dh_2048_224&quot;, &quot;dh_2048_256&quot;.
+
+=item B&lt;dh_rfc5114&gt;:I&lt;num&gt;
+
+If this option is set, then the appropriate RFC5114 parameters are used
+instead of generating new parameters. The value I&lt;num&gt; can be one of
+1, 2 or 3 that are equivalant to using the option B&lt;group&gt; with one of
+&quot;dh_1024_160&quot;, &quot;dh_2048_224&quot; or &quot;dh_2048_256&quot;.
+All other options will be ignored if this value is set.
+
+=item B&lt;pbits&gt;:I&lt;numbits&gt;
+
 =item B&lt;dh_paramgen_prime_len&gt;:I&lt;numbits&gt;
 
 The number of bits in the prime parameter I&lt;p&gt;. The default is 2048.
 
+=item B&lt;qbits&gt;:I&lt;numbits&gt;
+
 =item B&lt;dh_paramgen_subprime_len&gt;:I&lt;numbits&gt;
 
-The number of bits in the sub prime parameter I&lt;q&gt;. The default is 256 if the
-prime is at least 2048 bits long or 160 otherwise. Only relevant if used in
-conjunction with the B&lt;dh_paramgen_type&gt; option to generate X9.42 DH parameters.
+The number of bits in the sub prime parameter I&lt;q&gt;. The default is 224.
+Only relevant if used in conjunction with the B&lt;dh_paramgen_type&gt; option to
+generate DHX parameters.
+
+=item B&lt;safeprime-generator&gt;:I&lt;value&gt;
 
 =item B&lt;dh_paramgen_generator&gt;:I&lt;value&gt;
 
 The value to use for the generator I&lt;g&gt;. The default is 2.
+The B&lt;algorithm&gt; option must be B&lt;&quot;DH&quot;&gt; for this parameter to be used.
+
+=item B&lt;type&gt;:I&lt;string&gt;
+
+The type name of DH parameters to generate. Valid values are:
+
+=over 4
+
+=item &quot;generator&quot;
+
+Use a safe prime generator with the option B&lt;safeprime_generator&gt;
+The B&lt;algorithm&gt; option must be B&lt;&quot;DH&quot;&gt;.
+
+=item &quot;fips186_4&quot;
+
+FIPS186-4 parameter generation.
+The B&lt;algorithm&gt; option must be B&lt;&quot;DHX&quot;&gt;.
+
+=item &quot;fips186_2&quot;
+
+FIPS186-4 parameter generation.
+The B&lt;algorithm&gt; option must be B&lt;&quot;DHX&quot;&gt;.
+
+=item &quot;group&quot;
+
+Can be used with the option B&lt;pbits&gt; to select one of
+&quot;ffdhe2048&quot;, &quot;ffdhe3072&quot;, &quot;ffdhe4096&quot;, &quot;ffdhe6144&quot; or &quot;ffdhe8192&quot;.
+The B&lt;algorithm&gt; option must be B&lt;&quot;DH&quot;&gt;.
+
+=item &quot;default&quot;
+
+Selects a default type based on the B&lt;algorithm&gt;. This is used by the
+OpenSSL default provider to set the type for backwards compatability.
+If B&lt;algorithm&gt; is B&lt;&quot;DH&quot;&gt; then B&lt;&quot;generator&quot;&gt; is used.
+If B&lt;algorithm&gt; is B&lt;&quot;DHX&quot;&gt; then B&lt;&quot;fips186_2&quot;&gt; is used.
+
+=back
 
 =item B&lt;dh_paramgen_type&gt;:I&lt;value&gt;
 
-The type of DH parameters to generate. Use 0 for PKCS#3 DH and 1 for X9.42 DH.
-The default is 0.
+The type of DH parameters to generate. Valid values are 0, 1, 2 or 3
+which correspond to setting the option B&lt;type&gt; to
+&quot;generator&quot;, &quot;fips186_2&quot;, &quot;fips186_4&quot; or &quot;group&quot;.
 
-=item B&lt;dh_rfc5114&gt;:I&lt;num&gt;
+=item B&lt;digest&gt;:I&lt;digest&gt;
 
-If this option is set, then the appropriate RFC5114 parameters are used
-instead of generating new parameters. The value I&lt;num&gt; can be one of
-1, 2 or 3 corresponding to RFC5114 DH parameters consisting of
-1024 bit group with 160 bit subgroup, 2048 bit group with 224 bit subgroup
-and 2048 bit group with 256 bit subgroup as mentioned in RFC5114 sections
-2.1, 2.2 and 2.3 respectively. If present this overrides all other DH parameter
-options.
+The digest to use during parameter generation. Must be one of B&lt;sha1&gt;, B&lt;sha224&gt;
+or B&lt;sha256&gt;. If set, then the number of bits in B&lt;qbits&gt; will match the output
+size of the specified digest and the B&lt;qbits&gt; parameter will be
+ignored. If not set, then a digest will be used that gives an output matching
+the number of bits in B&lt;q&gt;, i.e. B&lt;sha1&gt; if q length is 160, B&lt;sha224&gt; if it is
+224 or B&lt;sha256&gt; if it is 256.
+This is only used by &quot;fips186_4&quot; and &quot;fips186_2&quot; key generation.
+
+=item B&lt;properties&gt;:I&lt;query&gt;
+
+The I&lt;digest&gt; property I&lt;query&gt; string to use when fetching a digest from a provider.
+This is only used by &quot;fips186_4&quot; and &quot;fips186_2&quot; key generation.
+
+=item B&lt;gindex&gt;:I&lt;index&gt;
+
+The index to use for canonical generation and verification of the generator g.
+Set this to a positive value ranging from 0..255 to use this mode. Larger values
+will only use the bottom byte.
+This I&lt;index&gt; must then be reused during key validation to verify the value of g.
+If this value is not set then g is not verifiable. The default value is -1.
+This is only used by &quot;fips186_4&quot; and &quot;fips186_2&quot; key generation.
+
+=item B&lt;hexseed&gt;:I&lt;seed&gt;
+
+The seed I&lt;seed&gt; data to use instead of generating a random seed internally.
+This should be used for testing purposes only. This will either produced fixed
+values for the generated parameters OR it will fail if the seed did not
+generate valid primes.
+This is only used by &quot;fips186_4&quot; and &quot;fips186_2&quot; key generation.
 
 =back
 
@@ -313,25 +413,49 @@ Generate DSA key from parameters:
 
  openssl genpkey -paramfile dsap.pem -out dsakey.pem
 
-Generate 2048 bit DH parameters:
+Generate 4096 bit DH Key using safe prime group ffdhe4096:
+
+ openssl genpkey -algorithm DH -out dhkey.pem -pkeyopt group:ffdhe4096
+
+Generate 2048 bit X9.42 DH key with 256 bit subgroup using RFC5114 group3:
+
+ openssl genpkey -algorithm DHX -out dhkey.pem -pkeyopt dh_rfc5114:3
+
+Generate a DH key using a DH parameters file:
+
+ openssl genpkey -paramfile dhp.pem -out dhkey.pem
+
+Output DH parameters for safe prime group ffdhe2048:
+
+ openssl genpkey -genparam -algorithm DH -out dhp.pem -pkeyopt group:ffdhe2048
+
+Output 2048 bit X9.42 DH parameters with 224 bit subgroup using RFC5114 group2:
+
+ openssl genpkey -genparam -algorithm DHX -out dhp.pem -pkeyopt dh_rfc5114:2
+
+Output 2048 bit X9.42 DH parameters with 224 bit subgroup using FIP186-4 keygen:
+
+ openssl genpkey -genparam -algorithm DHX -out dhp.pem -text \
+     -pkeyopt pbits:2048 -pkeyopt qbits:224 -pkeyopt digest:SHA256 \
+     -pkeyopt gindex:1 -pkeyopt dh_paramgen_type:2
+
+Output 1024 bit X9.42 DH parameters with 160 bit subgroup using FIP186-2 keygen:
+
+ openssl genpkey -genparam -algorithm DHX -out dhp.pem -text \
+     -pkeyopt pbits:1024 -pkeyopt qbits:160 -pkeyopt digest:SHA1 \
+     -pkeyopt gindex:1 -pkeyopt dh_paramgen_type:1
+
+Output 2048 bit DH parameters:
 
  openssl genpkey -genparam -algorithm DH -out dhp.pem \
      -pkeyopt dh_paramgen_prime_len:2048
 
-Generate 2048 bit X9.42 DH parameters:
+Output 2048 bit DH parameters using a generator:
 
  openssl genpkey -genparam -algorithm DH -out dhpx.pem \
      -pkeyopt dh_paramgen_prime_len:2048 \
      -pkeyopt dh_paramgen_type:1
 
-Output RFC5114 2048 bit DH parameters with 224 bit subgroup:
-
- openssl genpkey -genparam -algorithm DH -out dhp.pem -pkeyopt dh_rfc5114:2
-
-Generate DH key from parameters:
-
- openssl genpkey -paramfile dhp.pem -out dhkey.pem
-
 Generate EC parameters:
 
  openssl genpkey -genparam -algorithm EC -out ecp.pem \
@@ -367,7 +491,7 @@ The B&lt;-engine&gt; option was deprecated in OpenSSL 3.0.
 
 =head1 COPYRIGHT
 
-Copyright 2006-2020 The OpenSSL Project Authors. All Rights Reserved.
+Copyright 2006-2021 The OpenSSL Project Authors. All Rights Reserved.
 
 Licensed under the Apache License 2.0 (the &quot;License&quot;).  You may not use
 this file except in compliance with the License.  You can obtain a copy
diff --git a/doc/man7/EVP_PKEY-DH.pod b/doc/man7/EVP_PKEY-DH.pod
index 72d20f6f1c..60865a7120 100644
--- a/doc/man7/EVP_PKEY-DH.pod
+++ b/doc/man7/EVP_PKEY-DH.pod
@@ -2,7 +2,8 @@
 
 =head1 NAME
 
-EVP_PKEY-DH, EVP_KEYMGMT-DH - EVP_PKEY DH keytype and algorithm support
+EVP_PKEY-DH, EVP_PKEY-DHX, EVP_KEYMGMT-DH
+- EVP_PKEY DH and DHX keytype and algorithm support
 
 =head1 DESCRIPTION
 
@@ -14,25 +15,30 @@ applications that cannot be upgraded to use the approved safe-prime groups.
 
 See L&lt;EVP_PKEY-FFC(7)&gt; for more information about FFC keys.
 
-For B&lt;DH&gt; that is not a named group the FIPS186-4 standard specifies that the
+The B&lt;DH&gt; key type uses PKCS#3 format which saves p and g, but not the 'q' value.
+The B&lt;DHX&gt; key type uses X9.42 format which saves the value of 'q' and this
+must be used for FIPS186-4.
+
+For B&lt;DHX&gt; that is not a named group the FIPS186-4 standard specifies that the
 values used for FFC parameter generation are also required for parameter
 validation. This means that optional FFC domain parameter values for
-I&lt;seed&gt;, I&lt;pcounter&gt; and I&lt;gindex&gt; may need to be stored for validation purposes.
-For B&lt;DH&gt; the I&lt;seed&gt; and I&lt;pcounter&gt; can be stored in ASN1 data
-(but the I&lt;gindex&gt; is not).
+I&lt;seed&gt;, I&lt;pcounter&gt; and I&lt;gindex&gt; or I&lt;hindex&gt; may need to be stored for
+validation purposes.
+For B&lt;DHX&gt; the I&lt;seed&gt; and I&lt;pcounter&gt; can be stored in ASN1 data
+(but the I&lt;gindex&gt; or I&lt;hindex&gt; can not be stored).
 
-=head2 DH parameters
+=head2 DH and DHX domain parameters
 
 In addition to the common FCC parameters that all FFC keytypes should support
-(see L&lt;EVP_PKEY-FFC(7)/FFC parameters&gt;) the B&lt;DH&gt; keytype
-implementation supports the following:
+(see L&lt;EVP_PKEY-FFC(7)/FFC parameters&gt;) the B&lt;DHX&gt; and B&lt;DH&gt; keytype
+implementations support the following:
 
 =over 4
 
 =item &quot;group&quot; (B&lt;OSSL_PKEY_PARAM_GROUP_NAME&gt;) &lt;UTF8 string&gt;
 
-Set or gets a string that associates a B&lt;DH&gt; named safe prime group with known
-values for I&lt;p&gt;, I&lt;q&gt; and I&lt;g&gt;.
+Sets or gets a string that associates a B&lt;DH&gt; or B&lt;DHX&gt; named safe prime group
+with known values for I&lt;p&gt;, I&lt;q&gt; and I&lt;g&gt;.
 
 The following values can be used by the OpenSSL's default and FIPS providers:
 &quot;ffdhe2048&quot;, &quot;ffdhe3072&quot;, &quot;ffdhe4096&quot;, &quot;ffdhe6144&quot;, &quot;ffdhe8192&quot;,
@@ -41,31 +47,46 @@ The following values can be used by the OpenSSL's default and FIPS providers:
 The following additional values can also be used by OpenSSL's default provider:
 &quot;modp_1536&quot;, &quot;dh_1024_160&quot;, &quot;dh_2048_224&quot;, &quot;dh_2048_256&quot;.
 
-DH named groups can be easily validated since the parameters are well known.
+DH/DHX named groups can be easily validated since the parameters are well known.
 For protocols that only transfer I&lt;p&gt; and I&lt;g&gt; the value of I&lt;q&gt; can also be
 retrieved.
 
-=item &quot;safeprime-generator&quot; (B&lt;OSSL_PKEY_PARAM_DH_GENERATOR&gt;) &lt;integer&gt;
+=back
 
-Used for DH generation of safe primes using the old generator code.
-It is recommended to use a named safe prime group instead, if domain parameter
-validation is required. The default value is 2.
+=head2 DH and DHX additional parameters
 
-These are not named safe prime groups so setting this value for the OpenSSL FIPS
-provider will instead choose a named safe prime group based on the size of I&lt;p&gt;.
+=over 4
 
 =item &quot;encoded-pub-key&quot; (B&lt;OSSL_PKEY_PARAM_ENCODED_PUBLIC_KEY&gt;) &lt;octet string&gt;
 
 Used for getting and setting the encoding of the DH public key used in a key
 exchange message for the TLS protocol.
+See EVP_PKEY_set1_encoded_public_key() and EVP_PKEY_get1_encoded_public_key().
+
+=back
+
+=head2 DH additional domain parameters
+
+=over 4
+
+=item &quot;safeprime-generator&quot; (B&lt;OSSL_PKEY_PARAM_DH_GENERATOR&gt;) &lt;integer&gt;
+
+Used for DH generation of safe primes using the old safe prime generator code.
+The default value is 2.
+It is recommended to use a named safe prime group instead, if domain parameter
+validation is required. 
+
+Randomly generated safe primes are not allowed by FIPS, so setting this value
+for the OpenSSL FIPS provider will instead choose a named safe prime group
+based on the size of I&lt;p&gt;.
 
 =back
 
-=head2 DH domain parameter / key generation parameters
+=head2 DH and DHX domain parameter / key generation parameters
 
 In addition to the common FFC key generation parameters that all FFC key types
 should support (see L&lt;EVP_PKEY-FFC(7)/FFC key generation parameters&gt;) the
-B&lt;DH&gt; keytype implementation supports the following:
+B&lt;DH&gt; and B&lt;DHX&gt; keytype implementation supports the following:
 
 =over 4
 
@@ -91,6 +112,7 @@ type.
 =item &quot;generator&quot;
 
 A safe prime generator. See the &quot;safeprime-generator&quot; type above.
+This is only valid for B&lt;DH&gt; keys.
 
 =back
 
diff --git a/doc/man7/EVP_PKEY-FFC.pod b/doc/man7/EVP_PKEY-FFC.pod
index 7e238d7b44..e345580ec1 100644
--- a/doc/man7/EVP_PKEY-FFC.pod
+++ b/doc/man7/EVP_PKEY-FFC.pod
@@ -2,7 +2,7 @@
 
 =head1 NAME
 
-EVP_PKEY-FFC - EVP_PKEY DSA and DH shared FFC parameters.
+EVP_PKEY-FFC - EVP_PKEY DSA and DH/DHX shared FFC parameters.
 
 =head1 DESCRIPTION
 
@@ -11,9 +11,9 @@ cryptography using finite field mathematics. DSA is an example of FFC and
 Diffie-Hellman key establishment algorithms specified in SP800-56A can also be
 implemented as FFC.
 
-The B&lt;DSA&gt; and B&lt;DH&gt; keytypes are implemented in OpenSSL's default and FIPS
-providers.
-The implementations support the basic DSA and DH keys, containing the public
+The B&lt;DSA&gt;, B&lt;DH&gt; and B&lt;DHX&gt; keytypes are implemented in OpenSSL's default and
+FIPS providers.
+The implementations support the basic DSA, DH and DHX keys, containing the public
 and private keys I&lt;pub&gt; and I&lt;priv&gt; as well as the three main domain parameters
 I&lt;p&gt;, I&lt;q&gt; and I&lt;g&gt;.
 
@@ -26,10 +26,14 @@ For B&lt;DH&gt; the I&lt;seed&gt; and I&lt;pcounter&gt; can be stored in ASN1 data
 (but the I&lt;gindex&gt; is not). For B&lt;DSA&gt; however, these fields are not stored in
 the ASN1 data so they need to be stored externally if validation is required.
 
+The B&lt;DH&gt; key type uses PKCS#3 format which saves p and g, but not the 'q' value.
+The B&lt;DHX&gt; key type uses X9.42 format which saves the value of 'q' and this
+must be used for FIPS186-4.
+
 =head2 FFC parameters
 
 In addition to the common parameters that all keytypes should support (see
-L&lt;provider-keymgmt(7)/Common parameters&gt;), the B&lt;DSA&gt; and B&lt;DH&gt; keytype
+L&lt;provider-keymgmt(7)/Common parameters&gt;), the B&lt;DSA&gt;, B&lt;DH&gt; and B&lt;DHX&gt; keytype
 implementations support the following.
 
 =over 4
@@ -42,18 +46,30 @@ The public key value.
 
 The private key value.
 
-=item &quot;p&quot; (B&lt;OSSL_PKEY_PARAM_FFC_P&gt;) &lt;unsigned integer&gt;
+=back
 
-A DSA or Diffie-Hellman prime &quot;p&quot; value.
+=head2 FFC DSA, DH and DHX domain parameters
 
-=item &quot;q&quot; (B&lt;OSSL_PKEY_PARAM_FFC_Q&gt;) &lt;unsigned integer&gt;
+=over 4
 
-A DSA or Diffie-Hellman prime &quot;q&quot; value.
+=item &quot;p&quot; (B&lt;OSSL_PKEY_PARAM_FFC_P&gt;) &lt;unsigned integer&gt;
+
+A DSA or Diffie-Hellman prime &quot;p&quot; value.
 
 =item &quot;g&quot; (B&lt;OSSL_PKEY_PARAM_FFC_G&gt;) &lt;unsigned integer&gt;
 
 A DSA or Diffie-Hellman generator &quot;g&quot; value.
 
+=back
+
+=head2 FFC DSA and DHX domain parameters
+
+=over 4
+
+=item &quot;q&quot; (B&lt;OSSL_PKEY_PARAM_FFC_Q&gt;) &lt;unsigned integer&gt;
+
+A DSA or Diffie-Hellman prime &quot;q&quot; value.
+
 =item &quot;seed&quot; (B&lt;OSSL_PKEY_PARAM_FFC_SEED&gt;) &lt;octet string&gt;
 
 An optional domain parameter I&lt;seed&gt; value used during generation and validation
@@ -88,7 +104,7 @@ An optional informational cofactor parameter that should equal to (p - 1) / q.
 
 =head2 FFC key generation parameters
 
-The following key generation types are available for DSA and DH algorithms:
+The following key generation types are available for DSA and DHX algorithms:
 
 =over 4
 
diff --git a/include/crypto/dh.h b/include/crypto/dh.h
index ff7c65a468..8613f9038e 100644
--- a/include/crypto/dh.h
+++ b/include/crypto/dh.h
@@ -26,7 +26,7 @@ int ossl_dh_generate_public_key(BN_CTX *ctx, const DH *dh,
                                 const BIGNUM *priv_key, BIGNUM *pub_key);
 int ossl_dh_get_named_group_uid_from_size(int pbits);
 const char *ossl_dh_gen_type_id2name(int id);
-int ossl_dh_gen_type_name2id(const char *name);
+int ossl_dh_gen_type_name2id(const char *name, int type);
 void ossl_dh_cache_named_group(DH *dh);
 int ossl_dh_is_named_safe_prime_group(const DH *dh);
 
diff --git a/providers/implementations/keymgmt/dh_kmgmt.c b/providers/implementations/keymgmt/dh_kmgmt.c
index b3678c5e2a..c4cda447bf 100644
--- a/providers/implementations/keymgmt/dh_kmgmt.c
+++ b/providers/implementations/keymgmt/dh_kmgmt.c
@@ -92,7 +92,7 @@ static int dh_gen_type_name2id_w_default(const char *name, int type)
 #endif
     }
 
-    return ossl_dh_gen_type_name2id(name);
+    return ossl_dh_gen_type_name2id(name, type);
 }
 
 static void *dh_newdata(void *provctx)
@@ -488,7 +488,7 @@ static int dh_set_gen_seed(struct dh_gen_ctx *gctx, unsigned char *seed,
     return 1;
 }
 
-static int dh_gen_set_params(void *genctx, const OSSL_PARAM params[])
+static int dh_gen_common_set_params(void *genctx, const OSSL_PARAM params[])
 {
     struct dh_gen_ctx *gctx = genctx;
     const OSSL_PARAM *p;
@@ -498,7 +498,6 @@ static int dh_gen_set_params(void *genctx, const OSSL_PARAM params[])
     if (params == NULL)
         return 1;
 
-
     p = OSSL_PARAM_locate_const(params, OSSL_PKEY_PARAM_FFC_TYPE);
     if (p != NULL) {
         if (p-&gt;data_type != OSSL_PARAM_UTF8_STRING
@@ -519,11 +518,59 @@ static int dh_gen_set_params(void *genctx, const OSSL_PARAM params[])
             ERR_raise(ERR_LIB_PROV, ERR_R_PASSED_INVALID_ARGUMENT);
             return 0;
         }
-        gctx-&gt;gen_type = DH_PARAMGEN_TYPE_GROUP;
     }
-    p = OSSL_PARAM_locate_const(params, OSSL_PKEY_PARAM_DH_GENERATOR);
-    if (p != NULL &amp;&amp; !OSSL_PARAM_get_int(p, &amp;gctx-&gt;generator))
+    if ((p = OSSL_PARAM_locate_const(params, OSSL_PKEY_PARAM_FFC_PBITS)) != NULL
+        &amp;&amp; !OSSL_PARAM_get_size_t(p, &amp;gctx-&gt;pbits))
+        return 0;
+    p = OSSL_PARAM_locate_const(params, OSSL_PKEY_PARAM_DH_PRIV_LEN);
+    if (p != NULL &amp;&amp; !OSSL_PARAM_get_int(p, &amp;gctx-&gt;priv_len))
+        return 0;
+    return 1;
+}
+
+static const OSSL_PARAM *dh_gen_settable_params(ossl_unused void *genctx,
+                                                ossl_unused void *provctx)
+{
+    static const OSSL_PARAM dh_gen_settable[] = {
+        OSSL_PARAM_utf8_string(OSSL_PKEY_PARAM_FFC_TYPE, NULL, 0),
+        OSSL_PARAM_utf8_string(OSSL_PKEY_PARAM_GROUP_NAME, NULL, 0),
+        OSSL_PARAM_int(OSSL_PKEY_PARAM_DH_PRIV_LEN, NULL),
+        OSSL_PARAM_size_t(OSSL_PKEY_PARAM_FFC_PBITS, NULL),
+        OSSL_PARAM_int(OSSL_PKEY_PARAM_DH_GENERATOR, NULL),
+        OSSL_PARAM_END
+    };
+    return dh_gen_settable;
+}
+
+static const OSSL_PARAM *dhx_gen_settable_params(ossl_unused void *genctx,
+                                                 ossl_unused void *provctx)
+{
+    static const OSSL_PARAM dhx_gen_settable[] = {
+        OSSL_PARAM_utf8_string(OSSL_PKEY_PARAM_FFC_TYPE, NULL, 0),
+        OSSL_PARAM_utf8_string(OSSL_PKEY_PARAM_GROUP_NAME, NULL, 0),
+        OSSL_PARAM_int(OSSL_PKEY_PARAM_DH_PRIV_LEN, NULL),
+        OSSL_PARAM_size_t(OSSL_PKEY_PARAM_FFC_PBITS, NULL),
+        OSSL_PARAM_size_t(OSSL_PKEY_PARAM_FFC_QBITS, NULL),
+        OSSL_PARAM_utf8_string(OSSL_PKEY_PARAM_FFC_DIGEST, NULL, 0),
+        OSSL_PARAM_utf8_string(OSSL_PKEY_PARAM_FFC_DIGEST_PROPS, NULL, 0),
+        OSSL_PARAM_int(OSSL_PKEY_PARAM_FFC_GINDEX, NULL),
+        OSSL_PARAM_octet_string(OSSL_PKEY_PARAM_FFC_SEED, NULL, 0),
+        OSSL_PARAM_int(OSSL_PKEY_PARAM_FFC_PCOUNTER, NULL),
+        OSSL_PARAM_int(OSSL_PKEY_PARAM_FFC_H, NULL),
+        OSSL_PARAM_END
+    };
+    return dhx_gen_settable;
+}
+
+static int dhx_gen_set_params(void *genctx, const OSSL_PARAM params[])
+{
+    struct dh_gen_ctx *gctx = genctx;
+    const OSSL_PARAM *p;
+
+    if (!dh_gen_common_set_params(genctx, params))
         return 0;
+
+    /* Parameters related to fips186-4 and fips186-2 */
     p = OSSL_PARAM_locate_const(params, OSSL_PKEY_PARAM_FFC_GINDEX);
     if (p != NULL &amp;&amp; !OSSL_PARAM_get_int(p, &amp;gctx-&gt;gindex))
         return 0;
@@ -538,10 +585,6 @@ static int dh_gen_set_params(void *genctx, const OSSL_PARAM params[])
         &amp;&amp; (p-&gt;data_type != OSSL_PARAM_OCTET_STRING
             || !dh_set_gen_seed(gctx, p-&gt;data, p-&gt;data_size)))
             return 0;
-
-    if ((p = OSSL_PARAM_locate_const(params, OSSL_PKEY_PARAM_FFC_PBITS)) != NULL
-        &amp;&amp; !OSSL_PARAM_get_size_t(p, &amp;gctx-&gt;pbits))
-        return 0;
     if ((p = OSSL_PARAM_locate_const(params, OSSL_PKEY_PARAM_FFC_QBITS)) != NULL
         &amp;&amp; !OSSL_PARAM_get_size_t(p, &amp;gctx-&gt;qbits))
         return 0;
@@ -563,31 +606,41 @@ static int dh_gen_set_params(void *genctx, const OSSL_PARAM params[])
         if (gctx-&gt;mdprops == NULL)
             return 0;
     }
-    p = OSSL_PARAM_locate_const(params, OSSL_PKEY_PARAM_DH_PRIV_LEN);
-    if (p != NULL &amp;&amp; !OSSL_PARAM_get_int(p, &amp;gctx-&gt;priv_len))
+
+    /* Parameters that are not allowed for DHX */
+    p = OSSL_PARAM_locate_const(params, OSSL_PKEY_PARAM_DH_GENERATOR);
+    if (p != NULL) {
+        ERR_raise(ERR_LIB_PROV, ERR_R_UNSUPPORTED);
         return 0;
+    }
     return 1;
 }
 
-static const OSSL_PARAM *dh_gen_settable_params(ossl_unused void *genctx,
-                                                ossl_unused void *provctx)
+static int dh_gen_set_params(void *genctx, const OSSL_PARAM params[])
 {
-    static OSSL_PARAM settable[] = {
-        OSSL_PARAM_utf8_string(OSSL_PKEY_PARAM_GROUP_NAME, NULL, 0),
-        OSSL_PARAM_int(OSSL_PKEY_PARAM_DH_PRIV_LEN, NULL),
-        OSSL_PARAM_int(OSSL_PKEY_PARAM_DH_GENERATOR, NULL),
-        OSSL_PARAM_utf8_string(OSSL_PKEY_PARAM_FFC_TYPE, NULL, 0),
-        OSSL_PARAM_size_t(OSSL_PKEY_PARAM_FFC_PBITS, NULL),
-        OSSL_PARAM_size_t(OSSL_PKEY_PARAM_FFC_QBITS, NULL),
-        OSSL_PARAM_utf8_string(OSSL_PKEY_PARAM_FFC_DIGEST, NULL, 0),
-        OSSL_PARAM_utf8_string(OSSL_PKEY_PARAM_FFC_DIGEST_PROPS, NULL, 0),
-        OSSL_PARAM_int(OSSL_PKEY_PARAM_FFC_GINDEX, NULL),
-        OSSL_PARAM_octet_string(OSSL_PKEY_PARAM_FFC_SEED, NULL, 0),
-        OSSL_PARAM_int(OSSL_PKEY_PARAM_FFC_PCOUNTER, NULL),
-        OSSL_PARAM_int(OSSL_PKEY_PARAM_FFC_H, NULL),
-        OSSL_PARAM_END
-    };
-    return settable;
+    struct dh_gen_ctx *gctx = genctx;
+    const OSSL_PARAM *p;
+
+    if (!dh_gen_common_set_params(genctx, params))
+        return 0;
+
+    p = OSSL_PARAM_locate_const(params, OSSL_PKEY_PARAM_DH_GENERATOR);
+    if (p != NULL &amp;&amp; !OSSL_PARAM_get_int(p, &amp;gctx-&gt;generator))
+        return 0;
+
+    /* Parameters that are not allowed for DH */
+    if (OSSL_PARAM_locate_const(params, OSSL_PKEY_PARAM_FFC_GINDEX) != NULL
+        || OSSL_PARAM_locate_const(params, OSSL_PKEY_PARAM_FFC_PCOUNTER) != NULL
+        || OSSL_PARAM_locate_const(params, OSSL_PKEY_PARAM_FFC_H) != NULL
+        || OSSL_PARAM_locate_const(params, OSSL_PKEY_PARAM_FFC_SEED) != NULL
+        || OSSL_PARAM_locate_const(params, OSSL_PKEY_PARAM_FFC_QBITS) != NULL
+        || OSSL_PARAM_locate_const(params, OSSL_PKEY_PARAM_FFC_DIGEST) != NULL
+        || OSSL_PARAM_locate_const(params,
+                                   OSSL_PKEY_PARAM_FFC_DIGEST_PROPS) != NULL) {
+        ERR_raise(ERR_LIB_PROV, ERR_R_PASSED_INVALID_ARGUMENT);
+        return 0;
+    }
+    return 1;
 }
 
 static int dh_gencb(int p, int n, BN_GENCB *cb)
@@ -612,6 +665,14 @@ static void *dh_gen(void *genctx, OSSL_CALLBACK *osslcb, void *cbarg)
     if (!ossl_prov_is_running() || gctx == NULL)
         return NULL;
 
+    /*
+     * If a group name is selected then the type is group regardless of what the
+     * the user selected. This overrides rather than errors for backwards
+     * compatibility.
+     */
+    if (gctx-&gt;group_nid != NID_undef)
+        gctx-&gt;gen_type = DH_PARAMGEN_TYPE_GROUP;
+
     /* For parameter generation - If there is a group name just create it */
     if (gctx-&gt;gen_type == DH_PARAMGEN_TYPE_GROUP
             &amp;&amp; gctx-&gt;ffc_params == NULL) {
@@ -765,9 +826,9 @@ const OSSL_DISPATCH ossl_dhx_keymgmt_functions[] = {
     { OSSL_FUNC_KEYMGMT_NEW, (void (*)(void))dhx_newdata },
     { OSSL_FUNC_KEYMGMT_GEN_INIT, (void (*)(void))dhx_gen_init },
     { OSSL_FUNC_KEYMGMT_GEN_SET_TEMPLATE, (void (*)(void))dh_gen_set_template },
-    { OSSL_FUNC_KEYMGMT_GEN_SET_PARAMS, (void (*)(void))dh_gen_set_params },
+    { OSSL_FUNC_KEYMGMT_GEN_SET_PARAMS, (void (*)(void))dhx_gen_set_params },
     { OSSL_FUNC_KEYMGMT_GEN_SETTABLE_PARAMS,
-      (void (*)(void))dh_gen_settable_params },
+      (void (*)(void))dhx_gen_settable_params },
     { OSSL_FUNC_KEYMGMT_GEN, (void (*)(void))dh_gen },
     { OSSL_FUNC_KEYMGMT_GEN_CLEANUP, (void (*)(void))dh_gen_cleanup },
     { OSSL_FUNC_KEYMGMT_LOAD, (void (*)(void))dh_load },
diff --git a/test/recipes/15-test_gendh.t b/test/recipes/15-test_gendh.t
index 87dd73f438..39112f1bfe 100644
--- a/test/recipes/15-test_gendh.t
+++ b/test/recipes/15-test_gendh.t
@@ -18,34 +18,7 @@ setup(&quot;test_gendh&quot;);
 
 plan skip_all =&gt; &quot;This test is unsupported in a no-dh build&quot; if disabled(&quot;dh&quot;);
 
-plan tests =&gt; 13;
-
-ok(run(app([ 'openssl', 'genpkey', '-genparam',
-             '-algorithm', 'DH',
-             '-pkeyopt', 'gindex:1',
-             '-pkeyopt', 'type:fips186_4',
-             '-text'])),
-   &quot;genpkey DH params fips186_4 with verifiable g&quot;);
-
-ok(run(app([ 'openssl', 'genpkey', '-genparam',
-             '-algorithm', 'DH',
-             '-pkeyopt', 'type:fips186_4',
-             '-text'])),
-   &quot;genpkey DH params fips186_4 with unverifiable g&quot;);
-
-ok(run(app([ 'openssl', 'genpkey', '-genparam',
-             '-algorithm', 'DH',
-             '-pkeyopt', 'pbits:2048',
-             '-pkeyopt', 'qbits:224',
-             '-pkeyopt', 'digest:SHA512-224',
-             '-pkeyopt', 'type:fips186_4'])),
-   &quot;genpkey DH params fips186_4 with truncated SHA&quot;);
-
-ok(run(app([ 'openssl', 'genpkey', '-genparam',
-             '-algorithm', 'DH',
-             '-pkeyopt', 'type:fips186_2',
-             '-text'])),
-   &quot;genpkey DH params fips186_2&quot;);
+plan tests =&gt; 9;
 
 ok(run(app([ 'openssl', 'genpkey', '-algorithm', 'DH',
              '-pkeyopt', 'type:group',
@@ -59,7 +32,7 @@ ok(run(app([ 'openssl', 'genpkey', '-algorithm', 'DH',
    &quot;genpkey DH group ffdhe2048&quot;);
 
 ok(run(app([ 'openssl', 'genpkey', '-genparam',
-             '-algorithm', 'DH',
+             '-algorithm', 'DHX',
              '-pkeyopt', 'gindex:1',
              '-pkeyopt', 'type:fips186_4',
              '-out', 'dhgen.pem' ])),
@@ -70,7 +43,7 @@ ok(run(app([ 'openssl', 'genpkey', '-genparam',
 ok(run(app([ 'openssl', 'genpkey',
              '-paramfile', 'dhgen.pem',
              '-pkeyopt', 'gindex:1',
-             '-pkeyopt', 'hexseed:0102030405060708090A0B0C0D0E0F1011121314',
+             '-pkeyopt', 'hexseed:ed2927f2139eb61495d6641efda1243f93ebe482b5bfc2c755a53825',
              '-pkeyopt', 'pcounter:25',
              '-text' ])),
    &quot;genpkey DH fips186_4 with PEM params&quot;);
diff --git a/test/recipes/15-test_gendhparam.t b/test/recipes/15-test_gendhparam.t
new file mode 100644
index 0000000000..b5fe644889
--- /dev/null
+++ b/test/recipes/15-test_gendhparam.t
@@ -0,0 +1,170 @@
+#! /usr/bin/env perl
+# Copyright 2021 The OpenSSL Project Authors. All Rights Reserved.
+#
+# Licensed under the Apache License 2.0 (the &quot;License&quot;).  You may not use
+# this file except in compliance with the License.  You can obtain a copy
+# in the file LICENSE in the source distribution or at
+# <A HREF="https://www.openssl.org/source/license.html">https://www.openssl.org/source/license.html</A>
+
+use strict;
+use warnings;
+
+use OpenSSL::Test;
+use OpenSSL::Test::Utils;
+
+setup(&quot;test_gendhparam&quot;);
+
+my @testdata = (
+    {
+        algorithm =&gt; 'DHX',
+        pkeyopts =&gt; [ &quot;type:fips186_4&quot;, 'digest:SHA256', 'gindex:1' ],
+        expect =&gt; [ 'BEGIN X9.42 DH PARAMETERS', 'gindex:', 'pcounter:', 'SEED:' ],
+        message   =&gt; 'DH fips186_4 param gen with verifiable g',
+    },
+    {
+        algorithm =&gt; 'DH',
+        pkeyopts =&gt; [ &quot;type:fips186_4&quot;, 'digest:SHA256', 'gindex:1' ],
+        expect =&gt; [ 'ERROR' ],
+        message   =&gt; 'fips186_4 param gen should fail if DHX is not used',
+    },
+    {
+        algorithm =&gt; 'DHX',
+        pkeyopts =&gt; [ &quot;type:fips186_4&quot;, 'digest:SHA512-224', 'gindex:1' ],
+        expect =&gt; [ 'BEGIN X9.42 DH PARAMETERS', 'gindex:', 'pcounter:', 'SEED:' ],
+        message   =&gt; 'DH fips186_4 param gen with verifiable g and truncated digest',
+    },
+    {
+        algorithm =&gt; 'DHX',
+        pkeyopts =&gt; [ 'type:fips186_2', 'pbits:1024', 'qbits:160' ],
+        expect =&gt; [ 'BEGIN X9.42 DH PARAMETERS', 'h:', 'pcounter:', 'SEED:' ],
+        message   =&gt; 'DHX fips186_2 param gen with a selected p and q size with unverifyable g',
+    },
+    {
+        algorithm =&gt; 'DHX',
+        pkeyopts =&gt; [ 'type:fips186_2', 'dh_paramgen_prime_len:1024', 'dh_paramgen_subprime_len:160' ],
+        message   =&gt; 'DHX fips186_2 param gen with a selected p and q size using aliased',
+        expect =&gt; [ &quot;BEGIN X9.42 DH PARAMETERS&quot; ],
+    },
+    {
+        algorithm =&gt; 'DH',
+        pkeyopts =&gt; [ 'type:fips186_2', 'dh_paramgen_prime_len:1024', 'dh_paramgen_subprime_len:160' ],
+        message   =&gt; 'DH fips186_2 param gen with a selected p and q size using aliases should fail',
+        expect =&gt; [ &quot;ERROR&quot; ],
+    },
+    {
+        algorithm =&gt; 'DH',
+        pkeyopts =&gt; [ 'group:ffdhe2048'],
+        expect =&gt; [ 'BEGIN DH PARAMETERS', 'GROUP:' ],
+        message   =&gt; 'DH named group ffdhe selection',
+    },
+    {
+        algorithm =&gt; 'DH',
+        pkeyopts =&gt; [ 'dh_param:ffdhe8192'],
+        expect =&gt; [ 'BEGIN DH PARAMETERS', 'GROUP:' ],
+        message   =&gt; 'DH named group ffdhe selection using alias',
+    },
+    {
+        algorithm =&gt; 'DH',
+        pkeyopts =&gt; [ 'group:modp_3072'],
+        expect =&gt; [ 'BEGIN DH PARAMETERS', 'GROUP:' ],
+        message   =&gt; 'DH named group modp selection',
+    },
+    {
+        algorithm =&gt; 'DH',
+        pkeyopts =&gt; [ 'dh_param:modp_4096'],
+        message   =&gt; 'DH named group modp selection using alias',
+        expect =&gt; [ 'BEGIN DH PARAMETERS', 'GROUP:'],
+    },
+    {
+        algorithm =&gt; 'DHX',
+        pkeyopts =&gt; [ 'group:dh_2048_256' ],
+        expect =&gt; [ 'BEGIN X9.42 DH PARAMETERS', 'GROUP:' ],
+        message   =&gt; 'DHX RFC5114 named group selection',
+    },
+    {
+        algorithm =&gt; 'DHX',
+        pkeyopts =&gt; [ 'dh_param:dh_2048_224' ],
+        expect =&gt; [ 'BEGIN X9.42 DH PARAMETERS', 'GROUP:' ],
+        message   =&gt; 'DHX RFC5114 named group selection using alias',
+    },
+    {
+        algorithm =&gt; 'DHX',
+        pkeyopts =&gt; [ 'dh_rfc5114:2'],
+        expect =&gt; [ 'BEGIN X9.42 DH PARAMETERS', 'GROUP:' ],
+        message   =&gt; 'DHX RFC5114 named group selection using an id',
+    },
+    {
+        algorithm =&gt; 'DHX',
+        pkeyopts =&gt; [ 'dh_rfc5114:1', 'dh_paramgen_type:1' ],
+        expect =&gt; [ 'BEGIN X9.42 DH PARAMETERS', 'GROUP:' ],
+        message   =&gt; 'DHX paramgen_type is ignored if the group is set',
+    },
+    {
+        algorithm =&gt; 'DH',
+        pkeyopts =&gt; [ 'dh_rfc5114:1', 'dh_paramgen_type:1' ],
+        expect =&gt; [ 'ERROR' ],
+        message   =&gt; &quot;Setting dh_paramgen_type to fips186 should fail for DH keys&quot;,
+    },
+# These tests using the safeprime generator were removed as they are slow..
+#    {
+#        algorithm =&gt; 'DH',
+#        pkeyopts =&gt; [ 'type:generator', 'safeprime-generator:5'],
+#        expect =&gt; [ 'BEGIN DH PARAMETERS', 'G:    5' ],
+#        message   =&gt; 'DH safe prime generator',
+#    },
+#    {
+#        algorithm =&gt; 'DH',
+#        pkeyopts =&gt; [ 'dh_paramgen_type:0', 'dh_paramgen_generator:5'],
+#        expect =&gt; [ 'BEGIN DH PARAMETERS', 'G:    5' ],
+#        message   =&gt; 'DH safe prime generator using an alias',
+#    },
+     {
+        algorithm =&gt; 'DHX',
+        pkeyopts =&gt; [ 'type:generator', 'safeprime-generator:5'],
+        expect =&gt; [ 'ERROR' ],
+        message   =&gt; 'safe prime generator should fail for DHX',
+    },
+);
+
+plan skip_all =&gt; &quot;DH isn't supported in this build&quot; if disabled(&quot;dh&quot;);
+
+plan tests =&gt; scalar @testdata;
+
+foreach my $test (@testdata) {
+    my $alg = $test-&gt;{algorithm};
+    my $msg = $test-&gt;{message};
+    my @testargs = @{ $test-&gt;{pkeyopts} };
+    my @expected = @{ $test-&gt;{expect} };
+    my @pkeyopts= ();
+    foreach (@testargs) {
+        push(@pkeyopts, '-pkeyopt');
+        push(@pkeyopts, $_);
+    }
+    my @lines = run(app(['openssl', 'genpkey', '-genparam',
+                          '-algorithm', $alg, '-text', @pkeyopts]),
+                    capture =&gt; 1);
+    ok(compareline(\@lines, \@expected), $msg);
+}
+
+# Check that the stdout output matches the expected value.
+sub compareline {
+    my ($ref_lines, $ref_expected) = @_;
+    my @lines = @$ref_lines;
+    my @expected = @$ref_expected;
+
+    if (@lines == 0 and $expected[0] eq 'ERROR') {
+        return 1;
+    }
+    print &quot;-----------------\n&quot;;
+    foreach (@lines) {
+        print $_;
+    }
+    print &quot;-----------------\n&quot;;
+    foreach my $ex (@expected) {
+        if ( !grep { index($_, $ex) &gt;= 0 }  @lines) {
+            print &quot;ERROR: Cannot find: $ex\n&quot;;
+            return 0;
+        }
+    }
+    return 1;
+}
diff --git a/test/recipes/20-test_dhparam_check.t b/test/recipes/20-test_dhparam_check.t
index f3882ad2b3..b929afb326 100644
--- a/test/recipes/20-test_dhparam_check.t
+++ b/test/recipes/20-test_dhparam_check.t
@@ -28,16 +28,10 @@ TESTDIR=test/recipes/20-test_dhparam_check_data/valid
 rm -rf $TESTDIR
 mkdir -p $TESTDIR
 
-#TODO(3.0): These 3 currently create invalid output - see issue #14145
-./util/opensslwrap.sh genpkey -genparam -algorithm DH -pkeyopt dh_rfc5114:1 -out $TESTDIR/dh5114_1.pem
-./util/opensslwrap.sh genpkey -genparam -algorithm DH -pkeyopt dh_rfc5114:2 -out $TESTDIR/dh5114_2.pem
-./util/opensslwrap.sh genpkey -genparam -algorithm DH -pkeyopt dh_rfc5114:3 -out $TESTDIR/dh5114_3.pem
-
-#TODO(3.0): These 4 currently create invalid output - see issue #14145
-./util/opensslwrap.sh genpkey -genparam -algorithm DH -pkeyopt pbits:1024 -pkeyopt type:fips186_2 -out $TESTDIR/dh_p1024_t1862.pem
-./util/opensslwrap.sh genpkey -genparam -algorithm DH -pkeyopt pbits:2048 -pkeyopt type:fips186_2 -out $TESTDIR/dh_p2048_t1862.pem
-./util/opensslwrap.sh genpkey -genparam -algorithm DH -pkeyopt pbits:2048 -pkeyopt type:fips186_4 -out $TESTDIR/dh_p2048_t1864.pem
-./util/opensslwrap.sh genpkey -genparam -algorithm DH -pkeyopt pbits:3072 -pkeyopt type:fips186_2 -out $TESTDIR/dh_p3072_t1862.pem
+./util/opensslwrap.sh genpkey -genparam -algorithm DH -pkeyopt dh_rfc5114:1 -out $TESTDIR/dh_5114_1.pem
+./util/opensslwrap.sh genpkey -genparam -algorithm DH -pkeyopt dh_rfc5114:2 -out $TESTDIR/dh_5114_2.pem
+./util/opensslwrap.sh genpkey -genparam -algorithm DH -pkeyopt dh_rfc5114:3 -out $TESTDIR/dh_5114_3.pem
+./util/opensslwrap.sh genpkey -genparam -algorithm DHX -pkeyopt dh_rfc5114:2 -out $TESTDIR/dhx_5114_2.pem
 
 ./util/opensslwrap.sh genpkey -genparam -algorithm DHX -pkeyopt pbits:1024 -pkeyopt qbits:160 -pkeyopt type:fips186_2 -out $TESTDIR/dhx_p1024_q160_t1862.pem
 ./util/opensslwrap.sh genpkey -genparam -algorithm DHX -pkeyopt pbits:1024 -pkeyopt qbits:224 -pkeyopt type:fips186_2 -out $TESTDIR/dhx_p1024_q224_t1862.pem
diff --git a/test/recipes/20-test_dhparam_check_data/invalid/dh5114_1_pkcs3.pem b/test/recipes/20-test_dhparam_check_data/valid/dh_5114_1.pem
similarity index 100%
rename from test/recipes/20-test_dhparam_check_data/invalid/dh5114_1_pkcs3.pem
rename to test/recipes/20-test_dhparam_check_data/valid/dh_5114_1.pem
diff --git a/test/recipes/20-test_dhparam_check_data/invalid/dh5114_2_pkcs3.pem b/test/recipes/20-test_dhparam_check_data/valid/dh_5114_2.pem
similarity index 100%
copy from test/recipes/20-test_dhparam_check_data/invalid/dh5114_2_pkcs3.pem
copy to test/recipes/20-test_dhparam_check_data/valid/dh_5114_2.pem
diff --git a/test/recipes/20-test_dhparam_check_data/invalid/dh5114_3_pkcs3.pem b/test/recipes/20-test_dhparam_check_data/valid/dh_5114_3.pem
similarity index 100%
rename from test/recipes/20-test_dhparam_check_data/invalid/dh5114_3_pkcs3.pem
rename to test/recipes/20-test_dhparam_check_data/valid/dh_5114_3.pem
diff --git a/test/recipes/20-test_dhparam_check_data/invalid/dh5114_2_pkcs3.pem b/test/recipes/20-test_dhparam_check_data/valid/dhx_5114_2.pem
similarity index 71%
rename from test/recipes/20-test_dhparam_check_data/invalid/dh5114_2_pkcs3.pem
rename to test/recipes/20-test_dhparam_check_data/valid/dhx_5114_2.pem
index d1fadc1a90..8887cb174b 100644
--- a/test/recipes/20-test_dhparam_check_data/invalid/dh5114_2_pkcs3.pem
+++ b/test/recipes/20-test_dhparam_check_data/valid/dhx_5114_2.pem
@@ -1,5 +1,5 @@
------BEGIN DH PARAMETERS-----
-MIICDgKCAQEArRB+HpEjqdDWYPqnlVnFH6INZOVoO5/RtUsVl7YdCnXm+hQd+VpW
+-----BEGIN X9.42 DH PARAMETERS-----
+MIICKQKCAQEArRB+HpEjqdDWYPqnlVnFH6INZOVoO5/RtUsVl7YdCnXm+hQd+VpW
 26+aPEB7od8V6z1oijCcGA4d5rhaEnSgpm0/gVKtasISkDfJ7e/aTfjZHo/vVbc5
 S3rVt9C2wSIHyfmNEe002/bGugssi7wnvmoA4KC5xJcIs7+KMXCRiDaBKGEwvImF
 2xYC5xRBXZMwJ4Jzx94x79xzEPcSH9WgdBWYfZrcCkhtzfk6zEQyg4cxXXXhmMZB
@@ -9,6 +9,6 @@ vnuJmYyvdIZqCM/k/+OmgkpOELmm8N2SHwGnDEr6q3OddwDCn1LFfbF8YgqGUr5e
 kAGo1mrXwXZpEBmZAkr00CcnWsE0i7inYtBSG8mK4kcVBCLqHtQJk51U2nRgzbX2
 xrJQcXy+8YDrNBGOmNEZUppF1vg0Vm4wJeMWozDvu3eobwwasVsFGuPUKMj4rLcK
 gTcVC47rEOGD7dGZY93Z4mPkdwWJ72qiHn9fL/OBtTnM40CdE81Wavu0jWwBkYHh
-vP6UswJp7f5y/ptqpL17Wg8ccc//TBnEGOH27AF5gbwIfypwZbOEuJDTGR8r+gIC
-AOA=
------END DH PARAMETERS-----
+vP6UswJp7f5y/ptqpL17Wg8ccc//TBnEGOH27AF5gbwIfypwZbOEuJDTGR8r+gId
+AIAcDTTFjZP+mXF3EB+AU1pHOM68vziambNjces=
+-----END X9.42 DH PARAMETERS-----
</PRE>




<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="034018.html">[openssl]  master update
</A></li>
	<LI>Next message: <A HREF="034024.html">[openssl]  master update
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#34022">[ date ]</a>
              <a href="thread.html#34022">[ thread ]</a>
              <a href="subject.html#34022">[ subject ]</a>
              <a href="author.html#34022">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="../../../mailman/listinfo/openssl-commits.html">More information about the openssl-commits
mailing list</a><br>
</body></html>
