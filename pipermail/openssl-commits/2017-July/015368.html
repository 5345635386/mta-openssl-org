<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [openssl-commits] [openssl]  master update
   </TITLE>
   <LINK REL="Index" HREF="https://mta.openssl.org/pipermail/openssl-commits/2017-July/index.html" >
   <LINK REL="made" HREF="mailto:openssl-commits%40openssl.org?Subject=Re%3A%20%5Bopenssl-commits%5D%20%5Bopenssl%5D%20%20master%20update&In-Reply-To=%3C1499288821.215913.1848.nullmailer%40dev.openssl.org%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="015367.html">
   <LINK REL="Next"  HREF="015370.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[openssl-commits] [openssl]  master update</H1>
    <B>Rich Salz</B> 
    <A HREF="mailto:openssl-commits%40openssl.org?Subject=Re%3A%20%5Bopenssl-commits%5D%20%5Bopenssl%5D%20%20master%20update&In-Reply-To=%3C1499288821.215913.1848.nullmailer%40dev.openssl.org%3E"
       TITLE="[openssl-commits] [openssl]  master update">rsalz at openssl.org
       </A><BR>
    <I>Wed Jul  5 21:07:01 UTC 2017</I>
    <P><UL>
        <LI>Previous message: <A HREF="015367.html">[openssl-commits] [openssl]  master update
</A></li>
        <LI>Next message: <A HREF="015370.html">[openssl-commits] [openssl]  master update
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#15368">[ date ]</a>
              <a href="thread.html#15368">[ thread ]</a>
              <a href="subject.html#15368">[ subject ]</a>
              <a href="author.html#15368">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>The branch master has been updated
       via  e2dba64c8460a3c08cd6021184b5a8163df28306 (commit)
       via  f48ad5cbdf47c28f68f88e3c9b2f487a4dccc7b8 (commit)
       via  28f298e70aa8c65b275e6c915b5717a59090932d (commit)
       via  0791bef0d42ddc9a2c2851f279f4a2db39153b6e (commit)
       via  810ef917070902f729e3913f1656371c9b0855f8 (commit)
       via  f472560879a48bc68a3f7f63264457da37751845 (commit)
      from  11d66064f36e6968faffb48a2cfd58cbe37eff0c (commit)


- Log -----------------------------------------------------------------
commit e2dba64c8460a3c08cd6021184b5a8163df28306
Author: Rich Salz &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">rsalz at openssl.org</A>&gt;
Date:   Thu Jun 15 18:51:10 2017 -0400

    Fix crash
    
    [extended tests]
    
    Reviewed-by: Richard Levitte &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">levitte at openssl.org</A>&gt;
    Reviewed-by: Tim Hudson &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">tjh at openssl.org</A>&gt;
    (Merged from <A HREF="https://github.com/openssl/openssl/pull/3700">https://github.com/openssl/openssl/pull/3700</A>)

commit f48ad5cbdf47c28f68f88e3c9b2f487a4dccc7b8
Author: Rich Salz &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">rsalz at openssl.org</A>&gt;
Date:   Wed Jun 14 15:08:39 2017 -0400

    Undo commit dc00fb9
    
    Original text:
        Document openssl dgst -hmac option
    
    Reviewed-by: Richard Levitte &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">levitte at openssl.org</A>&gt;
    Reviewed-by: Tim Hudson &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">tjh at openssl.org</A>&gt;
    (Merged from <A HREF="https://github.com/openssl/openssl/pull/3700">https://github.com/openssl/openssl/pull/3700</A>)

commit 28f298e70aa8c65b275e6c915b5717a59090932d
Author: Rich Salz &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">rsalz at openssl.org</A>&gt;
Date:   Wed Jun 14 15:07:52 2017 -0400

    Undo commit cd359b2
    
    Original text:
        Clarify use of |$end0| in stitched x86-64 AES-GCM code.
    
        There was some uncertainty about what the code is doing with |$end0|
        and whether it was necessary for |$len| to be a multiple of 16 or 96.
        Hopefully these added comments make it clear that the code is correct
        except for the caveat regarding low memory addresses.
    
        Change-Id: Iea546a59dc7aeb400f50ac5d2d7b9cb88ace9027
        Reviewed-on: <A HREF="https://boringssl-review.googlesource.com/7194">https://boringssl-review.googlesource.com/7194</A>
        Reviewed-by: Adam Langley &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">agl at google.com</A>&gt;
    
    Reviewed-by: Richard Levitte &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">levitte at openssl.org</A>&gt;
    Reviewed-by: Tim Hudson &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">tjh at openssl.org</A>&gt;
    (Merged from <A HREF="https://github.com/openssl/openssl/pull/3700">https://github.com/openssl/openssl/pull/3700</A>)

commit 0791bef0d42ddc9a2c2851f279f4a2db39153b6e
Author: Rich Salz &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">rsalz at openssl.org</A>&gt;
Date:   Wed Jun 14 13:54:04 2017 -0400

    Undo commit 40720ce
    
    Comment in the commit:
        /* Ignore NULLs, thanks to Bob Beck &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">beck at obtuse.com</A>&gt; */
    
    Reviewed-by: Richard Levitte &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">levitte at openssl.org</A>&gt;
    Reviewed-by: Tim Hudson &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">tjh at openssl.org</A>&gt;
    (Merged from <A HREF="https://github.com/openssl/openssl/pull/3700">https://github.com/openssl/openssl/pull/3700</A>)

commit 810ef917070902f729e3913f1656371c9b0855f8
Author: Rich Salz &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">rsalz at openssl.org</A>&gt;
Date:   Wed Jun 14 13:53:01 2017 -0400

    Undo commit de02ec2
    
    Original text:
        Check if a random &quot;file&quot; is really a device file, and treat it
        specially if it is.
        Add a few OpenBSD-specific cases.
        This is part of a large change submitted by Markus Friedl &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">markus at openbsd.or</A>
    
    Reviewed-by: Richard Levitte &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">levitte at openssl.org</A>&gt;
    Reviewed-by: Tim Hudson &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">tjh at openssl.org</A>&gt;
    (Merged from <A HREF="https://github.com/openssl/openssl/pull/3700">https://github.com/openssl/openssl/pull/3700</A>)

commit f472560879a48bc68a3f7f63264457da37751845
Author: Rich Salz &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">rsalz at openssl.org</A>&gt;
Date:   Wed Jun 14 13:47:17 2017 -0400

    Undo commit 0755217
    
    Original text:
        Fix Perl problems on sparc64.
        This is part of a large change submitted by Markus Friedl
        &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">markus at openbsd.org</A>&gt;
    
    Reviewed-by: Richard Levitte &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">levitte at openssl.org</A>&gt;
    Reviewed-by: Tim Hudson &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">tjh at openssl.org</A>&gt;
    (Merged from <A HREF="https://github.com/openssl/openssl/pull/3700">https://github.com/openssl/openssl/pull/3700</A>)

-----------------------------------------------------------------------

Summary of changes:
 crypto/err/err.c                     | 23 ++++++++++----------
 crypto/modes/asm/aesni-gcm-x86_64.pl | 41 ------------------------------------
 crypto/objects/obj_dat.pl            |  1 -
 crypto/rand/rand_unix.c              | 19 +----------------
 crypto/rand/randfile.c               | 41 ------------------------------------
 doc/man1/dgst.pod                    |  5 -----
 6 files changed, 12 insertions(+), 118 deletions(-)

diff --git a/crypto/err/err.c b/crypto/err/err.c
index adbd41e..e50c6d6 100644
--- a/crypto/err/err.c
+++ b/crypto/err/err.c
@@ -757,20 +757,19 @@ void ERR_add_error_vdata(int num, va_list args)
     n = 0;
     for (i = 0; i &lt; num; i++) {
         a = va_arg(args, char *);
-        /* ignore NULLs, thanks to Bob Beck &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">beck at obtuse.com</A>&gt; */
-        if (a != NULL) {
-            n += strlen(a);
-            if (n &gt; s) {
-                s = n + 20;
-                p = OPENSSL_realloc(str, s + 1);
-                if (p == NULL) {
-                    OPENSSL_free(str);
-                    return;
-                }
-                str = p;
+        if (a == NULL)
+            a = &quot;&lt;NULL&gt;&quot;;
+        n += strlen(a);
+        if (n &gt; s) {
+            s = n + 20;
+            p = OPENSSL_realloc(str, s + 1);
+            if (p == NULL) {
+                OPENSSL_free(str);
+                return;
             }
-            OPENSSL_strlcat(str, a, (size_t)s + 1);
+            str = p;
         }
+        OPENSSL_strlcat(str, a, (size_t)s + 1);
     }
     ERR_set_error_data(str, ERR_TXT_MALLOCED | ERR_TXT_STRING);
 }
diff --git a/crypto/modes/asm/aesni-gcm-x86_64.pl b/crypto/modes/asm/aesni-gcm-x86_64.pl
index 5e69cb8..3cd231e 100644
--- a/crypto/modes/asm/aesni-gcm-x86_64.pl
+++ b/crypto/modes/asm/aesni-gcm-x86_64.pl
@@ -116,23 +116,6 @@ _aesni_ctr32_ghash_6x:
 	  vpxor		$rndkey,$inout3,$inout3
 	  vmovups	0x10-0x80($key),$T2	# borrow $T2 for $rndkey
 	vpclmulqdq	\$0x01,$Hkey,$Z3,$Z2
-
-	# At this point, the current block of 96 (0x60) bytes has already been
-	# loaded into registers. Concurrently with processing it, we want to
-	# load the next 96 bytes of input for the next round. Obviously, we can
-	# only do this if there are at least 96 more bytes of input beyond the
-	# input we're currently processing, or else we'd read past the end of
-	# the input buffer. Here, we set |%r12| to 96 if there are at least 96
-	# bytes of input beyond the 96 bytes we're already processing, and we
-	# set |%r12| to 0 otherwise. In the case where we set |%r12| to 96,
-	# we'll read in the next block so that it is in registers for the next
-	# loop iteration. In the case where we set |%r12| to 0, we'll re-read
-	# the current block and then ignore what we re-read.
-	#
-	# At this point, |$in0| points to the current (already read into
-	# registers) block, and |$end0| points to 2*96 bytes before the end of
-	# the input. Thus, |$in0| &gt; |$end0| means that we do not have the next
-	# 96-byte block to read in, and |$in0| &lt;= |$end0| means we do.
 	xor		%r12,%r12
 	cmp		$in0,$end0
 
@@ -426,9 +409,6 @@ $code.=&lt;&lt;___;
 aesni_gcm_decrypt:
 .cfi_startproc
 	xor	$ret,$ret
-
-	# We call |_aesni_ctr32_ghash_6x|, which requires at least 96 (0x60)
-	# bytes of input.
 	cmp	\$0x60,$len			# minimal accepted length
 	jb	.Lgcm_dec_abort
 
@@ -490,15 +470,7 @@ $code.=&lt;&lt;___;
 	vmovdqu		0x50($inp),$Z3		# I[5]
 	lea		($inp),$in0
 	vmovdqu		0x40($inp),$Z0
-
-	# |_aesni_ctr32_ghash_6x| requires |$end0| to point to 2*96 (0xc0)
-	# bytes before the end of the input. Note, in particular, that this is
-	# correct even if |$len| is not an even multiple of 96 or 16. XXX: This
-	# seems to require that |$inp| + |$len| &gt;= 2*96 (0xc0); i.e. |$inp| must
-	# not be near the very beginning of the address space when |$len| &lt; 2*96
-	# (0xc0).
 	lea		-0xc0($inp,$len),$end0
-
 	vmovdqu		0x30($inp),$Z1
 	shr		\$4,$len
 	xor		$ret,$ret
@@ -663,10 +635,6 @@ _aesni_ctr32_6x:
 aesni_gcm_encrypt:
 .cfi_startproc
 	xor	$ret,$ret
-
-	# We call |_aesni_ctr32_6x| twice, each call consuming 96 bytes of
-	# input. Then we call |_aesni_ctr32_ghash_6x|, which requires at
-	# least 96 more bytes of input.
 	cmp	\$0x60*3,$len			# minimal accepted length
 	jb	.Lgcm_enc_abort
 
@@ -723,16 +691,7 @@ $code.=&lt;&lt;___;
 .Lenc_no_key_aliasing:
 
 	lea		($out),$in0
-
-	# |_aesni_ctr32_ghash_6x| requires |$end0| to point to 2*96 (0xc0)
-	# bytes before the end of the input. Note, in particular, that this is
-	# correct even if |$len| is not an even multiple of 96 or 16. Unlike in
-	# the decryption case, there's no caveat that |$out| must not be near
-	# the very beginning of the address space, because we know that
-	# |$len| &gt;= 3*96 from the check above, and so we know
-	# |$out| + |$len| &gt;= 2*96 (0xc0).
 	lea		-0xc0($out,$len),$end0
-
 	shr		\$4,$len
 
 	call		_aesni_ctr32_6x
diff --git a/crypto/objects/obj_dat.pl b/crypto/objects/obj_dat.pl
index 947ccee..3e201c3 100644
--- a/crypto/objects/obj_dat.pl
+++ b/crypto/objects/obj_dat.pl
@@ -6,7 +6,6 @@
 # in the file LICENSE in the source distribution or at
 # <A HREF="https://www.openssl.org/source/license.html">https://www.openssl.org/source/license.html</A>
 
-use integer;
 use strict;
 use warnings;
 
diff --git a/crypto/rand/rand_unix.c b/crypto/rand/rand_unix.c
index ecba2dc..241f287 100644
--- a/crypto/rand/rand_unix.c
+++ b/crypto/rand/rand_unix.c
@@ -121,24 +121,7 @@ int RAND_poll(void)
     }
     return 1;
 }
-# elif defined __OpenBSD__
-int RAND_poll(void)
-{
-    u_int32_t rnd = 0, i;
-    unsigned char buf[ENTROPY_NEEDED];
-
-    for (i = 0; i &lt; sizeof(buf); i++) {
-        if (i % 4 == 0)
-            rnd = arc4random();
-        buf[i] = rnd;
-        rnd &gt;&gt;= 8;
-    }
-    RAND_add(buf, sizeof(buf), ENTROPY_NEEDED);
-    OPENSSL_cleanse(buf, sizeof(buf));
-
-    return 1;
-}
-# else                          /* !defined(__OpenBSD__) */
+# else
 int RAND_poll(void)
 {
     unsigned long l;
diff --git a/crypto/rand/randfile.c b/crypto/rand/randfile.c
index 15fa9dc..1c2043e 100644
--- a/crypto/rand/randfile.c
+++ b/crypto/rand/randfile.c
@@ -145,17 +145,6 @@ int RAND_load_file(const char *file, long bytes)
         goto err;
     RAND_add(&amp;sb, sizeof(sb), 0.0);
 
-# if defined(S_ISBLK) &amp;&amp; defined(S_ISCHR)
-    if (S_ISBLK(sb.st_mode) || S_ISCHR(sb.st_mode)) {
-        /*
-         * this file is a device. we don't want read an infinite number of
-         * bytes from a random device, nor do we want to use buffered I/O
-         * because we will waste system entropy.
-         */
-        bytes = (bytes == -1) ? 2048 : bytes; /* ok, is 2048 enough? */
-        setbuf(in, NULL); /* don't do buffered reads */
-    }
-# endif
 #endif
     for (;;) {
         if (bytes &gt; 0)
@@ -188,7 +177,6 @@ int RAND_write_file(const char *file)
     FILE *out = NULL;
     int n;
 #ifndef OPENSSL_NO_POSIX_IO
-    struct stat sb;
 
 # if defined(S_ISBLK) &amp;&amp; defined(S_ISCHR)
 # ifdef _WIN32
@@ -197,18 +185,6 @@ int RAND_write_file(const char *file)
      * because driver paths are always ASCII.
      */
 # endif
-    i = stat(file, &amp;sb);
-    if (i != -1) {
-        if (S_ISBLK(sb.st_mode) || S_ISCHR(sb.st_mode)) {
-            /*
-             * this file is a device. we don't write back to it. we
-             * &quot;succeed&quot; on the assumption this is some sort of random
-             * device. Otherwise attempting to write to and chmod the device
-             * causes problems.
-             */
-            return 1;
-        }
-    }
 # endif
 #endif
 
@@ -283,9 +259,6 @@ const char *RAND_file_name(char *buf, size_t size)
 {
     char *s = NULL;
     int use_randfile = 1;
-#ifdef __OpenBSD__
-    struct stat sb;
-#endif
 
 #if defined(_WIN32) &amp;&amp; defined(CP_UTF8)
     DWORD len;
@@ -348,19 +321,5 @@ const char *RAND_file_name(char *buf, size_t size)
         buf[0] = '\0';      /* no file name */
     }
 
-#ifdef __OpenBSD__
-    /*
-     * given that all random loads just fail if the file can't be seen on a
-     * stat, we stat the file we're returning, if it fails, use /dev/arandom
-     * instead. this allows the user to use their own source for good random
-     * data, but defaults to something hopefully decent if that isn't
-     * available.
-     */
-
-    if (!buf[0] || stat(buf, &amp;sb) == -1)
-        if (OPENSSL_strlcpy(buf, &quot;/dev/arandom&quot;, size) &gt;= size) {
-            return NULL;
-        }
-#endif
     return buf[0] ? buf : NULL;
 }
diff --git a/doc/man1/dgst.pod b/doc/man1/dgst.pod
index 677f2b2..a11f190 100644
--- a/doc/man1/dgst.pod
+++ b/doc/man1/dgst.pod
@@ -21,7 +21,6 @@ B&lt;openssl&gt; B&lt;dgst&gt;
 [B&lt;-verify filename&gt;]
 [B&lt;-prverify filename&gt;]
 [B&lt;-signature filename&gt;]
-[B&lt;-hmac key&gt;]
 [B&lt;-fips-fingerprint&gt;]
 [B&lt;-engine id&gt;]
 [B&lt;-engine_impl&gt;]
@@ -116,10 +115,6 @@ Verify the signature using the private key in &quot;filename&quot;.
 
 The actual signature to verify.
 
-=item B&lt;-hmac key&gt;
-
-Create a hashed MAC using &quot;key&quot;.
-
 =item B&lt;-mac alg&gt;
 
 Create MAC (keyed Message Authentication Code). The most popular MAC
</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="015367.html">[openssl-commits] [openssl]  master update
</A></li>
	<LI>Next message: <A HREF="015370.html">[openssl-commits] [openssl]  master update
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#15368">[ date ]</a>
              <a href="thread.html#15368">[ thread ]</a>
              <a href="subject.html#15368">[ subject ]</a>
              <a href="author.html#15368">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="../../../mailman/listinfo/openssl-commits.html">More information about the openssl-commits
mailing list</a><br>
</body></html>
