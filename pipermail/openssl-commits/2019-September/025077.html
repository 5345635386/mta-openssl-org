<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [openssl]  master update
   </TITLE>
   <LINK REL="Index" HREF="https://mta.openssl.org/pipermail/openssl-commits/2019-September/index.html" >
   <LINK REL="made" HREF="mailto:openssl-commits%40openssl.org?Subject=Re%3A%20%5Bopenssl%5D%20%20master%20update&In-Reply-To=%3C1568305221.505861.28644.nullmailer%40dev.openssl.org%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="025075.html">
   <LINK REL="Next"  HREF="025096.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[openssl]  master update</H1>
    <B>Richard Levitte</B> 
    <A HREF="mailto:openssl-commits%40openssl.org?Subject=Re%3A%20%5Bopenssl%5D%20%20master%20update&In-Reply-To=%3C1568305221.505861.28644.nullmailer%40dev.openssl.org%3E"
       TITLE="[openssl]  master update">levitte at openssl.org
       </A><BR>
    <I>Thu Sep 12 16:20:21 UTC 2019</I>
    <P><UL>
        <LI>Previous message: <A HREF="025075.html">[openssl]  master update
</A></li>
        <LI>Next message: <A HREF="025096.html">[openssl]  master update
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25077">[ date ]</a>
              <a href="thread.html#25077">[ thread ]</a>
              <a href="subject.html#25077">[ subject ]</a>
              <a href="author.html#25077">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>The branch master has been updated
       via  1f86b8228b49938e0e368f361202570d7eab5806 (commit)
       via  486f149131e94c970da1b89ebe8c66ab88e5d343 (commit)
      from  d4830d018dfdab5d5d497d88207ee8f1761cf878 (commit)


- Log -----------------------------------------------------------------
commit 1f86b8228b49938e0e368f361202570d7eab5806
Author: Richard Levitte &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">levitte at openssl.org</A>&gt;
Date:   Sun Aug 25 10:46:22 2019 +0200

    confdata.pm.in: New template for configdata.pm
    
    To have the configdata.pm text embedded in Configure was kind of ugly,
    and becomes clearer if put into a template file, configdata.pm.in.  We
    can then use OpenSSL::Template to generate it.
    
    We also modify configdata.pm to be the build file generator, and run
    it from Configure.  The benefit with that is that developers who
    tinker and play with the build file can do a &quot;factory reset&quot; without
    having to go through the configuration process, i.e. they can re-use
    the config data the already have.
    
    Reviewed-by: Matt Caswell &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">matt at openssl.org</A>&gt;
    (Merged from <A HREF="https://github.com/openssl/openssl/pull/9693">https://github.com/openssl/openssl/pull/9693</A>)

commit 486f149131e94c970da1b89ebe8c66ab88e5d343
Author: Richard Levitte &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">levitte at openssl.org</A>&gt;
Date:   Sun Aug 25 10:44:41 2019 +0200

    util/dofile.pl, util/perl/OpenSSL/Template.pm: move parts of dofile.pl
    
    We make a module OpenSSL::Template from the central parts of
    util/dofile.pl, and also reduce the amount of ugly code with more
    proper use of Text::Template.  OpenSSL::Template is a simply subclass
    of Text::Template.
    
    Reviewed-by: Matt Caswell &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">matt at openssl.org</A>&gt;
    (Merged from <A HREF="https://github.com/openssl/openssl/pull/9693">https://github.com/openssl/openssl/pull/9693</A>)

-----------------------------------------------------------------------

Summary of changes:
 Configure                     | 495 ++++--------------------------------------
 configdata.pm.in              | 418 +++++++++++++++++++++++++++++++++++
 util/dofile.pl                | 204 +++--------------
 util/perl/OpenSSL/Template.pm | 195 +++++++++++++++++
 4 files changed, 684 insertions(+), 628 deletions(-)
 create mode 100644 configdata.pm.in
 create mode 100644 util/perl/OpenSSL/Template.pm

diff --git a/Configure b/Configure
index 652d13ea16..92c9d4e4d9 100755
--- a/Configure
+++ b/Configure
@@ -19,6 +19,7 @@ use File::Spec::Functions qw/:DEFAULT abs2rel rel2abs splitdir/;
 use File::Path qw/mkpath/;
 use OpenSSL::fallback &quot;$FindBin::Bin/external/perl/MODULES.txt&quot;;
 use OpenSSL::Glob;
+use OpenSSL::Template;
 
 # see INSTALL for instructions.
 
@@ -2387,452 +2388,50 @@ foreach (grep /_(asm|aux)_src$/, keys %target) {
 
 # Write down our configuration where it fits #########################
 
-print &quot;Creating configdata.pm\n&quot;;
-open(OUT,&quot;&gt;configdata.pm&quot;) || die &quot;unable to create configdata.pm: $!\n&quot;;
-print OUT &lt;&lt;&quot;EOF&quot;;
-#! $config{HASHBANGPERL}
-
-package configdata;
-
-use strict;
-use warnings;
-
-use Exporter;
-#use vars qw(\@ISA \@EXPORT);
-our \@ISA = qw(Exporter);
-our \@EXPORT = qw(\%config \%target \%disabled \%withargs \%unified_info \@disablables \@disablables_int);
-
-EOF
-print OUT &quot;our %config = (\n&quot;;
-foreach (sort keys %config) {
-    if (ref($config{$_}) eq &quot;ARRAY&quot;) {
-        print OUT &quot;  &quot;, $_, &quot; =&gt; [ &quot;, join(&quot;, &quot;,
-                                           map { quotify(&quot;perl&quot;, $_) }
-                                           @{$config{$_}}), &quot; ],\n&quot;;
-    } elsif (ref($config{$_}) eq &quot;HASH&quot;) {
-        print OUT &quot;  &quot;, $_, &quot; =&gt; {&quot;;
-        if (scalar keys %{$config{$_}} &gt; 0) {
-            print OUT &quot;\n&quot;;
-            foreach my $key (sort keys %{$config{$_}}) {
-                print OUT &quot;      &quot;,
-                    join(&quot; =&gt; &quot;,
-                         quotify(&quot;perl&quot;, $key),
-                         defined $config{$_}-&gt;{$key}
-                             ? quotify(&quot;perl&quot;, $config{$_}-&gt;{$key})
-                             : &quot;undef&quot;);
-                print OUT &quot;,\n&quot;;
-            }
-            print OUT &quot;  &quot;;
-        }
-        print OUT &quot;},\n&quot;;
-    } else {
-        print OUT &quot;  &quot;, $_, &quot; =&gt; &quot;, quotify(&quot;perl&quot;, $config{$_}), &quot;,\n&quot;
-    }
-}
-print OUT &lt;&lt;&quot;EOF&quot;;
-);
-
-EOF
-print OUT &quot;our %target = (\n&quot;;
-foreach (sort keys %target) {
-    if (ref($target{$_}) eq &quot;ARRAY&quot;) {
-        print OUT &quot;  &quot;, $_, &quot; =&gt; [ &quot;, join(&quot;, &quot;,
-                                           map { quotify(&quot;perl&quot;, $_) }
-                                           @{$target{$_}}), &quot; ],\n&quot;;
-    } else {
-        print OUT &quot;  &quot;, $_, &quot; =&gt; &quot;, quotify(&quot;perl&quot;, $target{$_}), &quot;,\n&quot;
-    }
-}
-print OUT &lt;&lt;&quot;EOF&quot;;
+my %template_vars = (
+    config =&gt; \%config,
+    target =&gt; \%target,
+    disablables =&gt; \@disablables,
+    disablables_int =&gt; \@disablables_int,
+    disabled =&gt; \%disabled,
+    withargs =&gt; \%withargs,
+    unified_info =&gt; \%unified_info,
+    tls =&gt; \@tls,
+    dtls =&gt; \@dtls,
+    makevars =&gt; [ sort keys %user ],
+    disabled_info =&gt; \%disabled_info,
+    user_crossable =&gt; \@user_crossable,
 );
-
-EOF
-print OUT &quot;our \%available_protocols = (\n&quot;;
-print OUT &quot;  tls =&gt; [ &quot;, join(&quot;, &quot;, map { quotify(&quot;perl&quot;, $_) } @tls), &quot; ],\n&quot;;
-print OUT &quot;  dtls =&gt; [ &quot;, join(&quot;, &quot;, map { quotify(&quot;perl&quot;, $_) } @dtls), &quot; ],\n&quot;;
-print OUT &lt;&lt;&quot;EOF&quot;;
-);
-
-EOF
-print OUT &quot;our \@disablables = (\n&quot;;
-foreach (@disablables) {
-    print OUT &quot;  &quot;, quotify(&quot;perl&quot;, $_), &quot;,\n&quot;;
-}
-print OUT &lt;&lt;&quot;EOF&quot;;
-);
-
-EOF
-print OUT &quot;# The following come from Configure's @disablables_int\n&quot;;
-print OUT &quot;our \@disablables_int = (\n&quot;;
-foreach (@disablables_int) {
-    print OUT &quot;  &quot;, quotify(&quot;perl&quot;, $_), &quot;,\n&quot;;
-}
-print OUT &lt;&lt;&quot;EOF&quot;;
-);
-
-EOF
-print OUT &quot;our \%disabled = (\n&quot;;
-foreach (sort keys %disabled) {
-    print OUT &quot;  &quot;, quotify(&quot;perl&quot;, $_), &quot; =&gt; &quot;, quotify(&quot;perl&quot;, $disabled{$_}), &quot;,\n&quot;;
-}
-print OUT &lt;&lt;&quot;EOF&quot;;
-);
-
-EOF
-print OUT &quot;our %withargs = (\n&quot;;
-foreach (sort keys %withargs) {
-    if (ref($withargs{$_}) eq &quot;ARRAY&quot;) {
-        print OUT &quot;  &quot;, $_, &quot; =&gt; [ &quot;, join(&quot;, &quot;,
-                                           map { quotify(&quot;perl&quot;, $_) }
-                                           @{$withargs{$_}}), &quot; ],\n&quot;;
-    } else {
-        print OUT &quot;  &quot;, $_, &quot; =&gt; &quot;, quotify(&quot;perl&quot;, $withargs{$_}), &quot;,\n&quot;
-    }
-}
-print OUT &lt;&lt;&quot;EOF&quot;;
-);
-
-EOF
-if ($builder eq &quot;unified&quot;) {
-    my $recurse;
-    $recurse = sub {
-        my $indent = shift;
-        foreach (@_) {
-            if (ref $_ eq &quot;ARRAY&quot;) {
-                print OUT &quot; &quot;x$indent, &quot;[\n&quot;;
-                foreach (@$_) {
-                    $recurse-&gt;($indent + 4, $_);
-                }
-                print OUT &quot; &quot;x$indent, &quot;],\n&quot;;
-            } elsif (ref $_ eq &quot;HASH&quot;) {
-                my %h = %$_;
-                print OUT &quot; &quot;x$indent, &quot;{\n&quot;;
-                foreach (sort keys %h) {
-                    if (ref $h{$_} eq &quot;&quot;) {
-                        print OUT &quot; &quot;x($indent + 4), quotify(&quot;perl&quot;, $_), &quot; =&gt; &quot;, quotify(&quot;perl&quot;, $h{$_}), &quot;,\n&quot;;
-                    } else {
-                        print OUT &quot; &quot;x($indent + 4), quotify(&quot;perl&quot;, $_), &quot; =&gt;\n&quot;;
-                        $recurse-&gt;($indent + 8, $h{$_});
-                    }
-                }
-                print OUT &quot; &quot;x$indent, &quot;},\n&quot;;
-            } else {
-                print OUT &quot; &quot;x$indent, quotify(&quot;perl&quot;, $_), &quot;,\n&quot;;
-            }
-        }
-    };
-    print OUT &quot;our %unified_info = (\n&quot;;
-    foreach (sort keys %unified_info) {
-        if (ref $unified_info{$_} eq &quot;&quot;) {
-            print OUT &quot; &quot;x4, quotify(&quot;perl&quot;, $_), &quot; =&gt; &quot;, quotify(&quot;perl&quot;, $unified_info{$_}), &quot;,\n&quot;;
-        } else {
-            print OUT &quot; &quot;x4, quotify(&quot;perl&quot;, $_), &quot; =&gt;\n&quot;;
-            $recurse-&gt;(8, $unified_info{$_});
-        }
-    }
-    print OUT &lt;&lt;&quot;EOF&quot;;
-);
-
-EOF
-}
-print OUT
-    &quot;# The following data is only used when this files is use as a script\n&quot;;
-print OUT &quot;my \@makevars = (\n&quot;;
-foreach (sort keys %user) {
-    print OUT &quot;    '&quot;,$_,&quot;',\n&quot;;
-}
-print OUT &quot;);\n&quot;;
-print OUT &quot;my \%disabled_info = (\n&quot;;
-foreach my $what (sort keys %disabled_info) {
-    print OUT &quot;    '$what' =&gt; {\n&quot;;
-    foreach my $info (sort keys %{$disabled_info{$what}}) {
-        if (ref $disabled_info{$what}-&gt;{$info} eq 'ARRAY') {
-            print OUT &quot;        $info =&gt; [ &quot;,
-                join(', ', map { &quot;'$_'&quot; } @{$disabled_info{$what}-&gt;{$info}}),
-                &quot; ],\n&quot;;
-        } else {
-            print OUT &quot;        $info =&gt; '&quot;, $disabled_info{$what}-&gt;{$info},
-                &quot;',\n&quot;;
-        }
-    }
-    print OUT &quot;    },\n&quot;;
-}
-print OUT &quot;);\n&quot;;
-print OUT 'my @user_crossable = qw( ', join (' ', @user_crossable), &quot; );\n&quot;;
-print OUT &lt;&lt; 'EOF';
-# If run directly, we can give some answers, and even reconfigure
-unless (caller) {
-    use Getopt::Long;
-    use File::Spec::Functions;
-    use File::Basename;
-    use Pod::Usage;
-
-    my $here = dirname($0);
-
-    my $dump = undef;
-    my $cmdline = undef;
-    my $options = undef;
-    my $target = undef;
-    my $envvars = undef;
-    my $makevars = undef;
-    my $buildparams = undef;
-    my $reconf = undef;
-    my $verbose = undef;
-    my $help = undef;
-    my $man = undef;
-    GetOptions('dump|d'                 =&gt; \$dump,
-               'command-line|c'         =&gt; \$cmdline,
-               'options|o'              =&gt; \$options,
-               'target|t'               =&gt; \$target,
-               'environment|e'          =&gt; \$envvars,
-               'make-variables|m'       =&gt; \$makevars,
-               'build-parameters|b'     =&gt; \$buildparams,
-               'reconfigure|reconf|r'   =&gt; \$reconf,
-               'verbose|v'              =&gt; \$verbose,
-               'help'                   =&gt; \$help,
-               'man'                    =&gt; \$man)
-        or die &quot;Errors in command line arguments\n&quot;;
-
-    unless ($dump || $cmdline || $options || $target || $envvars || $makevars
-            || $buildparams || $reconf || $verbose || $help || $man) {
-        print STDERR &lt;&lt;&quot;_____&quot;;
-You must give at least one option.
-For more information, do '$0 --help'
-_____
-        exit(2);
-    }
-
-    if ($help) {
-        pod2usage(-exitval =&gt; 0,
-                  -verbose =&gt; 1);
-    }
-    if ($man) {
-        pod2usage(-exitval =&gt; 0,
-                  -verbose =&gt; 2);
-    }
-    if ($dump || $cmdline) {
-        print &quot;\nCommand line (with current working directory = $here):\n\n&quot;;
-        print '    ',join(' ',
-                          $config{PERL},
-                          catfile($config{sourcedir}, 'Configure'),
-                          @{$config{perlargv}}), &quot;\n&quot;;
-        print &quot;\nPerl information:\n\n&quot;;
-        print '    ',$config{perl_cmd},&quot;\n&quot;;
-        print '    ',$config{perl_version},' for ',$config{perl_archname},&quot;\n&quot;;
-    }
-    if ($dump || $options) {
-        my $longest = 0;
-        my $longest2 = 0;
-        foreach my $what (@disablables) {
-            $longest = length($what) if $longest &lt; length($what);
-            $longest2 = length($disabled{$what})
-                if $disabled{$what} &amp;&amp; $longest2 &lt; length($disabled{$what});
-        }
-        print &quot;\nEnabled features:\n\n&quot;;
-        foreach my $what (@disablables) {
-            print &quot;    $what\n&quot; unless $disabled{$what};
-        }
-        print &quot;\nDisabled features:\n\n&quot;;
-        foreach my $what (@disablables) {
-            if ($disabled{$what}) {
-                print &quot;    $what&quot;, ' ' x ($longest - length($what) + 1),
-                    &quot;[$disabled{$what}]&quot;, ' ' x ($longest2 - length($disabled{$what}) + 1);
-                print $disabled_info{$what}-&gt;{macro}
-                    if $disabled_info{$what}-&gt;{macro};
-                print ' (skip ',
-                    join(', ', @{$disabled_info{$what}-&gt;{skipped}}),
-                    ')'
-                    if $disabled_info{$what}-&gt;{skipped};
-                print &quot;\n&quot;;
-            }
-        }
-    }
-    if ($dump || $target) {
-        print &quot;\nConfig target attributes:\n\n&quot;;
-        foreach (sort keys %target) {
-            next if $_ =~ m|^_| || $_ eq 'template';
-            my $quotify = sub {
-                map { (my $x = $_) =~ s|([\\\$\@&quot;])|\\$1|g; &quot;\&quot;$x\&quot;&quot;} @_;
-            };
-            print '    ', $_, ' =&gt; ';
-            if (ref($target{$_}) eq &quot;ARRAY&quot;) {
-                print '[ ', join(', ', $quotify-&gt;(@{$target{$_}})), &quot; ],\n&quot;;
-            } else {
-                print $quotify-&gt;($target{$_}), &quot;,\n&quot;
-            }
-        }
-    }
-    if ($dump || $envvars) {
-        print &quot;\nRecorded environment:\n\n&quot;;
-        foreach (sort keys %{$config{perlenv}}) {
-            print '    ',$_,' = ',($config{perlenv}-&gt;{$_} || ''),&quot;\n&quot;;
-        }
-    }
-    if ($dump || $makevars) {
-        print &quot;\nMakevars:\n\n&quot;;
-        foreach my $var (@makevars) {
-            my $prefix = '';
-            $prefix = $config{CROSS_COMPILE}
-                if grep { $var eq $_ } @user_crossable;
-            $prefix //= '';
-            print '    ',$var,' ' x (16 - length $var),'= ',
-                (ref $config{$var} eq 'ARRAY'
-                 ? join(' ', @{$config{$var}})
-                 : $prefix.$config{$var}),
-                &quot;\n&quot;
-                if defined $config{$var};
-        }
-
-        my @buildfile = ($config{builddir}, $config{build_file});
-        unshift @buildfile, $here
-            unless file_name_is_absolute($config{builddir});
-        my $buildfile = canonpath(catdir(@buildfile));
-        print &lt;&lt;&quot;_____&quot;;
-
-NOTE: These variables only represent the configuration view.  The build file
-template may have processed these variables further, please have a look at the
-build file for more exact data:
-    $buildfile
-_____
-    }
-    if ($dump || $buildparams) {
-        my @buildfile = ($config{builddir}, $config{build_file});
-        unshift @buildfile, $here
-            unless file_name_is_absolute($config{builddir});
-        print &quot;\nbuild file:\n\n&quot;;
-        print &quot;    &quot;, canonpath(catfile(@buildfile)),&quot;\n&quot;;
-
-        print &quot;\nbuild file templates:\n\n&quot;;
-        foreach (@{$config{build_file_templates}}) {
-            my @tmpl = ($_);
-            unshift @tmpl, $here
-                unless file_name_is_absolute($config{sourcedir});
-            print '    ',canonpath(catfile(@tmpl)),&quot;\n&quot;;
-        }
-    }
-    if ($reconf) {
-        if ($verbose) {
-            print 'Reconfiguring with: ', join(' ',@{$config{perlargv}}), &quot;\n&quot;;
-            foreach (sort keys %{$config{perlenv}}) {
-                print '    ',$_,' = ',($config{perlenv}-&gt;{$_} || &quot;&quot;),&quot;\n&quot;;
-            }
-        }
-
-        chdir $here;
-        exec $^X,catfile($config{sourcedir}, 'Configure'),'reconf';
-    }
-}
-
-1;
-
-__END__
-
-=head1 NAME
-
-configdata.pm - configuration data for OpenSSL builds
-
-=head1 SYNOPSIS
-
-Interactive:
-
-  perl configdata.pm [options]
-
-As data bank module:
-
-  use configdata;
-
-=head1 DESCRIPTION
-
-This module can be used in two modes, interactively and as a module containing
-all the data recorded by OpenSSL's Configure script.
-
-When used interactively, simply run it as any perl script, with at least one
-option, and you will get the information you ask for.  See L&lt;/OPTIONS&gt; below.
-
-When loaded as a module, you get a few databanks with useful information to
-perform build related tasks.  The databanks are:
-
-    %config             Configured things.
-    %target             The OpenSSL config target with all inheritances
-                        resolved.
-    %disabled           The features that are disabled.
-    @disablables        The list of features that can be disabled.
-    %withargs           All data given through --with-THING options.
-    %unified_info       All information that was computed from the build.info
-                        files.
-
-=head1 OPTIONS
-
-=over 4
-
-=item B&lt;--help&gt;
-
-Print a brief help message and exit.
-
-=item B&lt;--man&gt;
-
-Print the manual page and exit.
-
-=item B&lt;--dump&gt; | B&lt;-d&gt;
-
-Print all relevant configuration data.  This is equivalent to B&lt;--command-line&gt;
-B&lt;--options&gt; B&lt;--target&gt; B&lt;--environment&gt; B&lt;--make-variables&gt;
-B&lt;--build-parameters&gt;.
-
-=item B&lt;--command-line&gt; | B&lt;-c&gt;
-
-Print the current configuration command line.
-
-=item B&lt;--options&gt; | B&lt;-o&gt;
-
-Print the features, both enabled and disabled, and display defined macro and
-skipped directories where applicable.
-
-=item B&lt;--target&gt; | B&lt;-t&gt;
-
-Print the config attributes for this config target.
-
-=item B&lt;--environment&gt; | B&lt;-e&gt;
-
-Print the environment variables and their values at the time of configuration.
-
-=item B&lt;--make-variables&gt; | B&lt;-m&gt;
-
-Print the main make variables generated in the current configuration
-
-=item B&lt;--build-parameters&gt; | B&lt;-b&gt;
-
-Print the build parameters, i.e. build file and build file templates.
-
-=item B&lt;--reconfigure&gt; | B&lt;--reconf&gt; | B&lt;-r&gt;
-
-Redo the configuration.
-
-=item B&lt;--verbose&gt; | B&lt;-v&gt;
-
-Verbose output.
-
-=back
-
-=cut
-
-EOF
-close(OUT);
+my $configdata_outname = 'configdata.pm';
+print &quot;Creating $configdata_outname\n&quot;;
+open CONFIGDATA, &quot;&gt;$configdata_outname.new&quot;
+            or die &quot;Trying to create $configdata_outname.new: $!&quot;;
+my $configdata_tmplname = cleanfile($srcdir, &quot;configdata.pm.in&quot;, $blddir);
+my $configdata_tmpl =
+    OpenSSL::Template-&gt;new(TYPE =&gt; 'FILE', SOURCE =&gt; $configdata_tmplname);
+$configdata_tmpl-&gt;fill_in(
+    FILENAME =&gt; $configdata_tmplname,
+    OUTPUT =&gt; \*CONFIGDATA,
+    HASH =&gt; { %template_vars,
+              autowarntext =&gt; [
+                  'WARNING: do not edit!',
+                  &quot;Generated by Configure from $configdata_tmplname&quot;,
+              ] }
+) or die $Text::Template::ERROR;
+close CONFIGDATA;
+rename &quot;$configdata_outname.new&quot;, $configdata_outname;
 if ($builder_platform eq 'unix') {
     my $mode = (0755 &amp; ~umask);
     chmod $mode, 'configdata.pm'
         or warn sprintf(&quot;WARNING: Couldn't change mode for 'configdata.pm' to 0%03o: %s\n&quot;,$mode,$!);
 }
 
-my %builders = (
-    unified =&gt; sub {
-        print 'Creating ',$target{build_file},&quot;\n&quot;;
-        run_dofile(catfile($blddir, $target{build_file}),
-                   @{$config{build_file_templates}});
-    },
-    );
-
-$builders{$builder}-&gt;($builder_platform, @builder_opts);
+print &quot;Running $configdata_outname\n&quot;;
+my $perlcmd = (quotify(&quot;maybeshell&quot;, $config{PERL}))[0];
+my $cmd = &quot;$perlcmd $configdata_outname&quot;;
+#print STDERR &quot;DEBUG[run_dofile]: \$cmd = $cmd\n&quot;;
+system($cmd);
+exit 1 if $? != 0;
 
 $SIG{__DIE__} = $orig_death_handler;
 
@@ -3223,24 +2822,6 @@ sub usage
         exit(1);
         }
 
-sub run_dofile
-{
-    my $out = shift;
-    my @templates = @_;
-
-    unlink $out || warn &quot;Can't remove $out, $!&quot;
-        if -f $out;
-    foreach (@templates) {
-        die &quot;Can't open $_, $!&quot; unless -f $_;
-    }
-    my $perlcmd = (quotify(&quot;maybeshell&quot;, $config{PERL}))[0];
-    my $cmd = &quot;$perlcmd \&quot;-I.\&quot; \&quot;-Mconfigdata\&quot; \&quot;$dofile\&quot; -o\&quot;Configure\&quot; \&quot;&quot;.join(&quot;\&quot; \&quot;&quot;<A HREF="../../../mailman/listinfo/openssl-commits.html">, at templates</A>).&quot;\&quot; &gt; \&quot;$out.new\&quot;&quot;;
-    #print STDERR &quot;DEBUG[run_dofile]: \$cmd = $cmd\n&quot;;
-    system($cmd);
-    exit 1 if $? != 0;
-    rename(&quot;$out.new&quot;, $out) || die &quot;Can't rename $out.new, $!&quot;;
-}
-
 sub compiler_predefined {
     state %predefined;
     my $cc = shift;
diff --git a/configdata.pm.in b/configdata.pm.in
new file mode 100644
index 0000000000..6e5c1ad4f6
--- /dev/null
+++ b/configdata.pm.in
@@ -0,0 +1,418 @@
+#! {- $config{HASHBANGPERL} -}
+# -*- mode: perl -*-
+{-
+ sub out_item {
+     my $ref = shift;
+     # Available options:
+     # indent           =&gt; callers indentation (int)
+     # delimiters       =&gt; 1 if outer delimiters should be added
+     my %opts = @_;
+
+     my $indent = $opts{indent} // 0;
+     # Indentation of the whole structure, where applicable
+     my $nlindent1 = &quot;\n&quot; . ' ' x $indent;
+     # Indentation of individual items, where applicable
+     my $nlindent2 = &quot;\n&quot; . ' ' x ($indent + 4);
+
+     my $product;      # Finished product, or reference to a function that
+                       # produces a string, given $_
+     # The following are only used when $product is a function reference
+     my $delim_l;      # Left delimiter of structure
+     my $delim_r;      # Right delimiter of structure
+     my $separator;    # Item separator
+     my @items;        # Items to iterate over
+
+     if (ref($ref) eq &quot;ARRAY&quot;) {
+         if (scalar @$ref == 0) {
+             $product = $opts{delimiters} ? '[]' : '';
+         } else {
+             $product = sub {
+                 out_item(\$_, delimiters =&gt; 1, indent =&gt; $indent + 4)
+             };
+             $delim_l = ($opts{delimiters} ? '[' : '').$nlindent2;
+             $delim_r = $nlindent1.($opts{delimiters} ? ']' : '');
+             $separator = &quot;,$nlindent2&quot;;
+             @items = @$ref;
+         }
+     } elsif (ref($ref) eq &quot;HASH&quot;) {
+         if (scalar keys %$ref == 0) {
+             $product = $opts{delimiters} ? '{}' : '';
+         } else {
+             $product = sub {
+                 quotify1($_) . &quot; =&gt; &quot;
+                 . out_item($ref-&gt;{$_}, delimiters =&gt; 1, indent =&gt; $indent + 4)
+             };
+             $delim_l = ($opts{delimiters} ? '{' : '').$nlindent2;
+             $delim_r = $nlindent1.($opts{delimiters} ? '}' : '');
+             $separator = &quot;,$nlindent2&quot;;
+             @items = sort keys %$ref;
+         }
+     } elsif (ref($ref) eq &quot;SCALAR&quot;) {
+         $product = defined $$ref ? quotify1 $$ref : &quot;undef&quot;;
+     } else {
+         $product = defined $ref ? quotify1 $ref : &quot;undef&quot;;
+     }
+
+     if (ref($product) eq &quot;CODE&quot;) {
+         $delim_l . join($separator, map { &amp;$product } @items) . $delim_r;
+     } else {
+         $product;
+     }
+ }
+
+ # We must make sourcedir() return an absolute path, because configdata.pm
+ # may be loaded as a module from any script in any directory, making
+ # relative paths untrustable.  Because the result is used with 'use lib',
+ # we must ensure that it returns a Unix style path.  Cwd::abs_path does
+ # that (File::Spec::Functions::rel2abs return O/S specific paths)
+ use File::Spec::Functions;
+ use Cwd qw(abs_path);
+ sub sourcedir {
+     return abs_path(catdir($config{sourcedir}, @_));
+ }
+ sub sourcefile {
+     return abs_path(catfile($config{sourcedir}, @_));
+ }
+-}
+package configdata;
+
+use strict;
+use warnings;
+
+use Exporter;
+our @ISA = qw(Exporter);
+our @EXPORT = qw(
+    %config %target %disabled %withargs %unified_info
+    @disablables @disablables_int
+);
+
+our %config = ({- out_item(\%config); -});
+our %target = ({- out_item(\%target); -});
+our @disablables = ({- out_item(\@disablables) -});
+our @disablables_int = ({- out_item(\@disablables_int) -});
+our %disabled = ({- out_item(\%disabled); -});
+our %withargs = ({- out_item(\%withargs); -});
+our %unified_info = ({- out_item(\%unified_info); -});
+
+# Unexported, only used by OpenSSL::Test::Utils::available_protocols()
+our %available_protocols = (
+    tls  =&gt; [{- out_item(\@tls) -}],
+    dtls =&gt; [{- out_item(\@dtls) -}],
+);
+
+# The following data is only used when this files is use as a script
+my @makevars = ({- out_item(\@makevars); -});
+my %disabled_info = ({- out_item(\%disabled_info); -});
+my @user_crossable = qw( {- join (' ', @user_crossable) -} );
+
+# If run directly, we can give some answers, and even reconfigure
+unless (caller) {
+    use Getopt::Long;
+    use File::Spec::Functions;
+    use File::Basename;
+    use Pod::Usage;
+
+    my $here = dirname($0);
+
+    if (scalar @ARGV == 0) {
+        # With no arguments, re-create the build file
+
+        use lib '{- sourcedir('util', 'perl') -}';
+        use OpenSSL::fallback '{- sourcefile('external', 'perl', 'MODULES.txt') -}';
+        use OpenSSL::Template;
+
+        my $prepend = &lt;&lt;&quot;_____&quot;;
+use File::Spec::Functions;
+use lib '{- sourcedir('util', 'perl') -}';
+_____
+        $prepend .= &lt;&lt;&quot;_____&quot; if defined $target{perl_platform};
+use lib '{- sourcedir('Configurations') -}';
+use lib '{- $config{builddir} -}';
+use platform;
+_____
+
+        my @autowarntext = (
+            'WARNING: do not edit!',
+            &quot;Generated by configdata.pm from &quot;
+            .join(&quot;, &quot;, @{$config{build_file_templates}})
+        );
+
+        print 'Creating ',$target{build_file},&quot;\n&quot;;
+        open BUILDFILE, &quot;&gt;$target{build_file}.new&quot;
+            or die &quot;Trying to create $target{build_file}.new: $!&quot;;
+        foreach (@{$config{build_file_templates}}) {
+            my $tmpl = OpenSSL::Template-&gt;new(TYPE =&gt; 'FILE',
+                                              SOURCE =&gt; $_);
+            $tmpl-&gt;fill_in(FILENAME =&gt; $_,
+                           OUTPUT =&gt; \*BUILDFILE,
+                           HASH =&gt; { config =&gt; \%config,
+                                     target =&gt; \%target,
+                                     disabled =&gt; \%disabled,
+                                     withargs =&gt; \%withargs,
+                                     unified_info =&gt; \%unified_info,
+                                     autowarntext =&gt; \@autowarntext },
+                           PREPEND =&gt; $prepend,
+                           # To ensure that global variables and functions
+                           # defined in one template stick around for the
+                           # next, making them combinable
+                           PACKAGE =&gt; 'OpenSSL::safe')
+                or die $Text::Template::ERROR;
+        }
+        close BUILDFILE;
+        rename(&quot;$target{build_file}.new&quot;, $target{build_file})
+            or die &quot;Trying to rename $target{build_file}.new to $target{build_file}: $!&quot;;
+
+        exit(0);
+    }
+
+    my $dump = undef;
+    my $cmdline = undef;
+    my $options = undef;
+    my $target = undef;
+    my $envvars = undef;
+    my $makevars = undef;
+    my $buildparams = undef;
+    my $reconf = undef;
+    my $verbose = undef;
+    my $help = undef;
+    my $man = undef;
+    GetOptions('dump|d'                 =&gt; \$dump,
+               'command-line|c'         =&gt; \$cmdline,
+               'options|o'              =&gt; \$options,
+               'target|t'               =&gt; \$target,
+               'environment|e'          =&gt; \$envvars,
+               'make-variables|m'       =&gt; \$makevars,
+               'build-parameters|b'     =&gt; \$buildparams,
+               'reconfigure|reconf|r'   =&gt; \$reconf,
+               'verbose|v'              =&gt; \$verbose,
+               'help'                   =&gt; \$help,
+               'man'                    =&gt; \$man)
+        or die &quot;Errors in command line arguments\n&quot;;
+
+    if (scalar @ARGV &gt; 0) {
+        print STDERR &lt;&lt;&quot;_____&quot;;
+Unrecognised arguments.
+For more information, do '$0 --help'
+_____
+        exit(2);
+    }
+
+    if ($help) {
+        pod2usage(-exitval =&gt; 0,
+                  -verbose =&gt; 1);
+    }
+    if ($man) {
+        pod2usage(-exitval =&gt; 0,
+                  -verbose =&gt; 2);
+    }
+    if ($dump || $cmdline) {
+        print &quot;\nCommand line (with current working directory = $here):\n\n&quot;;
+        print '    ',join(' ',
+                          $config{PERL},
+                          catfile($config{sourcedir}, 'Configure'),
+                          @{$config{perlargv}}), &quot;\n&quot;;
+        print &quot;\nPerl information:\n\n&quot;;
+        print '    ',$config{perl_cmd},&quot;\n&quot;;
+        print '    ',$config{perl_version},' for ',$config{perl_archname},&quot;\n&quot;;
+    }
+    if ($dump || $options) {
+        my $longest = 0;
+        my $longest2 = 0;
+        foreach my $what (@disablables) {
+            $longest = length($what) if $longest &lt; length($what);
+            $longest2 = length($disabled{$what})
+                if $disabled{$what} &amp;&amp; $longest2 &lt; length($disabled{$what});
+        }
+        print &quot;\nEnabled features:\n\n&quot;;
+        foreach my $what (@disablables) {
+            print &quot;    $what\n&quot; unless $disabled{$what};
+        }
+        print &quot;\nDisabled features:\n\n&quot;;
+        foreach my $what (@disablables) {
+            if ($disabled{$what}) {
+                print &quot;    $what&quot;, ' ' x ($longest - length($what) + 1),
+                    &quot;[$disabled{$what}]&quot;, ' ' x ($longest2 - length($disabled{$what}) + 1);
+                print $disabled_info{$what}-&gt;{macro}
+                    if $disabled_info{$what}-&gt;{macro};
+                print ' (skip ',
+                    join(', ', @{$disabled_info{$what}-&gt;{skipped}}),
+                    ')'
+                    if $disabled_info{$what}-&gt;{skipped};
+                print &quot;\n&quot;;
+            }
+        }
+    }
+    if ($dump || $target) {
+        print &quot;\nConfig target attributes:\n\n&quot;;
+        foreach (sort keys %target) {
+            next if $_ =~ m|^_| || $_ eq 'template';
+            my $quotify = sub {
+                map { (my $x = $_) =~ s|([\\\$\@&quot;])|\\$1|g; &quot;\&quot;$x\&quot;&quot;} @_;
+            };
+            print '    ', $_, ' =&gt; ';
+            if (ref($target{$_}) eq &quot;ARRAY&quot;) {
+                print '[ ', join(', ', $quotify-&gt;(@{$target{$_}})), &quot; ],\n&quot;;
+            } else {
+                print $quotify-&gt;($target{$_}), &quot;,\n&quot;
+            }
+        }
+    }
+    if ($dump || $envvars) {
+        print &quot;\nRecorded environment:\n\n&quot;;
+        foreach (sort keys %{$config{perlenv}}) {
+            print '    ',$_,' = ',($config{perlenv}-&gt;{$_} || ''),&quot;\n&quot;;
+        }
+    }
+    if ($dump || $makevars) {
+        print &quot;\nMakevars:\n\n&quot;;
+        foreach my $var (@makevars) {
+            my $prefix = '';
+            $prefix = $config{CROSS_COMPILE}
+                if grep { $var eq $_ } @user_crossable;
+            $prefix //= '';
+            print '    ',$var,' ' x (16 - length $var),'= ',
+                (ref $config{$var} eq 'ARRAY'
+                 ? join(' ', @{$config{$var}})
+                 : $prefix.$config{$var}),
+                &quot;\n&quot;
+                if defined $config{$var};
+        }
+
+        my @buildfile = ($config{builddir}, $config{build_file});
+        unshift @buildfile, $here
+            unless file_name_is_absolute($config{builddir});
+        my $buildfile = canonpath(catdir(@buildfile));
+        print &lt;&lt;&quot;_____&quot;;
+
+NOTE: These variables only represent the configuration view.  The build file
+template may have processed these variables further, please have a look at the
+build file for more exact data:
+    $buildfile
+_____
+    }
+    if ($dump || $buildparams) {
+        my @buildfile = ($config{builddir}, $config{build_file});
+        unshift @buildfile, $here
+            unless file_name_is_absolute($config{builddir});
+        print &quot;\nbuild file:\n\n&quot;;
+        print &quot;    &quot;, canonpath(catfile(@buildfile)),&quot;\n&quot;;
+
+        print &quot;\nbuild file templates:\n\n&quot;;
+        foreach (@{$config{build_file_templates}}) {
+            my @tmpl = ($_);
+            unshift @tmpl, $here
+                unless file_name_is_absolute($config{sourcedir});
+            print '    ',canonpath(catfile(@tmpl)),&quot;\n&quot;;
+        }
+    }
+    if ($reconf) {
+        if ($verbose) {
+            print 'Reconfiguring with: ', join(' ',@{$config{perlargv}}), &quot;\n&quot;;
+            foreach (sort keys %{$config{perlenv}}) {
+                print '    ',$_,' = ',($config{perlenv}-&gt;{$_} || &quot;&quot;),&quot;\n&quot;;
+            }
+        }
+
+        chdir $here;
+        exec $^X,catfile($config{sourcedir}, 'Configure'),'reconf';
+    }
+}
+
+1;
+
+__END__
+
+=head1 NAME
+
+configdata.pm - configuration data for OpenSSL builds
+
+=head1 SYNOPSIS
+
+Interactive:
+
+  perl configdata.pm [options]
+
+As data bank module:
+
+  use configdata;
+
+=head1 DESCRIPTION
+
+This module can be used in two modes, interactively and as a module containing
+all the data recorded by OpenSSL's Configure script.
+
+When used interactively, simply run it as any perl script.
+If run with no arguments, it will rebuild the build file (Makefile or
+corresponding).
+With at least one option, it will instead get the information you ask for, or
+re-run the configuration process.
+See L&lt;/OPTIONS&gt; below for more information.
+
+When loaded as a module, you get a few databanks with useful information to
+perform build related tasks.  The databanks are:
+
+    %config             Configured things.
+    %target             The OpenSSL config target with all inheritances
+                        resolved.
+    %disabled           The features that are disabled.
+    @disablables        The list of features that can be disabled.
+    %withargs           All data given through --with-THING options.
+    %unified_info       All information that was computed from the build.info
+                        files.
+
+=head1 OPTIONS
+
+=over 4
+
+=item B&lt;--help&gt;
+
+Print a brief help message and exit.
+
+=item B&lt;--man&gt;
+
+Print the manual page and exit.
+
+=item B&lt;--dump&gt; | B&lt;-d&gt;
+
+Print all relevant configuration data.  This is equivalent to B&lt;--command-line&gt;
+B&lt;--options&gt; B&lt;--target&gt; B&lt;--environment&gt; B&lt;--make-variables&gt;
+B&lt;--build-parameters&gt;.
+
+=item B&lt;--command-line&gt; | B&lt;-c&gt;
+
+Print the current configuration command line.
+
+=item B&lt;--options&gt; | B&lt;-o&gt;
+
+Print the features, both enabled and disabled, and display defined macro and
+skipped directories where applicable.
+
+=item B&lt;--target&gt; | B&lt;-t&gt;
+
+Print the config attributes for this config target.
+
+=item B&lt;--environment&gt; | B&lt;-e&gt;
+
+Print the environment variables and their values at the time of configuration.
+
+=item B&lt;--make-variables&gt; | B&lt;-m&gt;
+
+Print the main make variables generated in the current configuration
+
+=item B&lt;--build-parameters&gt; | B&lt;-b&gt;
+
+Print the build parameters, i.e. build file and build file templates.
+
+=item B&lt;--reconfigure&gt; | B&lt;--reconf&gt; | B&lt;-r&gt;
+
+Re-run the configuration process.
+
+=item B&lt;--verbose&gt; | B&lt;-v&gt;
+
+Verbose output.
+
+=back
+
+=cut
+
+EOF
diff --git a/util/dofile.pl b/util/dofile.pl
index 8cf66cd742..9fa8684549 100644
--- a/util/dofile.pl
+++ b/util/dofile.pl
@@ -14,9 +14,11 @@
 use strict;
 use warnings;
 
-use Getopt::Std;
 use FindBin;
 use lib &quot;$FindBin::Bin/perl&quot;;
+use OpenSSL::fallback &quot;$FindBin::Bin/../external/perl/MODULES.txt&quot;;
+use Getopt::Std;
+use OpenSSL::Template;
 
 # We actually expect to get the following hash tables from configdata:
 #
@@ -27,115 +29,8 @@ use lib &quot;$FindBin::Bin/perl&quot;;
 #
 # We just do a minimal test to see that we got what we expected.
 # $config{target} must exist as an absolute minimum.
-die &quot;You must run this script with -Mconfigdata\n&quot; if !exists($config{target});
-
-# Make a subclass of Text::Template to override append_text_to_result,
-# as recommended here:
-#
-# <A HREF="http://search.cpan.org/~mjd/Text-Template-1.46/lib/Text/Template.pm#Automatic_postprocessing_of_template_hunks">http://search.cpan.org/~mjd/Text-Template-1.46/lib/Text/Template.pm#Automatic_postprocessing_of_template_hunks</A>
-
-package OpenSSL::Template;
-
-# Because we know that Text::Template isn't a core Perl module, we use
-# a fallback in case it's not installed on the system
-use OpenSSL::fallback &quot;$FindBin::Bin/../external/perl/MODULES.txt&quot;;
-use Text::Template 1.46;
-
-#use parent qw/Text::Template/;
-use vars qw/@ISA/;
-push @ISA, qw/Text::Template/;
-
-# Override constructor
-sub new {
-    my ($class) = shift;
-
-    # Call the constructor of the parent class, Person.
-    my $self = $class-&gt;SUPER::new( @_ );
-    # Add few more attributes
-    $self-&gt;{_output_off}   = 0;	# Default to output hunks
-    bless $self, $class;
-    return $self;
-}
-
-sub append_text_to_output {
-    my $self = shift;
-
-    if ($self-&gt;{_output_off} == 0) {
-	$self-&gt;SUPER::append_text_to_output(@_);
-    }
-
-    return;
-}
-
-sub output_reset_on {
-    my $self = shift;
-    $self-&gt;{_output_off} = 0;
-}
-
-sub output_on {
-    my $self = shift;
-    if (--$self-&gt;{_output_off} &lt; 0) {
-	$self-&gt;{_output_off} = 0;
-    }
-}
-
-sub output_off {
-    my $self = shift;
-    $self-&gt;{_output_off}++;
-}
-
-# Come back to main
-
-package main;
-
-# Helper functions for the templates #################################
-
-# It might be practical to quotify some strings and have them protected
-# from possible harm.  These functions primarily quote things that might
-# be interpreted wrongly by a perl eval.
-
-# quotify1 STRING
-# This adds quotes (&quot;) around the given string, and escapes any $, @, \,
-# &quot; and ' by prepending a \ to them.
-sub quotify1 {
-    my $s = shift @_;
-    $s =~ s/([\$\@\\&quot;'])/\\$1/g;
-    '&quot;'.$s.'&quot;';
-}
-
-# quotify_l LIST
-# For each defined element in LIST (i.e. elements that aren't undef), have
-# it quotified with 'quotify1'
-sub quotify_l {
-    map {
-        if (!defined($_)) {
-            ();
-        } else {
-            quotify1($_);
-        }
-    } @_;
-}
-
-# Error reporter #####################################################
-
-# The error reporter uses %lines to figure out exactly which file the
-# error happened and at what line.  Not that the line number may be
-# the start of a perl snippet rather than the exact line where it
-# happened.  Nothing we can do about that here.
-
-my %lines = ();
-sub broken {
-    my %args = @_;
-    my $filename = &quot;&lt;STDIN&gt;&quot;;
-    my $deducelines = 0;
-    foreach (sort keys %lines) {
-        $filename = $lines{$_};
-        last if ($_ &gt; $args{lineno});
-        $deducelines += $_;
-    }
-    print STDERR $args{error},&quot; in $filename, fragment starting at line &quot;,$args{lineno}-$deducelines;
-    undef;
-}
+die &quot;You must run this script with -Mconfigdata\n&quot;
+    if !exists($config{target});
 
 # Check options ######################################################
 
@@ -146,74 +41,41 @@ my %opts = ();
 getopt('o', \%opts);
 
 my @autowarntext = (&quot;WARNING: do not edit!&quot;,
-		    &quot;Generated&quot;
-		    . (defined($opts{o}) ? &quot; by &quot;.$opts{o} : &quot;&quot;)
-		    . (scalar(@ARGV) &gt; 0 ? &quot; from &quot;.join(&quot;, &quot;<A HREF="../../../mailman/listinfo/openssl-commits.html">, at ARGV</A>) : &quot;&quot;));
+                    &quot;Generated&quot;
+                    . (defined($opts{o}) ? &quot; by &quot;.$opts{o} : &quot;&quot;)
+                    . (scalar(@ARGV) &gt; 0 ? &quot; from &quot;.join(&quot;, &quot;<A HREF="../../../mailman/listinfo/openssl-commits.html">, at ARGV</A>) : &quot;&quot;));
 
-# Template reading ###################################################
+# Template setup #####################################################
 
-# Read in all the templates into $text, while keeping track of each
-# file and its size in lines, to try to help report errors with the
-# correct file name and line number.
-
-my $prev_linecount = 0;
-my $text =
+my @template_settings =
     @ARGV
-    ? join(&quot;&quot;, map { my $x = Text::Template::_load_text($_);
-                     if (!defined($x)) {
-                         die $Text::Template::ERROR, &quot;\n&quot;;
-                     }
-                     $x = &quot;{- output_reset_on() -}&quot; . $x;
-                     my $linecount = $x =~ tr/\n//;
-                     $prev_linecount = ($linecount += $prev_linecount);
-                     $lines{$linecount} = $_;
-                     $x } @ARGV)
-    : join(&quot;&quot;, &lt;STDIN&gt;);
+    ? map { { TYPE =&gt; 'FILE', SOURCE =&gt; $_, FILENAME =&gt; $_ } } @ARGV
+    : ( { TYPE =&gt; 'FILEHANDLE', SOURCE =&gt; \*STDIN, FILENAME =&gt; '&lt;stdin&gt;' } );
 
 # Engage! ############################################################
 
-# Load the full template (combination of files) into Text::Template
-# and fill it up with our data.  Output goes directly to STDOUT
-
-my $prepend = qq{
+my $prepend = &lt;&lt;&quot;_____&quot;;
 use File::Spec::Functions;
-use lib catdir('$config{sourcedir}', 'util', 'perl');
-};
-$prepend .= qq{
-use lib catdir('$config{sourcedir}', 'Configurations');
+_____
+$prepend .= &lt;&lt;&quot;_____&quot; if defined $target{perl_platform};
+use lib &quot;$FindBin::Bin/../Configurations&quot;;
 use lib '$config{builddir}';
 use platform;
-} if defined $target{perl_platform};
-
-my $template =
-    OpenSSL::Template-&gt;new(TYPE =&gt; 'STRING',
-                           SOURCE =&gt; $text,
-                           PREPEND =&gt; $prepend);
-
-sub output_reset_on {
-    $template-&gt;output_reset_on();
-    &quot;&quot;;
-}
-sub output_on {
-    $template-&gt;output_on();
-    &quot;&quot;;
+_____
+
+foreach (@template_settings) {
+    my $template = OpenSSL::Template-&gt;new(%$_);
+    $template-&gt;fill_in(%$_,
+                       OUTPUT =&gt; \*STDOUT,
+                       HASH =&gt; { config =&gt; \%config,
+                                 target =&gt; \%target,
+                                 disabled =&gt; \%disabled,
+                                 withargs =&gt; \%withargs,
+                                 unified_info =&gt; \%unified_info,
+                                 autowarntext =&gt; \@autowarntext },
+                       PREPEND =&gt; $prepend,
+                       # To ensure that global variables and functions
+                       # defined in one template stick around for the
+                       # next, making them combinable
+                       PACKAGE =&gt; 'OpenSSL::safe');
 }
-sub output_off {
-    $template-&gt;output_off();
-    &quot;&quot;;
-}
-
-$template-&gt;fill_in(OUTPUT =&gt; \*STDOUT,
-                   HASH =&gt; { config =&gt; \%config,
-                             target =&gt; \%target,
-                             disabled =&gt; \%disabled,
-                             withargs =&gt; \%withargs,
-                             unified_info =&gt; \%unified_info,
-                             autowarntext =&gt; \@autowarntext,
-                             quotify1 =&gt; \&amp;quotify1,
-                             quotify_l =&gt; \&amp;quotify_l,
-                             output_reset_on =&gt; \&amp;output_reset_on,
-                             output_on =&gt; \&amp;output_on,
-                             output_off =&gt; \&amp;output_off },
-                   DELIMITERS =&gt; [ &quot;{-&quot;, &quot;-}&quot; ],
-                   BROKEN =&gt; \&amp;broken);
diff --git a/util/perl/OpenSSL/Template.pm b/util/perl/OpenSSL/Template.pm
new file mode 100644
index 0000000000..ed89d15085
--- /dev/null
+++ b/util/perl/OpenSSL/Template.pm
@@ -0,0 +1,195 @@
+#! /usr/bin/env perl
+# Copyright 2016-2019 The OpenSSL Project Authors. All Rights Reserved.
+#
+# Licensed under the Apache License 2.0 (the &quot;License&quot;).  You may not use
+# this file except in compliance with the License.  You can obtain a copy
+# in the file LICENSE in the source distribution or at
+# <A HREF="https://www.openssl.org/source/license.html">https://www.openssl.org/source/license.html</A>
+
+# Implements the functionality to read one or more template files and run
+# them through Text::Template
+
+package OpenSSL::Template;
+
+=head1 NAME
+
+OpenSSL::Template - a private extension of Text::Template
+
+=head1 DESCRIPTION
+
+This provides exactly the functionality from Text::Template, with the
+following additions:
+
+=over 4
+
+=item -
+
+The template perl code delimiters (given with the C&lt;DELIMITER&gt; option)
+are set to C&lt;{-&gt; and C&lt;-}&gt; by default.
+
+=item -
+
+A few extra functions are offered to be used by the template perl code, see
+L&lt;/Functions&gt;.
+
+=back
+
+=cut
+
+use File::Basename;
+use File::Spec::Functions;
+use Text::Template 1.46;
+
+our @ISA = qw(Text::Template);  # parent
+
+sub new {
+    my $class = shift;
+
+    # Call the constructor of the parent class.
+    my $self = $class-&gt;SUPER::new(DELIMITERS =&gt; [ '{-', '-}'],
+                                  @_ );
+
+    # Add few more attributes
+    $self-&gt;{_output_off}   = 0; # Default to output hunks
+
+    return bless $self, $class;
+}
+
+sub fill_in {
+    my $self = shift;
+    my %opts = @_;
+    my %hash = ( %{$opts{HASH}} );
+    delete $opts{HASH};
+
+    $self-&gt;SUPER::fill_in(HASH =&gt; { quotify1 =&gt; \&amp;quotify1,
+                                    quotify_l =&gt; \&amp;quotify_l,
+                                    output_on =&gt; sub { $self-&gt;output_on() },
+                                    output_off =&gt; sub { $self-&gt;output_off() },
+                                    %hash },
+                          %opts);
+}
+
+=head2 Functions
+
+=cut
+
+# Override Text::Template's append_text_to_result, as recommended here:
+#
+# <A HREF="http://search.cpan.org/~mjd/Text-Template-1.46/lib/Text/Template.pm#Automatic_postprocessing_of_template_hunks">http://search.cpan.org/~mjd/Text-Template-1.46/lib/Text/Template.pm#Automatic_postprocessing_of_template_hunks</A>
+sub append_text_to_output {
+    my $self = shift;
+
+    if ($self-&gt;{_output_off} == 0) {
+        $self-&gt;SUPER::append_text_to_output(@_);
+    }
+
+    return;
+}
+
+=begin comment
+
+We lie about the OO nature of output_on() and output_off(), 'cause that's
+not how we pass them, see the HASH option used in fill_in() above
+
+=end comment
+
+=over 4
+
+=item output_on()
+
+=item output_off()
+
+Switch on or off template output.  Here's an example usage:
+
+=over 4
+
+ {- output_off() if CONDITION -}
+ whatever
+ {- output_on() if CONDITION -}
+
+=back
+
+In this example, C&lt;whatever&gt; will only become part of the template output
+if C&lt;CONDITION&gt; is true.
+
+=back
+
+=cut
+
+sub output_on {
+    my $self = shift;
+    if (--$self-&gt;{_output_off} &lt; 0) {
+        $self-&gt;{_output_off} = 0;
+    }
+}
+
+sub output_off {
+    my $self = shift;
+    $self-&gt;{_output_off}++;
+}
+
+# Helper functions for the templates #################################
+
+# It might be practical to quotify some strings and have them protected
+# from possible harm.  These functions primarily quote things that might
+# be interpreted wrongly by a perl eval.
+
+# NOTE THAT THESE AREN'T CLASS METHODS!
+
+=over 4
+
+=item quotify1 STRING
+
+This adds quotes (&quot;) around the given string, and escapes any $, @, \,
+&quot; and ' by prepending a \ to them.
+
+=back
+
+=cut
+
+sub quotify1 {
+    my $s = shift @_;
+    $s =~ s/([\$\@\\&quot;'])/\\$1/g;
+    '&quot;'.$s.'&quot;';
+}
+
+=over 4
+
+=item quotify_l LIST
+
+For each defined element in LIST (i.e. elements that aren't undef), have
+it quotified with 'quotify1'.
+Undefined elements are ignored.
+
+=back
+
+=cut
+
+sub quotify_l {
+    map {
+        if (!defined($_)) {
+            ();
+        } else {
+            quotify1($_);
+        }
+    } @_;
+}
+
+=head1 SEE ALSO
+
+L&lt;Text::Template&gt;
+
+=head1 AUTHORS
+
+Richard Levitte E&lt;lt&gt;<A HREF="../../../mailman/listinfo/openssl-commits.html">levitte at openssl.orgE</A>&lt;gt&gt;
+
+=head1 COPYRIGHT
+
+Copyright 2016-2019 The OpenSSL Project Authors. All Rights Reserved.
+
+Licensed under the Apache License 2.0 (the &quot;License&quot;).  You may not use
+this file except in compliance with the License.  You can obtain a copy
+in the file LICENSE in the source distribution or at
+L&lt;<A HREF="https://www.openssl.org/source/license.html">https://www.openssl.org/source/license.html</A>&gt;.
+
+=cut
</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="025075.html">[openssl]  master update
</A></li>
	<LI>Next message: <A HREF="025096.html">[openssl]  master update
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25077">[ date ]</a>
              <a href="thread.html#25077">[ thread ]</a>
              <a href="subject.html#25077">[ subject ]</a>
              <a href="author.html#25077">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="../../../mailman/listinfo/openssl-commits.html">More information about the openssl-commits
mailing list</a><br>
</body></html>
