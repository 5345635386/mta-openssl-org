<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [openssl-commits] [openssl]  master update
   </TITLE>
   <LINK REL="Index" HREF="https://mta.openssl.org/pipermail/openssl-commits/2018-March/index.html" >
   <LINK REL="made" HREF="mailto:openssl-commits%40openssl.org?Subject=Re%3A%20%5Bopenssl-commits%5D%20%5Bopenssl%5D%20%20master%20update&In-Reply-To=%3C1522272732.774335.4696.nullmailer%40dev.openssl.org%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="018804.html">
   <LINK REL="Next"  HREF="018807.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[openssl-commits] [openssl]  master update</H1>
    <B>Andy Polyakov</B> 
    <A HREF="mailto:openssl-commits%40openssl.org?Subject=Re%3A%20%5Bopenssl-commits%5D%20%5Bopenssl%5D%20%20master%20update&In-Reply-To=%3C1522272732.774335.4696.nullmailer%40dev.openssl.org%3E"
       TITLE="[openssl-commits] [openssl]  master update">appro at openssl.org
       </A><BR>
    <I>Wed Mar 28 21:32:12 UTC 2018</I>
    <P><UL>
        <LI>Previous message: <A HREF="018804.html">[openssl-commits] [openssl]  master update
</A></li>
        <LI>Next message: <A HREF="018807.html">[openssl-commits] [openssl]  master update
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#18806">[ date ]</a>
              <a href="thread.html#18806">[ thread ]</a>
              <a href="subject.html#18806">[ subject ]</a>
              <a href="author.html#18806">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>The branch master has been updated
       via  8eb399fb25a6ef68b2a9e8d34b242b9767c46abe (commit)
       via  258689931ef9f25f282b550367f9c815b91069d7 (commit)
       via  74d38a8677ac10f7368c12079af9a27e959ee295 (commit)
       via  dacd2a87b550923524e80554b3a4869ea0351f66 (commit)
       via  55bd169fd874f65fa15b20ce4feae2e8ed5e77f1 (commit)
      from  c6d38183d6754b0a7b90527d085a500680e7d2ea (commit)


- Log -----------------------------------------------------------------
commit 8eb399fb25a6ef68b2a9e8d34b242b9767c46abe
Author: Patrick Steuer &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">patrick.steuer at de.ibm.com</A>&gt;
Date:   Wed Mar 28 13:23:56 2018 +0100

    crypto/e_aes.c: use S390X_AES_FC macro
    
    ... to compute s390x aes function code from keylength.
    
    Signed-off-by: Patrick Steuer &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">patrick.steuer at de.ibm.com</A>&gt;
    
    Reviewed-by: Richard Levitte &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">levitte at openssl.org</A>&gt;
    Reviewed-by: Andy Polyakov &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">appro at openssl.org</A>&gt;
    Reviewed-by: Rich Salz &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">rsalz at openssl.org</A>&gt;
    (Merged from <A HREF="https://github.com/openssl/openssl/pull/5250">https://github.com/openssl/openssl/pull/5250</A>)

commit 258689931ef9f25f282b550367f9c815b91069d7
Author: Patrick Steuer &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">patrick.steuer at de.ibm.com</A>&gt;
Date:   Wed Mar 28 13:21:29 2018 +0100

    crypto/evp/e_aes.c: add size_t casts to increase readability
    
    Signed-off-by: Patrick Steuer &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">patrick.steuer at de.ibm.com</A>&gt;
    
    Reviewed-by: Richard Levitte &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">levitte at openssl.org</A>&gt;
    Reviewed-by: Andy Polyakov &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">appro at openssl.org</A>&gt;
    Reviewed-by: Rich Salz &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">rsalz at openssl.org</A>&gt;
    (Merged from <A HREF="https://github.com/openssl/openssl/pull/5250">https://github.com/openssl/openssl/pull/5250</A>)

commit 74d38a8677ac10f7368c12079af9a27e959ee295
Author: Patrick Steuer &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">patrick.steuer at de.ibm.com</A>&gt;
Date:   Wed Mar 28 13:09:24 2018 +0100

    s390x assembly pack: add KMF code path for aes-cfb/cfb8
    
    Signed-off-by: Patrick Steuer &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">patrick.steuer at de.ibm.com</A>&gt;
    
    Reviewed-by: Richard Levitte &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">levitte at openssl.org</A>&gt;
    Reviewed-by: Andy Polyakov &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">appro at openssl.org</A>&gt;
    Reviewed-by: Rich Salz &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">rsalz at openssl.org</A>&gt;
    (Merged from <A HREF="https://github.com/openssl/openssl/pull/5250">https://github.com/openssl/openssl/pull/5250</A>)

commit dacd2a87b550923524e80554b3a4869ea0351f66
Author: Patrick Steuer &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">patrick.steuer at de.ibm.com</A>&gt;
Date:   Wed Mar 28 12:54:50 2018 +0100

    s390x assembly pack: add KMO code path for aes-ofb
    
    Signed-off-by: Patrick Steuer &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">patrick.steuer at de.ibm.com</A>&gt;
    
    Reviewed-by: Richard Levitte &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">levitte at openssl.org</A>&gt;
    Reviewed-by: Andy Polyakov &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">appro at openssl.org</A>&gt;
    Reviewed-by: Rich Salz &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">rsalz at openssl.org</A>&gt;
    (Merged from <A HREF="https://github.com/openssl/openssl/pull/5250">https://github.com/openssl/openssl/pull/5250</A>)

commit 55bd169fd874f65fa15b20ce4feae2e8ed5e77f1
Author: Patrick Steuer &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">patrick.steuer at de.ibm.com</A>&gt;
Date:   Wed Mar 28 12:43:15 2018 +0100

    s390x assembly pack: add KM code path for aes-ecb
    
    Signed-off-by: Patrick Steuer &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">patrick.steuer at de.ibm.com</A>&gt;
    
    Reviewed-by: Richard Levitte &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">levitte at openssl.org</A>&gt;
    Reviewed-by: Andy Polyakov &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">appro at openssl.org</A>&gt;
    Reviewed-by: Rich Salz &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">rsalz at openssl.org</A>&gt;
    (Merged from <A HREF="https://github.com/openssl/openssl/pull/5250">https://github.com/openssl/openssl/pull/5250</A>)

-----------------------------------------------------------------------

Summary of changes:
 crypto/evp/e_aes.c   | 316 ++++++++++++++++++++++++++++++++++++++++++++-------
 crypto/s390x_arch.h  |   4 +
 crypto/s390xcpuid.pl |  42 +++++++
 3 files changed, 319 insertions(+), 43 deletions(-)

diff --git a/crypto/evp/e_aes.c b/crypto/evp/e_aes.c
index 1d5007a..a914a6e 100644
--- a/crypto/evp/e_aes.c
+++ b/crypto/evp/e_aes.c
@@ -960,6 +960,57 @@ typedef struct {
     union {
         double align;
         /*-
+         * KM-AES parameter block - begin
+         * (see z/Architecture Principles of Operation &gt;= SA22-7832-06)
+         */
+        struct {
+            unsigned char k[32];
+        } param;
+        /* KM-AES parameter block - end */
+    } km;
+    unsigned int fc;
+} S390X_AES_ECB_CTX;
+
+typedef struct {
+    union {
+        double align;
+        /*-
+         * KMO-AES parameter block - begin
+         * (see z/Architecture Principles of Operation &gt;= SA22-7832-08)
+         */
+        struct {
+            unsigned char cv[16];
+            unsigned char k[32];
+        } param;
+        /* KMO-AES parameter block - end */
+    } kmo;
+    unsigned int fc;
+
+    int res;
+} S390X_AES_OFB_CTX;
+
+typedef struct {
+    union {
+        double align;
+        /*-
+         * KMF-AES parameter block - begin
+         * (see z/Architecture Principles of Operation &gt;= SA22-7832-08)
+         */
+        struct {
+            unsigned char cv[16];
+            unsigned char k[32];
+        } param;
+        /* KMF-AES parameter block - end */
+    } kmf;
+    unsigned int fc;
+
+    int res;
+} S390X_AES_CFB_CTX;
+
+typedef struct {
+    union {
+        double align;
+        /*-
          * KMA-GCM-AES parameter block - begin
          * (see z/Architecture Principles of Operation &gt;= SA22-7832-11)
          */
@@ -1056,18 +1107,16 @@ typedef struct {
     } aes;
 } S390X_AES_CCM_CTX;
 
-# define S390X_aes_128_CAPABLE ((OPENSSL_s390xcap_P.km[0] &amp;	\
-                                 S390X_CAPBIT(S390X_AES_128)) &amp;&amp;\
-                                (OPENSSL_s390xcap_P.kmc[0] &amp;	\
-                                 S390X_CAPBIT(S390X_AES_128)))
-# define S390X_aes_192_CAPABLE ((OPENSSL_s390xcap_P.km[0] &amp;	\
-                                 S390X_CAPBIT(S390X_AES_192)) &amp;&amp;\
-                                (OPENSSL_s390xcap_P.kmc[0] &amp;	\
-                                 S390X_CAPBIT(S390X_AES_192)))
-# define S390X_aes_256_CAPABLE ((OPENSSL_s390xcap_P.km[0] &amp;	\
-                                 S390X_CAPBIT(S390X_AES_256)) &amp;&amp;\
-                                (OPENSSL_s390xcap_P.kmc[0] &amp;	\
-                                 S390X_CAPBIT(S390X_AES_256)))
+/* Convert key size to function code: [16,24,32] -&gt; [18,19,20]. */
+# define S390X_AES_FC(keylen)  (S390X_AES_128 + ((((keylen) &lt;&lt; 3) - 128) &gt;&gt; 6))
+
+/* Most modes of operation need km for partial block processing. */
+# define S390X_aes_128_CAPABLE (OPENSSL_s390xcap_P.km[0] &amp;	\
+                                S390X_CAPBIT(S390X_AES_128))
+# define S390X_aes_192_CAPABLE (OPENSSL_s390xcap_P.km[0] &amp;	\
+                                S390X_CAPBIT(S390X_AES_192))
+# define S390X_aes_256_CAPABLE (OPENSSL_s390xcap_P.km[0] &amp;	\
+                                S390X_CAPBIT(S390X_AES_256))
 
 # define s390x_aes_init_key aes_init_key
 static int s390x_aes_init_key(EVP_CIPHER_CTX *ctx, const unsigned char *key,
@@ -1076,47 +1125,224 @@ static int s390x_aes_init_key(EVP_CIPHER_CTX *ctx, const unsigned char *key,
 # define S390X_aes_128_cbc_CAPABLE	1	/* checked by callee */
 # define S390X_aes_192_cbc_CAPABLE	1
 # define S390X_aes_256_cbc_CAPABLE	1
+# define S390X_AES_CBC_CTX		EVP_AES_KEY
+
+# define s390x_aes_cbc_init_key aes_init_key
 
 # define s390x_aes_cbc_cipher aes_cbc_cipher
 static int s390x_aes_cbc_cipher(EVP_CIPHER_CTX *ctx, unsigned char *out,
                                 const unsigned char *in, size_t len);
 
-# define S390X_aes_128_ecb_CAPABLE	0
-# define S390X_aes_192_ecb_CAPABLE	0
-# define S390X_aes_256_ecb_CAPABLE	0
+# define S390X_aes_128_ecb_CAPABLE	S390X_aes_128_CAPABLE
+# define S390X_aes_192_ecb_CAPABLE	S390X_aes_192_CAPABLE
+# define S390X_aes_256_ecb_CAPABLE	S390X_aes_256_CAPABLE
+
+static int s390x_aes_ecb_init_key(EVP_CIPHER_CTX *ctx,
+                                  const unsigned char *key,
+                                  const unsigned char *iv, int enc)
+{
+    S390X_AES_ECB_CTX *cctx = EVP_C_DATA(S390X_AES_ECB_CTX, ctx);
+    const int keylen = EVP_CIPHER_CTX_key_length(ctx);
+
+    cctx-&gt;fc = S390X_AES_FC(keylen);
+    if (!enc)
+        cctx-&gt;fc |= S390X_DECRYPT;
+
+    memcpy(cctx-&gt;km.param.k, key, keylen);
+    return 1;
+}
 
-# define s390x_aes_ecb_cipher aes_ecb_cipher
 static int s390x_aes_ecb_cipher(EVP_CIPHER_CTX *ctx, unsigned char *out,
-                                const unsigned char *in, size_t len);
+                                const unsigned char *in, size_t len)
+{
+    S390X_AES_ECB_CTX *cctx = EVP_C_DATA(S390X_AES_ECB_CTX, ctx);
+
+    s390x_km(in, len, out, cctx-&gt;fc, &amp;cctx-&gt;km.param);
+    return 1;
+}
 
-# define S390X_aes_128_ofb_CAPABLE	0
-# define S390X_aes_192_ofb_CAPABLE	0
-# define S390X_aes_256_ofb_CAPABLE	0
+# define S390X_aes_128_ofb_CAPABLE (S390X_aes_128_CAPABLE &amp;&amp;		\
+                                    (OPENSSL_s390xcap_P.kmo[0] &amp;	\
+                                     S390X_CAPBIT(S390X_AES_128)))
+# define S390X_aes_192_ofb_CAPABLE (S390X_aes_192_CAPABLE &amp;&amp;		\
+                                    (OPENSSL_s390xcap_P.kmo[0] &amp;	\
+                                     S390X_CAPBIT(S390X_AES_192)))
+# define S390X_aes_256_ofb_CAPABLE (S390X_aes_256_CAPABLE &amp;&amp;		\
+                                    (OPENSSL_s390xcap_P.kmo[0] &amp;	\
+                                     S390X_CAPBIT(S390X_AES_256)))
+
+static int s390x_aes_ofb_init_key(EVP_CIPHER_CTX *ctx,
+                                  const unsigned char *key,
+                                  const unsigned char *ivec, int enc)
+{
+    S390X_AES_OFB_CTX *cctx = EVP_C_DATA(S390X_AES_OFB_CTX, ctx);
+    const unsigned char *iv = EVP_CIPHER_CTX_original_iv(ctx);
+    const int keylen = EVP_CIPHER_CTX_key_length(ctx);
+    const int ivlen = EVP_CIPHER_CTX_iv_length(ctx);
+
+    memcpy(cctx-&gt;kmo.param.cv, iv, ivlen);
+    memcpy(cctx-&gt;kmo.param.k, key, keylen);
+    cctx-&gt;fc = S390X_AES_FC(keylen);
+    cctx-&gt;res = 0;
+    return 1;
+}
 
-# define s390x_aes_ofb_cipher aes_ofb_cipher
 static int s390x_aes_ofb_cipher(EVP_CIPHER_CTX *ctx, unsigned char *out,
-                                const unsigned char *in, size_t len);
+                                const unsigned char *in, size_t len)
+{
+    S390X_AES_OFB_CTX *cctx = EVP_C_DATA(S390X_AES_OFB_CTX, ctx);
+    int n = cctx-&gt;res;
+    int rem;
+
+    while (n &amp;&amp; len) {
+        *out = *in ^ cctx-&gt;kmo.param.cv[n];
+        n = (n + 1) &amp; 0xf;
+        --len;
+        ++in;
+        ++out;
+    }
+
+    rem = len &amp; 0xf;
+
+    len &amp;= ~(size_t)0xf;
+    if (len) {
+        s390x_kmo(in, len, out, cctx-&gt;fc, &amp;cctx-&gt;kmo.param);
+
+        out += len;
+        in += len;
+    }
+
+    if (rem) {
+        s390x_km(cctx-&gt;kmo.param.cv, 16, cctx-&gt;kmo.param.cv, cctx-&gt;fc,
+                 cctx-&gt;kmo.param.k);
+
+        while (rem--) {
+            out[n] = in[n] ^ cctx-&gt;kmo.param.cv[n];
+            ++n;
+        }
+    }
 
-# define S390X_aes_128_cfb_CAPABLE	0
-# define S390X_aes_192_cfb_CAPABLE	0
-# define S390X_aes_256_cfb_CAPABLE	0
+    cctx-&gt;res = n;
+    return 1;
+}
+
+# define S390X_aes_128_cfb_CAPABLE (S390X_aes_128_CAPABLE &amp;&amp;		\
+                                    (OPENSSL_s390xcap_P.kmf[0] &amp;	\
+                                     S390X_CAPBIT(S390X_AES_128)))
+# define S390X_aes_192_cfb_CAPABLE (S390X_aes_192_CAPABLE &amp;&amp;		\
+                                    (OPENSSL_s390xcap_P.kmf[0] &amp;	\
+                                     S390X_CAPBIT(S390X_AES_192)))
+# define S390X_aes_256_cfb_CAPABLE (S390X_aes_256_CAPABLE &amp;&amp;		\
+                                    (OPENSSL_s390xcap_P.kmf[0] &amp;	\
+                                     S390X_CAPBIT(S390X_AES_256)))
+
+static int s390x_aes_cfb_init_key(EVP_CIPHER_CTX *ctx,
+                                  const unsigned char *key,
+                                  const unsigned char *ivec, int enc)
+{
+    S390X_AES_CFB_CTX *cctx = EVP_C_DATA(S390X_AES_CFB_CTX, ctx);
+    const unsigned char *iv = EVP_CIPHER_CTX_original_iv(ctx);
+    const int keylen = EVP_CIPHER_CTX_key_length(ctx);
+    const int ivlen = EVP_CIPHER_CTX_iv_length(ctx);
+
+    cctx-&gt;fc = S390X_AES_FC(keylen);
+    cctx-&gt;fc |= 16 &lt;&lt; 24;   /* 16 bytes cipher feedback */
+    if (!enc)
+        cctx-&gt;fc |= S390X_DECRYPT;
+
+    cctx-&gt;res = 0;
+    memcpy(cctx-&gt;kmf.param.cv, iv, ivlen);
+    memcpy(cctx-&gt;kmf.param.k, key, keylen);
+    return 1;
+}
 
-# define s390x_aes_cfb_cipher aes_cfb_cipher
 static int s390x_aes_cfb_cipher(EVP_CIPHER_CTX *ctx, unsigned char *out,
-                                const unsigned char *in, size_t len);
+                                const unsigned char *in, size_t len)
+{
+    S390X_AES_CFB_CTX *cctx = EVP_C_DATA(S390X_AES_CFB_CTX, ctx);
+    const int keylen = EVP_CIPHER_CTX_key_length(ctx);
+    const int enc = EVP_CIPHER_CTX_encrypting(ctx);
+    int n = cctx-&gt;res;
+    int rem;
+    unsigned char tmp;
+
+    while (n &amp;&amp; len) {
+        tmp = *in;
+        *out = cctx-&gt;kmf.param.cv[n] ^ tmp;
+        cctx-&gt;kmf.param.cv[n] = enc ? *out : tmp;
+        n = (n + 1) &amp; 0xf;
+        --len;
+        ++in;
+        ++out;
+    }
 
-# define S390X_aes_128_cfb8_CAPABLE	0
-# define S390X_aes_192_cfb8_CAPABLE	0
-# define S390X_aes_256_cfb8_CAPABLE	0
+    rem = len &amp; 0xf;
+
+    len &amp;= ~(size_t)0xf;
+    if (len) {
+        s390x_kmf(in, len, out, cctx-&gt;fc, &amp;cctx-&gt;kmf.param);
+
+        out += len;
+        in += len;
+    }
+
+    if (rem) {
+        s390x_km(cctx-&gt;kmf.param.cv, 16, cctx-&gt;kmf.param.cv,
+                 S390X_AES_FC(keylen), cctx-&gt;kmf.param.k);
+
+        while (rem--) {
+            tmp = in[n];
+            out[n] = cctx-&gt;kmf.param.cv[n] ^ tmp;
+            cctx-&gt;kmf.param.cv[n] = enc ? out[n] : tmp;
+            ++n;
+        }
+    }
+
+    cctx-&gt;res = n;
+    return 1;
+}
+
+# define S390X_aes_128_cfb8_CAPABLE (OPENSSL_s390xcap_P.kmf[0] &amp;	\
+                                     S390X_CAPBIT(S390X_AES_128))
+# define S390X_aes_192_cfb8_CAPABLE (OPENSSL_s390xcap_P.kmf[0] &amp;	\
+                                     S390X_CAPBIT(S390X_AES_192))
+# define S390X_aes_256_cfb8_CAPABLE (OPENSSL_s390xcap_P.kmf[0] &amp;	\
+                                     S390X_CAPBIT(S390X_AES_256))
+
+static int s390x_aes_cfb8_init_key(EVP_CIPHER_CTX *ctx,
+                                   const unsigned char *key,
+                                   const unsigned char *ivec, int enc)
+{
+    S390X_AES_CFB_CTX *cctx = EVP_C_DATA(S390X_AES_CFB_CTX, ctx);
+    const unsigned char *iv = EVP_CIPHER_CTX_original_iv(ctx);
+    const int keylen = EVP_CIPHER_CTX_key_length(ctx);
+    const int ivlen = EVP_CIPHER_CTX_iv_length(ctx);
+
+    cctx-&gt;fc = S390X_AES_FC(keylen);
+    cctx-&gt;fc |= 1 &lt;&lt; 24;   /* 1 byte cipher feedback */
+    if (!enc)
+        cctx-&gt;fc |= S390X_DECRYPT;
+
+    memcpy(cctx-&gt;kmf.param.cv, iv, ivlen);
+    memcpy(cctx-&gt;kmf.param.k, key, keylen);
+    return 1;
+}
 
-# define s390x_aes_cfb8_cipher aes_cfb8_cipher
 static int s390x_aes_cfb8_cipher(EVP_CIPHER_CTX *ctx, unsigned char *out,
-                                 const unsigned char *in, size_t len);
+                                 const unsigned char *in, size_t len)
+{
+    S390X_AES_CFB_CTX *cctx = EVP_C_DATA(S390X_AES_CFB_CTX, ctx);
+
+    s390x_kmf(in, len, out, cctx-&gt;fc, &amp;cctx-&gt;kmf.param);
+    return 1;
+}
 
 # define S390X_aes_128_cfb1_CAPABLE	0
 # define S390X_aes_192_cfb1_CAPABLE	0
 # define S390X_aes_256_cfb1_CAPABLE	0
 
+# define s390x_aes_cfb1_init_key aes_init_key
+
 # define s390x_aes_cfb1_cipher aes_cfb1_cipher
 static int s390x_aes_cfb1_cipher(EVP_CIPHER_CTX *ctx, unsigned char *out,
                                  const unsigned char *in, size_t len);
@@ -1124,6 +1350,9 @@ static int s390x_aes_cfb1_cipher(EVP_CIPHER_CTX *ctx, unsigned char *out,
 # define S390X_aes_128_ctr_CAPABLE	1	/* checked by callee */
 # define S390X_aes_192_ctr_CAPABLE	1
 # define S390X_aes_256_ctr_CAPABLE	1
+# define S390X_AES_CTR_CTX		EVP_AES_KEY
+
+# define s390x_aes_ctr_init_key aes_init_key
 
 # define s390x_aes_ctr_cipher aes_ctr_cipher
 static int s390x_aes_ctr_cipher(EVP_CIPHER_CTX *ctx, unsigned char *out,
@@ -1178,7 +1407,7 @@ static int s390x_aes_gcm_aad(S390X_AES_GCM_CTX *ctx, const unsigned char *aad,
 
     rem = len &amp; 0xf;
 
-    len &amp;= ~0xf;
+    len &amp;= ~(size_t)0xf;
     if (len) {
         s390x_kma(aad, len, NULL, 0, NULL, ctx-&gt;fc, &amp;ctx-&gt;kma.param);
         aad += len;
@@ -1250,7 +1479,7 @@ static int s390x_aes_gcm(S390X_AES_GCM_CTX *ctx, const unsigned char *in,
 
     rem = len &amp; 0xf;
 
-    len &amp;= ~0xf;
+    len &amp;= ~(size_t)0xf;
     if (len) {
         s390x_kma(ctx-&gt;ares, ctx-&gt;areslen, in, len, out,
                   ctx-&gt;fc | S390X_KMA_LAAD, &amp;ctx-&gt;kma.param);
@@ -1505,8 +1734,7 @@ static int s390x_aes_gcm_init_key(EVP_CIPHER_CTX *ctx,
         keylen = EVP_CIPHER_CTX_key_length(ctx);
         memcpy(&amp;gctx-&gt;kma.param.k, key, keylen);
 
-        /* Convert key size to function code. */
-        gctx-&gt;fc = S390X_AES_128 + (((keylen &lt;&lt; 3) - 128) &gt;&gt; 6);
+        gctx-&gt;fc = S390X_AES_FC(keylen);
         if (!enc)
             gctx-&gt;fc |= S390X_DECRYPT;
 
@@ -1736,7 +1964,7 @@ static void s390x_aes_ccm_aad(S390X_AES_CCM_CTX *ctx, const unsigned char *aad,
     ctx-&gt;aes.ccm.blocks += 2;
 
     rem = alen &amp; 0xf;
-    alen &amp;= ~0xf;
+    alen &amp;= ~(size_t)0xf;
     if (alen) {
         s390x_kmac(aad, alen, ctx-&gt;aes.ccm.fc, &amp;ctx-&gt;aes.ccm.kmac_param);
         ctx-&gt;aes.ccm.blocks += alen &gt;&gt; 4;
@@ -1798,7 +2026,7 @@ static int s390x_aes_ccm(S390X_AES_CCM_CTX *ctx, const unsigned char *in,
 
     num = 0;
     rem = len &amp; 0xf;
-    len &amp;= ~0xf;
+    len &amp;= ~(size_t)0xf;
 
     if (enc) {
         /* mac-then-encrypt */
@@ -1916,8 +2144,7 @@ static int s390x_aes_ccm_init_key(EVP_CIPHER_CTX *ctx,
 
     if (key != NULL) {
         keylen = EVP_CIPHER_CTX_key_length(ctx);
-        /* Convert key size to function code. */
-        cctx-&gt;aes.ccm.fc = S390X_AES_128 + (((keylen &lt;&lt; 3) - 128) &gt;&gt; 6);
+        cctx-&gt;aes.ccm.fc = S390X_AES_FC(keylen);
         memcpy(cctx-&gt;aes.ccm.kmac_param.k, key, keylen);
 
         /* Store encoded m and l. */
@@ -2168,10 +2395,10 @@ static const EVP_CIPHER s390x_aes_##keylen##_##mode = {			\
     keylen / 8,								\
     ivlen,								\
     flags | EVP_CIPH_##MODE##_MODE,					\
-    s390x_aes_init_key,							\
+    s390x_aes_##mode##_init_key,					\
     s390x_aes_##mode##_cipher,						\
     NULL,								\
-    sizeof(EVP_AES_KEY),						\
+    sizeof(S390X_AES_##MODE##_CTX),					\
     NULL,								\
     NULL,								\
     NULL,								\
@@ -2187,7 +2414,10 @@ static const EVP_CIPHER aes_##keylen##_##mode = {			\
     aes_##mode##_cipher,						\
     NULL,								\
     sizeof(EVP_AES_KEY),						\
-    NULL,NULL,NULL,NULL							\
+    NULL,								\
+    NULL,								\
+    NULL,								\
+    NULL								\
 };									\
 const EVP_CIPHER *EVP_aes_##keylen##_##mode(void)			\
 {									\
diff --git a/crypto/s390x_arch.h b/crypto/s390x_arch.h
index 5744318..5042154 100644
--- a/crypto/s390x_arch.h
+++ b/crypto/s390x_arch.h
@@ -16,6 +16,10 @@ void s390x_km(const unsigned char *in, size_t len, unsigned char *out,
               unsigned int fc, void *param);
 void s390x_kmac(const unsigned char *in, size_t len, unsigned int fc,
                 void *param);
+void s390x_kmo(const unsigned char *in, size_t len, unsigned char *out,
+               unsigned int fc, void *param);
+void s390x_kmf(const unsigned char *in, size_t len, unsigned char *out,
+               unsigned int fc, void *param);
 void s390x_kma(const unsigned char *aad, size_t alen, const unsigned char *in,
                size_t len, unsigned char *out, unsigned int fc, void *param);
 
diff --git a/crypto/s390xcpuid.pl b/crypto/s390xcpuid.pl
index b0ed9e0..e7afb8d 100755
--- a/crypto/s390xcpuid.pl
+++ b/crypto/s390xcpuid.pl
@@ -305,6 +305,48 @@ ___
 }
 
 ################
+# void s390x_kmo(const unsigned char *in, size_t len, unsigned char *out,
+#                unsigned int fc, void *param)
+{
+my ($in,$len,$out,$fc,$param) = map(&quot;%r$_&quot;,(2..6));
+$code.=&lt;&lt;___;
+.globl	s390x_kmo
+.type	s390x_kmo,\@function
+.align	16
+s390x_kmo:
+	lr	%r0,$fc
+	l${g}r	%r1,$param
+
+	.long	0xb92b0042	# kmo $out,$in
+	brc	1,.-4		# pay attention to &quot;partial completion&quot;
+
+	br	$ra
+.size	s390x_kmo,.-s390x_kmo
+___
+}
+
+################
+# void s390x_kmf(const unsigned char *in, size_t len, unsigned char *out,
+#                unsigned int fc, void *param)
+{
+my ($in,$len,$out,$fc,$param) = map(&quot;%r$_&quot;,(2..6));
+$code.=&lt;&lt;___;
+.globl	s390x_kmf
+.type	s390x_kmf,\@function
+.align	16
+s390x_kmf:
+	lr	%r0,$fc
+	l${g}r	%r1,$param
+
+	.long	0xb92a0042	# kmf $out,$in
+	brc	1,.-4		# pay attention to &quot;partial completion&quot;
+
+	br	$ra
+.size	s390x_kmf,.-s390x_kmf
+___
+}
+
+################
 # void s390x_kma(const unsigned char *aad, size_t alen,
 #                const unsigned char *in, size_t len,
 #                unsigned char *out, unsigned int fc, void *param)
</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="018804.html">[openssl-commits] [openssl]  master update
</A></li>
	<LI>Next message: <A HREF="018807.html">[openssl-commits] [openssl]  master update
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#18806">[ date ]</a>
              <a href="thread.html#18806">[ thread ]</a>
              <a href="subject.html#18806">[ subject ]</a>
              <a href="author.html#18806">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="../../../mailman/listinfo/openssl-commits.html">More information about the openssl-commits
mailing list</a><br>
</body></html>
