<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [openssl]  master update
   </TITLE>
   <LINK REL="Index" HREF="https://mta.openssl.org/pipermail/openssl-commits/2021-March/index.html" >
   <LINK REL="made" HREF="mailto:openssl-commits%40openssl.org?Subject=Re%3A%20%5Bopenssl%5D%20%20master%20update&In-Reply-To=%3C1617213229.204848.15232.nullmailer%40dev.openssl.org%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="033706.html">
   <LINK REL="Next"  HREF="033708.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[openssl]  master update</H1>
    <B>dev at ddvo.net</B> 
    <A HREF="mailto:openssl-commits%40openssl.org?Subject=Re%3A%20%5Bopenssl%5D%20%20master%20update&In-Reply-To=%3C1617213229.204848.15232.nullmailer%40dev.openssl.org%3E"
       TITLE="[openssl]  master update">dev at ddvo.net
       </A><BR>
    <I>Wed Mar 31 17:53:49 UTC 2021</I>
    <P><UL>
        <LI>Previous message: <A HREF="033706.html">[openssl]  master update
</A></li>
        <LI>Next message: <A HREF="033708.html">[openssl]  master update
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#33707">[ date ]</a>
              <a href="thread.html#33707">[ thread ]</a>
              <a href="subject.html#33707">[ subject ]</a>
              <a href="author.html#33707">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>The branch master has been updated
       via  9e6f30e683fd0f243cf15d2bac2cdef2bcbbac12 (commit)
       via  1e6174b1b58d3545b2ef34fd7262dadd2149ec15 (commit)
       via  231837911980ff55a661e2509642442435082c90 (commit)
       via  f7c4d8622840b92a9f6cdb00d937d063a4efae9c (commit)
       via  e1428c62a1588def5af25678583f1a0166adf924 (commit)
      from  534725fd4389782d693cff061f4d31b786058ab1 (commit)


- Log -----------------------------------------------------------------
commit 9e6f30e683fd0f243cf15d2bac2cdef2bcbbac12
Author: Dr. David von Oheimb &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">David.von.Oheimb at siemens.com</A>&gt;
Date:   Mon Mar 29 19:39:57 2021 +0200

    CHANGES.md: reflect OSSL_HTTP_REQ_CTX_i2d renamed to OSSL_HTTP_REQ_CTX_set1_req
    
    Reviewed-by: Tomas Mraz &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">tomas at openssl.org</A>&gt;
    (Merged from <A HREF="https://github.com/openssl/openssl/pull/14630">https://github.com/openssl/openssl/pull/14630</A>)

commit 1e6174b1b58d3545b2ef34fd7262dadd2149ec15
Author: Dr. David von Oheimb &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">David.von.Oheimb at siemens.com</A>&gt;
Date:   Mon Mar 8 13:47:33 2021 +0100

    OSSL_HTTP_REQ_CTX_transfer(): improve distinction of send error vs. receive error
    
    Reviewed-by: Tomas Mraz &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">tomas at openssl.org</A>&gt;
    (Merged from <A HREF="https://github.com/openssl/openssl/pull/14630">https://github.com/openssl/openssl/pull/14630</A>)

commit 231837911980ff55a661e2509642442435082c90
Author: Dr. David von Oheimb &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">David.von.Oheimb at siemens.com</A>&gt;
Date:   Mon Mar 8 09:59:35 2021 +0100

    OSSL_parse_url(): Improve handling of IPv6 addresses
    
    Reviewed-by: Tomas Mraz &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">tomas at openssl.org</A>&gt;
    (Merged from <A HREF="https://github.com/openssl/openssl/pull/14630">https://github.com/openssl/openssl/pull/14630</A>)

commit f7c4d8622840b92a9f6cdb00d937d063a4efae9c
Author: Dr. David von Oheimb &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">David.von.Oheimb at siemens.com</A>&gt;
Date:   Mon Mar 8 09:26:28 2021 +0100

    80-test_cmp_http.t: Add diagnostic info on starting/stopping mock server
    
    Reviewed-by: Tomas Mraz &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">tomas at openssl.org</A>&gt;
    (Merged from <A HREF="https://github.com/openssl/openssl/pull/14630">https://github.com/openssl/openssl/pull/14630</A>)

commit e1428c62a1588def5af25678583f1a0166adf924
Author: Dr. David von Oheimb &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">David.von.Oheimb at siemens.com</A>&gt;
Date:   Mon Mar 8 09:25:54 2021 +0100

    http_client.c: Prevent spurious error queue entry on NULL mem argument
    
    Reviewed-by: Tomas Mraz &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">tomas at openssl.org</A>&gt;
    (Merged from <A HREF="https://github.com/openssl/openssl/pull/14630">https://github.com/openssl/openssl/pull/14630</A>)

-----------------------------------------------------------------------

Summary of changes:
 CHANGES.md                      | 2 +-
 crypto/http/http_client.c       | 7 ++-----
 crypto/http/http_lib.c          | 5 ++---
 test/http_test.c                | 2 +-
 test/recipes/80-test_cmp_http.t | 7 ++++++-
 5 files changed, 12 insertions(+), 11 deletions(-)

diff --git a/CHANGES.md b/CHANGES.md
index c57b9ad4a5..10c471ab1b 100644
--- a/CHANGES.md
+++ b/CHANGES.md
@@ -249,7 +249,7 @@ OpenSSL 3.0
    type is OSSL_HTTP_REQ_CTX, and the deprecated functions are replaced
    with OSSL_HTTP_REQ_CTX_new(), OSSL_HTTP_REQ_CTX_free(),
    OSSL_HTTP_REQ_CTX_set_request_line(), OSSL_HTTP_REQ_CTX_add1_header(),
-   OSSL_HTTP_REQ_CTX_i2d(), OSSL_HTTP_REQ_CTX_nbio(),
+   OSSL_HTTP_REQ_CTX_set1_req(), OSSL_HTTP_REQ_CTX_nbio(),
    OSSL_HTTP_REQ_CTX_sendreq_d2i(), OSSL_HTTP_REQ_CTX_get0_mem_bio() and
    OSSL_HTTP_REQ_CTX_set_max_response_length().
 
diff --git a/crypto/http/http_client.c b/crypto/http/http_client.c
index 8e4f8e8c83..9c2b593a2d 100644
--- a/crypto/http/http_client.c
+++ b/crypto/http/http_client.c
@@ -734,20 +734,18 @@ static BIO *HTTP_new_bio(const char *server /* optionally includes &quot;:port&quot; */,
 static ASN1_VALUE *BIO_mem_d2i(BIO *mem, const ASN1_ITEM *it)
 {
     const unsigned char *p;
-    long len = BIO_get_mem_data(mem, &amp;p);
     ASN1_VALUE *resp;
 
     if (mem == NULL)
         return NULL;
 
-    if ((resp = ASN1_item_d2i(NULL, &amp;p, len, it)) == NULL)
+    if ((resp = ASN1_item_d2i(NULL, &amp;p, BIO_get_mem_data(mem, &amp;p), it)) == NULL)
         ERR_raise(ERR_LIB_HTTP, HTTP_R_RESPONSE_PARSE_ERROR);
     return resp;
 }
 
 static BIO *ossl_http_req_ctx_transfer(OSSL_HTTP_REQ_CTX *rctx)
 {
-    int sending = 1;
     int rv;
 
     if (rctx == NULL) {
@@ -760,7 +758,6 @@ static BIO *ossl_http_req_ctx_transfer(OSSL_HTTP_REQ_CTX *rctx)
         if (rv != -1)
             break;
         /* BIO_should_retry was true */
-        sending = 0;
         /* will not actually wait if rctx-&gt;max_time == 0 */
         if (BIO_wait(rctx-&gt;rbio, rctx-&gt;max_time, 100 /* milliseconds */) &lt;= 0)
             return NULL;
@@ -768,7 +765,7 @@ static BIO *ossl_http_req_ctx_transfer(OSSL_HTTP_REQ_CTX *rctx)
 
     if (rv == 0) {
         if (rctx-&gt;redirection_url == NULL) { /* an error occurred */
-            if (sending &amp;&amp; (rctx-&gt;state &amp; OHS_NOREAD) != 0)
+            if (rctx-&gt;len_to_send &gt; 0)
                 ERR_raise(ERR_LIB_HTTP, HTTP_R_ERROR_SENDING);
             else
                 ERR_raise(ERR_LIB_HTTP, HTTP_R_ERROR_RECEIVING);
diff --git a/crypto/http/http_lib.c b/crypto/http/http_lib.c
index 3bf642a4f4..f0fc770f22 100644
--- a/crypto/http/http_lib.c
+++ b/crypto/http/http_lib.c
@@ -87,11 +87,10 @@ int OSSL_parse_url(const char *url, char **pscheme, char **puser, char **phost,
     /* parse host name/address as far as needed here */
     if (host[0] == '[') {
         /* ipv6 literal, which may include ':' */
-        host++;
-        host_end = strchr(host, ']');
+        host_end = strchr(host + 1, ']');
         if (host_end == NULL)
             goto parse_err;
-        p = host_end + 1;
+        p = ++host_end;
     } else {
         /* look for start of optional port, path, query, or fragment */
         host_end = strchr(host, ':');
diff --git a/test/http_test.c b/test/http_test.c
index e59ef63833..0a3389c15f 100644
--- a/test/http_test.c
+++ b/test/http_test.c
@@ -204,7 +204,7 @@ static int test_http_url_ipv4(void)
 
 static int test_http_url_ipv6(void)
 {
-    return test_http_url_ok(&quot;<A HREF="http://[FF01::101">http://[FF01::101</A>]:6&quot;, 0, &quot;FF01::101&quot;, &quot;6&quot;, &quot;/&quot;);
+    return test_http_url_ok(&quot;<A HREF="http://[FF01::101">http://[FF01::101</A>]:6&quot;, 0, &quot;[FF01::101]&quot;, &quot;6&quot;, &quot;/&quot;);
 }
 
 static int test_http_url_invalid(const char *url)
diff --git a/test/recipes/80-test_cmp_http.t b/test/recipes/80-test_cmp_http.t
index 4315b1c439..80cb6a4122 100644
--- a/test/recipes/80-test_cmp_http.t
+++ b/test/recipes/80-test_cmp_http.t
@@ -273,12 +273,17 @@ sub start_mock_server {
     my $cmd = &quot;LD_LIBRARY_PATH=$dir DYLD_LIBRARY_PATH=$dir &quot; .
         bldtop_dir($app) . &quot; -config server.cnf $args&quot;;
     my $pid = mock_server_pid();
-    return $pid if $pid; # already running
+    if ($pid) {
+        print &quot;Mock server already running with pid=$pid\n&quot;;
+        return $pid;
+    }
+    print &quot;Launching mock server: $cmd\n&quot;;
     return system(&quot;$cmd &amp;&quot;) == 0 # start in background, check for success
         ? (sleep 1, mock_server_pid()) : 0;
 }
 
 sub stop_mock_server {
     my $pid = $_[0];
+    print &quot;Killing mock server with pid=$pid\n&quot;;
     system(&quot;kill $pid&quot;) if $pid;
 }
</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="033706.html">[openssl]  master update
</A></li>
	<LI>Next message: <A HREF="033708.html">[openssl]  master update
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#33707">[ date ]</a>
              <a href="thread.html#33707">[ thread ]</a>
              <a href="subject.html#33707">[ subject ]</a>
              <a href="author.html#33707">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="../../../mailman/listinfo/openssl-commits.html">More information about the openssl-commits
mailing list</a><br>
</body></html>
