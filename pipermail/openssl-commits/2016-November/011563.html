<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [openssl-commits] [openssl]  OpenSSL_1_1_0-stable update
   </TITLE>
   <LINK REL="Index" HREF="https://mta.openssl.org/pipermail/openssl-commits/2016-November/index.html" >
   <LINK REL="made" HREF="mailto:openssl-commits%40openssl.org?Subject=Re%3A%20%5Bopenssl-commits%5D%20%5Bopenssl%5D%20%20OpenSSL_1_1_0-stable%20update&In-Reply-To=%3C1479331922.665716.19122.nullmailer%40dev.openssl.org%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="011559.html">
   <LINK REL="Next"  HREF="011567.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[openssl-commits] [openssl]  OpenSSL_1_1_0-stable update</H1>
    <B>Rich Salz</B> 
    <A HREF="mailto:openssl-commits%40openssl.org?Subject=Re%3A%20%5Bopenssl-commits%5D%20%5Bopenssl%5D%20%20OpenSSL_1_1_0-stable%20update&In-Reply-To=%3C1479331922.665716.19122.nullmailer%40dev.openssl.org%3E"
       TITLE="[openssl-commits] [openssl]  OpenSSL_1_1_0-stable update">rsalz at openssl.org
       </A><BR>
    <I>Wed Nov 16 21:32:02 UTC 2016</I>
    <P><UL>
        <LI>Previous message: <A HREF="011559.html">[openssl-commits] [openssl]  OpenSSL_1_1_0-stable update
</A></li>
        <LI>Next message: <A HREF="011567.html">[openssl-commits] [openssl]  OpenSSL_1_1_0-stable update
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#11563">[ date ]</a>
              <a href="thread.html#11563">[ thread ]</a>
              <a href="subject.html#11563">[ subject ]</a>
              <a href="author.html#11563">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>The branch OpenSSL_1_1_0-stable has been updated
       via  56518d82372048825f068de32dfca77c32be1bc0 (commit)
       via  0140f9d98b31142c81dc1cc35aa153682c1a313a (commit)
       via  6ae6ff57f2667614c0bd6310f9a2856b3f5defd2 (commit)
       via  4caa44d7ea001708069d8ce638e11e7dfd975f85 (commit)
       via  bb2b6b6cb7e697a69a1e5cd371a96721a7b89633 (commit)
       via  189d4e0906551429dd177af658b5ee37aac2dad3 (commit)
      from  760c969584bb52f1c88f11563c59a2c5efad66d7 (commit)


- Log -----------------------------------------------------------------
commit 56518d82372048825f068de32dfca77c32be1bc0
Author: Rob Percival &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">robpercival at google.com</A>&gt;
Date:   Wed Oct 19 15:42:05 2016 +0100

    Move SCT_LIST_free definition into a more logical place
    
    This reflects its position in include/openssl/ct.h.
    
    Reviewed-by: Tim Hudson &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">tjh at openssl.org</A>&gt;
    Reviewed-by: Rich Salz &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">rsalz at openssl.org</A>&gt;
    (Merged from <A HREF="https://github.com/openssl/openssl/pull/1548">https://github.com/openssl/openssl/pull/1548</A>)
    (cherry picked from commit e1940e9f7a73bf3a560fbe3550a9b69a612118ec)

commit 0140f9d98b31142c81dc1cc35aa153682c1a313a
Author: Rob Percival &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">robpercival at google.com</A>&gt;
Date:   Wed Oct 19 15:40:46 2016 +0100

    Make sure things get deleted when test setup fails in ct_test.c
    
    Reviewed-by: Tim Hudson &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">tjh at openssl.org</A>&gt;
    Reviewed-by: Rich Salz &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">rsalz at openssl.org</A>&gt;
    (Merged from <A HREF="https://github.com/openssl/openssl/pull/1548">https://github.com/openssl/openssl/pull/1548</A>)
    (cherry picked from commit 765731a88899771989a53c72259cacd1c658bb3f)

commit 6ae6ff57f2667614c0bd6310f9a2856b3f5defd2
Author: Rob Percival &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">robpercival at google.com</A>&gt;
Date:   Wed Oct 19 15:39:13 2016 +0100

    Use valid signature in test_decode_tls_sct()
    
    Reviewed-by: Tim Hudson &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">tjh at openssl.org</A>&gt;
    Reviewed-by: Rich Salz &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">rsalz at openssl.org</A>&gt;
    (Merged from <A HREF="https://github.com/openssl/openssl/pull/1548">https://github.com/openssl/openssl/pull/1548</A>)
    (cherry picked from commit e2635c49f35c615820b1c6d92d180e31e28adeb2)

commit 4caa44d7ea001708069d8ce638e11e7dfd975f85
Author: Rob Percival &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">robpercival at google.com</A>&gt;
Date:   Wed Oct 19 15:38:20 2016 +0100

    Pass a temporary pointer to o2i_SCT_signature from SCT_new_from_base64
    
    Otherwise, |dec| gets moved past the end of the signature by
    o2i_SCT_signature and then can't be correctly freed afterwards.
    
    Reviewed-by: Tim Hudson &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">tjh at openssl.org</A>&gt;
    Reviewed-by: Rich Salz &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">rsalz at openssl.org</A>&gt;
    (Merged from <A HREF="https://github.com/openssl/openssl/pull/1548">https://github.com/openssl/openssl/pull/1548</A>)
    (cherry picked from commit 73ccf3ca01085d143aecb7fcfb0aac18caa678d2)

commit bb2b6b6cb7e697a69a1e5cd371a96721a7b89633
Author: Rob Percival &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">robpercival at google.com</A>&gt;
Date:   Wed Oct 19 15:11:04 2016 +0100

    Subtract padding from outlen in ct_base64_decode
    
    Reviewed-by: Tim Hudson &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">tjh at openssl.org</A>&gt;
    Reviewed-by: Rich Salz &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">rsalz at openssl.org</A>&gt;
    (Merged from <A HREF="https://github.com/openssl/openssl/pull/1548">https://github.com/openssl/openssl/pull/1548</A>)
    (cherry picked from commit 70a06fc1a8b098e9934f837896159bfc6caf0228)

commit 189d4e0906551429dd177af658b5ee37aac2dad3
Author: Rob Percival &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">robpercival at google.com</A>&gt;
Date:   Wed Sep 7 17:47:56 2016 +0100

    Construct SCT from base64 in ct_test
    
    This gives better code coverage and is more representative of how a
    user would likely construct an SCT (using the base64 returned by a CT log).
    
    Reviewed-by: Tim Hudson &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">tjh at openssl.org</A>&gt;
    Reviewed-by: Rich Salz &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">rsalz at openssl.org</A>&gt;
    (Merged from <A HREF="https://github.com/openssl/openssl/pull/1548">https://github.com/openssl/openssl/pull/1548</A>)
    (cherry picked from commit f7a39a5a3f7f91e0d1ba0030323eef26bc8ccddf)

-----------------------------------------------------------------------

Summary of changes:
 crypto/ct/ct_b64.c | 10 ++++++++-
 crypto/ct/ct_oct.c |  5 -----
 crypto/ct/ct_sct.c |  5 +++++
 test/ct_test.c     | 59 ++++++++++++++++++++----------------------------------
 4 files changed, 36 insertions(+), 43 deletions(-)

diff --git a/crypto/ct/ct_b64.c b/crypto/ct/ct_b64.c
index d13d8f2..f0bf3af 100644
--- a/crypto/ct/ct_b64.c
+++ b/crypto/ct/ct_b64.c
@@ -45,6 +45,11 @@ static int ct_base64_decode(const char *in, unsigned char **out)
         goto err;
     }
 
+    /* Subtract padding bytes from |outlen| */
+    while (in[--inlen] == '=') {
+        --outlen;
+    }
+
     *out = outbuf;
     return outlen;
 err:
@@ -59,6 +64,7 @@ SCT *SCT_new_from_base64(unsigned char version, const char *logid_base64,
 {
     SCT *sct = SCT_new();
     unsigned char *dec = NULL;
+    const unsigned char* p = NULL;
     int declen;
 
     if (sct == NULL) {
@@ -97,7 +103,9 @@ SCT *SCT_new_from_base64(unsigned char version, const char *logid_base64,
         CTerr(CT_F_SCT_NEW_FROM_BASE64, X509_R_BASE64_DECODE_ERROR);
         goto err;
     }
-    if (o2i_SCT_signature(sct, (const unsigned char **)&amp;dec, declen) &lt;= 0)
+
+    p = dec;
+    if (o2i_SCT_signature(sct, &amp;p, declen) &lt;= 0)
         goto err;
     OPENSSL_free(dec);
     dec = NULL;
diff --git a/crypto/ct/ct_oct.c b/crypto/ct/ct_oct.c
index cacc3bd..d3edd39 100644
--- a/crypto/ct/ct_oct.c
+++ b/crypto/ct/ct_oct.c
@@ -254,11 +254,6 @@ err:
     return -1;
 }
 
-void SCT_LIST_free(STACK_OF(SCT) *a)
-{
-    sk_SCT_pop_free(a, SCT_free);
-}
-
 STACK_OF(SCT) *o2i_SCT_LIST(STACK_OF(SCT) **a, const unsigned char **pp,
                             size_t len)
 {
diff --git a/crypto/ct/ct_sct.c b/crypto/ct/ct_sct.c
index 92cee8d..cd2cf60 100644
--- a/crypto/ct/ct_sct.c
+++ b/crypto/ct/ct_sct.c
@@ -45,6 +45,11 @@ void SCT_free(SCT *sct)
     OPENSSL_free(sct);
 }
 
+void SCT_LIST_free(STACK_OF(SCT) *a)
+{
+    sk_SCT_pop_free(a, SCT_free);
+}
+
 int SCT_set_version(SCT *sct, sct_version_t version)
 {
     if (version != SCT_VERSION_V1) {
diff --git a/test/ct_test.c b/test/ct_test.c
index 8ab2f7d..ea90923 100644
--- a/test/ct_test.c
+++ b/test/ct_test.c
@@ -61,30 +61,28 @@ static CT_TEST_FIXTURE set_up(const char *const test_case_name)
 {
     CT_TEST_FIXTURE fixture;
     int setup_ok = 1;
-    CTLOG_STORE *ctlog_store;
 
     memset(&amp;fixture, 0, sizeof(fixture));
 
-    ctlog_store = CTLOG_STORE_new();
+    fixture.test_case_name = test_case_name;
+    fixture.epoch_time_in_ms = 1473269626000; /* Sep 7 17:33:46 2016 GMT */
+    fixture.ctlog_store = CTLOG_STORE_new();
 
-    if (ctlog_store == NULL) {
+    if (fixture.ctlog_store == NULL) {
         setup_ok = 0;
         fprintf(stderr, &quot;Failed to create a new CT log store\n&quot;);
         goto end;
     }
 
-    if (CTLOG_STORE_load_default_file(ctlog_store) != 1) {
+    if (CTLOG_STORE_load_default_file(fixture.ctlog_store) != 1) {
         setup_ok = 0;
         fprintf(stderr, &quot;Failed to load CT log list\n&quot;);
         goto end;
     }
 
-    fixture.test_case_name = test_case_name;
-    fixture.epoch_time_in_ms = 1473269626000; /* Sep 7 17:33:46 2016 GMT */
-    fixture.ctlog_store = ctlog_store;
-
 end:
     if (!setup_ok) {
+        CTLOG_STORE_free(fixture.ctlog_store);
         exit(EXIT_FAILURE);
     }
     return fixture;
@@ -510,40 +508,27 @@ static int test_decode_tls_sct()
 
 static int test_encode_tls_sct()
 {
-    const unsigned char log_id[] = &quot;\xDF\x1C\x2E\xC1\x15\x00\x94\x52\x47\xA9&quot;
-            &quot;\x61\x68\x32\x5D\xDC\x5C\x79\x59\xE8\xF7\xC6\xD3\x88\xFC\x00\x2E&quot;
-            &quot;\x0B\xBD\x3F\x74\xD7\x64&quot;;
-
-    const unsigned char signature[] = &quot;\x45\x02\x20\x48\x2F\x67\x51\xAF\x35&quot;
-            &quot;\xDB\xA6\x54\x36\xBE\x1F\xD6\x64\x0F\x3D\xBF\x9A\x41\x42\x94\x95&quot;
-            &quot;\x92\x45\x30\x28\x8F\xA3\xE5\xE2\x3E\x06\x02\x21\x00\xE4\xED\xC0&quot;
-            &quot;\xDB\x3A\xC5\x72\xB1\xE2\xF5\xE8\xAB\x6A\x68\x06\x53\x98\x7D\xCF&quot;
-            &quot;\x41\x02\x7D\xFE\xFF\xA1\x05\x51\x9D\x89\xED\xBF\x08&quot;;
+    const char log_id[] = &quot;3xwuwRUAlFJHqWFoMl3cXHlZ6PfG04j8AC4LvT9012Q=&quot;;
+    const uint64_t timestamp = 1;
+    const char extensions[] = &quot;&quot;;
+    const char signature[] = &quot;BAMARzBAMiBIL2dRrzXbplQ2vh/WZA89v5pBQpSVkkUwKI+j5&quot;
+            &quot;eI+BgIhAOTtwNs6xXKx4vXoq2poBlOYfc9BAn3+/6EFUZ2J7b8I&quot;;
+    SCT *sct = NULL;
 
     SETUP_CT_TEST_FIXTURE();
 
-    STACK_OF(SCT) *sct_list = sk_SCT_new_null();
-    SCT *sct = SCT_new();
-    if (!SCT_set_version(sct, SCT_VERSION_V1)) {
-        fprintf(stderr, &quot;Failed to set SCT version\n&quot;);
-        return 1;
-    }
-    if (!SCT_set1_log_id(sct, log_id, 32)) {
-        fprintf(stderr, &quot;Failed to set SCT log ID\n&quot;);
-        return 1;
-    }
-    SCT_set_timestamp(sct, 1);
-    if (!SCT_set_signature_nid(sct, NID_ecdsa_with_SHA256)) {
-        fprintf(stderr, &quot;Failed to set SCT signature NID\n&quot;);
-        return 1;
-    }
-    if (!SCT_set1_signature(sct, signature, 71)) {
-        fprintf(stderr, &quot;Failed to set SCT signature\n&quot;);
-        return 1;
+    fixture.sct_list = sk_SCT_new_null();
+    sct = SCT_new_from_base64(SCT_VERSION_V1, log_id,
+                              CT_LOG_ENTRY_TYPE_X509, timestamp,
+                              extensions, signature);
+
+    if (sct == NULL) {
+        tear_down(fixture);
+        fprintf(stderr, &quot;Failed to create SCT from base64-encoded test data\n&quot;);
+        return 0;
     }
-    sk_SCT_push(sct_list, sct);
 
-    fixture.sct_list = sct_list;
+    sk_SCT_push(fixture.sct_list, sct);
     fixture.sct_dir = ct_dir;
     fixture.sct_text_file = &quot;tls1.sct&quot;;
     EXECUTE_CT_TEST();
</PRE>




































<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="011559.html">[openssl-commits] [openssl]  OpenSSL_1_1_0-stable update
</A></li>
	<LI>Next message: <A HREF="011567.html">[openssl-commits] [openssl]  OpenSSL_1_1_0-stable update
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#11563">[ date ]</a>
              <a href="thread.html#11563">[ thread ]</a>
              <a href="subject.html#11563">[ subject ]</a>
              <a href="author.html#11563">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="../../../mailman/listinfo/openssl-commits.html">More information about the openssl-commits
mailing list</a><br>
</body></html>
