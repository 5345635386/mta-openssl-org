<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [openssl-commits] [openssl]  master update
   </TITLE>
   <LINK REL="Index" HREF="https://mta.openssl.org/pipermail/openssl-commits/2017-April/index.html" >
   <LINK REL="made" HREF="mailto:openssl-commits%40openssl.org?Subject=Re%3A%20%5Bopenssl-commits%5D%20%5Bopenssl%5D%20%20master%20update&In-Reply-To=%3C1493213724.124361.18225.nullmailer%40dev.openssl.org%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="014352.html">
   <LINK REL="Next"  HREF="014356.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[openssl-commits] [openssl]  master update</H1>
    <B>Matt Caswell</B> 
    <A HREF="mailto:openssl-commits%40openssl.org?Subject=Re%3A%20%5Bopenssl-commits%5D%20%5Bopenssl%5D%20%20master%20update&In-Reply-To=%3C1493213724.124361.18225.nullmailer%40dev.openssl.org%3E"
       TITLE="[openssl-commits] [openssl]  master update">matt at openssl.org
       </A><BR>
    <I>Wed Apr 26 13:35:24 UTC 2017</I>
    <P><UL>
        <LI>Previous message: <A HREF="014352.html">[openssl-commits] [openssl]  master update
</A></li>
        <LI>Next message: <A HREF="014356.html">[openssl-commits] [openssl]  master update
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#14353">[ date ]</a>
              <a href="thread.html#14353">[ thread ]</a>
              <a href="subject.html#14353">[ subject ]</a>
              <a href="author.html#14353">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>The branch master has been updated
       via  975922fd0c6a3089a49b9bcdcd77c672d97e36b2 (commit)
       via  38a7315060ec4ca49799b2a7ea83e8678e3acd20 (commit)
       via  aafec89c63efeade20f1bdc8023d2bb611e419b8 (commit)
      from  bf846a6d47a0f94b9771ead5ce52786045e58f49 (commit)


- Log -----------------------------------------------------------------
commit 975922fd0c6a3089a49b9bcdcd77c672d97e36b2
Author: Matt Caswell &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">matt at openssl.org</A>&gt;
Date:   Wed Apr 26 11:43:05 2017 +0100

    Add tests for version/ciphersuite sanity checks
    
    The previous commits added sanity checks for where the max enabled protocol
    version does not have any configured ciphersuites. We should check that we
    fail in those circumstances.
    
    Reviewed-by: Richard Levitte &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">levitte at openssl.org</A>&gt;
    (Merged from <A HREF="https://github.com/openssl/openssl/pull/3316">https://github.com/openssl/openssl/pull/3316</A>)

commit 38a7315060ec4ca49799b2a7ea83e8678e3acd20
Author: Matt Caswell &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">matt at openssl.org</A>&gt;
Date:   Wed Apr 26 11:28:20 2017 +0100

    Add a ciphersuite config sanity check for servers
    
    Ensure that there are ciphersuites enabled for the maximum supported
    version we will accept in a ClientHello.
    
    Reviewed-by: Richard Levitte &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">levitte at openssl.org</A>&gt;
    (Merged from <A HREF="https://github.com/openssl/openssl/pull/3316">https://github.com/openssl/openssl/pull/3316</A>)

commit aafec89c63efeade20f1bdc8023d2bb611e419b8
Author: Matt Caswell &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">matt at openssl.org</A>&gt;
Date:   Wed Apr 26 10:38:32 2017 +0100

    Add a ciphersuite config sanity check for clients
    
    Ensure that there are ciphersuites enabled for the maximum supported
    version we are claiming in the ClientHello.
    
    Reviewed-by: Richard Levitte &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">levitte at openssl.org</A>&gt;
    (Merged from <A HREF="https://github.com/openssl/openssl/pull/3316">https://github.com/openssl/openssl/pull/3316</A>)

-----------------------------------------------------------------------

Summary of changes:
 ssl/ssl_locl.h                             |   3 +-
 ssl/statem/extensions.c                    |   2 +-
 ssl/statem/extensions_clnt.c               |   2 +-
 ssl/statem/statem_clnt.c                   |  22 ++++-
 ssl/statem/statem_lib.c                    |  40 +++++++-
 ssl/t1_lib.c                               |   2 +-
 test/recipes/70-test_sslmessages.t         |   1 +
 test/ssl-tests/14-curves.conf              |  29 ++++++
 test/ssl-tests/14-curves.conf.in           |   5 +-
 test/ssl-tests/17-renegotiate.conf         |   8 +-
 test/ssl-tests/17-renegotiate.conf.in      |   8 +-
 test/ssl-tests/19-mac-then-encrypt.conf    |   2 +-
 test/ssl-tests/19-mac-then-encrypt.conf.in |   2 +-
 test/ssl-tests/20-cert-select.conf         |   3 +
 test/ssl-tests/20-cert-select.conf.in      |   5 +-
 test/ssl-tests/23-srp.conf                 |   4 +
 test/ssl-tests/23-srp.conf.in              | 154 +++++++++++++++--------------
 test/ssl-tests/protocol_version.pm         |  31 ++++++
 18 files changed, 224 insertions(+), 99 deletions(-)

diff --git a/ssl/ssl_locl.h b/ssl/ssl_locl.h
index 8eb6ff5..15065c7 100644
--- a/ssl/ssl_locl.h
+++ b/ssl/ssl_locl.h
@@ -2194,8 +2194,7 @@ __owur int ssl_choose_server_version(SSL *s, CLIENTHELLO_MSG *hello,
                                      DOWNGRADE *dgrd);
 __owur int ssl_choose_client_version(SSL *s, int version, int checkdgrd,
                                      int *al);
-int ssl_get_client_min_max_version(const SSL *s, int *min_version,
-                                   int *max_version);
+int ssl_get_min_max_version(const SSL *s, int *min_version, int *max_version);
 
 __owur long tls1_default_timeout(void);
 __owur int dtls1_do_write(SSL *s, int type);
diff --git a/ssl/statem/extensions.c b/ssl/statem/extensions.c
index 7ec7128..c8ed722 100644
--- a/ssl/statem/extensions.c
+++ b/ssl/statem/extensions.c
@@ -674,7 +674,7 @@ int tls_construct_extensions(SSL *s, WPACKET *pkt, unsigned int context,
     }
 
     if ((context &amp; SSL_EXT_CLIENT_HELLO) != 0) {
-        reason = ssl_get_client_min_max_version(s, &amp;min_version, &amp;max_version);
+        reason = ssl_get_min_max_version(s, &amp;min_version, &amp;max_version);
         if (reason != 0) {
             SSLerr(SSL_F_TLS_CONSTRUCT_EXTENSIONS, reason);
             goto err;
diff --git a/ssl/statem/extensions_clnt.c b/ssl/statem/extensions_clnt.c
index 7d2a4b0..898992d 100644
--- a/ssl/statem/extensions_clnt.c
+++ b/ssl/statem/extensions_clnt.c
@@ -464,7 +464,7 @@ int tls_construct_ctos_supported_versions(SSL *s, WPACKET *pkt,
         return 0;
     }
 
-    reason = ssl_get_client_min_max_version(s, &amp;min_version, &amp;max_version);
+    reason = ssl_get_min_max_version(s, &amp;min_version, &amp;max_version);
     if (reason != 0) {
         SSLerr(SSL_F_TLS_CONSTRUCT_CTOS_SUPPORTED_VERSIONS, reason);
         return 0;
diff --git a/ssl/statem/statem_clnt.c b/ssl/statem/statem_clnt.c
index 7bcd3ac..8c4c839 100644
--- a/ssl/statem/statem_clnt.c
+++ b/ssl/statem/statem_clnt.c
@@ -3496,7 +3496,7 @@ int ssl_do_client_cert_cb(SSL *s, X509 **px509, EVP_PKEY **ppkey)
 int ssl_cipher_list_to_bytes(SSL *s, STACK_OF(SSL_CIPHER) *sk, WPACKET *pkt)
 {
     int i;
-    size_t totlen = 0, len, maxlen;
+    size_t totlen = 0, len, maxlen, maxverok = 0;
     int empty_reneg_info_scsv = !s-&gt;renegotiate;
     /* Set disabled masks for this session */
     ssl_set_client_disabled(s);
@@ -3538,11 +3538,29 @@ int ssl_cipher_list_to_bytes(SSL *s, STACK_OF(SSL_CIPHER) *sk, WPACKET *pkt)
             return 0;
         }
 
+        /* Sanity check that the maximum version we offer has ciphers enabled */
+        if (!maxverok) {
+            if (SSL_IS_DTLS(s)) {
+                if (DTLS_VERSION_GE(c-&gt;max_dtls, s-&gt;s3-&gt;tmp.max_ver)
+                        &amp;&amp; DTLS_VERSION_LE(c-&gt;min_dtls, s-&gt;s3-&gt;tmp.max_ver))
+                    maxverok = 1;
+            } else {
+                if (c-&gt;max_tls &gt;= s-&gt;s3-&gt;tmp.max_ver
+                        &amp;&amp; c-&gt;min_tls &lt;= s-&gt;s3-&gt;tmp.max_ver)
+                    maxverok = 1;
+            }
+        }
+
         totlen += len;
     }
 
-    if (totlen == 0) {
+    if (totlen == 0 || !maxverok) {
         SSLerr(SSL_F_SSL_CIPHER_LIST_TO_BYTES, SSL_R_NO_CIPHERS_AVAILABLE);
+
+        if (!maxverok)
+            ERR_add_error_data(1, &quot;No ciphers enabled for max supported &quot;
+                                  &quot;SSL/TLS version&quot;);
+
         return 0;
     }
 
diff --git a/ssl/statem/statem_lib.c b/ssl/statem/statem_lib.c
index 0180445..36d5534 100644
--- a/ssl/statem/statem_lib.c
+++ b/ssl/statem/statem_lib.c
@@ -78,6 +78,39 @@ int tls_setup_handshake(SSL *s)
         return 0;
 
     if (s-&gt;server) {
+        STACK_OF(SSL_CIPHER) *ciphers = SSL_get_ciphers(s);
+        int i, ver_min, ver_max, ok = 0;
+
+        /*
+         * Sanity check that the maximum version we accept has ciphers
+         * enabled. For clients we do this check during construction of the
+         * ClientHello.
+         */
+        if (ssl_get_min_max_version(s, &amp;ver_min, &amp;ver_max) != 0) {
+            SSLerr(SSL_F_TLS_SETUP_HANDSHAKE, ERR_R_INTERNAL_ERROR);
+            ssl3_send_alert(s, SSL3_AL_FATAL, SSL_AD_INTERNAL_ERROR);
+            return 0;
+        }
+        for (i = 0; i &lt; sk_SSL_CIPHER_num(ciphers); i++) {
+            const SSL_CIPHER *c = sk_SSL_CIPHER_value(ciphers, i);
+
+            if (SSL_IS_DTLS(s)) {
+                if (DTLS_VERSION_GE(ver_max, c-&gt;min_dtls) &amp;&amp;
+                        DTLS_VERSION_LE(ver_max, c-&gt;max_dtls))
+                    ok = 1;
+            } else if (ver_max &gt;= c-&gt;min_tls &amp;&amp; ver_max &lt;= c-&gt;max_tls) {
+                ok = 1;
+            }
+            if (ok)
+                break;
+        }
+        if (!ok) {
+            SSLerr(SSL_F_TLS_SETUP_HANDSHAKE, SSL_R_NO_CIPHERS_AVAILABLE);
+            ERR_add_error_data(1, &quot;No ciphers enabled for max supported &quot;
+                                  &quot;SSL/TLS version&quot;);
+            ssl3_send_alert(s, SSL3_AL_FATAL, SSL_AD_HANDSHAKE_FAILURE);
+            return 0;
+        }
         if (SSL_IS_FIRST_HANDSHAKE(s)) {
             s-&gt;ctx-&gt;stats.sess_accept++;
         } else if (!s-&gt;s3-&gt;send_connection_binding &amp;&amp;
@@ -1781,7 +1814,7 @@ int ssl_choose_client_version(SSL *s, int version, int checkdgrd, int *al)
 }
 
 /*
- * ssl_get_client_min_max_version - get minimum and maximum client version
+ * ssl_get_min_max_version - get minimum and maximum protocol version
  * @s: The SSL connection
  * @min_version: The minimum supported version
  * @max_version: The maximum supported version
@@ -1799,8 +1832,7 @@ int ssl_choose_client_version(SSL *s, int version, int checkdgrd, int *al)
  * Returns 0 on success or an SSL error reason number on failure.  On failure
  * min_version and max_version will also be set to 0.
  */
-int ssl_get_client_min_max_version(const SSL *s, int *min_version,
-                                   int *max_version)
+int ssl_get_min_max_version(const SSL *s, int *min_version, int *max_version)
 {
     int version;
     int hole;
@@ -1894,7 +1926,7 @@ int ssl_set_client_hello_version(SSL *s)
 {
     int ver_min, ver_max, ret;
 
-    ret = ssl_get_client_min_max_version(s, &amp;ver_min, &amp;ver_max);
+    ret = ssl_get_min_max_version(s, &amp;ver_min, &amp;ver_max);
 
     if (ret != 0)
         return ret;
diff --git a/ssl/t1_lib.c b/ssl/t1_lib.c
index 5007f7e..0e1a97e 100644
--- a/ssl/t1_lib.c
+++ b/ssl/t1_lib.c
@@ -1013,7 +1013,7 @@ void ssl_set_client_disabled(SSL *s)
     s-&gt;s3-&gt;tmp.mask_a = 0;
     s-&gt;s3-&gt;tmp.mask_k = 0;
     ssl_set_sig_mask(&amp;s-&gt;s3-&gt;tmp.mask_a, s, SSL_SECOP_SIGALG_MASK);
-    ssl_get_client_min_max_version(s, &amp;s-&gt;s3-&gt;tmp.min_ver, &amp;s-&gt;s3-&gt;tmp.max_ver);
+    ssl_get_min_max_version(s, &amp;s-&gt;s3-&gt;tmp.min_ver, &amp;s-&gt;s3-&gt;tmp.max_ver);
 #ifndef OPENSSL_NO_PSK
     /* with PSK there must be client callback set */
     if (!s-&gt;psk_client_callback) {
diff --git a/test/recipes/70-test_sslmessages.t b/test/recipes/70-test_sslmessages.t
index 790b3ae..a6278dc 100644
--- a/test/recipes/70-test_sslmessages.t
+++ b/test/recipes/70-test_sslmessages.t
@@ -396,6 +396,7 @@ SKIP: {
     skip &quot;No EC support in this OpenSSL build&quot;, 1 if disabled(&quot;ec&quot;);
     $proxy-&gt;clear();
     $proxy-&gt;clientflags(&quot;-no_tls1_3&quot;);
+    $proxy-&gt;serverflags(&quot;-no_tls1_3&quot;);
     $proxy-&gt;ciphers(&quot;ECDHE-RSA-AES128-SHA&quot;);
     $proxy-&gt;start();
     checkhandshake($proxy, checkhandshake::EC_HANDSHAKE,
diff --git a/test/ssl-tests/14-curves.conf b/test/ssl-tests/14-curves.conf
index 83911b0..ab04c2e 100644
--- a/test/ssl-tests/14-curves.conf
+++ b/test/ssl-tests/14-curves.conf
@@ -50,6 +50,7 @@ PrivateKey = ${ENV::TEST_CERTS_DIR}/serverkey.pem
 [0-curve-sect163k1-client]
 CipherString = ECDHE
 Curves = sect163k1
+MaxProtocol = TLSv1.2
 VerifyCAFile = ${ENV::TEST_CERTS_DIR}/rootcert.pem
 VerifyMode = Peer
 
@@ -77,6 +78,7 @@ PrivateKey = ${ENV::TEST_CERTS_DIR}/serverkey.pem
 [1-curve-sect163r1-client]
 CipherString = ECDHE
 Curves = sect163r1
+MaxProtocol = TLSv1.2
 VerifyCAFile = ${ENV::TEST_CERTS_DIR}/rootcert.pem
 VerifyMode = Peer
 
@@ -104,6 +106,7 @@ PrivateKey = ${ENV::TEST_CERTS_DIR}/serverkey.pem
 [2-curve-sect163r2-client]
 CipherString = ECDHE
 Curves = sect163r2
+MaxProtocol = TLSv1.2
 VerifyCAFile = ${ENV::TEST_CERTS_DIR}/rootcert.pem
 VerifyMode = Peer
 
@@ -131,6 +134,7 @@ PrivateKey = ${ENV::TEST_CERTS_DIR}/serverkey.pem
 [3-curve-sect193r1-client]
 CipherString = ECDHE
 Curves = sect193r1
+MaxProtocol = TLSv1.2
 VerifyCAFile = ${ENV::TEST_CERTS_DIR}/rootcert.pem
 VerifyMode = Peer
 
@@ -158,6 +162,7 @@ PrivateKey = ${ENV::TEST_CERTS_DIR}/serverkey.pem
 [4-curve-sect193r2-client]
 CipherString = ECDHE
 Curves = sect193r2
+MaxProtocol = TLSv1.2
 VerifyCAFile = ${ENV::TEST_CERTS_DIR}/rootcert.pem
 VerifyMode = Peer
 
@@ -185,6 +190,7 @@ PrivateKey = ${ENV::TEST_CERTS_DIR}/serverkey.pem
 [5-curve-sect233k1-client]
 CipherString = ECDHE
 Curves = sect233k1
+MaxProtocol = TLSv1.2
 VerifyCAFile = ${ENV::TEST_CERTS_DIR}/rootcert.pem
 VerifyMode = Peer
 
@@ -212,6 +218,7 @@ PrivateKey = ${ENV::TEST_CERTS_DIR}/serverkey.pem
 [6-curve-sect233r1-client]
 CipherString = ECDHE
 Curves = sect233r1
+MaxProtocol = TLSv1.2
 VerifyCAFile = ${ENV::TEST_CERTS_DIR}/rootcert.pem
 VerifyMode = Peer
 
@@ -239,6 +246,7 @@ PrivateKey = ${ENV::TEST_CERTS_DIR}/serverkey.pem
 [7-curve-sect239k1-client]
 CipherString = ECDHE
 Curves = sect239k1
+MaxProtocol = TLSv1.2
 VerifyCAFile = ${ENV::TEST_CERTS_DIR}/rootcert.pem
 VerifyMode = Peer
 
@@ -266,6 +274,7 @@ PrivateKey = ${ENV::TEST_CERTS_DIR}/serverkey.pem
 [8-curve-sect283k1-client]
 CipherString = ECDHE
 Curves = sect283k1
+MaxProtocol = TLSv1.2
 VerifyCAFile = ${ENV::TEST_CERTS_DIR}/rootcert.pem
 VerifyMode = Peer
 
@@ -293,6 +302,7 @@ PrivateKey = ${ENV::TEST_CERTS_DIR}/serverkey.pem
 [9-curve-sect283r1-client]
 CipherString = ECDHE
 Curves = sect283r1
+MaxProtocol = TLSv1.2
 VerifyCAFile = ${ENV::TEST_CERTS_DIR}/rootcert.pem
 VerifyMode = Peer
 
@@ -320,6 +330,7 @@ PrivateKey = ${ENV::TEST_CERTS_DIR}/serverkey.pem
 [10-curve-sect409k1-client]
 CipherString = ECDHE
 Curves = sect409k1
+MaxProtocol = TLSv1.2
 VerifyCAFile = ${ENV::TEST_CERTS_DIR}/rootcert.pem
 VerifyMode = Peer
 
@@ -347,6 +358,7 @@ PrivateKey = ${ENV::TEST_CERTS_DIR}/serverkey.pem
 [11-curve-sect409r1-client]
 CipherString = ECDHE
 Curves = sect409r1
+MaxProtocol = TLSv1.2
 VerifyCAFile = ${ENV::TEST_CERTS_DIR}/rootcert.pem
 VerifyMode = Peer
 
@@ -374,6 +386,7 @@ PrivateKey = ${ENV::TEST_CERTS_DIR}/serverkey.pem
 [12-curve-sect571k1-client]
 CipherString = ECDHE
 Curves = sect571k1
+MaxProtocol = TLSv1.2
 VerifyCAFile = ${ENV::TEST_CERTS_DIR}/rootcert.pem
 VerifyMode = Peer
 
@@ -401,6 +414,7 @@ PrivateKey = ${ENV::TEST_CERTS_DIR}/serverkey.pem
 [13-curve-sect571r1-client]
 CipherString = ECDHE
 Curves = sect571r1
+MaxProtocol = TLSv1.2
 VerifyCAFile = ${ENV::TEST_CERTS_DIR}/rootcert.pem
 VerifyMode = Peer
 
@@ -428,6 +442,7 @@ PrivateKey = ${ENV::TEST_CERTS_DIR}/serverkey.pem
 [14-curve-secp160k1-client]
 CipherString = ECDHE
 Curves = secp160k1
+MaxProtocol = TLSv1.2
 VerifyCAFile = ${ENV::TEST_CERTS_DIR}/rootcert.pem
 VerifyMode = Peer
 
@@ -455,6 +470,7 @@ PrivateKey = ${ENV::TEST_CERTS_DIR}/serverkey.pem
 [15-curve-secp160r1-client]
 CipherString = ECDHE
 Curves = secp160r1
+MaxProtocol = TLSv1.2
 VerifyCAFile = ${ENV::TEST_CERTS_DIR}/rootcert.pem
 VerifyMode = Peer
 
@@ -482,6 +498,7 @@ PrivateKey = ${ENV::TEST_CERTS_DIR}/serverkey.pem
 [16-curve-secp160r2-client]
 CipherString = ECDHE
 Curves = secp160r2
+MaxProtocol = TLSv1.2
 VerifyCAFile = ${ENV::TEST_CERTS_DIR}/rootcert.pem
 VerifyMode = Peer
 
@@ -509,6 +526,7 @@ PrivateKey = ${ENV::TEST_CERTS_DIR}/serverkey.pem
 [17-curve-secp192k1-client]
 CipherString = ECDHE
 Curves = secp192k1
+MaxProtocol = TLSv1.2
 VerifyCAFile = ${ENV::TEST_CERTS_DIR}/rootcert.pem
 VerifyMode = Peer
 
@@ -536,6 +554,7 @@ PrivateKey = ${ENV::TEST_CERTS_DIR}/serverkey.pem
 [18-curve-prime192v1-client]
 CipherString = ECDHE
 Curves = prime192v1
+MaxProtocol = TLSv1.2
 VerifyCAFile = ${ENV::TEST_CERTS_DIR}/rootcert.pem
 VerifyMode = Peer
 
@@ -563,6 +582,7 @@ PrivateKey = ${ENV::TEST_CERTS_DIR}/serverkey.pem
 [19-curve-secp224k1-client]
 CipherString = ECDHE
 Curves = secp224k1
+MaxProtocol = TLSv1.2
 VerifyCAFile = ${ENV::TEST_CERTS_DIR}/rootcert.pem
 VerifyMode = Peer
 
@@ -590,6 +610,7 @@ PrivateKey = ${ENV::TEST_CERTS_DIR}/serverkey.pem
 [20-curve-secp224r1-client]
 CipherString = ECDHE
 Curves = secp224r1
+MaxProtocol = TLSv1.2
 VerifyCAFile = ${ENV::TEST_CERTS_DIR}/rootcert.pem
 VerifyMode = Peer
 
@@ -617,6 +638,7 @@ PrivateKey = ${ENV::TEST_CERTS_DIR}/serverkey.pem
 [21-curve-secp256k1-client]
 CipherString = ECDHE
 Curves = secp256k1
+MaxProtocol = TLSv1.2
 VerifyCAFile = ${ENV::TEST_CERTS_DIR}/rootcert.pem
 VerifyMode = Peer
 
@@ -644,6 +666,7 @@ PrivateKey = ${ENV::TEST_CERTS_DIR}/serverkey.pem
 [22-curve-prime256v1-client]
 CipherString = ECDHE
 Curves = prime256v1
+MaxProtocol = TLSv1.2
 VerifyCAFile = ${ENV::TEST_CERTS_DIR}/rootcert.pem
 VerifyMode = Peer
 
@@ -671,6 +694,7 @@ PrivateKey = ${ENV::TEST_CERTS_DIR}/serverkey.pem
 [23-curve-secp384r1-client]
 CipherString = ECDHE
 Curves = secp384r1
+MaxProtocol = TLSv1.2
 VerifyCAFile = ${ENV::TEST_CERTS_DIR}/rootcert.pem
 VerifyMode = Peer
 
@@ -698,6 +722,7 @@ PrivateKey = ${ENV::TEST_CERTS_DIR}/serverkey.pem
 [24-curve-secp521r1-client]
 CipherString = ECDHE
 Curves = secp521r1
+MaxProtocol = TLSv1.2
 VerifyCAFile = ${ENV::TEST_CERTS_DIR}/rootcert.pem
 VerifyMode = Peer
 
@@ -725,6 +750,7 @@ PrivateKey = ${ENV::TEST_CERTS_DIR}/serverkey.pem
 [25-curve-brainpoolP256r1-client]
 CipherString = ECDHE
 Curves = brainpoolP256r1
+MaxProtocol = TLSv1.2
 VerifyCAFile = ${ENV::TEST_CERTS_DIR}/rootcert.pem
 VerifyMode = Peer
 
@@ -752,6 +778,7 @@ PrivateKey = ${ENV::TEST_CERTS_DIR}/serverkey.pem
 [26-curve-brainpoolP384r1-client]
 CipherString = ECDHE
 Curves = brainpoolP384r1
+MaxProtocol = TLSv1.2
 VerifyCAFile = ${ENV::TEST_CERTS_DIR}/rootcert.pem
 VerifyMode = Peer
 
@@ -779,6 +806,7 @@ PrivateKey = ${ENV::TEST_CERTS_DIR}/serverkey.pem
 [27-curve-brainpoolP512r1-client]
 CipherString = ECDHE
 Curves = brainpoolP512r1
+MaxProtocol = TLSv1.2
 VerifyCAFile = ${ENV::TEST_CERTS_DIR}/rootcert.pem
 VerifyMode = Peer
 
@@ -806,6 +834,7 @@ PrivateKey = ${ENV::TEST_CERTS_DIR}/serverkey.pem
 [28-curve-X25519-client]
 CipherString = ECDHE
 Curves = X25519
+MaxProtocol = TLSv1.2
 VerifyCAFile = ${ENV::TEST_CERTS_DIR}/rootcert.pem
 VerifyMode = Peer
 
diff --git a/test/ssl-tests/14-curves.conf.in b/test/ssl-tests/14-curves.conf.in
index 6e98b5a..9f6e433 100644
--- a/test/ssl-tests/14-curves.conf.in
+++ b/test/ssl-tests/14-curves.conf.in
@@ -25,14 +25,15 @@ sub generate_tests() {
     foreach (0..$#curves) {
         my $curve = $curves[$_];
         push @tests, {
-	    name =&gt; &quot;curve-${curve}&quot;,
+            name =&gt; &quot;curve-${curve}&quot;,
             server =&gt; {
                 &quot;Curves&quot; =&gt; $curve,
                 # TODO(TLS1.3): Can we get this to work for TLSv1.3?
                 &quot;MaxProtocol&quot; =&gt; &quot;TLSv1.2&quot;
             },
             client =&gt; {
-		&quot;CipherString&quot; =&gt; &quot;ECDHE&quot;,
+                &quot;CipherString&quot; =&gt; &quot;ECDHE&quot;,
+                &quot;MaxProtocol&quot; =&gt; &quot;TLSv1.2&quot;,
                 &quot;Curves&quot; =&gt; $curve
             },
             test   =&gt; {
diff --git a/test/ssl-tests/17-renegotiate.conf b/test/ssl-tests/17-renegotiate.conf
index 8376eea..3f3769f 100644
--- a/test/ssl-tests/17-renegotiate.conf
+++ b/test/ssl-tests/17-renegotiate.conf
@@ -198,12 +198,12 @@ client = 6-renegotiate-aead-to-non-aead-client
 [6-renegotiate-aead-to-non-aead-server]
 Certificate = ${ENV::TEST_CERTS_DIR}/servercert.pem
 CipherString = DEFAULT
-MaxProtocol = TLSv1.2
 Options = NoResumptionOnRenegotiation
 PrivateKey = ${ENV::TEST_CERTS_DIR}/serverkey.pem
 
 [6-renegotiate-aead-to-non-aead-client]
 CipherString = AES128-GCM-SHA256
+MaxProtocol = TLSv1.2
 VerifyCAFile = ${ENV::TEST_CERTS_DIR}/rootcert.pem
 VerifyMode = Peer
 
@@ -230,12 +230,12 @@ client = 7-renegotiate-non-aead-to-aead-client
 [7-renegotiate-non-aead-to-aead-server]
 Certificate = ${ENV::TEST_CERTS_DIR}/servercert.pem
 CipherString = DEFAULT
-MaxProtocol = TLSv1.2
 Options = NoResumptionOnRenegotiation
 PrivateKey = ${ENV::TEST_CERTS_DIR}/serverkey.pem
 
 [7-renegotiate-non-aead-to-aead-client]
 CipherString = AES128-SHA
+MaxProtocol = TLSv1.2
 VerifyCAFile = ${ENV::TEST_CERTS_DIR}/rootcert.pem
 VerifyMode = Peer
 
@@ -262,12 +262,12 @@ client = 8-renegotiate-non-aead-to-non-aead-client
 [8-renegotiate-non-aead-to-non-aead-server]
 Certificate = ${ENV::TEST_CERTS_DIR}/servercert.pem
 CipherString = DEFAULT
-MaxProtocol = TLSv1.2
 Options = NoResumptionOnRenegotiation
 PrivateKey = ${ENV::TEST_CERTS_DIR}/serverkey.pem
 
 [8-renegotiate-non-aead-to-non-aead-client]
 CipherString = AES128-SHA
+MaxProtocol = TLSv1.2
 VerifyCAFile = ${ENV::TEST_CERTS_DIR}/rootcert.pem
 VerifyMode = Peer
 
@@ -294,12 +294,12 @@ client = 9-renegotiate-aead-to-aead-client
 [9-renegotiate-aead-to-aead-server]
 Certificate = ${ENV::TEST_CERTS_DIR}/servercert.pem
 CipherString = DEFAULT
-MaxProtocol = TLSv1.2
 Options = NoResumptionOnRenegotiation
 PrivateKey = ${ENV::TEST_CERTS_DIR}/serverkey.pem
 
 [9-renegotiate-aead-to-aead-client]
 CipherString = AES128-GCM-SHA256
+MaxProtocol = TLSv1.2
 VerifyCAFile = ${ENV::TEST_CERTS_DIR}/rootcert.pem
 VerifyMode = Peer
 
diff --git a/test/ssl-tests/17-renegotiate.conf.in b/test/ssl-tests/17-renegotiate.conf.in
index 867a4f2..b5d07b0 100644
--- a/test/ssl-tests/17-renegotiate.conf.in
+++ b/test/ssl-tests/17-renegotiate.conf.in
@@ -114,10 +114,10 @@ our @tests_tls1_2 = (
         name =&gt; &quot;renegotiate-aead-to-non-aead&quot;,
         server =&gt; {
             &quot;Options&quot; =&gt; &quot;NoResumptionOnRenegotiation&quot;,
-            &quot;MaxProtocol&quot; =&gt; &quot;TLSv1.2&quot;
         },
         client =&gt; {
             &quot;CipherString&quot; =&gt; &quot;AES128-GCM-SHA256&quot;,
+            &quot;MaxProtocol&quot; =&gt; &quot;TLSv1.2&quot;,
             extra =&gt; {
                 &quot;RenegotiateCiphers&quot; =&gt; &quot;AES128-SHA&quot;
             }
@@ -133,10 +133,10 @@ our @tests_tls1_2 = (
         name =&gt; &quot;renegotiate-non-aead-to-aead&quot;,
         server =&gt; {
             &quot;Options&quot; =&gt; &quot;NoResumptionOnRenegotiation&quot;,
-            &quot;MaxProtocol&quot; =&gt; &quot;TLSv1.2&quot;
         },
         client =&gt; {
             &quot;CipherString&quot; =&gt; &quot;AES128-SHA&quot;,
+            &quot;MaxProtocol&quot; =&gt; &quot;TLSv1.2&quot;,
             extra =&gt; {
                 &quot;RenegotiateCiphers&quot; =&gt; &quot;AES128-GCM-SHA256&quot;
             }
@@ -152,10 +152,10 @@ our @tests_tls1_2 = (
         name =&gt; &quot;renegotiate-non-aead-to-non-aead&quot;,
         server =&gt; {
             &quot;Options&quot; =&gt; &quot;NoResumptionOnRenegotiation&quot;,
-            &quot;MaxProtocol&quot; =&gt; &quot;TLSv1.2&quot;
         },
         client =&gt; {
             &quot;CipherString&quot; =&gt; &quot;AES128-SHA&quot;,
+            &quot;MaxProtocol&quot; =&gt; &quot;TLSv1.2&quot;,
             extra =&gt; {
                 &quot;RenegotiateCiphers&quot; =&gt; &quot;AES256-SHA&quot;
             }
@@ -171,10 +171,10 @@ our @tests_tls1_2 = (
         name =&gt; &quot;renegotiate-aead-to-aead&quot;,
         server =&gt; {
             &quot;Options&quot; =&gt; &quot;NoResumptionOnRenegotiation&quot;,
-            &quot;MaxProtocol&quot; =&gt; &quot;TLSv1.2&quot;
         },
         client =&gt; {
             &quot;CipherString&quot; =&gt; &quot;AES128-GCM-SHA256&quot;,
+            &quot;MaxProtocol&quot; =&gt; &quot;TLSv1.2&quot;,
             extra =&gt; {
                 &quot;RenegotiateCiphers&quot; =&gt; &quot;AES256-GCM-SHA384&quot;
             }
diff --git a/test/ssl-tests/19-mac-then-encrypt.conf b/test/ssl-tests/19-mac-then-encrypt.conf
index bba44d1..0dd384e 100644
--- a/test/ssl-tests/19-mac-then-encrypt.conf
+++ b/test/ssl-tests/19-mac-then-encrypt.conf
@@ -96,12 +96,12 @@ client = 3-disable-encrypt-then-mac-server-sha2-client
 [3-disable-encrypt-then-mac-server-sha2-server]
 Certificate = ${ENV::TEST_CERTS_DIR}/servercert.pem
 CipherString = DEFAULT
-MaxProtocol = TLSv1.2
 Options = -EncryptThenMac
 PrivateKey = ${ENV::TEST_CERTS_DIR}/serverkey.pem
 
 [3-disable-encrypt-then-mac-server-sha2-client]
 CipherString = AES128-SHA256
+MaxProtocol = TLSv1.2
 VerifyCAFile = ${ENV::TEST_CERTS_DIR}/rootcert.pem
 VerifyMode = Peer
 
diff --git a/test/ssl-tests/19-mac-then-encrypt.conf.in b/test/ssl-tests/19-mac-then-encrypt.conf.in
index d51cfa3..dfe529c 100644
--- a/test/ssl-tests/19-mac-then-encrypt.conf.in
+++ b/test/ssl-tests/19-mac-then-encrypt.conf.in
@@ -61,10 +61,10 @@ my @tests_tls1_2 = (
         name =&gt; &quot;disable-encrypt-then-mac-server-sha2&quot;,
         server =&gt; {
           &quot;Options&quot; =&gt; &quot;-EncryptThenMac&quot;,
-          &quot;MaxProtocol&quot; =&gt; &quot;TLSv1.2&quot;
         },
         client =&gt; {
           &quot;CipherString&quot; =&gt; &quot;AES128-SHA256&quot;,
+          &quot;MaxProtocol&quot; =&gt; &quot;TLSv1.2&quot;
         },
         test   =&gt; {
           &quot;ExpectedResult&quot; =&gt; &quot;Success&quot;,
diff --git a/test/ssl-tests/20-cert-select.conf b/test/ssl-tests/20-cert-select.conf
index 20154bb..f84d9b1 100644
--- a/test/ssl-tests/20-cert-select.conf
+++ b/test/ssl-tests/20-cert-select.conf
@@ -34,6 +34,7 @@ PrivateKey = ${ENV::TEST_CERTS_DIR}/serverkey.pem
 
 [0-ECDSA CipherString Selection-client]
 CipherString = aECDSA
+MaxProtocol = TLSv1.2
 RequestCAFile = ${ENV::TEST_CERTS_DIR}/root-cert.pem
 VerifyCAFile = ${ENV::TEST_CERTS_DIR}/rootcert.pem
 VerifyMode = Peer
@@ -64,6 +65,7 @@ PrivateKey = ${ENV::TEST_CERTS_DIR}/serverkey.pem
 
 [1-RSA CipherString Selection-client]
 CipherString = aRSA
+MaxProtocol = TLSv1.2
 VerifyCAFile = ${ENV::TEST_CERTS_DIR}/rootcert.pem
 VerifyMode = Peer
 
@@ -90,6 +92,7 @@ PrivateKey = ${ENV::TEST_CERTS_DIR}/serverkey.pem
 
 [2-ECDSA CipherString Selection, no ECDSA certificate-client]
 CipherString = aECDSA
+MaxProtocol = TLSv1.2
 VerifyCAFile = ${ENV::TEST_CERTS_DIR}/rootcert.pem
 VerifyMode = Peer
 
diff --git a/test/ssl-tests/20-cert-select.conf.in b/test/ssl-tests/20-cert-select.conf.in
index aadae27..5937f9a 100644
--- a/test/ssl-tests/20-cert-select.conf.in
+++ b/test/ssl-tests/20-cert-select.conf.in
@@ -21,6 +21,7 @@ our @tests = (
         server =&gt; $server,
         client =&gt; {
             &quot;CipherString&quot; =&gt; &quot;aECDSA&quot;,
+            &quot;MaxProtocol&quot; =&gt; &quot;TLSv1.2&quot;,
             &quot;RequestCAFile&quot; =&gt; test_pem(&quot;root-cert.pem&quot;),
         },
         test   =&gt; {
@@ -36,6 +37,7 @@ our @tests = (
         server =&gt; $server,
         client =&gt; {
             &quot;CipherString&quot; =&gt; &quot;aRSA&quot;,
+            &quot;MaxProtocol&quot; =&gt; &quot;TLSv1.2&quot;,
         },
         test   =&gt; {
             &quot;ExpectedServerCertType&quot; =&gt;, &quot;RSA&quot;,
@@ -49,7 +51,8 @@ our @tests = (
             &quot;MaxProtocol&quot; =&gt; &quot;TLSv1.2&quot;
         },
         client =&gt; {
-            &quot;CipherString&quot; =&gt; &quot;aECDSA&quot;
+            &quot;CipherString&quot; =&gt; &quot;aECDSA&quot;,
+            &quot;MaxProtocol&quot; =&gt; &quot;TLSv1.2&quot;
         },
         test   =&gt; {
             &quot;ExpectedResult&quot; =&gt; &quot;ServerFail&quot;
diff --git a/test/ssl-tests/23-srp.conf b/test/ssl-tests/23-srp.conf
index 6ae49e6..610a0bb 100644
--- a/test/ssl-tests/23-srp.conf
+++ b/test/ssl-tests/23-srp.conf
@@ -18,6 +18,7 @@ client = 0-srp-client
 [0-srp-server]
 Certificate = ${ENV::TEST_CERTS_DIR}/servercert.pem
 CipherString = SRP
+MaxProtocol = TLSv1.2
 PrivateKey = ${ENV::TEST_CERTS_DIR}/serverkey.pem
 
 [0-srp-client]
@@ -52,6 +53,7 @@ client = 1-srp-bad-password-client
 [1-srp-bad-password-server]
 Certificate = ${ENV::TEST_CERTS_DIR}/servercert.pem
 CipherString = SRP
+MaxProtocol = TLSv1.2
 PrivateKey = ${ENV::TEST_CERTS_DIR}/serverkey.pem
 
 [1-srp-bad-password-client]
@@ -86,6 +88,7 @@ client = 2-srp-auth-client
 [2-srp-auth-server]
 Certificate = ${ENV::TEST_CERTS_DIR}/servercert.pem
 CipherString = aSRP
+MaxProtocol = TLSv1.2
 PrivateKey = ${ENV::TEST_CERTS_DIR}/serverkey.pem
 
 [2-srp-auth-client]
@@ -120,6 +123,7 @@ client = 3-srp-auth-bad-password-client
 [3-srp-auth-bad-password-server]
 Certificate = ${ENV::TEST_CERTS_DIR}/servercert.pem
 CipherString = aSRP
+MaxProtocol = TLSv1.2
 PrivateKey = ${ENV::TEST_CERTS_DIR}/serverkey.pem
 
 [3-srp-auth-bad-password-client]
diff --git a/test/ssl-tests/23-srp.conf.in b/test/ssl-tests/23-srp.conf.in
index b7601fc..dcbd9f4 100644
--- a/test/ssl-tests/23-srp.conf.in
+++ b/test/ssl-tests/23-srp.conf.in
@@ -15,89 +15,93 @@ package ssltests;
 
 our @tests = (
     {
-	name =&gt; &quot;srp&quot;,
-	server =&gt; {
-	    &quot;CipherString&quot; =&gt; &quot;SRP&quot;,
-	    extra =&gt; {
-	       	&quot;SRPUser&quot; =&gt; &quot;user&quot;,
-		&quot;SRPPassword&quot; =&gt; &quot;password&quot;,
-	    },
+        name =&gt; &quot;srp&quot;,
+        server =&gt; {
+            &quot;CipherString&quot; =&gt; &quot;SRP&quot;,
+            &quot;MaxProtocol&quot; =&gt; &quot;TLSv1.2&quot;,
+            extra =&gt; {
+                &quot;SRPUser&quot; =&gt; &quot;user&quot;,
+                &quot;SRPPassword&quot; =&gt; &quot;password&quot;,
+            },
+        },
+        client =&gt; {
+            &quot;CipherString&quot; =&gt; &quot;SRP&quot;,
+            &quot;MaxProtocol&quot; =&gt; &quot;TLSv1.2&quot;,
+            extra =&gt; {
+                &quot;SRPUser&quot; =&gt; &quot;user&quot;,
+                &quot;SRPPassword&quot; =&gt; &quot;password&quot;,
+            },
+        },
+        test =&gt; {
+            &quot;ExpectedResult&quot; =&gt; &quot;Success&quot;
         },
-	client =&gt; {
-	    &quot;CipherString&quot; =&gt; &quot;SRP&quot;,
-	    &quot;MaxProtocol&quot; =&gt; &quot;TLSv1.2&quot;,
-	    extra =&gt; {
-	        &quot;SRPUser&quot; =&gt; &quot;user&quot;,
-		&quot;SRPPassword&quot; =&gt; &quot;password&quot;,
-	    },
-	},
-	test =&gt; {
-	    &quot;ExpectedResult&quot; =&gt; &quot;Success&quot;
-	},
     },
     {
-	name =&gt; &quot;srp-bad-password&quot;,
-	server =&gt; {
-	    &quot;CipherString&quot; =&gt; &quot;SRP&quot;,
-	    extra =&gt; {
-	       	&quot;SRPUser&quot; =&gt; &quot;user&quot;,
-		&quot;SRPPassword&quot; =&gt; &quot;password&quot;,
-	    },
+        name =&gt; &quot;srp-bad-password&quot;,
+        server =&gt; {
+            &quot;CipherString&quot; =&gt; &quot;SRP&quot;,
+            &quot;MaxProtocol&quot; =&gt; &quot;TLSv1.2&quot;,
+            extra =&gt; {
+                &quot;SRPUser&quot; =&gt; &quot;user&quot;,
+                &quot;SRPPassword&quot; =&gt; &quot;password&quot;,
+            },
+        },
+        client =&gt; {
+            &quot;CipherString&quot; =&gt; &quot;SRP&quot;,
+            &quot;MaxProtocol&quot; =&gt; &quot;TLSv1.2&quot;,
+            extra =&gt; {
+                &quot;SRPUser&quot; =&gt; &quot;user&quot;,
+                &quot;SRPPassword&quot; =&gt; &quot;passw0rd&quot;,
+            },
+        },
+        test =&gt; {
+            # Server fails first with bad client Finished.
+            &quot;ExpectedResult&quot; =&gt; &quot;ServerFail&quot;
         },
-	client =&gt; {
-	    &quot;CipherString&quot; =&gt; &quot;SRP&quot;,
-	    &quot;MaxProtocol&quot; =&gt; &quot;TLSv1.2&quot;,
-	    extra =&gt; {
-	        &quot;SRPUser&quot; =&gt; &quot;user&quot;,
-		&quot;SRPPassword&quot; =&gt; &quot;passw0rd&quot;,
-	    },
-	},
-	test =&gt; {
-	    # Server fails first with bad client Finished.
-	    &quot;ExpectedResult&quot; =&gt; &quot;ServerFail&quot;
-	},
     },
     {
-	name =&gt; &quot;srp-auth&quot;,
-	server =&gt; {
-	    &quot;CipherString&quot; =&gt; &quot;aSRP&quot;,
-	    extra =&gt; {
-	       	&quot;SRPUser&quot; =&gt; &quot;user&quot;,
-		&quot;SRPPassword&quot; =&gt; &quot;password&quot;,
-	    },
+        name =&gt; &quot;srp-auth&quot;,
+        server =&gt; {
+            &quot;CipherString&quot; =&gt; &quot;aSRP&quot;,
+            &quot;MaxProtocol&quot; =&gt; &quot;TLSv1.2&quot;,
+            extra =&gt; {
+                &quot;SRPUser&quot; =&gt; &quot;user&quot;,
+                &quot;SRPPassword&quot; =&gt; &quot;password&quot;,
+            },
+        },
+        client =&gt; {
+            &quot;CipherString&quot; =&gt; &quot;aSRP&quot;,
+            &quot;MaxProtocol&quot; =&gt; &quot;TLSv1.2&quot;,
+            extra =&gt; {
+                &quot;SRPUser&quot; =&gt; &quot;user&quot;,
+                &quot;SRPPassword&quot; =&gt; &quot;password&quot;,
+            },
+        },
+        test =&gt; {
+            &quot;ExpectedResult&quot; =&gt; &quot;Success&quot;
         },
-	client =&gt; {
-	    &quot;CipherString&quot; =&gt; &quot;aSRP&quot;,
-	    &quot;MaxProtocol&quot; =&gt; &quot;TLSv1.2&quot;,
-	    extra =&gt; {
-	        &quot;SRPUser&quot; =&gt; &quot;user&quot;,
-		&quot;SRPPassword&quot; =&gt; &quot;password&quot;,
-	    },
-	},
-	test =&gt; {
-	    &quot;ExpectedResult&quot; =&gt; &quot;Success&quot;
-	},
     },
     {
-	name =&gt; &quot;srp-auth-bad-password&quot;,
-	server =&gt; {
-	    &quot;CipherString&quot; =&gt; &quot;aSRP&quot;,
-	    extra =&gt; {
-	       	&quot;SRPUser&quot; =&gt; &quot;user&quot;,
-		&quot;SRPPassword&quot; =&gt; &quot;password&quot;,
-	    },
+        name =&gt; &quot;srp-auth-bad-password&quot;,
+        server =&gt; {
+            &quot;CipherString&quot; =&gt; &quot;aSRP&quot;,
+            &quot;MaxProtocol&quot; =&gt; &quot;TLSv1.2&quot;,
+            extra =&gt; {
+                &quot;SRPUser&quot; =&gt; &quot;user&quot;,
+                &quot;SRPPassword&quot; =&gt; &quot;password&quot;,
+            },
+        },
+        client =&gt; {
+            &quot;CipherString&quot; =&gt; &quot;aSRP&quot;,
+            &quot;MaxProtocol&quot; =&gt; &quot;TLSv1.2&quot;,
+            extra =&gt; {
+                &quot;SRPUser&quot; =&gt; &quot;user&quot;,
+                &quot;SRPPassword&quot; =&gt; &quot;passw0rd&quot;,
+            },
+        },
+        test =&gt; {
+            # Server fails first with bad client Finished.
+            &quot;ExpectedResult&quot; =&gt; &quot;ServerFail&quot;
         },
-	client =&gt; {
-	    &quot;CipherString&quot; =&gt; &quot;aSRP&quot;,
-	    &quot;MaxProtocol&quot; =&gt; &quot;TLSv1.2&quot;,
-	    extra =&gt; {
-	        &quot;SRPUser&quot; =&gt; &quot;user&quot;,
-		&quot;SRPPassword&quot; =&gt; &quot;passw0rd&quot;,
-	    },
-	},
-	test =&gt; {
-	    # Server fails first with bad client Finished.
-	    &quot;ExpectedResult&quot; =&gt; &quot;ServerFail&quot;
-	},
     },
-);
\ No newline at end of file
+);
diff --git a/test/ssl-tests/protocol_version.pm b/test/ssl-tests/protocol_version.pm
index f0b3030..edc0dd2 100644
--- a/test/ssl-tests/protocol_version.pm
+++ b/test/ssl-tests/protocol_version.pm
@@ -129,6 +129,37 @@ sub generate_version_tests {
             }
         }
     }
+    return @tests if disabled(&quot;tls1_3&quot;) || disabled(&quot;tls1_2&quot;) || $dtls;
+
+    #Add some version/ciphersuite sanity check tests
+    push @tests, {
+        &quot;name&quot; =&gt; &quot;ciphersuite-sanity-check-client&quot;,
+        &quot;client&quot; =&gt; {
+            #Offering only &lt;=TLSv1.2 ciphersuites with TLSv1.3 should fail
+            &quot;CipherString&quot; =&gt; &quot;AES128-SHA&quot;,
+        },
+        &quot;server&quot; =&gt; {
+            &quot;MaxProtocol&quot; =&gt; &quot;TLSv1.2&quot;
+        },
+        &quot;test&quot; =&gt; {
+            &quot;ExpectedResult&quot; =&gt; &quot;ClientFail&quot;,
+        }
+    };
+    push @tests, {
+        &quot;name&quot; =&gt; &quot;ciphersuite-sanity-check-server&quot;,
+        &quot;client&quot; =&gt; {
+            &quot;CipherString&quot; =&gt; &quot;AES128-SHA&quot;,
+            &quot;MaxProtocol&quot; =&gt; &quot;TLSv1.2&quot;
+        },
+        &quot;server&quot; =&gt; {
+            #Allowing only &lt;=TLSv1.2 ciphersuites with TLSv1.3 should fail
+            &quot;CipherString&quot; =&gt; &quot;AES128-SHA&quot;,
+        },
+        &quot;test&quot; =&gt; {
+            &quot;ExpectedResult&quot; =&gt; &quot;ServerFail&quot;,
+        }
+    };
+
     return @tests;
 }
 
</PRE>









<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="014352.html">[openssl-commits] [openssl]  master update
</A></li>
	<LI>Next message: <A HREF="014356.html">[openssl-commits] [openssl]  master update
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#14353">[ date ]</a>
              <a href="thread.html#14353">[ thread ]</a>
              <a href="subject.html#14353">[ subject ]</a>
              <a href="author.html#14353">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="../../../mailman/listinfo/openssl-commits.html">More information about the openssl-commits
mailing list</a><br>
</body></html>
