<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [openssl-commits] [openssl]  master update
   </TITLE>
   <LINK REL="Index" HREF="https://mta.openssl.org/pipermail/openssl-commits/2017-April/index.html" >
   <LINK REL="made" HREF="mailto:openssl-commits%40openssl.org?Subject=Re%3A%20%5Bopenssl-commits%5D%20%5Bopenssl%5D%20%20master%20update&In-Reply-To=%3C1492541134.657755.3564.nullmailer%40dev.openssl.org%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="014194.html">
   <LINK REL="Next"  HREF="014198.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[openssl-commits] [openssl]  master update</H1>
    <B>Rich Salz</B> 
    <A HREF="mailto:openssl-commits%40openssl.org?Subject=Re%3A%20%5Bopenssl-commits%5D%20%5Bopenssl%5D%20%20master%20update&In-Reply-To=%3C1492541134.657755.3564.nullmailer%40dev.openssl.org%3E"
       TITLE="[openssl-commits] [openssl]  master update">rsalz at openssl.org
       </A><BR>
    <I>Tue Apr 18 18:45:34 UTC 2017</I>
    <P><UL>
        <LI>Previous message: <A HREF="014194.html">[openssl-commits] [openssl]  master update
</A></li>
        <LI>Next message: <A HREF="014198.html">[openssl-commits] [openssl]  master update
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#14197">[ date ]</a>
              <a href="thread.html#14197">[ thread ]</a>
              <a href="subject.html#14197">[ subject ]</a>
              <a href="author.html#14197">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>The branch master has been updated
       via  b66411f6cda6970c01283ddde6d8063c57b3b7d9 (commit)
      from  0fef74486ede58e34eeac2fab38c3f467ea31f95 (commit)


- Log -----------------------------------------------------------------
commit b66411f6cda6970c01283ddde6d8063c57b3b7d9
Author: Rich Salz &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">rsalz at openssl.org</A>&gt;
Date:   Tue Apr 18 14:34:43 2017 -0400

    Convert more tests
    
    recordlentest, srptest, ecdsatest, enginetest, pbelutest
    
    Reviewed-by: Richard Levitte &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">levitte at openssl.org</A>&gt;
    (Merged from <A HREF="https://github.com/openssl/openssl/pull/3237">https://github.com/openssl/openssl/pull/3237</A>)

-----------------------------------------------------------------------

Summary of changes:
 test/build.info      |  10 +-
 test/ecdsatest.c     | 316 ++++++++++++++++++---------------------------------
 test/enginetest.c    | 182 ++++++++++++++---------------
 test/pbelutest.c     |  43 ++++---
 test/recordlentest.c |  48 +++-----
 test/srptest.c       | 180 +++++++++++++----------------
 6 files changed, 317 insertions(+), 462 deletions(-)

diff --git a/test/build.info b/test/build.info
index 537b361..8346385 100644
--- a/test/build.info
+++ b/test/build.info
@@ -55,7 +55,7 @@ IF[{- !$disabled{tests} -}]
   INCLUDE[ectest]=.. ../include
   DEPEND[ectest]=../libcrypto
 
-  SOURCE[ecdsatest]=ecdsatest.c
+  SOURCE[ecdsatest]=ecdsatest.c testutil.c test_main.c
   INCLUDE[ecdsatest]=../include
   DEPEND[ecdsatest]=../libcrypto
 
@@ -63,7 +63,7 @@ IF[{- !$disabled{tests} -}]
   INCLUDE[gmdifftest]=../include
   DEPEND[gmdifftest]=../libcrypto
 
-  SOURCE[pbelutest]=pbelutest.c
+  SOURCE[pbelutest]=pbelutest.c testutil.c test_main.c
   INCLUDE[pbelutest]=../include
   DEPEND[pbelutest]=../libcrypto
 
@@ -119,11 +119,11 @@ IF[{- !$disabled{tests} -}]
   INCLUDE[dhtest]=../include
   DEPEND[dhtest]=../libcrypto
 
-  SOURCE[enginetest]=enginetest.c
+  SOURCE[enginetest]=enginetest.c testutil.c test_main.c
   INCLUDE[enginetest]=../include
   DEPEND[enginetest]=../libcrypto
 
-  SOURCE[casttest]=casttest.c testutil.c test_main.o
+  SOURCE[casttest]=casttest.c testutil.c test_main.c
   INCLUDE[casttest]=.. ../include
   DEPEND[casttest]=../libcrypto
 
@@ -203,7 +203,7 @@ IF[{- !$disabled{tests} -}]
   INCLUDE[secmemtest]=../include
   DEPEND[secmemtest]=../libcrypto
 
-  SOURCE[srptest]=srptest.c
+  SOURCE[srptest]=srptest.c testutil.c test_main.c
   INCLUDE[srptest]=../include
   DEPEND[srptest]=../libcrypto
 
diff --git a/test/ecdsatest.c b/test/ecdsatest.c
index ce73778..8b1e566 100644
--- a/test/ecdsatest.c
+++ b/test/ecdsatest.c
@@ -45,48 +45,39 @@ int main(int argc, char *argv[])
 # endif
 # include &lt;openssl/err.h&gt;
 # include &lt;openssl/rand.h&gt;
+# include &quot;testutil.h&quot;
+# include &quot;test_main.h&quot;
 
 static const char rnd_seed[] = &quot;string to make the random number generator &quot;
     &quot;think it has entropy&quot;;
 
-/* declaration of the test functions */
-int x9_62_tests(BIO *);
-int x9_62_test_internal(BIO *out, int nid, const char *r, const char *s);
-int test_builtin(BIO *);
 
 /* functions to change the RAND_METHOD */
-int change_rand(void);
-int restore_rand(void);
-int fbytes(unsigned char *buf, int num);
+static int fbytes(unsigned char *buf, int num);
 
 static RAND_METHOD fake_rand;
 static const RAND_METHOD *old_rand;
 
-int change_rand(void)
+static int change_rand(void)
 {
     /* save old rand method */
-    if ((old_rand = RAND_get_rand_method()) == NULL)
+    if (!TEST_ptr(old_rand = RAND_get_rand_method()))
         return 0;
 
-    fake_rand.seed = old_rand-&gt;seed;
-    fake_rand.cleanup = old_rand-&gt;cleanup;
-    fake_rand.add = old_rand-&gt;add;
-    fake_rand.status = old_rand-&gt;status;
+    fake_rand = *old_rand;
     /* use own random function */
     fake_rand.bytes = fbytes;
-    fake_rand.pseudorand = old_rand-&gt;bytes;
     /* set new RAND_METHOD */
-    if (!RAND_set_rand_method(&amp;fake_rand))
+    if (!TEST_true(RAND_set_rand_method(&amp;fake_rand)))
         return 0;
     return 1;
 }
 
-int restore_rand(void)
+static int restore_rand(void)
 {
-    if (!RAND_set_rand_method(old_rand))
+    if (!TEST_true(RAND_set_rand_method(old_rand)))
         return 0;
-    else
-        return 1;
+    return 1;
 }
 
 static int fbytes_counter = 0, use_fake = 0;
@@ -105,9 +96,9 @@ static const char *numbers[8] = {
         &quot;40041670216363&quot;
 };
 
-int fbytes(unsigned char *buf, int num)
+static int fbytes(unsigned char *buf, int num)
 {
-    int ret;
+    int ret = 0;
     BIGNUM *tmp = NULL;
 
     if (use_fake == 0)
@@ -117,85 +108,77 @@ int fbytes(unsigned char *buf, int num)
 
     if (fbytes_counter &gt;= 8)
         return 0;
-    tmp = BN_new();
-    if (!tmp)
+    if (!TEST_ptr(tmp = BN_new()))
         return 0;
-    if (!BN_dec2bn(&amp;tmp, numbers[fbytes_counter])) {
+    if (!TEST_true(BN_dec2bn(&amp;tmp, numbers[fbytes_counter]))) {
         BN_free(tmp);
         return 0;
     }
     fbytes_counter++;
-    if (num != BN_num_bytes(tmp) || !BN_bn2bin(tmp, buf))
-        ret = 0;
-    else
+    if (TEST_int_eq(BN_num_bytes(tmp), num)
+            &amp;&amp; TEST_true(BN_bn2bin(tmp, buf)))
         ret = 1;
     BN_free(tmp);
     return ret;
 }
 
 /* some tests from the X9.62 draft */
-int x9_62_test_internal(BIO *out, int nid, const char *r_in, const char *s_in)
+static int x9_62_test_internal(int nid, const char *r_in, const char *s_in)
 {
     int ret = 0;
     const char message[] = &quot;abc&quot;;
     unsigned char digest[20];
     unsigned int dgst_len = 0;
-    EVP_MD_CTX *md_ctx = EVP_MD_CTX_new();
+    EVP_MD_CTX *md_ctx;
     EC_KEY *key = NULL;
     ECDSA_SIG *signature = NULL;
     BIGNUM *r = NULL, *s = NULL;
     BIGNUM *kinv = NULL, *rp = NULL;
     const BIGNUM *sig_r, *sig_s;
 
-    if (md_ctx == NULL)
+    if (!TEST_ptr(md_ctx = EVP_MD_CTX_new()))
         goto x962_int_err;
 
     /* get the message digest */
-    if (!EVP_DigestInit(md_ctx, EVP_sha1())
-        || !EVP_DigestUpdate(md_ctx, (const void *)message, 3)
-        || !EVP_DigestFinal(md_ctx, digest, &amp;dgst_len))
+    if (!TEST_true(EVP_DigestInit(md_ctx, EVP_sha1()))
+        || !TEST_true(EVP_DigestUpdate(md_ctx, (const void *)message, 3))
+        || !TEST_true(EVP_DigestFinal(md_ctx, digest, &amp;dgst_len)))
         goto x962_int_err;
 
-    BIO_printf(out, &quot;testing %s: &quot;, OBJ_nid2sn(nid));
+    TEST_info(&quot;testing %s&quot;, OBJ_nid2sn(nid));
+
     /* create the key */
-    if ((key = EC_KEY_new_by_curve_name(nid)) == NULL)
+    if (!TEST_ptr(key = EC_KEY_new_by_curve_name(nid)))
         goto x962_int_err;
     use_fake = 1;
-    if (!EC_KEY_generate_key(key))
+    if (!TEST_true(EC_KEY_generate_key(key)))
         goto x962_int_err;
-    BIO_printf(out, &quot;.&quot;);
-    (void)BIO_flush(out);
+
     /* create the signature */
     use_fake = 1;
     /* Use ECDSA_sign_setup to avoid use of ECDSA nonces */
-    if (!ECDSA_sign_setup(key, NULL, &amp;kinv, &amp;rp))
+    if (!TEST_true(ECDSA_sign_setup(key, NULL, &amp;kinv, &amp;rp)))
         goto x962_int_err;
-    signature = ECDSA_do_sign_ex(digest, 20, kinv, rp, key);
-    if (signature == NULL)
+    if (!TEST_ptr(signature = ECDSA_do_sign_ex(digest, 20, kinv, rp, key)))
         goto x962_int_err;
-    BIO_printf(out, &quot;.&quot;);
-    (void)BIO_flush(out);
+
     /* compare the created signature with the expected signature */
-    if ((r = BN_new()) == NULL || (s = BN_new()) == NULL)
+    if (!TEST_ptr(r = BN_new()) || !TEST_ptr(s = BN_new()))
         goto x962_int_err;
-    if (!BN_dec2bn(&amp;r, r_in) || !BN_dec2bn(&amp;s, s_in))
+    if (!TEST_true(BN_dec2bn(&amp;r, r_in)) || !TEST_true(BN_dec2bn(&amp;s, s_in)))
         goto x962_int_err;
     ECDSA_SIG_get0(signature, &amp;sig_r, &amp;sig_s);
-    if (BN_cmp(sig_r, r) || BN_cmp(sig_s, s))
+    if (!TEST_int_eq(BN_cmp(sig_r, r), 0)
+            || !TEST_int_eq(BN_cmp(sig_s, s), 0))
         goto x962_int_err;
-    BIO_printf(out, &quot;.&quot;);
-    (void)BIO_flush(out);
+
     /* verify the signature */
-    if (ECDSA_do_verify(digest, 20, signature, key) != 1)
+    if (!TEST_int_eq(ECDSA_do_verify(digest, 20, signature, key), 1))
         goto x962_int_err;
-    BIO_printf(out, &quot;.&quot;);
-    (void)BIO_flush(out);
 
-    BIO_printf(out, &quot; ok\n&quot;);
     ret = 1;
+
  x962_int_err:
-    if (!ret)
-        BIO_printf(out, &quot; failed\n&quot;);
     EC_KEY_free(key);
     ECDSA_SIG_free(signature);
     BN_free(r);
@@ -206,46 +189,46 @@ int x9_62_test_internal(BIO *out, int nid, const char *r_in, const char *s_in)
     return ret;
 }
 
-int x9_62_tests(BIO *out)
+static int x9_62_tests()
 {
     int ret = 0;
 
-    BIO_printf(out, &quot;some tests from X9.62:\n&quot;);
-
     /* set own rand method */
     if (!change_rand())
         goto x962_err;
 
-    if (!x9_62_test_internal(out, NID_X9_62_prime192v1,
-                             &quot;3342403536405981729393488334694600415596881826869351677613&quot;,
-                             &quot;5735822328888155254683894997897571951568553642892029982342&quot;))
+    if (!TEST_true(x9_62_test_internal(NID_X9_62_prime192v1,
+                 &quot;3342403536405981729393488334694600415596881826869351677613&quot;,
+                 &quot;5735822328888155254683894997897571951568553642892029982342&quot;)))
         goto x962_err;
-    if (!x9_62_test_internal(out, NID_X9_62_prime239v1,
-                             &quot;3086361431751678114926225473006680188549593787585317781474&quot;
+    if (!TEST_true(x9_62_test_internal(NID_X9_62_prime239v1,
+                 &quot;3086361431751678114926225473006680188549593787585317781474&quot;
                              &quot;62058306432176&quot;,
-                             &quot;3238135532097973577080787768312505059318910517550078427819&quot;
-                             &quot;78505179448783&quot;))
+                 &quot;3238135532097973577080787768312505059318910517550078427819&quot;
+                             &quot;78505179448783&quot;)))
         goto x962_err;
+
 # ifndef OPENSSL_NO_EC2M
-    if (!x9_62_test_internal(out, NID_X9_62_c2tnb191v1,
-                             &quot;87194383164871543355722284926904419997237591535066528048&quot;,
-                             &quot;308992691965804947361541664549085895292153777025772063598&quot;))
+    if (!TEST_true(x9_62_test_internal(NID_X9_62_c2tnb191v1,
+                 &quot;87194383164871543355722284926904419997237591535066528048&quot;,
+                 &quot;308992691965804947361541664549085895292153777025772063598&quot;)))
         goto x962_err;
-    if (!x9_62_test_internal(out, NID_X9_62_c2tnb239v1,
-                             &quot;2159633321041961198501834003903461262881815148684178964245&quot;
+    if (!TEST_true(x9_62_test_internal(NID_X9_62_c2tnb239v1,
+                 &quot;2159633321041961198501834003903461262881815148684178964245&quot;
                              &quot;5876922391552&quot;,
-                             &quot;1970303740007316867383349976549972270528498040721988191026&quot;
-                             &quot;49413465737174&quot;))
+                 &quot;1970303740007316867383349976549972270528498040721988191026&quot;
+                             &quot;49413465737174&quot;)))
         goto x962_err;
 # endif
     ret = 1;
+
  x962_err:
-    if (!restore_rand())
+    if (!TEST_true(restore_rand()))
         ret = 0;
     return ret;
 }
 
-int test_builtin(BIO *out)
+static int test_builtin(void)
 {
     EC_builtin_curve *curves = NULL;
     size_t crv_len = 0, n = 0;
@@ -264,29 +247,16 @@ int test_builtin(BIO *out)
     int nid, ret = 0;
 
     /* fill digest values with some random data */
-    if (RAND_bytes(digest, 20) &lt;= 0 || RAND_bytes(wrong_digest, 20) &lt;= 0) {
-        BIO_printf(out, &quot;ERROR: unable to get random data\n&quot;);
+    if (!TEST_true(RAND_bytes(digest, 20))
+            || !TEST_true(RAND_bytes(wrong_digest, 20)))
         goto builtin_err;
-    }
-
-    /*
-     * create and verify a ecdsa signature with every available curve (with )
-     */
-    BIO_printf(out, &quot;\ntesting ECDSA_sign() and ECDSA_verify() &quot;
-               &quot;with some internal curves:\n&quot;);
 
+    /* create and verify a ecdsa signature with every available curve */
     /* get a list of all internal curves */
     crv_len = EC_get_builtin_curves(NULL, 0);
-    curves = OPENSSL_malloc(sizeof(*curves) * crv_len);
-    if (curves == NULL) {
-        BIO_printf(out, &quot;malloc error\n&quot;);
+    if (!TEST_ptr(curves = OPENSSL_malloc(sizeof(*curves) * crv_len))
+            || !TEST_true(EC_get_builtin_curves(curves, crv_len)))
         goto builtin_err;
-    }
-
-    if (!EC_get_builtin_curves(curves, crv_len)) {
-        BIO_printf(out, &quot;unable to get internal curves\n&quot;);
-        goto builtin_err;
-    }
 
     /* now create and verify a signature for every curve */
     for (n = 0; n &lt; crv_len; n++) {
@@ -296,12 +266,9 @@ int test_builtin(BIO *out)
         if (nid == NID_ipsec4 || nid == NID_X25519)
             continue;
         /* create new ecdsa key (== EC_KEY) */
-        if ((eckey = EC_KEY_new()) == NULL)
-            goto builtin_err;
-        group = EC_GROUP_new_by_curve_name(nid);
-        if (group == NULL)
-            goto builtin_err;
-        if (EC_KEY_set_group(eckey, group) == 0)
+        if (!TEST_ptr(eckey = EC_KEY_new())
+                || !TEST_ptr(group = EC_GROUP_new_by_curve_name(nid))
+                || !TEST_true(EC_KEY_set_group(eckey, group)))
             goto builtin_err;
         EC_GROUP_free(group);
         degree = EC_GROUP_get_degree(EC_KEY_get0_group(eckey));
@@ -311,73 +278,50 @@ int test_builtin(BIO *out)
             eckey = NULL;
             continue;
         }
-        BIO_printf(out, &quot;%s: &quot;, OBJ_nid2sn(nid));
+        TEST_info(&quot;testing %s&quot;, OBJ_nid2sn(nid));
+
         /* create key */
-        if (!EC_KEY_generate_key(eckey)) {
-            BIO_printf(out, &quot; failed\n&quot;);
+        if (!TEST_true(EC_KEY_generate_key(eckey)))
             goto builtin_err;
-        }
         /* create second key */
-        if ((wrong_eckey = EC_KEY_new()) == NULL)
-            goto builtin_err;
-        group = EC_GROUP_new_by_curve_name(nid);
-        if (group == NULL)
-            goto builtin_err;
-        if (EC_KEY_set_group(wrong_eckey, group) == 0)
+        if (!TEST_ptr(wrong_eckey = EC_KEY_new())
+                || !TEST_ptr(group = EC_GROUP_new_by_curve_name(nid))
+                || !TEST_true(EC_KEY_set_group(wrong_eckey, group)))
             goto builtin_err;
         EC_GROUP_free(group);
-        if (!EC_KEY_generate_key(wrong_eckey)) {
-            BIO_printf(out, &quot; failed\n&quot;);
+        if (!TEST_true(EC_KEY_generate_key(wrong_eckey)))
             goto builtin_err;
-        }
 
-        BIO_printf(out, &quot;.&quot;);
-        (void)BIO_flush(out);
         /* check key */
-        if (!EC_KEY_check_key(eckey)) {
-            BIO_printf(out, &quot; failed\n&quot;);
+        if (!TEST_true(EC_KEY_check_key(eckey)))
             goto builtin_err;
-        }
-        BIO_printf(out, &quot;.&quot;);
-        (void)BIO_flush(out);
+
         /* create signature */
         sig_len = ECDSA_size(eckey);
-        if ((signature = OPENSSL_malloc(sig_len)) == NULL)
+        if (!TEST_ptr(signature = OPENSSL_malloc(sig_len))
+                || !TEST_true(ECDSA_sign(0, digest, 20, signature, &amp;sig_len,
+                                         eckey)))
             goto builtin_err;
-        if (!ECDSA_sign(0, digest, 20, signature, &amp;sig_len, eckey)) {
-            BIO_printf(out, &quot; failed\n&quot;);
-            goto builtin_err;
-        }
-        BIO_printf(out, &quot;.&quot;);
-        (void)BIO_flush(out);
+
         /* verify signature */
-        if (ECDSA_verify(0, digest, 20, signature, sig_len, eckey) != 1) {
-            BIO_printf(out, &quot; failed\n&quot;);
+        if (!TEST_int_eq(ECDSA_verify(0, digest, 20, signature, sig_len,
+                                      eckey), 1))
             goto builtin_err;
-        }
-        BIO_printf(out, &quot;.&quot;);
-        (void)BIO_flush(out);
+
         /* verify signature with the wrong key */
-        if (ECDSA_verify(0, digest, 20, signature, sig_len, wrong_eckey) == 1) {
-            BIO_printf(out, &quot; failed\n&quot;);
+        if (!TEST_int_ne(ECDSA_verify(0, digest, 20, signature, sig_len,
+                                      wrong_eckey), 1))
             goto builtin_err;
-        }
-        BIO_printf(out, &quot;.&quot;);
-        (void)BIO_flush(out);
+
         /* wrong digest */
-        if (ECDSA_verify(0, wrong_digest, 20, signature, sig_len, eckey) == 1) {
-            BIO_printf(out, &quot; failed\n&quot;);
+        if (!TEST_int_ne(ECDSA_verify(0, wrong_digest, 20, signature,
+                                      sig_len, eckey), 1))
             goto builtin_err;
-        }
-        BIO_printf(out, &quot;.&quot;);
-        (void)BIO_flush(out);
+
         /* wrong length */
-        if (ECDSA_verify(0, digest, 20, signature, sig_len - 1, eckey) == 1) {
-            BIO_printf(out, &quot; failed\n&quot;);
+        if (!TEST_int_ne(ECDSA_verify(0, digest, 20, signature,
+                                      sig_len - 1, eckey), 1))
             goto builtin_err;
-        }
-        BIO_printf(out, &quot;.&quot;);
-        (void)BIO_flush(out);
 
         /*
          * Modify a single byte of the signature: to ensure we don't garble
@@ -385,10 +329,8 @@ int test_builtin(BIO *out)
          * one of the bignums directly.
          */
         sig_ptr = signature;
-        if ((ecdsa_sig = d2i_ECDSA_SIG(NULL, &amp;sig_ptr, sig_len)) == NULL) {
-            BIO_printf(out, &quot; failed\n&quot;);
+        if (!TEST_ptr(ecdsa_sig = d2i_ECDSA_SIG(NULL, &amp;sig_ptr, sig_len)))
             goto builtin_err;
-        }
 
         ECDSA_SIG_get0(ecdsa_sig, &amp;sig_r, &amp;sig_s);
 
@@ -396,12 +338,11 @@ int test_builtin(BIO *out)
         r_len = BN_num_bytes(sig_r);
         s_len = BN_num_bytes(sig_s);
         bn_len = (degree + 7) / 8;
-        if ((r_len &gt; bn_len) || (s_len &gt; bn_len)) {
-            BIO_printf(out, &quot; failed\n&quot;);
+        if (!TEST_false(r_len &gt; bn_len)
+                || !TEST_false(s_len &gt; bn_len))
             goto builtin_err;
-        }
         buf_len = 2 * bn_len;
-        if ((raw_buf = OPENSSL_zalloc(buf_len)) == NULL)
+        if (!TEST_ptr(raw_buf = OPENSSL_zalloc(buf_len)))
             goto builtin_err;
         BN_bn2bin(sig_r, raw_buf + bn_len - r_len);
         BN_bn2bin(sig_s, raw_buf + buf_len - s_len);
@@ -410,30 +351,31 @@ int test_builtin(BIO *out)
         offset = raw_buf[10] % buf_len;
         dirt = raw_buf[11] ? raw_buf[11] : 1;
         raw_buf[offset] ^= dirt;
+
         /* Now read the BIGNUMs back in from raw_buf. */
-        modified_sig = ECDSA_SIG_new();
-        if (modified_sig == NULL)
+        if (!TEST_ptr(modified_sig = ECDSA_SIG_new()))
             goto builtin_err;
-        if (((modified_r = BN_bin2bn(raw_buf, bn_len, NULL)) == NULL)
-            || ((modified_s = BN_bin2bn(raw_buf + bn_len, bn_len, NULL)) == NULL)
-            || !ECDSA_SIG_set0(modified_sig, modified_r, modified_s)) {
+        if (!TEST_ptr(modified_r = BN_bin2bn(raw_buf, bn_len, NULL))
+                || !TEST_ptr(modified_s = BN_bin2bn(raw_buf + bn_len,
+                                                    bn_len, NULL))
+                || !TEST_true(ECDSA_SIG_set0(modified_sig,
+                                             modified_r, modified_s))) {
             BN_free(modified_r);
             BN_free(modified_s);
             goto builtin_err;
         }
         sig_ptr2 = signature;
         sig_len = i2d_ECDSA_SIG(modified_sig, &amp;sig_ptr2);
-        if (ECDSA_verify(0, digest, 20, signature, sig_len, eckey) == 1) {
-            BIO_printf(out, &quot; failed\n&quot;);
+        if (!TEST_false(ECDSA_verify(0, digest, 20, signature, sig_len, eckey)))
             goto builtin_err;
-        }
-        /*
-         * Sanity check: undo the modification and verify signature.
-         */
+
+        /* Sanity check: undo the modification and verify signature. */
         raw_buf[offset] ^= dirt;
-        if (((unmodified_r = BN_bin2bn(raw_buf, bn_len, NULL)) == NULL)
-            || ((unmodified_s = BN_bin2bn(raw_buf + bn_len, bn_len, NULL)) == NULL)
-            || !ECDSA_SIG_set0(modified_sig, unmodified_r, unmodified_s)) {
+        if (!TEST_ptr(unmodified_r = BN_bin2bn(raw_buf, bn_len, NULL))
+                || !TEST_ptr(unmodified_s = BN_bin2bn(raw_buf + bn_len,
+                                                       bn_len, NULL))
+                || !TEST_true(ECDSA_SIG_set0(modified_sig, unmodified_r,
+                                             unmodified_s))) {
             BN_free(unmodified_r);
             BN_free(unmodified_s);
             goto builtin_err;
@@ -441,16 +383,10 @@ int test_builtin(BIO *out)
 
         sig_ptr2 = signature;
         sig_len = i2d_ECDSA_SIG(modified_sig, &amp;sig_ptr2);
-        if (ECDSA_verify(0, digest, 20, signature, sig_len, eckey) != 1) {
-            BIO_printf(out, &quot; failed\n&quot;);
+        if (!TEST_true(ECDSA_verify(0, digest, 20, signature, sig_len, eckey)))
             goto builtin_err;
-        }
-        BIO_printf(out, &quot;.&quot;);
-        (void)BIO_flush(out);
 
-        BIO_printf(out, &quot; ok\n&quot;);
         /* cleanup */
-        /* clean bogus errors */
         ERR_clear_error();
         OPENSSL_free(signature);
         signature = NULL;
@@ -479,41 +415,11 @@ int test_builtin(BIO *out)
     return ret;
 }
 
-int main(void)
+void register_tests(void)
 {
-    int ret = 1;
-    BIO *out;
-    char *p;
-
-    out = BIO_new_fp(stdout, BIO_NOCLOSE | BIO_FP_TEXT);
-
-    p = getenv(&quot;OPENSSL_DEBUG_MEMORY&quot;);
-    if (p != NULL &amp;&amp; strcmp(p, &quot;on&quot;) == 0)
-        CRYPTO_set_mem_debug(1);
-
     /* initialize the prng */
     RAND_seed(rnd_seed, sizeof(rnd_seed));
-
-    /* the tests */
-    if (!x9_62_tests(out))
-        goto err;
-    if (!test_builtin(out))
-        goto err;
-
-    ret = 0;
- err:
-    if (ret)
-        BIO_printf(out, &quot;\nECDSA test failed\n&quot;);
-    else
-        BIO_printf(out, &quot;\nECDSA test passed\n&quot;);
-    if (ret)
-        ERR_print_errors(out);
-
-#ifndef OPENSSL_NO_CRYPTO_MDEBUG
-    if (CRYPTO_mem_leaks(out) &lt;= 0)
-        ret = 1;
-#endif
-    BIO_free(out);
-    return ret;
+    ADD_TEST(x9_62_tests);
+    ADD_TEST(test_builtin);
 }
 #endif
diff --git a/test/enginetest.c b/test/enginetest.c
index 21cd20a..89107a3 100644
--- a/test/enginetest.c
+++ b/test/enginetest.c
@@ -22,21 +22,20 @@ int main(int argc, char *argv[])
 # include &lt;openssl/crypto.h&gt;
 # include &lt;openssl/engine.h&gt;
 # include &lt;openssl/err.h&gt;
+# include &quot;testutil.h&quot;
+# include &quot;test_main.h&quot;
 
 static void display_engine_list(void)
 {
     ENGINE *h;
     int loop;
 
-    h = ENGINE_get_first();
     loop = 0;
-    printf(&quot;listing available engine types\n&quot;);
-    while (h) {
-        printf(&quot;engine %i, id = \&quot;%s\&quot;, name = \&quot;%s\&quot;\n&quot;,
+    for (h = ENGINE_get_first(); h != NULL; h = ENGINE_get_next(h)) {
+        TEST_info(&quot;#%d: id = \&quot;%s\&quot;, name = \&quot;%s\&quot;&quot;,
                loop++, ENGINE_get_id(h), ENGINE_get_name(h));
-        h = ENGINE_get_next(h);
     }
-    printf(&quot;end of list\n&quot;);
+
     /*
      * ENGINE_get_first() increases the struct_ref counter, so we must call
      * ENGINE_free() to decrease it again
@@ -44,161 +43,146 @@ static void display_engine_list(void)
     ENGINE_free(h);
 }
 
-int main(int argc, char *argv[])
+#define NUMTOADD 512
+
+static int test_engines(void)
 {
-    ENGINE *block[512];
+    ENGINE *block[NUMTOADD];
     char buf[256];
-    const char *id, *name, *p;
+    const char *id, *name;
     ENGINE *ptr;
     int loop;
-    int to_return = 1;
+    int to_return = 0;
     ENGINE *new_h1 = NULL;
     ENGINE *new_h2 = NULL;
     ENGINE *new_h3 = NULL;
     ENGINE *new_h4 = NULL;
 
-    p = getenv(&quot;OPENSSL_DEBUG_MEMORY&quot;);
-    if (p != NULL &amp;&amp; strcmp(p, &quot;on&quot;) == 0)
-        CRYPTO_set_mem_debug(1);
-
     memset(block, 0, sizeof(block));
-    if (((new_h1 = ENGINE_new()) == NULL) ||
-        !ENGINE_set_id(new_h1, &quot;test_id0&quot;) ||
-        !ENGINE_set_name(new_h1, &quot;First test item&quot;) ||
-        ((new_h2 = ENGINE_new()) == NULL) ||
-        !ENGINE_set_id(new_h2, &quot;test_id1&quot;) ||
-        !ENGINE_set_name(new_h2, &quot;Second test item&quot;) ||
-        ((new_h3 = ENGINE_new()) == NULL) ||
-        !ENGINE_set_id(new_h3, &quot;test_id2&quot;) ||
-        !ENGINE_set_name(new_h3, &quot;Third test item&quot;) ||
-        ((new_h4 = ENGINE_new()) == NULL) ||
-        !ENGINE_set_id(new_h4, &quot;test_id3&quot;) ||
-        !ENGINE_set_name(new_h4, &quot;Fourth test item&quot;)) {
-        printf(&quot;Couldn't set up test ENGINE structures\n&quot;);
+    if (!TEST_ptr(new_h1 = ENGINE_new())
+            || !TEST_true(ENGINE_set_id(new_h1, &quot;test_id0&quot;))
+            || !TEST_true(ENGINE_set_name(new_h1, &quot;First test item&quot;))
+            || !TEST_ptr(new_h2 = ENGINE_new())
+            || !TEST_true(ENGINE_set_id(new_h2, &quot;test_id1&quot;))
+            || !TEST_true(ENGINE_set_name(new_h2, &quot;Second test item&quot;))
+            || !TEST_ptr(new_h3 = ENGINE_new())
+            || !TEST_true(ENGINE_set_id(new_h3, &quot;test_id2&quot;))
+            || !TEST_true(ENGINE_set_name(new_h3, &quot;Third test item&quot;))
+            || !TEST_ptr(new_h4 = ENGINE_new())
+            || !TEST_true(ENGINE_set_id(new_h4, &quot;test_id3&quot;))
+            || !TEST_true(ENGINE_set_name(new_h4, &quot;Fourth test item&quot;)))
         goto end;
-    }
-    printf(&quot;\nenginetest beginning\n\n&quot;);
+    TEST_info(&quot;Engines:&quot;);
     display_engine_list();
-    if (!ENGINE_add(new_h1)) {
-        printf(&quot;Add failed!\n&quot;);
+
+    if (!TEST_true(ENGINE_add(new_h1)))
         goto end;
-    }
+    TEST_info(&quot;Engines:&quot;);
     display_engine_list();
+
     ptr = ENGINE_get_first();
-    if (!ENGINE_remove(ptr)) {
-        printf(&quot;Remove failed!\n&quot;);
+    if (!TEST_true(ENGINE_remove(ptr)))
         goto end;
-    }
     ENGINE_free(ptr);
+    TEST_info(&quot;Engines:&quot;);
     display_engine_list();
-    if (!ENGINE_add(new_h3) || !ENGINE_add(new_h2)) {
-        printf(&quot;Add failed!\n&quot;);
+
+    if (!TEST_true(ENGINE_add(new_h3))
+            || !TEST_true(ENGINE_add(new_h2)))
         goto end;
-    }
+    TEST_info(&quot;Engines:&quot;);
     display_engine_list();
-    if (!ENGINE_remove(new_h2)) {
-        printf(&quot;Remove failed!\n&quot;);
+
+    if (!TEST_true(ENGINE_remove(new_h2)))
         goto end;
-    }
+    TEST_info(&quot;Engines:&quot;);
     display_engine_list();
-    if (!ENGINE_add(new_h4)) {
-        printf(&quot;Add failed!\n&quot;);
+
+    if (!TEST_true(ENGINE_add(new_h4)))
         goto end;
-    }
+    TEST_info(&quot;Engines:&quot;);
     display_engine_list();
-    if (ENGINE_add(new_h3)) {
-        printf(&quot;Add *should* have failed but didn't!\n&quot;);
+
+    /* Should fail. */
+    if (!TEST_false(ENGINE_add(new_h3)))
         goto end;
-    } else
-        printf(&quot;Add that should fail did.\n&quot;);
     ERR_clear_error();
-    if (ENGINE_remove(new_h2)) {
-        printf(&quot;Remove *should* have failed but didn't!\n&quot;);
+
+    /* Should fail. */
+    if (!TEST_false(ENGINE_remove(new_h2)))
         goto end;
-    } else
-        printf(&quot;Remove that should fail did.\n&quot;);
     ERR_clear_error();
-    if (!ENGINE_remove(new_h3)) {
-        printf(&quot;Remove failed!\n&quot;);
+
+    if (!TEST_true(ENGINE_remove(new_h3)))
         goto end;
-    }
+    TEST_info(&quot;Engines:&quot;);
     display_engine_list();
-    if (!ENGINE_remove(new_h4)) {
-        printf(&quot;Remove failed!\n&quot;);
+
+    if (!TEST_true(ENGINE_remove(new_h4)))
         goto end;
-    }
+    TEST_info(&quot;Engines:&quot;);
     display_engine_list();
+
     /*
      * Depending on whether there's any hardware support compiled in, this
      * remove may be destined to fail.
      */
-    ptr = ENGINE_get_first();
-    if (ptr)
+    if ((ptr = ENGINE_get_first()) != NULL) {
         if (!ENGINE_remove(ptr))
-            printf(&quot;Remove failed!i - probably no hardware &quot;
-                   &quot;support present.\n&quot;);
+            TEST_info(&quot;Remove failed - probably no hardware support present&quot;);
+    }
     ENGINE_free(ptr);
+    TEST_info(&quot;Engines:&quot;);
     display_engine_list();
-    if (!ENGINE_add(new_h1) || !ENGINE_remove(new_h1)) {
-        printf(&quot;Couldn't add and remove to an empty list!\n&quot;);
+
+    if (!TEST_true(ENGINE_add(new_h1))
+            || !TEST_true(ENGINE_remove(new_h1)))
         goto end;
-    } else
-        printf(&quot;Successfully added and removed to an empty list!\n&quot;);
-    printf(&quot;About to beef up the engine-type list\n&quot;);
-    for (loop = 0; loop &lt; 512; loop++) {
-        sprintf(buf, &quot;id%i&quot;, loop);
+
+    TEST_info(&quot;About to beef up the engine-type list&quot;);
+    for (loop = 0; loop &lt; NUMTOADD; loop++) {
+        sprintf(buf, &quot;id%d&quot;, loop);
         id = OPENSSL_strdup(buf);
-        sprintf(buf, &quot;Fake engine type %i&quot;, loop);
+        sprintf(buf, &quot;Fake engine type %d&quot;, loop);
         name = OPENSSL_strdup(buf);
-        if (((block[loop] = ENGINE_new()) == NULL) ||
-            !ENGINE_set_id(block[loop], id) ||
-            !ENGINE_set_name(block[loop], name)) {
-            printf(&quot;Couldn't create block of ENGINE structures.\n&quot;
-                   &quot;I'll probably also core-dump now, damn.\n&quot;);
+        if (!TEST_ptr(block[loop] = ENGINE_new())
+                || !TEST_true(ENGINE_set_id(block[loop], id))
+                || !TEST_true(ENGINE_set_name(block[loop], name)))
             goto end;
-        }
     }
-    for (loop = 0; loop &lt; 512; loop++) {
-        if (!ENGINE_add(block[loop])) {
-            printf(&quot;\nAdding stopped at %i, (%s,%s)\n&quot;,
+    for (loop = 0; loop &lt; NUMTOADD; loop++) {
+        if (!TEST_true(ENGINE_add(block[loop]))) {
+            printf(&quot;Adding stopped at %d, (%s,%s)&quot;,
                    loop, ENGINE_get_id(block[loop]),
                    ENGINE_get_name(block[loop]));
             goto cleanup_loop;
-        } else
-            printf(&quot;.&quot;);
-        fflush(stdout);
+        }
     }
  cleanup_loop:
-    printf(&quot;\nAbout to empty the engine-type list\n&quot;);
+    TEST_info(&quot;About to empty the engine-type list&quot;);
     while ((ptr = ENGINE_get_first()) != NULL) {
-        if (!ENGINE_remove(ptr)) {
-            printf(&quot;\nRemove failed!\n&quot;);
+        if (!TEST_true(ENGINE_remove(ptr)))
             goto end;
-        }
         ENGINE_free(ptr);
-        printf(&quot;.&quot;);
-        fflush(stdout);
     }
-    for (loop = 0; loop &lt; 512; loop++) {
+    for (loop = 0; loop &lt; NUMTOADD; loop++) {
         OPENSSL_free((void *)ENGINE_get_id(block[loop]));
         OPENSSL_free((void *)ENGINE_get_name(block[loop]));
     }
-    printf(&quot;\nTests completed happily\n&quot;);
-    to_return = 0;
+    to_return = 1;
+
  end:
-    if (to_return)
-        ERR_print_errors_fp(stderr);
     ENGINE_free(new_h1);
     ENGINE_free(new_h2);
     ENGINE_free(new_h3);
     ENGINE_free(new_h4);
-    for (loop = 0; loop &lt; 512; loop++)
+    for (loop = 0; loop &lt; NUMTOADD; loop++)
         ENGINE_free(block[loop]);
-
-#ifndef OPENSSL_NO_CRYPTO_MDEBUG
-    if (CRYPTO_mem_leaks_fp(stderr) &lt;= 0)
-        to_return = 1;
-#endif
     return to_return;
 }
+
+void register_tests(void)
+{
+    ADD_TEST(test_engines);
+}
 #endif
diff --git a/test/pbelutest.c b/test/pbelutest.c
index e226d43..11189b4 100644
--- a/test/pbelutest.c
+++ b/test/pbelutest.c
@@ -8,40 +8,49 @@
  */
 
 #include &lt;openssl/evp.h&gt;
-#include &lt;stdio.h&gt;
-#include &lt;string.h&gt;
+#include &quot;testutil.h&quot;
+#include &quot;test_main.h&quot;
 
 /*
  * Password based encryption (PBE) table ordering test.
  * Attempt to look up all supported algorithms.
  */
 
-int main(int argc, char **argv)
+static int test_pbelu(void)
 {
-    size_t i;
-    int rv = 0;
-    int pbe_type, pbe_nid;
-    int last_type = -1, last_nid = -1;
+    int i, failed = 0, ok;
+    int pbe_type, pbe_nid, last_type = -1, last_nid = -1;
+
     for (i = 0; EVP_PBE_get(&amp;pbe_type, &amp;pbe_nid, i) != 0; i++) {
-        if (EVP_PBE_find(pbe_type, pbe_nid, NULL, NULL, 0) == 0) {
-            rv = 1;
+        if (!TEST_true(EVP_PBE_find(pbe_type, pbe_nid, NULL, NULL, 0))) {
+            TEST_info(&quot;i=%d, pbe_type=%d, pbe_nid=%d&quot;, i, pbe_type, pbe_nid);
+            failed = 1;
             break;
         }
     }
-    if (rv == 0)
-        return 0;
+
+    if (!failed)
+        return 1;
+
     /* Error: print out whole table */
     for (i = 0; EVP_PBE_get(&amp;pbe_type, &amp;pbe_nid, i) != 0; i++) {
         if (pbe_type &gt; last_type)
-            rv = 0;
+            ok = 0;
         else if (pbe_type &lt; last_type || pbe_nid &lt; last_nid)
-            rv = 1;
+            ok = 1;
         else
-            rv = 0;
-        fprintf(stderr, &quot;PBE type=%d %d (%s): %s\n&quot;, pbe_type, pbe_nid,
-                OBJ_nid2sn(pbe_nid), rv ? &quot;ERROR&quot; : &quot;OK&quot;);
+            ok = 0;
+        if (!ok)
+            failed = 1;
+        TEST_info(&quot;PBE type=%d %d (%s): %s\n&quot;, pbe_type, pbe_nid,
+                OBJ_nid2sn(pbe_nid), ok ? &quot;ERROR&quot; : &quot;OK&quot;);
         last_type = pbe_type;
         last_nid = pbe_nid;
     }
-    return 1;
+    return failed ? 0 : 1;
+}
+
+void register_tests(void)
+{
+    ADD_TEST(test_pbelu);
 }
diff --git a/test/recordlentest.c b/test/recordlentest.c
index b9d868f..7063149 100644
--- a/test/recordlentest.c
+++ b/test/recordlentest.c
@@ -103,11 +103,9 @@ static int test_record_overflow(int idx)
 
     ERR_clear_error();
 
-    if (!create_ssl_ctx_pair(TLS_server_method(), TLS_client_method(), &amp;sctx,
-                             &amp;cctx, cert, privkey)) {
-        printf(&quot;Unable to create SSL_CTX pair\n&quot;);
+    if (!TEST_true(create_ssl_ctx_pair(TLS_server_method(), TLS_client_method(),
+                                       &amp;sctx, &amp;cctx, cert, privkey)))
         goto end;
-    }
 
     if (idx == TEST_ENCRYPTED_OVERFLOW_TLS1_2_OK
             || idx == TEST_ENCRYPTED_OVERFLOW_TLS1_2_NOT_OK) {
@@ -121,10 +119,9 @@ static int test_record_overflow(int idx)
         len = SSL3_RT_MAX_TLS13_ENCRYPTED_LENGTH;
     }
 
-    if (!create_ssl_objects(sctx, cctx, &amp;serverssl, &amp;clientssl, NULL, NULL)) {
-        printf(&quot;Unable to create SSL objects\n&quot;);
+    if (!TEST_true(create_ssl_objects(sctx, cctx, &amp;serverssl, &amp;clientssl,
+                                      NULL, NULL)))
         goto end;
-    }
 
     serverbio = SSL_get_rbio(serverssl);
 
@@ -135,29 +132,23 @@ static int test_record_overflow(int idx)
         if (idx == TEST_PLAINTEXT_OVERFLOW_NOT_OK)
             len++;
 
-        if (!write_record(serverbio, len, SSL3_RT_HANDSHAKE, TLS1_VERSION)) {
-            printf(&quot;Unable to write plaintext record\n&quot;);
+        if (!TEST_true(write_record(serverbio, len,
+                                    SSL3_RT_HANDSHAKE, TLS1_VERSION)))
             goto end;
-        }
 
-        if (SSL_accept(serverssl) &gt; 0) {
-            printf(&quot;Unexpected success reading plaintext record\n&quot;);
+        if (!TEST_int_le(SSL_accept(serverssl), 0))
             goto end;
-        }
 
         overf_expected = (idx == TEST_PLAINTEXT_OVERFLOW_OK) ? 0 : 1;
-        if (fail_due_to_record_overflow(0) != overf_expected) {
-            printf(&quot;Unexpected error value received\n&quot;);
+        if (!TEST_int_eq(fail_due_to_record_overflow(0), overf_expected))
             goto end;
-        }
 
         goto success;
     }
 
-    if (!create_ssl_connection(serverssl, clientssl, SSL_ERROR_NONE)) {
-        printf(&quot;Unable to create SSL connection\n&quot;);
+    if (!TEST_true(create_ssl_connection(serverssl, clientssl,
+                                         SSL_ERROR_NONE)))
         goto end;
-    }
 
     if (idx == TEST_ENCRYPTED_OVERFLOW_TLS1_2_NOT_OK
             || idx == TEST_ENCRYPTED_OVERFLOW_TLS1_3_NOT_OK) {
@@ -173,32 +164,24 @@ static int test_record_overflow(int idx)
     else
         recversion = TLS1_2_VERSION;
 
-    if (!write_record(serverbio, len, SSL3_RT_APPLICATION_DATA, recversion)) {
-        printf(&quot;Unable to write encrypted record\n&quot;);
+    if (!TEST_true(write_record(serverbio, len, SSL3_RT_APPLICATION_DATA,
+                                recversion)))
         goto end;
-    }
 
-    if (SSL_read_ex(serverssl, &amp;buf, sizeof(buf), &amp;written)) {
-        printf(&quot;Unexpected success reading encrypted record\n&quot;);
+    if (!TEST_false(SSL_read_ex(serverssl, &amp;buf, sizeof(buf), &amp;written)))
         goto end;
-    }
 
-    if (fail_due_to_record_overflow(1) != overf_expected) {
-        printf(&quot;Unexpected error value received\n&quot;);
+    if (!TEST_int_eq(fail_due_to_record_overflow(1), overf_expected))
         goto end;
-    }
 
  success:
     testresult = 1;
 
  end:
-    if(!testresult)
-        ERR_print_errors_fp(stdout);
     SSL_free(serverssl);
     SSL_free(clientssl);
     SSL_CTX_free(sctx);
     SSL_CTX_free(cctx);
-
     return testresult;
 }
 
@@ -207,10 +190,9 @@ int test_main(int argc, char *argv[])
     int testresult = 1;
 
     if (argc != 3) {
-        printf(&quot;Invalid argument count\n&quot;);
+        TEST_error(&quot;Invalid argument count&quot;);
         return 1;
     }
-
     cert = argv[1];
     privkey = argv[2];
 
diff --git a/test/srptest.c b/test/srptest.c
index 73b3881..6d14571 100644
--- a/test/srptest.c
+++ b/test/srptest.c
@@ -23,13 +23,23 @@ int main(int argc, char *argv[])
 # include &lt;openssl/srp.h&gt;
 # include &lt;openssl/rand.h&gt;
 # include &lt;openssl/err.h&gt;
+# include &quot;testutil.h&quot;
+# include &quot;test_main.h&quot;
 
 static void showbn(const char *name, const BIGNUM *bn)
 {
-    fputs(name, stdout);
-    fputs(&quot; = &quot;, stdout);
-    BN_print_fp(stdout, bn);
-    putc('\n', stdout);
+    BIO *b;
+    const char *text;
+    
+    if (!TEST_ptr(b = BIO_new(BIO_s_mem())))
+        return;
+    BIO_write(b, name, strlen(name));
+    BIO_write(b, &quot; = &quot;, 3);
+    BN_print(b, bn);
+    BIO_write(b, &quot;\0&quot;, 1);
+    BIO_get_mem_data(b, &amp;text);
+    TEST_info(&quot;%s&quot;, text);
+    BIO_free(b);
 }
 
 # define RANDOM_SIZE 32         /* use 256 bits on each side */
@@ -37,7 +47,7 @@ static void showbn(const char *name, const BIGNUM *bn)
 static int run_srp(const char *username, const char *client_pass,
                    const char *server_pass)
 {
-    int ret = -1;
+    int ret = 0;
     BIGNUM *s = NULL;
     BIGNUM *v = NULL;
     BIGNUM *a = NULL;
@@ -50,17 +60,15 @@ static int run_srp(const char *username, const char *client_pass,
     BIGNUM *Kserver = NULL;
     unsigned char rand_tmp[RANDOM_SIZE];
     /* use builtin 1024-bit params */
-    const SRP_gN *GN = SRP_get_default_gN(&quot;1024&quot;);
+    const SRP_gN *GN;
+    
+    if (!TEST_ptr(GN = SRP_get_default_gN(&quot;1024&quot;)))
+        return 0;
 
-    if (GN == NULL) {
-        fprintf(stderr, &quot;Failed to get SRP parameters\n&quot;);
-        return -1;
-    }
     /* Set up server's password entry */
-    if (!SRP_create_verifier_BN(username, server_pass, &amp;s, &amp;v, GN-&gt;N, GN-&gt;g)) {
-        fprintf(stderr, &quot;Failed to create SRP verifier\n&quot;);
-        return -1;
-    }
+    if (!TEST_true(SRP_create_verifier_BN(username, server_pass,
+                                          &amp;s, &amp;v, GN-&gt;N, GN-&gt;g)))
+        goto end;
 
     showbn(&quot;N&quot;, GN-&gt;N);
     showbn(&quot;g&quot;, GN-&gt;g);
@@ -70,32 +78,30 @@ static int run_srp(const char *username, const char *client_pass,
     /* Server random */
     RAND_bytes(rand_tmp, sizeof(rand_tmp));
     b = BN_bin2bn(rand_tmp, sizeof(rand_tmp), NULL);
-    /* TODO - check b != 0 */
+    if (!TEST_false(BN_is_zero(b)))
+        goto end;
     showbn(&quot;b&quot;, b);
 
     /* Server's first message */
     Bpub = SRP_Calc_B(b, GN-&gt;N, GN-&gt;g, v);
     showbn(&quot;B&quot;, Bpub);
 
-    if (!SRP_Verify_B_mod_N(Bpub, GN-&gt;N)) {
-        fprintf(stderr, &quot;Invalid B\n&quot;);
-        return -1;
-    }
+    if (!TEST_true(SRP_Verify_B_mod_N(Bpub, GN-&gt;N)))
+        goto end;
 
     /* Client random */
     RAND_bytes(rand_tmp, sizeof(rand_tmp));
     a = BN_bin2bn(rand_tmp, sizeof(rand_tmp), NULL);
-    /* TODO - check a != 0 */
+    if (!TEST_false(BN_is_zero(a)))
+        goto end;
     showbn(&quot;a&quot;, a);
 
     /* Client's response */
     Apub = SRP_Calc_A(a, GN-&gt;N, GN-&gt;g);
     showbn(&quot;A&quot;, Apub);
 
-    if (!SRP_Verify_A_mod_N(Apub, GN-&gt;N)) {
-        fprintf(stderr, &quot;Invalid A\n&quot;);
-        return -1;
-    }
+    if (!TEST_true(SRP_Verify_A_mod_N(Apub, GN-&gt;N)))
+        goto end;
 
     /* Both sides calculate u */
     u = SRP_Calc_u(Apub, Bpub, GN-&gt;N);
@@ -109,13 +115,12 @@ static int run_srp(const char *username, const char *client_pass,
     Kserver = SRP_Calc_server_key(Apub, v, u, b, GN-&gt;N);
     showbn(&quot;Server's key&quot;, Kserver);
 
-    if (BN_cmp(Kclient, Kserver) == 0) {
-        ret = 0;
-    } else {
-        fprintf(stderr, &quot;Keys mismatch\n&quot;);
-        ret = 1;
-    }
+    if (!TEST_int_eq(BN_cmp(Kclient, Kserver), 0))
+        goto end;
+
+    ret = 1;
 
+end:
     BN_clear_free(Kclient);
     BN_clear_free(Kserver);
     BN_clear_free(x);
@@ -133,25 +138,19 @@ static int run_srp(const char *username, const char *client_pass,
 static int check_bn(const char *name, const BIGNUM *bn, const char *hexbn)
 {
     BIGNUM *tmp = NULL;
-    int rv;
-    if (BN_hex2bn(&amp;tmp, hexbn) == 0)
+
+    if (!TEST_true(BN_hex2bn(&amp;tmp, hexbn)))
         return 0;
-    rv = BN_cmp(bn, tmp);
-    if (rv == 0) {
-        printf(&quot;%s = &quot;, name);
-        BN_print_fp(stdout, bn);
-        printf(&quot;\n&quot;);
+
+    if (!TEST_int_eq(BN_cmp(bn, tmp), 0)) {
+        TEST_info(&quot;Unexpected %s value&quot;, name);
+        showbn(&quot;expecting&quot;, tmp);
+        showbn(&quot;received&quot;, bn);
         BN_free(tmp);
-        return 1;
+        return 0;
     }
-    printf(&quot;Unexpected %s value\n&quot;, name);
-    printf(&quot;Expecting: &quot;);
-    BN_print_fp(stdout, tmp);
-    printf(&quot;\nReceived: &quot;);
-    BN_print_fp(stdout, bn);
-    printf(&quot;\n&quot;);
     BN_free(tmp);
-    return 0;
+    return 1;
 }
 
 /* SRP test vectors from RFC5054 */
@@ -169,26 +168,22 @@ static int run_srp_kat(void)
     BIGNUM *Kclient = NULL;
     BIGNUM *Kserver = NULL;
     /* use builtin 1024-bit params */
-    const SRP_gN *GN = SRP_get_default_gN(&quot;1024&quot;);
-
-    if (GN == NULL) {
-        fprintf(stderr, &quot;Failed to get SRP parameters\n&quot;);
+    const SRP_gN *GN;
+        
+    if (!TEST_ptr(GN = SRP_get_default_gN(&quot;1024&quot;)))
         goto err;
-    }
     BN_hex2bn(&amp;s, &quot;BEB25379D1A8581EB5A727673A2441EE&quot;);
     /* Set up server's password entry */
-    if (!SRP_create_verifier_BN(&quot;alice&quot;, &quot;password123&quot;, &amp;s, &amp;v, GN-&gt;N,
-                                GN-&gt;g)) {
-        fprintf(stderr, &quot;Failed to create SRP verifier\n&quot;);
+    if (!TEST_true(SRP_create_verifier_BN(&quot;alice&quot;, &quot;password123&quot;, &amp;s, &amp;v, GN-&gt;N,
+                                GN-&gt;g)))
         goto err;
-    }
 
-    if (!check_bn(&quot;v&quot;, v,
+    if (!TEST_true(check_bn(&quot;v&quot;, v,
                  &quot;7E273DE8696FFC4F4E337D05B4B375BEB0DDE1569E8FA00A9886D812&quot;
                  &quot;9BADA1F1822223CA1A605B530E379BA4729FDC59F105B4787E5186F5&quot;
                  &quot;C671085A1447B52A48CF1970B4FB6F8400BBF4CEBFBB168152E08AB5&quot;
                  &quot;EA53D15C1AFF87B2B9DA6E04E058AD51CC72BFC9033B564E26480D78&quot;
-                 &quot;E955A5E29E7AB245DB2BE315E2099AFB&quot;))
+                 &quot;E955A5E29E7AB245DB2BE315E2099AFB&quot;)))
         goto err;
 
     /* Server random */
@@ -197,18 +192,15 @@ static int run_srp_kat(void)
 
     /* Server's first message */
     Bpub = SRP_Calc_B(b, GN-&gt;N, GN-&gt;g, v);
-
-    if (!SRP_Verify_B_mod_N(Bpub, GN-&gt;N)) {
-        fprintf(stderr, &quot;Invalid B\n&quot;);
+    if (!TEST_true(SRP_Verify_B_mod_N(Bpub, GN-&gt;N)))
         goto err;
-    }
 
-    if (!check_bn(&quot;B&quot;, Bpub,
+    if (!TEST_true(check_bn(&quot;B&quot;, Bpub,
                   &quot;BD0C61512C692C0CB6D041FA01BB152D4916A1E77AF46AE105393011&quot;
                   &quot;BAF38964DC46A0670DD125B95A981652236F99D9B681CBF87837EC99&quot;
                   &quot;6C6DA04453728610D0C6DDB58B318885D7D82C7F8DEB75CE7BD4FBAA&quot;
                   &quot;37089E6F9C6059F388838E7A00030B331EB76840910440B1B27AAEAE&quot;
-                  &quot;EB4012B7D7665238A8E3FB004B117B58&quot;))
+                  &quot;EB4012B7D7665238A8E3FB004B117B58&quot;)))
         goto err;
 
     /* Client random */
@@ -217,49 +209,48 @@ static int run_srp_kat(void)
 
     /* Client's response */
     Apub = SRP_Calc_A(a, GN-&gt;N, GN-&gt;g);
+    if (!TEST_true(SRP_Verify_A_mod_N(Apub, GN-&gt;N)))
+        goto err;
 
-    if (!SRP_Verify_A_mod_N(Apub, GN-&gt;N)) {
-        fprintf(stderr, &quot;Invalid A\n&quot;);
-        return -1;
-    }
-
-    if (!check_bn(&quot;A&quot;, Apub,
+    if (!TEST_true(check_bn(&quot;A&quot;, Apub,
                   &quot;61D5E490F6F1B79547B0704C436F523DD0E560F0C64115BB72557EC4&quot;
                   &quot;4352E8903211C04692272D8B2D1A5358A2CF1B6E0BFCF99F921530EC&quot;
                   &quot;8E39356179EAE45E42BA92AEACED825171E1E8B9AF6D9C03E1327F44&quot;
                   &quot;BE087EF06530E69F66615261EEF54073CA11CF5858F0EDFDFE15EFEA&quot;
-                  &quot;B349EF5D76988A3672FAC47B0769447B&quot;))
+                  &quot;B349EF5D76988A3672FAC47B0769447B&quot;)))
         goto err;
 
     /* Both sides calculate u */
     u = SRP_Calc_u(Apub, Bpub, GN-&gt;N);
 
-    if (!check_bn(&quot;u&quot;, u, &quot;CE38B9593487DA98554ED47D70A7AE5F462EF019&quot;))
+    if (!TEST_true(check_bn(&quot;u&quot;, u,
+                    &quot;CE38B9593487DA98554ED47D70A7AE5F462EF019&quot;)))
         goto err;
 
     /* Client's key */
     x = SRP_Calc_x(s, &quot;alice&quot;, &quot;password123&quot;);
     Kclient = SRP_Calc_client_key(GN-&gt;N, Bpub, GN-&gt;g, x, a, u);
-    if (!check_bn(&quot;Client's key&quot;, Kclient,
+    if (!TEST_true(check_bn(&quot;Client's key&quot;, Kclient,
                   &quot;B0DC82BABCF30674AE450C0287745E7990A3381F63B387AAF271A10D&quot;
                   &quot;233861E359B48220F7C4693C9AE12B0A6F67809F0876E2D013800D6C&quot;
                   &quot;41BB59B6D5979B5C00A172B4A2A5903A0BDCAF8A709585EB2AFAFA8F&quot;
                   &quot;3499B200210DCC1F10EB33943CD67FC88A2F39A4BE5BEC4EC0A3212D&quot;
-                  &quot;C346D7E474B29EDE8A469FFECA686E5A&quot;))
+                  &quot;C346D7E474B29EDE8A469FFECA686E5A&quot;)))
         goto err;
+
     /* Server's key */
     Kserver = SRP_Calc_server_key(Apub, v, u, b, GN-&gt;N);
-    if (!check_bn(&quot;Server's key&quot;, Kserver,
+    if (!TEST_true(check_bn(&quot;Server's key&quot;, Kserver,
                   &quot;B0DC82BABCF30674AE450C0287745E7990A3381F63B387AAF271A10D&quot;
                   &quot;233861E359B48220F7C4693C9AE12B0A6F67809F0876E2D013800D6C&quot;
                   &quot;41BB59B6D5979B5C00A172B4A2A5903A0BDCAF8A709585EB2AFAFA8F&quot;
                   &quot;3499B200210DCC1F10EB33943CD67FC88A2F39A4BE5BEC4EC0A3212D&quot;
-                  &quot;C346D7E474B29EDE8A469FFECA686E5A&quot;))
+                  &quot;C346D7E474B29EDE8A469FFECA686E5A&quot;)))
         goto err;
 
     ret = 1;
 
-    err:
+err:
     BN_clear_free(Kclient);
     BN_clear_free(Kserver);
     BN_clear_free(x);
@@ -274,39 +265,22 @@ static int run_srp_kat(void)
     return ret;
 }
 
-int main(int argc, char **argv)
+static int run_srp_tests(void)
 {
-    BIO *bio_err;
-    bio_err = BIO_new_fp(stderr, BIO_NOCLOSE | BIO_FP_TEXT);
-
-    CRYPTO_set_mem_debug(1);
-    CRYPTO_mem_ctrl(CRYPTO_MEM_CHECK_ON);
-
-
     /* &quot;Negative&quot; test, expect a mismatch */
-    if (run_srp(&quot;alice&quot;, &quot;password1&quot;, &quot;password2&quot;) == 0) {
-        fprintf(stderr, &quot;Mismatched SRP run failed\n&quot;);
-        return 1;
-    }
+    if (!TEST_false(run_srp(&quot;alice&quot;, &quot;password1&quot;, &quot;password2&quot;)))
+        return 0;
 
     /* &quot;Positive&quot; test, should pass */
-    if (run_srp(&quot;alice&quot;, &quot;password&quot;, &quot;password&quot;) != 0) {
-        fprintf(stderr, &quot;Plain SRP run failed\n&quot;);
-        return 1;
-    }
-
-    /* KAT from RFC5054: should pass */
-    if (run_srp_kat() != 1) {
-        fprintf(stderr, &quot;SRP KAT failed\n&quot;);
-        return 1;
-    }
+    if (!TEST_true(run_srp(&quot;alice&quot;, &quot;password&quot;, &quot;password&quot;)))
+        return 0;
 
-#ifndef OPENSSL_NO_CRYPTO_MDEBUG
-    if (CRYPTO_mem_leaks(bio_err) &lt;= 0)
-        return 1;
-#endif
-    BIO_free(bio_err);
+    return 1;
+}
 
-    return 0;
+void register_tests(void)
+{
+    ADD_TEST(run_srp_tests);
+    ADD_TEST(run_srp_kat);
 }
 #endif
</PRE>




















<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="014194.html">[openssl-commits] [openssl]  master update
</A></li>
	<LI>Next message: <A HREF="014198.html">[openssl-commits] [openssl]  master update
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#14197">[ date ]</a>
              <a href="thread.html#14197">[ thread ]</a>
              <a href="subject.html#14197">[ subject ]</a>
              <a href="author.html#14197">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="../../../mailman/listinfo/openssl-commits.html">More information about the openssl-commits
mailing list</a><br>
</body></html>
