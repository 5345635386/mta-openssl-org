<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [openssl-commits] [openssl]  master update
   </TITLE>
   <LINK REL="Index" HREF="https://mta.openssl.org/pipermail/openssl-commits/2017-April/index.html" >
   <LINK REL="made" HREF="mailto:openssl-commits%40openssl.org?Subject=Re%3A%20%5Bopenssl-commits%5D%20%5Bopenssl%5D%20%20master%20update&In-Reply-To=%3C1493228583.133031.564.nullmailer%40dev.openssl.org%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="014367.html">
   <LINK REL="Next"  HREF="014375.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[openssl-commits] [openssl]  master update</H1>
    <B>Rich Salz</B> 
    <A HREF="mailto:openssl-commits%40openssl.org?Subject=Re%3A%20%5Bopenssl-commits%5D%20%5Bopenssl%5D%20%20master%20update&In-Reply-To=%3C1493228583.133031.564.nullmailer%40dev.openssl.org%3E"
       TITLE="[openssl-commits] [openssl]  master update">rsalz at openssl.org
       </A><BR>
    <I>Wed Apr 26 17:43:03 UTC 2017</I>
    <P><UL>
        <LI>Previous message: <A HREF="014367.html">[openssl-commits] [openssl]  master update
</A></li>
        <LI>Next message: <A HREF="014375.html">[openssl-commits] [openssl]  master update
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#14371">[ date ]</a>
              <a href="thread.html#14371">[ thread ]</a>
              <a href="subject.html#14371">[ subject ]</a>
              <a href="author.html#14371">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>The branch master has been updated
       via  710756a9b384c9e9eaaf42acaf429aebc2a822a1 (commit)
      from  30bea14be6bbf77ed60acb9bd1befeb51d4c4b10 (commit)


- Log -----------------------------------------------------------------
commit 710756a9b384c9e9eaaf42acaf429aebc2a822a1
Author: Rich Salz &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">rsalz at openssl.org</A>&gt;
Date:   Wed Apr 26 13:24:37 2017 -0400

    Convert sslapitest to test framework
    
    Reviewed-by: Richard Levitte &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">levitte at openssl.org</A>&gt;
    (Merged from <A HREF="https://github.com/openssl/openssl/pull/3252">https://github.com/openssl/openssl/pull/3252</A>)

-----------------------------------------------------------------------

Summary of changes:
 test/sslapitest.c | 1629 ++++++++++++++++++-----------------------------------
 1 file changed, 558 insertions(+), 1071 deletions(-)

diff --git a/test/sslapitest.c b/test/sslapitest.c
index 436fbbb..7c0171b 100644
--- a/test/sslapitest.c
+++ b/test/sslapitest.c
@@ -24,9 +24,9 @@ static char *privkey = NULL;
 
 #define LOG_BUFFER_SIZE 1024
 static char server_log_buffer[LOG_BUFFER_SIZE + 1] = {0};
-static int server_log_buffer_index = 0;
+static size_t server_log_buffer_index = 0;
 static char client_log_buffer[LOG_BUFFER_SIZE + 1] = {0};
-static int client_log_buffer_index = 0;
+static size_t client_log_buffer_index = 0;
 static int error_writing_log = 0;
 
 #ifndef OPENSSL_NO_OCSP
@@ -53,64 +53,54 @@ struct sslapitest_log_counts {
     unsigned int server_application_secret_count;
 };
 
-static void client_keylog_callback(const SSL *ssl, const char *line) {
+static void client_keylog_callback(const SSL *ssl, const char *line)
+{
     int line_length = strlen(line);
 
     /* If the log doesn't fit, error out. */
-    if ((client_log_buffer_index + line_length) &gt; LOG_BUFFER_SIZE) {
-        printf(&quot;No room in client log\n&quot;);
+    if (client_log_buffer_index + line_length &gt; sizeof(client_log_buffer) - 1) {
+        TEST_info(&quot;Client log too full&quot;);
         error_writing_log = 1;
         return;
     }
 
     strcat(client_log_buffer, line);
     client_log_buffer_index += line_length;
-    client_log_buffer[client_log_buffer_index] = '\n';
-    client_log_buffer_index += 1;
-
-    return;
+    client_log_buffer[client_log_buffer_index++] = '\n';
 }
 
-static void server_keylog_callback(const SSL *ssl, const char *line) {
+static void server_keylog_callback(const SSL *ssl, const char *line)
+{
     int line_length = strlen(line);
 
     /* If the log doesn't fit, error out. */
-    if ((server_log_buffer_index + line_length) &gt; LOG_BUFFER_SIZE) {
-        printf(&quot;No room in server log\n&quot;);
+    if (server_log_buffer_index + line_length &gt; sizeof(server_log_buffer) - 1) {
+        TEST_info(&quot;Server og too full&quot;);
         error_writing_log = 1;
         return;
     }
 
     strcat(server_log_buffer, line);
     server_log_buffer_index += line_length;
-    server_log_buffer[server_log_buffer_index] = '\n';
-    server_log_buffer_index += 1;
-
-    return;
+    server_log_buffer[server_log_buffer_index++] = '\n';
 }
 
 static int compare_hex_encoded_buffer(const char *hex_encoded,
                                       size_t hex_length,
                                       const uint8_t *raw,
-                                      size_t raw_length) {
-    size_t i;
-    size_t j;
-
-    /* One byte too big, just to be safe. */
-    char hexed[3] = {0};
+                                      size_t raw_length)
+{
+    size_t i, j;
+    char hexed[3];
 
-    if ((raw_length * 2) != hex_length) {
-        printf(&quot;Inconsistent hex encoded lengths.\n&quot;);
+    if (!TEST_size_t_eq(raw_length * 2, hex_length))
         return 1;
-    }
 
-    for (i = j = 0; (i &lt; raw_length) &amp;&amp; ((j + 1) &lt; hex_length); i++) {
+    for (i = j = 0; i &lt; raw_length &amp;&amp; j + 1 &lt; hex_length; i++, j += 2) {
         sprintf(hexed, &quot;%02x&quot;, raw[i]);
-        if ((hexed[0] != hex_encoded[j]) || (hexed[1] != hex_encoded[j + 1])) {
-            printf(&quot;Hex output does not match.\n&quot;);
+        if (!TEST_int_eq(hexed[0], hex_encoded[j])
+                || !TEST_int_eq(hexed[1], hex_encoded[j + 1]))
             return 1;
-        }
-        j += 2;
     }
 
     return 0;
@@ -118,7 +108,8 @@ static int compare_hex_encoded_buffer(const char *hex_encoded,
 
 static int test_keylog_output(char *buffer, const SSL *ssl,
                               const SSL_SESSION *session,
-                              struct sslapitest_log_counts *expected) {
+                              struct sslapitest_log_counts *expected)
+{
     char *token = NULL;
     unsigned char actual_client_random[SSL3_RANDOM_SIZE] = {0};
     size_t client_random_size = SSL3_RANDOM_SIZE;
@@ -131,28 +122,20 @@ static int test_keylog_output(char *buffer, const SSL *ssl,
     unsigned int client_application_secret_count = 0;
     unsigned int server_application_secret_count = 0;
 
-    token = strtok(buffer, &quot; \n&quot;);
-    while (token) {
+    for (token = strtok(buffer, &quot; \n&quot;); token != NULL;
+         token = strtok(NULL, &quot; \n&quot;)) {
         if (strcmp(token, &quot;RSA&quot;) == 0) {
             /*
              * Premaster secret. Tokens should be: 16 ASCII bytes of
              * hex-encoded encrypted secret, then the hex-encoded pre-master
              * secret.
              */
-            token = strtok(NULL, &quot; \n&quot;);
-            if (!token) {
-                printf(&quot;Unexpectedly short premaster secret log.\n&quot;);
+            if (!TEST_ptr(token = strtok(NULL, &quot; \n&quot;)))
                 return 0;
-            }
-            if (strlen(token) != 16) {
-                printf(&quot;Bad value for encrypted secret: %s\n&quot;, token);
+            if (!TEST_size_t_eq(strlen(token), 16))
                 return 0;
-            }
-            token = strtok(NULL, &quot; \n&quot;);
-            if (!token) {
-                printf(&quot;Unexpectedly short premaster secret log.\n&quot;);
+            if (!TEST_ptr(token = strtok(NULL, &quot; \n&quot;)))
                 return 0;
-            }
             /*
              * We can't sensibly check the log because the premaster secret is
              * transient, and OpenSSL doesn't keep hold of it once the master
@@ -167,51 +150,34 @@ static int test_keylog_output(char *buffer, const SSL *ssl,
             client_random_size = SSL_get_client_random(ssl,
                                                        actual_client_random,
                                                        SSL3_RANDOM_SIZE);
-            if (client_random_size != SSL3_RANDOM_SIZE) {
-                printf(&quot;Unexpected short client random.\n&quot;);
+            if (!TEST_size_t_eq(client_random_size, SSL3_RANDOM_SIZE))
                 return 0;
-            }
 
-            token = strtok(NULL, &quot; \n&quot;);
-            if (!token) {
-                printf(&quot;Unexpected short master secret log.\n&quot;);
+            if (!TEST_ptr(token = strtok(NULL, &quot; \n&quot;)))
                 return 0;
-            }
-            if (strlen(token) != 64) {
-                printf(&quot;Bad value for client random: %s\n&quot;, token);
+            if (!TEST_size_t_eq(strlen(token), 64))
                 return 0;
-            }
-            if (compare_hex_encoded_buffer(token, 64, actual_client_random,
-                                           client_random_size)) {
-                printf(&quot;Bad value for client random: %s\n&quot;, token);
+            if (!TEST_false(compare_hex_encoded_buffer(token, 64,
+                                                       actual_client_random,
+                                                       client_random_size)))
                 return 0;
-            }
 
-            token = strtok(NULL, &quot; \n&quot;);
-            if (!token) {
-                printf(&quot;Unexpectedly short master secret log.\n&quot;);
+            if (!TEST_ptr(token = strtok(NULL, &quot; \n&quot;)))
                 return 0;
-            }
-
             master_key_size = SSL_SESSION_get_master_key(session,
                                                          actual_master_key,
                                                          master_key_size);
-            if (!master_key_size) {
-                printf(&quot;Error getting master key to compare.\n&quot;);
+            if (!TEST_size_t_ne(master_key_size, 0))
                 return 0;
-            }
-            if (compare_hex_encoded_buffer(token, strlen(token),
-                                           actual_master_key,
-                                           master_key_size)) {
-                printf(&quot;Bad value for master key: %s\n&quot;, token);
+            if (!TEST_false(compare_hex_encoded_buffer(token, strlen(token),
+                                                       actual_master_key,
+                                                       master_key_size)))
                 return 0;
-            }
-
             master_secret_count++;
-        } else if ((strcmp(token, &quot;CLIENT_HANDSHAKE_TRAFFIC_SECRET&quot;) == 0) ||
-                   (strcmp(token, &quot;SERVER_HANDSHAKE_TRAFFIC_SECRET&quot;) == 0) ||
-                   (strcmp(token, &quot;CLIENT_TRAFFIC_SECRET_0&quot;) == 0) ||
-                   (strcmp(token, &quot;SERVER_TRAFFIC_SECRET_0&quot;) == 0)) {
+        } else if (strcmp(token, &quot;CLIENT_HANDSHAKE_TRAFFIC_SECRET&quot;) == 0
+                    || strcmp(token, &quot;SERVER_HANDSHAKE_TRAFFIC_SECRET&quot;) == 0
+                    || strcmp(token, &quot;CLIENT_TRAFFIC_SECRET_0&quot;) == 0
+                    || strcmp(token, &quot;SERVER_TRAFFIC_SECRET_0&quot;) == 0) {
             /*
              * TLSv1.3 secret. Tokens should be: 64 ASCII bytes of hex-encoded
              * client random, and then the hex-encoded secret. In this case,
@@ -230,127 +196,95 @@ static int test_keylog_output(char *buffer, const SSL *ssl,
             client_random_size = SSL_get_client_random(ssl,
                                                        actual_client_random,
                                                        SSL3_RANDOM_SIZE);
-            if (client_random_size != SSL3_RANDOM_SIZE) {
-                printf(&quot;Unexpected short client random.\n&quot;);
+            if (!TEST_size_t_eq(client_random_size, SSL3_RANDOM_SIZE))
                 return 0;
-            }
 
-            token = strtok(NULL, &quot; \n&quot;);
-            if (!token) {
-                printf(&quot;Unexpected short client handshake secret log.\n&quot;);
+            if (!TEST_ptr(token = strtok(NULL, &quot; \n&quot;)))
                 return 0;
-            }
-            if (strlen(token) != 64) {
-                printf(&quot;Bad value for client random: %s\n&quot;, token);
+            if (!TEST_size_t_eq(strlen(token), 64))
                 return 0;
-            }
-            if (compare_hex_encoded_buffer(token, 64, actual_client_random,
-                                           client_random_size)) {
-                printf(&quot;Bad value for client random: %s\n&quot;, token);
+            if (!TEST_false(compare_hex_encoded_buffer(token, 64,
+                                                       actual_client_random,
+                                                       client_random_size)))
                 return 0;
-            }
 
-            token = strtok(NULL, &quot; \n&quot;);
-            if (!token) {
-                printf(&quot;Unexpectedly short master secret log.\n&quot;);
+            if (!TEST_ptr(token = strtok(NULL, &quot; \n&quot;)))
                 return 0;
-            }
 
             /*
              * TODO(TLS1.3): test that application traffic secrets are what
              * we expect */
         } else {
-            printf(&quot;Unexpected token in buffer: %s\n&quot;, token);
+            TEST_info(&quot;Unexpected token %s\n&quot;, token);
             return 0;
         }
-
-        token = strtok(NULL, &quot; \n&quot;);
     }
 
-    /* Return whether we got what we expected. */
-    return ((rsa_key_exchange_count == expected-&gt;rsa_key_exchange_count) &amp;&amp;
-            (master_secret_count == expected-&gt;master_secret_count) &amp;&amp;
-            (client_handshake_secret_count == expected-&gt;client_handshake_secret_count) &amp;&amp;
-            (server_handshake_secret_count == expected-&gt;server_handshake_secret_count) &amp;&amp;
-            (client_application_secret_count == expected-&gt;client_application_secret_count) &amp;&amp;
-            (server_application_secret_count == expected-&gt;server_application_secret_count));
+    /* Got what we expected? */
+    if (!TEST_size_t_eq(rsa_key_exchange_count,
+                        expected-&gt;rsa_key_exchange_count)
+            || !TEST_size_t_eq(master_secret_count,
+                               expected-&gt;master_secret_count)
+            || !TEST_size_t_eq(client_handshake_secret_count,
+                               expected-&gt;client_handshake_secret_count)
+            || !TEST_size_t_eq(server_handshake_secret_count,
+                               expected-&gt;server_handshake_secret_count)
+            || !TEST_size_t_eq(client_application_secret_count,
+                               expected-&gt;client_application_secret_count)
+            || !TEST_size_t_eq(server_application_secret_count,
+                               expected-&gt;server_application_secret_count))
+        return 0;
+    return 1;
 }
 
-static int test_keylog(void) {
+static int test_keylog(void)
+{
     SSL_CTX *cctx = NULL, *sctx = NULL;
     SSL *clientssl = NULL, *serverssl = NULL;
     int testresult = 0;
-    int rc;
     struct sslapitest_log_counts expected = {0};
 
     /* Clean up logging space */
-    memset(client_log_buffer, 0, LOG_BUFFER_SIZE + 1);
-    memset(server_log_buffer, 0, LOG_BUFFER_SIZE + 1);
+    memset(client_log_buffer, 0, sizeof(client_log_buffer));
+    memset(server_log_buffer, 0, sizeof(server_log_buffer));
     client_log_buffer_index = 0;
     server_log_buffer_index = 0;
     error_writing_log = 0;
 
-    if (!create_ssl_ctx_pair(TLS_server_method(), TLS_client_method(), &amp;sctx,
-                             &amp;cctx, cert, privkey)) {
-        printf(&quot;Unable to create SSL_CTX pair\n&quot;);
+    if (!TEST_true(create_ssl_ctx_pair(TLS_server_method(),
+                                       TLS_client_method(),
+                                       &amp;sctx, &amp;cctx, cert, privkey)))
         return 0;
-    }
 
     /* We cannot log the master secret for TLSv1.3, so we should forbid it. */
     SSL_CTX_set_options(cctx, SSL_OP_NO_TLSv1_3);
     SSL_CTX_set_options(sctx, SSL_OP_NO_TLSv1_3);
 
     /* We also want to ensure that we use RSA-based key exchange. */
-    rc = SSL_CTX_set_cipher_list(cctx, &quot;RSA&quot;);
-    if (rc == 0) {
-        printf(&quot;Unable to restrict to RSA key exchange.\n&quot;);
+    if (!TEST_true(SSL_CTX_set_cipher_list(cctx, &quot;RSA&quot;)))
         goto end;
-    }
 
-    if (SSL_CTX_get_keylog_callback(cctx)) {
-        printf(&quot;Unexpected initial value for client &quot;
-               &quot;SSL_CTX_get_keylog_callback()\n&quot;);
-        goto end;
-    }
-    if (SSL_CTX_get_keylog_callback(sctx)) {
-        printf(&quot;Unexpected initial value for server &quot;
-               &quot;SSL_CTX_get_keylog_callback()\n&quot;);
+    if (!TEST_ptr_null((void *)SSL_CTX_get_keylog_callback(cctx))
+            || !TEST_ptr_null((void *)SSL_CTX_get_keylog_callback(sctx)))
         goto end;
-    }
-
     SSL_CTX_set_keylog_callback(cctx, client_keylog_callback);
-    SSL_CTX_set_keylog_callback(sctx, server_keylog_callback);
-
-    if (SSL_CTX_get_keylog_callback(cctx) != client_keylog_callback) {
-        printf(&quot;Unexpected set value for client &quot;
-               &quot;SSL_CTX_get_keylog_callback()\n&quot;);
-    }
-
-    if (SSL_CTX_get_keylog_callback(sctx) != server_keylog_callback) {
-        printf(&quot;Unexpected set value for server &quot;
-               &quot;SSL_CTX_get_keylog_callback()\n&quot;);
-    }
-
-    /* Now do a handshake and check that the logs have been written to. */
-    if (!create_ssl_objects(sctx, cctx, &amp;serverssl, &amp;clientssl, NULL, NULL)) {
-        printf(&quot;Unable to create SSL objects\n&quot;);
+    if (!TEST_ptr_eq((void *)SSL_CTX_get_keylog_callback(cctx),
+                     (void *)client_keylog_callback))
         goto end;
-    }
-
-    if (!create_ssl_connection(serverssl, clientssl, SSL_ERROR_NONE)) {
-        printf(&quot;Unable to create SSL connection\n&quot;);
-        goto end;
-    }
-
-    if (error_writing_log) {
-        printf(&quot;Error encountered while logging\n&quot;);
+    SSL_CTX_set_keylog_callback(sctx, server_keylog_callback);
+    if (!TEST_ptr_eq((void *)SSL_CTX_get_keylog_callback(sctx),
+                     (void *)server_keylog_callback))
         goto end;
-    }
 
-    if ((client_log_buffer_index == 0) || (server_log_buffer_index == 0)) {
-        printf(&quot;No logs written\n&quot;);
+    /* Now do a handshake and check that the logs have been written to. */
+    if (!TEST_true(create_ssl_objects(sctx, cctx, &amp;serverssl,
+                                      &amp;clientssl, NULL, NULL))
+            || !TEST_true(create_ssl_connection(serverssl, clientssl,
+                                                SSL_ERROR_NONE))
+            || !TEST_false(error_writing_log)
+            || !TEST_int_gt(client_log_buffer_index, 0)
+            || !TEST_int_gt(server_log_buffer_index, 0))
         goto end;
-    }
 
     /*
      * Now we want to test that our output data was vaguely sensible. We
@@ -360,18 +294,14 @@ static int test_keylog(void) {
      */
     expected.rsa_key_exchange_count = 1;
     expected.master_secret_count = 1;
-    if (!test_keylog_output(client_log_buffer, clientssl,
-                            SSL_get_session(clientssl), &amp;expected)) {
-        printf(&quot;Error encountered in client log buffer\n&quot;);
+    if (!TEST_true(test_keylog_output(client_log_buffer, clientssl,
+                                      SSL_get_session(clientssl), &amp;expected)))
         goto end;
-    }
 
     expected.rsa_key_exchange_count = 0;
-    if (!test_keylog_output(server_log_buffer, serverssl,
-                            SSL_get_session(serverssl), &amp;expected)) {
-        printf(&quot;Error encountered in server log buffer\n&quot;);
+    if (!TEST_true(test_keylog_output(server_log_buffer, serverssl,
+                                      SSL_get_session(serverssl), &amp;expected)))
         goto end;
-    }
 
     testresult = 1;
 
@@ -385,64 +315,46 @@ end:
 }
 
 #ifndef OPENSSL_NO_TLS1_3
-static int test_keylog_no_master_key(void) {
+static int test_keylog_no_master_key(void)
+{
     SSL_CTX *cctx = NULL, *sctx = NULL;
     SSL *clientssl = NULL, *serverssl = NULL;
     int testresult = 0;
     struct sslapitest_log_counts expected = {0};
 
     /* Clean up logging space */
-    memset(client_log_buffer, 0, LOG_BUFFER_SIZE + 1);
-    memset(server_log_buffer, 0, LOG_BUFFER_SIZE + 1);
+    memset(client_log_buffer, 0, sizeof(client_log_buffer));
+    memset(server_log_buffer, 0, sizeof(server_log_buffer));
     client_log_buffer_index = 0;
     server_log_buffer_index = 0;
     error_writing_log = 0;
 
-    if (!create_ssl_ctx_pair(TLS_server_method(), TLS_client_method(), &amp;sctx,
-                             &amp;cctx, cert, privkey)) {
-        printf(&quot;Unable to create SSL_CTX pair\n&quot;);
+    if (!TEST_true(create_ssl_ctx_pair(TLS_server_method(),
+                             TLS_client_method(), &amp;sctx,
+                             &amp;cctx, cert, privkey)))
         return 0;
-    }
 
-    if (SSL_CTX_get_keylog_callback(cctx)) {
-        printf(&quot;Unexpected initial value for client &quot;
-               &quot;SSL_CTX_get_keylog_callback()\n&quot;);
-        goto end;
-    }
-    if (SSL_CTX_get_keylog_callback(sctx)) {
-        printf(&quot;Unexpected initial value for server &quot;
-               &quot;SSL_CTX_get_keylog_callback()\n&quot;);
+    if (!TEST_ptr_null((void *)SSL_CTX_get_keylog_callback(cctx))
+            || !TEST_ptr_null((void *)SSL_CTX_get_keylog_callback(sctx)))
         goto end;
-    }
 
     SSL_CTX_set_keylog_callback(cctx, client_keylog_callback);
-    SSL_CTX_set_keylog_callback(sctx, server_keylog_callback);
-
-    if (SSL_CTX_get_keylog_callback(cctx) != client_keylog_callback) {
-        printf(&quot;Unexpected set value for client &quot;
-               &quot;SSL_CTX_get_keylog_callback()\n&quot;);
-    }
-
-    if (SSL_CTX_get_keylog_callback(sctx) != server_keylog_callback) {
-        printf(&quot;Unexpected set value for server &quot;
-               &quot;SSL_CTX_get_keylog_callback()\n&quot;);
-    }
-
-    /* Now do a handshake and check that the logs have been written to. */
-    if (!create_ssl_objects(sctx, cctx, &amp;serverssl, &amp;clientssl, NULL, NULL)) {
-        printf(&quot;Unable to create SSL objects\n&quot;);
+    if (!TEST_ptr_eq((void *)SSL_CTX_get_keylog_callback(cctx),
+                     (void *)client_keylog_callback))
         goto end;
-    }
 
-    if (!create_ssl_connection(serverssl, clientssl, SSL_ERROR_NONE)) {
-        printf(&quot;Unable to create SSL connection\n&quot;);
+    SSL_CTX_set_keylog_callback(sctx, server_keylog_callback);
+    if (!TEST_ptr_eq((void *)SSL_CTX_get_keylog_callback(sctx),
+                     (void *)server_keylog_callback))
         goto end;
-    }
 
-    if (error_writing_log) {
-        printf(&quot;Error encountered while logging\n&quot;);
+    /* Now do a handshake and check that the logs have been written to. */
+    if (!TEST_true(create_ssl_objects(sctx, cctx, &amp;serverssl,
+                                      &amp;clientssl, NULL, NULL))
+            || !TEST_true(create_ssl_connection(serverssl, clientssl,
+                                                SSL_ERROR_NONE))
+            || !TEST_false(error_writing_log))
         goto end;
-    }
 
     /*
      * Now we want to test that our output data was vaguely sensible. For this
@@ -453,16 +365,12 @@ static int test_keylog_no_master_key(void) {
     expected.server_handshake_secret_count = 1;
     expected.client_application_secret_count = 1;
     expected.server_application_secret_count = 1;
-    if (!test_keylog_output(client_log_buffer, clientssl,
-                            SSL_get_session(clientssl), &amp;expected)) {
-        printf(&quot;Error encountered in client log buffer\n&quot;);
-        goto end;
-    }
-    if (!test_keylog_output(server_log_buffer, serverssl,
-                            SSL_get_session(serverssl), &amp;expected)) {
-        printf(&quot;Error encountered in server log buffer\n&quot;);
+    if (!TEST_true(test_keylog_output(client_log_buffer, clientssl,
+                                      SSL_get_session(clientssl), &amp;expected))
+            || !TEST_true(test_keylog_output(server_log_buffer, serverssl,
+                                             SSL_get_session(serverssl),
+                                             &amp;expected)))
         goto end;
-    }
 
     testresult = 1;
 
@@ -495,59 +403,42 @@ static int full_early_callback(SSL *s, int *al, void *arg)
         return -1;
 
     len = SSL_early_get0_ciphers(s, &amp;p);
-    if (len != sizeof(expected_ciphers) ||
-        memcmp(p, expected_ciphers, len) != 0) {
-        printf(&quot;Early callback expected ciphers mismatch\n&quot;);
-        return 0;
-    }
-    len = SSL_early_get0_compression_methods(s, &amp;p);
-    if (len != 1 || *p != 0) {
-        printf(&quot;Early callback expected compression methods mismatch\n&quot;);
+    if (!TEST_mem_eq(p, len, expected_ciphers, sizeof(expected_ciphers))
+            || !TEST_size_t_eq(SSL_early_get0_compression_methods(s, &amp;p), 1)
+            || !TEST_int_eq(*p, 0))
         return 0;
-    }
     return 1;
 }
 
-static int test_early_cb(void) {
+static int test_early_cb(void)
+{
     SSL_CTX *cctx = NULL, *sctx = NULL;
     SSL *clientssl = NULL, *serverssl = NULL;
     int testctr = 0, testresult = 0;
 
-    if (!create_ssl_ctx_pair(TLS_server_method(), TLS_client_method(), &amp;sctx,
-                             &amp;cctx, cert, privkey)) {
-        printf(&quot;Unable to create SSL_CTX pair\n&quot;);
+    if (!TEST_true(create_ssl_ctx_pair(TLS_server_method(),
+                                       TLS_client_method(), &amp;sctx,
+                                       &amp;cctx, cert, privkey)))
         goto end;
-    }
-
     SSL_CTX_set_early_cb(sctx, full_early_callback, &amp;testctr);
+
     /* The gimpy cipher list we configure can't do TLS 1.3. */
     SSL_CTX_set_max_proto_version(cctx, TLS1_2_VERSION);
-    if (!SSL_CTX_set_cipher_list(cctx,
-            &quot;AES256-GCM-SHA384:ECDHE-ECDSA-AES256-GCM-SHA384&quot;)) {
-        printf(&quot;Failed to set cipher list\n&quot;);
-        goto end;
-    }
-
-    if (!create_ssl_objects(sctx, cctx, &amp;serverssl, &amp;clientssl, NULL, NULL)) {
-        printf(&quot;Unable to create SSL objects\n&quot;);
-        goto end;
-    }
-
-    if (create_ssl_connection(serverssl, clientssl, SSL_ERROR_WANT_EARLY)) {
-        printf(&quot;Creating SSL connection succeeded with async early return\n&quot;);
-        goto end;
-    }
 
-    /* Passing a -1 literal is a hack since the real value was lost. */
-    if (SSL_get_error(serverssl, -1) != SSL_ERROR_WANT_EARLY) {
-        printf(&quot;Early callback failed to make state SSL_ERROR_WANT_EARLY\n&quot;);
+    if (!TEST_true(SSL_CTX_set_cipher_list(cctx,
+                        &quot;AES256-GCM-SHA384:ECDHE-ECDSA-AES256-GCM-SHA384&quot;))
+            || !TEST_true(create_ssl_objects(sctx, cctx, &amp;serverssl,
+                                             &amp;clientssl, NULL, NULL))
+            || !TEST_false(create_ssl_connection(serverssl, clientssl,
+                                                 SSL_ERROR_WANT_EARLY))
+                /*
+                 * Passing a -1 literal is a hack since
+                 * the real value was lost.
+                 * */
+            || !TEST_int_eq(SSL_get_error(serverssl, -1), SSL_ERROR_WANT_EARLY)
+            || !TEST_true(create_ssl_connection(serverssl, clientssl,
+                                                SSL_ERROR_NONE)))
         goto end;
-    }
-
-    if (!create_ssl_connection(serverssl, clientssl, SSL_ERROR_NONE)) {
-        printf(&quot;Restarting SSL connection failed\n&quot;);
-        goto end;
-    }
 
     testresult = 1;
 
@@ -568,29 +459,23 @@ static int execute_test_large_message(const SSL_METHOD *smeth,
     SSL *clientssl = NULL, *serverssl = NULL;
     int testresult = 0;
     int i;
-    BIO *certbio = BIO_new_file(cert, &quot;r&quot;);
+    BIO *certbio = NULL;
     X509 *chaincert = NULL;
     int certlen;
 
-    if (certbio == NULL) {
-        printf(&quot;Can't load the certificate file\n&quot;);
+    if (!TEST_ptr(certbio = BIO_new_file(cert, &quot;r&quot;)))
         goto end;
-    }
     chaincert = PEM_read_bio_X509(certbio, NULL, NULL, NULL);
     BIO_free(certbio);
     certbio = NULL;
-    if (chaincert == NULL) {
-        printf(&quot;Unable to load certificate for chain\n&quot;);
+    if (!TEST_ptr(chaincert))
         goto end;
-    }
 
-    if (!create_ssl_ctx_pair(smeth, cmeth, &amp;sctx,
-                             &amp;cctx, cert, privkey)) {
-        printf(&quot;Unable to create SSL_CTX pair\n&quot;);
+    if (!TEST_true(create_ssl_ctx_pair(smeth, cmeth, &amp;sctx,
+                                       &amp;cctx, cert, privkey)))
         goto end;
-    }
 
-    if(read_ahead) {
+    if (read_ahead) {
         /*
          * Test that read_ahead works correctly when dealing with large
          * records
@@ -602,42 +487,33 @@ static int execute_test_large_message(const SSL_METHOD *smeth,
      * We assume the supplied certificate is big enough so that if we add
      * NUM_EXTRA_CERTS it will make the overall message large enough. The
      * default buffer size is requested to be 16k, but due to the way BUF_MEM
-     * works, it ends up allocating a little over 21k (16 * 4/3). So, in this test
-     * we need to have a message larger than that.
+     * works, it ends up allocating a little over 21k (16 * 4/3). So, in this
+     * test we need to have a message larger than that.
      */
     certlen = i2d_X509(chaincert, NULL);
-    OPENSSL_assert((certlen * NUM_EXTRA_CERTS)
-                   &gt; ((SSL3_RT_MAX_PLAIN_LENGTH * 4) / 3));
+    OPENSSL_assert(certlen * NUM_EXTRA_CERTS &gt;
+                   (SSL3_RT_MAX_PLAIN_LENGTH * 4) / 3);
     for (i = 0; i &lt; NUM_EXTRA_CERTS; i++) {
-        if (!X509_up_ref(chaincert)) {
-            printf(&quot;Unable to up ref cert\n&quot;);
+        if (!X509_up_ref(chaincert))
             goto end;
-        }
         if (!SSL_CTX_add_extra_chain_cert(sctx, chaincert)) {
-            printf(&quot;Unable to add extra chain cert %d\n&quot;, i);
             X509_free(chaincert);
             goto end;
         }
     }
 
-    if (!create_ssl_objects(sctx, cctx, &amp;serverssl, &amp;clientssl, NULL, NULL)) {
-        printf(&quot;Unable to create SSL objects\n&quot;);
+    if (!TEST_true(create_ssl_objects(sctx, cctx, &amp;serverssl, &amp;clientssl,
+                                      NULL, NULL))
+            || !TEST_true(create_ssl_connection(serverssl, clientssl,
+                                                SSL_ERROR_NONE)))
         goto end;
-    }
-
-    if (!create_ssl_connection(serverssl, clientssl, SSL_ERROR_NONE)) {
-        printf(&quot;Unable to create SSL connection\n&quot;);
-        goto end;
-    }
 
     /*
      * Calling SSL_clear() first is not required but this tests that SSL_clear()
      * doesn't leak (when using enable-crypto-mdebug).
      */
-    if (!SSL_clear(serverssl)) {
-        printf(&quot;Unexpected failure from SSL_clear()\n&quot;);
+    if (!TEST_true(SSL_clear(serverssl)))
         goto end;
-    }
 
     testresult = 1;
  end:
@@ -678,7 +554,7 @@ static int test_large_message_dtls(void)
 static int ocsp_server_cb(SSL *s, void *arg)
 {
     int *argi = (int *)arg;
-    unsigned char *orespdercopy = NULL;
+    unsigned char *copy = NULL;
     STACK_OF(OCSP_RESPID) *ids = NULL;
     OCSP_RESPID *id = NULL;
 
@@ -695,15 +571,11 @@ static int ocsp_server_cb(SSL *s, void *arg)
         return SSL_TLSEXT_ERR_ALERT_FATAL;
     }
 
-
-    orespdercopy = OPENSSL_memdup(orespder, sizeof(orespder));
-    if (orespdercopy == NULL)
+    if (!TEST_ptr(copy = OPENSSL_memdup(orespder, sizeof(orespder))))
         return SSL_TLSEXT_ERR_ALERT_FATAL;
 
-    SSL_set_tlsext_status_ocsp_resp(s, orespdercopy, sizeof(orespder));
-
+    SSL_set_tlsext_status_ocsp_resp(s, copy, sizeof(orespder));
     ocsp_server_called = 1;
-
     return SSL_TLSEXT_ERR_OK;
 }
 
@@ -717,12 +589,10 @@ static int ocsp_client_cb(SSL *s, void *arg)
         return 0;
 
     len = SSL_get_tlsext_status_ocsp_resp(s, &amp;respderin);
-
-    if (memcmp(orespder, respderin, len) != 0)
+    if (!TEST_mem_eq(orespder, len, respderin, len))
         return 0;
 
     ocsp_client_called = 1;
-
     return 1;
 }
 
@@ -736,55 +606,32 @@ static int test_tlsext_status_type(void)
     BIO *certbio = NULL;
 
     if (!create_ssl_ctx_pair(TLS_server_method(), TLS_client_method(), &amp;sctx,
-                             &amp;cctx, cert, privkey)) {
-        printf(&quot;Unable to create SSL_CTX pair\n&quot;);
+                             &amp;cctx, cert, privkey))
         return 0;
-    }
 
-    if (SSL_CTX_get_tlsext_status_type(cctx) != -1) {
-        printf(&quot;Unexpected initial value for &quot;
-               &quot;SSL_CTX_get_tlsext_status_type()\n&quot;);
+    if (SSL_CTX_get_tlsext_status_type(cctx) != -1)
         goto end;
-    }
 
     /* First just do various checks getting and setting tlsext_status_type */
 
     clientssl = SSL_new(cctx);
-    if (SSL_get_tlsext_status_type(clientssl) != -1) {
-        printf(&quot;Unexpected initial value for SSL_get_tlsext_status_type()\n&quot;);
+    if (!TEST_int_eq(SSL_get_tlsext_status_type(clientssl), -1)
+            || !TEST_true(SSL_set_tlsext_status_type(clientssl,
+                                                      TLSEXT_STATUSTYPE_ocsp))
+            || !TEST_int_eq(SSL_get_tlsext_status_type(clientssl),
+                            TLSEXT_STATUSTYPE_ocsp))
         goto end;
-    }
-
-    if (!SSL_set_tlsext_status_type(clientssl, TLSEXT_STATUSTYPE_ocsp)) {
-        printf(&quot;Unexpected fail for SSL_set_tlsext_status_type()\n&quot;);
-        goto end;
-    }
-
-    if (SSL_get_tlsext_status_type(clientssl) != TLSEXT_STATUSTYPE_ocsp) {
-        printf(&quot;Unexpected result for SSL_get_tlsext_status_type()\n&quot;);
-        goto end;
-    }
 
     SSL_free(clientssl);
     clientssl = NULL;
 
-    if (!SSL_CTX_set_tlsext_status_type(cctx, TLSEXT_STATUSTYPE_ocsp)) {
-        printf(&quot;Unexpected fail for SSL_CTX_set_tlsext_status_type()\n&quot;);
+    if (!SSL_CTX_set_tlsext_status_type(cctx, TLSEXT_STATUSTYPE_ocsp)
+     || SSL_CTX_get_tlsext_status_type(cctx) != TLSEXT_STATUSTYPE_ocsp)
         goto end;
-    }
-
-    if (SSL_CTX_get_tlsext_status_type(cctx) != TLSEXT_STATUSTYPE_ocsp) {
-        printf(&quot;Unexpected result for SSL_CTX_get_tlsext_status_type()\n&quot;);
-        goto end;
-    }
 
     clientssl = SSL_new(cctx);
-
-    if (SSL_get_tlsext_status_type(clientssl) != TLSEXT_STATUSTYPE_ocsp) {
-        printf(&quot;Unexpected result for SSL_get_tlsext_status_type() (test 2)\n&quot;);
+    if (SSL_get_tlsext_status_type(clientssl) != TLSEXT_STATUSTYPE_ocsp)
         goto end;
-    }
-
     SSL_free(clientssl);
     clientssl = NULL;
 
@@ -792,27 +639,17 @@ static int test_tlsext_status_type(void)
      * Now actually do a handshake and check OCSP information is exchanged and
      * the callbacks get called
      */
-
     SSL_CTX_set_tlsext_status_cb(cctx, ocsp_client_cb);
     SSL_CTX_set_tlsext_status_arg(cctx, &amp;cdummyarg);
     SSL_CTX_set_tlsext_status_cb(sctx, ocsp_server_cb);
     SSL_CTX_set_tlsext_status_arg(sctx, &amp;cdummyarg);
-
-    if (!create_ssl_objects(sctx, cctx, &amp;serverssl, &amp;clientssl, NULL, NULL)) {
-        printf(&quot;Unable to create SSL objects\n&quot;);
-        goto end;
-    }
-
-    if (!create_ssl_connection(serverssl, clientssl, SSL_ERROR_NONE)) {
-        printf(&quot;Unable to create SSL connection\n&quot;);
-        goto end;
-    }
-
-    if (!ocsp_client_called || !ocsp_server_called) {
-        printf(&quot;OCSP callbacks not called\n&quot;);
+    if (!TEST_true(create_ssl_objects(sctx, cctx, &amp;serverssl,
+                                      &amp;clientssl, NULL, NULL))
+            || !TEST_true(create_ssl_connection(serverssl, clientssl,
+                                                SSL_ERROR_NONE))
+            || !TEST_true(ocsp_client_called)
+            || !TEST_true(ocsp_server_called))
         goto end;
-    }
-
     SSL_free(serverssl);
     SSL_free(clientssl);
     serverssl = NULL;
@@ -822,23 +659,14 @@ static int test_tlsext_status_type(void)
     ocsp_client_called = 0;
     ocsp_server_called = 0;
     cdummyarg = 0;
-
-    if (!create_ssl_objects(sctx, cctx, &amp;serverssl, &amp;clientssl, NULL, NULL)) {
-        printf(&quot;Unable to create SSL objects\n&quot;);
+    if (!TEST_true(create_ssl_objects(sctx, cctx, &amp;serverssl,
+                                      &amp;clientssl, NULL, NULL))
+                /* This should fail because the callback will fail */
+            || !TEST_false(create_ssl_connection(serverssl, clientssl,
+                                                 SSL_ERROR_NONE))
+            || !TEST_false(ocsp_client_called)
+            || !TEST_false(ocsp_server_called))
         goto end;
-    }
-
-    /* This should fail because the callback will fail */
-    if (create_ssl_connection(serverssl, clientssl, SSL_ERROR_NONE)) {
-        printf(&quot;Unexpected success creating the connection\n&quot;);
-        goto end;
-    }
-
-    if (ocsp_client_called || ocsp_server_called) {
-        printf(&quot;OCSP callbacks successfully called unexpectedly\n&quot;);
-        goto end;
-    }
-
     SSL_free(serverssl);
     SSL_free(clientssl);
     serverssl = NULL;
@@ -851,30 +679,22 @@ static int test_tlsext_status_type(void)
     ocsp_client_called = 0;
     ocsp_server_called = 0;
     cdummyarg = 2;
-
-    if (!create_ssl_objects(sctx, cctx, &amp;serverssl, &amp;clientssl, NULL, NULL)) {
-        printf(&quot;Unable to create SSL objects\n&quot;);
+    if (!TEST_true(create_ssl_objects(sctx, cctx, &amp;serverssl,
+                                      &amp;clientssl, NULL, NULL)))
         goto end;
-    }
 
     /*
      * We'll just use any old cert for this test - it doesn't have to be an OCSP
      * specific one. We'll use the server cert.
      */
-    certbio = BIO_new_file(cert, &quot;r&quot;);
-    if (certbio == NULL) {
-        printf(&quot;Can't load the certificate file\n&quot;);
-        goto end;
-    }
-    id = OCSP_RESPID_new();
-    ids = sk_OCSP_RESPID_new_null();
-    ocspcert = PEM_read_bio_X509(certbio, NULL, NULL, NULL);
-    if (id == NULL || ids == NULL || ocspcert == NULL
-            || !OCSP_RESPID_set_by_key(id, ocspcert)
-            || !sk_OCSP_RESPID_push(ids, id)) {
-        printf(&quot;Unable to set OCSP_RESPIDs\n&quot;);
+    if (!TEST_ptr(certbio = BIO_new_file(cert, &quot;r&quot;))
+            || !TEST_ptr(id = OCSP_RESPID_new())
+            || !TEST_ptr(ids = sk_OCSP_RESPID_new_null())
+            || !TEST_ptr(ocspcert = PEM_read_bio_X509(certbio,
+                                                      NULL, NULL, NULL))
+            || !TEST_true(OCSP_RESPID_set_by_key(id, ocspcert))
+            || !TEST_true(sk_OCSP_RESPID_push(ids, id)))
         goto end;
-    }
     id = NULL;
     SSL_set_tlsext_status_ids(clientssl, ids);
     /* Control has been transferred */
@@ -883,15 +703,11 @@ static int test_tlsext_status_type(void)
     BIO_free(certbio);
     certbio = NULL;
 
-    if (!create_ssl_connection(serverssl, clientssl, SSL_ERROR_NONE)) {
-        printf(&quot;Unable to create SSL connection\n&quot;);
+    if (!TEST_true(create_ssl_connection(serverssl, clientssl,
+                                         SSL_ERROR_NONE))
+            || !TEST_true(ocsp_client_called)
+            || !TEST_true(ocsp_server_called))
         goto end;
-    }
-
-    if (!ocsp_client_called || !ocsp_server_called) {
-        printf(&quot;OCSP callbacks not called\n&quot;);
-        goto end;
-    }
 
     testresult = 1;
 
@@ -939,7 +755,6 @@ static void ssl_session_tear_down(SSL_SESSION_TEST_FIXTURE fixture)
 static int new_session_cb(SSL *ssl, SSL_SESSION *sess)
 {
     new_called++;
-
     return 1;
 }
 
@@ -959,11 +774,10 @@ static int execute_test_session(SSL_SESSION_TEST_FIXTURE fix)
     SSL_SESSION *sess1 = NULL, *sess2 = NULL;
     int testresult = 0;
 
-    if (!create_ssl_ctx_pair(TLS_server_method(), TLS_client_method(), &amp;sctx,
-                             &amp;cctx, cert, privkey)) {
-        printf(&quot;Unable to create SSL_CTX pair\n&quot;);
+    if (!TEST_true(create_ssl_ctx_pair(TLS_server_method(),
+                                       TLS_client_method(), &amp;sctx,
+                                       &amp;cctx, cert, privkey)))
         return 0;
-    }
 
 #ifndef OPENSSL_NO_TLS1_2
     /* Only allow TLS1.2 so we can force a connection failure later */
@@ -984,89 +798,50 @@ static int execute_test_session(SSL_SESSION_TEST_FIXTURE fix)
                                        | SSL_SESS_CACHE_NO_INTERNAL_STORE);
     }
 
-    if (!create_ssl_objects(sctx, cctx, &amp;serverssl1, &amp;clientssl1, NULL,
-                               NULL)) {
-        printf(&quot;Unable to create SSL objects\n&quot;);
-        goto end;
-    }
-
-    if (!create_ssl_connection(serverssl1, clientssl1, SSL_ERROR_NONE)) {
-        printf(&quot;Unable to create SSL connection\n&quot;);
-        goto end;
-    }
-    sess1 = SSL_get1_session(clientssl1);
-    if (sess1 == NULL) {
-        printf(&quot;Unexpected NULL session\n&quot;);
-        goto end;
-    }
-
-    if (fix.use_int_cache &amp;&amp; SSL_CTX_add_session(cctx, sess1)) {
-        /* Should have failed because it should already be in the cache */
-        printf(&quot;Unexpected success adding session to cache\n&quot;);
+    if (!TEST_true(create_ssl_objects(sctx, cctx, &amp;serverssl1, &amp;clientssl1,
+                                      NULL, NULL))
+            || !TEST_true(create_ssl_connection(serverssl1, clientssl1,
+                                                SSL_ERROR_NONE))
+            || !TEST_ptr(sess1 = SSL_get1_session(clientssl1)))
         goto end;
-    }
 
-    if (fix.use_ext_cache &amp;&amp; (new_called != 1 || remove_called != 0)) {
-        printf(&quot;Session not added to cache\n&quot;);
+    /* Should fail because it should already be in the cache */
+    if (fix.use_int_cache &amp;&amp; !TEST_false(SSL_CTX_add_session(cctx, sess1)))
         goto end;
-    }
-
-    if (!create_ssl_objects(sctx, cctx, &amp;serverssl2, &amp;clientssl2, NULL, NULL)) {
-        printf(&quot;Unable to create second SSL objects\n&quot;);
+    if (fix.use_ext_cache &amp;&amp; (new_called != 1 || remove_called != 0))
         goto end;
-    }
 
-    if (!create_ssl_connection(serverssl2, clientssl2, SSL_ERROR_NONE)) {
-        printf(&quot;Unable to create second SSL connection\n&quot;);
+    if (!TEST_true(create_ssl_objects(sctx, cctx, &amp;serverssl2,
+                                      &amp;clientssl2, NULL, NULL))
+            || !TEST_true(create_ssl_connection(serverssl2, clientssl2,
+                                                SSL_ERROR_NONE)))
         goto end;
-    }
 
-    sess2 = SSL_get1_session(clientssl2);
-    if (sess2 == NULL) {
-        printf(&quot;Unexpected NULL session from clientssl2\n&quot;);
+    if (!TEST_ptr(sess2 = SSL_get1_session(clientssl2)))
         goto end;
-    }
 
-    if (fix.use_ext_cache &amp;&amp; (new_called != 2 || remove_called != 0)) {
-        printf(&quot;Remove session callback unexpectedly called\n&quot;);
+    if (fix.use_ext_cache &amp;&amp; (new_called != 2 || remove_called != 0))
         goto end;
-    }
 
     /*
-     * This should clear sess2 from the cache because it is a &quot;bad&quot; session. See
-     * SSL_set_session() documentation.
+     * This should clear sess2 from the cache because it is a &quot;bad&quot; session.
+     * See SSL_set_session() documentation.
      */
-    if (!SSL_set_session(clientssl2, sess1)) {
-        printf(&quot;Unexpected failure setting session\n&quot;);
+    if (!TEST_true(SSL_set_session(clientssl2, sess1)))
         goto end;
-    }
-
-    if (fix.use_ext_cache &amp;&amp; (new_called != 2 || remove_called != 1)) {
-        printf(&quot;Failed to call callback to remove session\n&quot;);
+    if (fix.use_ext_cache &amp;&amp; (new_called != 2 || remove_called != 1))
         goto end;
-    }
-
-
-    if (SSL_get_session(clientssl2) != sess1) {
-        printf(&quot;Unexpected session found\n&quot;);
+    if (!TEST_ptr_eq(SSL_get_session(clientssl2), sess1))
         goto end;
-    }
 
     if (fix.use_int_cache) {
-        if (!SSL_CTX_add_session(cctx, sess2)) {
-            /*
-             * Should have succeeded because it should not already be in the cache
-             */
-            printf(&quot;Unexpected failure adding session to cache\n&quot;);
-            goto end;
-        }
-
-        if (!SSL_CTX_remove_session(cctx, sess2)) {
-            printf(&quot;Unexpected failure removing session from cache\n&quot;);
+        /* Should succeeded because it should not already be in the cache */
+        if (!TEST_true(SSL_CTX_add_session(cctx, sess2))
+                || !TEST_true(SSL_CTX_remove_session(cctx, sess2)))
             goto end;
-        }
 
-        /* This is for the purposes of internal cache testing...ignore the
+        /*
+         * This is for the purposes of internal cache testing...ignore the
          * counter for external cache
          */
         if (fix.use_ext_cache)
@@ -1074,50 +849,30 @@ static int execute_test_session(SSL_SESSION_TEST_FIXTURE fix)
     }
 
     /* This shouldn't be in the cache so should fail */
-    if (SSL_CTX_remove_session(cctx, sess2)) {
-        printf(&quot;Unexpected success removing session from cache\n&quot;);
+    if (!TEST_false(SSL_CTX_remove_session(cctx, sess2)))
         goto end;
-    }
 
-    if (fix.use_ext_cache &amp;&amp; (new_called != 2 || remove_called != 2)) {
-        printf(&quot;Failed to call callback to remove session #2\n&quot;);
+    if (fix.use_ext_cache &amp;&amp; (new_called != 2 || remove_called != 2))
         goto end;
-    }
 
 #if !defined(OPENSSL_NO_TLS1_1) &amp;&amp; !defined(OPENSSL_NO_TLS1_2)
     /* Force a connection failure */
     SSL_CTX_set_max_proto_version(sctx, TLS1_1_VERSION);
-
-    if (!create_ssl_objects(sctx, cctx, &amp;serverssl3, &amp;clientssl3, NULL, NULL)) {
-        printf(&quot;Unable to create third SSL objects\n&quot;);
+    if (!TEST_true(create_ssl_objects(sctx, cctx, &amp;serverssl3,
+                                      &amp;clientssl3, NULL, NULL))
+            || !TEST_true(SSL_set_session(clientssl3, sess1))
+        /* This should fail because of the mismatched protocol versions */
+            || !TEST_false(create_ssl_connection(serverssl3, clientssl3,
+                                                 SSL_ERROR_NONE)))
         goto end;
-    }
-
-    if (!SSL_set_session(clientssl3, sess1)) {
-        printf(&quot;Unable to set session for third connection\n&quot;);
-        goto end;
-    }
-
-    /* This should fail because of the mismatched protocol versions */
-    if (create_ssl_connection(serverssl3, clientssl3, SSL_ERROR_NONE)) {
-        printf(&quot;Unable to create third SSL connection\n&quot;);
-        goto end;
-    }
-
 
     /* We should have automatically removed the session from the cache */
-    if (fix.use_ext_cache &amp;&amp; (new_called != 2 || remove_called != 3)) {
-        printf(&quot;Failed to call callback to remove session #2\n&quot;);
+    if (fix.use_ext_cache &amp;&amp; (new_called != 2 || remove_called != 3))
         goto end;
-    }
 
-    if (fix.use_int_cache &amp;&amp; !SSL_CTX_add_session(cctx, sess2)) {
-        /*
-         * Should have succeeded because it should not already be in the cache
-         */
-        printf(&quot;Unexpected failure adding session to cache #2\n&quot;);
+    /* Should succeed because it should not already be in the cache */
+    if (fix.use_int_cache &amp;&amp; !SSL_CTX_add_session(cctx, sess2))
         goto end;
-    }
 #endif
 
     testresult = 1;
@@ -1133,6 +888,7 @@ static int execute_test_session(SSL_SESSION_TEST_FIXTURE fix)
 #endif
     SSL_SESSION_free(sess1);
     SSL_SESSION_free(sess2);
+
     /*
      * Check if we need to remove any sessions up-refed for the external cache
      */
@@ -1149,25 +905,20 @@ static int execute_test_session(SSL_SESSION_TEST_FIXTURE fix)
 static int test_session_with_only_int_cache(void)
 {
     SETUP_TEST_FIXTURE(SSL_SESSION_TEST_FIXTURE, ssl_session_set_up);
-
     fixture.use_ext_cache = 0;
-
     EXECUTE_TEST(execute_test_session, ssl_session_tear_down);
 }
 
 static int test_session_with_only_ext_cache(void)
 {
     SETUP_TEST_FIXTURE(SSL_SESSION_TEST_FIXTURE, ssl_session_set_up);
-
     fixture.use_int_cache = 0;
-
     EXECUTE_TEST(execute_test_session, ssl_session_tear_down);
 }
 
 static int test_session_with_both_cache(void)
 {
     SETUP_TEST_FIXTURE(SSL_SESSION_TEST_FIXTURE, ssl_session_set_up);
-
     EXECUTE_TEST(execute_test_session, ssl_session_tear_down);
 }
 
@@ -1194,7 +945,7 @@ static void setupbio(BIO **res, BIO *bio1, BIO *bio2, int type)
 
 static int test_ssl_set_bio(int idx)
 {
-    SSL_CTX *ctx = SSL_CTX_new(TLS_method());
+    SSL_CTX *ctx;
     BIO *bio1 = NULL;
     BIO *bio2 = NULL;
     BIO *irbio = NULL, *iwbio = NULL, *nrbio = NULL, *nwbio = NULL;
@@ -1202,17 +953,6 @@ static int test_ssl_set_bio(int idx)
     int initrbio, initwbio, newrbio, newwbio;
     int testresult = 0;
 
-    if (ctx == NULL) {
-        printf(&quot;Failed to allocate SSL_CTX\n&quot;);
-        goto end;
-    }
-
-    ssl = SSL_new(ctx);
-    if (ssl == NULL) {
-        printf(&quot;Failed to allocate SSL object\n&quot;);
-        goto end;
-    }
-
     initrbio = idx % 3;
     idx /= 3;
     initwbio = idx % 3;
@@ -1220,24 +960,27 @@ static int test_ssl_set_bio(int idx)
     newrbio = idx % 3;
     idx /= 3;
     newwbio = idx;
-    OPENSSL_assert(newwbio &lt;= 2);
+    if (!TEST_int_le(newwbio, 2))
+        return 0;
+
+    if (!TEST_ptr(ctx = SSL_CTX_new(TLS_method()))
+                || !TEST_ptr(ssl = SSL_new(ctx)))
+        goto end;
 
-    if (initrbio == USE_BIO_1 || initwbio == USE_BIO_1 || newrbio == USE_BIO_1
+    if (initrbio == USE_BIO_1
+            || initwbio == USE_BIO_1
+            || newrbio == USE_BIO_1
             || newwbio == USE_BIO_1) {
-        bio1 = BIO_new(BIO_s_mem());
-        if (bio1 == NULL) {
-            printf(&quot;Failed to allocate bio1\n&quot;);
+        if (!TEST_ptr(bio1 = BIO_new(BIO_s_mem())))
             goto end;
-        }
     }
 
-    if (initrbio == USE_BIO_2 || initwbio == USE_BIO_2 || newrbio == USE_BIO_2
+    if (initrbio == USE_BIO_2
+            || initwbio == USE_BIO_2
+            || newrbio == USE_BIO_2
             || newwbio == USE_BIO_2) {
-        bio2 = BIO_new(BIO_s_mem());
-        if (bio2 == NULL) {
-            printf(&quot;Failed to allocate bio2\n&quot;);
+        if (!TEST_ptr(bio2 = BIO_new(BIO_s_mem())))
             goto end;
-        }
     }
 
     setupbio(&amp;irbio, bio1, bio2, initrbio);
@@ -1262,9 +1005,13 @@ static int test_ssl_set_bio(int idx)
      * SSL_set_bio() has some really complicated ownership rules where BIOs have
      * already been set!
      */
-    if (nrbio != NULL &amp;&amp; nrbio != irbio &amp;&amp; (nwbio != iwbio || nrbio != nwbio))
+    if (nrbio != NULL
+            &amp;&amp; nrbio != irbio
+            &amp;&amp; (nwbio != iwbio || nrbio != nwbio))
         BIO_up_ref(nrbio);
-    if (nwbio != NULL &amp;&amp; nwbio != nrbio &amp;&amp; (nwbio != iwbio || (nwbio == iwbio &amp;&amp; irbio == iwbio)))
+    if (nwbio != NULL
+            &amp;&amp; nwbio != nrbio
+            &amp;&amp; (nwbio != iwbio || (nwbio == iwbio &amp;&amp; irbio == iwbio)))
         BIO_up_ref(nwbio);
 
     SSL_set_bio(ssl, nrbio, nwbio);
@@ -1275,6 +1022,7 @@ static int test_ssl_set_bio(int idx)
     SSL_free(ssl);
     BIO_free(bio1);
     BIO_free(bio2);
+
     /*
      * This test is checking that the ref counting for SSL_set_bio is correct.
      * If we get here and we did too many frees then we will fail in the above
@@ -1282,7 +1030,6 @@ static int test_ssl_set_bio(int idx)
      * a crypto-mdebug build
      */
     SSL_CTX_free(ctx);
-
     return testresult;
 }
 
@@ -1299,7 +1046,6 @@ static SSL_BIO_TEST_FIXTURE ssl_bio_set_up(const char *const test_case_name)
     fixture.test_case_name = test_case_name;
     fixture.pop_ssl = 0;
     fixture.change_bio = NO_BIO_CHANGE;
-
     return fixture;
 }
 
@@ -1310,28 +1056,15 @@ static void ssl_bio_tear_down(SSL_BIO_TEST_FIXTURE fixture)
 static int execute_test_ssl_bio(SSL_BIO_TEST_FIXTURE fix)
 {
     BIO *sslbio = NULL, *membio1 = NULL, *membio2 = NULL;
-    SSL_CTX *ctx = SSL_CTX_new(TLS_method());
+    SSL_CTX *ctx;
     SSL *ssl = NULL;
     int testresult = 0;
 
-    if (ctx == NULL) {
-        printf(&quot;Failed to allocate SSL_CTX\n&quot;);
-        return 0;
-    }
-
-    ssl = SSL_new(ctx);
-    if (ssl == NULL) {
-        printf(&quot;Failed to allocate SSL object\n&quot;);
-        goto end;
-    }
-
-    sslbio = BIO_new(BIO_f_ssl());
-    membio1 = BIO_new(BIO_s_mem());
-
-    if (sslbio == NULL || membio1 == NULL) {
-        printf(&quot;Malloc failure creating BIOs\n&quot;);
+    if (!TEST_ptr(ctx = SSL_CTX_new(TLS_method()))
+            || !TEST_ptr(ssl = SSL_new(ctx))
+            || !TEST_ptr(sslbio = BIO_new(BIO_f_ssl()))
+            || !TEST_ptr(membio1 = BIO_new(BIO_s_mem())))
         goto end;
-    }
 
     BIO_set_ssl(sslbio, ssl, BIO_CLOSE);
 
@@ -1343,11 +1076,8 @@ static int execute_test_ssl_bio(SSL_BIO_TEST_FIXTURE fix)
 
     /* Verify changing the rbio/wbio directly does not cause leaks */
     if (fix.change_bio != NO_BIO_CHANGE) {
-        membio2 = BIO_new(BIO_s_mem());
-        if (membio2 == NULL) {
-            printf(&quot;Malloc failure creating membio2\n&quot;);
+        if (!TEST_ptr(membio2 = BIO_new(BIO_s_mem())))
             goto end;
-        }
         if (fix.change_bio == CHANGE_RBIO)
             SSL_set0_rbio(ssl, membio2);
         else
@@ -1373,34 +1103,27 @@ static int execute_test_ssl_bio(SSL_BIO_TEST_FIXTURE fix)
 static int test_ssl_bio_pop_next_bio(void)
 {
     SETUP_TEST_FIXTURE(SSL_BIO_TEST_FIXTURE, ssl_bio_set_up);
-
     EXECUTE_TEST(execute_test_ssl_bio, ssl_bio_tear_down);
 }
 
 static int test_ssl_bio_pop_ssl_bio(void)
 {
     SETUP_TEST_FIXTURE(SSL_BIO_TEST_FIXTURE, ssl_bio_set_up);
-
     fixture.pop_ssl = 1;
-
     EXECUTE_TEST(execute_test_ssl_bio, ssl_bio_tear_down);
 }
 
 static int test_ssl_bio_change_rbio(void)
 {
     SETUP_TEST_FIXTURE(SSL_BIO_TEST_FIXTURE, ssl_bio_set_up);
-
     fixture.change_bio = CHANGE_RBIO;
-
     EXECUTE_TEST(execute_test_ssl_bio, ssl_bio_tear_down);
 }
 
 static int test_ssl_bio_change_wbio(void)
 {
     SETUP_TEST_FIXTURE(SSL_BIO_TEST_FIXTURE, ssl_bio_set_up);
-
     fixture.change_bio = CHANGE_WBIO;
-
     EXECUTE_TEST(execute_test_ssl_bio, ssl_bio_tear_down);
 }
 
@@ -1444,7 +1167,8 @@ static const sigalgs_list testsigalgs[] = {
     {NULL, 0, &quot;RSA&quot;, 0, 0},
     {NULL, 0, &quot;SHA256&quot;, 0, 0},
     {NULL, 0, &quot;RSA+SHA256:SHA256&quot;, 0, 0},
-    {NULL, 0, &quot;Invalid&quot;, 0, 0}};
+    {NULL, 0, &quot;Invalid&quot;, 0, 0}
+};
 
 static int test_set_sigalgs(int idx)
 {
@@ -1455,18 +1179,17 @@ static int test_set_sigalgs(int idx)
     int testctx;
 
     /* Should never happen */
-    if ((size_t)idx &gt;= OSSL_NELEM(testsigalgs) * 2)
+    if (!TEST_size_t_le((size_t)idx, OSSL_NELEM(testsigalgs) * 2))
         return 0;
 
     testctx = ((size_t)idx &lt; OSSL_NELEM(testsigalgs));
     curr = testctx ? &amp;testsigalgs[idx]
                    : &amp;testsigalgs[idx - OSSL_NELEM(testsigalgs)];
 
-    if (!create_ssl_ctx_pair(TLS_server_method(), TLS_client_method(), &amp;sctx,
-                             &amp;cctx, cert, privkey)) {
-        printf(&quot;Unable to create SSL_CTX pair\n&quot;);
+    if (!TEST_true(create_ssl_ctx_pair(TLS_server_method(),
+                                       TLS_client_method(), &amp;sctx,
+                                       &amp;cctx, cert, privkey)))
         return 0;
-    }
 
     /*
      * TODO(TLS1.3): These APIs cannot set TLSv1.3 sig algs so we just test it
@@ -1476,6 +1199,7 @@ static int test_set_sigalgs(int idx)
 
     if (testctx) {
         int ret;
+
         if (curr-&gt;list != NULL)
             ret = SSL_CTX_set1_sigalgs(cctx, curr-&gt;list, curr-&gt;listlen);
         else
@@ -1483,22 +1207,20 @@ static int test_set_sigalgs(int idx)
 
         if (!ret) {
             if (curr-&gt;valid)
-                printf(&quot;Unexpected failure setting sigalgs in SSL_CTX (%d)\n&quot;,
-                       idx);
+                TEST_info(&quot;Failure setting sigalgs in SSL_CTX (%d)\n&quot;, idx);
             else
                 testresult = 1;
             goto end;
         }
         if (!curr-&gt;valid) {
-            printf(&quot;Unexpected success setting sigalgs in SSL_CTX (%d)\n&quot;, idx);
+            TEST_info(&quot;Not-failed setting sigalgs in SSL_CTX (%d)\n&quot;, idx);
             goto end;
         }
     }
 
-    if (!create_ssl_objects(sctx, cctx, &amp;serverssl, &amp;clientssl, NULL, NULL)) {
-        printf(&quot;Unable to create SSL objects\n&quot;);
+    if (!TEST_true(create_ssl_objects(sctx, cctx, &amp;serverssl,
+                                      &amp;clientssl, NULL, NULL)))
         goto end;
-    }
 
     if (!testctx) {
         int ret;
@@ -1509,21 +1231,19 @@ static int test_set_sigalgs(int idx)
             ret = SSL_set1_sigalgs_list(clientssl, curr-&gt;liststr);
         if (!ret) {
             if (curr-&gt;valid)
-                printf(&quot;Unexpected failure setting sigalgs in SSL (%d)\n&quot;, idx);
+                TEST_info(&quot;Failure setting sigalgs in SSL (%d)\n&quot;, idx);
             else
                 testresult = 1;
             goto end;
         }
-        if (!curr-&gt;valid) {
-            printf(&quot;Unexpected success setting sigalgs in SSL (%d)\n&quot;, idx);
+        if (!curr-&gt;valid)
             goto end;
-        }
     }
 
-    if (curr-&gt;connsuccess != create_ssl_connection(serverssl, clientssl, SSL_ERROR_NONE)) {
-        printf(&quot;Unexpected return value creating SSL connection (%d)\n&quot;, idx);
+    if (!TEST_int_eq(create_ssl_connection(serverssl, clientssl,
+                                           SSL_ERROR_NONE),
+                curr-&gt;connsuccess))
         goto end;
-    }
 
     testresult = 1;
 
@@ -1553,11 +1273,10 @@ static int test_set_sigalgs(int idx)
 static int setupearly_data_test(SSL_CTX **cctx, SSL_CTX **sctx, SSL **clientssl,
                                 SSL **serverssl, SSL_SESSION **sess, int idx)
 {
-    if (!create_ssl_ctx_pair(TLS_server_method(), TLS_client_method(), sctx,
-                             cctx, cert, privkey)) {
-        printf(&quot;Unable to create SSL_CTX pair\n&quot;);
+    if (!TEST_true(create_ssl_ctx_pair(TLS_server_method(),
+                                       TLS_client_method(), sctx,
+                                       cctx, cert, privkey)))
         return 0;
-    }
 
     /* When idx == 1 we repeat the tests with read_ahead set */
     if (idx &gt; 0) {
@@ -1565,34 +1284,23 @@ static int setupearly_data_test(SSL_CTX **cctx, SSL_CTX **sctx, SSL **clientssl,
         SSL_CTX_set_read_ahead(*sctx, 1);
     }
 
-    if (!create_ssl_objects(*sctx, *cctx, serverssl, clientssl, NULL, NULL)) {
-        printf(&quot;Unable to create SSL objects\n&quot;);
+    if (!TEST_true(create_ssl_objects(*sctx, *cctx, serverssl, clientssl,
+                                      NULL, NULL))
+            || !TEST_true(create_ssl_connection(*serverssl, *clientssl,
+                                                SSL_ERROR_NONE)))
         return 0;
-    }
-
-    if (!create_ssl_connection(*serverssl, *clientssl, SSL_ERROR_NONE)) {
-        printf(&quot;Unable to create SSL connection\n&quot;);
-        return 0;
-    }
 
     *sess = SSL_get1_session(*clientssl);
-
     SSL_shutdown(*clientssl);
     SSL_shutdown(*serverssl);
-
     SSL_free(*serverssl);
     SSL_free(*clientssl);
     *serverssl = *clientssl = NULL;
 
-    if (!create_ssl_objects(*sctx, *cctx, serverssl, clientssl, NULL, NULL)) {
-        printf(&quot;Unable to create SSL objects (2)\n&quot;);
+    if (!TEST_true(create_ssl_objects(*sctx, *cctx, serverssl,
+                                      clientssl, NULL, NULL))
+            || !TEST_true(SSL_set_session(*clientssl, *sess)))
         return 0;
-    }
-
-    if (!SSL_set_session(*clientssl, *sess)) {
-        printf(&quot;Failed setting session\n&quot;);
-        return 0;
-    }
 
     return 1;
 }
@@ -1607,90 +1315,63 @@ static int test_early_data_read_write(int idx)
     size_t readbytes, written, eoedlen, rawread, rawwritten;
     BIO *rbio;
 
-    if (!setupearly_data_test(&amp;cctx, &amp;sctx, &amp;clientssl, &amp;serverssl, &amp;sess, idx))
+    if (!TEST_true(setupearly_data_test(&amp;cctx, &amp;sctx, &amp;clientssl,
+                                        &amp;serverssl, &amp;sess, idx)))
         goto end;
 
     /* Write and read some early data */
-    if (!SSL_write_early_data(clientssl, MSG1, strlen(MSG1), &amp;written)
-            || written != strlen(MSG1)) {
-        printf(&quot;Failed writing early data message 1\n&quot;);
+    if (!TEST_true(SSL_write_early_data(clientssl, MSG1, strlen(MSG1),
+                                        &amp;written))
+            || !TEST_size_t_eq(written, strlen(MSG1))
+            || !TEST_int_eq(SSL_read_early_data(serverssl, buf,
+                                                sizeof(buf), &amp;readbytes),
+                            SSL_READ_EARLY_DATA_SUCCESS)
+            || !TEST_mem_eq(MSG1, readbytes, buf, strlen(MSG1))
+            || !TEST_int_eq(SSL_get_early_data_status(serverssl),
+                            SSL_EARLY_DATA_ACCEPTED))
         goto end;
-    }
-
-    if (SSL_read_early_data(serverssl, buf, sizeof(buf), &amp;readbytes)
-                != SSL_READ_EARLY_DATA_SUCCESS
-            || readbytes != strlen(MSG1)
-            || memcmp(MSG1, buf, strlen(MSG1))) {
-        printf(&quot;Failed reading early data message 1\n&quot;);
-        goto end;
-    }
-
-    if (SSL_get_early_data_status(serverssl) != SSL_EARLY_DATA_ACCEPTED) {
-        printf(&quot;Unexpected early data status\n&quot;);
-        goto end;
-    }
 
     /*
      * Server should be able to write data, and client should be able to
      * read it.
      */
-    if (!SSL_write_early_data(serverssl, MSG2, strlen(MSG2), &amp;written)
-            || written != strlen(MSG2)) {
-        printf(&quot;Failed writing message 2\n&quot;);
+    if (!TEST_true(SSL_write_early_data(serverssl, MSG2, strlen(MSG2),
+                                        &amp;written))
+            || !TEST_size_t_eq(written, strlen(MSG2))
+            || !TEST_true(SSL_read_ex(clientssl, buf, sizeof(buf), &amp;readbytes))
+            || !TEST_mem_eq(buf, readbytes, MSG2, strlen(MSG2)))
         goto end;
-    }
-
-    if (!SSL_read_ex(clientssl, buf, sizeof(buf), &amp;readbytes)
-            || readbytes != strlen(MSG2)
-            || memcmp(MSG2, buf, strlen(MSG2))) {
-        printf(&quot;Failed reading message 2\n&quot;);
-        goto end;
-    }
 
     /* Even after reading normal data, client should be able write early data */
-    if (!SSL_write_early_data(clientssl, MSG3, strlen(MSG3), &amp;written)
-            || written != strlen(MSG3)) {
-        printf(&quot;Failed writing early data message 3\n&quot;);
+    if (!TEST_true(SSL_write_early_data(clientssl, MSG3, strlen(MSG3),
+                                        &amp;written))
+            || !TEST_size_t_eq(written, strlen(MSG3)))
         goto end;
-    }
 
     /* Server should still be able read early data after writing data */
-    if (SSL_read_early_data(serverssl, buf, sizeof(buf), &amp;readbytes)
-                != SSL_READ_EARLY_DATA_SUCCESS
-            || readbytes != strlen(MSG3)
-            || memcmp(MSG3, buf, strlen(MSG3))) {
-        printf(&quot;Failed reading early data message 3\n&quot;);
+    if (!TEST_int_eq(SSL_read_early_data(serverssl, buf, sizeof(buf),
+                                         &amp;readbytes),
+                     SSL_READ_EARLY_DATA_SUCCESS)
+            || !TEST_mem_eq(buf, readbytes, MSG3, strlen(MSG3)))
         goto end;
-    }
 
     /* Write more data from server and read it from client */
-    if (!SSL_write_early_data(serverssl, MSG4, strlen(MSG4), &amp;written)
-            || written != strlen(MSG4)) {
-        printf(&quot;Failed writing message 4\n&quot;);
+    if (!TEST_true(SSL_write_early_data(serverssl, MSG4, strlen(MSG4),
+                                        &amp;written))
+            || !TEST_size_t_eq(written, strlen(MSG4))
+            || !TEST_true(SSL_read_ex(clientssl, buf, sizeof(buf), &amp;readbytes))
+            || !TEST_mem_eq(buf, readbytes, MSG4, strlen(MSG4)))
         goto end;
-    }
-
-    if (!SSL_read_ex(clientssl, buf, sizeof(buf), &amp;readbytes)
-            || readbytes != strlen(MSG4)
-            || memcmp(MSG4, buf, strlen(MSG4))) {
-        printf(&quot;Failed reading message 4\n&quot;);
-        goto end;
-    }
 
     /*
      * If client writes normal data it should mean writing early data is no
      * longer possible.
      */
-    if (!SSL_write_ex(clientssl, MSG5, strlen(MSG5), &amp;written)
-            || written != strlen(MSG5)) {
-        printf(&quot;Failed writing message 5\n&quot;);
+    if (!TEST_true(SSL_write_ex(clientssl, MSG5, strlen(MSG5), &amp;written))
+            || !TEST_size_t_eq(written, strlen(MSG5))
+            || !TEST_int_eq(SSL_get_early_data_status(clientssl),
+                            SSL_EARLY_DATA_ACCEPTED))
         goto end;
-    }
-
-    if (SSL_get_early_data_status(clientssl) != SSL_EARLY_DATA_ACCEPTED) {
-        printf(&quot;Unexpected early data status(2)\n&quot;);
-        goto end;
-    }
 
     /*
      * At this point the client has written EndOfEarlyData, ClientFinished and
@@ -1699,181 +1380,134 @@ static int test_early_data_read_write(int idx)
      * in the read BIO, and then just put back the EndOfEarlyData message.
      */
     rbio = SSL_get_rbio(serverssl);
-    if (!BIO_read_ex(rbio, data, sizeof(data), &amp;rawread)
-            || rawread &gt;= sizeof(data)
-            || rawread &lt; SSL3_RT_HEADER_LENGTH) {
-        printf(&quot;Failed reading data from rbio\n&quot;);
+    if (!TEST_true(BIO_read_ex(rbio, data, sizeof(data), &amp;rawread))
+            || !TEST_size_t_lt(rawread, sizeof(data))
+            || !TEST_size_t_gt(rawread, SSL3_RT_HEADER_LENGTH))
         goto end;
-    }
+
     /* Record length is in the 4th and 5th bytes of the record header */
     eoedlen = SSL3_RT_HEADER_LENGTH + (data[3] &lt;&lt; 8 | data[4]);
-    if (!BIO_write_ex(rbio, data, eoedlen, &amp;rawwritten)
-            || rawwritten != eoedlen) {
-        printf(&quot;Failed to write the EndOfEarlyData message to server rbio\n&quot;);
+    if (!TEST_true(BIO_write_ex(rbio, data, eoedlen, &amp;rawwritten))
+            || !TEST_size_t_eq(rawwritten, eoedlen))
         goto end;
-    }
 
     /* Server should be told that there is no more early data */
-    if (SSL_read_early_data(serverssl, buf, sizeof(buf), &amp;readbytes)
-                != SSL_READ_EARLY_DATA_FINISH
-            || readbytes != 0) {
-        printf(&quot;Failed finishing read of early data\n&quot;);
+    if (!TEST_int_eq(SSL_read_early_data(serverssl, buf, sizeof(buf),
+                                         &amp;readbytes),
+                     SSL_READ_EARLY_DATA_FINISH)
+            || !TEST_size_t_eq(readbytes, 0))
         goto end;
-    }
 
     /*
      * Server has not finished init yet, so should still be able to write early
      * data.
      */
-    if (!SSL_write_early_data(serverssl, MSG6, strlen(MSG6), &amp;written)
-            || written != strlen(MSG6)) {
-        printf(&quot;Failed writing early data message 6\n&quot;);
+    if (!TEST_true(SSL_write_early_data(serverssl, MSG6, strlen(MSG6),
+                                        &amp;written))
+            || !TEST_size_t_eq(written, strlen(MSG6)))
         goto end;
-    }
 
     /* Push the ClientFinished and the normal data back into the server rbio */
-    if (!BIO_write_ex(rbio, data + eoedlen, rawread - eoedlen, &amp;rawwritten)
-            || rawwritten != rawread - eoedlen) {
-        printf(&quot;Failed to write the ClientFinished and data to server rbio\n&quot;);
+    if (!TEST_true(BIO_write_ex(rbio, data + eoedlen, rawread - eoedlen,
+                                &amp;rawwritten))
+            || !TEST_size_t_eq(rawwritten, rawread - eoedlen))
         goto end;
-    }
 
     /* Server should be able to read normal data */
-    if (!SSL_read_ex(serverssl, buf, sizeof(buf), &amp;readbytes)
-            || readbytes != strlen(MSG5)) {
-        printf(&quot;Failed reading message 5\n&quot;);
+    if (!TEST_true(SSL_read_ex(serverssl, buf, sizeof(buf), &amp;readbytes))
+            || !TEST_size_t_eq(readbytes, strlen(MSG5)))
         goto end;
-    }
 
     /* Client and server should not be able to write/read early data now */
-    if (SSL_write_early_data(clientssl, MSG6, strlen(MSG6), &amp;written)) {
-        printf(&quot;Unexpected success writing early data\n&quot;);
+    if (!TEST_false(SSL_write_early_data(clientssl, MSG6, strlen(MSG6),
+                                         &amp;written)))
         goto end;
-    }
     ERR_clear_error();
-
-    if (SSL_read_early_data(serverssl, buf, sizeof(buf), &amp;readbytes)
-                != SSL_READ_EARLY_DATA_ERROR) {
-        printf(&quot;Unexpected success reading early data\n&quot;);
+    if (!TEST_int_eq(SSL_read_early_data(serverssl, buf, sizeof(buf),
+                                         &amp;readbytes),
+                     SSL_READ_EARLY_DATA_ERROR))
         goto end;
-    }
     ERR_clear_error();
 
     /* Client should be able to read the data sent by the server */
-    if (!SSL_read_ex(clientssl, buf, sizeof(buf), &amp;readbytes)
-            || readbytes != strlen(MSG6)
-            || memcmp(MSG6, buf, strlen(MSG6))) {
-        printf(&quot;Failed reading message 6\n&quot;);
+    if (!TEST_true(SSL_read_ex(clientssl, buf, sizeof(buf), &amp;readbytes))
+            || !TEST_mem_eq(buf, readbytes, MSG6, strlen(MSG6)))
         goto end;
-    }
+
     /*
      * Make sure we process the NewSessionTicket. This arrives post-handshake.
      * We attempt a read which we do not expect to return any data.
      */
-    if (SSL_read_ex(clientssl, buf, sizeof(buf), &amp;readbytes)) {
-        printf(&quot;Unexpected success doing final client read\n&quot;);
+    if (!TEST_false(SSL_read_ex(clientssl, buf, sizeof(buf), &amp;readbytes)))
         goto end;
-    }
 
     /* Server should be able to write normal data */
-    if (!SSL_write_ex(serverssl, MSG7, strlen(MSG7), &amp;written)
-            || written != strlen(MSG7)) {
-        printf(&quot;Failed writing normal data message 7\n&quot;);
-        goto end;
-    }
-    if (!SSL_read_ex(clientssl, buf, sizeof(buf), &amp;readbytes)
-            || readbytes != strlen(MSG7)
-            || memcmp(MSG7, buf, strlen(MSG7))) {
-        printf(&quot;Failed reading message 7\n&quot;);
+    if (!TEST_true(SSL_write_ex(serverssl, MSG7, strlen(MSG7), &amp;written))
+            || !TEST_size_t_eq(written, strlen(MSG7))
+            || !TEST_true(SSL_read_ex(clientssl, buf, sizeof(buf), &amp;readbytes))
+            || !TEST_mem_eq(buf, readbytes, MSG7, strlen(MSG7)))
         goto end;
-    }
 
     SSL_SESSION_free(sess);
     sess = SSL_get1_session(clientssl);
 
     SSL_shutdown(clientssl);
     SSL_shutdown(serverssl);
-
     SSL_free(serverssl);
     SSL_free(clientssl);
     serverssl = clientssl = NULL;
-
-    if (!create_ssl_objects(sctx, cctx, &amp;serverssl, &amp;clientssl, NULL, NULL)) {
-        printf(&quot;Unable to create SSL objects (3)\n&quot;);
-        goto end;
-    }
-
-    if (!SSL_set_session(clientssl, sess)) {
-        printf(&quot;Failed setting session (2)\n&quot;);
+    if (!TEST_true(create_ssl_objects(sctx, cctx, &amp;serverssl,
+                                      &amp;clientssl, NULL, NULL))
+            || !TEST_true(SSL_set_session(clientssl, sess)))
         goto end;
-    }
 
     /* Write and read some early data */
-    if (!SSL_write_early_data(clientssl, MSG1, strlen(MSG1), &amp;written)
-            || written != strlen(MSG1)) {
-        printf(&quot;Failed writing early data message 1\n&quot;);
-        goto end;
-    }
-
-    if (SSL_read_early_data(serverssl, buf, sizeof(buf), &amp;readbytes)
-                != SSL_READ_EARLY_DATA_SUCCESS
-            || readbytes != strlen(MSG1)
-            || memcmp(MSG1, buf, strlen(MSG1))) {
-        printf(&quot;Failed reading early data message 1\n&quot;);
+    if (!TEST_true(SSL_write_early_data(clientssl, MSG1, strlen(MSG1),
+                                        &amp;written))
+            || !TEST_size_t_eq(written, strlen(MSG1))
+            || !TEST_int_eq(SSL_read_early_data(serverssl, buf, sizeof(buf),
+                                                &amp;readbytes),
+                            SSL_READ_EARLY_DATA_SUCCESS)
+            || !TEST_mem_eq(buf, readbytes, MSG1, strlen(MSG1)))
         goto end;
-    }
 
-    if (SSL_connect(clientssl) &lt;= 0) {
-        printf(&quot;Unable to complete client handshake\n&quot;);
+    if (!TEST_int_gt(SSL_connect(clientssl), 0)
+            || !TEST_int_gt(SSL_accept(serverssl), 0))
         goto end;
-    }
-
-    if (SSL_accept(serverssl) &lt;= 0) {
-        printf(&quot;Unable to complete server handshake\n&quot;);
-        goto end;
-    }
 
     /* Client and server should not be able to write/read early data now */
-    if (SSL_write_early_data(clientssl, MSG6, strlen(MSG6), &amp;written)) {
-        printf(&quot;Unexpected success writing early data (2)\n&quot;);
+    if (!TEST_false(SSL_write_early_data(clientssl, MSG6, strlen(MSG6),
+                                         &amp;written)))
         goto end;
-    }
     ERR_clear_error();
-
-    if (SSL_read_early_data(serverssl, buf, sizeof(buf), &amp;readbytes)
-                != SSL_READ_EARLY_DATA_ERROR) {
-        printf(&quot;Unexpected success reading early data (2)\n&quot;);
+    if (!TEST_int_eq(SSL_read_early_data(serverssl, buf, sizeof(buf),
+                                         &amp;readbytes),
+                     SSL_READ_EARLY_DATA_ERROR))
         goto end;
-    }
     ERR_clear_error();
 
     /* Client and server should be able to write/read normal data */
-    if (!SSL_write_ex(clientssl, MSG5, strlen(MSG5), &amp;written)
-            || written != strlen(MSG5)) {
-        printf(&quot;Failed writing message 5 (2)\n&quot;);
+    if (!TEST_true(SSL_write_ex(clientssl, MSG5, strlen(MSG5), &amp;written))
+            || !TEST_size_t_eq(written, strlen(MSG5))
+            || !TEST_true(SSL_read_ex(serverssl, buf, sizeof(buf), &amp;readbytes))
+            || !TEST_size_t_eq(readbytes, strlen(MSG5)))
         goto end;
-    }
-
-    if (!SSL_read_ex(serverssl, buf, sizeof(buf), &amp;readbytes)
-            || readbytes != strlen(MSG5)) {
-        printf(&quot;Failed reading message 5 (2)\n&quot;);
-        goto end;
-    }
 
     testresult = 1;
 
  end:
-    if(!testresult)
-        ERR_print_errors_fp(stdout);
     SSL_SESSION_free(sess);
     SSL_free(serverssl);
     SSL_free(clientssl);
     SSL_CTX_free(sctx);
     SSL_CTX_free(cctx);
-
     return testresult;
 }
 
+/*
+ * Test that a server attempting to read early data can handle a connection
+ * from a client where the early data is not acceptable.
+ */
 static int test_early_data_skip(int idx)
 {
     SSL_CTX *cctx = NULL, *sctx = NULL;
@@ -1883,12 +1517,8 @@ static int test_early_data_skip(int idx)
     unsigned char buf[20];
     size_t readbytes, written;
 
-    /*
-     * Test that a server attempting to read early data can handle a connection
-     * from a client where the early data is not acceptable.
-     */
-
-    if (!setupearly_data_test(&amp;cctx, &amp;sctx, &amp;clientssl, &amp;serverssl, &amp;sess, idx))
+    if (!TEST_true(setupearly_data_test(&amp;cctx, &amp;sctx, &amp;clientssl,
+                                        &amp;serverssl, &amp;sess, idx)))
         goto end;
 
     /*
@@ -1896,66 +1526,48 @@ static int test_early_data_skip(int idx)
      * It could be any value as long as it is not within tolerance. This should
      * mean the ticket is rejected.
      */
-    if (!SSL_SESSION_set_time(sess, time(NULL) - 20)) {
-        printf(&quot;Unexpected failure setting session creation time\n&quot;);
+    if (!TEST_true(SSL_SESSION_set_time(sess, time(NULL) - 20)))
         goto end;
-    }
 
     /* Write some early data */
-    if (!SSL_write_early_data(clientssl, MSG1, strlen(MSG1), &amp;written)
-            || written != strlen(MSG1)) {
-        printf(&quot;Failed writing early data message 1\n&quot;);
+    if (!TEST_true(SSL_write_early_data(clientssl, MSG1, strlen(MSG1),
+                                        &amp;written))
+            || !TEST_size_t_eq(written, strlen(MSG1)))
         goto end;
-    }
 
     /* Server should reject the early data and skip over it */
-    if (SSL_read_early_data(serverssl, buf, sizeof(buf), &amp;readbytes)
-                != SSL_READ_EARLY_DATA_FINISH
-            || readbytes != 0) {
-        printf(&quot;Failed reading early data\n&quot;);
+    if (!TEST_int_eq(SSL_read_early_data(serverssl, buf, sizeof(buf),
+                                         &amp;readbytes),
+                     SSL_READ_EARLY_DATA_FINISH)
+            || !TEST_size_t_eq(readbytes, 0)
+            || !TEST_int_eq(SSL_get_early_data_status(serverssl),
+                            SSL_EARLY_DATA_REJECTED))
         goto end;
-    }
 
-    if (SSL_get_early_data_status(serverssl) != SSL_EARLY_DATA_REJECTED) {
-        printf(&quot;Unexpected early data status\n&quot;);
+    /* Should be able to send normal data despite rejection of early data */
+    if (!TEST_true(SSL_write_ex(clientssl, MSG2, strlen(MSG2), &amp;written))
+            || !TEST_size_t_eq(written, strlen(MSG2))
+            || !TEST_int_eq(SSL_get_early_data_status(clientssl),
+                            SSL_EARLY_DATA_REJECTED)
+            || !TEST_true(SSL_read_ex(serverssl, buf, sizeof(buf), &amp;readbytes))
+            || !TEST_mem_eq(buf, readbytes, MSG2, strlen(MSG2)))
         goto end;
-    }
-
-    /*
-     * We should be able to send normal data despite rejection of early data
-     */
-    if (!SSL_write_ex(clientssl, MSG2, strlen(MSG2), &amp;written)
-            || written != strlen(MSG2)) {
-        printf(&quot;Failed writing message 2\n&quot;);
-        goto end;
-    }
-
-    if (SSL_get_early_data_status(clientssl) != SSL_EARLY_DATA_REJECTED) {
-        printf(&quot;Unexpected early data status (2)\n&quot;);
-        goto end;
-    }
-
-    if (!SSL_read_ex(serverssl, buf, sizeof(buf), &amp;readbytes)
-            || readbytes != strlen(MSG2)
-            || memcmp(MSG2, buf, strlen(MSG2))) {
-        printf(&quot;Failed reading message 2\n&quot;);
-        goto end;
-    }
 
     testresult = 1;
 
  end:
-    if(!testresult)
-        ERR_print_errors_fp(stdout);
     SSL_SESSION_free(sess);
     SSL_free(serverssl);
     SSL_free(clientssl);
     SSL_CTX_free(sctx);
     SSL_CTX_free(cctx);
-
     return testresult;
 }
 
+/*
+ * Test that a server attempting to read early data can handle a connection
+ * from a client that doesn't send any.
+ */
 static int test_early_data_not_sent(int idx)
 {
     SSL_CTX *cctx = NULL, *sctx = NULL;
@@ -1965,91 +1577,63 @@ static int test_early_data_not_sent(int idx)
     unsigned char buf[20];
     size_t readbytes, written;
 
-    /*
-     * Test that a server attempting to read early data can handle a connection
-     * from a client that doesn't send any.
-     */
-
-    if (!setupearly_data_test(&amp;cctx, &amp;sctx, &amp;clientssl, &amp;serverssl, &amp;sess, idx))
+    if (!TEST_true(setupearly_data_test(&amp;cctx, &amp;sctx, &amp;clientssl,
+                                        &amp;serverssl, &amp;sess, idx)))
         goto end;
 
     /* Write some data - should block due to handshake with server */
     SSL_set_connect_state(clientssl);
-    if (SSL_write_ex(clientssl, MSG1, strlen(MSG1), &amp;written)) {
-        printf(&quot;Unexpected success writing message 1\n&quot;);
+    if (!TEST_false(SSL_write_ex(clientssl, MSG1, strlen(MSG1), &amp;written)))
         goto end;
-    }
 
     /* Server should detect that early data has not been sent */
-    if (SSL_read_early_data(serverssl, buf, sizeof(buf), &amp;readbytes)
-                != SSL_READ_EARLY_DATA_FINISH
-            || readbytes != 0) {
-        printf(&quot;Failed reading early data\n&quot;);
-        goto end;
-    }
-
-    if (SSL_get_early_data_status(serverssl) != SSL_EARLY_DATA_NOT_SENT) {
-        printf(&quot;Unexpected early data status\n&quot;);
-        goto end;
-    }
-
-    if (SSL_get_early_data_status(clientssl) != SSL_EARLY_DATA_NOT_SENT) {
-        printf(&quot;Unexpected early data status (2)\n&quot;);
+    if (!TEST_int_eq(SSL_read_early_data(serverssl, buf, sizeof(buf),
+                                         &amp;readbytes),
+                     SSL_READ_EARLY_DATA_FINISH)
+            || !TEST_size_t_eq(readbytes, 0)
+            || !TEST_int_eq(SSL_get_early_data_status(serverssl),
+                            SSL_EARLY_DATA_NOT_SENT)
+            || !TEST_int_eq(SSL_get_early_data_status(clientssl),
+                            SSL_EARLY_DATA_NOT_SENT))
         goto end;
-    }
 
     /* Continue writing the message we started earlier */
-    if (!SSL_write_ex(clientssl, MSG1, strlen(MSG1), &amp;written)
-            || written != strlen(MSG1)) {
-        printf(&quot;Failed writing message 1\n&quot;);
+    if (!TEST_true(SSL_write_ex(clientssl, MSG1, strlen(MSG1), &amp;written))
+            || !TEST_size_t_eq(written, strlen(MSG1))
+            || !TEST_true(SSL_read_ex(serverssl, buf, sizeof(buf), &amp;readbytes))
+            || !TEST_mem_eq(buf, readbytes, MSG1, strlen(MSG1))
+            || !SSL_write_ex(serverssl, MSG2, strlen(MSG2), &amp;written)
+            || !TEST_size_t_eq(written, strlen(MSG2)))
         goto end;
-    }
-
-    if (!SSL_read_ex(serverssl, buf, sizeof(buf), &amp;readbytes)
-            || readbytes != strlen(MSG1)
-            || memcmp(MSG1, buf, strlen(MSG1))) {
-        printf(&quot;Failed reading message 1\n&quot;);
-        goto end;
-    }
-
-    if (!SSL_write_ex(serverssl, MSG2, strlen(MSG2), &amp;written)
-            || written != strlen(MSG2)) {
-        printf(&quot;Failed writing message 2\n&quot;);
-        goto end;
-    }
 
     /*
      * Should block due to the NewSessionTicket arrival unless we're using
      * read_ahead
      */
     if (idx == 0) {
-        if (SSL_read_ex(clientssl, buf, sizeof(buf), &amp;readbytes)) {
-            printf(&quot;Unexpected success reading message 2\n&quot;);
+        if (!TEST_false(SSL_read_ex(clientssl, buf, sizeof(buf), &amp;readbytes)))
             goto end;
-        }
     }
 
-    if (!SSL_read_ex(clientssl, buf, sizeof(buf), &amp;readbytes)
-            || readbytes != strlen(MSG2)
-            || memcmp(MSG2, buf, strlen(MSG2))) {
-        printf(&quot;Failed reading message 2\n&quot;);
+    if (!TEST_true(SSL_read_ex(clientssl, buf, sizeof(buf), &amp;readbytes))
+            || !TEST_mem_eq(buf, readbytes, MSG2, strlen(MSG2)))
         goto end;
-    }
 
     testresult = 1;
 
  end:
-    if(!testresult)
-        ERR_print_errors_fp(stdout);
     SSL_SESSION_free(sess);
     SSL_free(serverssl);
     SSL_free(clientssl);
     SSL_CTX_free(sctx);
     SSL_CTX_free(cctx);
-
     return testresult;
 }
 
+/*
+ * Test that a server that doesn't try to read early data can handle a
+ * client sending some.
+ */
 static int test_early_data_not_expected(int idx)
 {
     SSL_CTX *cctx = NULL, *sctx = NULL;
@@ -2059,79 +1643,55 @@ static int test_early_data_not_expected(int idx)
     unsigned char buf[20];
     size_t readbytes, written;
 
-    /*
-     * Test that a server that doesn't try to read early data can handle a
-     * client sending some.
-     */
 
-    if (!setupearly_data_test(&amp;cctx, &amp;sctx, &amp;clientssl, &amp;serverssl, &amp;sess, idx))
+    if (!TEST_true(setupearly_data_test(&amp;cctx, &amp;sctx, &amp;clientssl,
+                                        &amp;serverssl, &amp;sess, idx)))
         goto end;
 
     /* Write some early data */
-    if (!SSL_write_early_data(clientssl, MSG1, strlen(MSG1), &amp;written)) {
-        printf(&quot;Unexpected failure writing message 1\n&quot;);
+    if (!TEST_true(SSL_write_early_data(clientssl, MSG1, strlen(MSG1),
+                                        &amp;written)))
         goto end;
-    }
 
     /*
      * Server should skip over early data and then block waiting for client to
      * continue handshake
      */
-    if (SSL_accept(serverssl) &gt; 0) {
-        printf(&quot;Unexpected success setting up server connection\n&quot;);
+    if (!TEST_int_le(SSL_accept(serverssl), 0)
+     || !TEST_int_gt(SSL_connect(clientssl), 0)
+     || !TEST_int_eq(SSL_get_early_data_status(serverssl),
+                     SSL_EARLY_DATA_REJECTED)
+     || !TEST_int_gt(SSL_accept(serverssl), 0)
+     || !TEST_int_eq(SSL_get_early_data_status(clientssl),
+                     SSL_EARLY_DATA_REJECTED))
         goto end;
-    }
-
-    if (SSL_connect(clientssl) &lt;= 0) {
-        printf(&quot;Failed setting up client connection\n&quot;);
-        goto end;
-    }
-
-    if (SSL_get_early_data_status(serverssl) != SSL_EARLY_DATA_REJECTED) {
-        printf(&quot;Unexpected early data status\n&quot;);
-        goto end;
-    }
-
-    if (SSL_accept(serverssl) &lt;= 0) {
-        printf(&quot;Failed setting up server connection\n&quot;);
-        goto end;
-    }
-
-    if (SSL_get_early_data_status(clientssl) != SSL_EARLY_DATA_REJECTED) {
-        printf(&quot;Unexpected early data status (2)\n&quot;);
-        goto end;
-    }
 
     /* Send some normal data from client to server */
-    if (!SSL_write_ex(clientssl, MSG2, strlen(MSG2), &amp;written)
-            || written != strlen(MSG2)) {
-        printf(&quot;Failed writing message 2\n&quot;);
+    if (!TEST_true(SSL_write_ex(clientssl, MSG2, strlen(MSG2), &amp;written))
+            || !TEST_size_t_eq(written, strlen(MSG2)))
         goto end;
-    }
 
-    if (!SSL_read_ex(serverssl, buf, sizeof(buf), &amp;readbytes)
-            || readbytes != strlen(MSG2)
-            || memcmp(MSG2, buf, strlen(MSG2))) {
-        printf(&quot;Failed reading message 2\n&quot;);
+    if (!TEST_true(SSL_read_ex(serverssl, buf, sizeof(buf), &amp;readbytes))
+            || !TEST_mem_eq(buf, readbytes, MSG2, strlen(MSG2)))
         goto end;
-    }
 
     testresult = 1;
 
  end:
-    if(!testresult)
-        ERR_print_errors_fp(stdout);
     SSL_SESSION_free(sess);
     SSL_free(serverssl);
     SSL_free(clientssl);
     SSL_CTX_free(sctx);
     SSL_CTX_free(cctx);
-
     return testresult;
 }
 
 
 # ifndef OPENSSL_NO_TLS1_2
+/*
+ * Test that a server attempting to read early data can handle a connection
+ * from a TLSv1.2 client.
+ */
 static int test_early_data_tls1_2(int idx)
 {
     SSL_CTX *cctx = NULL, *sctx = NULL;
@@ -2140,16 +1700,10 @@ static int test_early_data_tls1_2(int idx)
     unsigned char buf[20];
     size_t readbytes, written;
 
-    /*
-     * Test that a server attempting to read early data can handle a connection
-     * from a TLSv1.2 client.
-     */
-
-    if (!create_ssl_ctx_pair(TLS_server_method(), TLS_client_method(), &amp;sctx,
-                             &amp;cctx, cert, privkey)) {
-        printf(&quot;Unable to create SSL_CTX pair\n&quot;);
+    if (!TEST_true(create_ssl_ctx_pair(TLS_server_method(),
+                                       TLS_client_method(), &amp;sctx,
+                                       &amp;cctx, cert, privkey)))
         goto end;
-    }
 
     /* When idx == 1 we repeat the tests with read_ahead set */
     if (idx &gt; 0) {
@@ -2157,88 +1711,55 @@ static int test_early_data_tls1_2(int idx)
         SSL_CTX_set_read_ahead(sctx, 1);
     }
 
-    if (!create_ssl_objects(sctx, cctx, &amp;serverssl, &amp;clientssl, NULL, NULL)) {
-        printf(&quot;Unable to create SSL objects\n&quot;);
+    if (!TEST_true(create_ssl_objects(sctx, cctx, &amp;serverssl,
+                                      &amp;clientssl, NULL, NULL)))
         goto end;
-    }
 
     /* Write some data - should block due to handshake with server */
     SSL_set_max_proto_version(clientssl, TLS1_2_VERSION);
     SSL_set_connect_state(clientssl);
-    if (SSL_write_ex(clientssl, MSG1, strlen(MSG1), &amp;written)) {
-        printf(&quot;Unexpected success writing message 1\n&quot;);
+    if (!TEST_false(SSL_write_ex(clientssl, MSG1, strlen(MSG1), &amp;written)))
         goto end;
-    }
 
     /*
      * Server should do TLSv1.2 handshake. First it will block waiting for more
      * messages from client after ServerDone. Then SSL_read_early_data should
      * finish and detect that early data has not been sent
      */
-    if (SSL_read_early_data(serverssl, buf, sizeof(buf), &amp;readbytes)
-                != SSL_READ_EARLY_DATA_ERROR) {
-        printf(&quot;Unexpected success reading early data\n&quot;);
+    if (!TEST_int_eq(SSL_read_early_data(serverssl, buf, sizeof(buf),
+                                         &amp;readbytes),
+                     SSL_READ_EARLY_DATA_ERROR))
         goto end;
-    }
 
     /*
      * Continue writing the message we started earlier. Will still block waiting
      * for the CCS/Finished from server
      */
-    if (SSL_write_ex(clientssl, MSG1, strlen(MSG1), &amp;written)) {
-        printf(&quot;Unexpected success writing message 1\n&quot;);
-        goto end;
-    }
-
-    if (SSL_read_early_data(serverssl, buf, sizeof(buf), &amp;readbytes)
-                != SSL_READ_EARLY_DATA_FINISH
-            || readbytes != 0) {
-        printf(&quot;Failed reading early data\n&quot;);
+    if (!TEST_false(SSL_write_ex(clientssl, MSG1, strlen(MSG1), &amp;written))
+            || !TEST_int_eq(SSL_read_early_data(serverssl, buf, sizeof(buf),
+                                                &amp;readbytes),
+                            SSL_READ_EARLY_DATA_FINISH)
+            || !TEST_size_t_eq(readbytes, 0)
+            || !TEST_int_eq(SSL_get_early_data_status(serverssl),
+                            SSL_EARLY_DATA_NOT_SENT))
         goto end;
-    }
-
-    if (SSL_get_early_data_status(serverssl) != SSL_EARLY_DATA_NOT_SENT) {
-        printf(&quot;Unexpected early data status\n&quot;);
-        goto end;
-    }
 
     /* Continue writing the message we started earlier */
-    if (!SSL_write_ex(clientssl, MSG1, strlen(MSG1), &amp;written)
-            || written != strlen(MSG1)) {
-        printf(&quot;Failed writing message 1\n&quot;);
-        goto end;
-    }
-
-    if (SSL_get_early_data_status(clientssl) != SSL_EARLY_DATA_NOT_SENT) {
-        printf(&quot;Unexpected early data status (2)\n&quot;);
-        goto end;
-    }
-
-    if (!SSL_read_ex(serverssl, buf, sizeof(buf), &amp;readbytes)
-            || readbytes != strlen(MSG1)
-            || memcmp(MSG1, buf, strlen(MSG1))) {
-        printf(&quot;Failed reading message 1\n&quot;);
-        goto end;
-    }
-
-    if (!SSL_write_ex(serverssl, MSG2, strlen(MSG2), &amp;written)
-            || written != strlen(MSG2)) {
-        printf(&quot;Failed writing message 2\n&quot;);
+    if (!TEST_true(SSL_write_ex(clientssl, MSG1, strlen(MSG1), &amp;written))
+            || !TEST_size_t_eq(written, strlen(MSG1))
+            || !TEST_int_eq(SSL_get_early_data_status(clientssl),
+                            SSL_EARLY_DATA_NOT_SENT)
+            || !TEST_true(SSL_read_ex(serverssl, buf, sizeof(buf), &amp;readbytes))
+            || !TEST_mem_eq(buf, readbytes, MSG1, strlen(MSG1))
+            || !TEST_true(SSL_write_ex(serverssl, MSG2, strlen(MSG2), &amp;written))
+            || !TEST_size_t_eq(written, strlen(MSG2))
+            || !SSL_read_ex(clientssl, buf, sizeof(buf), &amp;readbytes)
+            || !TEST_mem_eq(buf, readbytes, MSG2, strlen(MSG2)))
         goto end;
-    }
-
-    if (!SSL_read_ex(clientssl, buf, sizeof(buf), &amp;readbytes)
-            || readbytes != strlen(MSG2)
-            || memcmp(MSG2, buf, strlen(MSG2))) {
-        printf(&quot;Failed reading message 2\n&quot;);
-        goto end;
-    }
 
     testresult = 1;
 
  end:
-    if(!testresult)
-        ERR_print_errors_fp(stdout);
     SSL_free(serverssl);
     SSL_free(clientssl);
     SSL_CTX_free(sctx);
@@ -2271,17 +1792,13 @@ static int old_add_cb(SSL *s, unsigned int ext_type, const unsigned char **out,
     else
         clntaddoldcb++;
 
-    if (*server != SSL_is_server(s))
-        return -1;
-
-    data = OPENSSL_malloc(sizeof(char));
-    if (data == NULL)
+    if (*server != SSL_is_server(s)
+            || (data = OPENSSL_malloc(sizeof(*data))) == NULL)
         return -1;
 
     *data = 1;
     *out = data;
     *outlen = sizeof(char);
-
     return 1;
 }
 
@@ -2301,10 +1818,9 @@ static int old_parse_cb(SSL *s, unsigned int ext_type, const unsigned char *in,
     else
         clntparseoldcb++;
 
-    if (*server != SSL_is_server(s))
-        return -1;
-
-    if (inlen != sizeof(char) || *in != 1)
+    if (*server != SSL_is_server(s)
+            || inlen != sizeof(char)
+            || *in != 1)
         return -1;
 
     return 1;
@@ -2322,17 +1838,13 @@ static int new_add_cb(SSL *s, unsigned int ext_type, unsigned int context,
     else
         clntaddnewcb++;
 
-    if (*server != SSL_is_server(s))
-        return -1;
-
-    data = OPENSSL_malloc(sizeof(char));
-    if (data == NULL)
+    if (*server != SSL_is_server(s)
+            || (data = OPENSSL_malloc(sizeof(*data))) == NULL)
         return -1;
 
     *data = 1;
     *out = data;
-    *outlen = sizeof(char);
-
+    *outlen = sizeof(*data);
     return 1;
 }
 
@@ -2353,10 +1865,8 @@ static int new_parse_cb(SSL *s, unsigned int ext_type, unsigned int context,
     else
         clntparsenewcb++;
 
-    if (*server != SSL_is_server(s))
-        return -1;
-
-    if (inlen != sizeof(char) || *in != 1)
+    if (*server != SSL_is_server(s)
+            || inlen != sizeof(char) || *in != 1)
         return -1;
 
     return 1;
@@ -2368,7 +1878,8 @@ static int new_parse_cb(SSL *s, unsigned int ext_type, unsigned int context,
  * Test 2: New style callbacks in TLSv1.3. Extensions in CH and EE
  * Test 3: New style callbacks in TLSv1.3. Extensions in CH, SH, EE, Cert + NST
  */
-static int test_custom_exts(int tst) {
+static int test_custom_exts(int tst)
+{
     SSL_CTX *cctx = NULL, *sctx = NULL;
     SSL *clientssl = NULL, *serverssl = NULL;
     int testresult = 0;
@@ -2381,11 +1892,10 @@ static int test_custom_exts(int tst) {
     clntaddoldcb = clntparseoldcb = srvaddoldcb = srvparseoldcb = 0;
     clntaddnewcb = clntparsenewcb = srvaddnewcb = srvparsenewcb = 0;
 
-    if (!create_ssl_ctx_pair(TLS_server_method(), TLS_client_method(), &amp;sctx,
-                             &amp;cctx, cert, privkey)) {
-        printf(&quot;Unable to create SSL_CTX pair\n&quot;);
-        return 0;
-    }
+    if (!TEST_true(create_ssl_ctx_pair(TLS_server_method(),
+                                       TLS_client_method(), &amp;sctx,
+                                       &amp;cctx, cert, privkey)))
+        goto end;
 
     if (tst &lt; 2) {
         SSL_CTX_set_options(cctx, SSL_OP_NO_TLSv1_3);
@@ -2393,129 +1903,107 @@ static int test_custom_exts(int tst) {
     }
 
     if (tst == 3) {
-        context = SSL_EXT_CLIENT_HELLO | SSL_EXT_TLS1_2_SERVER_HELLO
+        context = SSL_EXT_CLIENT_HELLO
+                  | SSL_EXT_TLS1_2_SERVER_HELLO
                   | SSL_EXT_TLS1_3_SERVER_HELLO
                   | SSL_EXT_TLS1_3_ENCRYPTED_EXTENSIONS
                   | SSL_EXT_TLS1_3_CERTIFICATE
                   | SSL_EXT_TLS1_3_NEW_SESSION_TICKET;
     } else {
-        context = SSL_EXT_CLIENT_HELLO | SSL_EXT_TLS1_2_SERVER_HELLO
+        context = SSL_EXT_CLIENT_HELLO
+                  | SSL_EXT_TLS1_2_SERVER_HELLO
                   | SSL_EXT_TLS1_3_ENCRYPTED_EXTENSIONS;
     }
 
     /* Create a client side custom extension */
     if (tst == 0) {
-        if (!SSL_CTX_add_client_custom_ext(cctx, TEST_EXT_TYPE1, old_add_cb,
-                                           old_free_cb, &amp;client, old_parse_cb,
-                                           &amp;client)) {
-            printf(&quot;Unable to create old style client side custom extension\n&quot;);
-            return 0;
-        }
+        if (!TEST_true(SSL_CTX_add_client_custom_ext(cctx, TEST_EXT_TYPE1,
+                                                     old_add_cb, old_free_cb,
+                                                     &amp;client, old_parse_cb,
+                                                     &amp;client)))
+            goto end;
     } else {
-        if (!SSL_CTX_add_custom_ext(cctx, TEST_EXT_TYPE1, context, new_add_cb,
-                                    new_free_cb, &amp;client, new_parse_cb,
-                                    &amp;client)) {
-            printf(&quot;Unable to create new style client side custom extension\n&quot;);
-            return 0;
-        }
+        if (!TEST_true(SSL_CTX_add_custom_ext(cctx, TEST_EXT_TYPE1, context,
+                                              new_add_cb, new_free_cb,
+                                              &amp;client, new_parse_cb, &amp;client)))
+            goto end;
     }
 
     /* Should not be able to add duplicates */
-    if (SSL_CTX_add_client_custom_ext(cctx, TEST_EXT_TYPE1, old_add_cb,
-                                      old_free_cb, &amp;client, old_parse_cb,
-                                      &amp;client)) {
-        printf(&quot;Unexpected success adding duplicate client custom extension\n&quot;);
-        return 0;
-    }
-    if (SSL_CTX_add_custom_ext(cctx, TEST_EXT_TYPE1, context, new_add_cb,
-                               new_free_cb, &amp;client, new_parse_cb, &amp;client)) {
-        printf(&quot;Unexpected success adding duplicate client custom extension\n&quot;);
-        return 0;
-    }
+    if (!TEST_false(SSL_CTX_add_client_custom_ext(cctx, TEST_EXT_TYPE1,
+                                                  old_add_cb, old_free_cb,
+                                                  &amp;client, old_parse_cb,
+                                                  &amp;client))
+            || !TEST_false(SSL_CTX_add_custom_ext(cctx, TEST_EXT_TYPE1,
+                                                  context, new_add_cb,
+                                                  new_free_cb, &amp;client,
+                                                  new_parse_cb, &amp;client)))
+        goto end;
 
     /* Create a server side custom extension */
     if (tst == 0) {
-        if (!SSL_CTX_add_server_custom_ext(sctx, TEST_EXT_TYPE1, old_add_cb,
-                                           old_free_cb, &amp;server, old_parse_cb,
-                                           &amp;server)) {
-            printf(&quot;Unable to create old style server side custom extension\n&quot;);
-            return 0;
-        }
+        if (!TEST_true(SSL_CTX_add_server_custom_ext(sctx, TEST_EXT_TYPE1,
+                                                     old_add_cb, old_free_cb,
+                                                     &amp;server, old_parse_cb,
+                                                     &amp;server)))
+            goto end;
     } else {
-        if (!SSL_CTX_add_custom_ext(sctx, TEST_EXT_TYPE1, context, new_add_cb,
-                                    new_free_cb, &amp;server, new_parse_cb,
-                                    &amp;server)) {
-            printf(&quot;Unable to create new style server side custom extension\n&quot;);
-            return 0;
-        }
+        if (!TEST_true(SSL_CTX_add_custom_ext(sctx, TEST_EXT_TYPE1, context,
+                                              new_add_cb, new_free_cb,
+                                              &amp;server, new_parse_cb, &amp;server)))
+            goto end;
     }
 
     /* Should not be able to add duplicates */
-    if (SSL_CTX_add_server_custom_ext(sctx, TEST_EXT_TYPE1, old_add_cb,
-                                      old_free_cb, &amp;server, old_parse_cb,
-                                      &amp;server)) {
-        printf(&quot;Unexpected success adding duplicate server custom extension\n&quot;);
-        return 0;
-    }
-    if (SSL_CTX_add_custom_ext(sctx, TEST_EXT_TYPE1, context, new_add_cb,
-                               new_free_cb, &amp;server, new_parse_cb, &amp;server)) {
-        printf(&quot;Unexpected success adding duplicate server custom extension\n&quot;);
-        return 0;
-    }
-
-    if (!create_ssl_objects(sctx, cctx, &amp;serverssl, &amp;clientssl, NULL, NULL)) {
-        printf(&quot;Unable to create SSL objects\n&quot;);
+    if (!TEST_false(SSL_CTX_add_server_custom_ext(sctx, TEST_EXT_TYPE1,
+                                                  old_add_cb, old_free_cb,
+                                                  &amp;server, old_parse_cb,
+                                                  &amp;server))
+            || !TEST_false(SSL_CTX_add_custom_ext(sctx, TEST_EXT_TYPE1,
+                                                  context, new_add_cb,
+                                                  new_free_cb, &amp;server,
+                                                  new_parse_cb, &amp;server)))
         goto end;
-    }
 
-    if (!create_ssl_connection(serverssl, clientssl, SSL_ERROR_NONE)) {
-        printf(&quot;Unable to create SSL connection\n&quot;);
+    if (!TEST_true(create_ssl_objects(sctx, cctx, &amp;serverssl,
+                                      &amp;clientssl, NULL, NULL))
+            || !TEST_true(create_ssl_connection(serverssl, clientssl,
+                                                SSL_ERROR_NONE)))
         goto end;
-    }
 
     if (tst == 0) {
-        if (clntaddoldcb != 1 || clntparseoldcb != 1 || srvaddoldcb != 1
-                || srvparseoldcb != 1) {
-            printf(&quot;Custom extension callbacks not called\n&quot;);
+        if (clntaddoldcb != 1
+                || clntparseoldcb != 1
+                || srvaddoldcb != 1
+                || srvparseoldcb != 1)
             goto end;
-        }
     } else if (tst == 1 || tst == 2) {
-        if (clntaddnewcb != 1 || clntparsenewcb != 1 || srvaddnewcb != 1
-                || srvparsenewcb != 1) {
-            printf(&quot;Custom extension callbacks not called\n&quot;);
+        if (clntaddnewcb != 1
+                || clntparsenewcb != 1
+                || srvaddnewcb != 1
+                || srvparsenewcb != 1)
             goto end;
-        }
     } else {
-        if (clntaddnewcb != 1 || clntparsenewcb != 4 || srvaddnewcb != 4
-                || srvparsenewcb != 1) {
-            printf(&quot;Custom extension callbacks not called\n&quot;);
+        if (clntaddnewcb != 1
+                || clntparsenewcb != 4
+                || srvaddnewcb != 4
+                || srvparsenewcb != 1)
             goto end;
-        }
     }
 
     sess = SSL_get1_session(clientssl);
-
     SSL_shutdown(clientssl);
     SSL_shutdown(serverssl);
-
     SSL_free(serverssl);
     SSL_free(clientssl);
     serverssl = clientssl = NULL;
 
-    if (!create_ssl_objects(sctx, cctx, &amp;serverssl, &amp;clientssl, NULL, NULL)) {
-        printf(&quot;Unable to create SSL objects (2)\n&quot;);
-        goto end;
-    }
-
-    if (!SSL_set_session(clientssl, sess)) {
-        printf(&quot;Failed setting session\n&quot;);
-        goto end;
-    }
-
-    if (!create_ssl_connection(serverssl, clientssl, SSL_ERROR_NONE)) {
-        printf(&quot;Unable to create SSL connection (2)\n&quot;);
+    if (!TEST_true(create_ssl_objects(sctx, cctx, &amp;serverssl, &amp;clientssl,
+                                      NULL, NULL))
+            || !TEST_true(SSL_set_session(clientssl, sess))
+            || !TEST_true(create_ssl_connection(serverssl, clientssl,
+                                               SSL_ERROR_NONE)))
         goto end;
-    }
 
     /*
      * For a resumed session we expect to add the ClientHello extension. For the
@@ -2524,24 +2012,24 @@ static int test_custom_exts(int tst) {
      * them.
      */
     if (tst == 0) {
-        if (clntaddoldcb != 2 || clntparseoldcb != 1 || srvaddoldcb != 1
-                || srvparseoldcb != 1) {
-            printf(&quot;Unexpected custom extension callback calls\n&quot;);
+        if (clntaddoldcb != 2
+                || clntparseoldcb != 1
+                || srvaddoldcb != 1
+                || srvparseoldcb != 1)
             goto end;
-        }
     } else if (tst == 1 || tst == 2) {
-        if (clntaddnewcb != 2 || clntparsenewcb != 2 || srvaddnewcb != 2
-                || srvparsenewcb != 2) {
-            printf(&quot;Unexpected custom extension callback calls\n&quot;);
+        if (clntaddnewcb != 2
+                || clntparsenewcb != 2
+                || srvaddnewcb != 2
+                || srvparsenewcb != 2)
             goto end;
-        }
     } else {
         /* No Certificate message extensions in the resumption handshake */
-        if (clntaddnewcb != 2 || clntparsenewcb != 7 || srvaddnewcb != 7
-                || srvparsenewcb != 2) {
-            printf(&quot;Unexpected custom extension callback calls\n&quot;);
+        if (clntaddnewcb != 2
+                || clntparsenewcb != 7
+                || srvaddnewcb != 7
+                || srvparsenewcb != 2)
             goto end;
-        }
     }
 
     testresult = 1;
@@ -2552,7 +2040,6 @@ end:
     SSL_free(clientssl);
     SSL_CTX_free(sctx);
     SSL_CTX_free(cctx);
-
     return testresult;
 }
 
@@ -2561,8 +2048,8 @@ int test_main(int argc, char *argv[])
     int testresult = 1;
 
     if (argc != 3) {
-        printf(&quot;Invalid argument count\n&quot;);
-        return 1;
+        TEST_error(&quot;Wrong argument count&quot;);
+        return 0;
     }
 
     cert = argv[1];
</PRE>








<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="014367.html">[openssl-commits] [openssl]  master update
</A></li>
	<LI>Next message: <A HREF="014375.html">[openssl-commits] [openssl]  master update
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#14371">[ date ]</a>
              <a href="thread.html#14371">[ thread ]</a>
              <a href="subject.html#14371">[ subject ]</a>
              <a href="author.html#14371">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="../../../mailman/listinfo/openssl-commits.html">More information about the openssl-commits
mailing list</a><br>
</body></html>
