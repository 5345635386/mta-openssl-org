<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [openssl-commits] [openssl]  master update
   </TITLE>
   <LINK REL="Index" HREF="https://mta.openssl.org/pipermail/openssl-commits/2016-March/index.html" >
   <LINK REL="made" HREF="mailto:openssl-commits%40openssl.org?Subject=Re%3A%20%5Bopenssl-commits%5D%20%5Bopenssl%5D%20%20master%20update&In-Reply-To=%3C1457445809.571018.17752.nullmailer%40dev.openssl.org%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="005088.html">
   <LINK REL="Next"  HREF="005093.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[openssl-commits] [openssl]  master update</H1>
    <B>Rich Salz</B> 
    <A HREF="mailto:openssl-commits%40openssl.org?Subject=Re%3A%20%5Bopenssl-commits%5D%20%5Bopenssl%5D%20%20master%20update&In-Reply-To=%3C1457445809.571018.17752.nullmailer%40dev.openssl.org%3E"
       TITLE="[openssl-commits] [openssl]  master update">rsalz at openssl.org
       </A><BR>
    <I>Tue Mar  8 14:03:29 UTC 2016</I>
    <P><UL>
        <LI>Previous message: <A HREF="005088.html">[openssl-commits] [openssl]  master update
</A></li>
        <LI>Next message: <A HREF="005093.html">[openssl-commits] [openssl]  master update
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#5092">[ date ]</a>
              <a href="thread.html#5092">[ thread ]</a>
              <a href="subject.html#5092">[ subject ]</a>
              <a href="author.html#5092">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>The branch master has been updated
       via  817cd0d52f0462039d1fe60462150be7f59d2002 (commit)
      from  f18ce934889a36db42b7988e8acca9ac4f23299f (commit)


- Log -----------------------------------------------------------------
commit 817cd0d52f0462039d1fe60462150be7f59d2002
Author: Todd Short &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">tshort at akamai.com</A>&gt;
Date:   Sat Mar 5 08:47:55 2016 -0500

    GH787: Fix ALPN
    
    * Perform ALPN after the SNI callback; the SSL_CTX may change due to
      that processing
    * Add flags to indicate that we actually sent ALPN, to properly error
      out if unexpectedly received.
    * clean up ssl3_free() no need to explicitly clear when doing memset
    * document ALPN functions
    
    Signed-off-by: Rich Salz &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">rsalz at openssl.org</A>&gt;
    Reviewed-by: Emilia K&#228;sper &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">emilia at openssl.org</A>&gt;

-----------------------------------------------------------------------

Summary of changes:
 CHANGES                                |   4 +
 apps/apps.c                            |   2 +-
 apps/apps.h                            |   2 +-
 apps/s_client.c                        |   4 +-
 apps/s_server.c                        |   8 +-
 doc/ssl/SSL_CTX_set_alpn_select_cb.pod | 126 +++++++++++++++++
 include/openssl/ssl.h                  |   6 +-
 ssl/s3_lib.c                           |  20 +--
 ssl/ssl_lib.c                          |  12 +-
 ssl/ssl_locl.h                         |   7 +-
 ssl/t1_lib.c                           |  77 ++++++----
 test/recipes/80-test_ssl.t             |  64 +++++++--
 test/ssltest.c                         | 251 +++++++++++++++++++++++----------
 13 files changed, 432 insertions(+), 151 deletions(-)
 create mode 100644 doc/ssl/SSL_CTX_set_alpn_select_cb.pod

diff --git a/CHANGES b/CHANGES
index f91ba05..9ff84fc 100644
--- a/CHANGES
+++ b/CHANGES
@@ -4,6 +4,10 @@
 
  Changes between 1.0.2g and 1.1.0  [xx XXX xxxx]
 
+  *) Modify behavior of ALPN to invoke callback after SNI/servername
+     callback, such that updates to the SSL_CTX affect ALPN.
+     [Todd Short]
+
   *) Changes to the DEFAULT cipherlist:
        - Prefer (EC)DHE handshakes over plain RSA.
        - Prefer AEAD ciphers over legacy ciphers.
diff --git a/apps/apps.c b/apps/apps.c
index 19523d6..4e2322d 100644
--- a/apps/apps.c
+++ b/apps/apps.c
@@ -1960,7 +1960,7 @@ void policies_print(X509_STORE_CTX *ctx)
  *
  *   returns: a malloced buffer or NULL on failure.
  */
-unsigned char *next_protos_parse(unsigned short *outlen, const char *in)
+unsigned char *next_protos_parse(size_t *outlen, const char *in)
 {
     size_t len;
     unsigned char *out;
diff --git a/apps/apps.h b/apps/apps.h
index 5450def..ebf696b 100644
--- a/apps/apps.h
+++ b/apps/apps.h
@@ -565,7 +565,7 @@ int do_X509_CRL_sign(X509_CRL *x, EVP_PKEY *pkey, const EVP_MD *md,
 extern char *psk_key;
 # endif
 
-unsigned char *next_protos_parse(unsigned short *outlen, const char *in);
+unsigned char *next_protos_parse(size_t *outlen, const char *in);
 
 void print_cert_checks(BIO *bio, X509 *x,
                        const char *checkhost,
diff --git a/apps/s_client.c b/apps/s_client.c
index a1ef64b..725dcd3 100644
--- a/apps/s_client.c
+++ b/apps/s_client.c
@@ -445,7 +445,7 @@ static char *srtp_profiles = NULL;
 /* This the context that we pass to next_proto_cb */
 typedef struct tlsextnextprotoctx_st {
     unsigned char *data;
-    unsigned short len;
+    size_t len;
     int status;
 } tlsextnextprotoctx;
 
@@ -1634,7 +1634,7 @@ int s_client_main(int argc, char **argv)
         SSL_CTX_set_next_proto_select_cb(ctx, next_proto_cb, &amp;next_proto);
 #endif
     if (alpn_in) {
-        unsigned short alpn_len;
+        size_t alpn_len;
         unsigned char *alpn = next_protos_parse(&amp;alpn_len, alpn_in);
 
         if (alpn == NULL) {
diff --git a/apps/s_server.c b/apps/s_server.c
index 35a22f7..69102d9 100644
--- a/apps/s_server.c
+++ b/apps/s_server.c
@@ -743,7 +743,7 @@ static int next_proto_cb(SSL *s, const unsigned char **data,
 /* This the context that we pass to alpn_cb */
 typedef struct tlsextalpnctx_st {
     unsigned char *data;
-    unsigned short len;
+    size_t len;
 } tlsextalpnctx;
 
 static int alpn_cb(SSL *s, const unsigned char **out, unsigned char *outlen,
@@ -753,7 +753,7 @@ static int alpn_cb(SSL *s, const unsigned char **out, unsigned char *outlen,
 
     if (!s_quiet) {
         /* We can assume that |in| is syntactically valid. */
-        unsigned i;
+        unsigned int i;
         BIO_printf(bio_s_out, &quot;ALPN protocols advertised by the client: &quot;);
         for (i = 0; i &lt; inlen;) {
             if (i)
@@ -1620,7 +1620,7 @@ int s_server_main(int argc, char *argv[])
     }
 #if !defined(OPENSSL_NO_NEXTPROTONEG)
     if (next_proto_neg_in) {
-        unsigned short len;
+        size_t len;
         next_proto.data = next_protos_parse(&amp;len, next_proto_neg_in);
         if (next_proto.data == NULL)
             goto end;
@@ -1631,7 +1631,7 @@ int s_server_main(int argc, char *argv[])
 #endif
     alpn_ctx.data = NULL;
     if (alpn_in) {
-        unsigned short len;
+        size_t len;
         alpn_ctx.data = next_protos_parse(&amp;len, alpn_in);
         if (alpn_ctx.data == NULL)
             goto end;
diff --git a/doc/ssl/SSL_CTX_set_alpn_select_cb.pod b/doc/ssl/SSL_CTX_set_alpn_select_cb.pod
new file mode 100644
index 0000000..974ca86
--- /dev/null
+++ b/doc/ssl/SSL_CTX_set_alpn_select_cb.pod
@@ -0,0 +1,126 @@
+=pod
+
+=head1 NAME
+
+SSL_CTX_set_alpn_select_cb, SSL_CTX_set_alpn_protos, SSL_set_alpn_protos,
+SSL_get0_alpn_selected, SSL_select_next_proto - handle application layer
+protocol negotiation (ALPN)
+
+=head1 SYNOPSIS
+
+ #include &lt;openssl/ssl.h&gt;
+
+ int SSL_CTX_set_alpn_protos(SSL_CTX *ctx, const unsigned char *protos,
+                             unsigned int protos_len);
+ int SSL_set_alpn_protos(SSL *ssl, const unsigned char *protos,
+                         unsigned int protos_len);
+ void SSL_CTX_set_alpn_select_cb(SSL_CTX *ctx,
+                                 int (*cb) (SSL *ssl,
+                                            const unsigned char **out,
+                                            unsigned char *outlen,
+                                            const unsigned char *in,
+                                            unsigned int inlen,
+                                            void *arg), void *arg);
+ int SSL_select_next_proto(unsigned char **out, unsigned char *outlen,
+                           const unsigned char *server,
+                           unsigned int server_len,
+                           const unsigned char *client,
+                           unsigned int client_len)
+ void SSL_get0_alpn_selected(const SSL *ssl, const unsigned char **data,
+                             unsigned int *len);
+
+=head1 DESCRIPTION
+
+SSL_CTX_set_alpn_protos() and SSL_set_alpn_protos() are used by the client to
+set the list of protocols available to be negotiated. The B&lt;protos&gt; must be in
+protocol-list format, described below. The length of B&lt;protos&gt; is specified in
+B&lt;protos_len&gt;.
+
+SSL_CTX_set_alpn_select_cb() sets the application callback B&lt;cb&gt; used by a
+server to select which protocol to use for the incoming connection. When B&lt;cb&gt;
+is NULL, no ALPN is not used. The B&lt;arg&gt; value is pointer which is passed to
+the application callback.
+
+B&lt;cb&gt; is the application defined callback. The B&lt;in&gt;, B&lt;inlen&gt; parameters are a
+vector in protocol-list format. The value of the B&lt;out&gt;, B&lt;outlen&gt; vector
+should be set to the value of a single protocol contained with in the B&lt;in&gt;,
+B&lt;inlen&gt; vector. The B&lt;arg&gt; parameter is the pointer set via
+SSL_CTX_set_alpn_select_cb().
+
+SSL_select_next_proto() is a helper function used to select protocols. It
+implements the standard protocol selection. It is expected that this function
+is called from the application callback B&lt;cb&gt;. The protocol data in B&lt;server&gt;,
+B&lt;server_len&gt; and B&lt;client&gt;, B&lt;client_len&gt; must be in protocol-list format
+described below. The first item in the B&lt;server&gt;, B&lt;server_len&gt; list that
+matches an item in the B&lt;client&gt;, B&lt;client_len&gt; list is selected, and returned
+in B&lt;out&gt;, B&lt;outlen&gt;. The B&lt;out&gt; value will point into either B&lt;server&gt; or
+B&lt;client&gt;, so it should be copied immediately. If no match is found, the first
+item in B&lt;client&gt;, B&lt;client_len&gt; is returned in B&lt;out&gt;, B&lt;outlen&gt;. This
+function can also be used in the NPN callback.
+
+SSL_get0_alpn_selected() returns a pointer to the selected protocol in B&lt;data&gt;
+with length B&lt;len&gt;. It is not NUL-terminated. B&lt;data&gt; is set to NULL and B&lt;len&gt;
+is set to 0 if no protocol has been selected. B&lt;data&gt; value must not be freed.
+
+=head1 NOTES
+
+The protocol-lists must be in wire-format, which is defined as a vector of
+non-empty, 8-bit length-prefixed, byte strings. The length-prefix byte is not
+included in the length. Each string is limited to 255 bytes. A byte-string
+length of 0 is invalid. A truncated byte-string is invalid. The length of the
+vector is not in the vector itself, but in a separate variable.
+
+Example:
+
+ unsigned char vector[] = {
+     6, 's', 'p', 'd', 'y', '/', '1',
+     8, 'h', 't', 't', 'p', '/', '1', '.', '1'
+ };
+ unsigned int length = sizeof(vector);
+
+The ALPN callback is executed after the servername callback; as that servername
+callback may update the SSL_CTX, and subsequently, the ALPN callback.
+
+If there is no ALPN proposed in the ClientHello, the ALPN callback is not
+invoked.
+
+=head1 RETURN VALUES
+
+SSL_CTX_set_alpn_protos() and SSL_set_alpn_protos() return 0 on success, and
+non-0 on failure. WARNING: these functions reverse the return value convention.
+
+SSL_select_next_proto() returns one of the following:
+
+=over 4
+
+=item OPENSSL_NPN_NEGOTIATED
+
+A match was found and is returned in B&lt;out&gt;, B&lt;outlen&gt;.
+
+=item OPENSSL_NPN_NO_OVERLAP
+
+No match was found. The first item in B&lt;client&gt;, B&lt;client_len&gt; is returned in
+B&lt;out&gt;, B&lt;outlen&gt;.
+
+=back
+
+The ALPN select callback B&lt;cb&gt;, must return one of the following:
+
+=over 4
+
+=item SSL_TLSEXT_ERR_OK
+
+ALPN protocol selected.
+
+=item SSL_TLSEXT_ERR_NOACK
+
+ALPN protocol not selected.
+
+=back
+
+=head1 SEE ALSO
+
+L&lt;ssl(3)&gt;, L&lt;SSL_CTX_set_tlsext_servername_callback(3)&gt;,
+L&lt;SSL_CTX_set_tlsext_servername_arg(3)&gt;
+
+=cut
diff --git a/include/openssl/ssl.h b/include/openssl/ssl.h
index aa3daca..a1533b6 100644
--- a/include/openssl/ssl.h
+++ b/include/openssl/ssl.h
@@ -782,9 +782,9 @@ __owur int SSL_select_next_proto(unsigned char **out, unsigned char *outlen,
 # define OPENSSL_NPN_NO_OVERLAP  2
 
 __owur int SSL_CTX_set_alpn_protos(SSL_CTX *ctx, const unsigned char *protos,
-                            unsigned protos_len);
+                                   unsigned int protos_len);
 __owur int SSL_set_alpn_protos(SSL *ssl, const unsigned char *protos,
-                        unsigned protos_len);
+                               unsigned int protos_len);
 void SSL_CTX_set_alpn_select_cb(SSL_CTX *ctx,
                                 int (*cb) (SSL *ssl,
                                            const unsigned char **out,
@@ -793,7 +793,7 @@ void SSL_CTX_set_alpn_select_cb(SSL_CTX *ctx,
                                            unsigned int inlen,
                                            void *arg), void *arg);
 void SSL_get0_alpn_selected(const SSL *ssl, const unsigned char **data,
-                            unsigned *len);
+                            unsigned int *len);
 
 # ifndef OPENSSL_NO_PSK
 /*
diff --git a/ssl/s3_lib.c b/ssl/s3_lib.c
index 78aaf7b..134c7e6 100644
--- a/ssl/s3_lib.c
+++ b/ssl/s3_lib.c
@@ -3047,6 +3047,7 @@ void ssl3_free(SSL *s)
     OPENSSL_free(s-&gt;s3-&gt;tmp.peer_sigalgs);
     ssl3_free_digest_list(s);
     OPENSSL_free(s-&gt;s3-&gt;alpn_selected);
+    OPENSSL_free(s-&gt;s3-&gt;alpn_proposed);
 
 #ifndef OPENSSL_NO_SRP
     SSL_SRP_CTX_free(s);
@@ -3060,37 +3061,24 @@ void ssl3_clear(SSL *s)
     ssl3_cleanup_key_block(s);
     sk_X509_NAME_pop_free(s-&gt;s3-&gt;tmp.ca_names, X509_NAME_free);
     OPENSSL_free(s-&gt;s3-&gt;tmp.ciphers_raw);
-    s-&gt;s3-&gt;tmp.ciphers_raw = NULL;
     OPENSSL_clear_free(s-&gt;s3-&gt;tmp.pms, s-&gt;s3-&gt;tmp.pmslen);
-    s-&gt;s3-&gt;tmp.pms = NULL;
     OPENSSL_free(s-&gt;s3-&gt;tmp.peer_sigalgs);
-    s-&gt;s3-&gt;tmp.peer_sigalgs = NULL;
 
-#ifndef OPENSSL_NO_EC
-    s-&gt;s3-&gt;is_probably_safari = 0;
-#endif
 #if !defined(OPENSSL_NO_EC) || !defined(OPENSSL_NO_DH)
     EVP_PKEY_free(s-&gt;s3-&gt;tmp.pkey);
-    s-&gt;s3-&gt;tmp.pkey = NULL;
     EVP_PKEY_free(s-&gt;s3-&gt;peer_tmp);
-    s-&gt;s3-&gt;peer_tmp = NULL;
 #endif                         /* !OPENSSL_NO_EC */
 
     ssl3_free_digest_list(s);
 
-    if (s-&gt;s3-&gt;alpn_selected) {
-        OPENSSL_free(s-&gt;s3-&gt;alpn_selected);
-        s-&gt;s3-&gt;alpn_selected = NULL;
-    }
+    OPENSSL_free(s-&gt;s3-&gt;alpn_selected);
+    OPENSSL_free(s-&gt;s3-&gt;alpn_proposed);
 
+    /* NULL/zero-out everything in the s3 struct */
     memset(s-&gt;s3, 0, sizeof(*s-&gt;s3));
 
     ssl_free_wbio_buffer(s);
 
-    s-&gt;s3-&gt;renegotiate = 0;
-    s-&gt;s3-&gt;total_renegotiations = 0;
-    s-&gt;s3-&gt;num_renegotiations = 0;
-    s-&gt;s3-&gt;in_read_app_data = 0;
     s-&gt;version = SSL3_VERSION;
 
 #if !defined(OPENSSL_NO_NEXTPROTONEG)
diff --git a/ssl/ssl_lib.c b/ssl/ssl_lib.c
index 13f4ccd..a1c8da8 100644
--- a/ssl/ssl_lib.c
+++ b/ssl/ssl_lib.c
@@ -2220,15 +2220,14 @@ void SSL_CTX_set_next_proto_select_cb(SSL_CTX *ctx,
  * length-prefixed strings). Returns 0 on success.
  */
 int SSL_CTX_set_alpn_protos(SSL_CTX *ctx, const unsigned char *protos,
-                            unsigned protos_len)
+                            unsigned int protos_len)
 {
     OPENSSL_free(ctx-&gt;alpn_client_proto_list);
-    ctx-&gt;alpn_client_proto_list = OPENSSL_malloc(protos_len);
+    ctx-&gt;alpn_client_proto_list = OPENSSL_memdup(protos, protos_len);
     if (ctx-&gt;alpn_client_proto_list == NULL) {
         SSLerr(SSL_F_SSL_CTX_SET_ALPN_PROTOS, ERR_R_MALLOC_FAILURE);
         return 1;
     }
-    memcpy(ctx-&gt;alpn_client_proto_list, protos, protos_len);
     ctx-&gt;alpn_client_proto_list_len = protos_len;
 
     return 0;
@@ -2240,15 +2239,14 @@ int SSL_CTX_set_alpn_protos(SSL_CTX *ctx, const unsigned char *protos,
  * length-prefixed strings). Returns 0 on success.
  */
 int SSL_set_alpn_protos(SSL *ssl, const unsigned char *protos,
-                        unsigned protos_len)
+                        unsigned int protos_len)
 {
     OPENSSL_free(ssl-&gt;alpn_client_proto_list);
-    ssl-&gt;alpn_client_proto_list = OPENSSL_malloc(protos_len);
+    ssl-&gt;alpn_client_proto_list = OPENSSL_memdup(protos, protos_len);
     if (ssl-&gt;alpn_client_proto_list == NULL) {
         SSLerr(SSL_F_SSL_SET_ALPN_PROTOS, ERR_R_MALLOC_FAILURE);
         return 1;
     }
-    memcpy(ssl-&gt;alpn_client_proto_list, protos, protos_len);
     ssl-&gt;alpn_client_proto_list_len = protos_len;
 
     return 0;
@@ -2278,7 +2276,7 @@ void SSL_CTX_set_alpn_select_cb(SSL_CTX *ctx,
  * respond with a negotiated protocol then |*len| will be zero.
  */
 void SSL_get0_alpn_selected(const SSL *ssl, const unsigned char **data,
-                            unsigned *len)
+                            unsigned int *len)
 {
     *data = NULL;
     if (ssl-&gt;s3)
diff --git a/ssl/ssl_locl.h b/ssl/ssl_locl.h
index 064c22c..4d816de 100644
--- a/ssl/ssl_locl.h
+++ b/ssl/ssl_locl.h
@@ -1372,7 +1372,12 @@ typedef struct ssl3_state_st {
      * that the server selected once the ServerHello has been processed.
      */
     unsigned char *alpn_selected;
-    unsigned alpn_selected_len;
+    size_t alpn_selected_len;
+    /* used by the server to know what options were proposed */
+    unsigned char *alpn_proposed;
+    size_t alpn_proposed_len;
+    /* used by the client to know if it actually sent alpn */
+    int alpn_sent;
 
 #   ifndef OPENSSL_NO_EC
     /*
diff --git a/ssl/t1_lib.c b/ssl/t1_lib.c
index 70c47c8..2161d15 100644
--- a/ssl/t1_lib.c
+++ b/ssl/t1_lib.c
@@ -1413,6 +1413,11 @@ unsigned char *ssl_add_clienthello_tlsext(SSL *s, unsigned char *buf,
     }
 #endif
 
+    /*
+     * finish_md_len is non-zero during a renegotiation, so
+     * this avoids sending ALPN during the renegotiation
+     * (see longer comment below)
+     */
     if (s-&gt;alpn_client_proto_list &amp;&amp; !s-&gt;s3-&gt;tmp.finish_md_len) {
         if ((size_t)(limit - ret) &lt; 6 + s-&gt;alpn_client_proto_list_len)
             return NULL;
@@ -1421,6 +1426,7 @@ unsigned char *ssl_add_clienthello_tlsext(SSL *s, unsigned char *buf,
         s2n(s-&gt;alpn_client_proto_list_len, ret);
         memcpy(ret, s-&gt;alpn_client_proto_list, s-&gt;alpn_client_proto_list_len);
         ret += s-&gt;alpn_client_proto_list_len;
+        s-&gt;s3-&gt;alpn_sent = 1;
     }
 #ifndef OPENSSL_NO_SRTP
     if (SSL_IS_DTLS(s) &amp;&amp; SSL_get_srtp_profiles(s)) {
@@ -1701,9 +1707,9 @@ unsigned char *ssl_add_serverhello_tlsext(SSL *s, unsigned char *buf,
         s2n(0, ret);
     }
 
-    if (s-&gt;s3-&gt;alpn_selected) {
+    if (s-&gt;s3-&gt;alpn_selected != NULL) {
         const unsigned char *selected = s-&gt;s3-&gt;alpn_selected;
-        unsigned len = s-&gt;s3-&gt;alpn_selected_len;
+        unsigned int len = s-&gt;s3-&gt;alpn_selected_len;
 
         if ((long)(limit - ret - 4 - 2 - 1 - len) &lt; 0)
             return NULL;
@@ -1725,16 +1731,13 @@ unsigned char *ssl_add_serverhello_tlsext(SSL *s, unsigned char *buf,
 }
 
 /*
- * Process the ALPN extension in a ClientHello.
+ * Save the ALPN extension in a ClientHello.
  * pkt: the contents of the ALPN extension, not including type and length.
  * al: a pointer to the  alert value to send in the event of a failure.
  * returns: 1 on success, 0 on error.
  */
 static int tls1_alpn_handle_client_hello(SSL *s, PACKET *pkt, int *al)
 {
-    const unsigned char *selected;
-    unsigned char selected_len;
-    int r;
     PACKET protocol_list, save_protocol_list, protocol;
 
     *al = SSL_AD_DECODE_ERROR;
@@ -1753,25 +1756,47 @@ static int tls1_alpn_handle_client_hello(SSL *s, PACKET *pkt, int *al)
         }
     } while (PACKET_remaining(&amp;protocol_list) != 0);
 
-    if (s-&gt;ctx-&gt;alpn_select_cb == NULL)
-        return 1;
+    if (!PACKET_memdup(&amp;save_protocol_list,
+                       &amp;s-&gt;s3-&gt;alpn_proposed,
+                       &amp;s-&gt;s3-&gt;alpn_proposed_len)) {
+        *al = TLS1_AD_INTERNAL_ERROR;
+        return 0;
+    }
+
+    return 1;
+}
+
+/*
+ * Process the ALPN extension in a ClientHello.
+ * ret: a pointer to the TLSEXT return value: SSL_TLSEXT_ERR_*
+ * al: a pointer to the alert value to send in the event of a failure.
+ * returns 1 on success, 0
+ */
+static int tls1_alpn_handle_client_hello_late(SSL *s, int *ret, int *al)
+{
+    const unsigned char *selected = NULL;
+    unsigned char selected_len = 0;
 
-    r = s-&gt;ctx-&gt;alpn_select_cb(s, &amp;selected, &amp;selected_len,
-                               PACKET_data(&amp;save_protocol_list),
-                               PACKET_remaining(&amp;save_protocol_list),
-                               s-&gt;ctx-&gt;alpn_select_cb_arg);
-    if (r == SSL_TLSEXT_ERR_OK) {
-        OPENSSL_free(s-&gt;s3-&gt;alpn_selected);
-        s-&gt;s3-&gt;alpn_selected = OPENSSL_malloc(selected_len);
-        if (s-&gt;s3-&gt;alpn_selected == NULL) {
-            *al = SSL_AD_INTERNAL_ERROR;
+    if (s-&gt;ctx-&gt;alpn_select_cb != NULL &amp;&amp; s-&gt;s3-&gt;alpn_proposed != NULL) {
+        int r = s-&gt;ctx-&gt;alpn_select_cb(s, &amp;selected, &amp;selected_len,
+                                       s-&gt;s3-&gt;alpn_proposed,
+                                       s-&gt;s3-&gt;alpn_proposed_len,
+                                       s-&gt;ctx-&gt;alpn_select_cb_arg);
+
+        if (r == SSL_TLSEXT_ERR_OK) {
+            OPENSSL_free(s-&gt;s3-&gt;alpn_selected);
+            s-&gt;s3-&gt;alpn_selected = OPENSSL_memdup(selected, selected_len);
+            if (s-&gt;s3-&gt;alpn_selected == NULL) {
+                *al = SSL_AD_INTERNAL_ERROR;
+                *ret = SSL_TLSEXT_ERR_ALERT_FATAL;
+                return 0;
+            }
+            s-&gt;s3-&gt;alpn_selected_len = selected_len;
+        } else {
+            *al = SSL_AD_NO_APPLICATION_PROTOCOL;
+            *ret = SSL_TLSEXT_ERR_ALERT_FATAL;
             return 0;
         }
-        memcpy(s-&gt;s3-&gt;alpn_selected, selected, selected_len);
-        s-&gt;s3-&gt;alpn_selected_len = selected_len;
-    } else {
-        *al = SSL_AD_NO_APPLICATION_PROTOCOL;
-        return 0;
     }
 
     return 1;
@@ -2484,7 +2509,7 @@ static int ssl_scan_serverhello_tlsext(SSL *s, PACKET *pkt, int *al)
         else if (type == TLSEXT_TYPE_application_layer_protocol_negotiation) {
             unsigned len;
             /* We must have requested it. */
-            if (s-&gt;alpn_client_proto_list == NULL) {
+            if (!s-&gt;s3-&gt;alpn_sent) {
                 *al = TLS1_AD_UNSUPPORTED_EXTENSION;
                 return 0;
             }
@@ -2617,7 +2642,7 @@ static int ssl_scan_serverhello_tlsext(SSL *s, PACKET *pkt, int *al)
 
 int ssl_prepare_clienthello_tlsext(SSL *s)
 {
-
+    s-&gt;s3-&gt;alpn_sent = 0;
     return 1;
 }
 
@@ -2776,6 +2801,10 @@ int ssl_check_clienthello_tlsext_late(SSL *s)
     } else
         s-&gt;tlsext_status_expected = 0;
 
+    if (!tls1_alpn_handle_client_hello_late(s, &amp;ret, &amp;al)) {
+        goto err;
+    }
+
  err:
     switch (ret) {
     case SSL_TLSEXT_ERR_ALERT_FATAL:
diff --git a/test/recipes/80-test_ssl.t b/test/recipes/80-test_ssl.t
index 37237dc..5412cb6 100644
--- a/test/recipes/80-test_ssl.t
+++ b/test/recipes/80-test_ssl.t
@@ -64,7 +64,7 @@ my $P2intermediate=&quot;tmp_intP2.ss&quot;;
 plan tests =&gt;
     1				# For testss
     + 1				# For ssltest -test_cipherlist
-    + 11			# For the first testssl
+    + 13			# For the first testssl
     + 16			# For the first testsslproxy
     + 16			# For the second testsslproxy
     ;
@@ -603,10 +603,29 @@ sub testssl {
 	}
     };
 
+    subtest 'SNI tests' =&gt; sub {
+
+	plan tests =&gt; 7;
+
+      SKIP: {
+	  skip &quot;TLSv1.x is not supported by this OpenSSL build&quot;, 7
+	      if $no_tls1 &amp;&amp; $no_tls1_1 &amp;&amp; $no_tls1_2;
+
+	  ok(run(test([@ssltest, &quot;-bio_pair&quot;, &quot;-sn_client&quot;, &quot;foo&quot;])));
+	  ok(run(test([@ssltest, &quot;-bio_pair&quot;, &quot;-sn_server1&quot;, &quot;foo&quot;])));
+	  ok(run(test([@ssltest, &quot;-bio_pair&quot;, &quot;-sn_client&quot;, &quot;foo&quot;, &quot;-sn_server1&quot;, &quot;foo&quot;, &quot;-sn_expect1&quot;])));
+	  ok(run(test([@ssltest, &quot;-bio_pair&quot;, &quot;-sn_client&quot;, &quot;foo&quot;, &quot;-sn_server1&quot;, &quot;bar&quot;, &quot;-sn_expect1&quot;])));
+	  ok(run(test([@ssltest, &quot;-bio_pair&quot;, &quot;-sn_client&quot;, &quot;foo&quot;, &quot;-sn_server1&quot;, &quot;foo&quot;, &quot;-sn_server2&quot;, &quot;bar&quot;, &quot;-sn_expect1&quot;])));
+	  ok(run(test([@ssltest, &quot;-bio_pair&quot;, &quot;-sn_client&quot;, &quot;bar&quot;, &quot;-sn_server1&quot;, &quot;foo&quot;, &quot;-sn_server2&quot;, &quot;bar&quot;, &quot;-sn_expect2&quot;])));
+	  # Negative test - make sure it doesn't crash, and doesn't switch contexts
+	  ok(run(test([@ssltest, &quot;-bio_pair&quot;, &quot;-sn_client&quot;, &quot;foobar&quot;, &quot;-sn_server1&quot;, &quot;foo&quot;, &quot;-sn_server2&quot;, &quot;bar&quot;, &quot;-sn_expect1&quot;])));
+	}
+    };
+
     subtest 'ALPN tests' =&gt; sub {
 	######################################################################
 
-	plan tests =&gt; 14;
+	plan tests =&gt; 12;
 
       SKIP: {
 	  skip &quot;TLSv1.0 is not supported by this OpenSSL build&quot;, 12
@@ -626,22 +645,39 @@ sub testssl {
 	  is(run(test([@ssltest, &quot;-bio_pair&quot;, &quot;-tls1&quot;, &quot;-alpn_client&quot;, &quot;baz&quot;, &quot;-alpn_server&quot;, &quot;bar,foo&quot;])), 0,
              &quot;Testing ALPN with protocol mismatch, expecting failure&quot;);
 
-	SKIP: {
-	    skip &quot;skipping SRP tests&quot;, 4
-		if $no_srp;
+	  # ALPN + SNI
+	  ok(run(test([@ssltest, &quot;-bio_pair&quot;,
+		       &quot;-alpn_client&quot;, &quot;foo,bar&quot;, &quot;-sn_client&quot;, &quot;alice&quot;,
+		       &quot;-alpn_server1&quot;, &quot;foo,123&quot;, &quot;-sn_server1&quot;, &quot;alice&quot;,
+		       &quot;-alpn_server2&quot;, &quot;bar,456&quot;, &quot;-sn_server2&quot;, &quot;bob&quot;,
+		       &quot;-alpn_expected&quot;, &quot;foo&quot;])));
+	  ok(run(test([@ssltest, &quot;-bio_pair&quot;,
+		       &quot;-alpn_client&quot;, &quot;foo,bar&quot;, &quot;-sn_client&quot;, &quot;bob&quot;,
+		       &quot;-alpn_server1&quot;, &quot;foo,123&quot;, &quot;-sn_server1&quot;, &quot;alice&quot;,
+		       &quot;-alpn_server2&quot;, &quot;bar,456&quot;, &quot;-sn_server2&quot;, &quot;bob&quot;,
+		       &quot;-alpn_expected&quot;, &quot;bar&quot;])));
+	}
+    };
 
-	    ok(run(test([@ssltest, &quot;-tls1&quot;, &quot;-cipher&quot;, &quot;SRP&quot;, &quot;-srpuser&quot;, &quot;test&quot;, &quot;-srppass&quot;, &quot;abc123&quot;])),
-	       'test tls1 with SRP');
+    subtest 'SRP tests' =&gt; sub {
 
-	    ok(run(test([@ssltest, &quot;-bio_pair&quot;, &quot;-tls1&quot;, &quot;-cipher&quot;, &quot;SRP&quot;, &quot;-srpuser&quot;, &quot;test&quot;, &quot;-srppass&quot;, &quot;abc123&quot;])),
-	       'test tls1 with SRP via BIO pair');
+	plan tests =&gt; 4;
 
-	    ok(run(test([@ssltest, &quot;-tls1&quot;, &quot;-cipher&quot;, &quot;aSRP&quot;, &quot;-srpuser&quot;, &quot;test&quot;, &quot;-srppass&quot;, &quot;abc123&quot;])),
-		 'test tls1 with SRP auth');
+      SKIP: {
+	  skip &quot;skipping SRP tests&quot;, 4
+	      if $no_srp;
 
-	    ok(run(test([@ssltest, &quot;-bio_pair&quot;, &quot;-tls1&quot;, &quot;-cipher&quot;, &quot;aSRP&quot;, &quot;-srpuser&quot;, &quot;test&quot;, &quot;-srppass&quot;, &quot;abc123&quot;])),
-	       'test tls1 with SRP auth via BIO pair');
-	  }
+	  ok(run(test([@ssltest, &quot;-tls1&quot;, &quot;-cipher&quot;, &quot;SRP&quot;, &quot;-srpuser&quot;, &quot;test&quot;, &quot;-srppass&quot;, &quot;abc123&quot;])),
+	     'test tls1 with SRP');
+
+	  ok(run(test([@ssltest, &quot;-bio_pair&quot;, &quot;-tls1&quot;, &quot;-cipher&quot;, &quot;SRP&quot;, &quot;-srpuser&quot;, &quot;test&quot;, &quot;-srppass&quot;, &quot;abc123&quot;])),
+	     'test tls1 with SRP via BIO pair');
+
+	  ok(run(test([@ssltest, &quot;-tls1&quot;, &quot;-cipher&quot;, &quot;aSRP&quot;, &quot;-srpuser&quot;, &quot;test&quot;, &quot;-srppass&quot;, &quot;abc123&quot;])),
+	     'test tls1 with SRP auth');
+
+	  ok(run(test([@ssltest, &quot;-bio_pair&quot;, &quot;-tls1&quot;, &quot;-cipher&quot;, &quot;aSRP&quot;, &quot;-srpuser&quot;, &quot;test&quot;, &quot;-srppass&quot;, &quot;abc123&quot;])),
+	     'test tls1 with SRP auth via BIO pair');
 	}
     };
 
diff --git a/test/ssltest.c b/test/ssltest.c
index da9391a..a8918db 100644
--- a/test/ssltest.c
+++ b/test/ssltest.c
@@ -207,6 +207,9 @@
 # include OPENSSL_UNISTD
 #endif
 
+SSL_CTX *s_ctx = NULL;
+SSL_CTX *s_ctx2 = NULL;
+
 /*
  * There is really no standard for this, so let's assign something
  * only for this test
@@ -366,7 +369,8 @@ static int verify_npn(SSL *client, SSL *server)
 #endif
 
 static const char *alpn_client;
-static const char *alpn_server;
+static char *alpn_server;
+static char *alpn_server2;
 static const char *alpn_expected;
 static unsigned char *alpn_selected;
 static const char *server_min_proto;
@@ -374,6 +378,48 @@ static const char *server_max_proto;
 static const char *client_min_proto;
 static const char *client_max_proto;
 static const char *should_negotiate;
+static const char *sn_client;
+static const char *sn_server1;
+static const char *sn_server2;
+static int sn_expect = 0;
+
+static int servername_cb(SSL *s, int *ad, void *arg)
+{
+    const char *servername = SSL_get_servername(s, TLSEXT_NAMETYPE_host_name);
+    if (sn_server2 == NULL) {
+        BIO_printf(bio_stdout, &quot;Servername 2 is NULL\n&quot;);
+        return SSL_TLSEXT_ERR_NOACK;
+    }
+
+    if (servername) {
+        if (s_ctx2 != NULL &amp;&amp; sn_server2 != NULL &amp;&amp;
+            !strcasecmp(servername, sn_server2)) {
+            BIO_printf(bio_stdout, &quot;Switching server context.\n&quot;);
+            SSL_set_SSL_CTX(s, s_ctx2);
+        }
+    }
+    return SSL_TLSEXT_ERR_OK;
+}
+static int verify_servername(SSL *client, SSL *server)
+{
+    /* just need to see if sn_context is what we expect */
+    SSL_CTX* ctx = SSL_get_SSL_CTX(server);
+    if (sn_expect == 0)
+        return 0;
+    if (sn_expect == 1 &amp;&amp; ctx == s_ctx)
+        return 0;
+    if (sn_expect == 2 &amp;&amp; ctx == s_ctx2)
+        return 0;
+    BIO_printf(bio_stdout, &quot;Servername: expected context %d\n&quot;, sn_expect);
+    if (ctx == s_ctx2)
+        BIO_printf(bio_stdout, &quot;Servername: context is 2\n&quot;);
+    else if (ctx == s_ctx)
+        BIO_printf(bio_stdout, &quot;Servername: context is 1\n&quot;);
+    else
+        BIO_printf(bio_stdout, &quot;Servername: context is unknown\n&quot;);
+    return -1;
+}
+
 
 /*-
  * next_protos_parse parses a comma separated list of strings into a string
@@ -384,7 +430,7 @@ static const char *should_negotiate;
  *
  *   returns: a malloced buffer or NULL on failure.
  */
-static unsigned char *next_protos_parse(unsigned short *outlen,
+static unsigned char *next_protos_parse(size_t *outlen,
                                         const char *in)
 {
     size_t len;
@@ -420,12 +466,13 @@ static int cb_server_alpn(SSL *s, const unsigned char **out,
                           unsigned int inlen, void *arg)
 {
     unsigned char *protos;
-    unsigned short protos_len;
+    size_t protos_len;
+    char* alpn_str = arg;
 
-    protos = next_protos_parse(&amp;protos_len, alpn_server);
+    protos = next_protos_parse(&amp;protos_len, alpn_str);
     if (protos == NULL) {
         fprintf(stderr, &quot;failed to parser ALPN server protocol string: %s\n&quot;,
-                alpn_server);
+                alpn_str);
         abort();
     }
 
@@ -491,8 +538,15 @@ static int verify_alpn(SSL *client, SSL *server)
     BIO_printf(bio_stdout, &quot;', server: '&quot;);
     BIO_write(bio_stdout, server_proto, server_proto_len);
     BIO_printf(bio_stdout, &quot;'\n&quot;);
-    BIO_printf(bio_stdout, &quot;ALPN configured: client: '%s', server: '%s'\n&quot;,
-               alpn_client, alpn_server);
+    BIO_printf(bio_stdout, &quot;ALPN configured: client: '%s', server: '&quot;,
+                   alpn_client);
+    if (SSL_get_SSL_CTX(server) == s_ctx2) {
+        BIO_printf(bio_stdout, &quot;%s'\n&quot;,
+                   alpn_server2);
+    } else {
+        BIO_printf(bio_stdout, &quot;%s'\n&quot;,
+                   alpn_server);
+    }
     return -1;
 }
 
@@ -769,7 +823,7 @@ static void sv_usage(void)
     fprintf(stderr, &quot; -no_dhe       - disable DHE\n&quot;);
 #endif
 #ifndef OPENSSL_NO_EC
-    fprintf(stderr, &quot; -no_ecdhe     - disable ECDHE\n&quot;);
+    fprintf(stderr, &quot; -no_ecdhe     - disable ECDHE\nTODO(openssl-team): no_ecdhe was broken by auto ecdh. Make this work again.\n&quot;);
 #endif
 #ifndef OPENSSL_NO_PSK
     fprintf(stderr, &quot; -psk arg      - PSK in hex (without 0x)\n&quot;);
@@ -809,12 +863,6 @@ static void sv_usage(void)
     fprintf(stderr,
             &quot; -time         - measure processor time used by client and server\n&quot;);
     fprintf(stderr, &quot; -zlib         - use zlib compression\n&quot;);
-#ifndef OPENSSL_NO_EC
-    fprintf(stderr,
-            &quot; -named_curve arg  - Elliptic curve name to use for ephemeral ECDH keys.\n&quot;
-            &quot;                 Use \&quot;openssl ecparam -list_curves\&quot; for all names\n&quot;
-            &quot;                 (default is sect163r2).\n&quot;);
-#endif
     fprintf(stderr,
             &quot; -test_cipherlist - Verifies the order of the ssl cipher lists.\n&quot;
             &quot;                    When this option is requested, the cipherlist\n&quot;
@@ -832,6 +880,8 @@ static void sv_usage(void)
             &quot; -custom_ext - try various custom extension callbacks\n&quot;);
     fprintf(stderr, &quot; -alpn_client &lt;string&gt; - have client side offer ALPN\n&quot;);
     fprintf(stderr, &quot; -alpn_server &lt;string&gt; - have server side offer ALPN\n&quot;);
+    fprintf(stderr, &quot; -alpn_server1 &lt;string&gt; - alias for -alpn_server\n&quot;);
+    fprintf(stderr, &quot; -alpn_server2 &lt;string&gt; - have server side context 2 offer ALPN\n&quot;);
     fprintf(stderr,
             &quot; -alpn_expected &lt;string&gt; - the ALPN protocol that should be negotiated\n&quot;);
     fprintf(stderr, &quot; -server_min_proto &lt;string&gt; - Minimum version the server should support\n&quot;);
@@ -844,6 +894,11 @@ static void sv_usage(void)
     fprintf(stderr, &quot; -requestct    - request certificate transparency\n&quot;);
     fprintf(stderr, &quot; -requirect    - require certificate transparency\n&quot;);
 #endif
+    fprintf(stderr, &quot; -sn_client &lt;string&gt;  - have client request this servername\n&quot;);
+    fprintf(stderr, &quot; -sn_server1 &lt;string&gt; - have server context 1 respond to this servername\n&quot;);
+    fprintf(stderr, &quot; -sn_server2 &lt;string&gt; - have server context 2 respond to this servername\n&quot;);
+    fprintf(stderr, &quot; -sn_expect1          - expected server 1\n&quot;);
+    fprintf(stderr, &quot; -sn_expect2          - expected server 2\n&quot;);
 }
 
 static void print_key_details(BIO *out, EVP_PKEY *key)
@@ -1025,10 +1080,6 @@ int main(int argc, char *argv[])
     struct app_verify_arg app_verify_arg =
         { APP_CALLBACK_STRING, 0, 0, NULL, NULL };
     char *p;
-#ifndef OPENSSL_NO_EC
-    char *named_curve = NULL;
-#endif
-    SSL_CTX *s_ctx = NULL;
     SSL_CTX *c_ctx = NULL;
     const SSL_METHOD *meth = NULL;
     SSL *c_ssl, *s_ssl;
@@ -1038,9 +1089,6 @@ int main(int argc, char *argv[])
     DH *dh;
     int dhe512 = 0, dhe1024dsa = 0;
 #endif
-#ifndef OPENSSL_NO_EC
-    EC_KEY *ecdh = NULL;
-#endif
 #ifndef OPENSSL_NO_SRP
     /* client */
     SRP_CLIENT_ARG srp_client_arg = { NULL, NULL };
@@ -1048,7 +1096,6 @@ int main(int argc, char *argv[])
     SRP_SERVER_ARG srp_server_arg = { NULL, NULL };
 #endif
     int no_dhe = 0;
-    int no_ecdhe = 0;
     int no_psk = 0;
     int print_time = 0;
     clock_t s_time = 0, c_time = 0;
@@ -1071,7 +1118,7 @@ int main(int argc, char *argv[])
     ct_validation_cb ct_validation = NULL;
 #endif
 
-    SSL_CONF_CTX *s_cctx = NULL, *c_cctx = NULL;
+    SSL_CONF_CTX *s_cctx = NULL, *c_cctx = NULL, *s_cctx2 = NULL;
     STACK_OF(OPENSSL_STRING) *conf_args = NULL;
     char *arg = NULL, *argn = NULL;
 
@@ -1093,9 +1140,10 @@ int main(int argc, char *argv[])
     bio_stdout = BIO_new_fp(stdout, BIO_NOCLOSE | BIO_FP_TEXT);
 
     s_cctx = SSL_CONF_CTX_new();
+    s_cctx2 = SSL_CONF_CTX_new();
     c_cctx = SSL_CONF_CTX_new();
 
-    if (!s_cctx || !c_cctx) {
+    if (!s_cctx || !c_cctx || !s_cctx2) {
         ERR_print_errors(bio_err);
         goto end;
     }
@@ -1104,10 +1152,18 @@ int main(int argc, char *argv[])
                            SSL_CONF_FLAG_CMDLINE | SSL_CONF_FLAG_SERVER |
                            SSL_CONF_FLAG_CERTIFICATE |
                            SSL_CONF_FLAG_REQUIRE_PRIVATE);
+    SSL_CONF_CTX_set_flags(s_cctx2,
+                           SSL_CONF_FLAG_CMDLINE | SSL_CONF_FLAG_SERVER |
+                           SSL_CONF_FLAG_CERTIFICATE |
+                           SSL_CONF_FLAG_REQUIRE_PRIVATE);
     if (!SSL_CONF_CTX_set1_prefix(s_cctx, &quot;-s_&quot;)) {
         ERR_print_errors(bio_err);
         goto end;
     }
+    if (!SSL_CONF_CTX_set1_prefix(s_cctx2, &quot;-s_&quot;)) {
+        ERR_print_errors(bio_err);
+        goto end;
+    }
 
     SSL_CONF_CTX_set_flags(c_cctx,
                            SSL_CONF_FLAG_CMDLINE | SSL_CONF_FLAG_CLIENT |
@@ -1165,7 +1221,7 @@ int main(int argc, char *argv[])
         } else if (strcmp(*argv, &quot;-no_dhe&quot;) == 0)
             no_dhe = 1;
         else if (strcmp(*argv, &quot;-no_ecdhe&quot;) == 0)
-            no_ecdhe = 1;
+            /* obsolete */;
         else if (strcmp(*argv, &quot;-psk&quot;) == 0) {
             if (--argc &lt; 1)
                 goto bad;
@@ -1259,17 +1315,7 @@ int main(int argc, char *argv[])
             comp = COMP_ZLIB;
         }
 #endif
-        else if (strcmp(*argv, &quot;-named_curve&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-#ifndef OPENSSL_NO_EC
-            named_curve = *(++argv);
-#else
-            fprintf(stderr,
-                    &quot;ignoring -named_curve, since I'm compiled without ECDH\n&quot;);
-            ++argv;
-#endif
-        } else if (strcmp(*argv, &quot;-app_verify&quot;) == 0) {
+        else if (strcmp(*argv, &quot;-app_verify&quot;) == 0) {
             app_verify_arg.app_verify = 1;
         } else if (strcmp(*argv, &quot;-proxy&quot;) == 0) {
             app_verify_arg.allow_proxy_certs = 1;
@@ -1299,10 +1345,15 @@ int main(int argc, char *argv[])
             if (--argc &lt; 1)
                 goto bad;
             alpn_client = *(++argv);
-        } else if (strcmp(*argv, &quot;-alpn_server&quot;) == 0) {
+        } else if (strcmp(*argv, &quot;-alpn_server&quot;) == 0 ||
+                   strcmp(*argv, &quot;-alpn_server1&quot;) == 0) {
             if (--argc &lt; 1)
                 goto bad;
             alpn_server = *(++argv);
+        } else if (strcmp(*argv, &quot;-alpn_server2&quot;) == 0) {
+            if (--argc &lt; 1)
+                goto bad;
+            alpn_server2 = *(++argv);
         } else if (strcmp(*argv, &quot;-alpn_expected&quot;) == 0) {
             if (--argc &lt; 1)
                 goto bad;
@@ -1327,6 +1378,22 @@ int main(int argc, char *argv[])
             if (--argc &lt; 1)
                 goto bad;
             should_negotiate = *(++argv);
+        } else if (strcmp(*argv, &quot;-sn_client&quot;) == 0) {
+            if (--argc &lt; 1)
+                goto bad;
+            sn_client = *(++argv);
+        } else if (strcmp(*argv, &quot;-sn_server1&quot;) == 0) {
+            if (--argc &lt; 1)
+                goto bad;
+            sn_server1 = *(++argv);
+        } else if (strcmp(*argv, &quot;-sn_server2&quot;) == 0) {
+            if (--argc &lt; 1)
+                goto bad;
+            sn_server2 = *(++argv);
+        } else if (strcmp(*argv, &quot;-sn_expect1&quot;) == 0) {
+            sn_expect = 1;
+        } else if (strcmp(*argv, &quot;-sn_expect2&quot;) == 0) {
+            sn_expect = 2;
         } else {
             int rv;
             arg = argv[0];
@@ -1517,7 +1584,8 @@ int main(int argc, char *argv[])
 
     c_ctx = SSL_CTX_new(meth);
     s_ctx = SSL_CTX_new(meth);
-    if ((c_ctx == NULL) || (s_ctx == NULL)) {
+    s_ctx2 = SSL_CTX_new(meth); /* no SSL_CTX_dup! */
+    if ((c_ctx == NULL) || (s_ctx == NULL) || (s_ctx2 == NULL)) {
         ERR_print_errors(bio_err);
         goto end;
     }
@@ -1528,10 +1596,12 @@ int main(int argc, char *argv[])
      */
     SSL_CTX_set_security_level(c_ctx, 0);
     SSL_CTX_set_security_level(s_ctx, 0);
+    SSL_CTX_set_security_level(s_ctx2, 0);
 
     if (cipher != NULL) {
         if (!SSL_CTX_set_cipher_list(c_ctx, cipher)
-           || !SSL_CTX_set_cipher_list(s_ctx, cipher)) {
+            || !SSL_CTX_set_cipher_list(s_ctx, cipher)
+            || !SSL_CTX_set_cipher_list(s_ctx2, cipher)) {
             ERR_print_errors(bio_err);
             goto end;
         }
@@ -1547,6 +1617,7 @@ int main(int argc, char *argv[])
     /* Process SSL_CONF arguments */
     SSL_CONF_CTX_set_ssl_ctx(c_cctx, c_ctx);
     SSL_CONF_CTX_set_ssl_ctx(s_cctx, s_ctx);
+    SSL_CONF_CTX_set_ssl_ctx(s_cctx2, s_ctx2);
 
     for (i = 0; i &lt; sk_OPENSSL_STRING_num(conf_args); i += 2) {
         int rv;
@@ -1554,8 +1625,10 @@ int main(int argc, char *argv[])
         argn = sk_OPENSSL_STRING_value(conf_args, i + 1);
         rv = SSL_CONF_cmd(c_cctx, arg, argn);
         /* If not recognised use server context */
-        if (rv == -2)
+        if (rv == -2) {
+            SSL_CONF_cmd(s_cctx2, arg, argn);
             rv = SSL_CONF_cmd(s_cctx, arg, argn);
+        }
         if (rv &lt;= 0) {
             BIO_printf(bio_err, &quot;Error processing %s %s\n&quot;,
                        arg, argn ? argn : &quot;&quot;);
@@ -1564,7 +1637,7 @@ int main(int argc, char *argv[])
         }
     }
 
-    if (!SSL_CONF_CTX_finish(s_cctx) || !SSL_CONF_CTX_finish(c_cctx)) {
+    if (!SSL_CONF_CTX_finish(s_cctx) || !SSL_CONF_CTX_finish(c_cctx) || !SSL_CONF_CTX_finish(s_cctx2)) {
         BIO_puts(bio_err, &quot;Error finishing context\n&quot;);
         ERR_print_errors(bio_err);
         goto end;
@@ -1572,52 +1645,23 @@ int main(int argc, char *argv[])
 #ifndef OPENSSL_NO_DH
     if (!no_dhe) {
         if (dhe1024dsa) {
-            /*
-             * use SSL_OP_SINGLE_DH_USE to avoid small subgroup attacks
-             */
-            SSL_CTX_set_options(s_ctx, SSL_OP_SINGLE_DH_USE);
             dh = get_dh1024dsa();
         } else if (dhe512)
             dh = get_dh512();
         else
             dh = get_dh1024();
         SSL_CTX_set_tmp_dh(s_ctx, dh);
+        SSL_CTX_set_tmp_dh(s_ctx2, dh);
         DH_free(dh);
     }
 #else
     (void)no_dhe;
 #endif
 
-#ifndef OPENSSL_NO_EC
-    if (!no_ecdhe) {
-        int nid;
-
-        if (named_curve != NULL) {
-            nid = OBJ_sn2nid(named_curve);
-            if (nid == 0) {
-                BIO_printf(bio_err, &quot;unknown curve name (%s)\n&quot;, named_curve);
-                goto end;
-            }
-        } else {
-            nid = NID_X9_62_prime256v1;
-        }
-
-        ecdh = EC_KEY_new_by_curve_name(nid);
-        if (ecdh == NULL) {
-            BIO_printf(bio_err, &quot;unable to create curve\n&quot;);
-            goto end;
-        }
-
-        SSL_CTX_set_tmp_ecdh(s_ctx, ecdh);
-        SSL_CTX_set_options(s_ctx, SSL_OP_SINGLE_ECDH_USE);
-        EC_KEY_free(ecdh);
-    }
-#else
-    (void)no_ecdhe;
-#endif
-
     if ((!SSL_CTX_load_verify_locations(s_ctx, CAfile, CApath)) ||
         (!SSL_CTX_set_default_verify_paths(s_ctx)) ||
+        (!SSL_CTX_load_verify_locations(s_ctx2, CAfile, CApath)) ||
+        (!SSL_CTX_set_default_verify_paths(s_ctx2)) ||
         (!SSL_CTX_load_verify_locations(c_ctx, CAfile, CApath)) ||
         (!SSL_CTX_set_default_verify_paths(c_ctx))) {
         /* fprintf(stderr,&quot;SSL_load_verify_locations\n&quot;); */
@@ -1626,6 +1670,7 @@ int main(int argc, char *argv[])
     }
 
     if (!SSL_CTX_set_default_ctlog_list_file(s_ctx) ||
+        !SSL_CTX_set_default_ctlog_list_file(s_ctx2) ||
         !SSL_CTX_set_default_ctlog_list_file(c_ctx)) {
         ERR_print_errors(bio_err);
     }
@@ -1635,8 +1680,13 @@ int main(int argc, char *argv[])
         SSL_CTX_set_verify(s_ctx,
                            SSL_VERIFY_PEER | SSL_VERIFY_FAIL_IF_NO_PEER_CERT,
                            verify_callback);
+        SSL_CTX_set_verify(s_ctx2,
+                           SSL_VERIFY_PEER | SSL_VERIFY_FAIL_IF_NO_PEER_CERT,
+                           verify_callback);
         SSL_CTX_set_cert_verify_callback(s_ctx, app_verify_callback,
                                          &amp;app_verify_arg);
+        SSL_CTX_set_cert_verify_callback(s_ctx2, app_verify_callback,
+                                         &amp;app_verify_arg);
     }
     if (server_auth) {
         printf(&quot;server authentication\n&quot;);
@@ -1648,7 +1698,9 @@ int main(int argc, char *argv[])
     {
         int session_id_context = 0;
         if (!SSL_CTX_set_session_id_context(s_ctx, (void *)&amp;session_id_context,
-                                       sizeof session_id_context)) {
+                                            sizeof session_id_context) ||
+            !SSL_CTX_set_session_id_context(s_ctx2, (void *)&amp;session_id_context,
+                                            sizeof session_id_context)) {
             ERR_print_errors(bio_err);
             goto end;
         }
@@ -1670,9 +1722,11 @@ int main(int argc, char *argv[])
 #ifndef OPENSSL_NO_PSK
         SSL_CTX_set_psk_client_callback(c_ctx, psk_client_callback);
         SSL_CTX_set_psk_server_callback(s_ctx, psk_server_callback);
+        SSL_CTX_set_psk_server_callback(s_ctx2, psk_server_callback);
         if (debug)
             BIO_printf(bio_err, &quot;setting PSK identity hint to s_ctx\n&quot;);
-        if (!SSL_CTX_use_psk_identity_hint(s_ctx, &quot;ctx server identity_hint&quot;)) {
+        if (!SSL_CTX_use_psk_identity_hint(s_ctx, &quot;ctx server identity_hint&quot;) ||
+            !SSL_CTX_use_psk_identity_hint(s_ctx2, &quot;ctx server identity_hint&quot;)) {
             BIO_printf(bio_err, &quot;error setting PSK identity hint to s_ctx\n&quot;);
             ERR_print_errors(bio_err);
             goto end;
@@ -1695,8 +1749,11 @@ int main(int argc, char *argv[])
 
     if (srp_server_arg.expected_user != NULL) {
         SSL_CTX_set_verify(s_ctx, SSL_VERIFY_NONE, verify_callback);
+        SSL_CTX_set_verify(s_ctx2, SSL_VERIFY_NONE, verify_callback);
         SSL_CTX_set_srp_cb_arg(s_ctx, &amp;srp_server_arg);
+        SSL_CTX_set_srp_cb_arg(s_ctx2, &amp;srp_server_arg);
         SSL_CTX_set_srp_username_callback(s_ctx, ssl_srp_server_param_cb);
+        SSL_CTX_set_srp_username_callback(s_ctx2, ssl_srp_server_param_cb);
     }
 #endif
 
@@ -1711,10 +1768,13 @@ int main(int argc, char *argv[])
             goto end;
         }
         SSL_CTX_set_next_protos_advertised_cb(s_ctx, cb_server_npn, NULL);
+        SSL_CTX_set_next_protos_advertised_cb(s_ctx2, cb_server_npn, NULL);
     }
     if (npn_server_reject) {
         SSL_CTX_set_next_protos_advertised_cb(s_ctx, cb_server_rejects_npn,
                                               NULL);
+        SSL_CTX_set_next_protos_advertised_cb(s_ctx2, cb_server_rejects_npn,
+                                              NULL);
     }
 #endif
 
@@ -1736,7 +1796,8 @@ int main(int argc, char *argv[])
         }
     }
     if (serverinfo_file)
-        if (!SSL_CTX_use_serverinfo_file(s_ctx, serverinfo_file)) {
+        if (!SSL_CTX_use_serverinfo_file(s_ctx, serverinfo_file) ||
+            !SSL_CTX_use_serverinfo_file(s_ctx2, serverinfo_file)) {
             BIO_printf(bio_err, &quot;missing serverinfo file\n&quot;);
             goto end;
         }
@@ -1762,17 +1823,33 @@ int main(int argc, char *argv[])
                                       custom_ext_0_srv_add_cb,
                                       NULL, NULL,
                                       custom_ext_0_srv_parse_cb, NULL)
+            || !SSL_CTX_add_server_custom_ext(s_ctx2, CUSTOM_EXT_TYPE_0,
+                                      custom_ext_0_srv_add_cb,
+                                      NULL, NULL,
+                                      custom_ext_0_srv_parse_cb, NULL)
             || !SSL_CTX_add_server_custom_ext(s_ctx, CUSTOM_EXT_TYPE_1,
                                       custom_ext_1_srv_add_cb,
                                       NULL, NULL,
                                       custom_ext_1_srv_parse_cb, NULL)
+            || !SSL_CTX_add_server_custom_ext(s_ctx2, CUSTOM_EXT_TYPE_1,
+                                      custom_ext_1_srv_add_cb,
+                                      NULL, NULL,
+                                      custom_ext_1_srv_parse_cb, NULL)
             || !SSL_CTX_add_server_custom_ext(s_ctx, CUSTOM_EXT_TYPE_2,
                                       custom_ext_2_srv_add_cb,
                                       NULL, NULL,
                                       custom_ext_2_srv_parse_cb, NULL)
+            || !SSL_CTX_add_server_custom_ext(s_ctx2, CUSTOM_EXT_TYPE_2,
+                                      custom_ext_2_srv_add_cb,
+                                      NULL, NULL,
+                                      custom_ext_2_srv_parse_cb, NULL)
             || !SSL_CTX_add_server_custom_ext(s_ctx, CUSTOM_EXT_TYPE_3,
                                       custom_ext_3_srv_add_cb,
                                       NULL, NULL,
+                                      custom_ext_3_srv_parse_cb, NULL)
+            || !SSL_CTX_add_server_custom_ext(s_ctx2, CUSTOM_EXT_TYPE_3,
+                                      custom_ext_3_srv_add_cb,
+                                      NULL, NULL,
                                       custom_ext_3_srv_parse_cb, NULL)) {
             BIO_printf(bio_err, &quot;Error setting custom extensions\n&quot;);
             goto end;
@@ -1780,10 +1857,12 @@ int main(int argc, char *argv[])
     }
 
     if (alpn_server)
-        SSL_CTX_set_alpn_select_cb(s_ctx, cb_server_alpn, NULL);
+        SSL_CTX_set_alpn_select_cb(s_ctx, cb_server_alpn, alpn_server);
+    if (alpn_server2)
+        SSL_CTX_set_alpn_select_cb(s_ctx2, cb_server_alpn, alpn_server2);
 
     if (alpn_client) {
-        unsigned short alpn_len;
+        size_t alpn_len;
         unsigned char *alpn = next_protos_parse(&amp;alpn_len, alpn_client);
 
         if (alpn == NULL) {
@@ -1799,9 +1878,15 @@ int main(int argc, char *argv[])
         OPENSSL_free(alpn);
     }
 
+    if (sn_server1 != NULL || sn_server2 != NULL)
+        SSL_CTX_set_tlsext_servername_callback(s_ctx, servername_cb);
+
     c_ssl = SSL_new(c_ctx);
     s_ssl = SSL_new(s_ctx);
 
+    if (sn_client)
+        SSL_set_tlsext_host_name(c_ssl, sn_client);
+
     if (!set_protocol_version(server_min_proto, s_ssl, SSL_CTRL_SET_MIN_PROTO_VERSION))
         goto end;
     if (!set_protocol_version(server_max_proto, s_ssl, SSL_CTRL_SET_MAX_PROTO_VERSION))
@@ -1883,8 +1968,10 @@ int main(int argc, char *argv[])
 
  end:
     SSL_CTX_free(s_ctx);
+    SSL_CTX_free(s_ctx2);
     SSL_CTX_free(c_ctx);
     SSL_CONF_CTX_free(s_cctx);
+    SSL_CONF_CTX_free(s_cctx2);
     SSL_CONF_CTX_free(c_cctx);
     sk_OPENSSL_STRING_free(conf_args);
 
@@ -2152,6 +2239,10 @@ int doit_localhost(SSL *s_ssl, SSL *c_ssl, int family, long count,
         ret = 1;
         goto err;
     }
+    if (verify_servername(c_ssl, s_ssl) &lt; 0) {
+        ret = 1;
+        goto err;
+    }
 
     if (custom_ext_error) {
         fprintf(stderr, &quot;Custom extension error\n&quot;);
@@ -2528,6 +2619,10 @@ int doit_biopair(SSL *s_ssl, SSL *c_ssl, long count,
         ret = 1;
         goto err;
     }
+    if (verify_servername(c_ssl, s_ssl) &lt; 0) {
+        ret = 1;
+        goto err;
+    }
 
     if (custom_ext_error) {
         fprintf(stderr, &quot;Custom extension error\n&quot;);
</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="005088.html">[openssl-commits] [openssl]  master update
</A></li>
	<LI>Next message: <A HREF="005093.html">[openssl-commits] [openssl]  master update
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#5092">[ date ]</a>
              <a href="thread.html#5092">[ thread ]</a>
              <a href="subject.html#5092">[ subject ]</a>
              <a href="author.html#5092">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="../../../mailman/listinfo/openssl-commits.html">More information about the openssl-commits
mailing list</a><br>
</body></html>
