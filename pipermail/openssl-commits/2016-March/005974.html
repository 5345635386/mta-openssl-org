<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [openssl-commits] [openssl]  master update
   </TITLE>
   <LINK REL="Index" HREF="https://mta.openssl.org/pipermail/openssl-commits/2016-March/index.html" >
   <LINK REL="made" HREF="mailto:openssl-commits%40openssl.org?Subject=Re%3A%20%5Bopenssl-commits%5D%20%5Bopenssl%5D%20%20master%20update&In-Reply-To=%3C1459269965.480107.3425.nullmailer%40dev.openssl.org%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="005963.html">
   <LINK REL="Next"  HREF="005976.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[openssl-commits] [openssl]  master update</H1>
    <B>Matt Caswell</B> 
    <A HREF="mailto:openssl-commits%40openssl.org?Subject=Re%3A%20%5Bopenssl-commits%5D%20%5Bopenssl%5D%20%20master%20update&In-Reply-To=%3C1459269965.480107.3425.nullmailer%40dev.openssl.org%3E"
       TITLE="[openssl-commits] [openssl]  master update">matt at openssl.org
       </A><BR>
    <I>Tue Mar 29 16:46:05 UTC 2016</I>
    <P><UL>
        <LI>Previous message: <A HREF="005963.html">[openssl-commits] [openssl]  master update
</A></li>
        <LI>Next message: <A HREF="005976.html">[openssl-commits] [openssl]  master update
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#5974">[ date ]</a>
              <a href="thread.html#5974">[ thread ]</a>
              <a href="subject.html#5974">[ subject ]</a>
              <a href="author.html#5974">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>The branch master has been updated
       via  eb47aae5d33de3d39379c15e20cbbd12ea8a29be (commit)
       via  85556b4dec97b1402e1edeaef6ffc0e9cd931457 (commit)
       via  173755255837d22c2bfbfe455164c67758224cb1 (commit)
       via  a146ae55ba479a5c7aa2a6afba1b2b93102a152c (commit)
       via  f334461facc4078adbad6552563f77799c174cab (commit)
       via  1a50b8139a6221d65bc526ab415c77b0561ff708 (commit)
      from  bbe9769ba66ab2512678a87b0d9b266ba970db05 (commit)


- Log -----------------------------------------------------------------
commit eb47aae5d33de3d39379c15e20cbbd12ea8a29be
Author: Matt Caswell &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">matt at openssl.org</A>&gt;
Date:   Tue Mar 29 16:03:08 2016 +0100

    Add a CHANGES entry for opaque BIOs
    
    Reviewed-by: Richard Levitte &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">levitte at openssl.org</A>&gt;

commit 85556b4dec97b1402e1edeaef6ffc0e9cd931457
Author: Matt Caswell &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">matt at openssl.org</A>&gt;
Date:   Tue Mar 29 14:25:23 2016 +0100

    Add documentation for BIO functions
    
    Add the documentation for new BIO functions added as a result of
    making BIO and BIO_METHOD opaque.
    
    Reviewed-by: Richard Levitte &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">levitte at openssl.org</A>&gt;

commit 173755255837d22c2bfbfe455164c67758224cb1
Author: Matt Caswell &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">matt at openssl.org</A>&gt;
Date:   Wed Mar 23 15:05:27 2016 +0000

    make update
    
    Reviewed-by: Richard Levitte &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">levitte at openssl.org</A>&gt;

commit a146ae55ba479a5c7aa2a6afba1b2b93102a152c
Author: Matt Caswell &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">matt at openssl.org</A>&gt;
Date:   Tue Mar 22 09:21:29 2016 +0000

    Make BIO opaque
    
    Move the the BIO_METHOD and BIO structures into internal header files,
    provide appropriate accessor methods and update all internal code to use
    the new accessors where appropriate.
    
    Reviewed-by: Richard Levitte &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">levitte at openssl.org</A>&gt;

commit f334461facc4078adbad6552563f77799c174cab
Author: Matt Caswell &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">matt at openssl.org</A>&gt;
Date:   Tue Mar 22 11:34:32 2016 +0000

    Add functions for creating BIO_METHODs
    
    BIO_METHODs are soon to be opaque so we need to have functions available
    to set them up.
    
    Reviewed-by: Richard Levitte &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">levitte at openssl.org</A>&gt;

commit 1a50b8139a6221d65bc526ab415c77b0561ff708
Author: FdaSilvaYY &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">fdasilvayy at gmail.com</A>&gt;
Date:   Sat Mar 19 00:40:11 2016 +0100

    Fix a big leak when using stack-allocated BIO items.
    
    Reviewed-by: Richard Levitte &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">levitte at openssl.org</A>&gt;
    Reviewed-by: Matt Caswell &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">matt at openssl.org</A>&gt;

-----------------------------------------------------------------------

Summary of changes:
 CHANGES                                            |   7 +-
 crypto/asn1/asn_mime.c                             |   1 +
 crypto/asn1/bio_asn1.c                             |  67 ++++++-----
 crypto/bio/Makefile.in                             |   4 +-
 crypto/bio/bf_buff.c                               |   2 +-
 crypto/bio/bf_nbio.c                               |   2 +-
 crypto/bio/bf_null.c                               |   2 +-
 crypto/bio/bio_cb.c                                |   2 +-
 crypto/bio/bio_lcl.h                               |  45 ++++++-
 crypto/bio/bio_lib.c                               |  42 ++++++-
 crypto/{engine/tb_digest.c =&gt; bio/bio_meth.c}      | 134 +++++++++++++--------
 crypto/bio/bss_bio.c                               |   2 +-
 crypto/bio/bss_log.c                               |   1 +
 crypto/bio/bss_mem.c                               |   2 +-
 crypto/bio/bss_null.c                              |   2 +-
 crypto/bio/bss_sock.c                              |   1 +
 crypto/bio/build.info                              |   2 +-
 crypto/err/err_prn.c                               |  29 ++---
 crypto/evp/bio_b64.c                               |  85 ++++++++-----
 crypto/evp/bio_enc.c                               | 100 +++++++++------
 crypto/evp/bio_md.c                                | 100 +++++++--------
 crypto/evp/bio_ok.c                                |  97 +++++++++------
 doc/crypto/BIO_get_data.pod                        |  56 +++++++++
 doc/crypto/BIO_meth_new.pod                        | 117 ++++++++++++++++++
 doc/crypto/BIO_push.pod                            |  19 ++-
 doc/crypto/BIO_should_retry.pod                    |  20 ++-
 .../internal/async.h =&gt; include/internal/bio.h     |  21 +++-
 include/openssl/bio.h                              |  94 ++++++---------
 ssl/bio_ssl.c                                      | 120 +++++++++---------
 ssl/ssl_lib.c                                      |   4 +-
 util/libcrypto.num                                 |  26 ++++
 31 files changed, 807 insertions(+), 399 deletions(-)
 copy crypto/{engine/tb_digest.c =&gt; bio/bio_meth.c} (53%)
 create mode 100644 doc/crypto/BIO_get_data.pod
 create mode 100644 doc/crypto/BIO_meth_new.pod
 copy crypto/include/internal/async.h =&gt; include/internal/bio.h (86%)

diff --git a/CHANGES b/CHANGES
index cdc8518..8597b8a 100644
--- a/CHANGES
+++ b/CHANGES
@@ -4,8 +4,13 @@
 
  Changes between 1.0.2g and 1.1.0  [xx XXX xxxx]
 
+  *) Made BIO and BIO_METHOD opaque. The structures for managing BIOs have been
+     moved out of the public header files. New functions for managing these
+     have been added.
+     [Matt Caswell]
+
   *) Removed no-rijndael as a config option. Rijndael is an old name for AES.
-     [Matt Caswell}
+     [Matt Caswell]
 
   *) Removed the mk1mf build scripts.
      [Richard Levitte]
diff --git a/crypto/asn1/asn_mime.c b/crypto/asn1/asn_mime.c
index 6ac9b2c..851fb91 100644
--- a/crypto/asn1/asn_mime.c
+++ b/crypto/asn1/asn_mime.c
@@ -60,6 +60,7 @@
 #include &lt;openssl/asn1.h&gt;
 #include &lt;openssl/asn1t.h&gt;
 #include &quot;internal/evp_int.h&quot;
+#include &quot;internal/bio.h&quot;
 #include &quot;asn1_locl.h&quot;
 
 /*
diff --git a/crypto/asn1/bio_asn1.c b/crypto/asn1/bio_asn1.c
index 80206aa..1657ac7 100644
--- a/crypto/asn1/bio_asn1.c
+++ b/crypto/asn1/bio_asn1.c
@@ -63,7 +63,7 @@
  */
 
 #include &lt;string.h&gt;
-#include &lt;openssl/bio.h&gt;
+#include &lt;internal/bio.h&gt;
 #include &lt;openssl/asn1.h&gt;
 
 /* Must be large enough for biggest tag+length */
@@ -152,9 +152,9 @@ static int asn1_bio_new(BIO *b)
         OPENSSL_free(ctx);
         return 0;
     }
-    b-&gt;init = 1;
-    b-&gt;ptr = (char *)ctx;
-    b-&gt;flags = 0;
+    BIO_set_data(b, ctx);
+    BIO_set_init(b, 1);
+
     return 1;
 }
 
@@ -178,15 +178,20 @@ static int asn1_bio_init(BIO_ASN1_BUF_CTX *ctx, int size)
 
 static int asn1_bio_free(BIO *b)
 {
-    BIO_ASN1_BUF_CTX *ctx = (BIO_ASN1_BUF_CTX *)b-&gt;ptr;
+    BIO_ASN1_BUF_CTX *ctx;
+
+    if (b == NULL)
+        return 0;
 
+    ctx = BIO_get_data(b);
     if (ctx == NULL)
         return 0;
+
     OPENSSL_free(ctx-&gt;buf);
     OPENSSL_free(ctx);
-    b-&gt;init = 0;
-    b-&gt;ptr = NULL;
-    b-&gt;flags = 0;
+    BIO_set_data(b, NULL);
+    BIO_set_init(b, 0);
+
     return 1;
 }
 
@@ -195,10 +200,11 @@ static int asn1_bio_write(BIO *b, const char *in, int inl)
     BIO_ASN1_BUF_CTX *ctx;
     int wrmax, wrlen, ret;
     unsigned char *p;
-    if (!in || (inl &lt; 0) || (b-&gt;next_bio == NULL))
-        return 0;
-    ctx = (BIO_ASN1_BUF_CTX *)b-&gt;ptr;
-    if (ctx == NULL)
+    BIO *next;
+
+    ctx = BIO_get_data(b);
+    next = BIO_next(b);
+    if (in == NULL || inl &lt; 0 || ctx == NULL || next == NULL)
         return 0;
 
     wrlen = 0;
@@ -236,7 +242,7 @@ static int asn1_bio_write(BIO *b, const char *in, int inl)
             break;
 
         case ASN1_STATE_HEADER_COPY:
-            ret = BIO_write(b-&gt;next_bio, ctx-&gt;buf + ctx-&gt;bufpos, ctx-&gt;buflen);
+            ret = BIO_write(next, ctx-&gt;buf + ctx-&gt;bufpos, ctx-&gt;buflen);
             if (ret &lt;= 0)
                 goto done;
 
@@ -256,7 +262,7 @@ static int asn1_bio_write(BIO *b, const char *in, int inl)
                 wrmax = ctx-&gt;copylen;
             else
                 wrmax = inl;
-            ret = BIO_write(b-&gt;next_bio, in, wrmax);
+            ret = BIO_write(next, in, wrmax);
             if (ret &lt;= 0)
                 break;
             wrlen += ret;
@@ -292,10 +298,11 @@ static int asn1_bio_flush_ex(BIO *b, BIO_ASN1_BUF_CTX *ctx,
                              asn1_ps_func *cleanup, asn1_bio_state_t next)
 {
     int ret;
+
     if (ctx-&gt;ex_len &lt;= 0)
         return 1;
     for (;;) {
-        ret = BIO_write(b-&gt;next_bio, ctx-&gt;ex_buf + ctx-&gt;ex_pos, ctx-&gt;ex_len);
+        ret = BIO_write(BIO_next(b), ctx-&gt;ex_buf + ctx-&gt;ex_pos, ctx-&gt;ex_len);
         if (ret &lt;= 0)
             break;
         ctx-&gt;ex_len -= ret;
@@ -330,9 +337,10 @@ static int asn1_bio_setup_ex(BIO *b, BIO_ASN1_BUF_CTX *ctx,
 
 static int asn1_bio_read(BIO *b, char *in, int inl)
 {
-    if (!b-&gt;next_bio)
+    BIO *next = BIO_next(b);
+    if (next == NULL)
         return 0;
-    return BIO_read(b-&gt;next_bio, in, inl);
+    return BIO_read(next, in, inl);
 }
 
 static int asn1_bio_puts(BIO *b, const char *str)
@@ -342,16 +350,18 @@ static int asn1_bio_puts(BIO *b, const char *str)
 
 static int asn1_bio_gets(BIO *b, char *str, int size)
 {
-    if (!b-&gt;next_bio)
+    BIO *next = BIO_next(b);
+    if (next == NULL)
         return 0;
-    return BIO_gets(b-&gt;next_bio, str, size);
+    return BIO_gets(next, str, size);
 }
 
 static long asn1_bio_callback_ctrl(BIO *b, int cmd, bio_info_cb *fp)
 {
-    if (b-&gt;next_bio == NULL)
-        return (0);
-    return BIO_callback_ctrl(b-&gt;next_bio, cmd, fp);
+    BIO *next = BIO_next(b);
+    if (next == NULL)
+        return 0;
+    return BIO_callback_ctrl(next, cmd, fp);
 }
 
 static long asn1_bio_ctrl(BIO *b, int cmd, long arg1, void *arg2)
@@ -359,9 +369,12 @@ static long asn1_bio_ctrl(BIO *b, int cmd, long arg1, void *arg2)
     BIO_ASN1_BUF_CTX *ctx;
     BIO_ASN1_EX_FUNCS *ex_func;
     long ret = 1;
-    ctx = (BIO_ASN1_BUF_CTX *)b-&gt;ptr;
+    BIO *next;
+
+    ctx = BIO_get_data(b);
     if (ctx == NULL)
         return 0;
+    next = BIO_next(b);
     switch (cmd) {
 
     case BIO_C_SET_PREFIX:
@@ -397,7 +410,7 @@ static long asn1_bio_ctrl(BIO *b, int cmd, long arg1, void *arg2)
         break;
 
     case BIO_CTRL_FLUSH:
-        if (!b-&gt;next_bio)
+        if (next == NULL)
             return 0;
 
         /* Call post function if possible */
@@ -415,16 +428,16 @@ static long asn1_bio_ctrl(BIO *b, int cmd, long arg1, void *arg2)
         }
 
         if (ctx-&gt;state == ASN1_STATE_DONE)
-            return BIO_ctrl(b-&gt;next_bio, cmd, arg1, arg2);
+            return BIO_ctrl(next, cmd, arg1, arg2);
         else {
             BIO_clear_retry_flags(b);
             return 0;
         }
 
     default:
-        if (!b-&gt;next_bio)
+        if (next == NULL)
             return 0;
-        return BIO_ctrl(b-&gt;next_bio, cmd, arg1, arg2);
+        return BIO_ctrl(next, cmd, arg1, arg2);
 
     }
 
diff --git a/crypto/bio/Makefile.in b/crypto/bio/Makefile.in
index 12cf6c6..f57d357 100644
--- a/crypto/bio/Makefile.in
+++ b/crypto/bio/Makefile.in
@@ -20,14 +20,14 @@ LIBSRC= bio_lib.c bio_cb.c bio_err.c \
 	bss_file.c bss_sock.c bss_conn.c \
 	bf_null.c bf_buff.c b_print.c b_dump.c b_addr.c \
 	b_sock.c b_sock2.c bss_acpt.c bf_nbio.c bss_log.c bss_bio.c \
-	bss_dgram.c
+	bss_dgram.c bio_meth.c
 #	bf_lbuf.c
 LIBOBJ= bio_lib.o bio_cb.o bio_err.o \
 	bss_mem.o bss_null.o bss_fd.o \
 	bss_file.o bss_sock.o bss_conn.o \
 	bf_null.o bf_buff.o b_print.o b_dump.o b_addr.o \
 	b_sock.o b_sock2.o bss_acpt.o bf_nbio.o bss_log.o bss_bio.o \
-	bss_dgram.o
+	bss_dgram.o bio_meth.o
 #	bf_lbuf.o
 
 SRC= $(LIBSRC)
diff --git a/crypto/bio/bf_buff.c b/crypto/bio/bf_buff.c
index 6040c85..361d26a 100644
--- a/crypto/bio/bf_buff.c
+++ b/crypto/bio/bf_buff.c
@@ -57,8 +57,8 @@
 
 #include &lt;stdio.h&gt;
 #include &lt;errno.h&gt;
+#include &quot;bio_lcl.h&quot;
 #include &quot;internal/cryptlib.h&quot;
-#include &lt;openssl/bio.h&gt;
 
 static int buffer_write(BIO *h, const char *buf, int num);
 static int buffer_read(BIO *h, char *buf, int size);
diff --git a/crypto/bio/bf_nbio.c b/crypto/bio/bf_nbio.c
index c8bf580..cefd35f 100644
--- a/crypto/bio/bf_nbio.c
+++ b/crypto/bio/bf_nbio.c
@@ -57,9 +57,9 @@
 
 #include &lt;stdio.h&gt;
 #include &lt;errno.h&gt;
+#include &quot;bio_lcl.h&quot;
 #include &quot;internal/cryptlib.h&quot;
 #include &lt;openssl/rand.h&gt;
-#include &lt;openssl/bio.h&gt;
 
 /*
  * BIO_put and BIO_get both add to the digest, BIO_gets returns the digest
diff --git a/crypto/bio/bf_null.c b/crypto/bio/bf_null.c
index e3b87d2..162e250 100644
--- a/crypto/bio/bf_null.c
+++ b/crypto/bio/bf_null.c
@@ -57,8 +57,8 @@
 
 #include &lt;stdio.h&gt;
 #include &lt;errno.h&gt;
+#include &quot;bio_lcl.h&quot;
 #include &quot;internal/cryptlib.h&quot;
-#include &lt;openssl/bio.h&gt;
 
 /*
  * BIO_put and BIO_get both add to the digest, BIO_gets returns the digest
diff --git a/crypto/bio/bio_cb.c b/crypto/bio/bio_cb.c
index ec484b6..552b66e 100644
--- a/crypto/bio/bio_cb.c
+++ b/crypto/bio/bio_cb.c
@@ -58,8 +58,8 @@
 #include &lt;stdio.h&gt;
 #include &lt;string.h&gt;
 #include &lt;stdlib.h&gt;
+#include &quot;bio_lcl.h&quot;
 #include &quot;internal/cryptlib.h&quot;
-#include &lt;openssl/bio.h&gt;
 #include &lt;openssl/err.h&gt;
 
 long BIO_debug_callback(BIO *bio, int cmd, const char *argp,
diff --git a/crypto/bio/bio_lcl.h b/crypto/bio/bio_lcl.h
index 24f8b18..1e409f8 100644
--- a/crypto/bio/bio_lcl.h
+++ b/crypto/bio/bio_lcl.h
@@ -65,7 +65,50 @@ union bio_addr_st {
 /* END BIO_ADDRINFO/BIO_ADDR stuff. */
 
 #include &quot;internal/cryptlib.h&quot;
-#include &lt;openssl/bio.h&gt;
+#include &lt;internal/bio.h&gt;
+
+typedef struct bio_f_buffer_ctx_struct {
+    /*-
+     * Buffers are setup like this:
+     *
+     * &lt;---------------------- size -----------------------&gt;
+     * +---------------------------------------------------+
+     * | consumed | remaining          | free space        |
+     * +---------------------------------------------------+
+     * &lt;-- off --&gt;&lt;------- len -------&gt;
+     */
+    /*- BIO *bio; *//*
+     * this is now in the BIO struct
+     */
+    int ibuf_size;              /* how big is the input buffer */
+    int obuf_size;              /* how big is the output buffer */
+    char *ibuf;                 /* the char array */
+    int ibuf_len;               /* how many bytes are in it */
+    int ibuf_off;               /* write/read offset */
+    char *obuf;                 /* the char array */
+    int obuf_len;               /* how many bytes are in it */
+    int obuf_off;               /* write/read offset */
+} BIO_F_BUFFER_CTX;
+
+struct bio_st {
+    const BIO_METHOD *method;
+    /* bio, mode, argp, argi, argl, ret */
+    long (*callback) (struct bio_st *, int, const char *, int, long, long);
+    char *cb_arg;               /* first argument for the callback */
+    int init;
+    int shutdown;
+    int flags;                  /* extra storage */
+    int retry_reason;
+    int num;
+    void *ptr;
+    struct bio_st *next_bio;    /* used by filter BIOs */
+    struct bio_st *prev_bio;    /* used by filter BIOs */
+    int references;
+    uint64_t num_read;
+    uint64_t num_write;
+    CRYPTO_EX_DATA ex_data;
+    CRYPTO_RWLOCK *lock;
+};
 
 #ifndef OPENSSL_NO_SOCK
 # ifdef OPENSSL_SYS_VMS
diff --git a/crypto/bio/bio_lib.c b/crypto/bio/bio_lib.c
index 9357553..ac98cf2 100644
--- a/crypto/bio/bio_lib.c
+++ b/crypto/bio/bio_lib.c
@@ -58,8 +58,8 @@
 #include &lt;stdio.h&gt;
 #include &lt;errno.h&gt;
 #include &lt;openssl/crypto.h&gt;
+#include &quot;bio_lcl.h&quot;
 #include &quot;internal/cryptlib.h&quot;
-#include &lt;openssl/bio.h&gt;
 #include &lt;openssl/stack.h&gt;
 
 BIO *BIO_new(const BIO_METHOD *method)
@@ -142,6 +142,36 @@ int BIO_free(BIO *a)
     return 1;
 }
 
+void BIO_set_data(BIO *a, void *ptr)
+{
+    a-&gt;ptr = ptr;
+}
+
+void *BIO_get_data(BIO *a)
+{
+    return a-&gt;ptr;
+}
+
+void BIO_set_init(BIO *a, int init)
+{
+    a-&gt;init = init;
+}
+
+int BIO_get_init(BIO *a)
+{
+    return a-&gt;init;
+}
+
+void BIO_set_shutdown(BIO *a, int shut)
+{
+    a-&gt;shutdown = shut;
+}
+
+int BIO_get_shutdown(BIO *a)
+{
+    return a-&gt;shutdown;
+}
+
 void BIO_vfree(BIO *a)
 {
     BIO_free(a);
@@ -487,6 +517,11 @@ int BIO_get_retry_reason(BIO *bio)
     return (bio-&gt;retry_reason);
 }
 
+void BIO_set_retry_reason(BIO *bio, int reason)
+{
+    bio-&gt;retry_reason = reason;
+}
+
 BIO *BIO_find_type(BIO *bio, int type)
 {
     int mt, mask;
@@ -516,6 +551,11 @@ BIO *BIO_next(BIO *b)
     return b-&gt;next_bio;
 }
 
+void BIO_set_next(BIO *b, BIO *next)
+{
+    b-&gt;next_bio = next;
+}
+
 void BIO_free_all(BIO *bio)
 {
     BIO *b;
diff --git a/crypto/engine/tb_digest.c b/crypto/bio/bio_meth.c
similarity index 53%
copy from crypto/engine/tb_digest.c
copy to crypto/bio/bio_meth.c
index 03096b3..134c448 100644
--- a/crypto/engine/tb_digest.c
+++ b/crypto/bio/bio_meth.c
@@ -1,5 +1,5 @@
 /* ====================================================================
- * Copyright (c) 2000 The OpenSSL Project.  All rights reserved.
+ * Copyright (c) 2016 The OpenSSL Project.  All rights reserved.
  *
  * Redistribution and use in source and binary forms, with or without
  * modification, are permitted provided that the following conditions
@@ -21,7 +21,7 @@
  * 4. The names &quot;OpenSSL Toolkit&quot; and &quot;OpenSSL Project&quot; must not be used to
  *    endorse or promote products derived from this software without
  *    prior written permission. For written permission, please contact
- *    <A HREF="../../../mailman/listinfo/openssl-commits.html">licensing at OpenSSL.org.</A>
+ *    <A HREF="../../../mailman/listinfo/openssl-commits.html">openssl-core at OpenSSL.org.</A>
  *
  * 5. Products derived from this software may not be called &quot;OpenSSL&quot;
  *    nor may &quot;OpenSSL&quot; appear in their names without prior written
@@ -52,85 +52,115 @@
  *
  */
 
-#include &quot;eng_int.h&quot;
+#include &quot;bio_lcl.h&quot;
 
-static ENGINE_TABLE *digest_table = NULL;
+BIO_METHOD *BIO_meth_new(int type, const char *name)
+{
+    BIO_METHOD *biom = OPENSSL_zalloc(sizeof(BIO_METHOD));
 
-void ENGINE_unregister_digests(ENGINE *e)
+    if (biom != NULL) {
+        biom-&gt;type = type;
+        biom-&gt;name = name;
+    }
+    return biom;
+}
+
+void BIO_meth_free(BIO_METHOD *biom)
 {
-    engine_table_unregister(&amp;digest_table, e);
+    OPENSSL_free(biom);
 }
 
-static void engine_unregister_all_digests(void)
+int (*BIO_meth_get_write(BIO_METHOD *biom)) (BIO *, const char *, int)
 {
-    engine_table_cleanup(&amp;digest_table);
+    return biom-&gt;bwrite;
 }
 
-int ENGINE_register_digests(ENGINE *e)
+int BIO_meth_set_write(BIO_METHOD *biom,
+                       int (*write) (BIO *, const char *, int))
 {
-    if (e-&gt;digests) {
-        const int *nids;
-        int num_nids = e-&gt;digests(e, NULL, &amp;nids, 0);
-        if (num_nids &gt; 0)
-            return engine_table_register(&amp;digest_table,
-                                         engine_unregister_all_digests, e,
-                                         nids, num_nids, 0);
-    }
+    biom-&gt;bwrite = write;
     return 1;
 }
 
-void ENGINE_register_all_digests()
+int (*BIO_meth_get_read(BIO_METHOD *biom)) (BIO *, char *, int)
 {
-    ENGINE *e;
+    return biom-&gt;bread;
+}
 
-    for (e = ENGINE_get_first(); e; e = ENGINE_get_next(e))
-        ENGINE_register_digests(e);
+int BIO_meth_set_read(BIO_METHOD *biom,
+                      int (*read) (BIO *, char *, int))
+{
+    biom-&gt;bread = read;
+    return 1;
 }
 
-int ENGINE_set_default_digests(ENGINE *e)
+int (*BIO_meth_get_puts(BIO_METHOD *biom)) (BIO *, const char *)
 {
-    if (e-&gt;digests) {
-        const int *nids;
-        int num_nids = e-&gt;digests(e, NULL, &amp;nids, 0);
-        if (num_nids &gt; 0)
-            return engine_table_register(&amp;digest_table,
-                                         engine_unregister_all_digests, e,
-                                         nids, num_nids, 1);
-    }
+    return biom-&gt;bputs;
+}
+
+int BIO_meth_set_puts(BIO_METHOD *biom,
+                      int (*puts) (BIO *, const char *))
+{
+    biom-&gt;bputs = puts;
     return 1;
 }
 
-/*
- * Exposed API function to get a functional reference from the implementation
- * table (ie. try to get a functional reference from the tabled structural
- * references) for a given digest 'nid'
- */
-ENGINE *ENGINE_get_digest_engine(int nid)
+int (*BIO_meth_get_gets(BIO_METHOD *biom)) (BIO *, char *, int)
 {
-    return engine_table_select(&amp;digest_table, nid);
+    return biom-&gt;bgets;
 }
 
-/* Obtains a digest implementation from an ENGINE functional reference */
-const EVP_MD *ENGINE_get_digest(ENGINE *e, int nid)
+int BIO_meth_set_gets(BIO_METHOD *biom,
+                      int (*gets) (BIO *, char *, int))
 {
-    const EVP_MD *ret;
-    ENGINE_DIGESTS_PTR fn = ENGINE_get_digests(e);
-    if (!fn || !fn(e, &amp;ret, NULL, nid)) {
-        ENGINEerr(ENGINE_F_ENGINE_GET_DIGEST, ENGINE_R_UNIMPLEMENTED_DIGEST);
-        return NULL;
-    }
-    return ret;
+    biom-&gt;bgets = gets;
+    return 1;
+}
+
+long (*BIO_meth_get_ctrl(BIO_METHOD *biom)) (BIO *, int, long, void *)
+{
+    return biom-&gt;ctrl;
+}
+
+int BIO_meth_set_ctrl(BIO_METHOD *biom,
+                      long (*ctrl) (BIO *, int, long, void *))
+{
+    biom-&gt;ctrl = ctrl;
+    return 1;
+}
+
+int (*BIO_meth_get_create(BIO_METHOD *biom)) (BIO *)
+{
+    return biom-&gt;create;
+}
+
+int BIO_meth_set_create(BIO_METHOD *biom, int (*create) (BIO *))
+{
+    biom-&gt;create = create;
+    return 1;
+}
+
+int (*BIO_meth_get_destroy(BIO_METHOD *biom)) (BIO *)
+{
+    return biom-&gt;destroy;
+}
+
+int BIO_meth_set_destroy(BIO_METHOD *biom, int (*destroy) (BIO *))
+{
+    biom-&gt;destroy = destroy;
+    return 1;
 }
 
-/* Gets the digest callback from an ENGINE structure */
-ENGINE_DIGESTS_PTR ENGINE_get_digests(const ENGINE *e)
+long (*BIO_meth_get_callback_ctrl(BIO_METHOD *biom)) (BIO *, int, bio_info_cb *)
 {
-    return e-&gt;digests;
+    return biom-&gt;callback_ctrl;
 }
 
-/* Sets the digest callback in an ENGINE structure */
-int ENGINE_set_digests(ENGINE *e, ENGINE_DIGESTS_PTR f)
+int BIO_meth_set_callback_ctrl(BIO_METHOD *biom,
+                               long (*callback_ctrl) (BIO *, int,
+                                                      bio_info_cb *))
 {
-    e-&gt;digests = f;
+    biom-&gt;callback_ctrl = callback_ctrl;
     return 1;
 }
diff --git a/crypto/bio/bss_bio.c b/crypto/bio/bss_bio.c
index 518fa35..2991c3a 100644
--- a/crypto/bio/bss_bio.c
+++ b/crypto/bio/bss_bio.c
@@ -65,7 +65,7 @@
 #include &lt;stdlib.h&gt;
 #include &lt;string.h&gt;
 
-#include &lt;openssl/bio.h&gt;
+#include &quot;bio_lcl.h&quot;
 #include &lt;openssl/err.h&gt;
 #include &lt;openssl/crypto.h&gt;
 
diff --git a/crypto/bio/bss_log.c b/crypto/bio/bss_log.c
index a6bc0e7..c2c8c79 100644
--- a/crypto/bio/bss_log.c
+++ b/crypto/bio/bss_log.c
@@ -64,6 +64,7 @@
 #include &lt;stdio.h&gt;
 #include &lt;errno.h&gt;
 
+#include &quot;bio_lcl.h&quot;
 #include &quot;internal/cryptlib.h&quot;
 
 #if defined(OPENSSL_SYS_WINCE)
diff --git a/crypto/bio/bss_mem.c b/crypto/bio/bss_mem.c
index 68ac90d..460e070 100644
--- a/crypto/bio/bss_mem.c
+++ b/crypto/bio/bss_mem.c
@@ -57,8 +57,8 @@
 
 #include &lt;stdio.h&gt;
 #include &lt;errno.h&gt;
+#include &quot;bio_lcl.h&quot;
 #include &quot;internal/cryptlib.h&quot;
-#include &lt;openssl/bio.h&gt;
 
 static int mem_write(BIO *h, const char *buf, int num);
 static int mem_read(BIO *h, char *buf, int size);
diff --git a/crypto/bio/bss_null.c b/crypto/bio/bss_null.c
index c5e2484..29561c7 100644
--- a/crypto/bio/bss_null.c
+++ b/crypto/bio/bss_null.c
@@ -57,8 +57,8 @@
 
 #include &lt;stdio.h&gt;
 #include &lt;errno.h&gt;
+#include &quot;bio_lcl.h&quot;
 #include &quot;internal/cryptlib.h&quot;
-#include &lt;openssl/bio.h&gt;
 
 static int null_write(BIO *h, const char *buf, int num);
 static int null_read(BIO *h, char *buf, int size);
diff --git a/crypto/bio/bss_sock.c b/crypto/bio/bss_sock.c
index 85d7d66..c1f76a2 100644
--- a/crypto/bio/bss_sock.c
+++ b/crypto/bio/bss_sock.c
@@ -58,6 +58,7 @@
 #include &lt;stdio.h&gt;
 #include &lt;errno.h&gt;
 #define USE_SOCKETS
+#include &quot;bio_lcl.h&quot;
 #include &quot;internal/cryptlib.h&quot;
 
 #ifndef OPENSSL_NO_SOCK
diff --git a/crypto/bio/build.info b/crypto/bio/build.info
index d976c6c..f462c50 100644
--- a/crypto/bio/build.info
+++ b/crypto/bio/build.info
@@ -5,5 +5,5 @@ SOURCE[../../libcrypto]=\
         bss_file.c bss_sock.c bss_conn.c \
         bf_null.c bf_buff.c b_print.c b_dump.c b_addr.c \
         b_sock.c b_sock2.c bss_acpt.c bf_nbio.c bss_log.c bss_bio.c \
-        bss_dgram.c \
+        bss_dgram.c bio_meth.c \
         {- $config{target} =~ /^VMS/i ? &quot;bf_lbuf.c&quot; : &quot;&quot; -}
diff --git a/crypto/err/err_prn.c b/crypto/err/err_prn.c
index ac6b81f..0f7d40c 100644
--- a/crypto/err/err_prn.c
+++ b/crypto/err/err_prn.c
@@ -92,23 +92,6 @@ void ERR_print_errors_cb(int (*cb) (const char *str, size_t len, void *u),
     }
 }
 
-#ifndef OPENSSL_NO_STDIO
-static int print_fp(const char *str, size_t len, void *fp)
-{
-    BIO bio;
-
-    BIO_set(&amp;bio, BIO_s_file());
-    BIO_set_fp(&amp;bio, fp, BIO_NOCLOSE);
-
-    return BIO_printf(&amp;bio, &quot;%s&quot;, str);
-}
-
-void ERR_print_errors_fp(FILE *fp)
-{
-    ERR_print_errors_cb(print_fp, fp);
-}
-#endif
-
 static int print_bio(const char *str, size_t len, void *bp)
 {
     return BIO_write((BIO *)bp, str, len);
@@ -118,3 +101,15 @@ void ERR_print_errors(BIO *bp)
 {
     ERR_print_errors_cb(print_bio, bp);
 }
+
+#ifndef OPENSSL_NO_STDIO
+void ERR_print_errors_fp(FILE *fp)
+{
+    BIO *bio = BIO_new_fp(fp, BIO_NOCLOSE);
+    if (bio == NULL)
+        return;
+
+    ERR_print_errors_cb(print_bio, bio);
+    BIO_free(bio);
+}
+#endif
diff --git a/crypto/evp/bio_b64.c b/crypto/evp/bio_b64.c
index 93e4166..cdb50b4 100644
--- a/crypto/evp/bio_b64.c
+++ b/crypto/evp/bio_b64.c
@@ -60,6 +60,7 @@
 #include &quot;internal/cryptlib.h&quot;
 #include &lt;openssl/buffer.h&gt;
 #include &lt;openssl/evp.h&gt;
+#include &quot;internal/bio.h&quot;
 
 static int b64_write(BIO *h, const char *buf, int num);
 static int b64_read(BIO *h, char *buf, int size);
@@ -105,9 +106,10 @@ static const BIO_METHOD methods_b64 = {
     b64_callback_ctrl,
 };
 
+
 const BIO_METHOD *BIO_f_base64(void)
 {
-    return (&amp;methods_b64);
+    return &amp;methods_b64;
 }
 
 static int b64_new(BIO *bi)
@@ -121,23 +123,28 @@ static int b64_new(BIO *bi)
     ctx-&gt;cont = 1;
     ctx-&gt;start = 1;
     ctx-&gt;base64 = EVP_ENCODE_CTX_new();
-    bi-&gt;init = 1;
-    bi-&gt;ptr = (char *)ctx;
-    bi-&gt;flags = 0;
-    bi-&gt;num = 0;
-    return (1);
+    BIO_set_data(bi, ctx);
+    BIO_set_init(bi, 1);
+
+    return 1;
 }
 
 static int b64_free(BIO *a)
 {
+    BIO_B64_CTX *ctx;
     if (a == NULL)
-        return (0);
-    EVP_ENCODE_CTX_free(((BIO_B64_CTX *)a-&gt;ptr)-&gt;base64);
-    OPENSSL_free(a-&gt;ptr);
-    a-&gt;ptr = NULL;
-    a-&gt;init = 0;
-    a-&gt;flags = 0;
-    return (1);
+        return 0;
+
+    ctx = BIO_get_data(a);
+    if (ctx == NULL)
+        return 0;
+
+    EVP_ENCODE_CTX_free(ctx-&gt;base64);
+    OPENSSL_free(ctx);
+    BIO_set_data(a, NULL);
+    BIO_set_init(a, 0);
+
+    return 1;
 }
 
 static int b64_read(BIO *b, char *out, int outl)
@@ -145,13 +152,15 @@ static int b64_read(BIO *b, char *out, int outl)
     int ret = 0, i, ii, j, k, x, n, num, ret_code = 0;
     BIO_B64_CTX *ctx;
     unsigned char *p, *q;
+    BIO *next;
 
     if (out == NULL)
         return (0);
-    ctx = (BIO_B64_CTX *)b-&gt;ptr;
+    ctx = (BIO_B64_CTX *)BIO_get_data(b);
 
-    if ((ctx == NULL) || (b-&gt;next_bio == NULL))
-        return (0);
+    next = BIO_next(b);
+    if ((ctx == NULL) || (next == NULL))
+        return 0;
 
     BIO_clear_retry_flags(b);
 
@@ -191,14 +200,14 @@ static int b64_read(BIO *b, char *out, int outl)
         if (ctx-&gt;cont &lt;= 0)
             break;
 
-        i = BIO_read(b-&gt;next_bio, &amp;(ctx-&gt;tmp[ctx-&gt;tmp_len]),
+        i = BIO_read(next, &amp;(ctx-&gt;tmp[ctx-&gt;tmp_len]),
                      B64_BLOCK_SIZE - ctx-&gt;tmp_len);
 
         if (i &lt;= 0) {
             ret_code = i;
 
             /* Should we continue next time we are called? */
-            if (!BIO_should_retry(b-&gt;next_bio)) {
+            if (!BIO_should_retry(next)) {
                 ctx-&gt;cont = i;
                 /* If buffer empty break */
                 if (ctx-&gt;tmp_len == 0)
@@ -354,8 +363,13 @@ static int b64_write(BIO *b, const char *in, int inl)
     int n;
     int i;
     BIO_B64_CTX *ctx;
+    BIO *next;
+
+    ctx = (BIO_B64_CTX *)BIO_get_data(b);
+    next = BIO_next(b);
+    if ((ctx == NULL) || (next == NULL))
+        return 0;
 
-    ctx = (BIO_B64_CTX *)b-&gt;ptr;
     BIO_clear_retry_flags(b);
 
     if (ctx-&gt;encode != B64_ENCODE) {
@@ -371,7 +385,7 @@ static int b64_write(BIO *b, const char *in, int inl)
     OPENSSL_assert(ctx-&gt;buf_len &gt;= ctx-&gt;buf_off);
     n = ctx-&gt;buf_len - ctx-&gt;buf_off;
     while (n &gt; 0) {
-        i = BIO_write(b-&gt;next_bio, &amp;(ctx-&gt;buf[ctx-&gt;buf_off]), n);
+        i = BIO_write(next, &amp;(ctx-&gt;buf[ctx-&gt;buf_off]), n);
         if (i &lt;= 0) {
             BIO_copy_next_retry(b);
             return (i);
@@ -445,7 +459,7 @@ static int b64_write(BIO *b, const char *in, int inl)
         ctx-&gt;buf_off = 0;
         n = ctx-&gt;buf_len;
         while (n &gt; 0) {
-            i = BIO_write(b-&gt;next_bio, &amp;(ctx-&gt;buf[ctx-&gt;buf_off]), n);
+            i = BIO_write(next, &amp;(ctx-&gt;buf[ctx-&gt;buf_off]), n);
             if (i &lt;= 0) {
                 BIO_copy_next_retry(b);
                 return ((ret == 0) ? i : ret);
@@ -467,21 +481,25 @@ static long b64_ctrl(BIO *b, int cmd, long num, void *ptr)
     BIO_B64_CTX *ctx;
     long ret = 1;
     int i;
+    BIO *next;
 
-    ctx = (BIO_B64_CTX *)b-&gt;ptr;
+    ctx = (BIO_B64_CTX *)BIO_get_data(b);
+    next = BIO_next(b);
+    if ((ctx == NULL) || (next == NULL))
+        return 0;
 
     switch (cmd) {
     case BIO_CTRL_RESET:
         ctx-&gt;cont = 1;
         ctx-&gt;start = 1;
         ctx-&gt;encode = B64_NONE;
-        ret = BIO_ctrl(b-&gt;next_bio, cmd, num, ptr);
+        ret = BIO_ctrl(next, cmd, num, ptr);
         break;
     case BIO_CTRL_EOF:         /* More to read */
         if (ctx-&gt;cont &lt;= 0)
             ret = 1;
         else
-            ret = BIO_ctrl(b-&gt;next_bio, cmd, num, ptr);
+            ret = BIO_ctrl(next, cmd, num, ptr);
         break;
     case BIO_CTRL_WPENDING:    /* More to write in buffer */
         OPENSSL_assert(ctx-&gt;buf_len &gt;= ctx-&gt;buf_off);
@@ -490,13 +508,13 @@ static long b64_ctrl(BIO *b, int cmd, long num, void *ptr)
             &amp;&amp; (EVP_ENCODE_CTX_num(ctx-&gt;base64) != 0))
             ret = 1;
         else if (ret &lt;= 0)
-            ret = BIO_ctrl(b-&gt;next_bio, cmd, num, ptr);
+            ret = BIO_ctrl(next, cmd, num, ptr);
         break;
     case BIO_CTRL_PENDING:     /* More to read in buffer */
         OPENSSL_assert(ctx-&gt;buf_len &gt;= ctx-&gt;buf_off);
         ret = ctx-&gt;buf_len - ctx-&gt;buf_off;
         if (ret &lt;= 0)
-            ret = BIO_ctrl(b-&gt;next_bio, cmd, num, ptr);
+            ret = BIO_ctrl(next, cmd, num, ptr);
         break;
     case BIO_CTRL_FLUSH:
         /* do a final write */
@@ -524,12 +542,12 @@ static long b64_ctrl(BIO *b, int cmd, long num, void *ptr)
             goto again;
         }
         /* Finally flush the underlying BIO */
-        ret = BIO_ctrl(b-&gt;next_bio, cmd, num, ptr);
+        ret = BIO_ctrl(next, cmd, num, ptr);
         break;
 
     case BIO_C_DO_STATE_MACHINE:
         BIO_clear_retry_flags(b);
-        ret = BIO_ctrl(b-&gt;next_bio, cmd, num, ptr);
+        ret = BIO_ctrl(next, cmd, num, ptr);
         BIO_copy_next_retry(b);
         break;
 
@@ -539,21 +557,22 @@ static long b64_ctrl(BIO *b, int cmd, long num, void *ptr)
     case BIO_CTRL_GET:
     case BIO_CTRL_SET:
     default:
-        ret = BIO_ctrl(b-&gt;next_bio, cmd, num, ptr);
+        ret = BIO_ctrl(next, cmd, num, ptr);
         break;
     }
-    return (ret);
+    return ret;
 }
 
 static long b64_callback_ctrl(BIO *b, int cmd, bio_info_cb *fp)
 {
     long ret = 1;
+    BIO *next = BIO_next(b);
 
-    if (b-&gt;next_bio == NULL)
-        return (0);
+    if (next == NULL)
+        return 0;
     switch (cmd) {
     default:
-        ret = BIO_callback_ctrl(b-&gt;next_bio, cmd, fp);
+        ret = BIO_callback_ctrl(next, cmd, fp);
         break;
     }
     return (ret);
diff --git a/crypto/evp/bio_enc.c b/crypto/evp/bio_enc.c
index e89c1df..ad94ba4 100644
--- a/crypto/evp/bio_enc.c
+++ b/crypto/evp/bio_enc.c
@@ -60,6 +60,7 @@
 #include &quot;internal/cryptlib.h&quot;
 #include &lt;openssl/buffer.h&gt;
 #include &lt;openssl/evp.h&gt;
+#include &quot;internal/bio.h&quot;
 
 static int enc_write(BIO *h, const char *buf, int num);
 static int enc_read(BIO *h, char *buf, int size);
@@ -122,9 +123,9 @@ static int enc_new(BIO *bi)
     }
     ctx-&gt;cont = 1;
     ctx-&gt;ok = 1;
-    bi-&gt;init = 0;
-    bi-&gt;ptr = (char *)ctx;
-    bi-&gt;flags = 0;
+    BIO_set_data(bi, ctx);
+    BIO_set_init(bi, 1);
+
     return 1;
 }
 
@@ -133,27 +134,33 @@ static int enc_free(BIO *a)
     BIO_ENC_CTX *b;
 
     if (a == NULL)
-        return (0);
-    b = (BIO_ENC_CTX *)a-&gt;ptr;
+        return 0;
+
+    b = BIO_get_data(a);
+    if (b == NULL)
+        return 0;
+
     EVP_CIPHER_CTX_free(b-&gt;cipher);
-    OPENSSL_clear_free(a-&gt;ptr, sizeof(BIO_ENC_CTX));
-    a-&gt;ptr = NULL;
-    a-&gt;init = 0;
-    a-&gt;flags = 0;
-    return (1);
+    OPENSSL_clear_free(b, sizeof(BIO_ENC_CTX));
+    BIO_set_data(a, NULL);
+    BIO_set_init(a, 0);
+
+    return 1;
 }
 
 static int enc_read(BIO *b, char *out, int outl)
 {
     int ret = 0, i;
     BIO_ENC_CTX *ctx;
+    BIO *next;
 
     if (out == NULL)
         return (0);
-    ctx = (BIO_ENC_CTX *)b-&gt;ptr;
+    ctx = BIO_get_data(b);
 
-    if ((ctx == NULL) || (b-&gt;next_bio == NULL))
-        return (0);
+    next = BIO_next(b);
+    if ((ctx == NULL) || (next == NULL))
+        return 0;
 
     /* First check if there are bytes decoded/encoded */
     if (ctx-&gt;buf_len &gt; 0) {
@@ -183,11 +190,11 @@ static int enc_read(BIO *b, char *out, int outl)
         /*
          * read in at IV offset, read the EVP_Cipher documentation about why
          */
-        i = BIO_read(b-&gt;next_bio, &amp;(ctx-&gt;buf[BUF_OFFSET]), ENC_BLOCK_SIZE);
+        i = BIO_read(next, &amp;(ctx-&gt;buf[BUF_OFFSET]), ENC_BLOCK_SIZE);
 
         if (i &lt;= 0) {
             /* Should be continue next time we are called? */
-            if (!BIO_should_retry(b-&gt;next_bio)) {
+            if (!BIO_should_retry(next)) {
                 ctx-&gt;cont = i;
                 i = EVP_CipherFinal_ex(ctx-&gt;cipher,
                                        (unsigned char *)ctx-&gt;buf,
@@ -239,14 +246,19 @@ static int enc_write(BIO *b, const char *in, int inl)
 {
     int ret = 0, n, i;
     BIO_ENC_CTX *ctx;
+    BIO *next;
+
+    ctx = BIO_get_data(b);
+    next = BIO_next(b);
+    if ((ctx == NULL) || (next == NULL))
+        return 0;
 
-    ctx = (BIO_ENC_CTX *)b-&gt;ptr;
     ret = inl;
 
     BIO_clear_retry_flags(b);
     n = ctx-&gt;buf_len - ctx-&gt;buf_off;
     while (n &gt; 0) {
-        i = BIO_write(b-&gt;next_bio, &amp;(ctx-&gt;buf[ctx-&gt;buf_off]), n);
+        i = BIO_write(next, &amp;(ctx-&gt;buf[ctx-&gt;buf_off]), n);
         if (i &lt;= 0) {
             BIO_copy_next_retry(b);
             return (i);
@@ -274,7 +286,7 @@ static int enc_write(BIO *b, const char *in, int inl)
         ctx-&gt;buf_off = 0;
         n = ctx-&gt;buf_len;
         while (n &gt; 0) {
-            i = BIO_write(b-&gt;next_bio, &amp;(ctx-&gt;buf[ctx-&gt;buf_off]), n);
+            i = BIO_write(next, &amp;(ctx-&gt;buf[ctx-&gt;buf_off]), n);
             if (i &lt;= 0) {
                 BIO_copy_next_retry(b);
                 return (ret == inl) ? i : ret - inl;
@@ -296,8 +308,12 @@ static long enc_ctrl(BIO *b, int cmd, long num, void *ptr)
     long ret = 1;
     int i;
     EVP_CIPHER_CTX **c_ctx;
+    BIO *next;
 
-    ctx = (BIO_ENC_CTX *)b-&gt;ptr;
+    ctx = BIO_get_data(b);
+    next = BIO_next(b);
+    if (ctx == NULL)
+        return 0;
 
     switch (cmd) {
     case BIO_CTRL_RESET:
@@ -306,23 +322,23 @@ static long enc_ctrl(BIO *b, int cmd, long num, void *ptr)
         if (!EVP_CipherInit_ex(ctx-&gt;cipher, NULL, NULL, NULL, NULL,
                                EVP_CIPHER_CTX_encrypting(ctx-&gt;cipher)))
             return 0;
-        ret = BIO_ctrl(b-&gt;next_bio, cmd, num, ptr);
+        ret = BIO_ctrl(next, cmd, num, ptr);
         break;
     case BIO_CTRL_EOF:         /* More to read */
         if (ctx-&gt;cont &lt;= 0)
             ret = 1;
         else
-            ret = BIO_ctrl(b-&gt;next_bio, cmd, num, ptr);
+            ret = BIO_ctrl(next, cmd, num, ptr);
         break;
     case BIO_CTRL_WPENDING:
         ret = ctx-&gt;buf_len - ctx-&gt;buf_off;
         if (ret &lt;= 0)
-            ret = BIO_ctrl(b-&gt;next_bio, cmd, num, ptr);
+            ret = BIO_ctrl(next, cmd, num, ptr);
         break;
     case BIO_CTRL_PENDING:     /* More to read in buffer */
         ret = ctx-&gt;buf_len - ctx-&gt;buf_off;
         if (ret &lt;= 0)
-            ret = BIO_ctrl(b-&gt;next_bio, cmd, num, ptr);
+            ret = BIO_ctrl(next, cmd, num, ptr);
         break;
     case BIO_CTRL_FLUSH:
         /* do a final write */
@@ -348,33 +364,33 @@ static long enc_ctrl(BIO *b, int cmd, long num, void *ptr)
         }
 
         /* Finally flush the underlying BIO */
-        ret = BIO_ctrl(b-&gt;next_bio, cmd, num, ptr);
+        ret = BIO_ctrl(next, cmd, num, ptr);
         break;
     case BIO_C_GET_CIPHER_STATUS:
         ret = (long)ctx-&gt;ok;
         break;
     case BIO_C_DO_STATE_MACHINE:
         BIO_clear_retry_flags(b);
-        ret = BIO_ctrl(b-&gt;next_bio, cmd, num, ptr);
+        ret = BIO_ctrl(next, cmd, num, ptr);
         BIO_copy_next_retry(b);
         break;
     case BIO_C_GET_CIPHER_CTX:
         c_ctx = (EVP_CIPHER_CTX **)ptr;
         *c_ctx = ctx-&gt;cipher;
-        b-&gt;init = 1;
+        BIO_set_init(b, 1);
         break;
     case BIO_CTRL_DUP:
         dbio = (BIO *)ptr;
-        dctx = (BIO_ENC_CTX *)dbio-&gt;ptr;
+        dctx = BIO_get_data(dbio);
         dctx-&gt;cipher = EVP_CIPHER_CTX_new();
         if (dctx-&gt;cipher == NULL)
             return 0;
         ret = EVP_CIPHER_CTX_copy(dctx-&gt;cipher, ctx-&gt;cipher);
         if (ret)
-            dbio-&gt;init = 1;
+            BIO_set_init(dbio, 1);
         break;
     default:
-        ret = BIO_ctrl(b-&gt;next_bio, cmd, num, ptr);
+        ret = BIO_ctrl(next, cmd, num, ptr);
         break;
     }
     return (ret);
@@ -383,12 +399,13 @@ static long enc_ctrl(BIO *b, int cmd, long num, void *ptr)
 static long enc_callback_ctrl(BIO *b, int cmd, bio_info_cb *fp)
 {
     long ret = 1;
+    BIO *next = BIO_next(b);
 
-    if (b-&gt;next_bio == NULL)
+    if (next == NULL)
         return (0);
     switch (cmd) {
     default:
-        ret = BIO_callback_ctrl(b-&gt;next_bio, cmd, fp);
+        ret = BIO_callback_ctrl(next, cmd, fp);
         break;
     }
     return (ret);
@@ -418,22 +435,25 @@ int BIO_set_cipher(BIO *b, const EVP_CIPHER *c, const unsigned char *k,
                    const unsigned char *i, int e)
 {
     BIO_ENC_CTX *ctx;
+    long (*callback) (struct bio_st *, int, const char *, int, long, long);
 
-    if (b == NULL)
+    ctx = BIO_get_data(b);
+    if (ctx == NULL)
         return 0;
 
-    if ((b-&gt;callback != NULL) &amp;&amp;
-        (b-&gt;callback(b, BIO_CB_CTRL, (const char *)c, BIO_CTRL_SET, e, 0L) &lt;=
-         0))
+    callback = BIO_get_callback(b);
+
+    if ((callback != NULL) &amp;&amp;
+            (callback(b, BIO_CB_CTRL, (const char *)c, BIO_CTRL_SET, e,
+                      0L) &lt;= 0))
         return 0;
 
-    b-&gt;init = 1;
-    ctx = (BIO_ENC_CTX *)b-&gt;ptr;
+    BIO_set_init(b, 1);
+
     if (!EVP_CipherInit_ex(ctx-&gt;cipher, c, NULL, k, i, e))
         return 0;
 
-    if (b-&gt;callback != NULL)
-        return b-&gt;callback(b, BIO_CB_CTRL, (const char *)c, BIO_CTRL_SET, e,
-                           1L);
+    if (callback != NULL)
+        return callback(b, BIO_CB_CTRL, (const char *)c, BIO_CTRL_SET, e, 1L);
     return 1;
 }
diff --git a/crypto/evp/bio_md.c b/crypto/evp/bio_md.c
index 90dffa1..46c5583 100644
--- a/crypto/evp/bio_md.c
+++ b/crypto/evp/bio_md.c
@@ -62,6 +62,7 @@
 #include &lt;openssl/evp.h&gt;
 #include &quot;internal/evp_int.h&quot;
 #include &quot;evp_locl.h&quot;
+#include &quot;internal/bio.h&quot;
 
 /*
  * BIO_put and BIO_get both add to the digest, BIO_gets returns the digest
@@ -103,37 +104,40 @@ static int md_new(BIO *bi)
     if (ctx == NULL)
         return (0);
 
-    bi-&gt;init = 0;
-    bi-&gt;ptr = (char *)ctx;
-    bi-&gt;flags = 0;
-    return (1);
+    BIO_set_init(bi, 1);
+    BIO_set_data(bi, ctx);
+
+    return 1;
 }
 
 static int md_free(BIO *a)
 {
     if (a == NULL)
         return (0);
-    EVP_MD_CTX_free(a-&gt;ptr);
-    a-&gt;ptr = NULL;
-    a-&gt;init = 0;
-    a-&gt;flags = 0;
-    return (1);
+    EVP_MD_CTX_free(BIO_get_data(a));
+    BIO_set_data(a, NULL);
+    BIO_set_init(a, 0);
+
+    return 1;
 }
 
 static int md_read(BIO *b, char *out, int outl)
 {
     int ret = 0;
     EVP_MD_CTX *ctx;
+    BIO *next;
 
     if (out == NULL)
         return (0);
-    ctx = b-&gt;ptr;
 
-    if ((ctx == NULL) || (b-&gt;next_bio == NULL))
+    ctx = BIO_get_data(b);
+    next = BIO_next(b);
+
+    if ((ctx == NULL) || (next == NULL))
         return (0);
 
-    ret = BIO_read(b-&gt;next_bio, out, outl);
-    if (b-&gt;init) {
+    ret = BIO_read(next, out, outl);
+    if (BIO_get_init(b)) {
         if (ret &gt; 0) {
             if (EVP_DigestUpdate(ctx, (unsigned char *)out,
                                  (unsigned int)ret) &lt;= 0)
@@ -149,14 +153,17 @@ static int md_write(BIO *b, const char *in, int inl)
 {
     int ret = 0;
     EVP_MD_CTX *ctx;
+    BIO *next;
 
     if ((in == NULL) || (inl &lt;= 0))
-        return (0);
-    ctx = b-&gt;ptr;
+        return 0;
 
-    if ((ctx != NULL) &amp;&amp; (b-&gt;next_bio != NULL))
-        ret = BIO_write(b-&gt;next_bio, in, inl);
-    if (b-&gt;init) {
+    ctx = BIO_get_data(b);
+    next = BIO_next(b);
+    if ((ctx != NULL) &amp;&amp; (next != NULL))
+        ret = BIO_write(next, in, inl);
+
+    if (BIO_get_init(b)) {
         if (ret &gt; 0) {
             if (!EVP_DigestUpdate(ctx, (const unsigned char *)in,
                                   (unsigned int)ret)) {
@@ -165,11 +172,11 @@ static int md_write(BIO *b, const char *in, int inl)
             }
         }
     }
-    if (b-&gt;next_bio != NULL) {
+    if (next != NULL) {
         BIO_clear_retry_flags(b);
         BIO_copy_next_retry(b);
     }
-    return (ret);
+    return ret;
 }
 
 static long md_ctrl(BIO *b, int cmd, long num, void *ptr)
@@ -178,21 +185,23 @@ static long md_ctrl(BIO *b, int cmd, long num, void *ptr)
     const EVP_MD **ppmd;
     EVP_MD *md;
     long ret = 1;
-    BIO *dbio;
+    BIO *dbio, *next;
 
-    ctx = b-&gt;ptr;
+
+    ctx = BIO_get_data(b);
+    next = BIO_next(b);
 
     switch (cmd) {
     case BIO_CTRL_RESET:
-        if (b-&gt;init)
+        if (BIO_get_init(b))
             ret = EVP_DigestInit_ex(ctx, ctx-&gt;digest, NULL);
         else
             ret = 0;
         if (ret &gt; 0)
-            ret = BIO_ctrl(b-&gt;next_bio, cmd, num, ptr);
+            ret = BIO_ctrl(next, cmd, num, ptr);
         break;
     case BIO_C_GET_MD:
-        if (b-&gt;init) {
+        if (BIO_get_init(b)) {
             ppmd = ptr;
             *ppmd = ctx-&gt;digest;
         } else
@@ -201,17 +210,17 @@ static long md_ctrl(BIO *b, int cmd, long num, void *ptr)
     case BIO_C_GET_MD_CTX:
         pctx = ptr;
         *pctx = ctx;
-        b-&gt;init = 1;
+        BIO_set_init(b, 1);
         break;
     case BIO_C_SET_MD_CTX:
-        if (b-&gt;init)
-            b-&gt;ptr = ptr;
+        if (BIO_get_init(b))
+            BIO_set_data(b, ptr);
         else
             ret = 0;
         break;
     case BIO_C_DO_STATE_MACHINE:
         BIO_clear_retry_flags(b);
-        ret = BIO_ctrl(b-&gt;next_bio, cmd, num, ptr);
+        ret = BIO_ctrl(next, cmd, num, ptr);
         BIO_copy_next_retry(b);
         break;
 
@@ -219,17 +228,17 @@ static long md_ctrl(BIO *b, int cmd, long num, void *ptr)
         md = ptr;
         ret = EVP_DigestInit_ex(ctx, md, NULL);
         if (ret &gt; 0)
-            b-&gt;init = 1;
+            BIO_set_init(b, 1);
         break;
     case BIO_CTRL_DUP:
         dbio = ptr;
-        dctx = dbio-&gt;ptr;
+        dctx = BIO_get_data(dbio);
         if (!EVP_MD_CTX_copy_ex(dctx, ctx))
             return 0;
-        b-&gt;init = 1;
+        BIO_set_init(b, 1);
         break;
     default:
-        ret = BIO_ctrl(b-&gt;next_bio, cmd, num, ptr);
+        ret = BIO_ctrl(next, cmd, num, ptr);
         break;
     }
     return (ret);
@@ -238,12 +247,16 @@ static long md_ctrl(BIO *b, int cmd, long num, void *ptr)
 static long md_callback_ctrl(BIO *b, int cmd, bio_info_cb *fp)
 {
     long ret = 1;
+    BIO *next;
+
+    next = BIO_next(b);
+
+    if (next == NULL)
+        return 0;
 
-    if (b-&gt;next_bio == NULL)
-        return (0);
     switch (cmd) {
     default:
-        ret = BIO_callback_ctrl(b-&gt;next_bio, cmd, fp);
+        ret = BIO_callback_ctrl(next, cmd, fp);
         break;
     }
     return (ret);
@@ -254,20 +267,13 @@ static int md_gets(BIO *bp, char *buf, int size)
     EVP_MD_CTX *ctx;
     unsigned int ret;
 
-    ctx = bp-&gt;ptr;
+    ctx = BIO_get_data(bp);
+
     if (size &lt; ctx-&gt;digest-&gt;md_size)
-        return (0);
+        return 0;
+
     if (EVP_DigestFinal_ex(ctx, (unsigned char *)buf, &amp;ret) &lt;= 0)
         return -1;
 
     return ((int)ret);
 }
-
-/*-
-static int md_puts(bp,str)
-BIO *bp;
-char *str;
-        {
-        return(-1);
-        }
-*/
diff --git a/crypto/evp/bio_ok.c b/crypto/evp/bio_ok.c
index a29777c..0ac1a31 100644
--- a/crypto/evp/bio_ok.c
+++ b/crypto/evp/bio_ok.c
@@ -121,7 +121,7 @@
 #include &lt;assert.h&gt;
 #include &quot;internal/cryptlib.h&quot;
 #include &lt;openssl/buffer.h&gt;
-#include &lt;openssl/bio.h&gt;
+#include &quot;internal/bio.h&quot;
 #include &lt;openssl/evp.h&gt;
 #include &lt;openssl/rand.h&gt;
 #include &quot;internal/evp_int.h&quot;
@@ -178,40 +178,48 @@ static int ok_new(BIO *bi)
 
     ctx = OPENSSL_zalloc(sizeof(*ctx));
     if (ctx == NULL)
-        return (0);
+        return 0;
 
     ctx-&gt;cont = 1;
     ctx-&gt;sigio = 1;
     ctx-&gt;md = EVP_MD_CTX_new();
-    bi-&gt;init = 0;
-    bi-&gt;ptr = (char *)ctx;
-    bi-&gt;flags = 0;
-    return (1);
+    BIO_set_init(bi, 0);
+    BIO_set_data(bi, ctx);
+
+    return 1;
 }
 
 static int ok_free(BIO *a)
 {
+    BIO_OK_CTX *ctx;
+
     if (a == NULL)
-        return (0);
-    EVP_MD_CTX_free(((BIO_OK_CTX *)a-&gt;ptr)-&gt;md);
-    OPENSSL_clear_free(a-&gt;ptr, sizeof(BIO_OK_CTX));
-    a-&gt;ptr = NULL;
-    a-&gt;init = 0;
-    a-&gt;flags = 0;
-    return (1);
+        return 0;
+
+    ctx = BIO_get_data(a);
+
+    EVP_MD_CTX_free(ctx-&gt;md);
+    OPENSSL_clear_free(ctx, sizeof(BIO_OK_CTX));
+    BIO_set_data(a, NULL);
+    BIO_set_init(a, 0);
+
+    return 1;
 }
 
 static int ok_read(BIO *b, char *out, int outl)
 {
     int ret = 0, i, n;
     BIO_OK_CTX *ctx;
+    BIO *next;
 
     if (out == NULL)
-        return (0);
-    ctx = (BIO_OK_CTX *)b-&gt;ptr;
+        return 0;
 
-    if ((ctx == NULL) || (b-&gt;next_bio == NULL) || (b-&gt;init == 0))
-        return (0);
+    ctx = BIO_get_data(b);
+    next = BIO_next(b);
+
+    if ((ctx == NULL) || (next == NULL) || (BIO_get_init(b) == 0))
+        return 0;
 
     while (outl &gt; 0) {
 
@@ -250,7 +258,7 @@ static int ok_read(BIO *b, char *out, int outl)
 
         /* no clean bytes in buffer -- fill it */
         n = IOBS - ctx-&gt;buf_len;
-        i = BIO_read(b-&gt;next_bio, &amp;(ctx-&gt;buf[ctx-&gt;buf_len]), n);
+        i = BIO_read(next, &amp;(ctx-&gt;buf[ctx-&gt;buf_len]), n);
 
         if (i &lt;= 0)
             break;              /* nothing new */
@@ -281,21 +289,23 @@ static int ok_read(BIO *b, char *out, int outl)
 
     BIO_clear_retry_flags(b);
     BIO_copy_next_retry(b);
-    return (ret);
+    return ret;
 }
 
 static int ok_write(BIO *b, const char *in, int inl)
 {
     int ret = 0, n, i;
     BIO_OK_CTX *ctx;
+    BIO *next;
 
     if (inl &lt;= 0)
         return inl;
 
-    ctx = (BIO_OK_CTX *)b-&gt;ptr;
+    ctx = BIO_get_data(b);
+    next = BIO_next(b);
     ret = inl;
 
-    if ((ctx == NULL) || (b-&gt;next_bio == NULL) || (b-&gt;init == 0))
+    if ((ctx == NULL) || (next == NULL) || (BIO_get_init(b) == 0))
         return (0);
 
     if (ctx-&gt;sigio &amp;&amp; !sig_out(b))
@@ -305,7 +315,7 @@ static int ok_write(BIO *b, const char *in, int inl)
         BIO_clear_retry_flags(b);
         n = ctx-&gt;buf_len - ctx-&gt;buf_off;
         while (ctx-&gt;blockout &amp;&amp; n &gt; 0) {
-            i = BIO_write(b-&gt;next_bio, &amp;(ctx-&gt;buf[ctx-&gt;buf_off]), n);
+            i = BIO_write(next, &amp;(ctx-&gt;buf[ctx-&gt;buf_off]), n);
             if (i &lt;= 0) {
                 BIO_copy_next_retry(b);
                 if (!BIO_should_retry(b))
@@ -354,8 +364,10 @@ static long ok_ctrl(BIO *b, int cmd, long num, void *ptr)
     const EVP_MD **ppmd;
     long ret = 1;
     int i;
+    BIO *next;
 
-    ctx = b-&gt;ptr;
+    ctx = BIO_get_data(b);
+    next = BIO_next(b);
 
     switch (cmd) {
     case BIO_CTRL_RESET:
@@ -367,19 +379,19 @@ static long ok_ctrl(BIO *b, int cmd, long num, void *ptr)
         ctx-&gt;finished = 0;
         ctx-&gt;blockout = 0;
         ctx-&gt;sigio = 1;
-        ret = BIO_ctrl(b-&gt;next_bio, cmd, num, ptr);
+        ret = BIO_ctrl(next, cmd, num, ptr);
         break;
     case BIO_CTRL_EOF:         /* More to read */
         if (ctx-&gt;cont &lt;= 0)
             ret = 1;
         else
-            ret = BIO_ctrl(b-&gt;next_bio, cmd, num, ptr);
+            ret = BIO_ctrl(next, cmd, num, ptr);
         break;
     case BIO_CTRL_PENDING:     /* More to read in buffer */
     case BIO_CTRL_WPENDING:    /* More to read in buffer */
         ret = ctx-&gt;blockout ? ctx-&gt;buf_len - ctx-&gt;buf_off : 0;
         if (ret &lt;= 0)
-            ret = BIO_ctrl(b-&gt;next_bio, cmd, num, ptr);
+            ret = BIO_ctrl(next, cmd, num, ptr);
         break;
     case BIO_CTRL_FLUSH:
         /* do a final write */
@@ -400,11 +412,11 @@ static long ok_ctrl(BIO *b, int cmd, long num, void *ptr)
         ctx-&gt;cont = (int)ret;
 
         /* Finally flush the underlying BIO */
-        ret = BIO_ctrl(b-&gt;next_bio, cmd, num, ptr);
+        ret = BIO_ctrl(next, cmd, num, ptr);
         break;
     case BIO_C_DO_STATE_MACHINE:
         BIO_clear_retry_flags(b);
-        ret = BIO_ctrl(b-&gt;next_bio, cmd, num, ptr);
+        ret = BIO_ctrl(next, cmd, num, ptr);
         BIO_copy_next_retry(b);
         break;
     case BIO_CTRL_INFO:
@@ -414,34 +426,39 @@ static long ok_ctrl(BIO *b, int cmd, long num, void *ptr)
         md = ptr;
         if (!EVP_DigestInit_ex(ctx-&gt;md, md, NULL))
             return 0;
-        b-&gt;init = 1;
+        BIO_set_init(b, 1);
         break;
     case BIO_C_GET_MD:
-        if (b-&gt;init) {
+        if (BIO_get_init(b)) {
             ppmd = ptr;
             *ppmd = EVP_MD_CTX_md(ctx-&gt;md);
         } else
             ret = 0;
         break;
     default:
-        ret = BIO_ctrl(b-&gt;next_bio, cmd, num, ptr);
+        ret = BIO_ctrl(next, cmd, num, ptr);
         break;
     }
-    return (ret);
+    return ret;
 }
 
 static long ok_callback_ctrl(BIO *b, int cmd, bio_info_cb *fp)
 {
     long ret = 1;
+    BIO *next;
+    
+    next = BIO_next(b);
+
+    if (next == NULL)
+        return 0;
 
-    if (b-&gt;next_bio == NULL)
-        return (0);
     switch (cmd) {
     default:
-        ret = BIO_callback_ctrl(b-&gt;next_bio, cmd, fp);
+        ret = BIO_callback_ctrl(next, cmd, fp);
         break;
     }
-    return (ret);
+
+    return ret;
 }
 
 static void longswap(void *_ptr, size_t len)
@@ -472,7 +489,7 @@ static int sig_out(BIO *b)
     int md_size;
     void *md_data;
 
-    ctx = b-&gt;ptr;
+    ctx = BIO_get_data(b);
     md = ctx-&gt;md;
     digest = EVP_MD_CTX_md(md);
     md_size = EVP_MD_size(digest);
@@ -516,7 +533,7 @@ static int sig_in(BIO *b)
     int md_size;
     void *md_data;
 
-    ctx = b-&gt;ptr;
+    ctx = BIO_get_data(b);
     md = ctx-&gt;md;
     digest = EVP_MD_CTX_md(md);
     md_size = EVP_MD_size(digest);
@@ -562,7 +579,7 @@ static int block_out(BIO *b)
     const EVP_MD *digest;
     int md_size;
 
-    ctx = b-&gt;ptr;
+    ctx = BIO_get_data(b);
     md = ctx-&gt;md;
     digest = EVP_MD_CTX_md(md);
     md_size = EVP_MD_size(digest);
@@ -593,7 +610,7 @@ static int block_in(BIO *b)
     unsigned char tmp[EVP_MAX_MD_SIZE];
     int md_size;
 
-    ctx = b-&gt;ptr;
+    ctx = BIO_get_data(b);
     md = ctx-&gt;md;
     md_size = EVP_MD_size(EVP_MD_CTX_md(md));
 
diff --git a/doc/crypto/BIO_get_data.pod b/doc/crypto/BIO_get_data.pod
new file mode 100644
index 0000000..73f8ea5
--- /dev/null
+++ b/doc/crypto/BIO_get_data.pod
@@ -0,0 +1,56 @@
+=pod
+
+=head1 NAME
+
+BIO_set_data, BIO_get_data, BIO_set_init, BIO_get_init, BIO_set_shutdown,
+BIO_get_shutdown - functions for managing BIO state information
+
+=head1 SYNOPSIS
+
+ #include &lt;openssl/bio.h&gt;
+
+ void BIO_set_data(BIO *a, void *ptr);
+ void *BIO_get_data(BIO *a);
+ void BIO_set_init(BIO *a, int init);
+ int BIO_get_init(BIO *a);
+ void BIO_set_shutdown(BIO *a, int shut);
+ int BIO_get_shutdown(BIO *a);
+
+=head1 DESCRIPTION
+
+These functions are mainly useful when implementing a custom BIO.
+
+The BIO_set_data() function associates the custom data pointed to by B&lt;ptr&gt; with
+the BIO. This data can subsequently be retrieved via a call to BIO_get_data().
+This can be used by custom BIOs for storing implementation specific information.
+
+The BIO_set_init() function sets the value of the BIO's &quot;init&quot; flag to indicate
+whether initialisation has been completed for this BIO or not. A non-zero value
+indicates that initialisation is complete, whilst zero indicates that it is not.
+Often initialisation will complete during initial construction of the BIO. For
+some BIOs however, initialisation may not complete until after additional steps
+have occurred (for example through calling custom ctrls). The BIO_get_init()
+function returns the value of the &quot;init&quot; flag.
+
+The BIO_set_shutdown() and BIO_get_shutdown() functions set and get the state of
+this BIO's shutdown (i.e. BIO_CLOSE) flag. If set then the underlying resource
+is also closed when the BIO is freed.
+
+=head1 RETURN VALUES
+
+BIO_get_data() returns a pointer to the implementation specific custom data
+associated with this BIO, or NULL if none has been set.
+
+BIO_get_init() returns the state of the BIO's init flag.
+
+BIO_get_shutdown() returns the stat of the BIO's shutdown (i.e. BIO_CLOSE) flag.
+
+=head1 SEE ALSO
+
+L&lt;bio&gt;, L&lt;BIO_meth_new&gt;
+
+=head1 HISTORY
+
+The functions described here were added in OpenSSL version 1.1.0.
+
+=cut
diff --git a/doc/crypto/BIO_meth_new.pod b/doc/crypto/BIO_meth_new.pod
new file mode 100644
index 0000000..de6ce66
--- /dev/null
+++ b/doc/crypto/BIO_meth_new.pod
@@ -0,0 +1,117 @@
+=pod
+
+=head1 NAME
+
+BIO_meth_new, BIO_meth_free, BIO_meth_get_write, BIO_meth_set_write,
+BIO_meth_get_read, BIO_meth_set_read, BIO_meth_get_puts, BIO_meth_set_puts,
+BIO_meth_get_gets, BIO_meth_set_gets, BIO_meth_get_ctrl, BIO_meth_set_ctrl,
+BIO_meth_get_create, BIO_meth_set_create, BIO_meth_get_destroy,
+BIO_meth_set_destroy, BIO_meth_get_callback_ctrl,
+BIO_meth_set_callback_ctrl  - Routines to build up BIO methods
+
+=head1 SYNOPSIS
+
+ #include &lt;openssl/bio.h&gt;
+
+ BIO_METHOD *BIO_meth_new(int type, const char *name);
+ void BIO_meth_free(BIO_METHOD *biom);
+ int (*BIO_meth_get_write(BIO_METHOD *biom)) (BIO *, const char *, int);
+ int BIO_meth_set_write(BIO_METHOD *biom,
+                        int (*write) (BIO *, const char *, int));
+ int (*BIO_meth_get_read(BIO_METHOD *biom)) (BIO *, char *, int);
+ int BIO_meth_set_read(BIO_METHOD *biom,
+                       int (*read) (BIO *, char *, int));
+ int (*BIO_meth_get_puts(BIO_METHOD *biom)) (BIO *, const char *);
+ int BIO_meth_set_puts(BIO_METHOD *biom,
+                       int (*puts) (BIO *, const char *));
+ int (*BIO_meth_get_gets(BIO_METHOD *biom)) (BIO *, char *, int);
+ int BIO_meth_set_gets(BIO_METHOD *biom,
+                       int (*gets) (BIO *, char *, int));
+ long (*BIO_meth_get_ctrl(BIO_METHOD *biom)) (BIO *, int, long, void *);
+ int BIO_meth_set_ctrl(BIO_METHOD *biom,
+                       long (*ctrl) (BIO *, int, long, void *));
+ int (*BIO_meth_get_create(BIO_METHOD *bion)) (BIO *);
+ int BIO_meth_set_create(BIO_METHOD *biom, int (*create) (BIO *));
+ int (*BIO_meth_get_destroy(BIO_METHOD *biom)) (BIO *);
+ int BIO_meth_set_destroy(BIO_METHOD *biom, int (*destroy) (BIO *));
+ long (*BIO_meth_get_callback_ctrl(BIO_METHOD *biom))
+                                  (BIO *, int, bio_info_cb *);
+ int BIO_meth_set_callback_ctrl(BIO_METHOD *biom,
+                                long (*callback_ctrl) (BIO *, int,
+                                                      bio_info_cb *));
+
+=head1 DESCRIPTION
+
+The B&lt;BIO_METHOD&gt; type is a structure used for the implementation of new BIO
+types. It provides a set of of functions used by OpenSSL for the implementation
+of the various BIO capabilities. See the L&lt;bio&gt; page for more information.
+
+BIO_meth_new() creates a new B&lt;BIO_METHOD&gt; structure. It should be given a
+unique integer B&lt;type&gt; and a string that represents its B&lt;name&gt;. The set of
+standard OpenSSL provided BIO types is provided in B&lt;bio.h&gt;. Some examples
+include B&lt;BIO_TYPE_BUFFER&gt; and B&lt;BIO_TYPE_CIPHER&gt;. Filter BIOs should have a
+type which have the &quot;filter&quot; bit set (B&lt;BIO_TYPE_FILTER&gt;). Source/sink BIOs
+should have the &quot;source/sink&quot; bit set (B&lt;BIO_TYPE_SOURCE_SINK&gt;). File descriptor
+based BIOs (e.g. socket, fd, connect, accept etc) should additionally have the
+&quot;descriptor&quot; bit set (B&lt;BIO_TYPE_DESCRIPTOR&gt;). See the L&lt;BIO_find_type&gt; page for
+more information.
+
+BIO_meth_free() destroys a B&lt;BIO_METHOD&gt; structure and frees up any memory
+associated with it.
+
+BIO_meth_get_write() and BIO_meth_set_write() get and set the function used for
+writing arbitrary length data to the BIO respectively. This function will be
+called in response to the application calling BIO_write(). The parameters for
+the function have the same meaning as for BIO_write().
+
+BIO_meth_get_read() and BIO_meth_set_read() get and set the function used for
+reading arbitrary length data from the BIO respectively. This function will be
+called in response to the application calling BIO_read(). The parameters for the
+function have the same meaning as for BIO_read().
+
+BIO_meth_get_puts() and BIO_meth_set_puts() get and set the function used for
+writing a NULL terminated string to the BIO respectively. This function will be
+called in response to the application calling BIO_puts(). The parameters for
+the function have the same meaning as for BIO_puts().
+
+BIO_meth_get_gets() and BIO_meth_set_gets() get and set the function typically
+used for reading a line of data from the BIO respectively (see the L&lt;BIO_gets&gt;
+page for more information). This function will be called in response to the
+application calling BIO_gets(). The parameters for the function have the same
+meaning as for BIO_gets().
+
+BIO_meth_get_ctrl() and BIO_meth_set_ctrl() get and set the function used for
+processing ctrl messages in the BIO respectively. See the L&lt;BIO_ctrl&gt; page for
+more information. This function will be called in response to the application
+calling BIO_ctrl(). The parameters for the function have the same meaning as for
+BIO_ctrl().
+
+BIO_meth_get_create() and BIO_meth_set_create() get and set the function used
+for creating a new instance of the BIO respectively. This function will be
+called in response to the application calling BIO_new() or BIO_set() and passing
+in a pointer to the current BIO_METHOD. The BIO_new() function will allocate the
+memory for the new BIO, and a pointer to this newly allocated structure will
+be passed as a parameter to the function.
+
+BIO_meth_get_destroy() and BIO_meth_set_destroy() get and set the function used
+for destroying an instance of a BIO respectively. This function will be
+called in response to the application calling BIO_free(). A pointer to the BIO
+to be destroyed is passed as a parameter. The destroy function should be used
+for BIO specific clean up. The memory for the BIO itself should not be freed by
+this function.
+
+BIO_meth_get_callback_ctrl() and BIO_meth_set_callback_ctrl() get and set the
+function used for processing callback ctrl messages in the BIO respectively. See
+the L&lt;BIO_callback_ctrl&gt; page for more information. This function will be called
+in response to the application calling BIO_callback_ctrl(). The parameters for
+the function have the same meaning as for BIO_callback_ctrl().
+
+=head1 SEE ALSO
+
+L&lt;bio&gt;, L&lt;BIO_find_type&gt;, L&lt;BIO_ctrl&gt;, L&lt;BIO_read&gt;, L&lt;BIO_new&gt;
+
+=head1 HISTORY
+
+The functions described here were added in OpenSSL version 1.1.0.
+
+=cut
diff --git a/doc/crypto/BIO_push.pod b/doc/crypto/BIO_push.pod
index 8a2657c..1523e5b 100644
--- a/doc/crypto/BIO_push.pod
+++ b/doc/crypto/BIO_push.pod
@@ -2,14 +2,15 @@
 
 =head1 NAME
 
-BIO_push, BIO_pop - add and remove BIOs from a chain.
+BIO_push, BIO_pop, BIO_set_next - add and remove BIOs from a chain.
 
 =head1 SYNOPSIS
 
  #include &lt;openssl/bio.h&gt;
 
- BIO *	BIO_push(BIO *b,BIO *append);
- BIO *	BIO_pop(BIO *b);
+ BIO *BIO_push(BIO *b,BIO *append);
+ BIO *BIO_pop(BIO *b);
+ void BIO_set_next(BIO *b, BIO *next);
 
 =head1 DESCRIPTION
 
@@ -21,6 +22,10 @@ in the chain, or NULL if there is no next BIO. The removed BIO then
 becomes a single BIO with no association with the original chain,
 it can thus be freed or attached to a different chain.
 
+BIO_set_next() replaces the existing next BIO in a chain with the BIO pointed to
+by B&lt;next&gt;. The new chain may include some of the same BIOs from the old chain
+or it may be completely different.
+
 =head1 NOTES
 
 The names of these functions are perhaps a little misleading. BIO_push()
@@ -66,4 +71,10 @@ BIO.
 
 =head1 SEE ALSO
 
-TBA
+L&lt;bio&gt;
+
+=head1 HISTORY
+
+The BIO_set_next() function was added in OpenSSL version 1.1.0.
+
+=cut
diff --git a/doc/crypto/BIO_should_retry.pod b/doc/crypto/BIO_should_retry.pod
index b6d51f7..f5b47b3 100644
--- a/doc/crypto/BIO_should_retry.pod
+++ b/doc/crypto/BIO_should_retry.pod
@@ -4,7 +4,8 @@
 
 BIO_should_retry, BIO_should_read, BIO_should_write,
 BIO_should_io_special, BIO_retry_type, BIO_should_retry,
-BIO_get_retry_BIO, BIO_get_retry_reason - BIO retry functions
+BIO_get_retry_BIO, BIO_get_retry_reason, BIO_set_retry_reason - BIO retry
+functions
 
 =head1 SYNOPSIS
 
@@ -22,8 +23,9 @@ BIO_get_retry_BIO, BIO_get_retry_reason - BIO retry functions
  #define BIO_FLAGS_RWS (BIO_FLAGS_READ|BIO_FLAGS_WRITE|BIO_FLAGS_IO_SPECIAL)
  #define BIO_FLAGS_SHOULD_RETRY	0x08
 
- BIO *	BIO_get_retry_BIO(BIO *bio, int *reason);
- int	BIO_get_retry_reason(BIO *bio);
+ BIO *BIO_get_retry_BIO(BIO *bio, int *reason);
+ int BIO_get_retry_reason(BIO *bio);
+ void BIO_set_retry_reason(BIO *bio, int reason);
 
 =head1 DESCRIPTION
 
@@ -59,6 +61,9 @@ the type of BIO that resulted in this condition.
 BIO_get_retry_reason() returns the reason for a special condition if
 passed the relevant BIO, for example as returned by BIO_get_retry_BIO().
 
+BIO_set_retry_reason() sets the retry reason for a special condition for a given
+BIO. This would usually only be called by BIO implementations.
+
 =head1 NOTES
 
 If BIO_should_retry() returns false then the precise &quot;error condition&quot;
@@ -111,4 +116,11 @@ the entire structure can be read or written.
 
 =head1 SEE ALSO
 
-TBA
+L&lt;bio&gt;
+
+=head1 HISTORY
+
+The BIO_get_retry_reason() and BIO_set_retry_reason() functions were added in
+OpenSSL version 1.1.0.
+
+=cut
diff --git a/crypto/include/internal/async.h b/include/internal/bio.h
similarity index 86%
copy from crypto/include/internal/async.h
copy to include/internal/bio.h
index 76fe4d1..b3352ce 100644
--- a/crypto/include/internal/async.h
+++ b/include/internal/bio.h
@@ -1,6 +1,3 @@
-/*
- * Written by Matt Caswell for the OpenSSL project
- */
 /* ====================================================================
  * Copyright (c) 2016 The OpenSSL Project.  All rights reserved.
  *
@@ -55,8 +52,20 @@
  *
  */
 
-#include &lt;openssl/async.h&gt;
+#include &lt;openssl/bio.h&gt;
+
+struct bio_method_st {
+    int type;
+    const char *name;
+    int (*bwrite) (BIO *, const char *, int);
+    int (*bread) (BIO *, char *, int);
+    int (*bputs) (BIO *, const char *);
+    int (*bgets) (BIO *, char *, int);
+    long (*ctrl) (BIO *, int, long, void *);
+    int (*create) (BIO *);
+    int (*destroy) (BIO *);
+    long (*callback_ctrl) (BIO *, int, bio_info_cb *);
+};
+
 
-int async_init(void);
-void async_deinit(void);
 
diff --git a/include/openssl/bio.h b/include/openssl/bio.h
index 5389770..09aeea1 100644
--- a/include/openssl/bio.h
+++ b/include/openssl/bio.h
@@ -290,70 +290,16 @@ void BIO_set_callback(BIO *b,
 char *BIO_get_callback_arg(const BIO *b);
 void BIO_set_callback_arg(BIO *b, char *arg);
 
+typedef struct bio_method_st BIO_METHOD;
+
 const char *BIO_method_name(const BIO *b);
 int BIO_method_type(const BIO *b);
 
 typedef void bio_info_cb (struct bio_st *, int, const char *, int, long,
                           long);
 
-typedef struct bio_method_st {
-    int type;
-    const char *name;
-    int (*bwrite) (BIO *, const char *, int);
-    int (*bread) (BIO *, char *, int);
-    int (*bputs) (BIO *, const char *);
-    int (*bgets) (BIO *, char *, int);
-    long (*ctrl) (BIO *, int, long, void *);
-    int (*create) (BIO *);
-    int (*destroy) (BIO *);
-    long (*callback_ctrl) (BIO *, int, bio_info_cb *);
-} BIO_METHOD;
-
-struct bio_st {
-    const BIO_METHOD *method;
-    /* bio, mode, argp, argi, argl, ret */
-    long (*callback) (struct bio_st *, int, const char *, int, long, long);
-    char *cb_arg;               /* first argument for the callback */
-    int init;
-    int shutdown;
-    int flags;                  /* extra storage */
-    int retry_reason;
-    int num;
-    void *ptr;
-    struct bio_st *next_bio;    /* used by filter BIOs */
-    struct bio_st *prev_bio;    /* used by filter BIOs */
-    int references;
-    uint64_t num_read;
-    uint64_t num_write;
-    CRYPTO_EX_DATA ex_data;
-    CRYPTO_RWLOCK *lock;
-};
-
 DEFINE_STACK_OF(BIO)
 
-typedef struct bio_f_buffer_ctx_struct {
-    /*-
-     * Buffers are setup like this:
-     *
-     * &lt;---------------------- size -----------------------&gt;
-     * +---------------------------------------------------+
-     * | consumed | remaining          | free space        |
-     * +---------------------------------------------------+
-     * &lt;-- off --&gt;&lt;------- len -------&gt;
-     */
-    /*- BIO *bio; *//*
-     * this is now in the BIO struct
-     */
-    int ibuf_size;              /* how big is the input buffer */
-    int obuf_size;              /* how big is the output buffer */
-    char *ibuf;                 /* the char array */
-    int ibuf_len;               /* how many bytes are in it */
-    int ibuf_off;               /* write/read offset */
-    char *obuf;                 /* the char array */
-    int obuf_len;               /* how many bytes are in it */
-    int obuf_off;               /* write/read offset */
-} BIO_F_BUFFER_CTX;
-
 /* Prefix and suffix callback in ASN1 BIO */
 typedef int asn1_ps_func (BIO *b, unsigned char **pbuf, int *plen,
                           void *parg);
@@ -635,6 +581,12 @@ BIO *BIO_new_fp(FILE *stream, int close_flag);
 BIO *BIO_new(const BIO_METHOD *type);
 int BIO_set(BIO *a, const BIO_METHOD *type);
 int BIO_free(BIO *a);
+void BIO_set_data(BIO *a, void *ptr);
+void *BIO_get_data(BIO *a);
+void BIO_set_init(BIO *a, int init);
+int BIO_get_init(BIO *a);
+void BIO_set_shutdown(BIO *a, int shut);
+int BIO_get_shutdown(BIO *a);
 void BIO_vfree(BIO *a);
 int BIO_up_ref(BIO *a);
 int BIO_read(BIO *b, void *data, int len);
@@ -653,8 +605,10 @@ BIO *BIO_pop(BIO *b);
 void BIO_free_all(BIO *a);
 BIO *BIO_find_type(BIO *b, int bio_type);
 BIO *BIO_next(BIO *b);
+void BIO_set_next(BIO *b, BIO *next);
 BIO *BIO_get_retry_BIO(BIO *bio, int *reason);
 int BIO_get_retry_reason(BIO *bio);
+void BIO_set_retry_reason(BIO *bio, int reason);
 BIO *BIO_dup_chain(BIO *in);
 
 int BIO_nread0(BIO *bio, char **buf);
@@ -818,6 +772,34 @@ int BIO_vsnprintf(char *buf, size_t n, const char *format, va_list args)
 __bio_h__attr__((__format__(__printf__, 3, 0)));
 # undef __bio_h__attr__
 
+
+BIO_METHOD *BIO_meth_new(int type, const char *name);
+void BIO_meth_free(BIO_METHOD *biom);
+int (*BIO_meth_get_write(BIO_METHOD *biom)) (BIO *, const char *, int);
+int BIO_meth_set_write(BIO_METHOD *biom,
+                       int (*write) (BIO *, const char *, int));
+int (*BIO_meth_get_read(BIO_METHOD *biom)) (BIO *, char *, int);
+int BIO_meth_set_read(BIO_METHOD *biom,
+                      int (*read) (BIO *, char *, int));
+int (*BIO_meth_get_puts(BIO_METHOD *biom)) (BIO *, const char *);
+int BIO_meth_set_puts(BIO_METHOD *biom,
+                      int (*puts) (BIO *, const char *));
+int (*BIO_meth_get_gets(BIO_METHOD *biom)) (BIO *, char *, int);
+int BIO_meth_set_gets(BIO_METHOD *biom,
+                      int (*gets) (BIO *, char *, int));
+long (*BIO_meth_get_ctrl(BIO_METHOD *biom)) (BIO *, int, long, void *);
+int BIO_meth_set_ctrl(BIO_METHOD *biom,
+                      long (*ctrl) (BIO *, int, long, void *));
+int (*BIO_meth_get_create(BIO_METHOD *bion)) (BIO *);
+int BIO_meth_set_create(BIO_METHOD *biom, int (*create) (BIO *));
+int (*BIO_meth_get_destroy(BIO_METHOD *biom)) (BIO *);
+int BIO_meth_set_destroy(BIO_METHOD *biom, int (*destroy) (BIO *));
+long (*BIO_meth_get_callback_ctrl(BIO_METHOD *biom))
+                                 (BIO *, int, bio_info_cb *);
+int BIO_meth_set_callback_ctrl(BIO_METHOD *biom,
+                               long (*callback_ctrl) (BIO *, int,
+                                                      bio_info_cb *));
+
 /* BEGIN ERROR CODES */
 /*
  * The following lines are auto generated by the script mkerr.pl. Any changes
diff --git a/ssl/bio_ssl.c b/ssl/bio_ssl.c
index c3afc57..e3deebc 100644
--- a/ssl/bio_ssl.c
+++ b/ssl/bio_ssl.c
@@ -60,7 +60,7 @@
 #include &lt;string.h&gt;
 #include &lt;errno.h&gt;
 #include &lt;openssl/crypto.h&gt;
-#include &lt;openssl/bio.h&gt;
+#include &quot;internal/bio.h&quot;
 #include &lt;openssl/err.h&gt;
 #include &quot;ssl_locl.h&quot;
 
@@ -106,10 +106,12 @@ static int ssl_new(BIO *bi)
         BIOerr(BIO_F_SSL_NEW, ERR_R_MALLOC_FAILURE);
         return (0);
     }
-    bi-&gt;init = 0;
-    bi-&gt;ptr = (char *)bs;
-    bi-&gt;flags = 0;
-    return (1);
+    BIO_set_init(bi, 0);
+    BIO_set_data(bi, bs);
+    /* Clear all flags */
+    BIO_clear_flags(bi, ~0);
+
+    return 1;
 }
 
 static int ssl_free(BIO *a)
@@ -118,17 +120,18 @@ static int ssl_free(BIO *a)
 
     if (a == NULL)
         return (0);
-    bs = (BIO_SSL *)a-&gt;ptr;
+    bs = BIO_get_data(a);
     if (bs-&gt;ssl != NULL)
         SSL_shutdown(bs-&gt;ssl);
-    if (a-&gt;shutdown) {
-        if (a-&gt;init)
+    if (BIO_get_shutdown(a)) {
+        if (BIO_get_init(a))
             SSL_free(bs-&gt;ssl);
-        a-&gt;init = 0;
-        a-&gt;flags = 0;
+        /* Clear all flags */
+        BIO_clear_flags(a, ~0);
+        BIO_set_init(a, 0);
     }
-    OPENSSL_free(a-&gt;ptr);
-    return (1);
+    OPENSSL_free(bs);
+    return 1;
 }
 
 static int ssl_read(BIO *b, char *out, int outl)
@@ -141,7 +144,7 @@ static int ssl_read(BIO *b, char *out, int outl)
 
     if (out == NULL)
         return (0);
-    sb = (BIO_SSL *)b-&gt;ptr;
+    sb = BIO_get_data(b);
     ssl = sb-&gt;ssl;
 
     BIO_clear_retry_flags(b);
@@ -198,7 +201,7 @@ static int ssl_read(BIO *b, char *out, int outl)
         break;
     }
 
-    b-&gt;retry_reason = retry_reason;
+    BIO_set_retry_reason(b, retry_reason);
     return (ret);
 }
 
@@ -211,7 +214,7 @@ static int ssl_write(BIO *b, const char *out, int outl)
 
     if (out == NULL)
         return (0);
-    bs = (BIO_SSL *)b-&gt;ptr;
+    bs = BIO_get_data(b);
     ssl = bs-&gt;ssl;
 
     BIO_clear_retry_flags(b);
@@ -264,18 +267,20 @@ static int ssl_write(BIO *b, const char *out, int outl)
         break;
     }
 
-    b-&gt;retry_reason = retry_reason;
-    return (ret);
+    BIO_set_retry_reason(b, retry_reason);
+    return ret;
 }
 
 static long ssl_ctrl(BIO *b, int cmd, long num, void *ptr)
 {
     SSL **sslp, *ssl;
-    BIO_SSL *bs;
+    BIO_SSL *bs, *dbs;
     BIO *dbio, *bio;
     long ret = 1;
+    BIO *next;
 
-    bs = (BIO_SSL *)b-&gt;ptr;
+    bs = BIO_get_data(b);
+    next = BIO_next(b);
     ssl = bs-&gt;ssl;
     if ((ssl == NULL) &amp;&amp; (cmd != BIO_C_SET_SSL))
         return (0);
@@ -293,8 +298,8 @@ static long ssl_ctrl(BIO *b, int cmd, long num, void *ptr)
             break;
         }
 
-        if (b-&gt;next_bio != NULL)
-            ret = BIO_ctrl(b-&gt;next_bio, cmd, num, ptr);
+        if (next != NULL)
+            ret = BIO_ctrl(next, cmd, num, ptr);
         else if (ssl-&gt;rbio != NULL)
             ret = BIO_ctrl(ssl-&gt;rbio, cmd, num, ptr);
         else
@@ -330,17 +335,17 @@ static long ssl_ctrl(BIO *b, int cmd, long num, void *ptr)
             if (!ssl_new(b))
                 return 0;
         }
-        b-&gt;shutdown = (int)num;
+        BIO_set_shutdown(b, num);
         ssl = (SSL *)ptr;
-        ((BIO_SSL *)b-&gt;ptr)-&gt;ssl = ssl;
+        bs-&gt;ssl = ssl;
         bio = SSL_get_rbio(ssl);
         if (bio != NULL) {
-            if (b-&gt;next_bio != NULL)
-                BIO_push(bio, b-&gt;next_bio);
-            b-&gt;next_bio = bio;
+            if (next != NULL)
+                BIO_push(bio, next);
+            BIO_set_next(b, bio);
             BIO_up_ref(bio);
         }
-        b-&gt;init = 1;
+        BIO_set_init(b, 1);
         break;
     case BIO_C_GET_SSL:
         if (ptr != NULL) {
@@ -350,10 +355,10 @@ static long ssl_ctrl(BIO *b, int cmd, long num, void *ptr)
             ret = 0;
         break;
     case BIO_CTRL_GET_CLOSE:
-        ret = b-&gt;shutdown;
+        ret = BIO_get_shutdown(b);
         break;
     case BIO_CTRL_SET_CLOSE:
-        b-&gt;shutdown = (int)num;
+        BIO_set_shutdown(b, (int)num);
         break;
     case BIO_CTRL_WPENDING:
         ret = BIO_ctrl(ssl-&gt;wbio, cmd, num, ptr);
@@ -369,8 +374,8 @@ static long ssl_ctrl(BIO *b, int cmd, long num, void *ptr)
         BIO_copy_next_retry(b);
         break;
     case BIO_CTRL_PUSH:
-        if ((b-&gt;next_bio != NULL) &amp;&amp; (b-&gt;next_bio != ssl-&gt;rbio)) {
-            SSL_set_bio(ssl, b-&gt;next_bio, b-&gt;next_bio);
+        if ((next != NULL) &amp;&amp; (next != ssl-&gt;rbio)) {
+            SSL_set_bio(ssl, next, next);
             BIO_up_ref(b);
         }
         break;
@@ -383,8 +388,8 @@ static long ssl_ctrl(BIO *b, int cmd, long num, void *ptr)
              */
             if (ssl-&gt;rbio != ssl-&gt;wbio)
                 BIO_free_all(ssl-&gt;wbio);
-            if (b-&gt;next_bio != NULL)
-                BIO_free(b-&gt;next_bio);
+            if (next != NULL)
+                BIO_free(next);
             ssl-&gt;wbio = NULL;
             ssl-&gt;rbio = NULL;
         }
@@ -392,7 +397,7 @@ static long ssl_ctrl(BIO *b, int cmd, long num, void *ptr)
     case BIO_C_DO_STATE_MACHINE:
         BIO_clear_retry_flags(b);
 
-        b-&gt;retry_reason = 0;
+        BIO_set_retry_reason(b, 0);
         ret = (int)SSL_do_handshake(ssl);
 
         switch (SSL_get_error(ssl, (int)ret)) {
@@ -404,11 +409,11 @@ static long ssl_ctrl(BIO *b, int cmd, long num, void *ptr)
             break;
         case SSL_ERROR_WANT_CONNECT:
             BIO_set_flags(b, BIO_FLAGS_IO_SPECIAL | BIO_FLAGS_SHOULD_RETRY);
-            b-&gt;retry_reason = b-&gt;next_bio-&gt;retry_reason;
+            BIO_set_retry_reason(b, BIO_get_retry_reason(next));
             break;
         case SSL_ERROR_WANT_X509_LOOKUP:
             BIO_set_retry_special(b);
-            b-&gt;retry_reason = BIO_RR_SSL_X509_LOOKUP;
+            BIO_set_retry_reason(b, BIO_RR_SSL_X509_LOOKUP);
             break;
         default:
             break;
@@ -416,15 +421,14 @@ static long ssl_ctrl(BIO *b, int cmd, long num, void *ptr)
         break;
     case BIO_CTRL_DUP:
         dbio = (BIO *)ptr;
-        SSL_free(((BIO_SSL *)dbio-&gt;ptr)-&gt;ssl);
-        ((BIO_SSL *)dbio-&gt;ptr)-&gt;ssl = SSL_dup(ssl);
-        ((BIO_SSL *)dbio-&gt;ptr)-&gt;renegotiate_count =
-            ((BIO_SSL *)b-&gt;ptr)-&gt;renegotiate_count;
-        ((BIO_SSL *)dbio-&gt;ptr)-&gt;byte_count = ((BIO_SSL *)b-&gt;ptr)-&gt;byte_count;
-        ((BIO_SSL *)dbio-&gt;ptr)-&gt;renegotiate_timeout =
-            ((BIO_SSL *)b-&gt;ptr)-&gt;renegotiate_timeout;
-        ((BIO_SSL *)dbio-&gt;ptr)-&gt;last_time = ((BIO_SSL *)b-&gt;ptr)-&gt;last_time;
-        ret = (((BIO_SSL *)dbio-&gt;ptr)-&gt;ssl != NULL);
+        dbs = BIO_get_data(dbio);
+        SSL_free(dbs-&gt;ssl);
+        dbs-&gt;ssl = SSL_dup(ssl);
+        dbs-&gt;renegotiate_count = dbs-&gt;renegotiate_count;
+        dbs-&gt;byte_count = dbs-&gt;byte_count;
+        dbs-&gt;renegotiate_timeout = dbs-&gt;renegotiate_timeout;
+        dbs-&gt;last_time = dbs-&gt;last_time;
+        ret = (dbs-&gt;ssl != NULL);
         break;
     case BIO_C_GET_FD:
         ret = BIO_ctrl(ssl-&gt;rbio, cmd, num, ptr);
@@ -461,7 +465,7 @@ static long ssl_callback_ctrl(BIO *b, int cmd, bio_info_cb *fp)
     BIO_SSL *bs;
     long ret = 1;
 
-    bs = (BIO_SSL *)b-&gt;ptr;
+    bs = BIO_get_data(b);
     ssl = bs-&gt;ssl;
     switch (cmd) {
     case BIO_CTRL_SET_CALLBACK:
@@ -548,14 +552,16 @@ BIO *BIO_new_ssl(SSL_CTX *ctx, int client)
 
 int BIO_ssl_copy_session_id(BIO *t, BIO *f)
 {
+    BIO_SSL *tdata, *fdata;
     t = BIO_find_type(t, BIO_TYPE_SSL);
     f = BIO_find_type(f, BIO_TYPE_SSL);
     if ((t == NULL) || (f == NULL))
+        return 0;
+    tdata = BIO_get_data(t);
+    fdata = BIO_get_data(f);
+    if ((tdata-&gt;ssl == NULL) || (fdata-&gt;ssl == NULL))
         return (0);
-    if ((((BIO_SSL *)t-&gt;ptr)-&gt;ssl == NULL) ||
-        (((BIO_SSL *)f-&gt;ptr)-&gt;ssl == NULL))
-        return (0);
-    if (!SSL_copy_session_id(((BIO_SSL *)t-&gt;ptr)-&gt;ssl, ((BIO_SSL *)f-&gt;ptr)-&gt;ssl))
+    if (!SSL_copy_session_id(tdata-&gt;ssl, (fdata-&gt;ssl)))
         return 0;
     return (1);
 }
@@ -564,12 +570,10 @@ void BIO_ssl_shutdown(BIO *b)
 {
     SSL *s;
 
-    while (b != NULL) {
-        if (b-&gt;method-&gt;type == BIO_TYPE_SSL) {
-            s = ((BIO_SSL *)b-&gt;ptr)-&gt;ssl;
-            SSL_shutdown(s);
-            break;
-        }
-        b = b-&gt;next_bio;
-    }
+    b = BIO_find_type(b, BIO_TYPE_SSL);
+    if (b == NULL)
+        return;
+
+    s = BIO_get_data(b);
+    SSL_shutdown(s);
 }
diff --git a/ssl/ssl_lib.c b/ssl/ssl_lib.c
index 3385bc1..e651189 100644
--- a/ssl/ssl_lib.c
+++ b/ssl/ssl_lib.c
@@ -1105,8 +1105,8 @@ void SSL_set_wbio(SSL *s, BIO *wbio)
      */
     if (s-&gt;bbio != NULL) {
         if (s-&gt;wbio == s-&gt;bbio) {
-            s-&gt;wbio = s-&gt;wbio-&gt;next_bio;
-            s-&gt;bbio-&gt;next_bio = NULL;
+            s-&gt;wbio = BIO_next(s-&gt;wbio);
+            BIO_set_next(s-&gt;bbio, NULL);
         }
     }
     if (s-&gt;wbio != wbio &amp;&amp; s-&gt;rbio != s-&gt;wbio)
diff --git a/util/libcrypto.num b/util/libcrypto.num
index 8a2e4ea..e43c854 100644
--- a/util/libcrypto.num
+++ b/util/libcrypto.num
@@ -4060,3 +4060,29 @@ DHparams_it                             3925	1_1_0	EXIST:EXPORT_VAR_AS_FUNCTION:
 EVP_blake2s256                          3926	1_1_0	EXIST::FUNCTION:BLAKE2
 EVP_blake2b512                          3927	1_1_0	EXIST::FUNCTION:BLAKE2
 X509_SIG_get0                           3928	1_1_0	EXIST::FUNCTION:
+BIO_meth_new                            3929	1_1_0	EXIST::FUNCTION:
+BIO_meth_get_puts                       3930	1_1_0	EXIST::FUNCTION:
+BIO_meth_get_ctrl                       3931	1_1_0	EXIST::FUNCTION:
+BIO_meth_get_gets                       3932	1_1_0	EXIST::FUNCTION:
+BIO_get_data                            3933	1_1_0	EXIST::FUNCTION:
+BIO_set_init                            3934	1_1_0	EXIST::FUNCTION:
+BIO_meth_set_puts                       3935	1_1_0	EXIST::FUNCTION:
+BIO_get_shutdown                        3936	1_1_0	EXIST::FUNCTION:
+BIO_get_init                            3937	1_1_0	EXIST::FUNCTION:
+BIO_meth_set_ctrl                       3938	1_1_0	EXIST::FUNCTION:
+BIO_meth_set_read                       3939	1_1_0	EXIST::FUNCTION:
+BIO_set_shutdown                        3940	1_1_0	EXIST::FUNCTION:
+BIO_meth_set_create                     3941	1_1_0	EXIST::FUNCTION:
+BIO_meth_get_write                      3942	1_1_0	EXIST::FUNCTION:
+BIO_meth_set_callback_ctrl              3943	1_1_0	EXIST::FUNCTION:
+BIO_meth_get_create                     3944	1_1_0	EXIST::FUNCTION:
+BIO_set_next                            3945	1_1_0	EXIST::FUNCTION:
+BIO_set_data                            3946	1_1_0	EXIST::FUNCTION:
+BIO_meth_set_write                      3947	1_1_0	EXIST::FUNCTION:
+BIO_meth_set_destroy                    3948	1_1_0	EXIST::FUNCTION:
+BIO_meth_set_gets                       3949	1_1_0	EXIST::FUNCTION:
+BIO_meth_get_callback_ctrl              3950	1_1_0	EXIST::FUNCTION:
+BIO_meth_get_destroy                    3951	1_1_0	EXIST::FUNCTION:
+BIO_meth_get_read                       3952	1_1_0	EXIST::FUNCTION:
+BIO_set_retry_reason                    3953	1_1_0	EXIST::FUNCTION:
+BIO_meth_free                           3954	1_1_0	EXIST::FUNCTION:
</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="005963.html">[openssl-commits] [openssl]  master update
</A></li>
	<LI>Next message: <A HREF="005976.html">[openssl-commits] [openssl]  master update
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#5974">[ date ]</a>
              <a href="thread.html#5974">[ thread ]</a>
              <a href="subject.html#5974">[ subject ]</a>
              <a href="author.html#5974">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="../../../mailman/listinfo/openssl-commits.html">More information about the openssl-commits
mailing list</a><br>
</body></html>
