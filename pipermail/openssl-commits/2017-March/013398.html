<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [openssl-commits] [openssl]  master update
   </TITLE>
   <LINK REL="Index" HREF="https://mta.openssl.org/pipermail/openssl-commits/2017-March/index.html" >
   <LINK REL="made" HREF="mailto:openssl-commits%40openssl.org?Subject=Re%3A%20%5Bopenssl-commits%5D%20%5Bopenssl%5D%20%20master%20update&In-Reply-To=%3C1488583568.927353.27848.nullmailer%40dev.openssl.org%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="013394.html">
   <LINK REL="Next"  HREF="013400.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[openssl-commits] [openssl]  master update</H1>
    <B>Dr. Stephen Henson</B> 
    <A HREF="mailto:openssl-commits%40openssl.org?Subject=Re%3A%20%5Bopenssl-commits%5D%20%5Bopenssl%5D%20%20master%20update&In-Reply-To=%3C1488583568.927353.27848.nullmailer%40dev.openssl.org%3E"
       TITLE="[openssl-commits] [openssl]  master update">steve at openssl.org
       </A><BR>
    <I>Fri Mar  3 23:26:08 UTC 2017</I>
    <P><UL>
        <LI>Previous message: <A HREF="013394.html">[openssl-commits] [openssl]  master update
</A></li>
        <LI>Next message: <A HREF="013400.html">[openssl-commits] [openssl]  master update
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#13398">[ date ]</a>
              <a href="thread.html#13398">[ thread ]</a>
              <a href="subject.html#13398">[ subject ]</a>
              <a href="author.html#13398">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>The branch master has been updated
       via  8336ca13b1be5358621da075eac7a0ab5dc2bd10 (commit)
       via  5528d68f6d716f3bd0b75d0fd223fb866a96346c (commit)
       via  b0e9ab95ddda78921545ee93a337e23ee99ea5ea (commit)
       via  8f12296e2356a0daf751cbc00aed14d4c31a2476 (commit)
       via  224b4e37c075f5bbe1573a90a1dc5e5d9a91d9c1 (commit)
      from  dbaa069a5eb7892b3178a21839a0e14b8d808d81 (commit)


- Log -----------------------------------------------------------------
commit 8336ca13b1be5358621da075eac7a0ab5dc2bd10
Author: Dr. Stephen Henson &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">steve at openssl.org</A>&gt;
Date:   Fri Mar 3 21:02:42 2017 +0000

    Update and add test
    
    Reviewed-by: Rich Salz &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">rsalz at openssl.org</A>&gt;
    (Merged from <A HREF="https://github.com/openssl/openssl/pull/2840">https://github.com/openssl/openssl/pull/2840</A>)

commit 5528d68f6d716f3bd0b75d0fd223fb866a96346c
Author: Dr. Stephen Henson &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">steve at openssl.org</A>&gt;
Date:   Fri Mar 3 03:23:27 2017 +0000

    Set specific error is we have no valid signature algorithms set
    
    Reviewed-by: Rich Salz &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">rsalz at openssl.org</A>&gt;
    (Merged from <A HREF="https://github.com/openssl/openssl/pull/2840">https://github.com/openssl/openssl/pull/2840</A>)

commit b0e9ab95ddda78921545ee93a337e23ee99ea5ea
Author: Dr. Stephen Henson &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">steve at openssl.org</A>&gt;
Date:   Fri Mar 3 03:10:13 2017 +0000

    Signature algorithm enhancement.
    
    Change tls12_sigalg_allowed() so it is passed a SIGALG_LOOKUP parameter,
    this avoids multiple lookups.
    
    When we copy signature algorithms return an error if no valid TLS message
    signing algorithm is present. For TLS 1.3 this means we need at least one
    signature algorithm other than RSA PKCS#1 or SHA1 both of which can only be
    used to sign certificates and not TLS messages.
    
    Reviewed-by: Rich Salz &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">rsalz at openssl.org</A>&gt;
    (Merged from <A HREF="https://github.com/openssl/openssl/pull/2840">https://github.com/openssl/openssl/pull/2840</A>)

commit 8f12296e2356a0daf751cbc00aed14d4c31a2476
Author: Dr. Stephen Henson &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">steve at openssl.org</A>&gt;
Date:   Fri Mar 3 02:44:18 2017 +0000

    Disallow zero length signature algorithms
    
    Reviewed-by: Rich Salz &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">rsalz at openssl.org</A>&gt;
    (Merged from <A HREF="https://github.com/openssl/openssl/pull/2840">https://github.com/openssl/openssl/pull/2840</A>)

commit 224b4e37c075f5bbe1573a90a1dc5e5d9a91d9c1
Author: Dr. Stephen Henson &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">steve at openssl.org</A>&gt;
Date:   Wed Mar 1 17:15:43 2017 +0000

    Don't allow DSA for TLS 1.3
    
    Reviewed-by: Rich Salz &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">rsalz at openssl.org</A>&gt;
    (Merged from <A HREF="https://github.com/openssl/openssl/pull/2840">https://github.com/openssl/openssl/pull/2840</A>)

-----------------------------------------------------------------------

Summary of changes:
 include/openssl/ssl.h                 |  1 +
 ssl/ssl_err.c                         |  3 +-
 ssl/statem/statem_srvr.c              |  1 +
 ssl/t1_lib.c                          | 63 ++++++++++++++++++++---------------
 test/ssl-tests/20-cert-select.conf.in | 14 +++++++-
 5 files changed, 54 insertions(+), 28 deletions(-)

diff --git a/include/openssl/ssl.h b/include/openssl/ssl.h
index 2b4464c..64a312c 100644
--- a/include/openssl/ssl.h
+++ b/include/openssl/ssl.h
@@ -2317,6 +2317,7 @@ int ERR_load_SSL_strings(void);
 # define SSL_F_SSL_WRITE_INTERNAL                         524
 # define SSL_F_STATE_MACHINE                              353
 # define SSL_F_TLS12_CHECK_PEER_SIGALG                    333
+# define SSL_F_TLS12_COPY_SIGALGS                         533
 # define SSL_F_TLS13_CHANGE_CIPHER_STATE                  440
 # define SSL_F_TLS13_SETUP_KEY_BLOCK                      441
 # define SSL_F_TLS1_CHANGE_CIPHER_STATE                   209
diff --git a/ssl/ssl_err.c b/ssl/ssl_err.c
index 6fe8e6e..0ace985 100644
--- a/ssl/ssl_err.c
+++ b/ssl/ssl_err.c
@@ -256,11 +256,12 @@ static ERR_STRING_DATA SSL_str_functs[] = {
     {ERR_FUNC(SSL_F_SSL_VERIFY_CERT_CHAIN), &quot;ssl_verify_cert_chain&quot;},
     {ERR_FUNC(SSL_F_SSL_WRITE), &quot;SSL_write&quot;},
     {ERR_FUNC(SSL_F_SSL_WRITE_EARLY_DATA), &quot;SSL_write_early_data&quot;},
-    {ERR_FUNC(SSL_F_SSL_WRITE_EARLY_FINISH), &quot;SSL_write_early_finish&quot;},
+    {ERR_FUNC(SSL_F_SSL_WRITE_EARLY_FINISH), &quot;ssl_write_early_finish&quot;},
     {ERR_FUNC(SSL_F_SSL_WRITE_EX), &quot;SSL_write_ex&quot;},
     {ERR_FUNC(SSL_F_SSL_WRITE_INTERNAL), &quot;ssl_write_internal&quot;},
     {ERR_FUNC(SSL_F_STATE_MACHINE), &quot;state_machine&quot;},
     {ERR_FUNC(SSL_F_TLS12_CHECK_PEER_SIGALG), &quot;tls12_check_peer_sigalg&quot;},
+    {ERR_FUNC(SSL_F_TLS12_COPY_SIGALGS), &quot;tls12_copy_sigalgs&quot;},
     {ERR_FUNC(SSL_F_TLS13_CHANGE_CIPHER_STATE), &quot;tls13_change_cipher_state&quot;},
     {ERR_FUNC(SSL_F_TLS13_SETUP_KEY_BLOCK), &quot;tls13_setup_key_block&quot;},
     {ERR_FUNC(SSL_F_TLS1_CHANGE_CIPHER_STATE), &quot;tls1_change_cipher_state&quot;},
diff --git a/ssl/statem/statem_srvr.c b/ssl/statem/statem_srvr.c
index 7414c19..6c007a1 100644
--- a/ssl/statem/statem_srvr.c
+++ b/ssl/statem/statem_srvr.c
@@ -2497,6 +2497,7 @@ int tls_construct_certificate_request(SSL *s, WPACKET *pkt)
         size_t nl = tls12_get_psigalgs(s, 1, &amp;psigs);
 
         if (!WPACKET_start_sub_packet_u16(pkt)
+                || !WPACKET_set_flags(pkt, WPACKET_FLAGS_NON_ZERO_LENGTH)
                 || !tls12_copy_sigalgs(s, pkt, psigs, nl)
                 || !WPACKET_close(pkt)) {
             SSLerr(SSL_F_TLS_CONSTRUCT_CERTIFICATE_REQUEST,
diff --git a/ssl/t1_lib.c b/ssl/t1_lib.c
index 099dcdb..5ab7223 100644
--- a/ssl/t1_lib.c
+++ b/ssl/t1_lib.c
@@ -828,13 +828,6 @@ int tls1_set_peer_legacy_sigalg(SSL *s, const EVP_PKEY *pkey)
     return 1;
 }
 
-static int tls_sigalg_get_sig(uint16_t sigalg)
-{
-    const SIGALG_LOOKUP *r = tls1_lookup_sigalg(sigalg);
-
-    return r != NULL ? r-&gt;sig : 0;
-}
-
 size_t tls12_get_psigalgs(SSL *s, int sent, const uint16_t **psigs)
 {
     /*
@@ -1387,23 +1380,25 @@ static int tls12_get_pkey_idx(int sig_nid)
 }
 
 /* Check to see if a signature algorithm is allowed */
-static int tls12_sigalg_allowed(SSL *s, int op, uint16_t ptmp)
+static int tls12_sigalg_allowed(SSL *s, int op, const SIGALG_LOOKUP *lu)
 {
-    const SIGALG_LOOKUP *lu = tls1_lookup_sigalg(ptmp);
     unsigned char sigalgstr[2];
     int secbits;
 
     /* See if sigalgs is recognised and if hash is enabled */
     if (lu == NULL || ssl_md(lu-&gt;hash_idx) == NULL)
         return 0;
+    /* DSA is not allowed in TLS 1.3 */
+    if (SSL_IS_TLS13(s) &amp;&amp; lu-&gt;sig == EVP_PKEY_DSA)
+        return 0;
     /* See if public key algorithm allowed */
     if (tls12_get_pkey_idx(lu-&gt;sig) == -1)
         return 0;
     /* Security bits: half digest bits */
     secbits = EVP_MD_size(ssl_md(lu-&gt;hash_idx)) * 4;
     /* Finally see if security callback allows it */
-    sigalgstr[0] = (ptmp &gt;&gt; 8) &amp; 0xff;
-    sigalgstr[1] = ptmp &amp; 0xff;
+    sigalgstr[0] = (lu-&gt;sigalg &gt;&gt; 8) &amp; 0xff;
+    sigalgstr[1] = lu-&gt;sigalg &amp; 0xff;
     return ssl_security(s, op, secbits, lu-&gt;hash, (void *)sigalgstr);
 }
 
@@ -1425,24 +1420,28 @@ void ssl_set_sig_mask(uint32_t *pmask_a, SSL *s, int op)
      */
     sigalgslen = tls12_get_psigalgs(s, 1, &amp;sigalgs);
     for (i = 0; i &lt; sigalgslen; i ++, sigalgs++) {
-        switch (tls_sigalg_get_sig(*sigalgs)) {
+        const SIGALG_LOOKUP *lu = tls1_lookup_sigalg(*sigalgs);
+
+        if (lu == NULL)
+            continue;
+        switch (lu-&gt;sig) {
 #ifndef OPENSSL_NO_RSA
         /* Any RSA-PSS signature algorithms also mean we allow RSA */
         case EVP_PKEY_RSA_PSS:
         case EVP_PKEY_RSA:
-            if (!have_rsa &amp;&amp; tls12_sigalg_allowed(s, op, *sigalgs))
+            if (!have_rsa &amp;&amp; tls12_sigalg_allowed(s, op, lu))
                 have_rsa = 1;
             break;
 #endif
 #ifndef OPENSSL_NO_DSA
         case EVP_PKEY_DSA:
-            if (!have_dsa &amp;&amp; tls12_sigalg_allowed(s, op, *sigalgs))
+            if (!have_dsa &amp;&amp; tls12_sigalg_allowed(s, op, lu))
                 have_dsa = 1;
             break;
 #endif
 #ifndef OPENSSL_NO_EC
         case EVP_PKEY_EC:
-            if (!have_ecdsa &amp;&amp; tls12_sigalg_allowed(s, op, *sigalgs))
+            if (!have_ecdsa &amp;&amp; tls12_sigalg_allowed(s, op, lu))
                 have_ecdsa = 1;
             break;
 #endif
@@ -1460,14 +1459,26 @@ int tls12_copy_sigalgs(SSL *s, WPACKET *pkt,
                        const uint16_t *psig, size_t psiglen)
 {
     size_t i;
+    int rv = 0;
 
     for (i = 0; i &lt; psiglen; i++, psig++) {
-        if (tls12_sigalg_allowed(s, SSL_SECOP_SIGALG_SUPPORTED, *psig)) {
-            if (!WPACKET_put_bytes_u16(pkt, *psig))
-                return 0;
-        }
+        const SIGALG_LOOKUP *lu = tls1_lookup_sigalg(*psig);
+
+        if (!tls12_sigalg_allowed(s, SSL_SECOP_SIGALG_SUPPORTED, lu))
+            continue;
+        if (!WPACKET_put_bytes_u16(pkt, *psig))
+            return 0;
+        /*
+         * If TLS 1.3 must have at least one valid TLS 1.3 message
+         * signing algorithm: i.e. neither RSA nor SHA1
+         */
+        if (rv == 0 &amp;&amp; (!SSL_IS_TLS13(s)
+            || (lu-&gt;sig != EVP_PKEY_RSA &amp;&amp; lu-&gt;hash != NID_sha1)))
+            rv = 1;
     }
-    return 1;
+    if (rv == 0)
+        SSLerr(SSL_F_TLS12_COPY_SIGALGS, SSL_R_NO_SUITABLE_SIGNATURE_ALGORITHM);
+    return rv;
 }
 
 /* Given preference and allowed sigalgs set shared sigalgs */
@@ -1478,16 +1489,16 @@ static size_t tls12_shared_sigalgs(SSL *s, const SIGALG_LOOKUP **shsig,
     const uint16_t *ptmp, *atmp;
     size_t i, j, nmatch = 0;
     for (i = 0, ptmp = pref; i &lt; preflen; i++, ptmp++) {
+        const SIGALG_LOOKUP *lu = tls1_lookup_sigalg(*ptmp);
+
         /* Skip disabled hashes or signature algorithms */
-        if (!tls12_sigalg_allowed(s, SSL_SECOP_SIGALG_SHARED, *ptmp))
+        if (!tls12_sigalg_allowed(s, SSL_SECOP_SIGALG_SHARED, lu))
             continue;
         for (j = 0, atmp = allow; j &lt; allowlen; j++, atmp++) {
             if (*ptmp == *atmp) {
                 nmatch++;
-                if (shsig) {
-                    *shsig = tls1_lookup_sigalg(*ptmp);
-                    shsig++;
-                }
+                if (shsig)
+                    *shsig++ = lu;
                 break;
             }
         }
@@ -1560,7 +1571,7 @@ int tls1_save_sigalgs(SSL *s, PACKET *pkt)
     size = PACKET_remaining(pkt);
 
     /* Invalid data length */
-    if ((size &amp; 1) != 0)
+    if (size == 0 || (size &amp; 1) != 0)
         return 0;
 
     size &gt;&gt;= 1;
diff --git a/test/ssl-tests/20-cert-select.conf.in b/test/ssl-tests/20-cert-select.conf.in
index 1dd7860..3d50f02 100644
--- a/test/ssl-tests/20-cert-select.conf.in
+++ b/test/ssl-tests/20-cert-select.conf.in
@@ -334,6 +334,18 @@ my @tests_tls_1_3 = (
             &quot;ExpectedResult&quot; =&gt; &quot;Success&quot;
         },
     },
+    {
+        name =&gt; &quot;TLS 1.3 Client Auth No TLS 1.3 Signature Algorithms&quot;,
+        server =&gt; {
+            &quot;ClientSignatureAlgorithms&quot; =&gt; &quot;ECDSA+SHA1:DSA+SHA256:RSA+SHA256&quot;,
+            &quot;VerifyCAFile&quot; =&gt; test_pem(&quot;root-cert.pem&quot;),
+            &quot;VerifyMode&quot; =&gt; &quot;Request&quot;
+        },
+        client =&gt; {},
+        test   =&gt; {
+            &quot;ExpectedResult&quot; =&gt; &quot;ServerFail&quot;
+        },
+    },
 );
 
 push @tests, @tests_tls_1_3 unless disabled(&quot;tls1_3&quot;);
@@ -370,7 +382,7 @@ my @tests_dsa_tls_1_3 = (
             &quot;CipherString&quot; =&gt; &quot;ALL&quot;,
         },
         client =&gt; {
-            &quot;SignatureAlgorithms&quot; =&gt; &quot;DSA+SHA1:DSA+SHA256&quot;,
+            &quot;SignatureAlgorithms&quot; =&gt; &quot;DSA+SHA1:DSA+SHA256:ECDSA+SHA256&quot;,
             &quot;CipherString&quot; =&gt; &quot;ALL&quot;,
         },
         test   =&gt; {
</PRE>





<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="013394.html">[openssl-commits] [openssl]  master update
</A></li>
	<LI>Next message: <A HREF="013400.html">[openssl-commits] [openssl]  master update
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#13398">[ date ]</a>
              <a href="thread.html#13398">[ thread ]</a>
              <a href="subject.html#13398">[ subject ]</a>
              <a href="author.html#13398">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="../../../mailman/listinfo/openssl-commits.html">More information about the openssl-commits
mailing list</a><br>
</body></html>
