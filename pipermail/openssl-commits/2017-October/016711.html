<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [openssl-commits] [openssl]  master update
   </TITLE>
   <LINK REL="Index" HREF="https://mta.openssl.org/pipermail/openssl-commits/2017-October/index.html" >
   <LINK REL="made" HREF="mailto:openssl-commits%40openssl.org?Subject=Re%3A%20%5Bopenssl-commits%5D%20%5Bopenssl%5D%20%20master%20update&In-Reply-To=%3C1508974546.331657.12019.nullmailer%40dev.openssl.org%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="016709.html">
   <LINK REL="Next"  HREF="016715.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[openssl-commits] [openssl]  master update</H1>
    <B>paul.dale at oracle.com</B> 
    <A HREF="mailto:openssl-commits%40openssl.org?Subject=Re%3A%20%5Bopenssl-commits%5D%20%5Bopenssl%5D%20%20master%20update&In-Reply-To=%3C1508974546.331657.12019.nullmailer%40dev.openssl.org%3E"
       TITLE="[openssl-commits] [openssl]  master update">paul.dale at oracle.com
       </A><BR>
    <I>Wed Oct 25 23:35:46 UTC 2017</I>
    <P><UL>
        <LI>Previous message: <A HREF="016709.html">[openssl-commits] [openssl]  master update
</A></li>
        <LI>Next message: <A HREF="016715.html">[openssl-commits] [openssl]  master update
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#16711">[ date ]</a>
              <a href="thread.html#16711">[ thread ]</a>
              <a href="subject.html#16711">[ subject ]</a>
              <a href="author.html#16711">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>The branch master has been updated
       via  d9c989fe3f137580ee627c91e01245e78b0b41ff (commit)
       via  62f45e34368c37368af5c8e3602ae7156d7f3f38 (commit)
       via  3ceab379fbaaf11b2adee0fb2a93c517272ee6c3 (commit)
      from  82d89ef72515ad3d78c0160641faf30b8b024dda (commit)


- Log -----------------------------------------------------------------
commit d9c989fe3f137580ee627c91e01245e78b0b41ff
Author: Paul Yang &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">yang.yang at baishancloud.com</A>&gt;
Date:   Tue Oct 24 01:35:31 2017 +0800

    Fix doc-nits in doc/man3/DEFINE_STACK_OF.pod
    
    &lt;compar&gt; to &lt;compare&gt; to match the var name in function prototype
    
    Reviewed-by: Paul Dale &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">paul.dale at oracle.com</A>&gt;
    Reviewed-by: Andy Polyakov &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">appro at openssl.org</A>&gt;
    Reviewed-by: Richard Levitte &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">levitte at openssl.org</A>&gt;
    (Merged from <A HREF="https://github.com/openssl/openssl/pull/4559">https://github.com/openssl/openssl/pull/4559</A>)

commit 62f45e34368c37368af5c8e3602ae7156d7f3f38
Author: Paul Yang &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">yang.yang at baishancloud.com</A>&gt;
Date:   Fri Oct 20 13:11:37 2017 +0800

    Fix mismatch of function prototype and document
    
    Reviewed-by: Paul Dale &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">paul.dale at oracle.com</A>&gt;
    Reviewed-by: Andy Polyakov &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">appro at openssl.org</A>&gt;
    Reviewed-by: Richard Levitte &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">levitte at openssl.org</A>&gt;
    (Merged from <A HREF="https://github.com/openssl/openssl/pull/4559">https://github.com/openssl/openssl/pull/4559</A>)

commit 3ceab379fbaaf11b2adee0fb2a93c517272ee6c3
Author: Paul Yang &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">yang.yang at baishancloud.com</A>&gt;
Date:   Fri Oct 20 01:42:39 2017 +0800

    Add sk_TYPE_new_reserve() function
    
    This is a combination of sk_new and sk_reserve, to make it more
    convenient to allocate a new stack with reserved memory and comaprison
    function (if any).
    
    Reviewed-by: Paul Dale &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">paul.dale at oracle.com</A>&gt;
    Reviewed-by: Andy Polyakov &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">appro at openssl.org</A>&gt;
    Reviewed-by: Richard Levitte &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">levitte at openssl.org</A>&gt;
    (Merged from <A HREF="https://github.com/openssl/openssl/pull/4559">https://github.com/openssl/openssl/pull/4559</A>)

-----------------------------------------------------------------------

Summary of changes:
 crypto/stack/stack.c         | 28 ++++++++++++++++++++++------
 doc/man3/DEFINE_STACK_OF.pod | 30 ++++++++++++++++++++++--------
 include/openssl/safestack.h  |  4 ++++
 include/openssl/stack.h      |  1 +
 util/libcrypto.num           |  1 +
 5 files changed, 50 insertions(+), 14 deletions(-)

diff --git a/crypto/stack/stack.c b/crypto/stack/stack.c
index 559085a..fc755e3 100644
--- a/crypto/stack/stack.c
+++ b/crypto/stack/stack.c
@@ -111,16 +111,12 @@ OPENSSL_STACK *OPENSSL_sk_deep_copy(const OPENSSL_STACK *sk,
 
 OPENSSL_STACK *OPENSSL_sk_new_null(void)
 {
-    return OPENSSL_zalloc(sizeof(OPENSSL_STACK));
+    return OPENSSL_sk_new_reserve(NULL, 0);
 }
 
 OPENSSL_STACK *OPENSSL_sk_new(OPENSSL_sk_compfunc c)
 {
-    OPENSSL_STACK *ret = OPENSSL_sk_new_null();
-
-    if (ret != NULL)
-        ret-&gt;comp = c;
-    return ret;
+    return OPENSSL_sk_new_reserve(c, 0);
 }
 
 /*
@@ -203,6 +199,26 @@ static int sk_reserve(OPENSSL_STACK *st, int n, int exact)
     return 1;
 }
 
+OPENSSL_STACK *OPENSSL_sk_new_reserve(OPENSSL_sk_compfunc c, int n)
+{
+    OPENSSL_STACK *st = OPENSSL_zalloc(sizeof(OPENSSL_STACK));
+
+    if (st == NULL)
+        return NULL;
+
+    st-&gt;comp = c;
+
+    if (n &lt;= 0)
+        return st;
+
+    if (!sk_reserve(st, n, 1)) {
+        OPENSSL_sk_free(st);
+        return NULL;
+    }
+
+    return st;
+}
+
 int OPENSSL_sk_reserve(OPENSSL_STACK *st, int n)
 {
     if (st == NULL)
diff --git a/doc/man3/DEFINE_STACK_OF.pod b/doc/man3/DEFINE_STACK_OF.pod
index f41d3ea..718e9f1 100644
--- a/doc/man3/DEFINE_STACK_OF.pod
+++ b/doc/man3/DEFINE_STACK_OF.pod
@@ -9,7 +9,8 @@ sk_TYPE_reserve, sk_TYPE_free, sk_TYPE_zero, sk_TYPE_delete,
 sk_TYPE_delete_ptr, sk_TYPE_push, sk_TYPE_unshift, sk_TYPE_pop,
 sk_TYPE_shift, sk_TYPE_pop_free, sk_TYPE_insert, sk_TYPE_set,
 sk_TYPE_find, sk_TYPE_find_ex, sk_TYPE_sort, sk_TYPE_is_sorted,
-sk_TYPE_dup, sk_TYPE_deep_copy, sk_TYPE_set_cmp_func - stack container
+sk_TYPE_dup, sk_TYPE_deep_copy, sk_TYPE_set_cmp_func, sk_TYPE_new_reserve
+- stack container
 
 =head1 SYNOPSIS
 
@@ -31,7 +32,7 @@ sk_TYPE_dup, sk_TYPE_deep_copy, sk_TYPE_set_cmp_func - stack container
  TYPE *sk_TYPE_value(const STACK_OF(TYPE) *sk, int idx);
  STACK_OF(TYPE) *sk_TYPE_new(sk_TYPE_compfunc compare);
  STACK_OF(TYPE) *sk_TYPE_new_null(void);
- int sk_TYPE_reserve(STACK_OF(TYPE) *sk, size_t n);
+ int sk_TYPE_reserve(STACK_OF(TYPE) *sk, int n);
  void sk_TYPE_free(const STACK_OF(TYPE) *sk);
  void sk_TYPE_zero(const STACK_OF(TYPE) *sk);
  TYPE *sk_TYPE_delete(STACK_OF(TYPE) *sk, int i);
@@ -53,6 +54,7 @@ sk_TYPE_dup, sk_TYPE_deep_copy, sk_TYPE_set_cmp_func - stack container
                                    sk_TYPE_freefunc freefunc);
  sk_TYPE_compfunc (*sk_TYPE_set_cmp_func(STACK_OF(TYPE) *sk,
                                          sk_TYPE_compfunc compare));
+ STACK_OF(TYPE) *sk_TYPE_new_reserve(sk_TYPE_compfunc compare, int n);
 
 =head1 DESCRIPTION
 
@@ -90,10 +92,12 @@ B&lt;NULL&gt;.
 sk_TYPE_value() returns element B&lt;idx&gt; in B&lt;sk&gt;, where B&lt;idx&gt; starts at
 zero. If B&lt;idx&gt; is out of range then B&lt;NULL&gt; is returned.
 
-sk_TYPE_new() allocates a new empty stack using comparison function B&lt;compar&gt;.
-If B&lt;compar&gt; is B&lt;NULL&gt; then no comparison function is used.
+sk_TYPE_new() allocates a new empty stack using comparison function B&lt;compare&gt;.
+If B&lt;compare&gt; is B&lt;NULL&gt; then no comparison function is used. This function is
+equivalent to sk_TYPE_new_reserve(compare, 0).
 
-sk_TYPE_new_null() allocates a new empty stack with no comparison function.
+sk_TYPE_new_null() allocates a new empty stack with no comparison function. This
+function is equivalent to sk_TYPE_new_reserve(NULL, 0).
 
 sk_TYPE_reserve() allocates additional memory in the B&lt;sk&gt; structure
 such that the next B&lt;n&gt; calls to sk_TYPE_insert(), sk_TYPE_push()
@@ -101,7 +105,15 @@ or sk_TYPE_unshift() will not fail or cause memory to be allocated
 or reallocated. If B&lt;n&gt; is zero, any excess space allocated in the
 B&lt;sk&gt; structure is freed. On error B&lt;sk&gt; is unchanged.
 
-sk_TYPE_set_cmp_func() sets the comparison function of B&lt;sk&gt; to B&lt;compar&gt;.
+sk_TYPE_new_reserve() allocates a new stack. The new stack will have additional
+memory allocated to hold B&lt;n&gt; elements if B&lt;n&gt; is positive. The next B&lt;n&gt; calls
+to sk_TYPE_insert(), sk_TYPE_push() or sk_TYPE_unshift() will not fail or cause
+memory to be allocated or reallocated. If B&lt;n&gt; is zero or less than zero, no
+memory is allocated. sk_TYPE_reserve() also sets the comparison function
+B&lt;compare&gt; to the newly created stack. If B&lt;compare&gt; is B&lt;NULL&gt; then no
+comparison function is used.
+
+sk_TYPE_set_cmp_func() sets the comparison function of B&lt;sk&gt; to B&lt;compare&gt;.
 The previous comparison function is returned or B&lt;NULL&gt; if there was
 no previous comparison function.
 
@@ -210,8 +222,8 @@ passed stack is B&lt;NULL&gt;.
 sk_TYPE_value() returns a pointer to a stack element or B&lt;NULL&gt; if the
 index is out of range.
 
-sk_TYPE_new() and sk_TYPE_new_null() return an empty stack or B&lt;NULL&gt; if
-an error occurs.
+sk_TYPE_new(), sk_TYPE_new_null() and sk_TYPE_new_reserve() return an empty
+stack or B&lt;NULL&gt; if an error occurs.
 
 sk_TYPE_reserve() returns B&lt;1&gt; on successful allocation of the required memory
 or B&lt;0&gt; on error.
@@ -245,6 +257,8 @@ stack.
 Before OpenSSL 1.1.0, this was implemented via macros and not inline functions
 and was not a public API.
 
+sk_TYPE_new_reserve() was added in OpenSSL 1.1.1.
+
 =head1 COPYRIGHT
 
 Copyright 2000-2017 The OpenSSL Project Authors. All Rights Reserved.
diff --git a/include/openssl/safestack.h b/include/openssl/safestack.h
index 4241c4f..7438b19 100644
--- a/include/openssl/safestack.h
+++ b/include/openssl/safestack.h
@@ -40,6 +40,10 @@ extern &quot;C&quot; {
     { \
         return (STACK_OF(t1) *)OPENSSL_sk_new_null(); \
     } \
+    static ossl_inline STACK_OF(t1) *sk_##t1##_new_reserve(sk_##t1##_compfunc compare, int n) \
+    { \
+        return (STACK_OF(t1) *)OPENSSL_sk_new_reserve((OPENSSL_sk_compfunc)compare, n); \
+    } \
     static ossl_inline int sk_##t1##_reserve(STACK_OF(t1) *sk, int n) \
     { \
         return OPENSSL_sk_reserve((OPENSSL_STACK *)sk, n); \
diff --git a/include/openssl/stack.h b/include/openssl/stack.h
index aee763c..cfc0750 100644
--- a/include/openssl/stack.h
+++ b/include/openssl/stack.h
@@ -27,6 +27,7 @@ void *OPENSSL_sk_set(OPENSSL_STACK *st, int i, const void *data);
 
 OPENSSL_STACK *OPENSSL_sk_new(OPENSSL_sk_compfunc cmp);
 OPENSSL_STACK *OPENSSL_sk_new_null(void);
+OPENSSL_STACK *OPENSSL_sk_new_reserve(OPENSSL_sk_compfunc c, int n);
 int OPENSSL_sk_reserve(OPENSSL_STACK *st, int n);
 void OPENSSL_sk_free(OPENSSL_STACK *);
 void OPENSSL_sk_pop_free(OPENSSL_STACK *st, void (*func) (void *));
diff --git a/util/libcrypto.num b/util/libcrypto.num
index 96990ed..f4e3451 100644
--- a/util/libcrypto.num
+++ b/util/libcrypto.num
@@ -4417,3 +4417,4 @@ RAND_POOL_add                           4361	1_1_1	EXIST::FUNCTION:
 RAND_POOL_add_begin                     4362	1_1_1	EXIST::FUNCTION:
 RAND_POOL_add_end                       4363	1_1_1	EXIST::FUNCTION:
 RAND_POOL_acquire_entropy               4364	1_1_1	EXIST::FUNCTION:
+OPENSSL_sk_new_reserve                  4365	1_1_1	EXIST::FUNCTION:
</PRE>










<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="016709.html">[openssl-commits] [openssl]  master update
</A></li>
	<LI>Next message: <A HREF="016715.html">[openssl-commits] [openssl]  master update
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#16711">[ date ]</a>
              <a href="thread.html#16711">[ thread ]</a>
              <a href="subject.html#16711">[ subject ]</a>
              <a href="author.html#16711">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="../../../mailman/listinfo/openssl-commits.html">More information about the openssl-commits
mailing list</a><br>
</body></html>
