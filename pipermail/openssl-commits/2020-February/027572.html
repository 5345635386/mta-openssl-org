<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [openssl]  master update
   </TITLE>
   <LINK REL="Index" HREF="https://mta.openssl.org/pipermail/openssl-commits/2020-February/index.html" >
   <LINK REL="made" HREF="mailto:openssl-commits%40openssl.org?Subject=Re%3A%20%5Bopenssl%5D%20%20master%20update&In-Reply-To=%3C1582015877.791420.9459.nullmailer%40dev.openssl.org%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="027571.html">
   <LINK REL="Next"  HREF="027573.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[openssl]  master update</H1>
    <B>Richard Levitte</B> 
    <A HREF="mailto:openssl-commits%40openssl.org?Subject=Re%3A%20%5Bopenssl%5D%20%20master%20update&In-Reply-To=%3C1582015877.791420.9459.nullmailer%40dev.openssl.org%3E"
       TITLE="[openssl]  master update">levitte at openssl.org
       </A><BR>
    <I>Tue Feb 18 08:51:17 UTC 2020</I>
    <P><UL>
        <LI>Previous message: <A HREF="027571.html">[openssl]  master update
</A></li>
        <LI>Next message: <A HREF="027573.html">[openssl]  master update
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#27572">[ date ]</a>
              <a href="thread.html#27572">[ thread ]</a>
              <a href="subject.html#27572">[ subject ]</a>
              <a href="author.html#27572">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>The branch master has been updated
       via  eeacf7d065e817b2c0c29ce7d6a9d8047450a293 (commit)
       via  a60079c76e9b8d9bd9e7da228ff514db8162459f (commit)
       via  6c93c56c5271ae3eefbb11bda195e2d55ffe5155 (commit)
       via  a3f3ed65a34320d229a9fb62e57732e42daf0a39 (commit)
       via  acf3360cadd959819307192d66269ab648d48a98 (commit)
       via  4b3327e70e1e97550a65a5d4aa26e017770e2214 (commit)
       via  6469d60e63a8edd1e060be017dc39829e7b4cc8b (commit)
       via  35746c7948f657a562d36eba05708fcce8a083f9 (commit)
       via  95640f748c2fd4ff362bda2b573d9dc1dc6ef40e (commit)
       via  42f7a4897f80d633646f955599037546bfcba519 (commit)
       via  11920665518bb5fc0487cf1de82fd89e779f5729 (commit)
       via  ebcc3e0a4d39bc2c50c75f18a5c47e67ff8d4c98 (commit)
       via  1cf959316894ab2a1111806803a2bed30f46bf30 (commit)
       via  b67d53a52408f626bed5edb4d753cae282399ef7 (commit)
       via  c0d49f4659ee100c1f9a0c4506f3867667b60c5f (commit)
       via  4a7234d2a146d83bd2728ee0491524a8588c6902 (commit)
       via  f0790d4d2f92373f68f5b3097eb326505c937831 (commit)
      from  4e46a7afa843cea44ee81bf7d40d146029358879 (commit)


- Log -----------------------------------------------------------------
commit eeacf7d065e817b2c0c29ce7d6a9d8047450a293
Author: Richard Levitte &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">levitte at openssl.org</A>&gt;
Date:   Sat Feb 15 07:18:57 2020 +0100

    TEST: Optionally silence OpenSSL::Test::setup()
    
    test/generate_ssl_tests.pl uses OpenSSL::Test to get to some of its
    practical location functions.  A recent note in the setup() code made
    its result not quite match the original (we do check that), so there's
    a need to silence setup(), which we do with a simple optional argument.
    
    Reviewed-by: Paul Dale &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">paul.dale at oracle.com</A>&gt;
    (Merged from <A HREF="https://github.com/openssl/openssl/pull/11080">https://github.com/openssl/openssl/pull/11080</A>)

commit a60079c76e9b8d9bd9e7da228ff514db8162459f
Author: Richard Levitte &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">levitte at openssl.org</A>&gt;
Date:   Fri Feb 14 08:46:54 2020 +0100

    TEST: Modify test/recipes/tconversion.pl to leave artifacts behind
    
    Reviewed-by: Paul Dale &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">paul.dale at oracle.com</A>&gt;
    (Merged from <A HREF="https://github.com/openssl/openssl/pull/11080">https://github.com/openssl/openssl/pull/11080</A>)

commit 6c93c56c5271ae3eefbb11bda195e2d55ffe5155
Author: Richard Levitte &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">levitte at openssl.org</A>&gt;
Date:   Fri Feb 14 08:43:28 2020 +0100

    TEST: Modify test/recipes/80-test_ssl_old.t to leave artifacts behind
    
    Reviewed-by: Paul Dale &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">paul.dale at oracle.com</A>&gt;
    (Merged from <A HREF="https://github.com/openssl/openssl/pull/11080">https://github.com/openssl/openssl/pull/11080</A>)

commit a3f3ed65a34320d229a9fb62e57732e42daf0a39
Author: Richard Levitte &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">levitte at openssl.org</A>&gt;
Date:   Fri Feb 14 08:42:05 2020 +0100

    TEST: Modify test/recipes/80-test_ssl_new.t to leave artifacts behind
    
    Reviewed-by: Paul Dale &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">paul.dale at oracle.com</A>&gt;
    (Merged from <A HREF="https://github.com/openssl/openssl/pull/11080">https://github.com/openssl/openssl/pull/11080</A>)

commit acf3360cadd959819307192d66269ab648d48a98
Author: Richard Levitte &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">levitte at openssl.org</A>&gt;
Date:   Fri Feb 14 08:37:32 2020 +0100

    TEST: Modify test/recipes/80-test_ocsp.t to leave artifacts behind
    
    Reviewed-by: Paul Dale &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">paul.dale at oracle.com</A>&gt;
    (Merged from <A HREF="https://github.com/openssl/openssl/pull/11080">https://github.com/openssl/openssl/pull/11080</A>)

commit 4b3327e70e1e97550a65a5d4aa26e017770e2214
Author: Richard Levitte &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">levitte at openssl.org</A>&gt;
Date:   Fri Feb 14 08:34:40 2020 +0100

    TEST: Modify test/recipes/80-test_cms.t to leave artifacts behind
    
    Reviewed-by: Paul Dale &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">paul.dale at oracle.com</A>&gt;
    (Merged from <A HREF="https://github.com/openssl/openssl/pull/11080">https://github.com/openssl/openssl/pull/11080</A>)

commit 6469d60e63a8edd1e060be017dc39829e7b4cc8b
Author: Richard Levitte &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">levitte at openssl.org</A>&gt;
Date:   Fri Feb 14 07:16:25 2020 +0100

    TEST: Modify test/recipes/80-test_ca.t to leave artifacts behind
    
    Reviewed-by: Paul Dale &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">paul.dale at oracle.com</A>&gt;
    (Merged from <A HREF="https://github.com/openssl/openssl/pull/11080">https://github.com/openssl/openssl/pull/11080</A>)

commit 35746c7948f657a562d36eba05708fcce8a083f9
Author: Richard Levitte &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">levitte at openssl.org</A>&gt;
Date:   Fri Feb 14 07:01:15 2020 +0100

    TEST: Modify test/recipes/20-test_pkeyutl.t to leave artifacts behind
    
    Reviewed-by: Paul Dale &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">paul.dale at oracle.com</A>&gt;
    (Merged from <A HREF="https://github.com/openssl/openssl/pull/11080">https://github.com/openssl/openssl/pull/11080</A>)

commit 95640f748c2fd4ff362bda2b573d9dc1dc6ef40e
Author: Richard Levitte &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">levitte at openssl.org</A>&gt;
Date:   Fri Feb 14 06:56:04 2020 +0100

    TEST: Modify test/recipes/20-test_enc_more.t to leave artifacts behind
    
    Reviewed-by: Paul Dale &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">paul.dale at oracle.com</A>&gt;
    (Merged from <A HREF="https://github.com/openssl/openssl/pull/11080">https://github.com/openssl/openssl/pull/11080</A>)

commit 42f7a4897f80d633646f955599037546bfcba519
Author: Richard Levitte &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">levitte at openssl.org</A>&gt;
Date:   Thu Feb 13 00:28:47 2020 +0100

    TEST: Modify test/recipes/25-test_x509.t to leave artifacts behind
    
    Reviewed-by: Paul Dale &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">paul.dale at oracle.com</A>&gt;
    (Merged from <A HREF="https://github.com/openssl/openssl/pull/11080">https://github.com/openssl/openssl/pull/11080</A>)

commit 11920665518bb5fc0487cf1de82fd89e779f5729
Author: Richard Levitte &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">levitte at openssl.org</A>&gt;
Date:   Thu Feb 13 00:28:31 2020 +0100

    TEST: Modify test/recipes/25-test_req.t to leave artifacts behind
    
    Reviewed-by: Paul Dale &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">paul.dale at oracle.com</A>&gt;
    (Merged from <A HREF="https://github.com/openssl/openssl/pull/11080">https://github.com/openssl/openssl/pull/11080</A>)

commit ebcc3e0a4d39bc2c50c75f18a5c47e67ff8d4c98
Author: Richard Levitte &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">levitte at openssl.org</A>&gt;
Date:   Thu Feb 13 00:28:16 2020 +0100

    TEST: Modify test/recipes/25-test_crl.t to leave artifacts behind
    
    Reviewed-by: Paul Dale &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">paul.dale at oracle.com</A>&gt;
    (Merged from <A HREF="https://github.com/openssl/openssl/pull/11080">https://github.com/openssl/openssl/pull/11080</A>)

commit 1cf959316894ab2a1111806803a2bed30f46bf30
Author: Richard Levitte &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">levitte at openssl.org</A>&gt;
Date:   Thu Feb 13 00:28:02 2020 +0100

    TEST: Modify test/recipes/20-test_enc.t to leave artifacts behind
    
    Reviewed-by: Paul Dale &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">paul.dale at oracle.com</A>&gt;
    (Merged from <A HREF="https://github.com/openssl/openssl/pull/11080">https://github.com/openssl/openssl/pull/11080</A>)

commit b67d53a52408f626bed5edb4d753cae282399ef7
Author: Richard Levitte &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">levitte at openssl.org</A>&gt;
Date:   Wed Feb 12 20:29:33 2020 +0100

    TEST: Modify test/recipes/20-test_dgst.t to leave artifacts behind
    
    Reviewed-by: Paul Dale &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">paul.dale at oracle.com</A>&gt;
    (Merged from <A HREF="https://github.com/openssl/openssl/pull/11080">https://github.com/openssl/openssl/pull/11080</A>)

commit c0d49f4659ee100c1f9a0c4506f3867667b60c5f
Author: Richard Levitte &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">levitte at openssl.org</A>&gt;
Date:   Wed Feb 12 20:29:20 2020 +0100

    TEST: Modify test/recipes/15-test_rsapss.t to leave artifacts behind
    
    Reviewed-by: Paul Dale &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">paul.dale at oracle.com</A>&gt;
    (Merged from <A HREF="https://github.com/openssl/openssl/pull/11080">https://github.com/openssl/openssl/pull/11080</A>)

commit 4a7234d2a146d83bd2728ee0491524a8588c6902
Author: Richard Levitte &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">levitte at openssl.org</A>&gt;
Date:   Wed Feb 12 20:29:04 2020 +0100

    TEST: Modify test/recipes/15-test_mp_rsa.t to leave artifacts behind
    
    Reviewed-by: Paul Dale &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">paul.dale at oracle.com</A>&gt;
    (Merged from <A HREF="https://github.com/openssl/openssl/pull/11080">https://github.com/openssl/openssl/pull/11080</A>)

commit f0790d4d2f92373f68f5b3097eb326505c937831
Author: Richard Levitte &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">levitte at openssl.org</A>&gt;
Date:   Wed Feb 12 20:22:42 2020 +0100

    TEST: Create test specific output directories
    
    We had all tests run with test/test-runs/ as working directory, and
    tests cleaned up after themselves...  which is well and good, until
    you want to have a look at what went wrong when a complex test fails,
    and you have to recreate everything it does manually.
    
    To remedy this, we have OpenSSL::Test create the result directory
    dynamically (and cleaning it up first if it's already there) and let
    the test recipe have that as working directory.
    
    Test recipes are now encouraged to name their diverse output files
    uniquely, and not to clean them up, to allow a developer to have a
    look at the files that were produced.
    
    With continuous integration that allows this, the result directories
    could also be archived and be left as a build artifact.
    
    Reviewed-by: Paul Dale &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">paul.dale at oracle.com</A>&gt;
    (Merged from <A HREF="https://github.com/openssl/openssl/pull/11080">https://github.com/openssl/openssl/pull/11080</A>)

-----------------------------------------------------------------------

Summary of changes:
 .gitignore                           |   2 +-
 CHANGES                              |   5 +
 Configurations/descrip.mms.tmpl      |  12 -
 Configurations/unix-Makefile.tmpl    |  13 +-
 Configurations/windows-makefile.tmpl |   2 -
 test/generate_ssl_tests.pl           |   2 +-
 test/recipes/15-test_mp_rsa.t        |  53 +--
 test/recipes/15-test_rsapss.t        |   1 -
 test/recipes/20-test_dgst.t          |  12 +-
 test/recipes/20-test_enc.t           |   3 -
 test/recipes/20-test_enc_more.t      |   3 -
 test/recipes/20-test_pkeyutl.t       |  19 +-
 test/recipes/25-test_crl.t           |   1 -
 test/recipes/25-test_req.t           |  30 +-
 test/recipes/25-test_x509.t          |  14 +-
 test/recipes/80-test_ca.t            |   4 -
 test/recipes/80-test_cms.t           | 731 +++++++++++++++++++----------------
 test/recipes/80-test_ocsp.t          |   7 +-
 test/recipes/80-test_ssl_new.t       |  13 +-
 test/recipes/80-test_ssl_old.t       |  38 --
 test/recipes/tconversion.pl          |   3 -
 util/perl/OpenSSL/Test.pm            |  50 ++-
 22 files changed, 497 insertions(+), 521 deletions(-)

diff --git a/.gitignore b/.gitignore
index 52c845300b..a75914092f 100644
--- a/.gitignore
+++ b/.gitignore
@@ -101,7 +101,7 @@ doc/man1/openssl-x509.pod
 /providers/fipsinstall.conf
 
 # Certain files that get created by tests on the fly
-/test/test-runs
+/test-runs
 /test/buildtest_*
 
 # Fuzz stuff.
diff --git a/CHANGES b/CHANGES
index 535269d0a8..d0f72970c8 100644
--- a/CHANGES
+++ b/CHANGES
@@ -9,6 +9,11 @@
 
  Changes between 1.1.1 and 3.0.0 [xx XXX xxxx]
 
+  *) The test suite is changed to preserve results of each test recipe.
+     A new directory test-runs/ with subdirectories named like the
+     test recipes are created in the build tree for this purpose.
+     [Richard Levitte]
+
   *) X509 certificates signed using SHA1 are no longer allowed at security
      level 1 and above.
      In TLS/SSL the default security level is 1. It can be set either
diff --git a/Configurations/descrip.mms.tmpl b/Configurations/descrip.mms.tmpl
index d379a8230b..15fefd2502 100644
--- a/Configurations/descrip.mms.tmpl
+++ b/Configurations/descrip.mms.tmpl
@@ -28,14 +28,6 @@
       (my $x = shift) =~ s|\]$|...]|;
       $x
   }
-  sub move {
-      my $f = catdir(@_);
-      my $b = abs2rel(rel2abs(&quot;.&quot;),rel2abs($f));
-      $sourcedir = catdir($b,$sourcedir)
-          if !file_name_is_absolute($sourcedir);
-      $builddir = catdir($b,$builddir)
-          if !file_name_is_absolute($builddir);
-      &quot;&quot;;
   }
 
   # Because we need to make two computations of these data,
@@ -439,11 +431,8 @@ all : build_sw build_docs
 test : tests
 {- dependmagic('tests'); -} : build_programs_nodep, build_modules_nodep
         @ ! {- output_off() if $disabled{tests}; &quot;&quot; -}
-        SET DEFAULT [.test]{- move(&quot;test&quot;) -}
-        CREATE/DIR [.test-runs]
         DEFINE SRCTOP {- sourcedir() -}
         DEFINE BLDTOP {- builddir() -}
-        DEFINE RESULT_D {- builddir(qw(test test-runs)) -}
         DEFINE OPENSSL_ENGINES {- builddir(&quot;engines&quot;) -}
         DEFINE OPENSSL_MODULES {- builddir(&quot;providers&quot;) -}
         IF &quot;$(VERBOSE)&quot; .NES. &quot;&quot; THEN DEFINE VERBOSE &quot;$(VERBOSE)&quot;
@@ -452,7 +441,6 @@ test : tests
         DEASSIGN OPENSSL_ENGINES
         DEASSIGN BLDTOP
         DEASSIGN SRCTOP
-        SET DEFAULT [-]{- move(&quot;..&quot;) -}
         @ ! {- if ($disabled{tests}) { output_on(); } else { output_off(); } &quot;&quot; -}
         @ WRITE SYS$OUTPUT &quot;Tests are not supported with your chosen Configure options&quot;
         @ ! {- output_on() if !$disabled{tests}; &quot;&quot; -}
diff --git a/Configurations/unix-Makefile.tmpl b/Configurations/unix-Makefile.tmpl
index 6777bb8de9..55c1b12573 100644
--- a/Configurations/unix-Makefile.tmpl
+++ b/Configurations/unix-Makefile.tmpl
@@ -464,16 +464,13 @@ all: build_sw build_docs
 test: tests
 {- dependmagic('tests'); -}: build_programs_nodep build_modules_nodep link-utils
 	@ : {- output_off() if $disabled{tests}; &quot;&quot; -}
-	( cd test; \
-	  mkdir -p test-runs; \
-	  SRCTOP=../$(SRCDIR) \
-	  BLDTOP=../$(BLDDIR) \
-	  RESULT_D=test-runs \
+	( SRCTOP=$(SRCDIR) \
+	  BLDTOP=$(BLDDIR) \
 	  PERL=&quot;$(PERL)&quot; \
 	  EXE_EXT={- platform-&gt;binext() -} \
-	  OPENSSL_ENGINES=`cd ../$(BLDDIR)/engines 2&gt;/dev/null &amp;&amp; pwd` \
-	  OPENSSL_MODULES=`cd ../$(BLDDIR)/providers 2&gt;/dev/null &amp;&amp; pwd` \
-	  $(PERL) ../$(SRCDIR)/test/run_tests.pl $(TESTS) )
+	  OPENSSL_ENGINES=`cd $(BLDDIR)/engines 2&gt;/dev/null &amp;&amp; pwd` \
+	  OPENSSL_MODULES=`cd $(BLDDIR)/providers 2&gt;/dev/null &amp;&amp; pwd` \
+	  $(PERL) $(SRCDIR)/test/run_tests.pl $(TESTS) )
 	@ : {- if ($disabled{tests}) { output_on(); } else { output_off(); } &quot;&quot; -}
 	@echo &quot;Tests are not supported with your chosen Configure options&quot;
 	@ : {- output_on() if !$disabled{tests}; &quot;&quot; -}
diff --git a/Configurations/windows-makefile.tmpl b/Configurations/windows-makefile.tmpl
index 275c93ebc1..074e8f74c5 100644
--- a/Configurations/windows-makefile.tmpl
+++ b/Configurations/windows-makefile.tmpl
@@ -387,10 +387,8 @@ all: build_sw build_docs
 test: tests
 {- dependmagic('tests'); -}: build_programs_nodep build_modules_nodep
 	@{- output_off() if $disabled{tests}; &quot;&quot; -}
-	-mkdir $(BLDDIR)\test\test-runs
 	set SRCTOP=$(SRCDIR)
 	set BLDTOP=$(BLDDIR)
-	set RESULT_D=$(BLDDIR)\test\test-runs
 	set PERL=$(PERL)
 	set OPENSSL_ENGINES=$(MAKEDIR)\engines
 	set OPENSSL_MODULES=$(MAKEDIR)\providers
diff --git a/test/generate_ssl_tests.pl b/test/generate_ssl_tests.pl
index 044dff6ad4..8cfc451fbb 100644
--- a/test/generate_ssl_tests.pl
+++ b/test/generate_ssl_tests.pl
@@ -19,7 +19,7 @@ use OpenSSL::Test::Utils;
 
 # This block needs to run before 'use lib srctop_dir' directives.
 BEGIN {
-    OpenSSL::Test::setup(&quot;no_test_here&quot;);
+    OpenSSL::Test::setup(&quot;no_test_here&quot;, quiet =&gt; 1);
 }
 
 use FindBin;
diff --git a/test/recipes/15-test_mp_rsa.t b/test/recipes/15-test_mp_rsa.t
index c69f3f31a5..4a4ac3569d 100644
--- a/test/recipes/15-test_mp_rsa.t
+++ b/test/recipes/15-test_mp_rsa.t
@@ -55,42 +55,47 @@ sub run_mp_tests {
         my $name = ($evp ? &quot;evp&quot; : &quot;&quot;) . &quot;${bits}p${primes}&quot;;
 
         if ($evp) {
-            ok(run(app([ 'openssl', 'genpkey', '-out', 'rsamptest.pem',
-                         '-algorithm', 'RSA', '-pkeyopt', &quot;rsa_keygen_primes:$primes&quot;,
-                         '-pkeyopt', &quot;rsa_keygen_bits:$bits&quot;])), &quot;genrsa $name&quot;);
+            ok(run(app([ 'openssl', 'genpkey', '-out', &quot;rsamptest-$name.pem&quot;,
+                         '-algorithm', 'RSA',
+                         '-pkeyopt', &quot;rsa_keygen_primes:$primes&quot;,
+                         '-pkeyopt', &quot;rsa_keygen_bits:$bits&quot;])),
+               &quot;genrsa $name&quot;);
         } else {
-            ok(run(app([ 'openssl', 'genrsa', '-out', 'rsamptest.pem',
-                         '-primes', $primes, $bits])), &quot;genrsa $name&quot;);
+            ok(run(app([ 'openssl', 'genrsa', '-out', &quot;rsamptest-$name.pem&quot;,
+                         '-primes', $primes, $bits])),
+               &quot;genrsa $name&quot;);
         }
 
-        ok(run(app([ 'openssl', 'rsa', '-check', '-in', 'rsamptest.pem',
-                     '-noout'])), &quot;rsa -check $name&quot;);
+        ok(run(app([ 'openssl', 'rsa', '-check', '-in', &quot;rsamptest-$name.pem&quot;,
+                     '-noout'])),
+           &quot;rsa -check $name&quot;);
+
         if ($evp) {
-            ok(run(app([ 'openssl', 'pkeyutl', '-inkey', 'rsamptest.pem',
+            ok(run(app([ 'openssl', 'pkeyutl', '-inkey', &quot;rsamptest-$name.pem&quot;,
                          '-encrypt', '-in', $cleartext,
-                         '-out', 'rsamptest.enc' ])), &quot;rsa $name encrypt&quot;);
-            ok(run(app([ 'openssl', 'pkeyutl', '-inkey', 'rsamptest.pem',
-                         '-decrypt', '-in', 'rsamptest.enc',
-                         '-out', 'rsamptest.dec' ])), &quot;rsa $name decrypt&quot;);
+                         '-out', &quot;rsamptest-$name.enc&quot; ])),
+               &quot;rsa $name encrypt&quot;);
+            ok(run(app([ 'openssl', 'pkeyutl', '-inkey', &quot;rsamptest-$name.pem&quot;,
+                         '-decrypt', '-in', &quot;rsamptest-$name.enc&quot;,
+                         '-out', &quot;rsamptest-$name.dec&quot; ])),
+               &quot;rsa $name decrypt&quot;);
         } else {
-            ok(run(app([ 'openssl', 'rsautl', '-inkey', 'rsamptest.pem',
+            ok(run(app([ 'openssl', 'rsautl', '-inkey', &quot;rsamptest-$name.pem&quot;,
                          '-encrypt', '-in', $cleartext,
-                         '-out', 'rsamptest.enc' ])), &quot;rsa $name encrypt&quot;);
-            ok(run(app([ 'openssl', 'rsautl', '-inkey', 'rsamptest.pem',
-                         '-decrypt', '-in', 'rsamptest.enc',
-                         '-out', 'rsamptest.dec' ])), &quot;rsa $name decrypt&quot;);
+                         '-out', &quot;rsamptest-$name.enc&quot; ])),
+               &quot;rsa $name encrypt&quot;);
+            ok(run(app([ 'openssl', 'rsautl', '-inkey', &quot;rsamptest-$name.pem&quot;,
+                         '-decrypt', '-in', &quot;rsamptest-$name.enc&quot;,
+                         '-out', &quot;rsamptest-$name.dec&quot; ])),
+               &quot;rsa $name decrypt&quot;);
         }
 
-        ok(check_msg(), &quot;rsa $name check result&quot;);
-
-        # clean up temp files
-        unlink 'rsamptest.pem';
-        unlink 'rsamptest.enc';
-        unlink 'rsamptest.dec';
+        ok(check_msg(&quot;rsamptest-$name.dec&quot;), &quot;rsa $name check result&quot;);
     }
 }
 
 sub check_msg {
+    my $decrypted = shift;
     my $msg;
     my $dec;
 
@@ -98,7 +103,7 @@ sub check_msg {
     binmode $fh;
     read($fh, $msg, 10240);
     close $fh;
-    open($fh, &quot;&lt;&quot;, &quot;rsamptest.dec&quot;) or return 0;
+    open($fh, &quot;&lt;&quot;, $decrypted ) or return 0;
     binmode $fh;
     read($fh, $dec, 10240);
     close $fh;
diff --git a/test/recipes/15-test_rsapss.t b/test/recipes/15-test_rsapss.t
index 0288976157..59144cdaee 100644
--- a/test/recipes/15-test_rsapss.t
+++ b/test/recipes/15-test_rsapss.t
@@ -46,4 +46,3 @@ ok(run(app(['openssl', 'dgst', '-prverify', srctop_file('test', 'testrsa.pem'),
             '-sigopt', 'rsa_mgf1_md:sha512', '-signature', 'testrsapss.sig',
             srctop_file('test', 'testrsa.pem')])),
    &quot;openssl dgst -prverify&quot;);
-unlink 'testrsapss.sig';
diff --git a/test/recipes/20-test_dgst.t b/test/recipes/20-test_dgst.t
index 1080770f53..a319d08ca2 100644
--- a/test/recipes/20-test_dgst.t
+++ b/test/recipes/20-test_dgst.t
@@ -11,6 +11,7 @@ use strict;
 use warnings;
 
 use File::Spec;
+use File::Basename;
 use OpenSSL::Test qw/:DEFAULT with srctop_file/;
 use OpenSSL::Test::Utils;
 
@@ -26,29 +27,28 @@ sub tsignverify {
     my $data_to_sign = srctop_file('test', 'README');
     my $other_data = srctop_file('test', 'README.external');
 
+    my $sigfile = basename($privkey, '.pem') . '.sig';
     plan tests =&gt; 4;
 
     ok(run(app(['openssl', 'dgst', '-sign', $privkey,
-                '-out', 'testdgst.sig',
+                '-out', $sigfile,
                 $data_to_sign])),
        $testtext.&quot;: Generating signature&quot;);
 
     ok(run(app(['openssl', 'dgst', '-prverify', $privkey,
-                '-signature', 'testdgst.sig',
+                '-signature', $sigfile,
                 $data_to_sign])),
        $testtext.&quot;: Verify signature with private key&quot;);
 
     ok(run(app(['openssl', 'dgst', '-verify', $pubkey,
-                '-signature', 'testdgst.sig',
+                '-signature', $sigfile,
                 $data_to_sign])),
        $testtext.&quot;: Verify signature with public key&quot;);
 
     ok(!run(app(['openssl', 'dgst', '-verify', $pubkey,
-                 '-signature', 'testdgst.sig',
+                 '-signature', $sigfile,
                  $other_data])),
        $testtext.&quot;: Expect failure verifying mismatching data&quot;);
-
-    unlink 'testdgst.sig';
 }
 
 SKIP: {
diff --git a/test/recipes/20-test_enc.t b/test/recipes/20-test_enc.t
index 50e7463c06..b4a8e01878 100644
--- a/test/recipes/20-test_enc.t
+++ b/test/recipes/20-test_enc.t
@@ -62,9 +62,6 @@ plan tests =&gt; 2 + (scalar @ciphers)*2;
 	     ok(run(app([$cmd, @e, &quot;-in&quot;, $test, &quot;-out&quot;, $cipherfile]))
 		&amp;&amp; run(app([$cmd, @d, &quot;-in&quot;, $cipherfile, &quot;-out&quot;, $clearfile]))
 		&amp;&amp; compare_text($test,$clearfile) == 0, $t);
-	     unlink $cipherfile, $clearfile;
 	 }
      }
 }
-
-unlink $test;
diff --git a/test/recipes/20-test_enc_more.t b/test/recipes/20-test_enc_more.t
index 8f37bee250..a59663412a 100644
--- a/test/recipes/20-test_enc_more.t
+++ b/test/recipes/20-test_enc_more.t
@@ -54,8 +54,5 @@ SKIP: {
            &amp;&amp; run(app([@common, &quot;-d&quot;, &quot;-in&quot;, $cipherfile, &quot;-out&quot;, $clearfile]))
            &amp;&amp; compare_text($plaintext, $clearfile) == 0
            , $ciphername);
-        unlink $cipherfile, $clearfile;
     }
 }
-
-unlink $plaintext;
diff --git a/test/recipes/20-test_pkeyutl.t b/test/recipes/20-test_pkeyutl.t
index 0f82b1f21a..f923f7cdc8 100644
--- a/test/recipes/20-test_pkeyutl.t
+++ b/test/recipes/20-test_pkeyutl.t
@@ -10,6 +10,7 @@ use strict;
 use warnings;
 
 use File::Spec;
+use File::Basename;
 use OpenSSL::Test qw/:DEFAULT srctop_file ok_nofips/;
 use OpenSSL::Test::Utils;
 
@@ -27,13 +28,13 @@ SKIP: {
     ok_nofips(run(app(([ 'openssl', 'pkeyutl', '-sign',
                       '-in', srctop_file('test', 'certs', 'sm2.pem'),
                       '-inkey', srctop_file('test', 'certs', 'sm2.key'),
-                      '-out', 'signature.dat', '-rawin',
+                      '-out', 'sm2.sig', '-rawin',
                       '-digest', 'sm3', '-pkeyopt', 'sm2_id:someid']))),
                       &quot;Sign a piece of data using SM2&quot;);
     ok_nofips(run(app(([ 'openssl', 'pkeyutl', '-verify', '-certin',
                       '-in', srctop_file('test', 'certs', 'sm2.pem'),
                       '-inkey', srctop_file('test', 'certs', 'sm2.pem'),
-                      '-sigfile', 'signature.dat', '-rawin',
+                      '-sigfile', 'sm2.sig', '-rawin',
                       '-digest', 'sm3', '-pkeyopt', 'sm2_id:someid']))),
                       &quot;Verify an SM2 signature against a piece of data&quot;);
 }
@@ -46,29 +47,27 @@ SKIP: {
     ok(run(app(([ 'openssl', 'pkeyutl', '-sign', '-in',
                   srctop_file('test', 'certs', 'server-ed25519-cert.pem'),
                   '-inkey', srctop_file('test', 'certs', 'server-ed25519-key.pem'),
-                  '-out', 'signature.dat', '-rawin']))),
+                  '-out', 'Ed25519.sig', '-rawin']))),
                   &quot;Sign a piece of data using Ed25519&quot;);
     ok(run(app(([ 'openssl', 'pkeyutl', '-verify', '-certin', '-in',
                   srctop_file('test', 'certs', 'server-ed25519-cert.pem'),
                   '-inkey', srctop_file('test', 'certs', 'server-ed25519-cert.pem'),
-                  '-sigfile', 'signature.dat', '-rawin']))),
+                  '-sigfile', 'Ed25519.sig', '-rawin']))),
                   &quot;Verify an Ed25519 signature against a piece of data&quot;);
 
     # Ed448
     ok(run(app(([ 'openssl', 'pkeyutl', '-sign', '-in',
                   srctop_file('test', 'certs', 'server-ed448-cert.pem'),
                   '-inkey', srctop_file('test', 'certs', 'server-ed448-key.pem'),
-                  '-out', 'signature.dat', '-rawin']))),
+                  '-out', 'Ed448.sig', '-rawin']))),
                   &quot;Sign a piece of data using Ed448&quot;);
     ok(run(app(([ 'openssl', 'pkeyutl', '-verify', '-certin', '-in',
                   srctop_file('test', 'certs', 'server-ed448-cert.pem'),
                   '-inkey', srctop_file('test', 'certs', 'server-ed448-cert.pem'),
-                  '-sigfile', 'signature.dat', '-rawin']))),
+                  '-sigfile', 'Ed448.sig', '-rawin']))),
                   &quot;Verify an Ed448 signature against a piece of data&quot;);
 }
 
-unlink 'signature.dat';
-
 sub tsignverify {
     my $testtext = shift;
     my $privkey = shift;
@@ -77,7 +76,7 @@ sub tsignverify {
 
     my $data_to_sign = srctop_file('test', 'README');
     my $other_data = srctop_file('test', 'README.external');
-    my $sigfile = 'testpkeyutl.sig';
+    my $sigfile = basename($privkey, '.pem') . '.sig';
 
     my @args = ();
     plan tests =&gt; 4;
@@ -113,8 +112,6 @@ sub tsignverify {
     push(@args, @extraopts);
     ok(!run(app([@args])),
        $testtext.&quot;: Expect failure verifying mismatching data&quot;);
-
-    unlink $sigfile;
 }
 
 SKIP: {
diff --git a/test/recipes/25-test_crl.t b/test/recipes/25-test_crl.t
index 50833d79fc..2dda361962 100644
--- a/test/recipes/25-test_crl.t
+++ b/test/recipes/25-test_crl.t
@@ -40,7 +40,6 @@ ok(run(app([&quot;openssl&quot;, &quot;crl&quot;, &quot;-text&quot;, &quot;-in&quot;, $pem, &quot;-out&quot;, $out,
             &quot;-nameopt&quot;, &quot;utf8&quot;])));
 is(cmp_text($out, srctop_file(&quot;test/certs&quot;, &quot;cyrillic_crl.utf8&quot;)),
    0, 'Comparing utf8 output');
-unlink $out;
 
 sub compare1stline {
     my ($cmdarray, $str) = @_;
diff --git a/test/recipes/25-test_req.t b/test/recipes/25-test_req.t
index 075c09db6d..1a6efa8be2 100644
--- a/test/recipes/25-test_req.t
+++ b/test/recipes/25-test_req.t
@@ -51,13 +51,13 @@ subtest &quot;generating certificate requests with RSA&quot; =&gt; sub {
 
         ok(run(app([&quot;openssl&quot;, &quot;req&quot;,
                     &quot;-config&quot;, srctop_file(&quot;test&quot;, &quot;test.cnf&quot;),
-                    &quot;-new&quot;, &quot;-out&quot;, &quot;testreq.pem&quot;, &quot;-utf8&quot;,
+                    &quot;-new&quot;, &quot;-out&quot;, &quot;testreq-rsa.pem&quot;, &quot;-utf8&quot;,
                     &quot;-key&quot;, srctop_file(&quot;test&quot;, &quot;testrsa.pem&quot;)])),
            &quot;Generating request&quot;);
 
         ok(run(app([&quot;openssl&quot;, &quot;req&quot;,
                     &quot;-config&quot;, srctop_file(&quot;test&quot;, &quot;test.cnf&quot;),
-                    &quot;-verify&quot;, &quot;-in&quot;, &quot;testreq.pem&quot;, &quot;-noout&quot;])),
+                    &quot;-verify&quot;, &quot;-in&quot;, &quot;testreq-rsa.pem&quot;, &quot;-noout&quot;])),
            &quot;Verifying signature on request&quot;);
     }
 };
@@ -71,13 +71,13 @@ subtest &quot;generating certificate requests with DSA&quot; =&gt; sub {
 
         ok(run(app([&quot;openssl&quot;, &quot;req&quot;,
                     &quot;-config&quot;, srctop_file(&quot;test&quot;, &quot;test.cnf&quot;),
-                    &quot;-new&quot;, &quot;-out&quot;, &quot;testreq.pem&quot;, &quot;-utf8&quot;,
+                    &quot;-new&quot;, &quot;-out&quot;, &quot;testreq-dsa.pem&quot;, &quot;-utf8&quot;,
                     &quot;-key&quot;, srctop_file(&quot;test&quot;, &quot;testdsa.pem&quot;)])),
            &quot;Generating request&quot;);
 
         ok(run(app([&quot;openssl&quot;, &quot;req&quot;,
                     &quot;-config&quot;, srctop_file(&quot;test&quot;, &quot;test.cnf&quot;),
-                    &quot;-verify&quot;, &quot;-in&quot;, &quot;testreq.pem&quot;, &quot;-noout&quot;])),
+                    &quot;-verify&quot;, &quot;-in&quot;, &quot;testreq-dsa.pem&quot;, &quot;-noout&quot;])),
            &quot;Verifying signature on request&quot;);
     }
 };
@@ -91,13 +91,13 @@ subtest &quot;generating certificate requests with ECDSA&quot; =&gt; sub {
 
         ok(run(app([&quot;openssl&quot;, &quot;req&quot;,
                     &quot;-config&quot;, srctop_file(&quot;test&quot;, &quot;test.cnf&quot;),
-                    &quot;-new&quot;, &quot;-out&quot;, &quot;testreq.pem&quot;, &quot;-utf8&quot;,
+                    &quot;-new&quot;, &quot;-out&quot;, &quot;testreq-ec.pem&quot;, &quot;-utf8&quot;,
                     &quot;-key&quot;, srctop_file(&quot;test&quot;, &quot;testec-p256.pem&quot;)])),
            &quot;Generating request&quot;);
 
         ok(run(app([&quot;openssl&quot;, &quot;req&quot;,
                     &quot;-config&quot;, srctop_file(&quot;test&quot;, &quot;test.cnf&quot;),
-                    &quot;-verify&quot;, &quot;-in&quot;, &quot;testreq.pem&quot;, &quot;-noout&quot;])),
+                    &quot;-verify&quot;, &quot;-in&quot;, &quot;testreq-ec.pem&quot;, &quot;-noout&quot;])),
            &quot;Verifying signature on request&quot;);
     }
 };
@@ -111,13 +111,13 @@ subtest &quot;generating certificate requests with Ed25519&quot; =&gt; sub {
 
         ok(run(app([&quot;openssl&quot;, &quot;req&quot;,
                     &quot;-config&quot;, srctop_file(&quot;test&quot;, &quot;test.cnf&quot;),
-                    &quot;-new&quot;, &quot;-out&quot;, &quot;testreq.pem&quot;, &quot;-utf8&quot;,
+                    &quot;-new&quot;, &quot;-out&quot;, &quot;testreq-ed25519.pem&quot;, &quot;-utf8&quot;,
                     &quot;-key&quot;, srctop_file(&quot;test&quot;, &quot;tested25519.pem&quot;)])),
            &quot;Generating request&quot;);
 
         ok(run(app([&quot;openssl&quot;, &quot;req&quot;,
                     &quot;-config&quot;, srctop_file(&quot;test&quot;, &quot;test.cnf&quot;),
-                    &quot;-verify&quot;, &quot;-in&quot;, &quot;testreq.pem&quot;, &quot;-noout&quot;])),
+                    &quot;-verify&quot;, &quot;-in&quot;, &quot;testreq-ed25519.pem&quot;, &quot;-noout&quot;])),
            &quot;Verifying signature on request&quot;);
     }
 };
@@ -131,13 +131,13 @@ subtest &quot;generating certificate requests with Ed448&quot; =&gt; sub {
 
         ok(run(app([&quot;openssl&quot;, &quot;req&quot;,
                     &quot;-config&quot;, srctop_file(&quot;test&quot;, &quot;test.cnf&quot;),
-                    &quot;-new&quot;, &quot;-out&quot;, &quot;testreq.pem&quot;, &quot;-utf8&quot;,
+                    &quot;-new&quot;, &quot;-out&quot;, &quot;testreq-ed448.pem&quot;, &quot;-utf8&quot;,
                     &quot;-key&quot;, srctop_file(&quot;test&quot;, &quot;tested448.pem&quot;)])),
            &quot;Generating request&quot;);
 
         ok(run(app([&quot;openssl&quot;, &quot;req&quot;,
                     &quot;-config&quot;, srctop_file(&quot;test&quot;, &quot;test.cnf&quot;),
-                    &quot;-verify&quot;, &quot;-in&quot;, &quot;testreq.pem&quot;, &quot;-noout&quot;])),
+                    &quot;-verify&quot;, &quot;-in&quot;, &quot;testreq-ed448.pem&quot;, &quot;-noout&quot;])),
            &quot;Verifying signature on request&quot;);
     }
 };
@@ -164,12 +164,12 @@ subtest &quot;generating SM2 certificate requests&quot; =&gt; sub {
                     &quot;-config&quot;, srctop_file(&quot;test&quot;, &quot;test.cnf&quot;),
                     &quot;-new&quot;, &quot;-key&quot;, srctop_file(&quot;test&quot;, &quot;certs&quot;, &quot;sm2.key&quot;),
                     &quot;-sigopt&quot;, &quot;sm2_id:1234567812345678&quot;,
-                    &quot;-out&quot;, &quot;testreq.pem&quot;, &quot;-sm3&quot;])),
+                    &quot;-out&quot;, &quot;testreq-sm2.pem&quot;, &quot;-sm3&quot;])),
            &quot;Generating SM2 certificate request&quot;);
 
         ok(run(app([&quot;openssl&quot;, &quot;req&quot;,
                     &quot;-config&quot;, srctop_file(&quot;test&quot;, &quot;test.cnf&quot;),
-                    &quot;-verify&quot;, &quot;-in&quot;, &quot;testreq.pem&quot;, &quot;-noout&quot;,
+                    &quot;-verify&quot;, &quot;-in&quot;, &quot;testreq-sm2.pem&quot;, &quot;-noout&quot;,
                     &quot;-sm2-id&quot;, &quot;1234567812345678&quot;, &quot;-sm3&quot;])),
            &quot;Verifying signature on SM2 certificate request&quot;);
 
@@ -177,12 +177,12 @@ subtest &quot;generating SM2 certificate requests&quot; =&gt; sub {
                     &quot;-config&quot;, srctop_file(&quot;test&quot;, &quot;test.cnf&quot;),
                     &quot;-new&quot;, &quot;-key&quot;, srctop_file(&quot;test&quot;, &quot;certs&quot;, &quot;sm2.key&quot;),
                     &quot;-sigopt&quot;, &quot;sm2_hex_id:DEADBEEF&quot;,
-                    &quot;-out&quot;, &quot;testreq.pem&quot;, &quot;-sm3&quot;])),
+                    &quot;-out&quot;, &quot;testreq-sm2.pem&quot;, &quot;-sm3&quot;])),
            &quot;Generating SM2 certificate request with hex id&quot;);
 
         ok(run(app([&quot;openssl&quot;, &quot;req&quot;,
                     &quot;-config&quot;, srctop_file(&quot;test&quot;, &quot;test.cnf&quot;),
-                    &quot;-verify&quot;, &quot;-in&quot;, &quot;testreq.pem&quot;, &quot;-noout&quot;,
+                    &quot;-verify&quot;, &quot;-in&quot;, &quot;testreq-sm2.pem&quot;, &quot;-noout&quot;,
                     &quot;-sm2-hex-id&quot;, &quot;DEADBEEF&quot;, &quot;-sm3&quot;])),
            &quot;Verifying signature on SM2 certificate request&quot;);
     }
@@ -195,8 +195,6 @@ run_conversion('req conversions',
 run_conversion('req conversions -- testreq2',
                srctop_file(&quot;test&quot;, &quot;testreq2.pem&quot;));
 
-unlink &quot;testkey.pem&quot;, &quot;testreq.pem&quot;;
-
 sub run_conversion {
     my $title = shift;
     my $reqfile = shift;
diff --git a/test/recipes/25-test_x509.t b/test/recipes/25-test_x509.t
index 4780247ea0..7ecdc02742 100644
--- a/test/recipes/25-test_x509.t
+++ b/test/recipes/25-test_x509.t
@@ -21,19 +21,19 @@ plan tests =&gt; 10;
 require_ok(srctop_file('test','recipes','tconversion.pl'));
 
 my $pem = srctop_file(&quot;test/certs&quot;, &quot;cyrillic.pem&quot;);
-my $out = &quot;cyrillic.out&quot;;
+my $out_msb = &quot;out-cyrillic.msb&quot;;
+my $out_utf8 = &quot;out-cyrillic.utf8&quot;;
 my $msb = srctop_file(&quot;test/certs&quot;, &quot;cyrillic.msb&quot;);
 my $utf = srctop_file(&quot;test/certs&quot;, &quot;cyrillic.utf8&quot;);
 
-ok(run(app([&quot;openssl&quot;, &quot;x509&quot;, &quot;-text&quot;, &quot;-in&quot;, $pem, &quot;-out&quot;, $out,
+ok(run(app([&quot;openssl&quot;, &quot;x509&quot;, &quot;-text&quot;, &quot;-in&quot;, $pem, &quot;-out&quot;, $out_msb,
             &quot;-nameopt&quot;, &quot;esc_msb&quot;])));
-is(cmp_text($out, srctop_file(&quot;test/certs&quot;, &quot;cyrillic.msb&quot;)),
+is(cmp_text($out_msb, srctop_file(&quot;test/certs&quot;, &quot;cyrillic.msb&quot;)),
    0, 'Comparing esc_msb output');
-ok(run(app([&quot;openssl&quot;, &quot;x509&quot;, &quot;-text&quot;, &quot;-in&quot;, $pem, &quot;-out&quot;, $out,
+ok(run(app([&quot;openssl&quot;, &quot;x509&quot;, &quot;-text&quot;, &quot;-in&quot;, $pem, &quot;-out&quot;, $out_utf8,
             &quot;-nameopt&quot;, &quot;utf8&quot;])));
-is(cmp_text($out, srctop_file(&quot;test/certs&quot;, &quot;cyrillic.utf8&quot;)),
+is(cmp_text($out_utf8, srctop_file(&quot;test/certs&quot;, &quot;cyrillic.utf8&quot;)),
    0, 'Comparing utf8 output');
-unlink $out;
 
 SKIP: {
     skip &quot;EC disabled&quot;, 1 if disabled(&quot;ec&quot;);
@@ -54,8 +54,6 @@ SKIP: {
        &amp;&amp;
        run(app([&quot;openssl&quot;, &quot;verify&quot;, &quot;-no_check_time&quot;,
                 &quot;-trusted&quot;, $selfout, $testcert])));
-    unlink $pubkey;
-    unlink $selfout;
 }
 
 subtest 'x509 -- x.509 v1 certificate' =&gt; sub {
diff --git a/test/recipes/80-test_ca.t b/test/recipes/80-test_ca.t
index 483b1f5ec6..c01bc389fa 100644
--- a/test/recipes/80-test_ca.t
+++ b/test/recipes/80-test_ca.t
@@ -68,10 +68,6 @@ SKIP: {
        &quot;Signing SM2 certificate request&quot;);
 }
 
-rmtree(&quot;demoCA&quot;, { safe =&gt; 0 });
-unlink &quot;newcert.pem&quot;, &quot;newreq.pem&quot;, &quot;newkey.pem&quot;, &quot;sm2-test.crt&quot;;
-
-
 sub yes {
     my $cntr = 10;
     open(PIPE, &quot;|-&quot;, join(&quot; &quot;<A HREF="../../../mailman/listinfo/openssl-commits.html">, at _</A>));
diff --git a/test/recipes/80-test_cms.t b/test/recipes/80-test_cms.t
index 868affc545..ee227f3cdb 100644
--- a/test/recipes/80-test_cms.t
+++ b/test/recipes/80-test_cms.t
@@ -32,150 +32,170 @@ plan tests =&gt; 6;
 my @smime_pkcs7_tests = (
 
     [ &quot;signed content DER format, RSA key&quot;,
-      [ &quot;-sign&quot;, &quot;-in&quot;, $smcont, &quot;-outform&quot;, &quot;DER&quot;, &quot;-nodetach&quot;,
-	&quot;-certfile&quot;, catfile($smdir, &quot;smroot.pem&quot;),
-	&quot;-signer&quot;, catfile($smdir, &quot;smrsa1.pem&quot;), &quot;-out&quot;, &quot;test.cms&quot; ],
-      [ &quot;-verify&quot;, &quot;-in&quot;, &quot;test.cms&quot;, &quot;-inform&quot;, &quot;DER&quot;,
-	&quot;-CAfile&quot;, catfile($smdir, &quot;smroot.pem&quot;), &quot;-out&quot;, &quot;smtst.txt&quot; ]
+      [ &quot;{cmd1}&quot;, &quot;-sign&quot;, &quot;-in&quot;, $smcont, &quot;-outform&quot;, &quot;DER&quot;, &quot;-nodetach&quot;,
+        &quot;-certfile&quot;, catfile($smdir, &quot;smroot.pem&quot;),
+        &quot;-signer&quot;, catfile($smdir, &quot;smrsa1.pem&quot;), &quot;-out&quot;, &quot;{output}.cms&quot; ],
+      [ &quot;{cmd2}&quot;, &quot;-verify&quot;, &quot;-in&quot;, &quot;{output}.cms&quot;, &quot;-inform&quot;, &quot;DER&quot;,
+        &quot;-CAfile&quot;, catfile($smdir, &quot;smroot.pem&quot;), &quot;-out&quot;, &quot;{output}.txt&quot; ],
+      \&amp;final_compare
     ],
 
     [ &quot;signed detached content DER format, RSA key&quot;,
-      [ &quot;-sign&quot;, &quot;-in&quot;, $smcont, &quot;-outform&quot;, &quot;DER&quot;,
-	&quot;-signer&quot;, catfile($smdir, &quot;smrsa1.pem&quot;), &quot;-out&quot;, &quot;test.cms&quot; ],
-      [ &quot;-verify&quot;, &quot;-in&quot;, &quot;test.cms&quot;, &quot;-inform&quot;, &quot;DER&quot;,
-	&quot;-CAfile&quot;, catfile($smdir, &quot;smroot.pem&quot;), &quot;-out&quot;, &quot;smtst.txt&quot;,
-	&quot;-content&quot;, $smcont ]
+      [ &quot;{cmd1}&quot;, &quot;-sign&quot;, &quot;-in&quot;, $smcont, &quot;-outform&quot;, &quot;DER&quot;,
+        &quot;-signer&quot;, catfile($smdir, &quot;smrsa1.pem&quot;), &quot;-out&quot;, &quot;{output}.cms&quot; ],
+      [ &quot;{cmd2}&quot;, &quot;-verify&quot;, &quot;-in&quot;, &quot;{output}.cms&quot;, &quot;-inform&quot;, &quot;DER&quot;,
+        &quot;-CAfile&quot;, catfile($smdir, &quot;smroot.pem&quot;), &quot;-out&quot;, &quot;{output}.txt&quot;,
+        &quot;-content&quot;, $smcont ],
+      \&amp;final_compare
     ],
 
     [ &quot;signed content test streaming BER format, RSA&quot;,
-      [ &quot;-sign&quot;, &quot;-in&quot;, $smcont, &quot;-outform&quot;, &quot;DER&quot;, &quot;-nodetach&quot;,
-	&quot;-stream&quot;,
-	&quot;-signer&quot;, catfile($smdir, &quot;smrsa1.pem&quot;), &quot;-out&quot;, &quot;test.cms&quot; ],
-      [ &quot;-verify&quot;, &quot;-in&quot;, &quot;test.cms&quot;, &quot;-inform&quot;, &quot;DER&quot;,
-	&quot;-CAfile&quot;, catfile($smdir, &quot;smroot.pem&quot;), &quot;-out&quot;, &quot;smtst.txt&quot; ]
+      [ &quot;{cmd1}&quot;, &quot;-sign&quot;, &quot;-in&quot;, $smcont, &quot;-outform&quot;, &quot;DER&quot;, &quot;-nodetach&quot;,
+        &quot;-stream&quot;,
+        &quot;-signer&quot;, catfile($smdir, &quot;smrsa1.pem&quot;), &quot;-out&quot;, &quot;{output}.cms&quot; ],
+      [ &quot;{cmd2}&quot;, &quot;-verify&quot;, &quot;-in&quot;, &quot;{output}.cms&quot;, &quot;-inform&quot;, &quot;DER&quot;,
+        &quot;-CAfile&quot;, catfile($smdir, &quot;smroot.pem&quot;), &quot;-out&quot;, &quot;{output}.txt&quot; ],
+      \&amp;final_compare
     ],
 
     [ &quot;signed content DER format, DSA key&quot;,
-      [ &quot;-sign&quot;, &quot;-in&quot;, $smcont, &quot;-outform&quot;, &quot;DER&quot;, &quot;-nodetach&quot;,
-	&quot;-signer&quot;, catfile($smdir, &quot;smdsa1.pem&quot;), &quot;-out&quot;, &quot;test.cms&quot; ],
-      [ &quot;-verify&quot;, &quot;-in&quot;, &quot;test.cms&quot;, &quot;-inform&quot;, &quot;DER&quot;,
-	&quot;-CAfile&quot;, catfile($smdir, &quot;smroot.pem&quot;), &quot;-out&quot;, &quot;smtst.txt&quot; ]
+      [ &quot;{cmd1}&quot;, &quot;-sign&quot;, &quot;-in&quot;, $smcont, &quot;-outform&quot;, &quot;DER&quot;, &quot;-nodetach&quot;,
+        &quot;-signer&quot;, catfile($smdir, &quot;smdsa1.pem&quot;), &quot;-out&quot;, &quot;{output}.cms&quot; ],
+      [ &quot;{cmd2}&quot;, &quot;-verify&quot;, &quot;-in&quot;, &quot;{output}.cms&quot;, &quot;-inform&quot;, &quot;DER&quot;,
+        &quot;-CAfile&quot;, catfile($smdir, &quot;smroot.pem&quot;), &quot;-out&quot;, &quot;{output}.txt&quot; ],
+      \&amp;final_compare
     ],
 
     [ &quot;signed detached content DER format, DSA key&quot;,
-      [ &quot;-sign&quot;, &quot;-in&quot;, $smcont, &quot;-outform&quot;, &quot;DER&quot;,
-	&quot;-signer&quot;, catfile($smdir, &quot;smdsa1.pem&quot;), &quot;-out&quot;, &quot;test.cms&quot; ],
-      [ &quot;-verify&quot;, &quot;-in&quot;, &quot;test.cms&quot;, &quot;-inform&quot;, &quot;DER&quot;,
-	&quot;-CAfile&quot;, catfile($smdir, &quot;smroot.pem&quot;), &quot;-out&quot;, &quot;smtst.txt&quot;,
-	&quot;-content&quot;, $smcont ]
+      [ &quot;{cmd1}&quot;, &quot;-sign&quot;, &quot;-in&quot;, $smcont, &quot;-outform&quot;, &quot;DER&quot;,
+        &quot;-signer&quot;, catfile($smdir, &quot;smdsa1.pem&quot;), &quot;-out&quot;, &quot;{output}.cms&quot; ],
+      [ &quot;{cmd2}&quot;, &quot;-verify&quot;, &quot;-in&quot;, &quot;{output}.cms&quot;, &quot;-inform&quot;, &quot;DER&quot;,
+        &quot;-CAfile&quot;, catfile($smdir, &quot;smroot.pem&quot;), &quot;-out&quot;, &quot;{output}.txt&quot;,
+        &quot;-content&quot;, $smcont ],
+      \&amp;final_compare
     ],
 
     [ &quot;signed detached content DER format, add RSA signer (with DSA existing)&quot;,
-      [ &quot;-resign&quot;, &quot;-inform&quot;, &quot;DER&quot;, &quot;-in&quot;, &quot;test.cms&quot;, &quot;-outform&quot;, &quot;DER&quot;,
-	&quot;-signer&quot;, catfile($smdir, &quot;smrsa1.pem&quot;), &quot;-out&quot;, &quot;test2.cms&quot; ],
-      [ &quot;-verify&quot;, &quot;-in&quot;, &quot;test2.cms&quot;, &quot;-inform&quot;, &quot;DER&quot;,
-	&quot;-CAfile&quot;, catfile($smdir, &quot;smroot.pem&quot;), &quot;-out&quot;, &quot;smtst.txt&quot;,
-	&quot;-content&quot;, $smcont ]
+      [ &quot;{cmd1}&quot;, &quot;-sign&quot;, &quot;-in&quot;, $smcont, &quot;-outform&quot;, &quot;DER&quot;,
+        &quot;-signer&quot;, catfile($smdir, &quot;smdsa1.pem&quot;), &quot;-out&quot;, &quot;{output}.cms&quot; ],
+      [ &quot;{cmd1}&quot;, &quot;-resign&quot;, &quot;-in&quot;, &quot;{output}.cms&quot;, &quot;-inform&quot;, &quot;DER&quot;, &quot;-outform&quot;, &quot;DER&quot;,
+        &quot;-signer&quot;, catfile($smdir, &quot;smrsa1.pem&quot;), &quot;-out&quot;, &quot;{output}2.cms&quot; ],
+      [ &quot;{cmd2}&quot;, &quot;-verify&quot;, &quot;-in&quot;, &quot;{output}2.cms&quot;, &quot;-inform&quot;, &quot;DER&quot;,
+        &quot;-CAfile&quot;, catfile($smdir, &quot;smroot.pem&quot;), &quot;-out&quot;, &quot;{output}.txt&quot;,
+        &quot;-content&quot;, $smcont ],
+      \&amp;final_compare
     ],
 
     [ &quot;signed content test streaming BER format, DSA key&quot;,
-      [ &quot;-sign&quot;, &quot;-in&quot;, $smcont, &quot;-outform&quot;, &quot;DER&quot;, &quot;-nodetach&quot;,
-	&quot;-stream&quot;,
-	&quot;-signer&quot;, catfile($smdir, &quot;smdsa1.pem&quot;), &quot;-out&quot;, &quot;test.cms&quot; ],
-      [ &quot;-verify&quot;, &quot;-in&quot;, &quot;test.cms&quot;, &quot;-inform&quot;, &quot;DER&quot;,
-	&quot;-CAfile&quot;, catfile($smdir, &quot;smroot.pem&quot;), &quot;-out&quot;, &quot;smtst.txt&quot; ]
+      [ &quot;{cmd1}&quot;, &quot;-sign&quot;, &quot;-in&quot;, $smcont, &quot;-outform&quot;, &quot;DER&quot;,
+        &quot;-nodetach&quot;, &quot;-stream&quot;,
+        &quot;-signer&quot;, catfile($smdir, &quot;smdsa1.pem&quot;), &quot;-out&quot;, &quot;{output}.cms&quot; ],
+      [ &quot;{cmd2}&quot;, &quot;-verify&quot;, &quot;-in&quot;, &quot;{output}.cms&quot;, &quot;-inform&quot;, &quot;DER&quot;,
+        &quot;-CAfile&quot;, catfile($smdir, &quot;smroot.pem&quot;), &quot;-out&quot;, &quot;{output}.txt&quot; ],
+      \&amp;final_compare
     ],
 
     [ &quot;signed content test streaming BER format, 2 DSA and 2 RSA keys&quot;,
-      [ &quot;-sign&quot;, &quot;-in&quot;, $smcont, &quot;-outform&quot;, &quot;DER&quot;, &quot;-nodetach&quot;,
-	&quot;-signer&quot;, catfile($smdir, &quot;smrsa1.pem&quot;),
-	&quot;-signer&quot;, catfile($smdir, &quot;smrsa2.pem&quot;),
-	&quot;-signer&quot;, catfile($smdir, &quot;smdsa1.pem&quot;),
-	&quot;-signer&quot;, catfile($smdir, &quot;smdsa2.pem&quot;),
-	&quot;-stream&quot;, &quot;-out&quot;, &quot;test.cms&quot; ],
-      [ &quot;-verify&quot;, &quot;-in&quot;, &quot;test.cms&quot;, &quot;-inform&quot;, &quot;DER&quot;,
-	&quot;-CAfile&quot;, catfile($smdir, &quot;smroot.pem&quot;), &quot;-out&quot;, &quot;smtst.txt&quot; ]
+      [ &quot;{cmd1}&quot;, &quot;-sign&quot;, &quot;-in&quot;, $smcont, &quot;-outform&quot;, &quot;DER&quot;,
+        &quot;-nodetach&quot;, &quot;-stream&quot;,
+        &quot;-signer&quot;, catfile($smdir, &quot;smrsa1.pem&quot;),
+        &quot;-signer&quot;, catfile($smdir, &quot;smrsa2.pem&quot;),
+        &quot;-signer&quot;, catfile($smdir, &quot;smdsa1.pem&quot;),
+        &quot;-signer&quot;, catfile($smdir, &quot;smdsa2.pem&quot;),
+        &quot;-out&quot;, &quot;{output}.cms&quot; ],
+      [ &quot;{cmd2}&quot;, &quot;-verify&quot;, &quot;-in&quot;, &quot;{output}.cms&quot;, &quot;-inform&quot;, &quot;DER&quot;,
+        &quot;-CAfile&quot;, catfile($smdir, &quot;smroot.pem&quot;), &quot;-out&quot;, &quot;{output}.txt&quot; ],
+      \&amp;final_compare
     ],
 
     [ &quot;signed content test streaming BER format, 2 DSA and 2 RSA keys, no attributes&quot;,
-      [ &quot;-sign&quot;, &quot;-in&quot;, $smcont, &quot;-outform&quot;, &quot;DER&quot;, &quot;-noattr&quot;, &quot;-nodetach&quot;,
-	&quot;-signer&quot;, catfile($smdir, &quot;smrsa1.pem&quot;),
-	&quot;-signer&quot;, catfile($smdir, &quot;smrsa2.pem&quot;),
-	&quot;-signer&quot;, catfile($smdir, &quot;smdsa1.pem&quot;),
-	&quot;-signer&quot;, catfile($smdir, &quot;smdsa2.pem&quot;),
-	&quot;-stream&quot;, &quot;-out&quot;, &quot;test.cms&quot; ],
-      [ &quot;-verify&quot;, &quot;-in&quot;, &quot;test.cms&quot;, &quot;-inform&quot;, &quot;DER&quot;,
-	&quot;-CAfile&quot;, catfile($smdir, &quot;smroot.pem&quot;), &quot;-out&quot;, &quot;smtst.txt&quot; ]
+      [ &quot;{cmd1}&quot;, &quot;-sign&quot;, &quot;-in&quot;, $smcont, &quot;-outform&quot;, &quot;DER&quot;,
+        &quot;-noattr&quot;, &quot;-nodetach&quot;, &quot;-stream&quot;,
+        &quot;-signer&quot;, catfile($smdir, &quot;smrsa1.pem&quot;),
+        &quot;-signer&quot;, catfile($smdir, &quot;smrsa2.pem&quot;),
+        &quot;-signer&quot;, catfile($smdir, &quot;smdsa1.pem&quot;),
+        &quot;-signer&quot;, catfile($smdir, &quot;smdsa2.pem&quot;),
+        &quot;-out&quot;, &quot;{output}.cms&quot; ],
+      [ &quot;{cmd2}&quot;, &quot;-verify&quot;, &quot;-in&quot;, &quot;{output}.cms&quot;, &quot;-inform&quot;, &quot;DER&quot;,
+        &quot;-CAfile&quot;, catfile($smdir, &quot;smroot.pem&quot;), &quot;-out&quot;, &quot;{output}.txt&quot; ],
+      \&amp;final_compare
     ],
 
     [ &quot;signed content S/MIME format, RSA key SHA1&quot;,
-      [ &quot;-sign&quot;, &quot;-in&quot;, $smcont, &quot;-md&quot;, &quot;sha1&quot;,
-	&quot;-certfile&quot;, catfile($smdir, &quot;smroot.pem&quot;),
-	&quot;-signer&quot;, catfile($smdir, &quot;smrsa1.pem&quot;), &quot;-out&quot;, &quot;test.cms&quot; ],
-      [ &quot;-verify&quot;, &quot;-in&quot;, &quot;test.cms&quot;,
-	&quot;-CAfile&quot;, catfile($smdir, &quot;smroot.pem&quot;), &quot;-out&quot;, &quot;smtst.txt&quot; ]
+      [ &quot;{cmd1}&quot;, &quot;-sign&quot;, &quot;-in&quot;, $smcont, &quot;-md&quot;, &quot;sha1&quot;,
+        &quot;-certfile&quot;, catfile($smdir, &quot;smroot.pem&quot;),
+        &quot;-signer&quot;, catfile($smdir, &quot;smrsa1.pem&quot;), &quot;-out&quot;, &quot;{output}.cms&quot; ],
+      [ &quot;{cmd2}&quot;, &quot;-verify&quot;, &quot;-in&quot;, &quot;{output}.cms&quot;,
+        &quot;-CAfile&quot;, catfile($smdir, &quot;smroot.pem&quot;), &quot;-out&quot;, &quot;{output}.txt&quot; ],
+      \&amp;final_compare
     ],
 
     [ &quot;signed content test streaming S/MIME format, 2 DSA and 2 RSA keys&quot;,
-      [ &quot;-sign&quot;, &quot;-in&quot;, $smcont, &quot;-nodetach&quot;,
-	&quot;-signer&quot;, catfile($smdir, &quot;smrsa1.pem&quot;),
-	&quot;-signer&quot;, catfile($smdir, &quot;smrsa2.pem&quot;),
-	&quot;-signer&quot;, catfile($smdir, &quot;smdsa1.pem&quot;),
-	&quot;-signer&quot;, catfile($smdir, &quot;smdsa2.pem&quot;),
-	&quot;-stream&quot;, &quot;-out&quot;, &quot;test.cms&quot; ],
-      [ &quot;-verify&quot;, &quot;-in&quot;, &quot;test.cms&quot;,
-	&quot;-CAfile&quot;, catfile($smdir, &quot;smroot.pem&quot;), &quot;-out&quot;, &quot;smtst.txt&quot; ]
+      [ &quot;{cmd1}&quot;, &quot;-sign&quot;, &quot;-in&quot;, $smcont, &quot;-nodetach&quot;,
+        &quot;-signer&quot;, catfile($smdir, &quot;smrsa1.pem&quot;),
+        &quot;-signer&quot;, catfile($smdir, &quot;smrsa2.pem&quot;),
+        &quot;-signer&quot;, catfile($smdir, &quot;smdsa1.pem&quot;),
+        &quot;-signer&quot;, catfile($smdir, &quot;smdsa2.pem&quot;),
+        &quot;-stream&quot;, &quot;-out&quot;, &quot;{output}.cms&quot; ],
+      [ &quot;{cmd2}&quot;, &quot;-verify&quot;, &quot;-in&quot;, &quot;{output}.cms&quot;,
+        &quot;-CAfile&quot;, catfile($smdir, &quot;smroot.pem&quot;), &quot;-out&quot;, &quot;{output}.txt&quot; ],
+      \&amp;final_compare
     ],
 
     [ &quot;signed content test streaming multipart S/MIME format, 2 DSA and 2 RSA keys&quot;,
-      [ &quot;-sign&quot;, &quot;-in&quot;, $smcont,
-	&quot;-signer&quot;, catfile($smdir, &quot;smrsa1.pem&quot;),
-	&quot;-signer&quot;, catfile($smdir, &quot;smrsa2.pem&quot;),
-	&quot;-signer&quot;, catfile($smdir, &quot;smdsa1.pem&quot;),
-	&quot;-signer&quot;, catfile($smdir, &quot;smdsa2.pem&quot;),
-	&quot;-stream&quot;, &quot;-out&quot;, &quot;test.cms&quot; ],
-      [ &quot;-verify&quot;, &quot;-in&quot;, &quot;test.cms&quot;,
-	&quot;-CAfile&quot;, catfile($smdir, &quot;smroot.pem&quot;), &quot;-out&quot;, &quot;smtst.txt&quot; ]
+      [ &quot;{cmd1}&quot;, &quot;-sign&quot;, &quot;-in&quot;, $smcont,
+        &quot;-signer&quot;, catfile($smdir, &quot;smrsa1.pem&quot;),
+        &quot;-signer&quot;, catfile($smdir, &quot;smrsa2.pem&quot;),
+        &quot;-signer&quot;, catfile($smdir, &quot;smdsa1.pem&quot;),
+        &quot;-signer&quot;, catfile($smdir, &quot;smdsa2.pem&quot;),
+        &quot;-stream&quot;, &quot;-out&quot;, &quot;{output}.cms&quot; ],
+      [ &quot;{cmd2}&quot;, &quot;-verify&quot;, &quot;-in&quot;, &quot;{output}.cms&quot;,
+        &quot;-CAfile&quot;, catfile($smdir, &quot;smroot.pem&quot;), &quot;-out&quot;, &quot;{output}.txt&quot; ],
+      \&amp;final_compare
     ],
 
     [ &quot;enveloped content test streaming S/MIME format, DES, 3 recipients&quot;,
-      [ &quot;-encrypt&quot;, &quot;-in&quot;, $smcont,
-	&quot;-stream&quot;, &quot;-out&quot;, &quot;test.cms&quot;,
-	catfile($smdir, &quot;smrsa1.pem&quot;),
-	catfile($smdir, &quot;smrsa2.pem&quot;),
-	catfile($smdir, &quot;smrsa3.pem&quot;) ],
-      [ &quot;-decrypt&quot;, &quot;-recip&quot;, catfile($smdir, &quot;smrsa1.pem&quot;),
-	&quot;-in&quot;, &quot;test.cms&quot;, &quot;-out&quot;, &quot;smtst.txt&quot; ]
+      [ &quot;{cmd1}&quot;, &quot;-encrypt&quot;, &quot;-in&quot;, $smcont,
+        &quot;-stream&quot;, &quot;-out&quot;, &quot;{output}.cms&quot;,
+        catfile($smdir, &quot;smrsa1.pem&quot;),
+        catfile($smdir, &quot;smrsa2.pem&quot;),
+        catfile($smdir, &quot;smrsa3.pem&quot;) ],
+      [ &quot;{cmd2}&quot;, &quot;-decrypt&quot;, &quot;-recip&quot;, catfile($smdir, &quot;smrsa1.pem&quot;),
+        &quot;-in&quot;, &quot;{output}.cms&quot;, &quot;-out&quot;, &quot;{output}.txt&quot; ],
+      \&amp;final_compare
     ],
 
     [ &quot;enveloped content test streaming S/MIME format, DES, 3 recipients, 3rd used&quot;,
-      [ &quot;-encrypt&quot;, &quot;-in&quot;, $smcont,
-	&quot;-stream&quot;, &quot;-out&quot;, &quot;test.cms&quot;,
-	catfile($smdir, &quot;smrsa1.pem&quot;),
-	catfile($smdir, &quot;smrsa2.pem&quot;),
-	catfile($smdir, &quot;smrsa3.pem&quot;) ],
-      [ &quot;-decrypt&quot;, &quot;-recip&quot;, catfile($smdir, &quot;smrsa3.pem&quot;),
-	&quot;-in&quot;, &quot;test.cms&quot;, &quot;-out&quot;, &quot;smtst.txt&quot; ]
+      [ &quot;{cmd1}&quot;, &quot;-encrypt&quot;, &quot;-in&quot;, $smcont,
+        &quot;-stream&quot;, &quot;-out&quot;, &quot;{output}.cms&quot;,
+        catfile($smdir, &quot;smrsa1.pem&quot;),
+        catfile($smdir, &quot;smrsa2.pem&quot;),
+        catfile($smdir, &quot;smrsa3.pem&quot;) ],
+      [ &quot;{cmd2}&quot;, &quot;-decrypt&quot;, &quot;-recip&quot;, catfile($smdir, &quot;smrsa3.pem&quot;),
+        &quot;-in&quot;, &quot;{output}.cms&quot;, &quot;-out&quot;, &quot;{output}.txt&quot; ],
+      \&amp;final_compare
     ],
 
     [ &quot;enveloped content test streaming S/MIME format, DES, 3 recipients, key only used&quot;,
-      [ &quot;-encrypt&quot;, &quot;-in&quot;, $smcont,
-	&quot;-stream&quot;, &quot;-out&quot;, &quot;test.cms&quot;,
-	catfile($smdir, &quot;smrsa1.pem&quot;),
-	catfile($smdir, &quot;smrsa2.pem&quot;),
-	catfile($smdir, &quot;smrsa3.pem&quot;) ],
-      [ &quot;-decrypt&quot;, &quot;-inkey&quot;, catfile($smdir, &quot;smrsa3.pem&quot;),
-	&quot;-in&quot;, &quot;test.cms&quot;, &quot;-out&quot;, &quot;smtst.txt&quot; ]
+      [ &quot;{cmd1}&quot;, &quot;-encrypt&quot;, &quot;-in&quot;, $smcont,
+        &quot;-stream&quot;, &quot;-out&quot;, &quot;{output}.cms&quot;,
+        catfile($smdir, &quot;smrsa1.pem&quot;),
+        catfile($smdir, &quot;smrsa2.pem&quot;),
+        catfile($smdir, &quot;smrsa3.pem&quot;) ],
+      [ &quot;{cmd2}&quot;, &quot;-decrypt&quot;, &quot;-inkey&quot;, catfile($smdir, &quot;smrsa3.pem&quot;),
+        &quot;-in&quot;, &quot;{output}.cms&quot;, &quot;-out&quot;, &quot;{output}.txt&quot; ],
+      \&amp;final_compare
     ],
 
     [ &quot;enveloped content test streaming S/MIME format, AES-256 cipher, 3 recipients&quot;,
-      [ &quot;-encrypt&quot;, &quot;-in&quot;, $smcont,
-	&quot;-aes256&quot;, &quot;-stream&quot;, &quot;-out&quot;, &quot;test.cms&quot;,
-	catfile($smdir, &quot;smrsa1.pem&quot;),
-	catfile($smdir, &quot;smrsa2.pem&quot;),
-	catfile($smdir, &quot;smrsa3.pem&quot;) ],
-      [ &quot;-decrypt&quot;, &quot;-recip&quot;, catfile($smdir, &quot;smrsa1.pem&quot;),
-	&quot;-in&quot;, &quot;test.cms&quot;, &quot;-out&quot;, &quot;smtst.txt&quot; ]
+      [ &quot;{cmd1}&quot;, &quot;-encrypt&quot;, &quot;-in&quot;, $smcont,
+        &quot;-aes256&quot;, &quot;-stream&quot;, &quot;-out&quot;, &quot;{output}.cms&quot;,
+        catfile($smdir, &quot;smrsa1.pem&quot;),
+        catfile($smdir, &quot;smrsa2.pem&quot;),
+        catfile($smdir, &quot;smrsa3.pem&quot;) ],
+      [ &quot;{cmd2}&quot;, &quot;-decrypt&quot;, &quot;-recip&quot;, catfile($smdir, &quot;smrsa1.pem&quot;),
+        &quot;-in&quot;, &quot;{output}.cms&quot;, &quot;-out&quot;, &quot;{output}.txt&quot; ],
+      \&amp;final_compare
     ],
 
 );
@@ -183,125 +203,154 @@ my @smime_pkcs7_tests = (
 my @smime_cms_tests = (
 
     [ &quot;signed content test streaming BER format, 2 DSA and 2 RSA keys, keyid&quot;,
-      [ &quot;-sign&quot;, &quot;-in&quot;, $smcont, &quot;-outform&quot;, &quot;DER&quot;, &quot;-nodetach&quot;, &quot;-keyid&quot;,
-	&quot;-signer&quot;, catfile($smdir, &quot;smrsa1.pem&quot;),
-	&quot;-signer&quot;, catfile($smdir, &quot;smrsa2.pem&quot;),
-	&quot;-signer&quot;, catfile($smdir, &quot;smdsa1.pem&quot;),
-	&quot;-signer&quot;, catfile($smdir, &quot;smdsa2.pem&quot;),
-	&quot;-stream&quot;, &quot;-out&quot;, &quot;test.cms&quot; ],
-      [ &quot;-verify&quot;, &quot;-in&quot;, &quot;test.cms&quot;, &quot;-inform&quot;, &quot;DER&quot;,
-	&quot;-CAfile&quot;, catfile($smdir, &quot;smroot.pem&quot;), &quot;-out&quot;, &quot;smtst.txt&quot; ]
+      [ &quot;{cmd1}&quot;, &quot;-sign&quot;, &quot;-in&quot;, $smcont, &quot;-outform&quot;, &quot;DER&quot;,
+        &quot;-nodetach&quot;, &quot;-keyid&quot;,
+        &quot;-signer&quot;, catfile($smdir, &quot;smrsa1.pem&quot;),
+        &quot;-signer&quot;, catfile($smdir, &quot;smrsa2.pem&quot;),
+        &quot;-signer&quot;, catfile($smdir, &quot;smdsa1.pem&quot;),
+        &quot;-signer&quot;, catfile($smdir, &quot;smdsa2.pem&quot;),
+        &quot;-stream&quot;, &quot;-out&quot;, &quot;{output}.cms&quot; ],
+      [ &quot;{cmd2}&quot;, &quot;-verify&quot;, &quot;-in&quot;, &quot;{output}.cms&quot;, &quot;-inform&quot;, &quot;DER&quot;,
+        &quot;-CAfile&quot;, catfile($smdir, &quot;smroot.pem&quot;), &quot;-out&quot;, &quot;{output}.txt&quot; ],
+      \&amp;final_compare
     ],
 
     [ &quot;signed content test streaming PEM format, 2 DSA and 2 RSA keys&quot;,
-      [ &quot;-sign&quot;, &quot;-in&quot;, $smcont, &quot;-outform&quot;, &quot;PEM&quot;, &quot;-nodetach&quot;,
-	&quot;-signer&quot;, catfile($smdir, &quot;smrsa1.pem&quot;),
-	&quot;-signer&quot;, catfile($smdir, &quot;smrsa2.pem&quot;),
-	&quot;-signer&quot;, catfile($smdir, &quot;smdsa1.pem&quot;),
-	&quot;-signer&quot;, catfile($smdir, &quot;smdsa2.pem&quot;),
-	&quot;-stream&quot;, &quot;-out&quot;, &quot;test.cms&quot; ],
-      [ &quot;-verify&quot;, &quot;-in&quot;, &quot;test.cms&quot;, &quot;-inform&quot;, &quot;PEM&quot;,
-	&quot;-CAfile&quot;, catfile($smdir, &quot;smroot.pem&quot;), &quot;-out&quot;, &quot;smtst.txt&quot; ]
+      [ &quot;{cmd1}&quot;, &quot;-sign&quot;, &quot;-in&quot;, $smcont, &quot;-outform&quot;, &quot;PEM&quot;, &quot;-nodetach&quot;,
+        &quot;-signer&quot;, catfile($smdir, &quot;smrsa1.pem&quot;),
+        &quot;-signer&quot;, catfile($smdir, &quot;smrsa2.pem&quot;),
+        &quot;-signer&quot;, catfile($smdir, &quot;smdsa1.pem&quot;),
+        &quot;-signer&quot;, catfile($smdir, &quot;smdsa2.pem&quot;),
+        &quot;-stream&quot;, &quot;-out&quot;, &quot;{output}.cms&quot; ],
+      [ &quot;{cmd2}&quot;, &quot;-verify&quot;, &quot;-in&quot;, &quot;{output}.cms&quot;, &quot;-inform&quot;, &quot;PEM&quot;,
+        &quot;-CAfile&quot;, catfile($smdir, &quot;smroot.pem&quot;), &quot;-out&quot;, &quot;{output}.txt&quot; ],
+      \&amp;final_compare
     ],
 
     [ &quot;signed content MIME format, RSA key, signed receipt request&quot;,
-      [ &quot;-sign&quot;, &quot;-in&quot;, $smcont, &quot;-signer&quot;, catfile($smdir, &quot;smrsa1.pem&quot;), &quot;-nodetach&quot;,
-	&quot;-receipt_request_to&quot;, &quot;test\@openssl.org&quot;, &quot;-receipt_request_all&quot;,
-	&quot;-out&quot;, &quot;test.cms&quot; ],
-      [ &quot;-verify&quot;, &quot;-in&quot;, &quot;test.cms&quot;,
-	&quot;-CAfile&quot;, catfile($smdir, &quot;smroot.pem&quot;), &quot;-out&quot;, &quot;smtst.txt&quot; ]
+      [ &quot;{cmd1}&quot;, &quot;-sign&quot;, &quot;-in&quot;, $smcont, &quot;-nodetach&quot;,
+        &quot;-signer&quot;, catfile($smdir, &quot;smrsa1.pem&quot;),
+        &quot;-receipt_request_to&quot;, &quot;test\@openssl.org&quot;, &quot;-receipt_request_all&quot;,
+        &quot;-out&quot;, &quot;{output}.cms&quot; ],
+      [ &quot;{cmd2}&quot;, &quot;-verify&quot;, &quot;-in&quot;, &quot;{output}.cms&quot;,
+        &quot;-CAfile&quot;, catfile($smdir, &quot;smroot.pem&quot;), &quot;-out&quot;, &quot;{output}.txt&quot; ],
+      \&amp;final_compare
     ],
 
     [ &quot;signed receipt MIME format, RSA key&quot;,
-      [ &quot;-sign_receipt&quot;, &quot;-in&quot;, &quot;test.cms&quot;,
-	&quot;-signer&quot;, catfile($smdir, &quot;smrsa2.pem&quot;),
-	&quot;-out&quot;, &quot;test2.cms&quot; ],
-      [ &quot;-verify_receipt&quot;, &quot;test2.cms&quot;, &quot;-in&quot;, &quot;test.cms&quot;,
-	&quot;-CAfile&quot;, catfile($smdir, &quot;smroot.pem&quot;) ]
+      [ &quot;{cmd1}&quot;, &quot;-sign&quot;, &quot;-in&quot;, $smcont, &quot;-nodetach&quot;,
+        &quot;-signer&quot;, catfile($smdir, &quot;smrsa1.pem&quot;),
+        &quot;-receipt_request_to&quot;, &quot;test\@openssl.org&quot;, &quot;-receipt_request_all&quot;,
+        &quot;-out&quot;, &quot;{output}.cms&quot; ],
+      [ &quot;{cmd1}&quot;, &quot;-sign_receipt&quot;, &quot;-in&quot;, &quot;{output}.cms&quot;,
+        &quot;-signer&quot;, catfile($smdir, &quot;smrsa2.pem&quot;), &quot;-out&quot;, &quot;{output}2.cms&quot; ],
+      [ &quot;{cmd2}&quot;, &quot;-verify_receipt&quot;, &quot;{output}2.cms&quot;, &quot;-in&quot;, &quot;{output}.cms&quot;,
+        &quot;-CAfile&quot;, catfile($smdir, &quot;smroot.pem&quot;) ]
     ],
 
     [ &quot;signed content DER format, RSA key, CAdES-BES compatible&quot;,
-      [ &quot;-sign&quot;, &quot;-cades&quot;, &quot;-in&quot;, $smcont, &quot;-outform&quot;, &quot;DER&quot;, &quot;-nodetach&quot;,
+      [ &quot;{cmd1}&quot;, &quot;-sign&quot;, &quot;-cades&quot;, &quot;-in&quot;, $smcont, &quot;-outform&quot;, &quot;DER&quot;,
+        &quot;-nodetach&quot;,
         &quot;-certfile&quot;, catfile($smdir, &quot;smroot.pem&quot;),
-        &quot;-signer&quot;, catfile($smdir, &quot;smrsa1.pem&quot;), &quot;-out&quot;, &quot;test.cms&quot; ],
-      [ &quot;-verify&quot;, &quot;-in&quot;, &quot;test.cms&quot;, &quot;-inform&quot;, &quot;DER&quot;,
-        &quot;-CAfile&quot;, catfile($smdir, &quot;smroot.pem&quot;), &quot;-out&quot;, &quot;smtst.txt&quot; ]
+        &quot;-signer&quot;, catfile($smdir, &quot;smrsa1.pem&quot;), &quot;-out&quot;, &quot;{output}.cms&quot; ],
+      [ &quot;{cmd2}&quot;, &quot;-verify&quot;, &quot;-in&quot;, &quot;{output}.cms&quot;, &quot;-inform&quot;, &quot;DER&quot;,
+        &quot;-CAfile&quot;, catfile($smdir, &quot;smroot.pem&quot;), &quot;-out&quot;, &quot;{output}.txt&quot; ],
+      \&amp;final_compare
     ],
 
     [ &quot;signed content DER format, RSA key, SHA256 md, CAdES-BES compatible&quot;,
-      [ &quot;-sign&quot;, &quot;-cades&quot;, &quot;-md&quot;, &quot;sha256&quot;, &quot;-in&quot;, $smcont, &quot;-outform&quot;,
-        &quot;DER&quot;, &quot;-nodetach&quot;, &quot;-certfile&quot;, catfile($smdir, &quot;smroot.pem&quot;),
-        &quot;-signer&quot;, catfile($smdir, &quot;smrsa1.pem&quot;), &quot;-out&quot;, &quot;test.cms&quot; ],
-      [ &quot;-verify&quot;, &quot;-in&quot;, &quot;test.cms&quot;, &quot;-inform&quot;, &quot;DER&quot;,
-        &quot;-CAfile&quot;, catfile($smdir, &quot;smroot.pem&quot;), &quot;-out&quot;, &quot;smtst.txt&quot; ]
+      [ &quot;{cmd1}&quot;, &quot;-sign&quot;, &quot;-cades&quot;, &quot;-md&quot;, &quot;sha256&quot;, &quot;-in&quot;, $smcont,
+        &quot;-outform&quot;, &quot;DER&quot;, &quot;-nodetach&quot;,
+        &quot;-certfile&quot;, catfile($smdir, &quot;smroot.pem&quot;),
+        &quot;-signer&quot;, catfile($smdir, &quot;smrsa1.pem&quot;), &quot;-out&quot;, &quot;{output}.cms&quot; ],
+      [ &quot;{cmd2}&quot;, &quot;-verify&quot;, &quot;-in&quot;, &quot;{output}.cms&quot;, &quot;-inform&quot;, &quot;DER&quot;,
+        &quot;-CAfile&quot;, catfile($smdir, &quot;smroot.pem&quot;), &quot;-out&quot;, &quot;{output}.txt&quot; ],
+      \&amp;final_compare
     ],
 
     [ &quot;enveloped content test streaming S/MIME format, DES, 3 recipients, keyid&quot;,
-      [ &quot;-encrypt&quot;, &quot;-in&quot;, $smcont,
-	&quot;-stream&quot;, &quot;-out&quot;, &quot;test.cms&quot;, &quot;-keyid&quot;,
-	catfile($smdir, &quot;smrsa1.pem&quot;),
-	catfile($smdir, &quot;smrsa2.pem&quot;),
-	catfile($smdir, &quot;smrsa3.pem&quot;) ],
-      [ &quot;-decrypt&quot;, &quot;-recip&quot;, catfile($smdir, &quot;smrsa1.pem&quot;),
-	&quot;-in&quot;, &quot;test.cms&quot;, &quot;-out&quot;, &quot;smtst.txt&quot; ]
+      [ &quot;{cmd1}&quot;, &quot;-encrypt&quot;, &quot;-in&quot;, $smcont,
+        &quot;-stream&quot;, &quot;-out&quot;, &quot;{output}.cms&quot;, &quot;-keyid&quot;,
+        catfile($smdir, &quot;smrsa1.pem&quot;),
+        catfile($smdir, &quot;smrsa2.pem&quot;),
+        catfile($smdir, &quot;smrsa3.pem&quot;) ],
+      [ &quot;{cmd2}&quot;, &quot;-decrypt&quot;, &quot;-recip&quot;, catfile($smdir, &quot;smrsa1.pem&quot;),
+        &quot;-in&quot;, &quot;{output}.cms&quot;, &quot;-out&quot;, &quot;{output}.txt&quot; ],
+      \&amp;final_compare
     ],
 
     [ &quot;enveloped content test streaming PEM format, KEK&quot;,
-      [ &quot;-encrypt&quot;, &quot;-in&quot;, $smcont, &quot;-outform&quot;, &quot;PEM&quot;, &quot;-aes128&quot;,
-	&quot;-stream&quot;, &quot;-out&quot;, &quot;test.cms&quot;,
-	&quot;-secretkey&quot;, &quot;000102030405060708090A0B0C0D0E0F&quot;,
-	&quot;-secretkeyid&quot;, &quot;C0FEE0&quot; ],
-      [ &quot;-decrypt&quot;, &quot;-in&quot;, &quot;test.cms&quot;, &quot;-out&quot;, &quot;smtst.txt&quot;, &quot;-inform&quot;, &quot;PEM&quot;,
-	&quot;-secretkey&quot;, &quot;000102030405060708090A0B0C0D0E0F&quot;,
-	&quot;-secretkeyid&quot;, &quot;C0FEE0&quot; ]
+      [ &quot;{cmd1}&quot;, &quot;-encrypt&quot;, &quot;-in&quot;, $smcont, &quot;-outform&quot;, &quot;PEM&quot;, &quot;-aes128&quot;,
+        &quot;-stream&quot;, &quot;-out&quot;, &quot;{output}.cms&quot;,
+        &quot;-secretkey&quot;, &quot;000102030405060708090A0B0C0D0E0F&quot;,
+        &quot;-secretkeyid&quot;, &quot;C0FEE0&quot; ],
+      [ &quot;{cmd2}&quot;, &quot;-decrypt&quot;, &quot;-in&quot;, &quot;{output}.cms&quot;, &quot;-out&quot;, &quot;{output}.txt&quot;,
+        &quot;-inform&quot;, &quot;PEM&quot;,
+        &quot;-secretkey&quot;, &quot;000102030405060708090A0B0C0D0E0F&quot;,
+        &quot;-secretkeyid&quot;, &quot;C0FEE0&quot; ],
+      \&amp;final_compare
     ],
 
     [ &quot;enveloped content test streaming PEM format, KEK, key only&quot;,
-      [ &quot;-encrypt&quot;, &quot;-in&quot;, $smcont, &quot;-outform&quot;, &quot;PEM&quot;, &quot;-aes128&quot;,
-	&quot;-stream&quot;, &quot;-out&quot;, &quot;test.cms&quot;,
-	&quot;-secretkey&quot;, &quot;000102030405060708090A0B0C0D0E0F&quot;,
-	&quot;-secretkeyid&quot;, &quot;C0FEE0&quot; ],
-      [ &quot;-decrypt&quot;, &quot;-in&quot;, &quot;test.cms&quot;, &quot;-out&quot;, &quot;smtst.txt&quot;, &quot;-inform&quot;, &quot;PEM&quot;,
-	&quot;-secretkey&quot;, &quot;000102030405060708090A0B0C0D0E0F&quot; ]
+      [ &quot;{cmd1}&quot;, &quot;-encrypt&quot;, &quot;-in&quot;, $smcont, &quot;-outform&quot;, &quot;PEM&quot;, &quot;-aes128&quot;,
+        &quot;-stream&quot;, &quot;-out&quot;, &quot;{output}.cms&quot;,
+        &quot;-secretkey&quot;, &quot;000102030405060708090A0B0C0D0E0F&quot;,
+        &quot;-secretkeyid&quot;, &quot;C0FEE0&quot; ],
+      [ &quot;{cmd2}&quot;, &quot;-decrypt&quot;, &quot;-in&quot;, &quot;{output}.cms&quot;, &quot;-out&quot;, &quot;{output}.txt&quot;,
+        &quot;-inform&quot;, &quot;PEM&quot;,
+        &quot;-secretkey&quot;, &quot;000102030405060708090A0B0C0D0E0F&quot; ],
+      \&amp;final_compare
     ],
 
     [ &quot;data content test streaming PEM format&quot;,
-      [ &quot;-data_create&quot;, &quot;-in&quot;, $smcont, &quot;-outform&quot;, &quot;PEM&quot;, &quot;-nodetach&quot;,
-	&quot;-stream&quot;, &quot;-out&quot;, &quot;test.cms&quot; ],
-      [ &quot;-data_out&quot;, &quot;-in&quot;, &quot;test.cms&quot;, &quot;-inform&quot;, &quot;PEM&quot;, &quot;-out&quot;, &quot;smtst.txt&quot; ]
+      [ &quot;{cmd1}&quot;, &quot;-data_create&quot;, &quot;-in&quot;, $smcont, &quot;-outform&quot;, &quot;PEM&quot;,
+        &quot;-nodetach&quot;, &quot;-stream&quot;, &quot;-out&quot;, &quot;{output}.cms&quot; ],
+      [ &quot;{cmd2}&quot;, &quot;-data_out&quot;, &quot;-in&quot;, &quot;{output}.cms&quot;, &quot;-inform&quot;, &quot;PEM&quot;,
+        &quot;-out&quot;, &quot;{output}.txt&quot; ],
+      \&amp;final_compare
     ],
 
     [ &quot;encrypted content test streaming PEM format, 128 bit RC2 key&quot;,
-      [ &quot;-EncryptedData_encrypt&quot;, &quot;-in&quot;, $smcont, &quot;-outform&quot;, &quot;PEM&quot;,
-	&quot;-rc2&quot;, &quot;-secretkey&quot;, &quot;000102030405060708090A0B0C0D0E0F&quot;,
-	&quot;-stream&quot;, &quot;-out&quot;, &quot;test.cms&quot; ],
-      [ &quot;-EncryptedData_decrypt&quot;, &quot;-in&quot;, &quot;test.cms&quot;, &quot;-inform&quot;, &quot;PEM&quot;,
-	&quot;-secretkey&quot;, &quot;000102030405060708090A0B0C0D0E0F&quot;, &quot;-out&quot;, &quot;smtst.txt&quot; ]
+      [ &quot;{cmd1}&quot;, &quot;-EncryptedData_encrypt&quot;, &quot;-in&quot;, $smcont, &quot;-outform&quot;, &quot;PEM&quot;,
+        &quot;-rc2&quot;, &quot;-secretkey&quot;, &quot;000102030405060708090A0B0C0D0E0F&quot;,
+        &quot;-stream&quot;, &quot;-out&quot;, &quot;{output}.cms&quot; ],
+      [ &quot;{cmd2}&quot;, &quot;-EncryptedData_decrypt&quot;, &quot;-in&quot;, &quot;{output}.cms&quot;,
+        &quot;-inform&quot;, &quot;PEM&quot;,
+        &quot;-secretkey&quot;, &quot;000102030405060708090A0B0C0D0E0F&quot;,
+        &quot;-out&quot;, &quot;{output}.txt&quot; ],
+      \&amp;final_compare
     ],
 
     [ &quot;encrypted content test streaming PEM format, 40 bit RC2 key&quot;,
-      [ &quot;-EncryptedData_encrypt&quot;, &quot;-in&quot;, $smcont, &quot;-outform&quot;, &quot;PEM&quot;,
-	&quot;-rc2&quot;, &quot;-secretkey&quot;, &quot;0001020304&quot;,
-	&quot;-stream&quot;, &quot;-out&quot;, &quot;test.cms&quot; ],
-      [ &quot;-EncryptedData_decrypt&quot;, &quot;-in&quot;, &quot;test.cms&quot;, &quot;-inform&quot;, &quot;PEM&quot;,
-	&quot;-secretkey&quot;, &quot;0001020304&quot;, &quot;-out&quot;, &quot;smtst.txt&quot; ]
+      [ &quot;{cmd1}&quot;, &quot;-EncryptedData_encrypt&quot;, &quot;-in&quot;, $smcont, &quot;-outform&quot;, &quot;PEM&quot;,
+        &quot;-rc2&quot;, &quot;-secretkey&quot;, &quot;0001020304&quot;,
+        &quot;-stream&quot;, &quot;-out&quot;, &quot;{output}.cms&quot; ],
+      [ &quot;{cmd2}&quot;, &quot;-EncryptedData_decrypt&quot;, &quot;-in&quot;, &quot;{output}.cms&quot;,
+        &quot;-inform&quot;, &quot;PEM&quot;,
+        &quot;-secretkey&quot;, &quot;0001020304&quot;, &quot;-out&quot;, &quot;{output}.txt&quot; ],
+      \&amp;final_compare
     ],
 
     [ &quot;encrypted content test streaming PEM format, triple DES key&quot;,
-      [ &quot;-EncryptedData_encrypt&quot;, &quot;-in&quot;, $smcont, &quot;-outform&quot;, &quot;PEM&quot;,
-	&quot;-des3&quot;, &quot;-secretkey&quot;, &quot;000102030405060708090A0B0C0D0E0F1011121314151617&quot;,
-	&quot;-stream&quot;, &quot;-out&quot;, &quot;test.cms&quot; ],
-      [ &quot;-EncryptedData_decrypt&quot;, &quot;-in&quot;, &quot;test.cms&quot;, &quot;-inform&quot;, &quot;PEM&quot;,
-	&quot;-secretkey&quot;, &quot;000102030405060708090A0B0C0D0E0F1011121314151617&quot;,
-	&quot;-out&quot;, &quot;smtst.txt&quot; ]
+      [ &quot;{cmd1}&quot;, &quot;-EncryptedData_encrypt&quot;, &quot;-in&quot;, $smcont, &quot;-outform&quot;, &quot;PEM&quot;,
+        &quot;-des3&quot;, &quot;-secretkey&quot;, &quot;000102030405060708090A0B0C0D0E0F1011121314151617&quot;,
+        &quot;-stream&quot;, &quot;-out&quot;, &quot;{output}.cms&quot; ],
+      [ &quot;{cmd2}&quot;, &quot;-EncryptedData_decrypt&quot;, &quot;-in&quot;, &quot;{output}.cms&quot;,
+        &quot;-inform&quot;, &quot;PEM&quot;,
+        &quot;-secretkey&quot;, &quot;000102030405060708090A0B0C0D0E0F1011121314151617&quot;,
+        &quot;-out&quot;, &quot;{output}.txt&quot; ],
+      \&amp;final_compare
     ],
 
     [ &quot;encrypted content test streaming PEM format, 128 bit AES key&quot;,
-      [ &quot;-EncryptedData_encrypt&quot;, &quot;-in&quot;, $smcont, &quot;-outform&quot;, &quot;PEM&quot;,
-	&quot;-aes128&quot;, &quot;-secretkey&quot;, &quot;000102030405060708090A0B0C0D0E0F&quot;,
-	&quot;-stream&quot;, &quot;-out&quot;, &quot;test.cms&quot; ],
-      [ &quot;-EncryptedData_decrypt&quot;, &quot;-in&quot;, &quot;test.cms&quot;, &quot;-inform&quot;, &quot;PEM&quot;,
-	&quot;-secretkey&quot;, &quot;000102030405060708090A0B0C0D0E0F&quot;, &quot;-out&quot;, &quot;smtst.txt&quot; ]
+      [ &quot;{cmd1}&quot;, &quot;-EncryptedData_encrypt&quot;, &quot;-in&quot;, $smcont, &quot;-outform&quot;, &quot;PEM&quot;,
+        &quot;-aes128&quot;, &quot;-secretkey&quot;, &quot;000102030405060708090A0B0C0D0E0F&quot;,
+        &quot;-stream&quot;, &quot;-out&quot;, &quot;{output}.cms&quot; ],
+      [ &quot;{cmd2}&quot;, &quot;-EncryptedData_decrypt&quot;, &quot;-in&quot;, &quot;{output}.cms&quot;,
+        &quot;-inform&quot;, &quot;PEM&quot;,
+        &quot;-secretkey&quot;, &quot;000102030405060708090A0B0C0D0E0F&quot;,
+        &quot;-out&quot;, &quot;{output}.txt&quot; ],
+      \&amp;final_compare
     ],
 
 );
@@ -309,124 +358,149 @@ my @smime_cms_tests = (
 my @smime_cms_comp_tests = (
 
     [ &quot;compressed content test streaming PEM format&quot;,
-      [ &quot;-compress&quot;, &quot;-in&quot;, $smcont, &quot;-outform&quot;, &quot;PEM&quot;, &quot;-nodetach&quot;,
-	&quot;-stream&quot;, &quot;-out&quot;, &quot;test.cms&quot; ],
-      [ &quot;-uncompress&quot;, &quot;-in&quot;, &quot;test.cms&quot;, &quot;-inform&quot;, &quot;PEM&quot;, &quot;-out&quot;, &quot;smtst.txt&quot; ]
+      [ &quot;{cmd1}&quot;, &quot;-compress&quot;, &quot;-in&quot;, $smcont, &quot;-outform&quot;, &quot;PEM&quot;, &quot;-nodetach&quot;,
+        &quot;-stream&quot;, &quot;-out&quot;, &quot;{output}.cms&quot; ],
+      [ &quot;{cmd2}&quot;, &quot;-uncompress&quot;, &quot;-in&quot;, &quot;{output}.cms&quot;, &quot;-inform&quot;, &quot;PEM&quot;,
+        &quot;-out&quot;, &quot;{output}.txt&quot; ],
+      \&amp;final_compare
     ]
 
 );
 
 my @smime_cms_param_tests = (
     [ &quot;signed content test streaming PEM format, RSA keys, PSS signature&quot;,
-      [ &quot;-sign&quot;, &quot;-in&quot;, $smcont, &quot;-outform&quot;, &quot;PEM&quot;, &quot;-nodetach&quot;,
-	&quot;-signer&quot;, catfile($smdir, &quot;smrsa1.pem&quot;), &quot;-keyopt&quot;, &quot;rsa_padding_mode:pss&quot;,
-	&quot;-out&quot;, &quot;test.cms&quot; ],
-      [ &quot;-verify&quot;, &quot;-in&quot;, &quot;test.cms&quot;, &quot;-inform&quot;, &quot;PEM&quot;,
-	&quot;-CAfile&quot;, catfile($smdir, &quot;smroot.pem&quot;), &quot;-out&quot;, &quot;smtst.txt&quot; ]
+      [ &quot;{cmd1}&quot;, &quot;-sign&quot;, &quot;-in&quot;, $smcont, &quot;-outform&quot;, &quot;PEM&quot;, &quot;-nodetach&quot;,
+        &quot;-signer&quot;, catfile($smdir, &quot;smrsa1.pem&quot;),
+        &quot;-keyopt&quot;, &quot;rsa_padding_mode:pss&quot;,
+        &quot;-out&quot;, &quot;{output}.cms&quot; ],
+      [ &quot;{cmd2}&quot;, &quot;-verify&quot;, &quot;-in&quot;, &quot;{output}.cms&quot;, &quot;-inform&quot;, &quot;PEM&quot;,
+        &quot;-CAfile&quot;, catfile($smdir, &quot;smroot.pem&quot;), &quot;-out&quot;, &quot;{output}.txt&quot; ],
+      \&amp;final_compare
     ],
 
     [ &quot;signed content test streaming PEM format, RSA keys, PSS signature, saltlen=max&quot;,
-      [ &quot;-sign&quot;, &quot;-in&quot;, $smcont, &quot;-outform&quot;, &quot;PEM&quot;, &quot;-nodetach&quot;,
-	&quot;-signer&quot;, catfile($smdir, &quot;smrsa1.pem&quot;), &quot;-keyopt&quot;, &quot;rsa_padding_mode:pss&quot;,
-	&quot;-keyopt&quot;, &quot;rsa_pss_saltlen:max&quot;, &quot;-out&quot;, &quot;test.cms&quot; ],
-      [ &quot;-verify&quot;, &quot;-in&quot;, &quot;test.cms&quot;, &quot;-inform&quot;, &quot;PEM&quot;,
-	&quot;-CAfile&quot;, catfile($smdir, &quot;smroot.pem&quot;), &quot;-out&quot;, &quot;smtst.txt&quot; ]
+      [ &quot;{cmd1}&quot;, &quot;-sign&quot;, &quot;-in&quot;, $smcont, &quot;-outform&quot;, &quot;PEM&quot;, &quot;-nodetach&quot;,
+        &quot;-signer&quot;, catfile($smdir, &quot;smrsa1.pem&quot;),
+        &quot;-keyopt&quot;, &quot;rsa_padding_mode:pss&quot;, &quot;-keyopt&quot;, &quot;rsa_pss_saltlen:max&quot;,
+        &quot;-out&quot;, &quot;{output}.cms&quot; ],
+      [ &quot;{cmd2}&quot;, &quot;-verify&quot;, &quot;-in&quot;, &quot;{output}.cms&quot;, &quot;-inform&quot;, &quot;PEM&quot;,
+        &quot;-CAfile&quot;, catfile($smdir, &quot;smroot.pem&quot;), &quot;-out&quot;, &quot;{output}.txt&quot; ],
+      \&amp;final_compare
     ],
 
     [ &quot;signed content test streaming PEM format, RSA keys, PSS signature, no attributes&quot;,
-      [ &quot;-sign&quot;, &quot;-in&quot;, $smcont, &quot;-outform&quot;, &quot;PEM&quot;, &quot;-nodetach&quot;, &quot;-noattr&quot;,
-	&quot;-signer&quot;, catfile($smdir, &quot;smrsa1.pem&quot;), &quot;-keyopt&quot;, &quot;rsa_padding_mode:pss&quot;,
-	&quot;-out&quot;, &quot;test.cms&quot; ],
-      [ &quot;-verify&quot;, &quot;-in&quot;, &quot;test.cms&quot;, &quot;-inform&quot;, &quot;PEM&quot;,
-	&quot;-CAfile&quot;, catfile($smdir, &quot;smroot.pem&quot;), &quot;-out&quot;, &quot;smtst.txt&quot; ]
+      [ &quot;{cmd1}&quot;, &quot;-sign&quot;, &quot;-in&quot;, $smcont, &quot;-outform&quot;, &quot;PEM&quot;, &quot;-nodetach&quot;,
+        &quot;-noattr&quot;,
+        &quot;-signer&quot;, catfile($smdir, &quot;smrsa1.pem&quot;),
+        &quot;-keyopt&quot;, &quot;rsa_padding_mode:pss&quot;,
+        &quot;-out&quot;, &quot;{output}.cms&quot; ],
+      [ &quot;{cmd2}&quot;, &quot;-verify&quot;, &quot;-in&quot;, &quot;{output}.cms&quot;, &quot;-inform&quot;, &quot;PEM&quot;,
+        &quot;-CAfile&quot;, catfile($smdir, &quot;smroot.pem&quot;), &quot;-out&quot;, &quot;{output}.txt&quot; ],
+      \&amp;final_compare
     ],
 
     [ &quot;signed content test streaming PEM format, RSA keys, PSS signature, SHA384 MGF1&quot;,
-      [ &quot;-sign&quot;, &quot;-in&quot;, $smcont, &quot;-outform&quot;, &quot;PEM&quot;, &quot;-nodetach&quot;,
-	&quot;-signer&quot;, catfile($smdir, &quot;smrsa1.pem&quot;), &quot;-keyopt&quot;, &quot;rsa_padding_mode:pss&quot;,
-	&quot;-keyopt&quot;, &quot;rsa_mgf1_md:sha384&quot;, &quot;-out&quot;, &quot;test.cms&quot; ],
-      [ &quot;-verify&quot;, &quot;-in&quot;, &quot;test.cms&quot;, &quot;-inform&quot;, &quot;PEM&quot;,
-	&quot;-CAfile&quot;, catfile($smdir, &quot;smroot.pem&quot;), &quot;-out&quot;, &quot;smtst.txt&quot; ]
+      [ &quot;{cmd1}&quot;, &quot;-sign&quot;, &quot;-in&quot;, $smcont, &quot;-outform&quot;, &quot;PEM&quot;, &quot;-nodetach&quot;,
+        &quot;-signer&quot;, catfile($smdir, &quot;smrsa1.pem&quot;),
+        &quot;-keyopt&quot;, &quot;rsa_padding_mode:pss&quot;, &quot;-keyopt&quot;, &quot;rsa_mgf1_md:sha384&quot;,
+        &quot;-out&quot;, &quot;{output}.cms&quot; ],
+      [ &quot;{cmd2}&quot;, &quot;-verify&quot;, &quot;-in&quot;, &quot;{output}.cms&quot;, &quot;-inform&quot;, &quot;PEM&quot;,
+        &quot;-CAfile&quot;, catfile($smdir, &quot;smroot.pem&quot;), &quot;-out&quot;, &quot;{output}.txt&quot; ],
+      \&amp;final_compare
     ],
 
     [ &quot;enveloped content test streaming S/MIME format, DES, OAEP default parameters&quot;,
-      [ &quot;-encrypt&quot;, &quot;-in&quot;, $smcont,
-	&quot;-stream&quot;, &quot;-out&quot;, &quot;test.cms&quot;,
-	&quot;-recip&quot;, catfile($smdir, &quot;smrsa1.pem&quot;), &quot;-keyopt&quot;, &quot;rsa_padding_mode:oaep&quot; ],
-      [ &quot;-decrypt&quot;, &quot;-recip&quot;, catfile($smdir, &quot;smrsa1.pem&quot;),
-	&quot;-in&quot;, &quot;test.cms&quot;, &quot;-out&quot;, &quot;smtst.txt&quot; ]
+      [ &quot;{cmd1}&quot;, &quot;-encrypt&quot;, &quot;-in&quot;, $smcont,
+        &quot;-stream&quot;, &quot;-out&quot;, &quot;{output}.cms&quot;,
+        &quot;-recip&quot;, catfile($smdir, &quot;smrsa1.pem&quot;),
+        &quot;-keyopt&quot;, &quot;rsa_padding_mode:oaep&quot; ],
+      [ &quot;{cmd2}&quot;, &quot;-decrypt&quot;, &quot;-recip&quot;, catfile($smdir, &quot;smrsa1.pem&quot;),
+        &quot;-in&quot;, &quot;{output}.cms&quot;, &quot;-out&quot;, &quot;{output}.txt&quot; ],
+      \&amp;final_compare
     ],
 
     [ &quot;enveloped content test streaming S/MIME format, DES, OAEP SHA256&quot;,
-      [ &quot;-encrypt&quot;, &quot;-in&quot;, $smcont,
-	&quot;-stream&quot;, &quot;-out&quot;, &quot;test.cms&quot;,
-	&quot;-recip&quot;, catfile($smdir, &quot;smrsa1.pem&quot;), &quot;-keyopt&quot;, &quot;rsa_padding_mode:oaep&quot;,
-	&quot;-keyopt&quot;, &quot;rsa_oaep_md:sha256&quot; ],
-      [ &quot;-decrypt&quot;, &quot;-recip&quot;, catfile($smdir, &quot;smrsa1.pem&quot;),
-	&quot;-in&quot;, &quot;test.cms&quot;, &quot;-out&quot;, &quot;smtst.txt&quot; ]
+      [ &quot;{cmd1}&quot;, &quot;-encrypt&quot;, &quot;-in&quot;, $smcont,
+        &quot;-stream&quot;, &quot;-out&quot;, &quot;{output}.cms&quot;,
+        &quot;-recip&quot;, catfile($smdir, &quot;smrsa1.pem&quot;),
+        &quot;-keyopt&quot;, &quot;rsa_padding_mode:oaep&quot;,
+        &quot;-keyopt&quot;, &quot;rsa_oaep_md:sha256&quot; ],
+      [ &quot;{cmd2}&quot;, &quot;-decrypt&quot;, &quot;-recip&quot;, catfile($smdir, &quot;smrsa1.pem&quot;),
+        &quot;-in&quot;, &quot;{output}.cms&quot;, &quot;-out&quot;, &quot;{output}.txt&quot; ],
+      \&amp;final_compare
     ],
 
     [ &quot;enveloped content test streaming S/MIME format, DES, ECDH&quot;,
-      [ &quot;-encrypt&quot;, &quot;-in&quot;, $smcont,
-	&quot;-stream&quot;, &quot;-out&quot;, &quot;test.cms&quot;,
-	&quot;-recip&quot;, catfile($smdir, &quot;smec1.pem&quot;) ],
-      [ &quot;-decrypt&quot;, &quot;-recip&quot;, catfile($smdir, &quot;smec1.pem&quot;),
-	&quot;-in&quot;, &quot;test.cms&quot;, &quot;-out&quot;, &quot;smtst.txt&quot; ]
+      [ &quot;{cmd1}&quot;, &quot;-encrypt&quot;, &quot;-in&quot;, $smcont,
+        &quot;-stream&quot;, &quot;-out&quot;, &quot;{output}.cms&quot;,
+        &quot;-recip&quot;, catfile($smdir, &quot;smec1.pem&quot;) ],
+      [ &quot;{cmd2}&quot;, &quot;-decrypt&quot;, &quot;-recip&quot;, catfile($smdir, &quot;smec1.pem&quot;),
+        &quot;-in&quot;, &quot;{output}.cms&quot;, &quot;-out&quot;, &quot;{output}.txt&quot; ],
+      \&amp;final_compare
     ],
 
     [ &quot;enveloped content test streaming S/MIME format, DES, ECDH, 2 recipients, key only used&quot;,
-      [ &quot;-encrypt&quot;, &quot;-in&quot;, $smcont,
-	&quot;-stream&quot;, &quot;-out&quot;, &quot;test.cms&quot;,
-	catfile($smdir, &quot;smec1.pem&quot;),
-	catfile($smdir, &quot;smec3.pem&quot;) ],
-      [ &quot;-decrypt&quot;, &quot;-inkey&quot;, catfile($smdir, &quot;smec3.pem&quot;),
-	&quot;-in&quot;, &quot;test.cms&quot;, &quot;-out&quot;, &quot;smtst.txt&quot; ]
+      [ &quot;{cmd1}&quot;, &quot;-encrypt&quot;, &quot;-in&quot;, $smcont,
+        &quot;-stream&quot;, &quot;-out&quot;, &quot;{output}.cms&quot;,
+        catfile($smdir, &quot;smec1.pem&quot;),
+        catfile($smdir, &quot;smec3.pem&quot;) ],
+      [ &quot;{cmd2}&quot;, &quot;-decrypt&quot;, &quot;-inkey&quot;, catfile($smdir, &quot;smec3.pem&quot;),
+        &quot;-in&quot;, &quot;{output}.cms&quot;, &quot;-out&quot;, &quot;{output}.txt&quot; ],
+      \&amp;final_compare
     ],
 
     [ &quot;enveloped content test streaming S/MIME format, ECDH, DES, key identifier&quot;,
-      [ &quot;-encrypt&quot;, &quot;-keyid&quot;, &quot;-in&quot;, $smcont,
-	&quot;-stream&quot;, &quot;-out&quot;, &quot;test.cms&quot;,
-	&quot;-recip&quot;, catfile($smdir, &quot;smec1.pem&quot;) ],
-      [ &quot;-decrypt&quot;, &quot;-recip&quot;, catfile($smdir, &quot;smec1.pem&quot;),
-	&quot;-in&quot;, &quot;test.cms&quot;, &quot;-out&quot;, &quot;smtst.txt&quot; ]
+      [ &quot;{cmd1}&quot;, &quot;-encrypt&quot;, &quot;-keyid&quot;, &quot;-in&quot;, $smcont,
+        &quot;-stream&quot;, &quot;-out&quot;, &quot;{output}.cms&quot;,
+        &quot;-recip&quot;, catfile($smdir, &quot;smec1.pem&quot;) ],
+      [ &quot;{cmd2}&quot;, &quot;-decrypt&quot;, &quot;-recip&quot;, catfile($smdir, &quot;smec1.pem&quot;),
+        &quot;-in&quot;, &quot;{output}.cms&quot;, &quot;-out&quot;, &quot;{output}.txt&quot; ],
+      \&amp;final_compare
     ],
 
     [ &quot;enveloped content test streaming S/MIME format, ECDH, AES128, SHA256 KDF&quot;,
-      [ &quot;-encrypt&quot;, &quot;-in&quot;, $smcont,
-	&quot;-stream&quot;, &quot;-out&quot;, &quot;test.cms&quot;,
-	&quot;-recip&quot;, catfile($smdir, &quot;smec1.pem&quot;), &quot;-aes128&quot;, &quot;-keyopt&quot;, &quot;ecdh_kdf_md:sha256&quot; ],
-      [ &quot;-decrypt&quot;, &quot;-recip&quot;, catfile($smdir, &quot;smec1.pem&quot;),
-	&quot;-in&quot;, &quot;test.cms&quot;, &quot;-out&quot;, &quot;smtst.txt&quot; ]
+      [ &quot;{cmd1}&quot;, &quot;-encrypt&quot;, &quot;-in&quot;, $smcont,
+        &quot;-stream&quot;, &quot;-out&quot;, &quot;{output}.cms&quot;,
+        &quot;-recip&quot;, catfile($smdir, &quot;smec1.pem&quot;), &quot;-aes128&quot;,
+        &quot;-keyopt&quot;, &quot;ecdh_kdf_md:sha256&quot; ],
+      [ &quot;{cmd2}&quot;, &quot;-decrypt&quot;, &quot;-recip&quot;, catfile($smdir, &quot;smec1.pem&quot;),
+        &quot;-in&quot;, &quot;{output}.cms&quot;, &quot;-out&quot;, &quot;{output}.txt&quot; ],
+      \&amp;final_compare
     ],
 
     [ &quot;enveloped content test streaming S/MIME format, ECDH, K-283, cofactor DH&quot;,
-      [ &quot;-encrypt&quot;, &quot;-in&quot;, $smcont,
-	&quot;-stream&quot;, &quot;-out&quot;, &quot;test.cms&quot;,
-	&quot;-recip&quot;, catfile($smdir, &quot;smec2.pem&quot;), &quot;-aes128&quot;,
-	&quot;-keyopt&quot;, &quot;ecdh_kdf_md:sha256&quot;, &quot;-keyopt&quot;, &quot;ecdh_cofactor_mode:1&quot; ],
-      [ &quot;-decrypt&quot;, &quot;-recip&quot;, catfile($smdir, &quot;smec2.pem&quot;),
-	&quot;-in&quot;, &quot;test.cms&quot;, &quot;-out&quot;, &quot;smtst.txt&quot; ]
+      [ &quot;{cmd1}&quot;, &quot;-encrypt&quot;, &quot;-in&quot;, $smcont,
+        &quot;-stream&quot;, &quot;-out&quot;, &quot;{output}.cms&quot;,
+        &quot;-recip&quot;, catfile($smdir, &quot;smec2.pem&quot;), &quot;-aes128&quot;,
+        &quot;-keyopt&quot;, &quot;ecdh_kdf_md:sha256&quot;, &quot;-keyopt&quot;, &quot;ecdh_cofactor_mode:1&quot; ],
+      [ &quot;{cmd2}&quot;, &quot;-decrypt&quot;, &quot;-recip&quot;, catfile($smdir, &quot;smec2.pem&quot;),
+        &quot;-in&quot;, &quot;{output}.cms&quot;, &quot;-out&quot;, &quot;{output}.txt&quot; ],
+      \&amp;final_compare
     ],
 
     [ &quot;enveloped content test streaming S/MIME format, X9.42 DH&quot;,
-      [ &quot;-encrypt&quot;, &quot;-in&quot;, $smcont,
-	&quot;-stream&quot;, &quot;-out&quot;, &quot;test.cms&quot;,
-	&quot;-recip&quot;, catfile($smdir, &quot;smdh.pem&quot;), &quot;-aes128&quot; ],
-      [ &quot;-decrypt&quot;, &quot;-recip&quot;, catfile($smdir, &quot;smdh.pem&quot;),
-	&quot;-in&quot;, &quot;test.cms&quot;, &quot;-out&quot;, &quot;smtst.txt&quot; ]
+      [ &quot;{cmd1}&quot;, &quot;-encrypt&quot;, &quot;-in&quot;, $smcont,
+        &quot;-stream&quot;, &quot;-out&quot;, &quot;{output}.cms&quot;,
+        &quot;-recip&quot;, catfile($smdir, &quot;smdh.pem&quot;), &quot;-aes128&quot; ],
+      [ &quot;{cmd2}&quot;, &quot;-decrypt&quot;, &quot;-recip&quot;, catfile($smdir, &quot;smdh.pem&quot;),
+        &quot;-in&quot;, &quot;{output}.cms&quot;, &quot;-out&quot;, &quot;{output}.txt&quot; ],
+      \&amp;final_compare
     ]
     );
 
 my @contenttype_cms_test = (
     [ &quot;signed content test - check that content type is added to additional signerinfo, RSA keys&quot;,
-      [ &quot;-sign&quot;, &quot;-binary&quot;, &quot;-nodetach&quot;, &quot;-stream&quot;, &quot;-in&quot;, $smcont, &quot;-outform&quot;, &quot;DER&quot;,
+      [ &quot;{cmd1}&quot;, &quot;-sign&quot;, &quot;-binary&quot;, &quot;-nodetach&quot;, &quot;-stream&quot;, &quot;-in&quot;, $smcont,
+        &quot;-outform&quot;, &quot;DER&quot;,
         &quot;-signer&quot;, catfile($smdir, &quot;smrsa1.pem&quot;), &quot;-md&quot;, &quot;SHA256&quot;,
-        &quot;-out&quot;, &quot;test.cms&quot; ],
-      [ &quot;-resign&quot;, &quot;-binary&quot;, &quot;-nodetach&quot;, &quot;-in&quot;, &quot;test.cms&quot;, &quot;-inform&quot;, &quot;DER&quot;, &quot;-outform&quot;, &quot;DER&quot;,
+        &quot;-out&quot;, &quot;{output}.cms&quot; ],
+      [ &quot;{cmd1}&quot;, &quot;-resign&quot;, &quot;-binary&quot;, &quot;-nodetach&quot;, &quot;-in&quot;, &quot;{output}.cms&quot;,
+        &quot;-inform&quot;, &quot;DER&quot;, &quot;-outform&quot;, &quot;DER&quot;,
         &quot;-signer&quot;, catfile($smdir, &quot;smrsa2.pem&quot;), &quot;-md&quot;, &quot;SHA256&quot;,
-        &quot;-out&quot;, &quot;test2.cms&quot; ],
-      [ &quot;-verify&quot;, &quot;-in&quot;, &quot;test2.cms&quot;, &quot;-inform&quot;, &quot;DER&quot;,
-        &quot;-CAfile&quot;, catfile($smdir, &quot;smroot.pem&quot;), &quot;-out&quot;, &quot;smtst.txt&quot; ]
+        &quot;-out&quot;, &quot;{output}2.cms&quot; ],
+      sub { my %opts = @_; contentType_matches(&quot;$opts{output}2.cms&quot;) == 2; },
+      [ &quot;{cmd2}&quot;, &quot;-verify&quot;, &quot;-in&quot;, &quot;{output}2.cms&quot;, &quot;-inform&quot;, &quot;DER&quot;,
+        &quot;-CAfile&quot;, catfile($smdir, &quot;smroot.pem&quot;), &quot;-out&quot;, &quot;{output}.txt&quot; ]
     ],
 );
 
@@ -437,96 +511,85 @@ my @incorrect_attribute_cms_test = (
     &quot;ct_multiple_attr.cms&quot;
 );
 
-subtest &quot;CMS =&gt; PKCS#7 compatibility tests\n&quot; =&gt; sub {
-    plan tests =&gt; scalar @smime_pkcs7_tests;
+# Runs a standard loop on the input array
+sub runner_loop {
+    my %opts = ( @_ );
+    my $cnt1 = 0;
 
-    foreach (@smime_pkcs7_tests) {
+    foreach (@{$opts{tests}}) {
+        $cnt1++;
+        $opts{output} = &quot;$opts{prefix}-$cnt1&quot;;
       SKIP: {
-	  my $skip_reason = check_availability($$_[0]);
-	  skip $skip_reason, 1 if $skip_reason;
-
-	  ok(run(app([&quot;openssl&quot;, &quot;cms&quot;, @{$$_[1]}]))
-	     &amp;&amp; run(app([&quot;openssl&quot;, &quot;smime&quot;, @{$$_[2]}]))
-	     &amp;&amp; compare_text($smcont, &quot;smtst.txt&quot;) == 0,
-	     $$_[0]);
-	}
+          my $skip_reason = check_availability($$_[0]);
+          skip $skip_reason, 1 if $skip_reason;
+          my $ok = 1;
+          1 while unlink &quot;$opts{output}.txt&quot;;
+
+          foreach (@$_[1..$#$_]) {
+              if (ref $_ eq 'CODE') {
+                  $ok &amp;&amp;= $_-&gt;(%opts);
+              } else {
+                  my @cmd = map {
+                      my $x = $_;
+                      while ($x =~ /\{([^\}]+)\}/) {
+                          $x = $`.$opts{$1}.$' if exists $opts{$1};
+                      }
+                      $x;
+                  } @$_;
+
+                  diag &quot;CMD: openssl&quot;, join(&quot; &quot;, @cmd);
+                  $ok &amp;&amp;= run(app([&quot;openssl&quot;, @cmd]));
+                  $opts{input} = $opts{output};
+              }
+          }
+
+          ok($ok, $$_[0]);
+        }
     }
+}
+
+sub final_compare {
+    my %opts = @_;
+
+    diag &quot;Comparing $smcont with $opts{output}.txt&quot;;
+    return compare_text($smcont, &quot;$opts{output}.txt&quot;) == 0;
+}
+
+subtest &quot;CMS =&gt; PKCS#7 compatibility tests\n&quot; =&gt; sub {
+    plan tests =&gt; scalar @smime_pkcs7_tests;
+
+    runner_loop(prefix =&gt; 'cms2pkcs7', cmd1 =&gt; 'cms', cmd2 =&gt; 'smime',
+                tests =&gt; [ @smime_pkcs7_tests ]);
 };
 subtest &quot;CMS &lt;= PKCS#7 compatibility tests\n&quot; =&gt; sub {
     plan tests =&gt; scalar @smime_pkcs7_tests;
 
-    foreach (@smime_pkcs7_tests) {
-      SKIP: {
-	  my $skip_reason = check_availability($$_[0]);
-	  skip $skip_reason, 1 if $skip_reason;
-
-	  ok(run(app([&quot;openssl&quot;, &quot;smime&quot;, @{$$_[1]}]))
-	     &amp;&amp; run(app([&quot;openssl&quot;, &quot;cms&quot;, @{$$_[2]}]))
-	     &amp;&amp; compare_text($smcont, &quot;smtst.txt&quot;) == 0,
-	     $$_[0]);
-	}
-    }
+    runner_loop(prefix =&gt; 'pkcs72cms', cmd1 =&gt; 'smime', cmd2 =&gt; 'cms',
+                tests =&gt; [ @smime_pkcs7_tests ]);
 };
 
 subtest &quot;CMS &lt;=&gt; CMS consistency tests\n&quot; =&gt; sub {
     plan tests =&gt; (scalar @smime_pkcs7_tests) + (scalar @smime_cms_tests);
 
-    foreach (@smime_pkcs7_tests) {
-      SKIP: {
-	  my $skip_reason = check_availability($$_[0]);
-	  skip $skip_reason, 1 if $skip_reason;
-
-	  ok(run(app([&quot;openssl&quot;, &quot;cms&quot;, @{$$_[1]}]))
-	     &amp;&amp; run(app([&quot;openssl&quot;, &quot;cms&quot;, @{$$_[2]}]))
-	     &amp;&amp; compare_text($smcont, &quot;smtst.txt&quot;) == 0,
-	     $$_[0]);
-	}
-    }
-    foreach (@smime_cms_tests) {
-      SKIP: {
-	  my $skip_reason = check_availability($$_[0]);
-	  skip $skip_reason, 1 if $skip_reason;
-
-	  ok(run(app([&quot;openssl&quot;, &quot;cms&quot;, @{$$_[1]}]))
-	     &amp;&amp; run(app([&quot;openssl&quot;, &quot;cms&quot;, @{$$_[2]}]))
-	     &amp;&amp; compare_text($smcont, &quot;smtst.txt&quot;) == 0,
-	     $$_[0]);
-	}
-    }
+    runner_loop(prefix =&gt; 'cms2cms-1', cmd1 =&gt; 'cms', cmd2 =&gt; 'cms',
+                tests =&gt; [ @smime_pkcs7_tests ]);
+    runner_loop(prefix =&gt; 'cms2cms-2', cmd1 =&gt; 'cms', cmd2 =&gt; 'cms',
+                tests =&gt; [ @smime_cms_tests ]);
 };
 
 subtest &quot;CMS &lt;=&gt; CMS consistency tests, modified key parameters\n&quot; =&gt; sub {
     plan tests =&gt;
-	(scalar @smime_cms_param_tests) + (scalar @smime_cms_comp_tests);
-
-    foreach (@smime_cms_param_tests) {
-      SKIP: {
-	  my $skip_reason = check_availability($$_[0]);
-	  skip $skip_reason, 1 if $skip_reason;
-
-	  ok(run(app([&quot;openssl&quot;, &quot;cms&quot;, @{$$_[1]}]))
-	     &amp;&amp; run(app([&quot;openssl&quot;, &quot;cms&quot;, @{$$_[2]}]))
-	     &amp;&amp; compare_text($smcont, &quot;smtst.txt&quot;) == 0,
-	     $$_[0]);
-	}
-    }
+        (scalar @smime_cms_param_tests) + (scalar @smime_cms_comp_tests);
 
+    runner_loop(prefix =&gt; 'cms2cms-mod', cmd1 =&gt; 'cms', cmd2 =&gt; 'cms',
+                tests =&gt; [ @smime_cms_param_tests ]);
   SKIP: {
       skip(&quot;Zlib not supported: compression tests skipped&quot;,
-	   scalar @smime_cms_comp_tests)
-	  if $no_zlib;
-
-      foreach (@smime_cms_comp_tests) {
-	SKIP: {
-	    my $skip_reason = check_availability($$_[0]);
-	    skip $skip_reason, 1 if $skip_reason;
-
-	    ok(run(app([&quot;openssl&quot;, &quot;cms&quot;, @{$$_[1]}]))
-	       &amp;&amp; run(app([&quot;openssl&quot;, &quot;cms&quot;, @{$$_[2]}]))
-	       &amp;&amp; compare_text($smcont, &quot;smtst.txt&quot;) == 0,
-	       $$_[0]);
-	  }
-      }
+           scalar @smime_cms_comp_tests)
+          if $no_zlib;
+
+      runner_loop(prefix =&gt; 'cms2cms-comp', cmd1 =&gt; 'cms', cmd2 =&gt; 'cms',
+                  tests =&gt; [ @smime_cms_comp_tests ]);
     }
 };
 
@@ -547,39 +610,27 @@ sub contentType_matches {
 }
 
 subtest &quot;CMS Check the content type attribute is added for additional signers\n&quot; =&gt; sub {
-    plan tests =&gt;
-        (scalar @contenttype_cms_test);
+    plan tests =&gt; (scalar @contenttype_cms_test);
 
-    foreach (@contenttype_cms_test) {
-      SKIP: {
-          my $skip_reason = check_availability($$_[0]);
-          skip $skip_reason, 1 if $skip_reason;
-
-          ok(run(app([&quot;openssl&quot;, &quot;cms&quot;, @{$$_[1]}]))
-             &amp;&amp; run(app([&quot;openssl&quot;, &quot;cms&quot;, @{$$_[2]}]))
-             &amp;&amp; contentType_matches(&quot;test2.cms&quot;) == 2
-             &amp;&amp; run(app([&quot;openssl&quot;, &quot;cms&quot;, @{$$_[3]}])),
-             $$_[0]);
-        }
-    }
+    runner_loop(prefix =&gt; 'cms2cms-added', cmd1 =&gt; 'cms', cmd2 =&gt; 'cms',
+                tests =&gt; [ @contenttype_cms_test ]);
 };
 
 subtest &quot;CMS Check that bad attributes fail when verifying signers\n&quot; =&gt; sub {
     plan tests =&gt;
         (scalar @incorrect_attribute_cms_test);
 
+    my $cnt = 0;
     foreach my $name (@incorrect_attribute_cms_test) {
+        my $out = &quot;incorrect-$cnt.txt&quot;;
+
         ok(!run(app([&quot;openssl&quot;, &quot;cms&quot;, &quot;-verify&quot;, &quot;-in&quot;,
                      catfile($datadir, $name), &quot;-inform&quot;, &quot;DER&quot;, &quot;-CAfile&quot;,
-                     catfile($smdir, &quot;smroot.pem&quot;), &quot;-out&quot;, &quot;smtst.txt&quot; ])),
+                     catfile($smdir, &quot;smroot.pem&quot;), &quot;-out&quot;, $out ])),
             $name);
     }
 };
 
-unlink &quot;test.cms&quot;;
-unlink &quot;test2.cms&quot;;
-unlink &quot;smtst.txt&quot;;
-
 sub check_availability {
     my $tnam = shift;
 
diff --git a/test/recipes/80-test_ocsp.t b/test/recipes/80-test_ocsp.t
index 5ca069801b..74ef7e3662 100644
--- a/test/recipes/80-test_ocsp.t
+++ b/test/recipes/80-test_ocsp.t
@@ -12,6 +12,7 @@ use warnings;
 
 use POSIX;
 use File::Spec::Functions qw/devnull catfile/;
+use File::Basename;
 use File::Copy;
 use OpenSSL::Test qw/:DEFAULT with pipe srctop_dir data_file/;
 use OpenSSL::Test::Utils;
@@ -34,18 +35,18 @@ sub test_ocsp {
         $untrusted = $CAfile;
     }
     my $expected_exit = shift;
+    my $outputfile = basename($inputfile, '.ors') . '.dat';
 
     run(app([&quot;openssl&quot;, &quot;base64&quot;, &quot;-d&quot;,
              &quot;-in&quot;, catfile($ocspdir,$inputfile),
-             &quot;-out&quot;, &quot;ocsp-resp-fff.dat&quot;]));
+             &quot;-out&quot;, $outputfile]));
     with({ exit_checker =&gt; sub { return shift == $expected_exit; } },
-         sub { ok(run(app([&quot;openssl&quot;, &quot;ocsp&quot;, &quot;-respin&quot;, &quot;ocsp-resp-fff.dat&quot;,
+         sub { ok(run(app([&quot;openssl&quot;, &quot;ocsp&quot;, &quot;-respin&quot;, $outputfile,
                            &quot;-partial_chain&quot;, @check_time,
                            &quot;-CAfile&quot;, catfile($ocspdir, $CAfile),
                            &quot;-verify_other&quot;, catfile($ocspdir, $untrusted),
                            &quot;-no-CApath&quot;])),
                   $title); });
-    unlink &quot;ocsp-resp-fff.dat&quot;;
 }
 
 plan tests =&gt; 11;
diff --git a/test/recipes/80-test_ssl_new.t b/test/recipes/80-test_ssl_new.t
index 04a0c13394..01a49173d6 100644
--- a/test/recipes/80-test_ssl_new.t
+++ b/test/recipes/80-test_ssl_new.t
@@ -120,17 +120,16 @@ sub test_conf {
     my ($conf, $check_source, $skip) = @_;
 
     my $conf_file = srctop_file(&quot;test&quot;, &quot;ssl-tests&quot;, $conf);
-    my $tmp_file = &quot;${conf}.$$.tmp&quot;;
+    my $input_file = $conf_file . &quot;.in&quot;;
+    my $output_file = $conf;
     my $run_test = 1;
 
   SKIP: {
       # &quot;Test&quot; 1. Generate the source.
-      my $input_file = $conf_file . &quot;.in&quot;;
-
       skip 'failure', 2 unless
         ok(run(perltest([&quot;generate_ssl_tests.pl&quot;, $input_file],
                         interpreter_args =&gt; [ &quot;-I&quot;, srctop_dir(&quot;util&quot;, &quot;perl&quot;)],
-                        stdout =&gt; $tmp_file)),
+                        stdout =&gt; $output_file)),
            &quot;Getting output from generate_ssl_tests.pl.&quot;);
 
     SKIP: {
@@ -138,7 +137,7 @@ sub test_conf {
         skip &quot;Skipping generated source test for $conf&quot;, 1
           if !$check_source;
 
-        $run_test = is(cmp_text($tmp_file, $conf_file), 0,
+        $run_test = is(cmp_text($output_file, $conf_file), 0,
                        &quot;Comparing generated sources.&quot;);
       }
 
@@ -146,10 +145,8 @@ sub test_conf {
       skip &quot;No tests available; skipping tests&quot;, 1 if $skip;
       skip &quot;Stale sources; skipping tests&quot;, 1 if !$run_test;
 
-      ok(run(test([&quot;ssl_test&quot;, $tmp_file])), &quot;running ssl_test $conf&quot;);
+      ok(run(test([&quot;ssl_test&quot;, $output_file])), &quot;running ssl_test $conf&quot;);
     }
-
-    unlink glob $tmp_file;
 }
 
 sub cmp_text {
diff --git a/test/recipes/80-test_ssl_old.t b/test/recipes/80-test_ssl_old.t
index d6e638d2f1..41eeb46a29 100644
--- a/test/recipes/80-test_ssl_old.t
+++ b/test/recipes/80-test_ssl_old.t
@@ -546,41 +546,3 @@ sub testssl {
 	}
     };
 }
-
-unlink $CAkey;
-unlink $CAcert;
-unlink $CAserial;
-unlink $CAreq;
-unlink $CAreq2;
-
-unlink $Ukey;
-unlink $Ureq;
-unlink $Ucert;
-unlink basename($Ucert, '.ss').'.srl';
-
-unlink $Dkey;
-unlink $Dreq;
-unlink $Dcert;
-
-unlink $Ekey;
-unlink $Ereq;
-unlink $Ecert;
-
-unlink $P1key;
-unlink $P1req;
-unlink $P1cert;
-unlink basename($P1cert, '.ss').'.srl';
-unlink $P1intermediate;
-unlink &quot;intP1.ss&quot;;
-
-unlink $P2key;
-unlink $P2req;
-unlink $P2cert;
-unlink $P2intermediate;
-unlink &quot;intP2.ss&quot;;
-
-unlink &quot;ecp.ss&quot;;
-unlink &quot;err.ss&quot;;
-
-unlink $server_sess;
-unlink $client_sess;
diff --git a/test/recipes/tconversion.pl b/test/recipes/tconversion.pl
index a7db10d24c..2cecb9fc23 100644
--- a/test/recipes/tconversion.pl
+++ b/test/recipes/tconversion.pl
@@ -89,9 +89,6 @@ sub tconversion {
 	  }
       }
     }
-    unlink glob &quot;$testtype-f.*&quot;;
-    unlink glob &quot;$testtype-ff.*&quot;;
-    unlink glob &quot;$testtype-fff.*&quot;;
 }
 
 sub cmp_text {
diff --git a/util/perl/OpenSSL/Test.pm b/util/perl/OpenSSL/Test.pm
index 78e13523c8..4297106392 100644
--- a/util/perl/OpenSSL/Test.pm
+++ b/util/perl/OpenSSL/Test.pm
@@ -132,6 +132,7 @@ is defined).
 sub setup {
     my $old_test_name = $test_name;
     $test_name = shift;
+    my %opts = @_;
 
     BAIL_OUT(&quot;setup() must receive a name&quot;) unless $test_name;
     warn &quot;setup() detected test name change.  Innocuous, so we continue...\n&quot;
@@ -149,6 +150,9 @@ sub setup {
     BAIL_OUT(&quot;setup() expects the file Configure in the source top directory&quot;)
         unless -f srctop_file(&quot;Configure&quot;);
 
+    note &quot;The results of this test will end up in $directories{RESULTS}&quot;
+        unless $opts{quiet};
+
     __cwd($directories{RESULTS});
 }
 
@@ -170,12 +174,6 @@ When set to 1 (or any value that perl perceives as true), the subdirectory
 will be created if it doesn't already exist.  This happens before BLOCK
 is executed.
 
-=item B&lt;cleanup =E&lt;gt&gt; 0|1&gt;
-
-When set to 1 (or any value that perl perceives as true), the subdirectory
-will be cleaned out and removed.  This happens both before and after BLOCK
-is executed.
-
 =back
 
 An example:
@@ -188,7 +186,7 @@ An example:
           is($line, qr/^OpenSSL 1\./,
              &quot;check that we're using OpenSSL 1.x.x&quot;);
       }
-  }, create =&gt; 1, cleanup =&gt; 1;
+  }, create =&gt; 1;
 
 =back
 
@@ -206,10 +204,6 @@ sub indir {
     $codeblock-&gt;();
 
     __cwd($reverse);
-
-    if ($opts{cleanup}) {
-	rmtree($subdir, { safe =&gt; 0 });
-    }
 }
 
 =over 4
@@ -943,17 +937,22 @@ i.e. Some tests may only work in non FIPS mode.
 sub __env {
     (my $recipe_datadir = basename($0)) =~ s/\.t$/_data/i;
 
-    $directories{SRCTOP}  = abs_path($ENV{SRCTOP} || $ENV{TOP});
-    $directories{BLDTOP}  = abs_path($ENV{BLDTOP} || $ENV{TOP});
-    $directories{BLDAPPS} = $ENV{BIN_D}  || __bldtop_dir(&quot;apps&quot;);
-    $directories{SRCAPPS} =                 __srctop_dir(&quot;apps&quot;);
-    $directories{BLDFUZZ} =                 __bldtop_dir(&quot;fuzz&quot;);
-    $directories{SRCFUZZ} =                 __srctop_dir(&quot;fuzz&quot;);
-    $directories{BLDTEST} = $ENV{TEST_D} || __bldtop_dir(&quot;test&quot;);
-    $directories{SRCTEST} =                 __srctop_dir(&quot;test&quot;);
-    $directories{SRCDATA} =                 __srctop_dir(&quot;test&quot;, &quot;recipes&quot;,
-                                                         $recipe_datadir);
-    $directories{RESULTS} = $ENV{RESULT_D} || $directories{BLDTEST};
+    $directories{SRCTOP}    = abs_path($ENV{SRCTOP} || $ENV{TOP});
+    $directories{BLDTOP}    = abs_path($ENV{BLDTOP} || $ENV{TOP});
+    $directories{BLDAPPS}   = $ENV{BIN_D}  || __bldtop_dir(&quot;apps&quot;);
+    $directories{SRCAPPS}   =                 __srctop_dir(&quot;apps&quot;);
+    $directories{BLDFUZZ}   =                 __bldtop_dir(&quot;fuzz&quot;);
+    $directories{SRCFUZZ}   =                 __srctop_dir(&quot;fuzz&quot;);
+    $directories{BLDTEST}   = $ENV{TEST_D} || __bldtop_dir(&quot;test&quot;);
+    $directories{SRCTEST}   =                 __srctop_dir(&quot;test&quot;);
+    $directories{SRCDATA}   =                 __srctop_dir(&quot;test&quot;, &quot;recipes&quot;,
+                                                           $recipe_datadir);
+    $directories{RESULTTOP} = $ENV{RESULT_D} || __bldtop_dir(&quot;test-runs&quot;);
+    $directories{RESULTS}   = catdir($directories{RESULTTOP}, $test_name);
+
+    # Create result directory dynamically
+    rmtree($directories{RESULTS}, { safe =&gt; 0, keep_root =&gt; 1 });
+    mkpath($directories{RESULTS});
 
     push @direnv, &quot;TOP&quot;       if $ENV{TOP};
     push @direnv, &quot;SRCTOP&quot;    if $ENV{SRCTOP};
@@ -962,7 +961,7 @@ sub __env {
     push @direnv, &quot;TEST_D&quot;    if $ENV{TEST_D};
     push @direnv, &quot;RESULT_D&quot;  if $ENV{RESULT_D};
 
-    $end_with_bailout	  = $ENV{STOPTEST} ? 1 : 0;
+    $end_with_bailout = $ENV{STOPTEST} ? 1 : 0;
 };
 
 # __srctop_file and __srctop_dir are helpers to build file and directory
@@ -1079,7 +1078,6 @@ sub __results_file {
 # hash style arguments to alter __cwd's behavior:
 #
 #    create = 0|1       The directory we move to is created if 1, not if 0.
-#    cleanup = 0|1      The directory we move from is removed if 1, not if 0.
 
 sub __cwd {
     my $dir = catdir(shift);
@@ -1137,10 +1135,6 @@ sub __cwd {
     # Should we just bail out here as well?  I'm unsure.
     return undef unless chdir($dir);
 
-    if ($opts{cleanup}) {
-	rmtree(&quot;.&quot;, { safe =&gt; 0, keep_root =&gt; 1 });
-    }
-
     # We put back new values carefully.  Doing the obvious
     # %directories = ( %tmp_directories )
     # will clear out any value that happens to be an absolute path
</PRE>




<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="027571.html">[openssl]  master update
</A></li>
	<LI>Next message: <A HREF="027573.html">[openssl]  master update
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#27572">[ date ]</a>
              <a href="thread.html#27572">[ thread ]</a>
              <a href="subject.html#27572">[ subject ]</a>
              <a href="author.html#27572">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="../../../mailman/listinfo/openssl-commits.html">More information about the openssl-commits
mailing list</a><br>
</body></html>
