<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [openssl]  master update
   </TITLE>
   <LINK REL="Index" HREF="https://mta.openssl.org/pipermail/openssl-commits/2021-May/index.html" >
   <LINK REL="made" HREF="mailto:openssl-commits%40openssl.org?Subject=Re%3A%20%5Bopenssl%5D%20%20master%20update&In-Reply-To=%3C1621521120.771037.1582.nullmailer%40dev.openssl.org%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="034353.html">
   <LINK REL="Next"  HREF="034355.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[openssl]  master update</H1>
    <B>dev at ddvo.net</B> 
    <A HREF="mailto:openssl-commits%40openssl.org?Subject=Re%3A%20%5Bopenssl%5D%20%20master%20update&In-Reply-To=%3C1621521120.771037.1582.nullmailer%40dev.openssl.org%3E"
       TITLE="[openssl]  master update">dev at ddvo.net
       </A><BR>
    <I>Thu May 20 14:32:00 UTC 2021</I>
    <P><UL>
        <LI>Previous message: <A HREF="034353.html">[openssl]  master update
</A></li>
        <LI>Next message: <A HREF="034355.html">[openssl]  master update
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#34354">[ date ]</a>
              <a href="thread.html#34354">[ thread ]</a>
              <a href="subject.html#34354">[ subject ]</a>
              <a href="author.html#34354">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>The branch master has been updated
       via  340cf8759f904859e609cecf4315b7cb50cde561 (commit)
       via  56c4f6fe724e4aa54498188873d84e5694b02984 (commit)
       via  601fe8e0d78d4344445cbfa83dbe9bc4ad1287f1 (commit)
      from  41d331b6f02267dbaa24cf35b9810994199431f4 (commit)


- Log -----------------------------------------------------------------
commit 340cf8759f904859e609cecf4315b7cb50cde561
Author: Dr. David von Oheimb &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">David.von.Oheimb at siemens.com</A>&gt;
Date:   Sat Apr 3 19:42:39 2021 +0200

    apps/cms: Clean up order of options in help output and documentation
    
    Reviewed-by: Tomas Mraz &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">tomas at openssl.org</A>&gt;
    (Merged from <A HREF="https://github.com/openssl/openssl/pull/15126">https://github.com/openssl/openssl/pull/15126</A>)

commit 56c4f6fe724e4aa54498188873d84e5694b02984
Author: Dr. David von Oheimb &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">David.von.Oheimb at siemens.com</A>&gt;
Date:   Mon Apr 12 19:00:00 2021 +0200

    APPS: Allow duplicate entries in options list, marking them OPT_DUP
    
    Reviewed-by: Tomas Mraz &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">tomas at openssl.org</A>&gt;
    (Merged from <A HREF="https://github.com/openssl/openssl/pull/15126">https://github.com/openssl/openssl/pull/15126</A>)

commit 601fe8e0d78d4344445cbfa83dbe9bc4ad1287f1
Author: Dr. David von Oheimb &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">David.von.Oheimb at siemens.com</A>&gt;
Date:   Sat Apr 3 16:03:21 2021 +0200

    APPS: Allow non-option parameters appear anywhere in list, marking them OPT_PARAM
    
    Reviewed-by: Tomas Mraz &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">tomas at openssl.org</A>&gt;
    (Merged from <A HREF="https://github.com/openssl/openssl/pull/15126">https://github.com/openssl/openssl/pull/15126</A>)

-----------------------------------------------------------------------

Summary of changes:
 apps/cms.c                  | 299 +++++++++++----------
 apps/include/opt.h          |   3 +
 apps/lib/opt.c              |  20 +-
 doc/man1/openssl-cms.pod.in | 639 ++++++++++++++++++++++++++------------------
 4 files changed, 547 insertions(+), 414 deletions(-)

diff --git a/apps/cms.c b/apps/cms.c
index d2225d51af..25ef1effd4 100644
--- a/apps/cms.c
+++ b/apps/cms.c
@@ -30,25 +30,25 @@ static CMS_ReceiptRequest
 static int cms_set_pkey_param(EVP_PKEY_CTX *pctx,
                               STACK_OF(OPENSSL_STRING) *param);
 
-#define SMIME_OP        0x10
-#define SMIME_IP        0x20
-#define SMIME_SIGNERS   0x40
+#define SMIME_OP                0x100
+#define SMIME_IP                0x200
+#define SMIME_SIGNERS           0x400
 #define SMIME_ENCRYPT           (1 | SMIME_OP)
 #define SMIME_DECRYPT           (2 | SMIME_IP)
 #define SMIME_SIGN              (3 | SMIME_OP | SMIME_SIGNERS)
 #define SMIME_VERIFY            (4 | SMIME_IP)
-#define SMIME_CMSOUT            (5 | SMIME_IP | SMIME_OP)
-#define SMIME_RESIGN            (6 | SMIME_IP | SMIME_OP | SMIME_SIGNERS)
-#define SMIME_DATAOUT           (7 | SMIME_IP)
-#define SMIME_DATA_CREATE       (8 | SMIME_OP)
+#define SMIME_RESIGN            (5 | SMIME_IP | SMIME_OP | SMIME_SIGNERS)
+#define SMIME_SIGN_RECEIPT      (6 | SMIME_IP | SMIME_OP)
+#define SMIME_VERIFY_RECEIPT    (7 | SMIME_IP)
+#define SMIME_DIGEST_CREATE     (8 | SMIME_OP)
 #define SMIME_DIGEST_VERIFY     (9 | SMIME_IP)
-#define SMIME_DIGEST_CREATE     (10 | SMIME_OP)
+#define SMIME_COMPRESS          (10 | SMIME_OP)
 #define SMIME_UNCOMPRESS        (11 | SMIME_IP)
-#define SMIME_COMPRESS          (12 | SMIME_OP)
+#define SMIME_ENCRYPTED_ENCRYPT (12 | SMIME_OP)
 #define SMIME_ENCRYPTED_DECRYPT (13 | SMIME_IP)
-#define SMIME_ENCRYPTED_ENCRYPT (14 | SMIME_OP)
-#define SMIME_SIGN_RECEIPT      (15 | SMIME_IP | SMIME_OP)
-#define SMIME_VERIFY_RECEIPT    (16 | SMIME_IP)
+#define SMIME_DATA_CREATE       (14 | SMIME_OP)
+#define SMIME_DATA_OUT          (15 | SMIME_IP)
+#define SMIME_CMSOUT            (16 | SMIME_IP | SMIME_OP)
 
 static int verify_err = 0;
 
@@ -89,141 +89,152 @@ typedef enum OPTION_choice {
 
 const OPTIONS cms_options[] = {
     {OPT_HELP_STR, 1, '-', &quot;Usage: %s [options] [cert...]\n&quot;},
+    {&quot;help&quot;, OPT_HELP, '-', &quot;Display this summary&quot;},
 
     OPT_SECTION(&quot;General&quot;),
-    {&quot;help&quot;, OPT_HELP, '-', &quot;Display this summary&quot;},
-    {&quot;inform&quot;, OPT_INFORM, 'c', &quot;Input format SMIME (default), PEM or DER&quot;},
-    {&quot;outform&quot;, OPT_OUTFORM, 'c',
-     &quot;Output format SMIME (default), PEM or DER&quot;},
     {&quot;in&quot;, OPT_IN, '&lt;', &quot;Input file&quot;},
     {&quot;out&quot;, OPT_OUT, '&gt;', &quot;Output file&quot;},
-    {&quot;debug_decrypt&quot;, OPT_DEBUG_DECRYPT, '-',
-        &quot;Disable MMA protection and return an error if no recipient found&quot;
-        &quot; (see documentation)&quot;},
-    {&quot;stream&quot;, OPT_INDEF, '-', &quot;Enable CMS streaming&quot;},
-    {&quot;indef&quot;, OPT_INDEF, '-', &quot;Same as -stream&quot;},
-    {&quot;noindef&quot;, OPT_NOINDEF, '-', &quot;Disable CMS streaming&quot;},
-    {&quot;crlfeol&quot;, OPT_CRLFEOL, '-', &quot;Use CRLF as EOL termination instead of CR only&quot; },
-    {&quot;CAfile&quot;, OPT_CAFILE, '&lt;', &quot;Trusted certificates file&quot;},
-    {&quot;CApath&quot;, OPT_CAPATH, '/', &quot;trusted certificates directory&quot;},
-    {&quot;CAstore&quot;, OPT_CASTORE, ':', &quot;trusted certificates store URI&quot;},
-    {&quot;no-CAfile&quot;, OPT_NOCAFILE, '-',
-     &quot;Do not load the default certificates file&quot;},
-    {&quot;no-CApath&quot;, OPT_NOCAPATH, '-',
-     &quot;Do not load certificates from the default certificates directory&quot;},
-    {&quot;no-CAstore&quot;, OPT_NOCASTORE, '-',
-     &quot;Do not load certificates from the default certificates store&quot;},
-# ifndef OPENSSL_NO_ENGINE
-    {&quot;engine&quot;, OPT_ENGINE, 's', &quot;Use engine e, possibly a hardware device&quot;},
-# endif
     OPT_CONFIG_OPTION,
 
-    OPT_SECTION(&quot;Action&quot;),
+    OPT_SECTION(&quot;Operation&quot;),
     {&quot;encrypt&quot;, OPT_ENCRYPT, '-', &quot;Encrypt message&quot;},
     {&quot;decrypt&quot;, OPT_DECRYPT, '-', &quot;Decrypt encrypted message&quot;},
     {&quot;sign&quot;, OPT_SIGN, '-', &quot;Sign message&quot;},
-    {&quot;sign_receipt&quot;, OPT_SIGN_RECEIPT, '-', &quot;Generate a signed receipt for the message&quot;},
-    {&quot;resign&quot;, OPT_RESIGN, '-', &quot;Resign a signed message&quot;},
-    {&quot;cades&quot;, OPT_CADES, '-', &quot;Include or check signingCertificate (CAdES-BES)&quot;},
     {&quot;verify&quot;, OPT_VERIFY, '-', &quot;Verify signed message&quot;},
-    {&quot;verify_retcode&quot;, OPT_VERIFY_RETCODE, '-',
-        &quot;Exit non-zero on verification failure&quot;},
+    {&quot;resign&quot;, OPT_RESIGN, '-', &quot;Resign a signed message&quot;},
+    {&quot;sign_receipt&quot;, OPT_SIGN_RECEIPT, '-',
+     &quot;Generate a signed receipt for a message&quot;},
     {&quot;verify_receipt&quot;, OPT_VERIFY_RECEIPT, '&lt;',
-        &quot;Verify receipts; exit if receipt signatures do not verify&quot;},
-    {&quot;digest_verify&quot;, OPT_DIGEST_VERIFY, '-',
-        &quot;Verify a CMS \&quot;DigestedData\&quot; object and output it&quot;},
+     &quot;Verify receipts; exit if receipt signatures do not verify&quot;},
     {&quot;digest_create&quot;, OPT_DIGEST_CREATE, '-',
-        &quot;Create a CMS \&quot;DigestedData\&quot; object&quot;},
+     &quot;Create a CMS \&quot;DigestedData\&quot; object&quot;},
+    {&quot;digest_verify&quot;, OPT_DIGEST_VERIFY, '-',
+     &quot;Verify a CMS \&quot;DigestedData\&quot; object and output it&quot;},
     {&quot;compress&quot;, OPT_COMPRESS, '-', &quot;Create a CMS \&quot;CompressedData\&quot; object&quot;},
     {&quot;uncompress&quot;, OPT_UNCOMPRESS, '-',
-        &quot;Uncompress a CMS \&quot;CompressedData\&quot; object&quot;},
-    {&quot;EncryptedData_decrypt&quot;, OPT_ED_DECRYPT, '-',
-        &quot;Decrypt CMS \&quot;EncryptedData\&quot; object using symmetric key&quot;},
+     &quot;Uncompress a CMS \&quot;CompressedData\&quot; object&quot;},
     {&quot;EncryptedData_encrypt&quot;, OPT_ED_ENCRYPT, '-',
-        &quot;Create CMS \&quot;EncryptedData\&quot; object using symmetric key&quot;},
-    {&quot;data_out&quot;, OPT_DATA_OUT, '-', &quot;Copy CMS \&quot;Data\&quot; object to output&quot;},
+     &quot;Create CMS \&quot;EncryptedData\&quot; object using symmetric key&quot;},
+    {&quot;EncryptedData_decrypt&quot;, OPT_ED_DECRYPT, '-',
+     &quot;Decrypt CMS \&quot;EncryptedData\&quot; object using symmetric key&quot;},
     {&quot;data_create&quot;, OPT_DATA_CREATE, '-', &quot;Create a CMS \&quot;Data\&quot; object&quot;},
+    {&quot;data_out&quot;, OPT_DATA_OUT, '-', &quot;Copy CMS \&quot;Data\&quot; object to output&quot;},
     {&quot;cmsout&quot;, OPT_CMSOUT, '-', &quot;Output CMS structure&quot;},
-    {&quot;no_content_verify&quot;, OPT_NO_CONTENT_VERIFY, '-',
-        &quot;Do not verify signed content signatures&quot;},
-    {&quot;no_attr_verify&quot;, OPT_NO_ATTR_VERIFY, '-',
-        &quot;Do not verify signed attribute signatures&quot;},
-    {&quot;nointern&quot;, OPT_NOINTERN, '-',
-        &quot;Don't search certificates in message for signer&quot;},
-    {&quot;noverify&quot;, OPT_NOVERIFY, '-', &quot;Don't verify signers certificate&quot;},
 
-    OPT_SECTION(&quot;Formatting&quot;),
-    {&quot;text&quot;, OPT_TEXT, '-', &quot;Include or delete text MIME headers&quot;},
-    {&quot;asciicrlf&quot;, OPT_ASCIICRLF, '-',
-        &quot;Perform CRLF canonicalisation when signing&quot;},
-    {&quot;nodetach&quot;, OPT_NODETACH, '-', &quot;Use opaque signing&quot;},
-    {&quot;nosmimecap&quot;, OPT_NOSMIMECAP, '-', &quot;Omit the SMIMECapabilities attribute&quot;},
-    {&quot;noattr&quot;, OPT_NOATTR, '-', &quot;Don't include any signed attributes&quot;},
-    {&quot;binary&quot;, OPT_BINARY, '-', &quot;Treat input as binary: do not translate to canonical form&quot;},
-    {&quot;keyid&quot;, OPT_KEYID, '-', &quot;Use subject key identifier&quot;},
-    {&quot;nosigs&quot;, OPT_NOSIGS, '-', &quot;Don't verify message signature&quot;},
-    {&quot;nocerts&quot;, OPT_NOCERTS, '-',
-     &quot;Don't include signers certificate when signing&quot;},
-    {&quot;noout&quot;, OPT_NOOUT, '-',
-        &quot;For the -cmsout operation do not output the parsed CMS structure&quot;},
-    {&quot;receipt_request_print&quot;, OPT_RR_PRINT, '-', &quot;Print CMS Receipt Request&quot; },
-    {&quot;receipt_request_all&quot;, OPT_RR_ALL, '-',
-        &quot;When signing, create a receipt request for all recipients&quot;},
-    {&quot;receipt_request_first&quot;, OPT_RR_FIRST, '-',
-        &quot;When signing, create a receipt request for first recipient&quot;},
+    OPT_SECTION(&quot;File format&quot;),
+    {&quot;inform&quot;, OPT_INFORM, 'c', &quot;Input format SMIME (default), PEM or DER&quot;},
+    {&quot;outform&quot;, OPT_OUTFORM, 'c',
+     &quot;Output format SMIME (default), PEM or DER&quot;},
     {&quot;rctform&quot;, OPT_RCTFORM, 'F', &quot;Receipt file format&quot;},
-    {&quot;certfile&quot;, OPT_CERTFILE, '&lt;', &quot;Other certificates file&quot;},
-    {&quot;content&quot;, OPT_CONTENT, '&lt;',
-     &quot;Supply or override content for detached signature&quot;},
-    {&quot;print&quot;, OPT_PRINT, '-',
-     &quot;For the -cmsout operation print out all fields of the CMS structure&quot;},
-    {&quot;nameopt&quot;, OPT_NAMEOPT, 's',
-     &quot;For the -print option specifies various strings printing options&quot;},
-    {&quot;certsout&quot;, OPT_CERTSOUT, '&gt;', &quot;Certificate output file&quot;},
+    {&quot;stream&quot;, OPT_INDEF, '-', &quot;Enable CMS streaming&quot;},
+    {&quot;indef&quot;, OPT_INDEF, '-', &quot;Same as -stream&quot;},
+    {&quot;noindef&quot;, OPT_NOINDEF, '-', &quot;Disable CMS streaming&quot;},
+    {&quot;binary&quot;, OPT_BINARY, '-',
+     &quot;Treat input as binary: do not translate to canonical form&quot;},
+    {&quot;crlfeol&quot;, OPT_CRLFEOL, '-',
+     &quot;Use CRLF as EOL termination instead of CR only&quot; },
+    {&quot;asciicrlf&quot;, OPT_ASCIICRLF, '-',
+     &quot;Perform CRLF canonicalisation when signing&quot;},
 
-    OPT_SECTION(&quot;Keying&quot;),
+    OPT_SECTION(&quot;Keys and passwords&quot;),
+    {&quot;pwri_password&quot;, OPT_PWRI_PASSWORD, 's',
+     &quot;Specific password for recipient&quot;},
     {&quot;secretkey&quot;, OPT_SECRETKEY, 's',
-        &quot;Use specified hex-encoded key to decrypt/encrypt recipients or content&quot;},
+     &quot;Use specified hex-encoded key to decrypt/encrypt recipients or content&quot;},
     {&quot;secretkeyid&quot;, OPT_SECRETKEYID, 's',
-        &quot;Identity of the -secretkey for CMS \&quot;KEKRecipientInfo\&quot; object&quot;},
-    {&quot;pwri_password&quot;, OPT_PWRI_PASSWORD, 's',
-        &quot;Specific password for recipient&quot;},
-    {&quot;passin&quot;, OPT_PASSIN, 's', &quot;Input file pass phrase source&quot;},
+     &quot;Identity of the -secretkey for CMS \&quot;KEKRecipientInfo\&quot; object&quot;},
     {&quot;inkey&quot;, OPT_INKEY, 's',
      &quot;Input private key (if not signer or recipient)&quot;},
-    {&quot;keyform&quot;, OPT_KEYFORM, 'f', &quot;Input private key format (ENGINE, other values ignored)&quot;},
+    {&quot;passin&quot;, OPT_PASSIN, 's', &quot;Input file pass phrase source&quot;},
     {&quot;keyopt&quot;, OPT_KEYOPT, 's', &quot;Set public key parameters as n:v pairs&quot;},
+    {&quot;keyform&quot;, OPT_KEYFORM, 'f',
+     &quot;Input private key format (ENGINE, other values ignored)&quot;},
+#ifndef OPENSSL_NO_ENGINE
+    {&quot;engine&quot;, OPT_ENGINE, 's', &quot;Use engine e, possibly a hardware device&quot;},
+#endif
+    OPT_PROV_OPTIONS,
+    OPT_R_OPTIONS,
 
-    OPT_SECTION(&quot;Mail header&quot;),
-    {&quot;econtent_type&quot;, OPT_ECONTENT_TYPE, 's', &quot;OID for external content&quot;},
-    {&quot;to&quot;, OPT_TO, 's', &quot;To address&quot;},
-    {&quot;from&quot;, OPT_FROM, 's', &quot;From address&quot;},
-    {&quot;subject&quot;, OPT_SUBJECT, 's', &quot;Subject&quot;},
-    {&quot;signer&quot;, OPT_SIGNER, 's', &quot;Signer certificate file&quot;},
+    OPT_SECTION(&quot;Encryption and decryption&quot;),
     {&quot;originator&quot;, OPT_ORIGINATOR, 's', &quot;Originator certificate file&quot;},
-    {&quot;recip&quot;, OPT_RECIP, '&lt;', &quot;Recipient cert file for decryption&quot;},
-    {&quot;receipt_request_from&quot;, OPT_RR_FROM, 's',
-        &quot;Create signed receipt request with specified email address&quot;},
-    {&quot;receipt_request_to&quot;, OPT_RR_TO, 's',
-        &quot;Create signed receipt targeted to specified address&quot;},
-
-    OPT_SECTION(&quot;Encryption&quot;),
-    {&quot;md&quot;, OPT_MD, 's', &quot;Digest algorithm to use when signing or resigning&quot;},
-    {&quot;&quot;, OPT_CIPHER, '-', &quot;Any supported cipher&quot;},
-
-    OPT_SECTION(&quot;Key-wrapping&quot;),
+    {&quot;recip&quot;, OPT_RECIP, '&lt;', &quot;Recipient cert file&quot;},
+    {&quot;cert...&quot;, OPT_PARAM, '.',
+     &quot;Recipient certs (optional; used only when encrypting)&quot;},
+    {&quot;&quot;, OPT_CIPHER, '-',
+     &quot;The encryption algorithm to use (any supported cipher)&quot;},
+    {&quot;wrap&quot;, OPT_WRAP, 's',
+     &quot;Key wrap algorithm to use when encrypting with key agreement&quot;},
     {&quot;aes128-wrap&quot;, OPT_AES128_WRAP, '-', &quot;Use AES128 to wrap key&quot;},
     {&quot;aes192-wrap&quot;, OPT_AES192_WRAP, '-', &quot;Use AES192 to wrap key&quot;},
     {&quot;aes256-wrap&quot;, OPT_AES256_WRAP, '-', &quot;Use AES256 to wrap key&quot;},
     {&quot;des3-wrap&quot;, OPT_3DES_WRAP, '-', &quot;Use 3DES-EDE to wrap key&quot;},
-    {&quot;wrap&quot;, OPT_WRAP, 's', &quot;Any wrap cipher to wrap key&quot;},
+    {&quot;debug_decrypt&quot;, OPT_DEBUG_DECRYPT, '-',
+     &quot;Disable MMA protection, return error if no recipient found (see doc)&quot;},
 
-    OPT_R_OPTIONS,
-    OPT_V_OPTIONS,
-    OPT_PROV_OPTIONS,
+    OPT_SECTION(&quot;Signing&quot;),
+    {&quot;md&quot;, OPT_MD, 's', &quot;Digest algorithm to use&quot;},
+    {&quot;signer&quot;, OPT_SIGNER, 's', &quot;Signer certificate input file&quot;},
+    {&quot;certfile&quot;, OPT_CERTFILE, '&lt;', &quot;Other certificates file&quot;},
+    {&quot;cades&quot;, OPT_CADES, '-',
+     &quot;Include signingCertificate attribute (CAdES-BES)&quot;},
+    {&quot;nodetach&quot;, OPT_NODETACH, '-', &quot;Use opaque signing&quot;},
+    {&quot;nocerts&quot;, OPT_NOCERTS, '-',
+     &quot;Don't include signer's certificate when signing&quot;},
+    {&quot;noattr&quot;, OPT_NOATTR, '-', &quot;Don't include any signed attributes&quot;},
+    {&quot;nosmimecap&quot;, OPT_NOSMIMECAP, '-', &quot;Omit the SMIMECapabilities attribute&quot;},
+    {&quot;receipt_request_all&quot;, OPT_RR_ALL, '-',
+     &quot;When signing, create a receipt request for all recipients&quot;},
+    {&quot;receipt_request_first&quot;, OPT_RR_FIRST, '-',
+     &quot;When signing, create a receipt request for first recipient&quot;},
+    {&quot;receipt_request_from&quot;, OPT_RR_FROM, 's',
+     &quot;Create signed receipt request with specified email address&quot;},
+    {&quot;receipt_request_to&quot;, OPT_RR_TO, 's',
+     &quot;Create signed receipt targeted to specified address&quot;},
 
-    OPT_PARAMETERS(),
-    {&quot;cert&quot;, 0, 0, &quot;Recipient certs (optional; used only when encrypting)&quot;},
+    OPT_SECTION(&quot;Verification&quot;),
+    {&quot;signer&quot;, OPT_DUP, 's', &quot;Signer certificate(s) output file&quot;},
+    {&quot;content&quot;, OPT_CONTENT, '&lt;',
+     &quot;Supply or override content for detached signature&quot;},
+    {&quot;no_content_verify&quot;, OPT_NO_CONTENT_VERIFY, '-',
+     &quot;Do not verify signed content signatures&quot;},
+    {&quot;no_attr_verify&quot;, OPT_NO_ATTR_VERIFY, '-',
+     &quot;Do not verify signed attribute signatures&quot;},
+    {&quot;nosigs&quot;, OPT_NOSIGS, '-', &quot;Don't verify message signature&quot;},
+    {&quot;noverify&quot;, OPT_NOVERIFY, '-', &quot;Don't verify signers certificate&quot;},
+    {&quot;nointern&quot;, OPT_NOINTERN, '-',
+     &quot;Don't search certificates in message for signer&quot;},
+    {&quot;cades&quot;, OPT_DUP, '-', &quot;Check signingCertificate (CAdES-BES)&quot;},
+    {&quot;verify_retcode&quot;, OPT_VERIFY_RETCODE, '-',
+     &quot;Exit non-zero on verification failure&quot;},
+    {&quot;CAfile&quot;, OPT_CAFILE, '&lt;', &quot;Trusted certificates file&quot;},
+    {&quot;CApath&quot;, OPT_CAPATH, '/', &quot;Trusted certificates directory&quot;},
+    {&quot;CAstore&quot;, OPT_CASTORE, ':', &quot;Trusted certificates store URI&quot;},
+    {&quot;no-CAfile&quot;, OPT_NOCAFILE, '-',
+     &quot;Do not load the default certificates file&quot;},
+    {&quot;no-CApath&quot;, OPT_NOCAPATH, '-',
+     &quot;Do not load certificates from the default certificates directory&quot;},
+    {&quot;no-CAstore&quot;, OPT_NOCASTORE, '-',
+     &quot;Do not load certificates from the default certificates store&quot;},
+
+    OPT_SECTION(&quot;Output&quot;),
+    {&quot;keyid&quot;, OPT_KEYID, '-', &quot;Use subject key identifier&quot;},
+    {&quot;econtent_type&quot;, OPT_ECONTENT_TYPE, 's', &quot;OID for external content&quot;},
+    {&quot;text&quot;, OPT_TEXT, '-', &quot;Include or delete text MIME headers&quot;},
+    {&quot;certsout&quot;, OPT_CERTSOUT, '&gt;', &quot;Certificate output file&quot;},
+    {&quot;to&quot;, OPT_TO, 's', &quot;To address&quot;},
+    {&quot;from&quot;, OPT_FROM, 's', &quot;From address&quot;},
+    {&quot;subject&quot;, OPT_SUBJECT, 's', &quot;Subject&quot;},
+
+    OPT_SECTION(&quot;Printing&quot;),
+    {&quot;noout&quot;, OPT_NOOUT, '-',
+     &quot;For the -cmsout operation do not output the parsed CMS structure&quot;},
+    {&quot;print&quot;, OPT_PRINT, '-',
+     &quot;For the -cmsout operation print out all fields of the CMS structure&quot;},
+    {&quot;nameopt&quot;, OPT_NAMEOPT, 's',
+     &quot;For the -print option specifies various strings printing options&quot;},
+    {&quot;receipt_request_print&quot;, OPT_RR_PRINT, '-', &quot;Print CMS Receipt Request&quot; },
+
+    OPT_V_OPTIONS,
     {NULL}
 };
 
@@ -347,6 +358,7 @@ int cms_main(int argc, char **argv)
         case OPT_OUT:
             outfile = opt_arg();
             break;
+
         case OPT_ENCRYPT:
             operation = SMIME_ENCRYPT;
             break;
@@ -356,49 +368,50 @@ int cms_main(int argc, char **argv)
         case OPT_SIGN:
             operation = SMIME_SIGN;
             break;
-        case OPT_SIGN_RECEIPT:
-            operation = SMIME_SIGN_RECEIPT;
+        case OPT_VERIFY:
+            operation = SMIME_VERIFY;
             break;
         case OPT_RESIGN:
             operation = SMIME_RESIGN;
             break;
-        case OPT_VERIFY:
-            operation = SMIME_VERIFY;
-            break;
-        case OPT_VERIFY_RETCODE:
-            verify_retcode = 1;
+        case OPT_SIGN_RECEIPT:
+            operation = SMIME_SIGN_RECEIPT;
             break;
         case OPT_VERIFY_RECEIPT:
             operation = SMIME_VERIFY_RECEIPT;
             rctfile = opt_arg();
             break;
-        case OPT_CMSOUT:
-            operation = SMIME_CMSOUT;
-            break;
-        case OPT_DATA_OUT:
-            operation = SMIME_DATAOUT;
+        case OPT_VERIFY_RETCODE:
+            verify_retcode = 1;
             break;
-        case OPT_DATA_CREATE:
-            operation = SMIME_DATA_CREATE;
+        case OPT_DIGEST_CREATE:
+            operation = SMIME_DIGEST_CREATE;
             break;
         case OPT_DIGEST_VERIFY:
             operation = SMIME_DIGEST_VERIFY;
             break;
-        case OPT_DIGEST_CREATE:
-            operation = SMIME_DIGEST_CREATE;
-            break;
         case OPT_COMPRESS:
             operation = SMIME_COMPRESS;
             break;
         case OPT_UNCOMPRESS:
             operation = SMIME_UNCOMPRESS;
             break;
+        case OPT_ED_ENCRYPT:
+            operation = SMIME_ENCRYPTED_ENCRYPT;
+            break;
         case OPT_ED_DECRYPT:
             operation = SMIME_ENCRYPTED_DECRYPT;
             break;
-        case OPT_ED_ENCRYPT:
-            operation = SMIME_ENCRYPTED_ENCRYPT;
+        case OPT_DATA_CREATE:
+            operation = SMIME_DATA_CREATE;
+            break;
+        case OPT_DATA_OUT:
+            operation = SMIME_DATA_OUT;
+            break;
+        case OPT_CMSOUT:
+            operation = SMIME_CMSOUT;
             break;
+
         case OPT_DEBUG_DECRYPT:
             flags |= CMS_DEBUG_DECRYPT;
             break;
@@ -693,15 +706,15 @@ int cms_main(int argc, char **argv)
             if (conf == NULL)
                 goto end;
             break;
-        case OPT_3DES_WRAP:
+        case OPT_WRAP:
+            wrapname = opt_unknown();
+            break;
         case OPT_AES128_WRAP:
         case OPT_AES192_WRAP:
         case OPT_AES256_WRAP:
+        case OPT_3DES_WRAP:
             wrapname = opt_flag() + 1;
             break;
-        case OPT_WRAP:
-            wrapname = opt_unknown();
-            break;
         }
     }
     if (!app_RAND_load())
@@ -812,12 +825,12 @@ int cms_main(int argc, char **argv)
 
     if (operation == SMIME_ENCRYPT) {
         if (!cipher) {
-# ifndef OPENSSL_NO_DES
+#ifndef OPENSSL_NO_DES
             cipher = (EVP_CIPHER *)EVP_des_ede3_cbc();
-# else
+#else
             BIO_printf(bio_err, &quot;No cipher selected\n&quot;);
             goto end;
-# endif
+#endif
         }
 
         if (secret_key &amp;&amp; !secret_keyid) {
@@ -1149,7 +1162,7 @@ int cms_main(int argc, char **argv)
             BIO_printf(bio_err, &quot;Error decrypting CMS structure\n&quot;);
             goto end;
         }
-    } else if (operation == SMIME_DATAOUT) {
+    } else if (operation == SMIME_DATA_OUT) {
         if (!CMS_data(cms, out, flags))
             goto end;
     } else if (operation == SMIME_UNCOMPRESS) {
@@ -1177,8 +1190,8 @@ int cms_main(int argc, char **argv)
             goto end;
         }
         if (signerfile != NULL) {
-            STACK_OF(X509) *signers;
-            signers = CMS_get0_signers(cms);
+            STACK_OF(X509) *signers = CMS_get0_signers(cms);
+
             if (!save_certs(signerfile, signers)) {
                 BIO_printf(bio_err,
                            &quot;Error writing signers to %s\n&quot;, signerfile);
diff --git a/apps/include/opt.h b/apps/include/opt.h
index 5d85877301..951557974b 100644
--- a/apps/include/opt.h
+++ b/apps/include/opt.h
@@ -316,6 +316,9 @@ typedef struct options_st {
     int valtype;
     const char *helpstr;
 } OPTIONS;
+/* Special retval values: */
+#define OPT_PARAM 0 /* same as OPT_EOF usually defined in apps */
+#define OPT_DUP -2 /* marks duplicate occurrence of option in help output */
 
 /*
  * A string/int pairing; widely use for option value lookup, hence the
diff --git a/apps/lib/opt.c b/apps/lib/opt.c
index 4b75b46681..0f08da2df4 100644
--- a/apps/lib/opt.c
+++ b/apps/lib/opt.c
@@ -184,9 +184,13 @@ char *opt_init(int ac, char **av, const OPTIONS *o)
 
         /* Make sure options are legit. */
         OPENSSL_assert(o-&gt;name[0] != '-');
-        OPENSSL_assert(o-&gt;retval &gt; 0);
+        if (o-&gt;valtype == '.')
+            OPENSSL_assert(o-&gt;retval == OPT_PARAM);
+        else
+            OPENSSL_assert(o-&gt;retval == OPT_DUP || o-&gt;retval &gt; OPT_PARAM);
         switch (i) {
-        case   0: case '-': case '/': case '&lt;': case '&gt;': case 'E': case 'F':
+        case   0: case '-': case '.':
+        case '/': case '&lt;': case '&gt;': case 'E': case 'F':
         case 'M': case 'U': case 'f': case 'l': case 'n': case 'p': case 's':
         case 'u': case 'c': case ':': case 'N':
             break;
@@ -199,8 +203,13 @@ char *opt_init(int ac, char **av, const OPTIONS *o)
             /*
              * Some compilers inline strcmp and the assert string is too long.
              */
-            duplicated = strcmp(o-&gt;name, next-&gt;name) == 0;
-            OPENSSL_assert(!duplicated);
+            duplicated = next-&gt;retval != OPT_DUP
+                &amp;&amp; strcmp(o-&gt;name, next-&gt;name) == 0;
+            if (duplicated) {
+                opt_printf_stderr(&quot;%s: Internal error: duplicate option %s\n&quot;,
+                                  prog, o-&gt;name);
+                OPENSSL_assert(!duplicated);
+            }
         }
 #endif
         if (o-&gt;name[0] == '\0') {
@@ -821,6 +830,9 @@ int opt_next(void)
         case ':':
             /* Just a string. */
             break;
+        case '.':
+            /* Parameters */
+            break;
         case '/':
             if (opt_isdir(arg) &gt; 0)
                 break;
diff --git a/doc/man1/openssl-cms.pod.in b/doc/man1/openssl-cms.pod.in
index bdfb607134..6e0f86804a 100644
--- a/doc/man1/openssl-cms.pod.in
+++ b/doc/man1/openssl-cms.pod.in
@@ -9,96 +9,131 @@ openssl-cms - CMS command
 
 B&lt;openssl&gt; B&lt;cms&gt;
 [B&lt;-help&gt;]
+
+General options:
+
+[B&lt;-in&gt; I&lt;filename&gt;]
+[B&lt;-out&gt; I&lt;filename&gt;]
+{- $OpenSSL::safe::opt_config_synopsis -}
+
+Operation options:
+
 [B&lt;-encrypt&gt;]
 [B&lt;-decrypt&gt;]
-[B&lt;-debug_decrypt&gt;]
 [B&lt;-sign&gt;]
 [B&lt;-verify&gt;]
-[B&lt;-verify_retcode&gt;]
-[B&lt;-no_attr_verify&gt;]
-[B&lt;-nosigs&gt;]
-[B&lt;-no_content_verify&gt;]
-[B&lt;-cmsout&gt;]
 [B&lt;-resign&gt;]
-[B&lt;-cades&gt;]
-[B&lt;-data_create&gt;]
-[B&lt;-data_out&gt;]
+[B&lt;-sign_receipt&gt;]
+[B&lt;-verify_receipt&gt; I&lt;receipt&gt;]
 [B&lt;-digest_create&gt;]
 [B&lt;-digest_verify&gt;]
 [B&lt;-compress&gt;]
 [B&lt;-uncompress&gt;]
-[B&lt;-EncryptedData_decrypt&gt;]
 [B&lt;-EncryptedData_encrypt&gt;]
-[B&lt;-sign_receipt&gt;]
-[B&lt;-verify_receipt&gt; I&lt;receipt&gt;]
-[B&lt;-in&gt; I&lt;filename&gt;]
-[B&lt;-out&gt; I&lt;filename&gt;]
+[B&lt;-EncryptedData_decrypt&gt;]
+[B&lt;-data_create&gt;]
+[B&lt;-data_out&gt;]
+[B&lt;-cmsout&gt;]
+
+File format options:
+
 [B&lt;-inform&gt; B&lt;DER&gt;|B&lt;PEM&gt;|B&lt;SMIME&gt;]
 [B&lt;-outform&gt; B&lt;DER&gt;|B&lt;PEM&gt;|B&lt;SMIME&gt;]
 [B&lt;-rctform&gt; B&lt;DER&gt;|B&lt;PEM&gt;|B&lt;SMIME&gt;]
-[B&lt;-keyform&gt; B&lt;DER&gt;|B&lt;PEM&gt;|B&lt;P12&gt;|B&lt;ENGINE&gt;]
 [B&lt;-stream&gt;]
 [B&lt;-indef&gt;]
 [B&lt;-noindef&gt;]
-[B&lt;-content&gt; I&lt;filename&gt;]
-[B&lt;-text&gt;]
-[B&lt;-noout&gt;]
-[B&lt;-print&gt;]
-[B&lt;-nameopt&gt; I&lt;option&gt;]
-[B&lt;-md&gt; I&lt;digest&gt;]
+[B&lt;-binary&gt;]
+[B&lt;-crlfeol&gt;]
+[B&lt;-asciicrlf&gt;]
+
+Keys and password options:
+
+[B&lt;-pwri_password&gt; I&lt;password&gt;]
+[B&lt;-secretkey&gt; I&lt;key&gt;]
+[B&lt;-secretkeyid&gt; I&lt;id&gt;]
+[B&lt;-inkey&gt; I&lt;filename&gt;|I&lt;uri&gt;]
+[B&lt;-passin&gt; I&lt;arg&gt;]
+[B&lt;-keyopt&gt; I&lt;name&gt;:I&lt;parameter&gt;]
+[B&lt;-keyform&gt; B&lt;DER&gt;|B&lt;PEM&gt;|B&lt;P12&gt;|B&lt;ENGINE&gt;]
+{- $OpenSSL::safe::opt_engine_synopsis -}{- $OpenSSL::safe::opt_provider_synopsis -}
+{- $OpenSSL::safe::opt_r_synopsis -}
+
+Encryption options:
+
+[B&lt;-originator&gt; I&lt;file&gt;]
+[B&lt;-recip&gt; I&lt;file&gt;]
+[I&lt;recipient-cert&gt; ...]
 [B&lt;-I&lt;cipher&gt;&gt;]
 [B&lt;-wrap&gt; I&lt;cipher&gt;]
 [B&lt;-aes128-wrap&gt;]
 [B&lt;-aes192-wrap&gt;]
 [B&lt;-aes256-wrap&gt;]
 [B&lt;-des3-wrap&gt;]
-[B&lt;-nointern&gt;]
-[B&lt;-noverify&gt;]
+[B&lt;-debug_decrypt&gt;]
+
+Signing options:
+
+[B&lt;-md&gt; I&lt;digest&gt;]
+[B&lt;-signer&gt; I&lt;file&gt;]
+[B&lt;-certfile&gt; I&lt;file&gt;]
+[B&lt;-cades&gt;]
+[B&lt;-nodetach&gt;]
 [B&lt;-nocerts&gt;]
 [B&lt;-noattr&gt;]
 [B&lt;-nosmimecap&gt;]
-[B&lt;-binary&gt;]
-[B&lt;-crlfeol&gt;]
-[B&lt;-asciicrlf&gt;]
-[B&lt;-nodetach&gt;]
-[B&lt;-certfile&gt; I&lt;file&gt;]
-[B&lt;-certsout&gt; I&lt;file&gt;]
-[B&lt;-signer&gt; I&lt;file&gt;]
-[B&lt;-originator&gt; I&lt;file&gt;]
-[B&lt;-recip&gt; I&lt;file&gt;]
-[B&lt;-keyid&gt;]
 [B&lt;-receipt_request_all&gt;]
 [B&lt;-receipt_request_first&gt;]
 [B&lt;-receipt_request_from&gt; I&lt;emailaddress&gt;]
 [B&lt;-receipt_request_to&gt; I&lt;emailaddress&gt;]
-[B&lt;-receipt_request_print&gt;]
-[B&lt;-pwri_password&gt; I&lt;password&gt;]
-[B&lt;-secretkey&gt; I&lt;key&gt;]
-[B&lt;-secretkeyid&gt; I&lt;id&gt;]
+
+Verification options:
+
+[B&lt;-signer&gt; I&lt;file&gt;]
+[B&lt;-content&gt; I&lt;filename&gt;]
+[B&lt;-no_content_verify&gt;]
+[B&lt;-no_attr_verify&gt;]
+[B&lt;-nosigs&gt;]
+[B&lt;-noverify&gt;]
+[B&lt;-nointern&gt;]
+[B&lt;-cades&gt;]
+[B&lt;-verify_retcode&gt;]
+{- $OpenSSL::safe::opt_trust_synopsis -}
+
+Output options:
+
+[B&lt;-keyid&gt;]
 [B&lt;-econtent_type&gt; I&lt;type&gt;]
-[B&lt;-inkey&gt; I&lt;filename&gt;|I&lt;uri&gt;]
-[B&lt;-keyopt&gt; I&lt;name&gt;:I&lt;parameter&gt;]
-[B&lt;-passin&gt; I&lt;arg&gt;]
+[B&lt;-text&gt;]
+[B&lt;-certsout&gt; I&lt;file&gt;]
 [B&lt;-to&gt; I&lt;addr&gt;]
 [B&lt;-from&gt; I&lt;addr&gt;]
 [B&lt;-subject&gt; I&lt;subj&gt;]
+
+Printing options:
+
+[B&lt;-noout&gt;]
+[B&lt;-print&gt;]
+[B&lt;-nameopt&gt; I&lt;option&gt;]
+[B&lt;-receipt_request_print&gt;]
+
+Validation options:
+
 {- $OpenSSL::safe::opt_v_synopsis -}
-{- $OpenSSL::safe::opt_trust_synopsis -}
-{- $OpenSSL::safe::opt_r_synopsis -}
-{- $OpenSSL::safe::opt_engine_synopsis -}{- $OpenSSL::safe::opt_provider_synopsis -}
-{- $OpenSSL::safe::opt_config_synopsis -}
-[I&lt;recipient-cert&gt; ...]
 
 =head1 DESCRIPTION
 
-This command handles S/MIME v3.1 mail. It can encrypt, decrypt,
-sign and verify, compress and uncompress S/MIME messages.
+This command handles data in CMS format such as S/MIME v3.1 email messages.
+It can encrypt, decrypt, sign, verify, compress, uncompress, and print messages.
 
 =head1 OPTIONS
 
-There are fourteen operation options that set the type of operation to be
-performed. The meaning of the other options varies according to the operation
-type.
+There are a number of operation options that set the type of operation to be
+performed: encrypt, decrypt, sign, verify, resign, sign_receipt, verify_receipt,
+digest_create, digest_verify, compress, uncompress,
+EncryptedData_encrypt, EncryptedData_decrypt, data_create, data_out, or cmsout.
+The relevance of the other options depends on the operation type
+and their meaning may vary according to it.
 
 =over 4
 
@@ -106,77 +141,71 @@ type.
 
 Print out a usage message.
 
-=item B&lt;-encrypt&gt;
-
-Encrypt mail for the given recipient certificates. Input file is the message
-to be encrypted. The output file is the encrypted mail in MIME format. The
-actual CMS type is B&lt;EnvelopedData&gt;.
+=back
 
-Note that no revocation check is done for the recipient cert, so if that
-key has been compromised, others may be able to decrypt the text.
+=head2 General options
 
-=item B&lt;-decrypt&gt;
+=over 4
 
-Decrypt mail using the supplied certificate and private key. Expects an
-encrypted mail message in MIME format for the input file. The decrypted mail
-is written to the output file.
+=item B&lt;-in&gt; I&lt;filename&gt;
 
-=item B&lt;-debug_decrypt&gt;
+The input message to be encrypted or signed or the message to be decrypted
+or verified.
 
-This option sets the B&lt;CMS_DEBUG_DECRYPT&gt; flag. This option should be used
-with caution: see the notes section below.
+=item B&lt;-out&gt; I&lt;filename&gt;
 
-=item B&lt;-sign&gt;
+The message text that has been decrypted or verified or the output MIME
+format message that has been signed or verified.
 
-Sign mail using the supplied certificate and private key. Input file is
-the message to be signed. The signed message in MIME format is written
-to the output file.
+{- $OpenSSL::safe::opt_config_item -}
 
-=item B&lt;-verify&gt;
+=back
 
-Verify signed mail. Expects a signed mail message on input and outputs
-the signed data. Both clear text and opaque signing is supported.
+=head2 Operation options
 
-=item B&lt;-verify_retcode&gt;
+=over 4
 
-Exit nonzero on verification failure.
+=item B&lt;-encrypt&gt;
 
-=item B&lt;-no_attr_verify&gt;
+Encrypt data for the given recipient certificates. Input file is the message
+to be encrypted. The output file is the encrypted data in MIME format. The
+actual CMS type is B&lt;EnvelopedData&gt;.
 
-Do not verify signed attribute signatures.
+Note that no revocation check is done for the recipient cert, so if that
+key has been compromised, others may be able to decrypt the text.
 
-=item B&lt;-no_content_verify&gt;
+=item B&lt;-decrypt&gt;
 
-Do not verify signed content signatures.
+Decrypt data using the supplied certificate and private key. Expects
+encrypted datain MIME format for the input file. The decrypted data
+is written to the output file.
 
-=item B&lt;-nosigs&gt;
+=item B&lt;-sign&gt;
 
-Don't verify message signature.
+Sign data using the supplied certificate and private key. Input file is
+the message to be signed. The signed data in MIME format is written
+to the output file.
 
-=item B&lt;-cmsout&gt;
+=item B&lt;-verify&gt;
 
-Takes an input message and writes out a PEM encoded CMS structure.
+Verify signed data. Expects a signed data on input and outputs
+the signed data. Both clear text and opaque signing is supported.
 
 =item B&lt;-resign&gt;
 
 Resign a message: take an existing message and one or more new signers.
 
-=item B&lt;-cades&gt;
-
-When used with B&lt;-sign&gt;,
-add an ESS signingCertificate or ESS signingCertificateV2 signed-attribute
-to the SignerInfo, in order to make the signature comply with the requirements
-for a CAdES Basic Electronic Signature (CAdES-BES).
-When used with B&lt;-verify&gt;, require and check signer certificate digest.
-See the NOTES section for more details.
-
-=item B&lt;-data_create&gt;
+=item B&lt;-sign_receipt&gt;
 
-Create a CMS B&lt;Data&gt; type.
+Generate and output a signed receipt for the supplied message. The input
+message B&lt;must&gt; contain a signed receipt request. Functionality is otherwise
+similar to the B&lt;-sign&gt; operation.
 
-=item B&lt;-data_out&gt;
+=item B&lt;-verify_receipt&gt; I&lt;receipt&gt;
 
-B&lt;Data&gt; type and output the content.
+Verify a signed receipt in filename B&lt;receipt&gt;. The input message B&lt;must&gt;
+contain the original receipt request. Functionality is otherwise similar
+to the B&lt;-verify&gt; operation.
 
 =item B&lt;-digest_create&gt;
 
@@ -197,37 +226,33 @@ Uncompress a CMS B&lt;CompressedData&gt; type and output the content. OpenSSL must be
 compiled with B&lt;zlib&gt; support for this option to work, otherwise it will
 output an error.
 
-=item B&lt;-EncryptedData_decrypt&gt;
+=item B&lt;-EncryptedData_encrypt&gt;
 
-Decrypt content using supplied symmetric key and algorithm using a CMS
+Encrypt content using supplied symmetric key and algorithm using a CMS
 B&lt;EncryptedData&gt; type and output the content.
 
-=item B&lt;-EncryptedData_encrypt&gt;
+=item B&lt;-EncryptedData_decrypt&gt;
 
-Encrypt content using supplied symmetric key and algorithm using a CMS
+Decrypt content using supplied symmetric key and algorithm using a CMS
 B&lt;EncryptedData&gt; type and output the content.
 
-=item B&lt;-sign_receipt&gt;
+=item B&lt;-data_create&gt;
 
-Generate and output a signed receipt for the supplied message. The input
-message B&lt;must&gt; contain a signed receipt request. Functionality is otherwise
-similar to the B&lt;-sign&gt; operation.
+Create a CMS B&lt;Data&gt; type.
 
-=item B&lt;-verify_receipt&gt; I&lt;receipt&gt;
+=item B&lt;-data_out&gt;
 
-Verify a signed receipt in filename B&lt;receipt&gt;. The input message B&lt;must&gt;
-contain the original receipt request. Functionality is otherwise similar
-to the B&lt;-verify&gt; operation.
+B&lt;Data&gt; type and output the content.
 
-=item B&lt;-in&gt; I&lt;filename&gt;
+=item B&lt;-cmsout&gt;
 
-The input message to be encrypted or signed or the message to be decrypted
-or verified.
+Takes an input message and writes out a PEM encoded CMS structure.
 
-=item B&lt;-out&gt; I&lt;filename&gt;
+=back
 
-The message text that has been decrypted or verified or the output MIME
-format message that has been signed or verified.
+=head2 File format options
+
+=over 4
 
 =item B&lt;-inform&gt; B&lt;DER&gt;|B&lt;PEM&gt;|B&lt;SMIME&gt;
 
@@ -241,68 +266,132 @@ The output format of the CMS structure (if one is being written);
 the default is B&lt;SMIME&gt;.
 See L&lt;openssl-format-options(1)&gt; for details.
 
-=item B&lt;-keyform&gt; B&lt;DER&gt;|B&lt;PEM&gt;|B&lt;P12&gt;|B&lt;ENGINE&gt;
-
-The format of the private key file; unspecified by default.
-See L&lt;openssl-format-options(1)&gt; for details.
-
 =item B&lt;-rctform&gt; B&lt;DER&gt;|B&lt;PEM&gt;|B&lt;SMIME&gt;
 
 The signed receipt format for use with the B&lt;-receipt_verify&gt;; the default
 is B&lt;SMIME&gt;.
 See L&lt;openssl-format-options(1)&gt; for details.
 
-=item B&lt;-stream&gt;, B&lt;-indef&gt;
+=item B&lt;-stream&gt;, B&lt;-indef&gt;
+
+The B&lt;-stream&gt; and B&lt;-indef&gt; options are equivalent and enable streaming I/O
+for encoding operations. This permits single pass processing of data without
+the need to hold the entire contents in memory, potentially supporting very
+large files. Streaming is automatically set for S/MIME signing with detached
+data if the output format is B&lt;SMIME&gt; it is currently off by default for all
+other operations.
+
+=item B&lt;-noindef&gt;
+
+Disable streaming I/O where it would produce and indefinite length constructed
+encoding. This option currently has no effect. In future streaming will be
+enabled by default on all relevant operations and this option will disable it.
+
+=item B&lt;-binary&gt;
+
+Normally the input message is converted to &quot;canonical&quot; format which is
+effectively using CR and LF as end of line: as required by the S/MIME
+specification. When this option is present no translation occurs. This
+is useful when handling binary data which may not be in MIME format.
+
+=item B&lt;-crlfeol&gt;
+
+Normally the output file uses a single B&lt;LF&gt; as end of line. When this
+option is present B&lt;CRLF&gt; is used instead.
+
+=item B&lt;-asciicrlf&gt;
+
+When signing use ASCII CRLF format canonicalisation. This strips trailing
+whitespace from all lines, deletes trailing blank lines at EOF and sets
+the encapsulated content type. This option is normally used with detached
+content and an output signature format of DER. This option is not normally
+needed when verifying as it is enabled automatically if the encapsulated
+content format is detected.
+
+=back
+
+=head2 Keys and password options
+
+=over 4
+
+=item B&lt;-pwri_password&gt; I&lt;password&gt;
+
+Specify password for recipient.
+
+=item B&lt;-secretkey&gt; I&lt;key&gt;
+
+Specify symmetric key to use. The key must be supplied in hex format and be
+consistent with the algorithm used. Supported by the B&lt;-EncryptedData_encrypt&gt;
+B&lt;-EncryptedData_decrypt&gt;, B&lt;-encrypt&gt; and B&lt;-decrypt&gt; options. When used
+with B&lt;-encrypt&gt; or B&lt;-decrypt&gt; the supplied key is used to wrap or unwrap the
+content encryption key using an AES key in the B&lt;KEKRecipientInfo&gt; type.
+
+=item B&lt;-secretkeyid&gt; I&lt;id&gt;
+
+The key identifier for the supplied symmetric key for B&lt;KEKRecipientInfo&gt; type.
+This option B&lt;must&gt; be present if the B&lt;-secretkey&gt; option is used with
+B&lt;-encrypt&gt;. With B&lt;-decrypt&gt; operations the I&lt;id&gt; is used to locate the
+relevant key if it is not supplied then an attempt is used to decrypt any
+B&lt;KEKRecipientInfo&gt; structures.
+
+=item B&lt;-inkey&gt; I&lt;filename&gt;|I&lt;uri&gt;
+
+The private key to use when signing or decrypting. This must match the
+corresponding certificate. If this option is not specified then the
+private key must be included in the certificate file specified with
+the B&lt;-recip&gt; or B&lt;-signer&gt; file. When signing this option can be used
+multiple times to specify successive keys.
+
+=item B&lt;-passin&gt; I&lt;arg&gt;
+
+The private key password source. For more information about the format of B&lt;arg&gt;
+see L&lt;openssl-passphrase-options(1)&gt;.
+
+=item B&lt;-keyopt&gt; I&lt;name&gt;:I&lt;parameter&gt;
+
+For signing and encryption this option can be used multiple times to
+set customised parameters for the preceding key or certificate. It can
+currently be used to set RSA-PSS for signing, RSA-OAEP for encryption
+or to modify default parameters for ECDH.
+
+=item B&lt;-keyform&gt; B&lt;DER&gt;|B&lt;PEM&gt;|B&lt;P12&gt;|B&lt;ENGINE&gt;
 
-The B&lt;-stream&gt; and B&lt;-indef&gt; options are equivalent and enable streaming I/O
-for encoding operations. This permits single pass processing of data without
-the need to hold the entire contents in memory, potentially supporting very
-large files. Streaming is automatically set for S/MIME signing with detached
-data if the output format is B&lt;SMIME&gt; it is currently off by default for all
-other operations.
+The format of the private key file; unspecified by default.
+See L&lt;openssl-format-options(1)&gt; for details.
 
-=item B&lt;-noindef&gt;
+{- $OpenSSL::safe::opt_engine_item -}
 
-Disable streaming I/O where it would produce and indefinite length constructed
-encoding. This option currently has no effect. In future streaming will be
-enabled by default on all relevant operations and this option will disable it.
+{- $OpenSSL::safe::opt_provider_item -}
 
-=item B&lt;-content&gt; I&lt;filename&gt;
+{- $OpenSSL::safe::opt_r_item -}
 
-This specifies a file containing the detached content, this is only
-useful with the B&lt;-verify&gt; command. This is only usable if the CMS
-structure is using the detached signature form where the content is
-not included. This option will override any content if the input format
-is S/MIME and it uses the multipart/signed MIME content type.
+=back
 
-=item B&lt;-text&gt;
+=head2 Encryption and decryption options
 
-This option adds plain text (text/plain) MIME headers to the supplied
-message if encrypting or signing. If decrypting or verifying it strips
-off text headers: if the decrypted or verified message is not of MIME
-type text/plain then an error occurs.
+=over 4
 
-=item B&lt;-noout&gt;
+=item B&lt;-originator&gt; I&lt;file&gt;
 
-For the B&lt;-cmsout&gt; operation do not output the parsed CMS structure. This
-is useful when combined with the B&lt;-print&gt; option or if the syntax of the CMS
-structure is being checked.
+A certificate of the originator of the encrypted message. Necessary for
+decryption when Key Agreement is in use for a shared key.
 
-=item B&lt;-print&gt;
+=item B&lt;-recip&gt; I&lt;file&gt;
 
-For the B&lt;-cmsout&gt; operation print out all fields of the CMS structure. This
-is mainly useful for testing purposes.
+When decrypting a message this specifies the certificate of the recipient.
+The certificate must match one of the recipients of the message.
 
-=item B&lt;-nameopt&gt; I&lt;option&gt;
+When encrypting a message this option may be used multiple times to specify
+each recipient. This form B&lt;must&gt; be used if customised parameters are
+required (for example to specify RSA-OAEP).
 
-For the B&lt;-cmsout&gt; operation when B&lt;-print&gt; option is in use, specifies
-printing options for string fields. For most cases B&lt;utf8&gt; is reasonable value.
-See L&lt;openssl-namedisplay-options(1)&gt; for details.
+Only certificates carrying RSA, Diffie-Hellman or EC keys are supported by this
+option.
 
-=item B&lt;-md&gt; I&lt;digest&gt;
+=item I&lt;recipient-cert&gt; ...
 
-Digest algorithm to use when signing or resigning. If not present then the
-default digest algorithm for the signing key will be used (usually SHA1).
+This is an alternative to using the B&lt;-recip&gt; option when encrypting a message.
+One or more certificate filennames may be given.
 
 =item B&lt;-I&lt;cipher&gt;&gt;
 
@@ -327,17 +416,49 @@ wrap.
 =item B&lt;-aes128-wrap&gt;, B&lt;-aes192-wrap&gt;, B&lt;-aes256-wrap&gt;, B&lt;-des3-wrap&gt;
 
 Use AES128, AES192, AES256, or 3DES-EDE, respectively, to wrap key.
+Depending on the OpenSSL build options used, B&lt;-des3-wrap&gt; may not be supported.
 
-=item B&lt;-nointern&gt;
+=item B&lt;-debug_decrypt&gt;
 
-When verifying a message normally certificates (if any) included in
-the message are searched for the signing certificate. With this option
-only the certificates specified in the B&lt;-certfile&gt; option are used.
-The supplied certificates can still be used as untrusted CAs however.
+This option sets the B&lt;CMS_DEBUG_DECRYPT&gt; flag. This option should be used
+with caution: see the notes section below.
 
-=item B&lt;-noverify&gt;
+=back
 
-Do not verify the signers certificate of a signed message.
+=head2 Signing options
+
+=over 4
+
+=item B&lt;-md&gt; I&lt;digest&gt;
+
+Digest algorithm to use when signing or resigning. If not present then the
+default digest algorithm for the signing key will be used (usually SHA1).
+
+=item B&lt;-signer&gt; I&lt;file&gt;
+
+A signing certificate.  When signing or resigning a message, this option can be
+used multiple times if more than one signer is required.
+
+=item B&lt;-certfile&gt; I&lt;file&gt;
+
+Allows additional certificates to be specified. When signing these will
+be included with the message. When verifying these will be searched for
+the signers certificates.
+The input can be in PEM, DER, or PKCS#12 format.
+
+=item B&lt;-cades&gt;
+
+When used with B&lt;-sign&gt;,
+add an ESS signingCertificate or ESS signingCertificateV2 signed-attribute
+to the SignerInfo, in order to make the signature comply with the requirements
+for a CAdES Basic Electronic Signature (CAdES-BES).
+
+=item B&lt;-nodetach&gt;
+
+When signing a message use opaque signing: this form is more resistant
+to translation by mail relays but it cannot be read by mail agents that
+do not support S/MIME.  Without this option cleartext signing with
+the MIME type multipart/signed is used.
 
 =item B&lt;-nocerts&gt;
 
@@ -357,116 +478,86 @@ option they are not included.
 Exclude the list of supported algorithms from signed attributes, other options
 such as signing time and content type are still included.
 
-=item B&lt;-binary&gt;
-
-Normally the input message is converted to &quot;canonical&quot; format which is
-effectively using CR and LF as end of line: as required by the S/MIME
-specification. When this option is present no translation occurs. This
-is useful when handling binary data which may not be in MIME format.
-
-=item B&lt;-crlfeol&gt;
-
-Normally the output file uses a single B&lt;LF&gt; as end of line. When this
-option is present B&lt;CRLF&gt; is used instead.
+=item B&lt;-receipt_request_all&gt;, B&lt;-receipt_request_first&gt;
 
-=item B&lt;-asciicrlf&gt;
+For B&lt;-sign&gt; option include a signed receipt request. Indicate requests should
+be provided by all recipient or first tier recipients (those mailed directly
+and not from a mailing list). Ignored it B&lt;-receipt_request_from&gt; is included.
 
-When signing use ASCII CRLF format canonicalisation. This strips trailing
-whitespace from all lines, deletes trailing blank lines at EOF and sets
-the encapsulated content type. This option is normally used with detached
-content and an output signature format of DER. This option is not normally
-needed when verifying as it is enabled automatically if the encapsulated
-content format is detected.
+=item B&lt;-receipt_request_from&gt; I&lt;emailaddress&gt;
 
-=item B&lt;-nodetach&gt;
+For B&lt;-sign&gt; option include a signed receipt request. Add an explicit email
+address where receipts should be supplied.
 
-When signing a message use opaque signing: this form is more resistant
-to translation by mail relays but it cannot be read by mail agents that
-do not support S/MIME.  Without this option cleartext signing with
-the MIME type multipart/signed is used.
+=item B&lt;-receipt_request_to&gt; I&lt;emailaddress&gt;
 
-=item B&lt;-certfile&gt; I&lt;file&gt;
+Add an explicit email address where signed receipts should be sent to. This
+option B&lt;must&gt; but supplied if a signed receipt is requested.
 
-Allows additional certificates to be specified. When signing these will
-be included with the message. When verifying these will be searched for
-the signers certificates.
-The input can be in PEM, DER, or PKCS#12 format.
+=back
 
-=item B&lt;-certsout&gt; I&lt;file&gt;
+=head2 Verification options
 
-Any certificates contained in the message are written to I&lt;file&gt;.
+=over 4
 
 =item B&lt;-signer&gt; I&lt;file&gt;
 
-A signing certificate when signing or resigning a message, this option can be
-used multiple times if more than one signer is required. If a message is being
-verified then the signers certificates will be written to this file if the
-verification was successful.
+If a message has been verified successfully then the signers certificate(s)
+will be written to this file if the verification was successful.
 
-=item B&lt;-originator&gt; I&lt;file&gt;
+=item B&lt;-content&gt; I&lt;filename&gt;
 
-A certificate of the originator of the encrypted message. Necessary for
-decryption when Key Agreement is in use for a shared key.
+This specifies a file containing the detached content, this is only
+useful with the B&lt;-verify&gt; command. This is only usable if the CMS
+structure is using the detached signature form where the content is
+not included. This option will override any content if the input format
+is S/MIME and it uses the multipart/signed MIME content type.
 
-=item B&lt;-recip&gt; I&lt;file&gt;
+=item B&lt;-no_content_verify&gt;
 
-When decrypting a message this specifies the recipients certificate. The
-certificate must match one of the recipients of the message or an error
-occurs.
+Do not verify signed content signatures.
 
-When encrypting a message this option may be used multiple times to specify
-each recipient. This form B&lt;must&gt; be used if customised parameters are
-required (for example to specify RSA-OAEP).
+=item B&lt;-no_attr_verify&gt;
 
-Only certificates carrying RSA, Diffie-Hellman or EC keys are supported by this
-option.
+Do not verify signed attribute signatures.
 
-=item B&lt;-keyid&gt;
+=item B&lt;-nosigs&gt;
 
-Use subject key identifier to identify certificates instead of issuer name and
-serial number. The supplied certificate B&lt;must&gt; include a subject key
-identifier extension. Supported by B&lt;-sign&gt; and B&lt;-encrypt&gt; options.
+Don't verify message signature.
 
-=item B&lt;-receipt_request_all&gt;, B&lt;-receipt_request_first&gt;
+=item B&lt;-noverify&gt;
 
-For B&lt;-sign&gt; option include a signed receipt request. Indicate requests should
-be provided by all recipient or first tier recipients (those mailed directly
-and not from a mailing list). Ignored it B&lt;-receipt_request_from&gt; is included.
+Do not verify the signers certificate of a signed message.
 
-=item B&lt;-receipt_request_from&gt; I&lt;emailaddress&gt;
+=item B&lt;-nointern&gt;
 
-For B&lt;-sign&gt; option include a signed receipt request. Add an explicit email
-address where receipts should be supplied.
+When verifying a message normally certificates (if any) included in
+the message are searched for the signing certificate. With this option
+only the certificates specified in the B&lt;-certfile&gt; option are used.
+The supplied certificates can still be used as untrusted CAs however.
 
-=item B&lt;-receipt_request_to&gt; I&lt;emailaddress&gt;
+=item B&lt;-cades&gt;
 
-Add an explicit email address where signed receipts should be sent to. This
-option B&lt;must&gt; but supplied if a signed receipt it requested.
+When used with B&lt;-verify&gt;, require and check signer certificate digest.
+See the NOTES section for more details.
 
-=item B&lt;-receipt_request_print&gt;
+=item B&lt;-verify_retcode&gt;
 
-For the B&lt;-verify&gt; operation print out the contents of any signed receipt
-requests.
+Exit nonzero on verification failure.
 
-=item B&lt;-pwri_password&gt; I&lt;password&gt;
+{- $OpenSSL::safe::opt_trust_item -}
 
-Specify password for recipient.
+=back
 
-=item B&lt;-secretkey&gt; I&lt;key&gt;
+=head2 Output options
 
-Specify symmetric key to use. The key must be supplied in hex format and be
-consistent with the algorithm used. Supported by the B&lt;-EncryptedData_encrypt&gt;
-B&lt;-EncryptedData_decrypt&gt;, B&lt;-encrypt&gt; and B&lt;-decrypt&gt; options. When used
-with B&lt;-encrypt&gt; or B&lt;-decrypt&gt; the supplied key is used to wrap or unwrap the
-content encryption key using an AES key in the B&lt;KEKRecipientInfo&gt; type.
+=over 4
 
-=item B&lt;-secretkeyid&gt; I&lt;id&gt;
+=item B&lt;-keyid&gt;
 
-The key identifier for the supplied symmetric key for B&lt;KEKRecipientInfo&gt; type.
-This option B&lt;must&gt; be present if the B&lt;-secretkey&gt; option is used with
-B&lt;-encrypt&gt;. With B&lt;-decrypt&gt; operations the I&lt;id&gt; is used to locate the
-relevant key if it is not supplied then an attempt is used to decrypt any
-B&lt;KEKRecipientInfo&gt; structures.
+Use subject key identifier to identify certificates instead of issuer name and
+serial number. The supplied certificate B&lt;must&gt; include a subject key
+identifier extension. Supported by B&lt;-sign&gt; and B&lt;-encrypt&gt; options.
 
 =item B&lt;-econtent_type&gt; I&lt;type&gt;
 
@@ -474,51 +565,61 @@ Set the encapsulated content type to I&lt;type&gt; if not supplied the B&lt;Data&gt; type
 is used. The I&lt;type&gt; argument can be any valid OID name in either text or
 numerical format.
 
-=item B&lt;-inkey&gt; I&lt;filename&gt;|I&lt;uri&gt;
-
-The private key to use when signing or decrypting. This must match the
-corresponding certificate. If this option is not specified then the
-private key must be included in the certificate file specified with
-the B&lt;-recip&gt; or B&lt;-signer&gt; file. When signing this option can be used
-multiple times to specify successive keys.
-
-=item B&lt;-keyopt&gt; I&lt;name&gt;:I&lt;parameter&gt;
+=item B&lt;-text&gt;
 
-For signing and encryption this option can be used multiple times to
-set customised parameters for the preceding key or certificate. It can
-currently be used to set RSA-PSS for signing, RSA-OAEP for encryption
-or to modify default parameters for ECDH.
+This option adds plain text (text/plain) MIME headers to the supplied
+message if encrypting or signing. If decrypting or verifying it strips
+off text headers: if the decrypted or verified message is not of MIME
+type text/plain then an error occurs.
 
-=item B&lt;-passin&gt; I&lt;arg&gt;
+=item B&lt;-certsout&gt; I&lt;file&gt;
 
-The private key password source. For more information about the format of B&lt;arg&gt;
-see L&lt;openssl-passphrase-options(1)&gt;.
+Any certificates contained in the input message are written to I&lt;file&gt;.
 
 =item B&lt;-to&gt;, B&lt;-from&gt;, B&lt;-subject&gt;
 
-The relevant mail headers. These are included outside the signed
+The relevant email headers. These are included outside the signed
 portion of a message so they may be included manually. If signing
 then many S/MIME mail clients check the signers certificate's email
 address matches that specified in the From: address.
 
-{- $OpenSSL::safe::opt_v_item -}
+=back
 
-Any verification errors cause the command to exit.
+=head2 Printing options
 
-{- $OpenSSL::safe::opt_trust_item -}
+=over 4
 
-{- $OpenSSL::safe::opt_r_item -}
+=item B&lt;-noout&gt;
 
-{- $OpenSSL::safe::opt_engine_item -}
+For the B&lt;-cmsout&gt; operation do not output the parsed CMS structure.
+This is useful if the syntax of the CMS structure is being checked.
 
-{- $OpenSSL::safe::opt_provider_item -}
+=item B&lt;-print&gt;
 
-{- $OpenSSL::safe::opt_config_item -}
+For the B&lt;-cmsout&gt; operation print out all fields of the CMS structure.
+This implies B&lt;-noout&gt;.
+This is mainly useful for testing purposes.
 
-=item I&lt;recipient-cert&gt; ...
+=item B&lt;-nameopt&gt; I&lt;option&gt;
+
+For the B&lt;-cmsout&gt; operation when B&lt;-print&gt; option is in use, specifies
+printing options for string fields. For most cases B&lt;utf8&gt; is reasonable value.
+See L&lt;openssl-namedisplay-options(1)&gt; for details.
+
+=item B&lt;-receipt_request_print&gt;
+
+For the B&lt;-verify&gt; operation print out the contents of any signed receipt
+requests.
+
+=back
+
+=head2 Validation options
+
+=over 4
 
-One or more certificates of message recipients: used when encrypting
-a message.
+{- $OpenSSL::safe::opt_v_item -}
+
+Any validation errors cause the command to exit.
 
 =back
 
@@ -710,7 +811,7 @@ Sign and encrypt mail:
 Note: the encryption command does not include the B&lt;-text&gt; option because the
 message being encrypted already has MIME headers.
 
-Decrypt mail:
+Decrypt a message:
 
  openssl cms -decrypt -in mail.msg -recip mycert.pem -inkey key.pem
 
@@ -738,12 +839,12 @@ Add a signer to an existing message:
 
  openssl cms -resign -in mail.msg -signer newsign.pem -out mail2.msg
 
-Sign mail using RSA-PSS:
+Sign a message using RSA-PSS:
 
  openssl cms -sign -in message.txt -text -out mail.msg \
         -signer mycert.pem -keyopt rsa_padding_mode:pss
 
-Create encrypted mail using RSA-OAEP:
+Create an encrypted message using RSA-OAEP:
 
  openssl cms -encrypt -in plain.txt -out mail.msg \
         -recip cert.pem -keyopt rsa_padding_mode:oaep
@@ -753,6 +854,10 @@ Use SHA256 KDF with an ECDH certificate:
  openssl cms -encrypt -in plain.txt -out mail.msg \
         -recip ecdhcert.pem -keyopt ecdh_kdf_md:sha256
 
+Print CMS signed binary data in human-readable form:
+
+openssl cms -in signed.cms -binary -inform DER -cmsout -print
+
 =head1 BUGS
 
 The MIME parser isn't very clever: it seems to handle most messages that I've
</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="034353.html">[openssl]  master update
</A></li>
	<LI>Next message: <A HREF="034355.html">[openssl]  master update
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#34354">[ date ]</a>
              <a href="thread.html#34354">[ thread ]</a>
              <a href="subject.html#34354">[ subject ]</a>
              <a href="author.html#34354">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="../../../mailman/listinfo/openssl-commits.html">More information about the openssl-commits
mailing list</a><br>
</body></html>
