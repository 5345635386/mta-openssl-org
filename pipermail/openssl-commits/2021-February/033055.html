<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [openssl]  master update
   </TITLE>
   <LINK REL="Index" HREF="https://mta.openssl.org/pipermail/openssl-commits/2021-February/index.html" >
   <LINK REL="made" HREF="mailto:openssl-commits%40openssl.org?Subject=Re%3A%20%5Bopenssl%5D%20%20master%20update&In-Reply-To=%3C1612924332.819440.361.nullmailer%40dev.openssl.org%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="033053.html">
   <LINK REL="Next"  HREF="033057.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[openssl]  master update</H1>
    <B>Dr. Paul Dale</B> 
    <A HREF="mailto:openssl-commits%40openssl.org?Subject=Re%3A%20%5Bopenssl%5D%20%20master%20update&In-Reply-To=%3C1612924332.819440.361.nullmailer%40dev.openssl.org%3E"
       TITLE="[openssl]  master update">pauli at openssl.org
       </A><BR>
    <I>Wed Feb 10 02:32:12 UTC 2021</I>
    <P><UL>
        <LI>Previous message: <A HREF="033053.html">[openssl]  master update
</A></li>
        <LI>Next message: <A HREF="033057.html">[openssl]  master update
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#33055">[ date ]</a>
              <a href="thread.html#33055">[ thread ]</a>
              <a href="subject.html#33055">[ subject ]</a>
              <a href="author.html#33055">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>The branch master has been updated
       via  af53092c2b67a8a0b76ae73385414cb1815ea7cc (commit)
       via  a054d15c22c501d33e1382bb09ba80bac08c2738 (commit)
       via  36978c19a9a5bfd514b1c6f9db66fda4b39ed2c3 (commit)
      from  8a686bdb3ac7d61b6d5f02b9132c4878ae80a7e5 (commit)


- Log -----------------------------------------------------------------
commit af53092c2b67a8a0b76ae73385414cb1815ea7cc
Author: Shane Lontis &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">shane.lontis at oracle.com</A>&gt;
Date:   Thu Dec 17 16:42:05 2020 +1000

    Replace provider digest flags with separate param fields
    
    Reviewed-by: Paul Dale &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">pauli at openssl.org</A>&gt;
    (Merged from <A HREF="https://github.com/openssl/openssl/pull/13830">https://github.com/openssl/openssl/pull/13830</A>)

commit a054d15c22c501d33e1382bb09ba80bac08c2738
Author: Shane Lontis &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">shane.lontis at oracle.com</A>&gt;
Date:   Thu Dec 17 16:39:57 2020 +1000

    Replace provider cipher flags with separate param fields
    
    Reviewed-by: Paul Dale &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">pauli at openssl.org</A>&gt;
    (Merged from <A HREF="https://github.com/openssl/openssl/pull/13830">https://github.com/openssl/openssl/pull/13830</A>)

commit 36978c19a9a5bfd514b1c6f9db66fda4b39ed2c3
Author: Shane Lontis &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">shane.lontis at oracle.com</A>&gt;
Date:   Mon Dec 14 14:36:48 2020 +1000

    Replace MAC flags OSSL_MAC_PARAM_FLAGS with separate param fields.
    
    Fixes #12992
    
    Reviewed-by: Paul Dale &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">pauli at openssl.org</A>&gt;
    (Merged from <A HREF="https://github.com/openssl/openssl/pull/13830">https://github.com/openssl/openssl/pull/13830</A>)

-----------------------------------------------------------------------

Summary of changes:
 crypto/evp/digest.c                                | 16 +++++---
 crypto/evp/evp_lib.c                               | 44 +++++++++++++++-------
 doc/man3/EVP_DigestInit.pod                        |  4 +-
 doc/man3/EVP_MAC.pod                               | 15 ++++++--
 doc/man7/EVP_MAC-HMAC.pod                          |  6 ++-
 doc/man7/EVP_MD-MDC2.pod                           |  2 +-
 doc/man7/provider-cipher.pod                       | 28 ++++++++++----
 doc/man7/provider-mac.pod                          | 11 +++++-
 include/openssl/core_names.h                       | 34 ++++++++++-------
 .../ciphers/cipher_aes_cbc_hmac_sha.c              |  7 +---
 .../implementations/ciphers/cipher_aes_cts.inc     |  8 ++--
 providers/implementations/ciphers/cipher_aes_siv.c |  3 +-
 providers/implementations/ciphers/cipher_aes_siv.h |  1 -
 providers/implementations/ciphers/cipher_aes_wrp.c |  8 ++--
 providers/implementations/ciphers/cipher_aes_xts.c | 11 +-----
 .../implementations/ciphers/cipher_blowfish.c      |  2 +-
 providers/implementations/ciphers/cipher_cast5.c   |  2 +-
 .../implementations/ciphers/cipher_chacha20.c      |  3 +-
 .../ciphers/cipher_chacha20_poly1305.c             | 10 +----
 providers/implementations/ciphers/cipher_des.c     |  3 +-
 providers/implementations/ciphers/cipher_des.h     |  3 +-
 providers/implementations/ciphers/cipher_rc2.c     | 13 ++++---
 providers/implementations/ciphers/cipher_rc4.c     |  7 ++--
 .../implementations/ciphers/cipher_rc4_hmac_md5.c  | 13 +++----
 providers/implementations/ciphers/cipher_rc5.c     | 10 +++--
 providers/implementations/ciphers/cipher_tdes.c    |  2 +-
 providers/implementations/ciphers/cipher_tdes.h    |  4 +-
 .../ciphers/cipher_tdes_default_hw.c               |  2 +-
 .../implementations/ciphers/cipher_tdes_wrap.c     |  4 +-
 providers/implementations/ciphers/ciphercommon.c   | 39 +++++++++++++++----
 .../implementations/ciphers/ciphercommon_ccm.c     |  5 +--
 .../implementations/ciphers/ciphercommon_hw.c      |  2 +-
 providers/implementations/digests/digestcommon.c   | 14 +++++--
 providers/implementations/digests/sha2_prov.c      | 22 +++++------
 providers/implementations/digests/sha3_prov.c      | 10 +++--
 .../implementations/include/prov/ciphercommon.h    | 23 ++++++++---
 .../include/prov/ciphercommon_aead.h               | 19 ++++------
 .../implementations/include/prov/digestcommon.h    |  4 ++
 providers/implementations/macs/hmac_prov.c         | 38 ++++++++++++++-----
 39 files changed, 272 insertions(+), 180 deletions(-)

diff --git a/crypto/evp/digest.c b/crypto/evp/digest.c
index e89b591978..40aedae47b 100644
--- a/crypto/evp/digest.c
+++ b/crypto/evp/digest.c
@@ -830,23 +830,27 @@ static void set_legacy_nid(const char *name, void *vlegacy_nid)
 
 static int evp_md_cache_constants(EVP_MD *md)
 {
-    int ok;
+    int ok, xof = 0, algid_absent = 0;
     size_t blksz = 0;
     size_t mdsize = 0;
-    unsigned long flags = 0;
-    OSSL_PARAM params[4];
+    OSSL_PARAM params[5];
 
     params[0] = OSSL_PARAM_construct_size_t(OSSL_DIGEST_PARAM_BLOCK_SIZE, &amp;blksz);
     params[1] = OSSL_PARAM_construct_size_t(OSSL_DIGEST_PARAM_SIZE, &amp;mdsize);
-    params[2] = OSSL_PARAM_construct_ulong(OSSL_DIGEST_PARAM_FLAGS, &amp;flags);
-    params[3] = OSSL_PARAM_construct_end();
+    params[2] = OSSL_PARAM_construct_int(OSSL_DIGEST_PARAM_XOF, &amp;xof);
+    params[3] = OSSL_PARAM_construct_int(OSSL_DIGEST_PARAM_ALGID_ABSENT,
+                                         &amp;algid_absent);
+    params[4] = OSSL_PARAM_construct_end();
     ok = evp_do_md_getparams(md, params);
     if (mdsize &gt; INT_MAX || blksz &gt; INT_MAX)
         ok = 0;
     if (ok) {
         md-&gt;block_size = (int)blksz;
         md-&gt;md_size = (int)mdsize;
-        md-&gt;flags = flags;
+        if (xof)
+            md-&gt;flags |= EVP_MD_FLAG_XOF;
+        if (algid_absent)
+            md-&gt;flags |= EVP_MD_FLAG_DIGALGID_ABSENT;
     }
     return ok;
 }
diff --git a/crypto/evp/evp_lib.c b/crypto/evp/evp_lib.c
index 2febcfc2d5..427ffc813a 100644
--- a/crypto/evp/evp_lib.c
+++ b/crypto/evp/evp_lib.c
@@ -333,29 +333,41 @@ int EVP_CIPHER_type(const EVP_CIPHER *ctx)
 
 int evp_cipher_cache_constants(EVP_CIPHER *cipher)
 {
-    int ok;
+    int ok, aead = 0, custom_iv = 0, cts = 0, multiblock = 0;
     size_t ivlen = 0;
     size_t blksz = 0;
     size_t keylen = 0;
     unsigned int mode = 0;
-    unsigned long flags = 0;
-    OSSL_PARAM params[6];
+    OSSL_PARAM params[9];
 
     params[0] = OSSL_PARAM_construct_size_t(OSSL_CIPHER_PARAM_BLOCK_SIZE, &amp;blksz);
     params[1] = OSSL_PARAM_construct_size_t(OSSL_CIPHER_PARAM_IVLEN, &amp;ivlen);
     params[2] = OSSL_PARAM_construct_size_t(OSSL_CIPHER_PARAM_KEYLEN, &amp;keylen);
     params[3] = OSSL_PARAM_construct_uint(OSSL_CIPHER_PARAM_MODE, &amp;mode);
-    params[4] = OSSL_PARAM_construct_ulong(OSSL_CIPHER_PARAM_FLAGS, &amp;flags);
-    params[5] = OSSL_PARAM_construct_end();
+    params[4] = OSSL_PARAM_construct_int(OSSL_CIPHER_PARAM_AEAD, &amp;aead);
+    params[5] = OSSL_PARAM_construct_int(OSSL_CIPHER_PARAM_CUSTOM_IV,
+                                         &amp;custom_iv);
+    params[6] = OSSL_PARAM_construct_int(OSSL_CIPHER_PARAM_CTS, &amp;cts);
+    params[7] = OSSL_PARAM_construct_int(OSSL_CIPHER_PARAM_TLS1_MULTIBLOCK,
+                                         &amp;multiblock);
+    params[8] = OSSL_PARAM_construct_end();
     ok = evp_do_ciph_getparams(cipher, params);
     if (ok) {
-        /* Provided implementations may have a custom cipher_cipher */
-        if (cipher-&gt;prov != NULL &amp;&amp; cipher-&gt;ccipher != NULL)
-            flags |= EVP_CIPH_FLAG_CUSTOM_CIPHER;
         cipher-&gt;block_size = blksz;
         cipher-&gt;iv_len = ivlen;
         cipher-&gt;key_len = keylen;
-        cipher-&gt;flags = flags | mode;
+        cipher-&gt;flags = mode;
+        if (aead)
+            cipher-&gt;flags |= EVP_CIPH_FLAG_AEAD_CIPHER;
+        if (custom_iv)
+            cipher-&gt;flags |= EVP_CIPH_CUSTOM_IV;
+        if (cts)
+            cipher-&gt;flags |= EVP_CIPH_FLAG_CTS;
+        if (multiblock)
+            cipher-&gt;flags |= EVP_CIPH_FLAG_TLS1_1_MULTIBLOCK;
+        /* Provided implementations may have a custom cipher_cipher */
+        if (cipher-&gt;prov != NULL &amp;&amp; cipher-&gt;ccipher != NULL)
+            cipher-&gt;flags |= EVP_CIPH_FLAG_CUSTOM_CIPHER;
     }
     return ok;
 }
@@ -686,11 +698,6 @@ const OSSL_PROVIDER *EVP_MD_provider(const EVP_MD *md)
     return md-&gt;prov;
 }
 
-int EVP_MD_block_size(const EVP_MD *md)
-{
-    return md-&gt;block_size;
-}
-
 int EVP_MD_type(const EVP_MD *md)
 {
     return md-&gt;type;
@@ -701,6 +708,15 @@ int EVP_MD_pkey_type(const EVP_MD *md)
     return md-&gt;pkey_type;
 }
 
+int EVP_MD_block_size(const EVP_MD *md)
+{
+    if (md == NULL) {
+        ERR_raise(ERR_LIB_EVP, EVP_R_MESSAGE_DIGEST_IS_NULL);
+        return -1;
+    }
+    return md-&gt;block_size;
+}
+
 int EVP_MD_size(const EVP_MD *md)
 {
     if (md == NULL) {
diff --git a/doc/man3/EVP_DigestInit.pod b/doc/man3/EVP_DigestInit.pod
index 3a17243976..28572f23b3 100644
--- a/doc/man3/EVP_DigestInit.pod
+++ b/doc/man3/EVP_DigestInit.pod
@@ -393,13 +393,13 @@ EVP_MD_CTX_set_params() can be used with the following OSSL_PARAM keys:
 
 =over 4
 
-=item &quot;xoflen&quot; (B&lt;OSSL_PARAM_DIGEST_KEY_XOFLEN&gt;) &lt;unsigned integer&gt;
+=item &quot;xoflen&quot; (B&lt;OSSL_DIGEST_PARAM_XOFLEN&gt;) &lt;unsigned integer&gt;
 
 Sets the digest length for extendable output functions.
 It is used by the SHAKE algorithm and should not exceed what can be given
 using a B&lt;size_t&gt;.
 
-=item &quot;pad_type&quot; (B&lt;OSSL_PARAM_DIGEST_KEY_PAD_TYPE&gt;) &lt;integer&gt;
+=item &quot;pad-type&quot; (B&lt;OSSL_DIGEST_PARAM_PAD_TYPE&gt;) &lt;unsigned integer&gt;
 
 Sets the padding type.
 It is used by the MDC2 algorithm.
diff --git a/doc/man3/EVP_MAC.pod b/doc/man3/EVP_MAC.pod
index 455d154cee..926c1fbd06 100644
--- a/doc/man3/EVP_MAC.pod
+++ b/doc/man3/EVP_MAC.pod
@@ -225,10 +225,19 @@ It's a simple flag, the value 0 or 1 are expected.
 
 This option is used by KMAC.
 
-=item &quot;flags&quot; (B&lt;OSSL_MAC_PARAM_FLAGS&gt;) &lt;integer&gt;
+=item &quot;digest-noinit&quot; (B&lt;OSSL_MAC_PARAM_DIGEST_NOINIT&gt;) &lt;integer&gt;
 
-These will set the MAC flags to the given numbers.
-Some MACs do not support this option.
+A simple flag to set the MAC digest to not initialise the
+implementation specific data. The value 0 or 1 is expected.
+
+This option is used by HMAC.
+
+=item &quot;digest-oneshot&quot; (B&lt;OSSL_MAC_PARAM_DIGEST_ONESHOT&gt;) &lt;integer&gt;
+
+A simple flag to set the MAC digest to be a oneshot operation.
+The value 0 or 1 is expected.
+
+This option is used by HMAC.
 
 =item &quot;properties&quot; (B&lt;OSSL_MAC_PARAM_PROPERTIES&gt;) &lt;UTF8 string&gt;
 
diff --git a/doc/man7/EVP_MAC-HMAC.pod b/doc/man7/EVP_MAC-HMAC.pod
index 94bac8dbcf..8136bed000 100644
--- a/doc/man7/EVP_MAC-HMAC.pod
+++ b/doc/man7/EVP_MAC-HMAC.pod
@@ -30,10 +30,12 @@ The following parameter can be set with EVP_MAC_CTX_set_params():
 
 =item &quot;key&quot; (B&lt;OSSL_MAC_PARAM_KEY&gt;) &lt;octet string&gt;
 
-=item &quot;flags&quot; (B&lt;OSSL_MAC_PARAM_FLAGS&gt;) &lt;octet string&gt;
-
 =item &quot;digest&quot; (B&lt;OSSL_MAC_PARAM_DIGEST&gt;) &lt;UTF8 string&gt;
 
+=item &quot;digest-noinit&quot; (B&lt;OSSL_MAC_PARAM_DIGEST_NOINIT&gt;) &lt;integer&gt;
+
+=item &quot;digest-oneshot&quot; (B&lt;OSSL_MAC_PARAM_DIGEST_ONESHOT&gt;) &lt;integer&gt;
+
 =item &quot;properties&quot; (B&lt;OSSL_MAC_PARAM_PROPERTIES&gt;) &lt;UTF8 string&gt;
 
 =item &quot;tls-data-size&quot; (B&lt;OSSL_MAC_PARAM_TLS_DATA_SIZE&gt;) &lt;unsigned integer&gt;
diff --git a/doc/man7/EVP_MD-MDC2.pod b/doc/man7/EVP_MD-MDC2.pod
index 516e19da19..53069557ea 100644
--- a/doc/man7/EVP_MD-MDC2.pod
+++ b/doc/man7/EVP_MD-MDC2.pod
@@ -25,7 +25,7 @@ settable for an B&lt;EVP_MD_CTX&gt; with L&lt;EVP_MD_CTX_set_params(3)&gt;:
 
 =over 4
 
-=item &quot;pad_type&quot; (B&lt;OSSL_DIGEST_PARAM_PAD_TYPE&gt;) &lt;unsigned integer&gt;
+=item &quot;pad-type&quot; (B&lt;OSSL_DIGEST_PARAM_PAD_TYPE&gt;) &lt;unsigned integer&gt;
 
 Sets the padding type to be used.
 Normally the final MDC2 block is padded with zeros.
diff --git a/doc/man7/provider-cipher.pod b/doc/man7/provider-cipher.pod
index 3ab277ecf9..34a5ec0a7f 100644
--- a/doc/man7/provider-cipher.pod
+++ b/doc/man7/provider-cipher.pod
@@ -218,13 +218,27 @@ For example AES in CTR mode has a block size of 1 (because it operates like a
 stream cipher), even though AES has a block size of 16.
 The length of the &quot;blocksize&quot; parameter should not exceed that of a B&lt;size_t&gt;.
 
-=item &quot;flags&quot; (B&lt;OSSL_CIPHER_PARAM_FLAGS&gt;) &lt;unsigned integer&gt;
+=item &quot;aead&quot; (B&lt;OSSL_CIPHER_PARAM_AEAD&gt;) &lt;integer&gt;
 
-Gets any flags for the associated cipher algorithm.
-See L&lt;EVP_CIPHER_meth_set_flags(3)&gt; for a list of currently defined cipher
-flags.
-The length of the &quot;flags&quot; parameter should equal that of an
-B&lt;unsigned long int&gt;.
+Gets 1 if this is an AEAD cipher algorithm, otherwise it gets 0.
+
+=item &quot;custom-iv&quot; (B&lt;OSSL_CIPHER_PARAM_CUSTOM_IV&gt;) &lt;integer&gt;
+
+Gets 1 if the cipher algorithm has a custom IV, otherwise it gets 0.
+Storing and initializing the IV is left entirely to the implementation, if a
+custom IV is used.
+
+=item &quot;cts&quot; (B&lt;OSSL_CIPHER_PARAM_CTS&gt;) &lt;integer&gt;
+
+Gets 1 if the cipher algorithm uses ciphertext stealing, otherwise it gets 0.
+This is currently used to indicate that the cipher is a one shot that only
+allows a single call to EVP_CipherUpdate().
+
+=item &quot;tls-multi&quot; (B&lt;OSSL_CIPHER_PARAM_TLS1_MULTIBLOCK&gt;) &lt;integer&gt;
+
+Gets 1 if the cipher algorithm supports interleaving of crypto blocks, otherwise
+it gets 0. The interleaving is an optimization only applicable to certain
+TLS ciphers.
 
 =item &quot;keylen&quot; (B&lt;OSSL_CIPHER_PARAM_KEYLEN&gt;) &lt;unsigned integer&gt;
 
@@ -263,7 +277,7 @@ See L&lt;EVP_EncryptInit(3)/AEAD Interface&gt;.
 =item &quot;taglen&quot; (B&lt;OSSL_CIPHER_PARAM_AEAD_TAGLEN&gt;) &lt;unsigned integer&gt;
 
 Gets the tag length to be used for an AEAD cipher for the associated cipher ctx.
-It returns a default value if it has not been set.
+It gets a default value if it has not been set.
 The length of the &quot;taglen&quot; parameter should not exceed that of a B&lt;size_t&gt;.
 
 =item &quot;tlsaad&quot; (B&lt;OSSL_CIPHER_PARAM_AEAD_TLS1_AAD&gt;) &lt;octet string&gt;
diff --git a/doc/man7/provider-mac.pod b/doc/man7/provider-mac.pod
index f89b1fe0e2..f18a8c7fde 100644
--- a/doc/man7/provider-mac.pod
+++ b/doc/man7/provider-mac.pod
@@ -172,9 +172,16 @@ Sets the salt of the underlying cipher, when applicable.
 Sets XOF mode in the associated MAC ctx.
 0 means no XOF mode, 1 means XOF mode.
 
-=item &quot;flags&quot; (B&lt;OSSL_MAC_PARAM_FLAGS&gt;) &lt;integer&gt;
+=item &quot;digest-noinit&quot; (B&lt;OSSL_MAC_PARAM_DIGEST_NOINIT&gt;) &lt;integer&gt;
+
+A simple flag to set the MAC digest to not initialise the
+implementation specific data. The value 0 or 1 is expected.
+
+=item &quot;digest-oneshot&quot; (B&lt;OSSL_MAC_PARAM_DIGEST_ONESHOT&gt;) &lt;integer&gt;
+
+A simple flag to set the MAC digest to be a oneshot operation.
+The value 0 or 1 is expected.
 
-Gets flags associated with the MAC.
 
 =for comment We need to investigate if this is the right approach
 
diff --git a/include/openssl/core_names.h b/include/openssl/core_names.h
index 221d67b823..ff2d1a03f9 100644
--- a/include/openssl/core_names.h
+++ b/include/openssl/core_names.h
@@ -69,7 +69,10 @@ extern &quot;C&quot; {
 #define OSSL_CIPHER_PARAM_TLS_MAC_SIZE         &quot;tls-mac-size&quot; /* size_t */
 #define OSSL_CIPHER_PARAM_MODE                 &quot;mode&quot;         /* uint */
 #define OSSL_CIPHER_PARAM_BLOCK_SIZE           &quot;blocksize&quot;    /* size_t */
-#define OSSL_CIPHER_PARAM_FLAGS                &quot;flags&quot;        /* ulong */
+#define OSSL_CIPHER_PARAM_AEAD                 &quot;aead&quot;         /* int, 0 or 1 */
+#define OSSL_CIPHER_PARAM_CUSTOM_IV            &quot;custom-iv&quot;    /* int, 0 or 1 */
+#define OSSL_CIPHER_PARAM_CTS                  &quot;cts&quot;          /* int, 0 or 1 */
+#define OSSL_CIPHER_PARAM_TLS1_MULTIBLOCK      &quot;tls-multi&quot;    /* int, 0 or 1 */
 #define OSSL_CIPHER_PARAM_KEYLEN               &quot;keylen&quot;       /* size_t */
 #define OSSL_CIPHER_PARAM_IVLEN                &quot;ivlen&quot;        /* size_t */
 #define OSSL_CIPHER_PARAM_IV                   &quot;iv&quot;           /* octet_string OR octet_ptr */
@@ -115,13 +118,14 @@ extern &quot;C&quot; {
 #define OSSL_CIPHER_CTS_MODE_CS3 &quot;CS3&quot;
 
 /* digest parameters */
-#define OSSL_DIGEST_PARAM_XOFLEN     &quot;xoflen&quot;    /* size_t */
-#define OSSL_DIGEST_PARAM_SSL3_MS    &quot;ssl3-ms&quot;   /* octet string */
-#define OSSL_DIGEST_PARAM_PAD_TYPE   &quot;pad_type&quot;  /* uint */
-#define OSSL_DIGEST_PARAM_MICALG     &quot;micalg&quot;    /* utf8 string */
-#define OSSL_DIGEST_PARAM_BLOCK_SIZE &quot;blocksize&quot; /* size_t */
-#define OSSL_DIGEST_PARAM_SIZE       &quot;size&quot;      /* size_t */
-#define OSSL_DIGEST_PARAM_FLAGS      &quot;flags&quot;     /* ulong */
+#define OSSL_DIGEST_PARAM_XOFLEN       &quot;xoflen&quot;        /* size_t */
+#define OSSL_DIGEST_PARAM_SSL3_MS      &quot;ssl3-ms&quot;       /* octet string */
+#define OSSL_DIGEST_PARAM_PAD_TYPE     &quot;pad-type&quot;      /* uint */
+#define OSSL_DIGEST_PARAM_MICALG       &quot;micalg&quot;        /* utf8 string */
+#define OSSL_DIGEST_PARAM_BLOCK_SIZE   &quot;blocksize&quot;     /* size_t */
+#define OSSL_DIGEST_PARAM_SIZE         &quot;size&quot;          /* size_t */
+#define OSSL_DIGEST_PARAM_XOF          &quot;xof&quot;           /* int, 0 or 1 */
+#define OSSL_DIGEST_PARAM_ALGID_ABSENT &quot;algid-absent&quot;  /* int, 0 or 1 */
 
 /* Known DIGEST names (not a complete list) */
 #define OSSL_DIGEST_NAME_MD5            &quot;MD5&quot;
@@ -146,12 +150,14 @@ extern &quot;C&quot; {
 #define OSSL_DIGEST_NAME_SM3            &quot;SM3&quot;
 
 /* MAC parameters */
-#define OSSL_MAC_PARAM_KEY          &quot;key&quot;        /* octet string */
-#define OSSL_MAC_PARAM_IV           &quot;iv&quot;         /* octet string */
-#define OSSL_MAC_PARAM_CUSTOM       &quot;custom&quot;     /* utf8 string */
-#define OSSL_MAC_PARAM_SALT         &quot;salt&quot;       /* octet string */
-#define OSSL_MAC_PARAM_XOF          &quot;xof&quot;        /* int, 0 or 1 */
-#define OSSL_MAC_PARAM_FLAGS        &quot;flags&quot;      /* int */
+#define OSSL_MAC_PARAM_KEY            &quot;key&quot;            /* octet string */
+#define OSSL_MAC_PARAM_IV             &quot;iv&quot;             /* octet string */
+#define OSSL_MAC_PARAM_CUSTOM         &quot;custom&quot;         /* utf8 string */
+#define OSSL_MAC_PARAM_SALT           &quot;salt&quot;           /* octet string */
+#define OSSL_MAC_PARAM_XOF            &quot;xof&quot;            /* int, 0 or 1 */
+#define OSSL_MAC_PARAM_DIGEST_NOINIT  &quot;digest-noinit&quot;  /* int, 0 or 1 */
+#define OSSL_MAC_PARAM_DIGEST_ONESHOT &quot;digest-oneshot&quot; /* int, 0 or 1 */
+
 /*
  * If &quot;engine&quot; or &quot;properties&quot; are specified, they should always be paired
  * with &quot;cipher&quot; or &quot;digest&quot;.
diff --git a/providers/implementations/ciphers/cipher_aes_cbc_hmac_sha.c b/providers/implementations/ciphers/cipher_aes_cbc_hmac_sha.c
index 53bef600a5..03f216d22e 100644
--- a/providers/implementations/ciphers/cipher_aes_cbc_hmac_sha.c
+++ b/providers/implementations/ciphers/cipher_aes_cbc_hmac_sha.c
@@ -30,11 +30,8 @@ const OSSL_DISPATCH ossl_##nm##kbits##sub##_functions[] = {                    \
 #else
 # include &quot;prov/providercommonerr.h&quot;
 
-/* TODO(3.0) Figure out what flags are required */
-# define AES_CBC_HMAC_SHA_FLAGS (EVP_CIPH_CBC_MODE                             \
-                                 | EVP_CIPH_FLAG_DEFAULT_ASN1                  \
-                                 | EVP_CIPH_FLAG_AEAD_CIPHER                   \
-                                 | EVP_CIPH_FLAG_TLS1_1_MULTIBLOCK)
+# define AES_CBC_HMAC_SHA_FLAGS (PROV_CIPHER_FLAG_AEAD                         \
+                                 | PROV_CIPHER_FLAG_TLS1_MULTIBLOCK)
 
 static OSSL_FUNC_cipher_freectx_fn aes_cbc_hmac_sha1_freectx;
 static OSSL_FUNC_cipher_freectx_fn aes_cbc_hmac_sha256_freectx;
diff --git a/providers/implementations/ciphers/cipher_aes_cts.inc b/providers/implementations/ciphers/cipher_aes_cts.inc
index 6eb85a083f..dae112febf 100644
--- a/providers/implementations/ciphers/cipher_aes_cts.inc
+++ b/providers/implementations/ciphers/cipher_aes_cts.inc
@@ -12,6 +12,8 @@
 #include &quot;cipher_aes_cts.h&quot;
 #include &quot;prov/providercommonerr.h&quot;
 
+#define AES_CTS_FLAGS PROV_CIPHER_FLAG_CTS
+
 static OSSL_FUNC_cipher_get_ctx_params_fn aes_cbc_cts_get_ctx_params;
 static OSSL_FUNC_cipher_set_ctx_params_fn aes_cbc_cts_set_ctx_params;
 static OSSL_FUNC_cipher_gettable_ctx_params_fn aes_cbc_cts_gettable_ctx_params;
@@ -101,8 +103,8 @@ const OSSL_DISPATCH ossl_##alg##kbits##lcmode##_cts_functions[] = {            \
 };
 
 /* ossl_aes256cbc_cts_functions */
-IMPLEMENT_cts_cipher(aes, AES, cbc, CBC, EVP_CIPH_FLAG_CTS, 256, 128, 128, block)
+IMPLEMENT_cts_cipher(aes, AES, cbc, CBC, AES_CTS_FLAGS, 256, 128, 128, block)
 /* ossl_aes192cbc_cts_functions */
-IMPLEMENT_cts_cipher(aes, AES, cbc, CBC, EVP_CIPH_FLAG_CTS, 192, 128, 128, block)
+IMPLEMENT_cts_cipher(aes, AES, cbc, CBC, AES_CTS_FLAGS, 192, 128, 128, block)
 /* ossl_aes128cbc_cts_functions */
-IMPLEMENT_cts_cipher(aes, AES, cbc, CBC, EVP_CIPH_FLAG_CTS, 128, 128, 128, block)
+IMPLEMENT_cts_cipher(aes, AES, cbc, CBC, AES_CTS_FLAGS, 128, 128, 128, block)
diff --git a/providers/implementations/ciphers/cipher_aes_siv.c b/providers/implementations/ciphers/cipher_aes_siv.c
index 7a83506c24..469515bb8c 100644
--- a/providers/implementations/ciphers/cipher_aes_siv.c
+++ b/providers/implementations/ciphers/cipher_aes_siv.c
@@ -37,7 +37,6 @@ static void *aes_siv_newctx(void *provctx, size_t keybits, unsigned int mode,
     if (ctx != NULL) {
         ctx-&gt;taglen = SIV_LEN;
         ctx-&gt;mode = mode;
-        ctx-&gt;flags = flags;
         ctx-&gt;keylen = keybits / 8;
         ctx-&gt;hw = ossl_prov_cipher_hw_aes_siv(keybits);
         ctx-&gt;libctx = PROV_LIBCTX_OF(provctx);
@@ -259,7 +258,7 @@ static OSSL_FUNC_cipher_settable_ctx_params_fn                                 \
 static int alg##_##kbits##_##lc##_get_params(OSSL_PARAM params[])              \
 {                                                                              \
     return ossl_cipher_generic_get_params(params, EVP_CIPH_##UCMODE##_MODE,    \
-                                     flags, 2*kbits, blkbits, ivbits);         \
+                                          flags, 2*kbits, blkbits, ivbits);    \
 }                                                                              \
 static void * alg##kbits##lc##_newctx(void *provctx)                           \
 {                                                                              \
diff --git a/providers/implementations/ciphers/cipher_aes_siv.h b/providers/implementations/ciphers/cipher_aes_siv.h
index 6d2649f049..c0b2a903bc 100644
--- a/providers/implementations/ciphers/cipher_aes_siv.h
+++ b/providers/implementations/ciphers/cipher_aes_siv.h
@@ -24,7 +24,6 @@ typedef struct prov_cipher_hw_aes_siv_st {
 typedef struct prov_siv_ctx_st {
     unsigned int mode;       /* The mode that we are using */
     unsigned int enc : 1;    /* Set to 1 if we are encrypting or 0 otherwise */
-    uint64_t flags;
     size_t keylen;           /* The input keylength (twice the alg key length) */
     size_t taglen;           /* the taglen is the same as the sivlen */
     SIV128_CONTEXT siv;
diff --git a/providers/implementations/ciphers/cipher_aes_wrp.c b/providers/implementations/ciphers/cipher_aes_wrp.c
index ca57666e7a..dc625216ca 100644
--- a/providers/implementations/ciphers/cipher_aes_wrp.c
+++ b/providers/implementations/ciphers/cipher_aes_wrp.c
@@ -22,10 +22,8 @@
 #define AES_WRAP_PAD_IVLEN   4
 #define AES_WRAP_NOPAD_IVLEN 8
 
-/* TODO(3.0) Figure out what flags need to be passed */
-#define WRAP_FLAGS (EVP_CIPH_WRAP_MODE | EVP_CIPH_CUSTOM_IV \
-                    | EVP_CIPH_ALWAYS_CALL_INIT)
-#define WRAP_FLAGS_INV (WRAP_FLAGS | EVP_CIPH_FLAG_INVERSE_CIPHER)
+#define WRAP_FLAGS (PROV_CIPHER_FLAG_CUSTOM_IV)
+#define WRAP_FLAGS_INV (WRAP_FLAGS | PROV_CIPHER_FLAG_INVERSE_CIPHER)
 
 typedef size_t (*aeswrap_fn)(void *key, const unsigned char *iv,
                              unsigned char *out, const unsigned char *in,
@@ -111,7 +109,7 @@ static int aes_wrap_init(void *vctx, const unsigned char *key,
          * to be the AES decryption function, then CIPH-1K will be the AES
          * encryption function.
          */
-        if ((ctx-&gt;flags &amp; EVP_CIPH_FLAG_INVERSE_CIPHER) == 0)
+        if (ctx-&gt;inverse_cipher == 0)
             use_forward_transform = ctx-&gt;enc;
         else
             use_forward_transform = !ctx-&gt;enc;
diff --git a/providers/implementations/ciphers/cipher_aes_xts.c b/providers/implementations/ciphers/cipher_aes_xts.c
index 7ccad56198..cf768d27d4 100644
--- a/providers/implementations/ciphers/cipher_aes_xts.c
+++ b/providers/implementations/ciphers/cipher_aes_xts.c
@@ -20,12 +20,7 @@
 #include &quot;prov/providercommon.h&quot;
 #include &quot;prov/providercommonerr.h&quot;
 
-/* TODO (3.0) Figure out what flags need to be set */
-#define AES_XTS_FLAGS (EVP_CIPH_CUSTOM_IV          \
-                       | EVP_CIPH_ALWAYS_CALL_INIT \
-                       | EVP_CIPH_CTRL_INIT        \
-                       | EVP_CIPH_CUSTOM_COPY)
-
+#define AES_XTS_FLAGS PROV_CIPHER_FLAG_CUSTOM_IV
 #define AES_XTS_IV_BITS 128
 #define AES_XTS_BLOCK_BITS 8
 
@@ -233,10 +228,6 @@ static int aes_xts_set_ctx_params(void *vctx, const OSSL_PARAM params[])
     PROV_CIPHER_CTX *ctx = (PROV_CIPHER_CTX *)vctx;
     const OSSL_PARAM *p;
 
-    /*
-     * TODO(3.0) We need a general solution for handling missing parameters
-     * inside set_params and get_params methods.
-     */
     p = OSSL_PARAM_locate_const(params, OSSL_CIPHER_PARAM_KEYLEN);
     if (p != NULL) {
         size_t keylen;
diff --git a/providers/implementations/ciphers/cipher_blowfish.c b/providers/implementations/ciphers/cipher_blowfish.c
index 6320f560a0..cf303bb863 100644
--- a/providers/implementations/ciphers/cipher_blowfish.c
+++ b/providers/implementations/ciphers/cipher_blowfish.c
@@ -19,7 +19,7 @@
 #include &quot;prov/implementations.h&quot;
 #include &quot;prov/providercommon.h&quot;
 
-#define BF_FLAGS (EVP_CIPH_VARIABLE_LENGTH)
+#define BF_FLAGS PROV_CIPHER_FLAG_VARIABLE_LENGTH
 
 static OSSL_FUNC_cipher_freectx_fn blowfish_freectx;
 static OSSL_FUNC_cipher_dupctx_fn blowfish_dupctx;
diff --git a/providers/implementations/ciphers/cipher_cast5.c b/providers/implementations/ciphers/cipher_cast5.c
index 7c686013d8..1d525343b4 100644
--- a/providers/implementations/ciphers/cipher_cast5.c
+++ b/providers/implementations/ciphers/cipher_cast5.c
@@ -20,7 +20,7 @@
 #include &quot;prov/providercommon.h&quot;
 #include &quot;prov/providercommonerr.h&quot;
 
-#define CAST5_FLAGS (EVP_CIPH_VARIABLE_LENGTH)
+#define CAST5_FLAGS PROV_CIPHER_FLAG_VARIABLE_LENGTH
 
 static OSSL_FUNC_cipher_freectx_fn cast5_freectx;
 static OSSL_FUNC_cipher_dupctx_fn cast5_dupctx;
diff --git a/providers/implementations/ciphers/cipher_chacha20.c b/providers/implementations/ciphers/cipher_chacha20.c
index 8e0727ae47..b2fe1b1957 100644
--- a/providers/implementations/ciphers/cipher_chacha20.c
+++ b/providers/implementations/ciphers/cipher_chacha20.c
@@ -17,8 +17,7 @@
 #define CHACHA20_KEYLEN (CHACHA_KEY_SIZE)
 #define CHACHA20_BLKLEN (1)
 #define CHACHA20_IVLEN (CHACHA_CTR_SIZE)
-/* TODO(3.0) Figure out what flags are required */
-#define CHACHA20_FLAGS (EVP_CIPH_CUSTOM_IV | EVP_CIPH_ALWAYS_CALL_INIT)
+#define CHACHA20_FLAGS (PROV_CIPHER_FLAG_CUSTOM_IV)
 
 static OSSL_FUNC_cipher_newctx_fn chacha20_newctx;
 static OSSL_FUNC_cipher_freectx_fn chacha20_freectx;
diff --git a/providers/implementations/ciphers/cipher_chacha20_poly1305.c b/providers/implementations/ciphers/cipher_chacha20_poly1305.c
index 7a9cc5c20f..919d4fba94 100644
--- a/providers/implementations/ciphers/cipher_chacha20_poly1305.c
+++ b/providers/implementations/ciphers/cipher_chacha20_poly1305.c
@@ -19,14 +19,8 @@
 #define CHACHA20_POLY1305_BLKLEN 1
 #define CHACHA20_POLY1305_MAX_IVLEN 12
 #define CHACHA20_POLY1305_MODE 0
-/* TODO(3.0) Figure out what flags are required */
-#define CHACHA20_POLY1305_FLAGS (EVP_CIPH_FLAG_AEAD_CIPHER                     \
-                                | EVP_CIPH_ALWAYS_CALL_INIT                    \
-                                | EVP_CIPH_CTRL_INIT                           \
-                                | EVP_CIPH_CUSTOM_COPY                         \
-                                | EVP_CIPH_FLAG_CUSTOM_CIPHER                  \
-                                | EVP_CIPH_CUSTOM_IV                           \
-                                | EVP_CIPH_CUSTOM_IV_LENGTH)
+#define CHACHA20_POLY1305_FLAGS (PROV_CIPHER_FLAG_AEAD                         \
+                                 | PROV_CIPHER_FLAG_CUSTOM_IV)
 
 static OSSL_FUNC_cipher_newctx_fn chacha20_poly1305_newctx;
 static OSSL_FUNC_cipher_freectx_fn chacha20_poly1305_freectx;
diff --git a/providers/implementations/ciphers/cipher_des.c b/providers/implementations/ciphers/cipher_des.c
index 345adfab60..ec186445c8 100644
--- a/providers/implementations/ciphers/cipher_des.c
+++ b/providers/implementations/ciphers/cipher_des.c
@@ -20,8 +20,7 @@
 #include &quot;prov/providercommon.h&quot;
 #include &quot;prov/providercommonerr.h&quot;
 
-/* TODO(3.0) Figure out what flags need to be here */
-#define DES_FLAGS (EVP_CIPH_RAND_KEY)
+#define DES_FLAGS 0
 
 static OSSL_FUNC_cipher_freectx_fn des_freectx;
 static OSSL_FUNC_cipher_encrypt_init_fn des_einit;
diff --git a/providers/implementations/ciphers/cipher_des.h b/providers/implementations/ciphers/cipher_des.h
index aedb38177e..78ca686bad 100644
--- a/providers/implementations/ciphers/cipher_des.h
+++ b/providers/implementations/ciphers/cipher_des.h
@@ -10,8 +10,7 @@
 #include &lt;openssl/des.h&gt;
 #include &quot;crypto/des_platform.h&quot;
 
-/* TODO(3.0) Figure out what flags need to be here */
-#define TDES_FLAGS (EVP_CIPH_RAND_KEY)
+#define TDES_FLAGS 0
 
 typedef struct prov_des_ctx_st {
     PROV_CIPHER_CTX base;      /* Must be first */
diff --git a/providers/implementations/ciphers/cipher_rc2.c b/providers/implementations/ciphers/cipher_rc2.c
index b7c244f245..09d66b2cdd 100644
--- a/providers/implementations/ciphers/cipher_rc2.c
+++ b/providers/implementations/ciphers/cipher_rc2.c
@@ -23,6 +23,7 @@
 #define RC2_40_MAGIC    0xa0
 #define RC2_64_MAGIC    0x78
 #define RC2_128_MAGIC   0x3a
+#define RC2_FLAGS       PROV_CIPHER_FLAG_VARIABLE_LENGTH
 
 static OSSL_FUNC_cipher_freectx_fn rc2_freectx;
 static OSSL_FUNC_cipher_dupctx_fn rc2_dupctx;
@@ -242,15 +243,15 @@ const OSSL_DISPATCH ossl_##alg##kbits##lcmode##_functions[] = {                \
 };
 
 /* ossl_rc2128ecb_functions */
-IMPLEMENT_cipher(rc2, RC2, ecb, ECB, EVP_CIPH_VARIABLE_LENGTH, 128, 64, 0, block)
+IMPLEMENT_cipher(rc2, RC2, ecb, ECB, RC2_FLAGS, 128, 64, 0, block)
 /* ossl_rc2128cbc_functions */
-IMPLEMENT_cipher(rc2, RC2, cbc, CBC, EVP_CIPH_VARIABLE_LENGTH, 128, 64, 64, block)
+IMPLEMENT_cipher(rc2, RC2, cbc, CBC, RC2_FLAGS, 128, 64, 64, block)
 /* ossl_rc240cbc_functions */
-IMPLEMENT_cipher(rc2, RC2, cbc, CBC, EVP_CIPH_VARIABLE_LENGTH, 40, 64, 64, block)
+IMPLEMENT_cipher(rc2, RC2, cbc, CBC, RC2_FLAGS, 40, 64, 64, block)
 /* ossl_rc264cbc_functions */
-IMPLEMENT_cipher(rc2, RC2, cbc, CBC, EVP_CIPH_VARIABLE_LENGTH, 64, 64, 64, block)
+IMPLEMENT_cipher(rc2, RC2, cbc, CBC, RC2_FLAGS, 64, 64, 64, block)
 
 /* ossl_rc2128ofb128_functions */
-IMPLEMENT_cipher(rc2, RC2, ofb128, OFB, EVP_CIPH_VARIABLE_LENGTH, 128, 8, 64, stream)
+IMPLEMENT_cipher(rc2, RC2, ofb128, OFB, RC2_FLAGS, 128, 8, 64, stream)
 /* ossl_rc2128cfb128_functions */
-IMPLEMENT_cipher(rc2, RC2, cfb128, CFB, EVP_CIPH_VARIABLE_LENGTH, 128, 8, 64, stream)
+IMPLEMENT_cipher(rc2, RC2, cfb128, CFB, RC2_FLAGS, 128, 8, 64, stream)
diff --git a/providers/implementations/ciphers/cipher_rc4.c b/providers/implementations/ciphers/cipher_rc4.c
index 91644fca59..18233bbac1 100644
--- a/providers/implementations/ciphers/cipher_rc4.c
+++ b/providers/implementations/ciphers/cipher_rc4.c
@@ -19,8 +19,7 @@
 #include &quot;prov/implementations.h&quot;
 #include &quot;prov/providercommon.h&quot;
 
-/* TODO (3.0) Figure out what flags are required */
-#define RC4_FLAGS EVP_CIPH_FLAG_DEFAULT_ASN1
+#define RC4_FLAGS PROV_CIPHER_FLAG_VARIABLE_LENGTH
 
 static OSSL_FUNC_cipher_freectx_fn rc4_freectx;
 static OSSL_FUNC_cipher_dupctx_fn rc4_dupctx;
@@ -97,6 +96,6 @@ const OSSL_DISPATCH ossl_##alg##kbits##_functions[] = {                        \
 };
 
 /* ossl_rc440_functions */
-IMPLEMENT_cipher(rc4, RC4, EVP_CIPH_VARIABLE_LENGTH, 40, 8, 0, stream)
+IMPLEMENT_cipher(rc4, RC4, RC4_FLAGS, 40, 8, 0, stream)
 /* ossl_rc4128_functions */
-IMPLEMENT_cipher(rc4, RC4, EVP_CIPH_VARIABLE_LENGTH, 128, 8, 0, stream)
+IMPLEMENT_cipher(rc4, RC4, RC4_FLAGS, 128, 8, 0, stream)
diff --git a/providers/implementations/ciphers/cipher_rc4_hmac_md5.c b/providers/implementations/ciphers/cipher_rc4_hmac_md5.c
index 9dc9615c04..b757197110 100644
--- a/providers/implementations/ciphers/cipher_rc4_hmac_md5.c
+++ b/providers/implementations/ciphers/cipher_rc4_hmac_md5.c
@@ -20,9 +20,8 @@
 #include &quot;prov/providercommon.h&quot;
 #include &quot;prov/providercommonerr.h&quot;
 
-/* TODO(3.0) Figure out what flags are required */
-#define RC4_HMAC_MD5_FLAGS (EVP_CIPH_STREAM_CIPHER | EVP_CIPH_VARIABLE_LENGTH  \
-                            | EVP_CIPH_FLAG_AEAD_CIPHER)
+#define RC4_HMAC_MD5_FLAGS (PROV_CIPHER_FLAG_VARIABLE_LENGTH                   \
+                            | PROV_CIPHER_FLAG_AEAD)
 
 #define RC4_HMAC_MD5_KEY_BITS (16 * 8)
 #define RC4_HMAC_MD5_BLOCK_BITS (1 * 8)
@@ -183,10 +182,10 @@ static int rc4_hmac_md5_set_ctx_params(void *vctx, const OSSL_PARAM params[])
 static int rc4_hmac_md5_get_params(OSSL_PARAM params[])
 {
     return ossl_cipher_generic_get_params(params, RC4_HMAC_MD5_MODE,
-                                     RC4_HMAC_MD5_FLAGS,
-                                     RC4_HMAC_MD5_KEY_BITS,
-                                     RC4_HMAC_MD5_BLOCK_BITS,
-                                     RC4_HMAC_MD5_IV_BITS);
+                                          RC4_HMAC_MD5_FLAGS,
+                                          RC4_HMAC_MD5_KEY_BITS,
+                                          RC4_HMAC_MD5_BLOCK_BITS,
+                                          RC4_HMAC_MD5_IV_BITS);
 }
 
 const OSSL_DISPATCH ossl_rc4_hmac_ossl_md5_functions[] = {
diff --git a/providers/implementations/ciphers/cipher_rc5.c b/providers/implementations/ciphers/cipher_rc5.c
index 80de5f4bdd..ec408ed885 100644
--- a/providers/implementations/ciphers/cipher_rc5.c
+++ b/providers/implementations/ciphers/cipher_rc5.c
@@ -20,6 +20,8 @@
 #include &quot;prov/providercommon.h&quot;
 #include &quot;prov/providercommonerr.h&quot;
 
+#define RC5_FLAGS PROV_CIPHER_FLAG_VARIABLE_LENGTH
+
 static OSSL_FUNC_cipher_freectx_fn rc5_freectx;
 static OSSL_FUNC_cipher_dupctx_fn rc5_dupctx;
 OSSL_FUNC_cipher_gettable_ctx_params_fn rc5_gettable_ctx_params;
@@ -153,10 +155,10 @@ const OSSL_DISPATCH ossl_##alg##kbits##lcmode##_functions[] = {                \
 };
 
 /* ossl_rc5128ecb_functions */
-IMPLEMENT_cipher(rc5, RC5, ecb, ECB, EVP_CIPH_VARIABLE_LENGTH, 128, 64, 0, block)
+IMPLEMENT_cipher(rc5, RC5, ecb, ECB, RC5_FLAGS, 128, 64, 0, block)
 /* ossl_rc5128cbc_functions */
-IMPLEMENT_cipher(rc5, RC5, cbc, CBC, EVP_CIPH_VARIABLE_LENGTH, 128, 64, 64, block)
+IMPLEMENT_cipher(rc5, RC5, cbc, CBC, RC5_FLAGS, 128, 64, 64, block)
 /* ossl_rc5128ofb64_functions */
-IMPLEMENT_cipher(rc5, RC5, ofb64, OFB, EVP_CIPH_VARIABLE_LENGTH, 128, 8, 64, stream)
+IMPLEMENT_cipher(rc5, RC5, ofb64, OFB, RC5_FLAGS, 128, 8, 64, stream)
 /* ossl_rc5128cfb64_functions */
-IMPLEMENT_cipher(rc5, RC5, cfb64,  CFB, EVP_CIPH_VARIABLE_LENGTH, 128, 8, 64, stream)
+IMPLEMENT_cipher(rc5, RC5, cfb64,  CFB, RC5_FLAGS, 128, 8, 64, stream)
diff --git a/providers/implementations/ciphers/cipher_tdes.c b/providers/implementations/ciphers/cipher_tdes.c
index c9fb1ceda7..a2855af481 100644
--- a/providers/implementations/ciphers/cipher_tdes.c
+++ b/providers/implementations/ciphers/cipher_tdes.c
@@ -20,7 +20,7 @@
 #include &quot;prov/providercommonerr.h&quot;
 
 /*
- * TODO(3.0) - ECB mode does not use an IV - but existing test code is setting
+ * NOTE: ECB mode does not use an IV - but existing test code is setting
  * an IV. Fixing this could potentially make applications break.
  */
 /* ossl_tdes_ede3_ecb_functions */
diff --git a/providers/implementations/ciphers/cipher_tdes.h b/providers/implementations/ciphers/cipher_tdes.h
index 081a00fffa..9bef908cc3 100644
--- a/providers/implementations/ciphers/cipher_tdes.h
+++ b/providers/implementations/ciphers/cipher_tdes.h
@@ -13,9 +13,7 @@
 
 #define DES_BLOCK_SIZE 8
 #define TDES_IVLEN 8
-
-/* TODO(3.0) Figure out what flags need to be here */
-#define TDES_FLAGS (EVP_CIPH_RAND_KEY)
+#define TDES_FLAGS 0
 
 typedef struct prov_tdes_ctx_st {
     PROV_CIPHER_CTX base;      /* Must be first */
diff --git a/providers/implementations/ciphers/cipher_tdes_default_hw.c b/providers/implementations/ciphers/cipher_tdes_default_hw.c
index b7c7ea11f7..77b08ebbe1 100644
--- a/providers/implementations/ciphers/cipher_tdes_default_hw.c
+++ b/providers/implementations/ciphers/cipher_tdes_default_hw.c
@@ -101,7 +101,7 @@ static int ossl_cipher_hw_tdes_cfb1(PROV_CIPHER_CTX *ctx, unsigned char *out,
     size_t n;
     unsigned char c[1], d[1];
 
-    if ((ctx-&gt;flags &amp; EVP_CIPH_FLAG_LENGTH_BITS) == 0)
+    if (ctx-&gt;use_bits == 0)
         inl *= 8;
     for (n = 0; n &lt; inl; ++n) {
         c[0] = (in[n / 8] &amp; (1 &lt;&lt; (7 - n % 8))) ? 0x80 : 0;
diff --git a/providers/implementations/ciphers/cipher_tdes_wrap.c b/providers/implementations/ciphers/cipher_tdes_wrap.c
index acb8c97e33..b78a77c254 100644
--- a/providers/implementations/ciphers/cipher_tdes_wrap.c
+++ b/providers/implementations/ciphers/cipher_tdes_wrap.c
@@ -21,9 +21,7 @@
 #include &quot;prov/providercommon.h&quot;
 #include &quot;prov/providercommonerr.h&quot;
 
-/* TODO (3.0) Figure out what flags are required */
-#define TDES_WRAP_FLAGS (EVP_CIPH_WRAP_MODE | EVP_CIPH_CUSTOM_IV)
-
+#define TDES_WRAP_FLAGS PROV_CIPHER_FLAG_CUSTOM_IV
 
 static OSSL_FUNC_cipher_update_fn tdes_wrap_update;
 static OSSL_FUNC_cipher_cipher_fn tdes_wrap_cipher;
diff --git a/providers/implementations/ciphers/ciphercommon.c b/providers/implementations/ciphers/ciphercommon.c
index d1e8c461b5..fa73edb473 100644
--- a/providers/implementations/ciphers/ciphercommon.c
+++ b/providers/implementations/ciphers/ciphercommon.c
@@ -26,7 +26,10 @@ static const OSSL_PARAM cipher_known_gettable_params[] = {
     OSSL_PARAM_size_t(OSSL_CIPHER_PARAM_KEYLEN, NULL),
     OSSL_PARAM_size_t(OSSL_CIPHER_PARAM_IVLEN, NULL),
     OSSL_PARAM_size_t(OSSL_CIPHER_PARAM_BLOCK_SIZE, NULL),
-    OSSL_PARAM_ulong(OSSL_CIPHER_PARAM_FLAGS, NULL),
+    OSSL_PARAM_int(OSSL_CIPHER_PARAM_AEAD, NULL),
+    OSSL_PARAM_int(OSSL_CIPHER_PARAM_CUSTOM_IV, NULL),
+    OSSL_PARAM_int(OSSL_CIPHER_PARAM_CTS, NULL),
+    OSSL_PARAM_int(OSSL_CIPHER_PARAM_TLS1_MULTIBLOCK, NULL),
     { OSSL_CIPHER_PARAM_TLS_MAC, OSSL_PARAM_OCTET_PTR, NULL, 0, OSSL_PARAM_UNMODIFIED },
     OSSL_PARAM_END
 };
@@ -36,7 +39,7 @@ const OSSL_PARAM *ossl_cipher_generic_gettable_params(void *provctx)
 }
 
 int ossl_cipher_generic_get_params(OSSL_PARAM params[], unsigned int md,
-                                   unsigned long flags,
+                                   uint64_t flags,
                                    size_t kbits, size_t blkbits, size_t ivbits)
 {
     OSSL_PARAM *p;
@@ -46,8 +49,27 @@ int ossl_cipher_generic_get_params(OSSL_PARAM params[], unsigned int md,
         ERR_raise(ERR_LIB_PROV, PROV_R_FAILED_TO_SET_PARAMETER);
         return 0;
     }
-    p = OSSL_PARAM_locate(params, OSSL_CIPHER_PARAM_FLAGS);
-    if (p != NULL &amp;&amp; !OSSL_PARAM_set_ulong(p, flags)) {
+    p = OSSL_PARAM_locate(params, OSSL_CIPHER_PARAM_AEAD);
+    if (p != NULL
+        &amp;&amp; !OSSL_PARAM_set_int(p, (flags &amp; PROV_CIPHER_FLAG_AEAD) != 0)) {
+        ERR_raise(ERR_LIB_PROV, PROV_R_FAILED_TO_SET_PARAMETER);
+        return 0;
+    }
+    p = OSSL_PARAM_locate(params, OSSL_CIPHER_PARAM_CUSTOM_IV);
+    if (p != NULL
+        &amp;&amp; !OSSL_PARAM_set_int(p, (flags &amp; PROV_CIPHER_FLAG_CUSTOM_IV) != 0)) {
+        ERR_raise(ERR_LIB_PROV, PROV_R_FAILED_TO_SET_PARAMETER);
+        return 0;
+    }
+    p = OSSL_PARAM_locate(params, OSSL_CIPHER_PARAM_CTS);
+    if (p != NULL
+        &amp;&amp; !OSSL_PARAM_set_int(p, (flags &amp; PROV_CIPHER_FLAG_CTS) != 0)) {
+        ERR_raise(ERR_LIB_PROV, PROV_R_FAILED_TO_SET_PARAMETER);
+        return 0;
+    }
+    p = OSSL_PARAM_locate(params, OSSL_CIPHER_PARAM_TLS1_MULTIBLOCK);
+    if (p != NULL
+        &amp;&amp; !OSSL_PARAM_set_int(p, (flags &amp; PROV_CIPHER_FLAG_TLS1_MULTIBLOCK) != 0)) {
         ERR_raise(ERR_LIB_PROV, PROV_R_FAILED_TO_SET_PARAMETER);
         return 0;
     }
@@ -80,7 +102,6 @@ CIPHER_DEFAULT_SETTABLE_CTX_PARAMS_END(ossl_cipher_generic)
 /*
  * Variable key length cipher functions for OSSL_PARAM settables
  */
-
 int ossl_cipher_var_keylen_set_ctx_params(void *vctx, const OSSL_PARAM params[])
 {
     PROV_CIPHER_CTX *ctx = (PROV_CIPHER_CTX *)vctx;
@@ -168,7 +189,7 @@ static int cipher_generic_init_internal(PROV_CIPHER_CTX *ctx,
             return 0;
     }
     if (key != NULL) {
-        if ((ctx-&gt;flags &amp; EVP_CIPH_VARIABLE_LENGTH) == 0) {
+        if (ctx-&gt;variable_keylength == 0) {
             if (keylen != ctx-&gt;keylen) {
                 ERR_raise(ERR_LIB_PROV, PROV_R_INVALID_KEYLEN);
                 return 0;
@@ -608,7 +629,11 @@ void ossl_cipher_generic_initkey(void *vctx, size_t kbits, size_t blkbits,
 {
     PROV_CIPHER_CTX *ctx = (PROV_CIPHER_CTX *)vctx;
 
-    ctx-&gt;flags = flags;
+    if ((flags &amp; PROV_CIPHER_FLAG_INVERSE_CIPHER) != 0)
+        ctx-&gt;inverse_cipher = 1;
+    if ((flags &amp; PROV_CIPHER_FLAG_VARIABLE_LENGTH) != 0)
+        ctx-&gt;variable_keylength = 1;
+
     ctx-&gt;pad = 1;
     ctx-&gt;keylen = ((kbits) / 8);
     ctx-&gt;ivlen = ((ivbits) / 8);
diff --git a/providers/implementations/ciphers/ciphercommon_ccm.c b/providers/implementations/ciphers/ciphercommon_ccm.c
index cb529f5f31..0009e9876c 100644
--- a/providers/implementations/ciphers/ciphercommon_ccm.c
+++ b/providers/implementations/ciphers/ciphercommon_ccm.c
@@ -291,9 +291,8 @@ int ccm_stream_final(void *vctx, unsigned char *out, size_t *outl,
     return 1;
 }
 
-int ccm_cipher(void *vctx,
-                      unsigned char *out, size_t *outl, size_t outsize,
-                      const unsigned char *in, size_t inl)
+int ccm_cipher(void *vctx, unsigned char *out, size_t *outl, size_t outsize,
+               const unsigned char *in, size_t inl)
 {
     PROV_CCM_CTX *ctx = (PROV_CCM_CTX *)vctx;
 
diff --git a/providers/implementations/ciphers/ciphercommon_hw.c b/providers/implementations/ciphers/ciphercommon_hw.c
index 7063593011..8673e7b744 100644
--- a/providers/implementations/ciphers/ciphercommon_hw.c
+++ b/providers/implementations/ciphers/ciphercommon_hw.c
@@ -85,7 +85,7 @@ int ossl_cipher_hw_generic_cfb1(PROV_CIPHER_CTX *dat, unsigned char *out,
 {
     int num = dat-&gt;num;
 
-    if ((dat-&gt;flags &amp; EVP_CIPH_FLAG_LENGTH_BITS) != 0) {
+    if (dat-&gt;use_bits) {
         CRYPTO_cfb128_1_encrypt(in, out, len, dat-&gt;ks, dat-&gt;iv, &amp;num,
                                 dat-&gt;enc, dat-&gt;block);
         dat-&gt;num = num;
diff --git a/providers/implementations/digests/digestcommon.c b/providers/implementations/digests/digestcommon.c
index 6d926713c8..b8e7efde60 100644
--- a/providers/implementations/digests/digestcommon.c
+++ b/providers/implementations/digests/digestcommon.c
@@ -26,8 +26,15 @@ int digest_default_get_params(OSSL_PARAM params[], size_t blksz, size_t paramsz,
         ERR_raise(ERR_LIB_PROV, PROV_R_FAILED_TO_SET_PARAMETER);
         return 0;
     }
-    p = OSSL_PARAM_locate(params, OSSL_DIGEST_PARAM_FLAGS);
-    if (p != NULL &amp;&amp; !OSSL_PARAM_set_ulong(p, flags)) {
+    p = OSSL_PARAM_locate(params, OSSL_DIGEST_PARAM_XOF);
+    if (p != NULL
+        &amp;&amp; !OSSL_PARAM_set_int(p, (flags &amp; PROV_DIGEST_FLAG_XOF) != 0)) {
+        ERR_raise(ERR_LIB_PROV, PROV_R_FAILED_TO_SET_PARAMETER);
+        return 0;
+    }
+    p = OSSL_PARAM_locate(params, OSSL_DIGEST_PARAM_ALGID_ABSENT);
+    if (p != NULL
+        &amp;&amp; !OSSL_PARAM_set_int(p, (flags &amp; PROV_DIGEST_FLAG_ALGID_ABSENT) != 0)) {
         ERR_raise(ERR_LIB_PROV, PROV_R_FAILED_TO_SET_PARAMETER);
         return 0;
     }
@@ -37,7 +44,8 @@ int digest_default_get_params(OSSL_PARAM params[], size_t blksz, size_t paramsz,
 static const OSSL_PARAM digest_default_known_gettable_params[] = {
     OSSL_PARAM_size_t(OSSL_DIGEST_PARAM_BLOCK_SIZE, NULL),
     OSSL_PARAM_size_t(OSSL_DIGEST_PARAM_SIZE, NULL),
-    OSSL_PARAM_ulong(OSSL_DIGEST_PARAM_FLAGS, NULL),
+    OSSL_PARAM_int(OSSL_DIGEST_PARAM_XOF, NULL),
+    OSSL_PARAM_int(OSSL_DIGEST_PARAM_ALGID_ABSENT, NULL),
     OSSL_PARAM_END
 };
 const OSSL_PARAM *digest_default_gettable_params(void *provctx)
diff --git a/providers/implementations/digests/sha2_prov.c b/providers/implementations/digests/sha2_prov.c
index 2f01149ad9..4cff62131c 100644
--- a/providers/implementations/digests/sha2_prov.c
+++ b/providers/implementations/digests/sha2_prov.c
@@ -24,6 +24,8 @@
 #include &quot;prov/implementations.h&quot;
 #include &quot;crypto/sha.h&quot;
 
+#define SHA2_FLAGS PROV_DIGEST_FLAG_ALGID_ABSENT
+
 static OSSL_FUNC_digest_set_ctx_params_fn sha1_set_ctx_params;
 static OSSL_FUNC_digest_settable_ctx_params_fn sha1_settable_ctx_params;
 
@@ -53,43 +55,37 @@ static int sha1_set_ctx_params(void *vctx, const OSSL_PARAM params[])
 
 /* ossl_sha1_functions */
 IMPLEMENT_digest_functions_with_settable_ctx(
-    sha1, SHA_CTX, SHA_CBLOCK, SHA_DIGEST_LENGTH, EVP_MD_FLAG_DIGALGID_ABSENT,
+    sha1, SHA_CTX, SHA_CBLOCK, SHA_DIGEST_LENGTH, SHA2_FLAGS,
     SHA1_Init, SHA1_Update, SHA1_Final,
     sha1_settable_ctx_params, sha1_set_ctx_params)
 
 /* ossl_sha224_functions */
 IMPLEMENT_digest_functions(sha224, SHA256_CTX,
-                           SHA256_CBLOCK, SHA224_DIGEST_LENGTH,
-                           EVP_MD_FLAG_DIGALGID_ABSENT,
+                           SHA256_CBLOCK, SHA224_DIGEST_LENGTH, SHA2_FLAGS,
                            SHA224_Init, SHA224_Update, SHA224_Final)
 
 /* ossl_sha256_functions */
 IMPLEMENT_digest_functions(sha256, SHA256_CTX,
-                           SHA256_CBLOCK, SHA256_DIGEST_LENGTH,
-                           EVP_MD_FLAG_DIGALGID_ABSENT,
+                           SHA256_CBLOCK, SHA256_DIGEST_LENGTH, SHA2_FLAGS,
                            SHA256_Init, SHA256_Update, SHA256_Final)
 
 /* ossl_sha384_functions */
 IMPLEMENT_digest_functions(sha384, SHA512_CTX,
-                           SHA512_CBLOCK, SHA384_DIGEST_LENGTH,
-                           EVP_MD_FLAG_DIGALGID_ABSENT,
+                           SHA512_CBLOCK, SHA384_DIGEST_LENGTH, SHA2_FLAGS,
                            SHA384_Init, SHA384_Update, SHA384_Final)
 
 /* ossl_sha512_functions */
 IMPLEMENT_digest_functions(sha512, SHA512_CTX,
-                           SHA512_CBLOCK, SHA512_DIGEST_LENGTH,
-                           EVP_MD_FLAG_DIGALGID_ABSENT,
+                           SHA512_CBLOCK, SHA512_DIGEST_LENGTH, SHA2_FLAGS,
                            SHA512_Init, SHA512_Update, SHA512_Final)
 
 /* ossl_sha512_224_functions */
 IMPLEMENT_digest_functions(sha512_224, SHA512_CTX,
-                           SHA512_CBLOCK, SHA224_DIGEST_LENGTH,
-                           EVP_MD_FLAG_DIGALGID_ABSENT,
+                           SHA512_CBLOCK, SHA224_DIGEST_LENGTH, SHA2_FLAGS,
                            sha512_224_init, SHA512_Update, SHA512_Final)
 
 /* ossl_sha512_256_functions */
 IMPLEMENT_digest_functions(sha512_256, SHA512_CTX,
-                           SHA512_CBLOCK, SHA256_DIGEST_LENGTH,
-                           EVP_MD_FLAG_DIGALGID_ABSENT,
+                           SHA512_CBLOCK, SHA256_DIGEST_LENGTH, SHA2_FLAGS,
                            sha512_256_init, SHA512_Update, SHA512_Final)
 
diff --git a/providers/implementations/digests/sha3_prov.c b/providers/implementations/digests/sha3_prov.c
index 6b44792529..6e731fd842 100644
--- a/providers/implementations/digests/sha3_prov.c
+++ b/providers/implementations/digests/sha3_prov.c
@@ -18,6 +18,10 @@
 #include &quot;prov/implementations.h&quot;
 #include &quot;prov/providercommonerr.h&quot;
 
+#define SHA3_FLAGS PROV_DIGEST_FLAG_ALGID_ABSENT
+#define SHAKE_FLAGS PROV_DIGEST_FLAG_XOF
+#define KMAC_FLAGS PROV_DIGEST_FLAG_XOF
+
 /*
  * Forward declaration of any unique methods implemented here. This is not strictly
  * necessary for the compiler, but provides an assurance that the signatures
@@ -286,18 +290,18 @@ static int shake_set_ctx_params(void *vctx, const OSSL_PARAM params[])
     SHA3_newctx(sha3, SHA3_##bitlen, sha3_##bitlen, bitlen, '\x06')            \
     PROV_FUNC_SHA3_DIGEST(sha3_##bitlen, bitlen,                               \
                           SHA3_BLOCKSIZE(bitlen), SHA3_MDSIZE(bitlen),         \
-                          EVP_MD_FLAG_DIGALGID_ABSENT)
+                          SHA3_FLAGS)
 
 #define IMPLEMENT_SHAKE_functions(bitlen)                                      \
     SHA3_newctx(shake, SHAKE_##bitlen, shake_##bitlen, bitlen, '\x1f')         \
     PROV_FUNC_SHAKE_DIGEST(shake_##bitlen, bitlen,                             \
                           SHA3_BLOCKSIZE(bitlen), SHA3_MDSIZE(bitlen),         \
-                          EVP_MD_FLAG_XOF)
+                          SHAKE_FLAGS)
 #define IMPLEMENT_KMAC_functions(bitlen)                                       \
     KMAC_newctx(keccak_kmac_##bitlen, bitlen, '\x04')                          \
     PROV_FUNC_SHAKE_DIGEST(keccak_kmac_##bitlen, bitlen,                       \
                            SHA3_BLOCKSIZE(bitlen), KMAC_MDSIZE(bitlen),        \
-                           EVP_MD_FLAG_XOF)
+                           KMAC_FLAGS)
 
 /* ossl_sha3_224_functions */
 IMPLEMENT_SHA3_functions(224)
diff --git a/providers/implementations/include/prov/ciphercommon.h b/providers/implementations/include/prov/ciphercommon.h
index efc7eb9223..ee35400936 100644
--- a/providers/implementations/include/prov/ciphercommon.h
+++ b/providers/implementations/include/prov/ciphercommon.h
@@ -34,6 +34,15 @@ typedef int (PROV_CIPHER_HW_FN)(PROV_CIPHER_CTX *dat, unsigned char *out,
 /* TODO(3.0): VERIFY ME */
 #define MAX_TLS_MAC_SIZE    48
 
+/* Internal flags that can be queried */
+#define PROV_CIPHER_FLAG_AEAD             0x0001
+#define PROV_CIPHER_FLAG_CUSTOM_IV        0x0002
+#define PROV_CIPHER_FLAG_CTS              0x0004
+#define PROV_CIPHER_FLAG_TLS1_MULTIBLOCK  0x0008
+/* Internal flags that are only used within the provider */
+#define PROV_CIPHER_FLAG_VARIABLE_LENGTH  0x0010
+#define PROV_CIPHER_FLAG_INVERSE_CIPHER   0x0020
+
 struct prov_cipher_ctx_st {
     block128_f block;
     union {
@@ -52,7 +61,9 @@ struct prov_cipher_ctx_st {
     unsigned int enc : 1;    /* Set to 1 for encrypt, or 0 otherwise */
     unsigned int iv_set : 1; /* Set when the iv is copied to the iv/oiv buffers */
     unsigned int updated : 1; /* Set to 1 during update for one shot ciphers */
-
+    unsigned int variable_keylength : 1;
+    unsigned int inverse_cipher : 1; /* set to 1 to use inverse cipher */
+    unsigned int use_bits : 1; /* Set to 0 for cfb1 to use bits instead of bytes */
 
     unsigned int tlsversion; /* If TLS padding is in use the TLS version number */
     unsigned char *tlsmac;   /* tls MAC extracted from the last record */
@@ -73,7 +84,6 @@ struct prov_cipher_ctx_st {
      * manage partial blocks themselves.
      */
     unsigned int num;
-    uint64_t flags;
 
     /* The original value of the iv */
     unsigned char oiv[GENERIC_BLOCK_SIZE];
@@ -110,11 +120,12 @@ OSSL_FUNC_cipher_gettable_ctx_params_fn ossl_cipher_aead_gettable_ctx_params;
 OSSL_FUNC_cipher_settable_ctx_params_fn ossl_cipher_aead_settable_ctx_params;
 
 int ossl_cipher_generic_get_params(OSSL_PARAM params[], unsigned int md,
-                              unsigned long flags,
-                              size_t kbits, size_t blkbits, size_t ivbits);
+                                   uint64_t flags,
+                                   size_t kbits, size_t blkbits, size_t ivbits);
 void ossl_cipher_generic_initkey(void *vctx, size_t kbits, size_t blkbits,
-                            size_t ivbits, unsigned int mode, uint64_t flags,
-                            const PROV_CIPHER_HW *hw, void *provctx);
+                                 size_t ivbits, unsigned int mode,
+                                 uint64_t flags,
+                                 const PROV_CIPHER_HW *hw, void *provctx);
 
 #define IMPLEMENT_generic_cipher_func(alg, UCALG, lcmode, UCMODE, flags, kbits,\
                                       blkbits, ivbits, typ)                    \
diff --git a/providers/implementations/include/prov/ciphercommon_aead.h b/providers/implementations/include/prov/ciphercommon_aead.h
index 47175f7247..63fdb54151 100644
--- a/providers/implementations/include/prov/ciphercommon_aead.h
+++ b/providers/implementations/include/prov/ciphercommon_aead.h
@@ -9,21 +9,16 @@
 
 #define UNINITIALISED_SIZET ((size_t)-1)
 
-/* TODO(3.0) Figure out what flags are really needed */
-#define AEAD_FLAGS (EVP_CIPH_FLAG_AEAD_CIPHER           \
-                    | EVP_CIPH_CUSTOM_IV                \
-                    | EVP_CIPH_ALWAYS_CALL_INIT         \
-                    | EVP_CIPH_CTRL_INIT                \
-                    | EVP_CIPH_CUSTOM_COPY)
+#define AEAD_FLAGS (PROV_CIPHER_FLAG_AEAD | PROV_CIPHER_FLAG_CUSTOM_IV)
 
 #define IMPLEMENT_aead_cipher(alg, lc, UCMODE, flags, kbits, blkbits, ivbits)  \
-static OSSL_FUNC_cipher_get_params_fn alg##_##kbits##_##lc##_get_params;         \
+static OSSL_FUNC_cipher_get_params_fn alg##_##kbits##_##lc##_get_params;       \
 static int alg##_##kbits##_##lc##_get_params(OSSL_PARAM params[])              \
 {                                                                              \
-    return ossl_cipher_generic_get_params(params, EVP_CIPH_##UCMODE##_MODE,         \
+    return ossl_cipher_generic_get_params(params, EVP_CIPH_##UCMODE##_MODE,    \
                                      flags, kbits, blkbits, ivbits);           \
 }                                                                              \
-static OSSL_FUNC_cipher_newctx_fn alg##kbits##lc##_newctx;                       \
+static OSSL_FUNC_cipher_newctx_fn alg##kbits##lc##_newctx;                     \
 static void * alg##kbits##lc##_newctx(void *provctx)                           \
 {                                                                              \
     return alg##_##lc##_newctx(provctx, kbits);                                \
@@ -43,10 +38,10 @@ const OSSL_DISPATCH ossl_##alg##kbits##lc##_functions[] = {                    \
     { OSSL_FUNC_CIPHER_SET_CTX_PARAMS,                                         \
       (void (*)(void)) lc##_set_ctx_params },                                  \
     { OSSL_FUNC_CIPHER_GETTABLE_PARAMS,                                        \
-      (void (*)(void))ossl_cipher_generic_gettable_params },                        \
+      (void (*)(void))ossl_cipher_generic_gettable_params },                   \
     { OSSL_FUNC_CIPHER_GETTABLE_CTX_PARAMS,                                    \
-      (void (*)(void))ossl_cipher_aead_gettable_ctx_params },                       \
+      (void (*)(void))ossl_cipher_aead_gettable_ctx_params },                  \
     { OSSL_FUNC_CIPHER_SETTABLE_CTX_PARAMS,                                    \
-      (void (*)(void))ossl_cipher_aead_settable_ctx_params },                       \
+      (void (*)(void))ossl_cipher_aead_settable_ctx_params },                  \
     { 0, NULL }                                                                \
 }
diff --git a/providers/implementations/include/prov/digestcommon.h b/providers/implementations/include/prov/digestcommon.h
index 99004731fa..f1164c5a1a 100644
--- a/providers/implementations/include/prov/digestcommon.h
+++ b/providers/implementations/include/prov/digestcommon.h
@@ -15,6 +15,10 @@
 # include &lt;openssl/params.h&gt;
 # include &quot;prov/providercommon.h&quot;
 
+/* Internal flags that can be queried */
+#define PROV_DIGEST_FLAG_XOF             0x0001
+#define PROV_DIGEST_FLAG_ALGID_ABSENT    0x0002
+
 # ifdef __cplusplus
 extern &quot;C&quot; {
 # endif
diff --git a/providers/implementations/macs/hmac_prov.c b/providers/implementations/macs/hmac_prov.c
index 993e36ae34..3f9a862458 100644
--- a/providers/implementations/macs/hmac_prov.c
+++ b/providers/implementations/macs/hmac_prov.c
@@ -83,7 +83,6 @@ static void *hmac_new(void *provctx)
         OPENSSL_free(macctx);
         return NULL;
     }
-    /* TODO(3.0) Should we do something more with that context? */
     macctx-&gt;provctx = provctx;
 
     return macctx;
@@ -239,7 +238,8 @@ static const OSSL_PARAM known_settable_ctx_params[] = {
     OSSL_PARAM_utf8_string(OSSL_MAC_PARAM_DIGEST, NULL, 0),
     OSSL_PARAM_utf8_string(OSSL_MAC_PARAM_PROPERTIES, NULL, 0),
     OSSL_PARAM_octet_string(OSSL_MAC_PARAM_KEY, NULL, 0),
-    OSSL_PARAM_int(OSSL_MAC_PARAM_FLAGS, NULL),
+    OSSL_PARAM_int(OSSL_MAC_PARAM_DIGEST_NOINIT, NULL),
+    OSSL_PARAM_int(OSSL_MAC_PARAM_DIGEST_ONESHOT, NULL),
     OSSL_PARAM_size_t(OSSL_MAC_PARAM_TLS_DATA_SIZE, NULL),
     OSSL_PARAM_END
 };
@@ -248,6 +248,23 @@ static const OSSL_PARAM *hmac_settable_ctx_params(ossl_unused void *provctx)
     return known_settable_ctx_params;
 }
 
+static int set_flag(const OSSL_PARAM params[], const char *key, int mask,
+                    int *flags)
+{
+    const OSSL_PARAM *p = OSSL_PARAM_locate_const(params, key);
+    int flag = 0;
+
+    if (p != NULL) {
+        if (!OSSL_PARAM_get_int(p, &amp;flag))
+            return 0;
+        if (flag == 0)
+            *flags &amp;= ~mask;
+        else
+            *flags |= mask;
+    }
+    return 1;
+}
+
 /*
  * ALL parameters should be set before init().
  */
@@ -256,19 +273,20 @@ static int hmac_set_ctx_params(void *vmacctx, const OSSL_PARAM params[])
     struct hmac_data_st *macctx = vmacctx;
     OSSL_LIB_CTX *ctx = PROV_LIBCTX_OF(macctx-&gt;provctx);
     const OSSL_PARAM *p;
+    int flags = 0;
 
     if (!ossl_prov_digest_load_from_params(&amp;macctx-&gt;digest, params, ctx))
         return 0;
 
-    /* TODO(3.0) formalize the meaning of &quot;flags&quot;, perhaps as other params */
-    if ((p = OSSL_PARAM_locate_const(params,
-                                     OSSL_MAC_PARAM_FLAGS)) != NULL) {
-        int flags = 0;
-
-        if (!OSSL_PARAM_get_int(p, &amp;flags))
-            return 0;
+    if (!set_flag(params, OSSL_MAC_PARAM_DIGEST_NOINIT, EVP_MD_CTX_FLAG_NO_INIT,
+                  &amp;flags))
+        return 0;
+    if (!set_flag(params, OSSL_MAC_PARAM_DIGEST_ONESHOT, EVP_MD_CTX_FLAG_ONESHOT,
+                  &amp;flags))
+        return 0;
+    if (flags)
         HMAC_CTX_set_flags(macctx-&gt;ctx, flags);
-    }
+
     if ((p = OSSL_PARAM_locate_const(params, OSSL_MAC_PARAM_KEY)) != NULL) {
         if (p-&gt;data_type != OSSL_PARAM_OCTET_STRING)
             return 0;
</PRE>

















<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="033053.html">[openssl]  master update
</A></li>
	<LI>Next message: <A HREF="033057.html">[openssl]  master update
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#33055">[ date ]</a>
              <a href="thread.html#33055">[ thread ]</a>
              <a href="subject.html#33055">[ subject ]</a>
              <a href="author.html#33055">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="../../../mailman/listinfo/openssl-commits.html">More information about the openssl-commits
mailing list</a><br>
</body></html>
