<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [openssl-commits] [openssl]  master update
   </TITLE>
   <LINK REL="Index" HREF="https://mta.openssl.org/pipermail/openssl-commits/2016-September/index.html" >
   <LINK REL="made" HREF="mailto:openssl-commits%40openssl.org?Subject=Re%3A%20%5Bopenssl-commits%5D%20%5Bopenssl%5D%20%20master%20update&In-Reply-To=%3C1474928176.831455.5814.nullmailer%40dev.openssl.org%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="010802.html">
   <LINK REL="Next"  HREF="010829.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[openssl-commits] [openssl]  master update</H1>
    <B>Matt Caswell</B> 
    <A HREF="mailto:openssl-commits%40openssl.org?Subject=Re%3A%20%5Bopenssl-commits%5D%20%5Bopenssl%5D%20%20master%20update&In-Reply-To=%3C1474928176.831455.5814.nullmailer%40dev.openssl.org%3E"
       TITLE="[openssl-commits] [openssl]  master update">matt at openssl.org
       </A><BR>
    <I>Mon Sep 26 22:16:16 UTC 2016</I>
    <P><UL>
        <LI>Previous message: <A HREF="010802.html">[openssl-commits] [openssl]  master update
</A></li>
        <LI>Next message: <A HREF="010829.html">[openssl-commits] [openssl]  master update
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#10813">[ date ]</a>
              <a href="thread.html#10813">[ thread ]</a>
              <a href="subject.html#10813">[ subject ]</a>
              <a href="author.html#10813">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>The branch master has been updated
       via  243ecf19ddc0dc2366de1be5c404d66d483b196d (commit)
       via  f3ea8d77080580979be086d97879ebc8b72f970a (commit)
       via  3058b742664287a30be77488c2ce3d8103bffd64 (commit)
       via  5cf6d7c51f16fd78de7921dc441e24897c8b3cc6 (commit)
       via  8523288e6d667f052bda092e01ab17986782fede (commit)
      from  fa454945cf2855fed452ff9bdb1876096bc07beb (commit)


- Log -----------------------------------------------------------------
commit 243ecf19ddc0dc2366de1be5c404d66d483b196d
Author: David Benjamin &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">davidben at google.com</A>&gt;
Date:   Thu Aug 25 01:55:48 2016 -0400

    Add missing parameter.
    
    Reviewed-by: Rich Salz &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">rsalz at openssl.org</A>&gt;
    Reviewed-by: Matt Caswell &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">matt at openssl.org</A>&gt;

commit f3ea8d77080580979be086d97879ebc8b72f970a
Author: David Benjamin &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">davidben at google.com</A>&gt;
Date:   Thu Aug 18 00:43:05 2016 -0400

    Switch back to assuming TLS 1.2.
    
    The TLSProxy::Record-&gt;new call hard-codes a version, like
    70-test_sslrecords.t.
    
    Reviewed-by: Rich Salz &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">rsalz at openssl.org</A>&gt;
    Reviewed-by: Matt Caswell &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">matt at openssl.org</A>&gt;

commit 3058b742664287a30be77488c2ce3d8103bffd64
Author: David Benjamin &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">davidben at google.com</A>&gt;
Date:   Thu Aug 18 00:38:43 2016 -0400

    Address review comments.
    
    Reviewed-by: Rich Salz &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">rsalz at openssl.org</A>&gt;
    Reviewed-by: Matt Caswell &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">matt at openssl.org</A>&gt;

commit 5cf6d7c51f16fd78de7921dc441e24897c8b3cc6
Author: David Benjamin &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">davidben at google.com</A>&gt;
Date:   Wed Aug 10 10:45:49 2016 -0400

    Don't test quite so many of them.
    
    Avoid making the CI blow up.
    
    Reviewed-by: Rich Salz &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">rsalz at openssl.org</A>&gt;
    Reviewed-by: Matt Caswell &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">matt at openssl.org</A>&gt;

commit 8523288e6d667f052bda092e01ab17986782fede
Author: David Benjamin &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">davidben at google.com</A>&gt;
Date:   Wed Aug 10 00:45:51 2016 -0400

    Test CBC mode padding.
    
    This is a regression test for
    <A HREF="https://github.com/openssl/openssl/pull/1431.">https://github.com/openssl/openssl/pull/1431.</A> It tests a
    maximally-padded record with each possible invalid offset.
    
    This required fixing a bug in Message.pm where the client sending a
    fatal alert followed by close_notify was still treated as success.
    
    Reviewed-by: Rich Salz &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">rsalz at openssl.org</A>&gt;
    Reviewed-by: Matt Caswell &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">matt at openssl.org</A>&gt;

-----------------------------------------------------------------------

Summary of changes:
 test/recipes/70-test_sslcbcpadding.t | 110 +++++++++++++++++++++++++++++++++++
 util/TLSProxy/Message.pm             |   6 +-
 util/TLSProxy/Proxy.pm               |  11 ++++
 3 files changed, 124 insertions(+), 3 deletions(-)
 create mode 100644 test/recipes/70-test_sslcbcpadding.t

diff --git a/test/recipes/70-test_sslcbcpadding.t b/test/recipes/70-test_sslcbcpadding.t
new file mode 100644
index 0000000..fdaa466
--- /dev/null
+++ b/test/recipes/70-test_sslcbcpadding.t
@@ -0,0 +1,110 @@
+#! /usr/bin/env perl
+# Copyright 2016 The OpenSSL Project Authors. All Rights Reserved.
+#
+# Licensed under the OpenSSL license (the &quot;License&quot;).  You may not use
+# this file except in compliance with the License.  You can obtain a copy
+# in the file LICENSE in the source distribution or at
+# <A HREF="https://www.openssl.org/source/license.html">https://www.openssl.org/source/license.html</A>
+
+use strict;
+use OpenSSL::Test qw/:DEFAULT cmdstr srctop_file bldtop_dir/;
+use OpenSSL::Test::Utils;
+use TLSProxy::Proxy;
+
+my $test_name = &quot;test_sslcbcpadding&quot;;
+setup($test_name);
+
+plan skip_all =&gt; &quot;TLSProxy isn't usable on $^O&quot;
+    if $^O =~ /^(VMS|MSWin32)$/;
+
+plan skip_all =&gt; &quot;$test_name needs the dynamic engine feature enabled&quot;
+    if disabled(&quot;engine&quot;) || disabled(&quot;dynamic-engine&quot;);
+
+plan skip_all =&gt; &quot;$test_name needs the sock feature enabled&quot;
+    if disabled(&quot;sock&quot;);
+
+plan skip_all =&gt; &quot;$test_name needs TLSv1.2 enabled&quot;
+    if disabled(&quot;tls1_2&quot;);
+
+$ENV{OPENSSL_ia32cap} = '~0x200000200000000';
+my $proxy = TLSProxy::Proxy-&gt;new(
+    \&amp;add_maximal_padding_filter,
+    cmdstr(app([&quot;openssl&quot;]), display =&gt; 1),
+    srctop_file(&quot;apps&quot;, &quot;server.pem&quot;),
+    (!$ENV{HARNESS_ACTIVE} || $ENV{HARNESS_VERBOSE})
+);
+
+# TODO: We could test all 256 values, but then the log file gets too large for
+# CI. See <A HREF="https://github.com/openssl/openssl/issues/1440.">https://github.com/openssl/openssl/issues/1440.</A>
+my @test_offsets = (0, 128, 254, 255);
+
+# Test that maximally-padded records are accepted.
+my $bad_padding_offset = -1;
+$proxy-&gt;start() or plan skip_all =&gt; &quot;Unable to start up Proxy for tests&quot;;
+plan tests =&gt; 1 + scalar(@test_offsets);
+ok(TLSProxy::Message-&gt;success(), &quot;Maximally-padded record test&quot;);
+
+# Test that invalid padding is rejected.
+foreach my $offset (@test_offsets) {
+    $proxy-&gt;clear();
+    $bad_padding_offset = $offset;
+    $proxy-&gt;start();
+    ok(TLSProxy::Message-&gt;fail(), &quot;Invalid padding byte $bad_padding_offset&quot;);
+}
+
+sub add_maximal_padding_filter
+{
+    my $proxy = shift;
+
+    if ($proxy-&gt;flight == 0) {
+        # Disable Encrypt-then-MAC.
+        foreach my $message (@{$proxy-&gt;message_list}) {
+            if ($message-&gt;mt != TLSProxy::Message::MT_CLIENT_HELLO) {
+                next;
+            }
+
+            $message-&gt;delete_extension(TLSProxy::Message::EXT_ENCRYPT_THEN_MAC);
+            $message-&gt;process_extensions();
+            $message-&gt;repack();
+        }
+    }
+
+    if ($proxy-&gt;flight == 3) {
+        # Insert a maximally-padded record. Assume a block size of 16 (AES) and
+        # a MAC length of 20 (SHA-1).
+        my $block_size = 16;
+        my $mac_len = 20;
+
+        # Size the plaintext so that 256 is a valid padding.
+        my $plaintext_len = $block_size - ($mac_len % $block_size);
+        my $plaintext = &quot;A&quot; x $plaintext_len;
+
+        my $data = &quot;B&quot; x $block_size; # Explicit IV.
+        $data .= $plaintext;
+        $data .= TLSProxy::Proxy::fill_known_data($mac_len); # MAC.
+
+        # Add padding.
+        for (my $i = 0; $i &lt; 256; $i++) {
+            if ($i == $bad_padding_offset) {
+                $data .= &quot;\xfe&quot;;
+            } else {
+                $data .= &quot;\xff&quot;;
+            }
+        }
+
+        my $record = TLSProxy::Record-&gt;new(
+            $proxy-&gt;flight,
+            TLSProxy::Record::RT_APPLICATION_DATA,
+            TLSProxy::Record::VERS_TLS_1_2,
+            length($data),
+            0,
+            length($data),
+            $plaintext_len,
+            $data,
+            $plaintext,
+        );
+
+        # Send the record immediately after the server Finished.
+        push @{$proxy-&gt;record_list}, $record;
+    }
+}
diff --git a/util/TLSProxy/Message.pm b/util/TLSProxy/Message.pm
index 321e080..1810d8c 100644
--- a/util/TLSProxy/Message.pm
+++ b/util/TLSProxy/Message.pm
@@ -199,14 +199,14 @@ sub get_messages
         print &quot;  [&quot;.$record-&gt;decrypt_data.&quot;]\n&quot;;
     } elsif ($record-&gt;content_type == TLSProxy::Record::RT_ALERT) {
         my ($alertlev, $alertdesc) = unpack('CC', $record-&gt;decrypt_data);
-        #All alerts end the test
-        $end = 1;
         #A CloseNotify from the client indicates we have finished successfully
         #(we assume)
-        if (!$server &amp;&amp; $alertlev == AL_LEVEL_WARN
+        if (!$end &amp;&amp; !$server &amp;&amp; $alertlev == AL_LEVEL_WARN
             &amp;&amp; $alertdesc == AL_DESC_CLOSE_NOTIFY) {
             $success = 1;
         }
+        #All alerts end the test
+        $end = 1;
     }
 
     return @messages;
diff --git a/util/TLSProxy/Proxy.pm b/util/TLSProxy/Proxy.pm
index e0ce43a..eeb83ed 100644
--- a/util/TLSProxy/Proxy.pm
+++ b/util/TLSProxy/Proxy.pm
@@ -493,4 +493,15 @@ sub serverpid
     }
     return $self-&gt;{serverpid};
 }
+
+sub fill_known_data
+{
+    my $length = shift;
+    my $ret = &quot;&quot;;
+    for (my $i = 0; $i &lt; $length; $i++) {
+        $ret .= chr($i);
+    }
+    return $ret;
+}
+
 1;
</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="010802.html">[openssl-commits] [openssl]  master update
</A></li>
	<LI>Next message: <A HREF="010829.html">[openssl-commits] [openssl]  master update
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#10813">[ date ]</a>
              <a href="thread.html#10813">[ thread ]</a>
              <a href="subject.html#10813">[ subject ]</a>
              <a href="author.html#10813">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="../../../mailman/listinfo/openssl-commits.html">More information about the openssl-commits
mailing list</a><br>
</body></html>
