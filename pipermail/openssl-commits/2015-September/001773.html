<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [openssl-commits] [openssl]  master update
   </TITLE>
   <LINK REL="Index" HREF="https://mta.openssl.org/pipermail/openssl-commits/2015-September/index.html" >
   <LINK REL="made" HREF="mailto:openssl-commits%40openssl.org?Subject=Re%3A%20%5Bopenssl-commits%5D%20%5Bopenssl%5D%20%20master%20update&In-Reply-To=%3C1441635109.899856.28679.nullmailer%40dev.openssl.org%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="001772.html">
   <LINK REL="Next"  HREF="001774.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[openssl-commits] [openssl]  master update</H1>
    <B>Richard Levitte</B> 
    <A HREF="mailto:openssl-commits%40openssl.org?Subject=Re%3A%20%5Bopenssl-commits%5D%20%5Bopenssl%5D%20%20master%20update&In-Reply-To=%3C1441635109.899856.28679.nullmailer%40dev.openssl.org%3E"
       TITLE="[openssl-commits] [openssl]  master update">levitte at openssl.org
       </A><BR>
    <I>Mon Sep  7 14:11:49 UTC 2015</I>
    <P><UL>
        <LI>Previous message: <A HREF="001772.html">[openssl-commits] [openssl]  master update
</A></li>
        <LI>Next message: <A HREF="001774.html">[openssl-commits] [openssl]  master update
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1773">[ date ]</a>
              <a href="thread.html#1773">[ thread ]</a>
              <a href="subject.html#1773">[ subject ]</a>
              <a href="author.html#1773">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>The branch master has been updated
       via  a351805733a2c0511c61e7fef06fe645e31a4796 (commit)
       via  eb8cd5dec28313d03025c160f81207ac6137f44a (commit)
       via  1c73c3bcf02731b4ce693b6e3ece9543cef4f2a0 (commit)
       via  ca5d7dff72b10cb030437a03d779c4fcf8ab832b (commit)
       via  49b147f85b96482be3931abda306afdf84d75d17 (commit)
       via  e3ff089249a31765c23faaf9d8019b7889dd0c58 (commit)
       via  5beb63c41e8bc140cd8096af8195b0b95bef1ff5 (commit)
       via  5ab4f893ce6d10e9286fd746acebe382c36cd32d (commit)
       via  24d794de25ae419f925b9ccc1e5dbab1b372cce8 (commit)
       via  50f0a9b3dd41c37875def805c2c48f8b2ed3ef24 (commit)
       via  c27a4049475428b902004a47104c17e1eaaadd20 (commit)
       via  25be5f44b81e1c45e15e689ba55713e455dfe624 (commit)
       via  53520ebe8757fea7d2e9ffe3d0c610dd6b9b9cc6 (commit)
       via  2511c12bf2d5f07f329d1e90cde8791817e4357e (commit)
       via  8de4f3d3a63f5eb5afa4bd92043953b501d0d7eb (commit)
       via  2a74b62e3ae1b6916190ff19276ed49a9b728b8f (commit)
       via  ca904707b6df0f5077f9eff94f29bd8035d042a7 (commit)
       via  8368d46bcadf13dd2c675da8113fcc9400ae12fc (commit)
       via  f5098edb14ce7da8db814dd392358d53c2b81496 (commit)
       via  fd99c6b599a8ed87b726caaa6d88c6915a60e0f4 (commit)
       via  caadc54381af04dd49d9812737d40fea320c8674 (commit)
       via  fb921436f3dc03daf4a7ac1fec9f1e458772e17b (commit)
       via  d6c5b66c1c9457a7f8c8f69c1ad3b4557dcd3fa2 (commit)
       via  204e41ed504b6deb370bdbf85fd988c03eff363b (commit)
       via  71a4f2832c3fe02d026af8241767ee80f440e876 (commit)
       via  fd9ad2300b280c0f71d24456bfbf04579331bc94 (commit)
       via  93de4f58ef8be2cb764343cb3102d41c81f11593 (commit)
       via  d11b43fdd30f084c19136359d0e3e4a06631abf9 (commit)
       via  7dc11227a385fd7e248e1292653761ec9ce9c105 (commit)
       via  127d25903fc705756ac211ea373104d8e8858ae1 (commit)
       via  88b8a5279f452027c193c2de7909dd9f7c9736c6 (commit)
       via  4fb35f8fcba5b49bdf8223e1964ef4cf640ea0ca (commit)
       via  4650de3e431d123e988821215f6473e93c3d4b17 (commit)
       via  0c85cc506916039bba86e8335aa71e0e44f038b0 (commit)
       via  904ae3342600fe1dae3e0835a784c73b7c237106 (commit)
       via  13350a0c0eb8937c299c394a88d6cb51d3356d1f (commit)
       via  894025c6428e7a78fb251e7a16522c3b7351f357 (commit)
       via  f3356b7f49823ddf31683667dfd376312b0a92a3 (commit)
       via  aec27d4d5210234560deab85c97bd453535f66ae (commit)
      from  8098fc566351cb76a2c5ad4f465df51f5e7e8c12 (commit)


- Log -----------------------------------------------------------------
commit a351805733a2c0511c61e7fef06fe645e31a4796
Author: Richard Levitte &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">levitte at openssl.org</A>&gt;
Date:   Mon Sep 7 01:09:23 2015 +0200

    Make sure that 80-test_ca.t finds all the config files
    
    This recipe counted too much on being called with test/ as its current
    working directory.  That's a mistake on, for example, Windows.
    
    Reviewed-by: Rich Salz &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">rsalz at openssl.org</A>&gt;

commit eb8cd5dec28313d03025c160f81207ac6137f44a
Author: Richard Levitte &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">levitte at openssl.org</A>&gt;
Date:   Sun Sep 6 16:04:15 2015 +0200

    Add a recipe for the new null pointer test
    
    Reviewed-by: Rich Salz &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">rsalz at openssl.org</A>&gt;

commit 1c73c3bcf02731b4ce693b6e3ece9543cef4f2a0
Author: Richard Levitte &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">levitte at openssl.org</A>&gt;
Date:   Sun Sep 6 16:03:30 2015 +0200

    Change the 80-test_tsa recipe as per changes in testtsa
    
    Reviewed-by: Rich Salz &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">rsalz at openssl.org</A>&gt;

commit ca5d7dff72b10cb030437a03d779c4fcf8ab832b
Author: Richard Levitte &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">levitte at openssl.org</A>&gt;
Date:   Thu Sep 3 21:17:31 2015 +0200

    Add a recipe for the new pbelu test
    
    Reviewed-by: Rich Salz &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">rsalz at openssl.org</A>&gt;

commit 49b147f85b96482be3931abda306afdf84d75d17
Author: Richard Levitte &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">levitte at openssl.org</A>&gt;
Date:   Thu Sep 3 20:54:01 2015 +0200

    Remake the testsslproxy tests
    
    The testsslproxy tests turned out to be useless as they were.  They
    were really just for show and the results were ignore.  Now they are
    changed into a more veerifiable test
    
    Reviewed-by: Rich Salz &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">rsalz at openssl.org</A>&gt;

commit e3ff089249a31765c23faaf9d8019b7889dd0c58
Author: Richard Levitte &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">levitte at openssl.org</A>&gt;
Date:   Thu Sep 3 19:41:40 2015 +0200

    Small fix in OpenSSL::Test
    
    Be careful when shifting in a function argument, you end up changing
    the caller's value.  Instead, when it is an array, make a shallow copy
    and shift in that instead.
    
    Reviewed-by: Rich Salz &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">rsalz at openssl.org</A>&gt;

commit 5beb63c41e8bc140cd8096af8195b0b95bef1ff5
Author: Richard Levitte &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">levitte at openssl.org</A>&gt;
Date:   Thu Sep 3 19:39:58 2015 +0200

    Incorporate recent changes that were originally made in test/testssl
    
    Reviewed-by: Rich Salz &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">rsalz at openssl.org</A>&gt;

commit 5ab4f893ce6d10e9286fd746acebe382c36cd32d
Author: Richard Levitte &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">levitte at openssl.org</A>&gt;
Date:   Thu Sep 3 12:00:28 2015 +0200

    Add documentation for the new testing framework
    
    Reviewed-by: Rich Salz &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">rsalz at openssl.org</A>&gt;

commit 24d794de25ae419f925b9ccc1e5dbab1b372cce8
Author: Richard Levitte &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">levitte at openssl.org</A>&gt;
Date:   Thu Sep 3 09:24:01 2015 +0200

    Add a recipe for the new gmdiff test
    
    Reviewed-by: Rich Salz &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">rsalz at openssl.org</A>&gt;

commit 50f0a9b3dd41c37875def805c2c48f8b2ed3ef24
Author: Richard Levitte &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">levitte at openssl.org</A>&gt;
Date:   Thu Sep 3 09:23:32 2015 +0200

    Correct test name
    
    Some tests were copied from test_jpake, but the title wasn't changed
    accordingly.  This might seem like a small thing, but it does affect
    the log file name...
    
    Reviewed-by: Rich Salz &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">rsalz at openssl.org</A>&gt;

commit c27a4049475428b902004a47104c17e1eaaadd20
Author: Richard Levitte &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">levitte at openssl.org</A>&gt;
Date:   Fri Aug 28 03:07:24 2015 +0200

    Remake test/sslsessionticktest.pl into a recipe
    
    Reviewed-by: Rich Salz &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">rsalz at openssl.org</A>&gt;

commit 25be5f44b81e1c45e15e689ba55713e455dfe624
Author: Richard Levitte &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">levitte at openssl.org</A>&gt;
Date:   Thu Aug 13 19:38:59 2015 +0200

    Adapt the libssl test harness testing scripts to new testing framework
    
    This involves adding $TOP/util as perl library in test/run_tests.pl.
    
    Reviewed-by: Rich Salz &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">rsalz at openssl.org</A>&gt;

commit 53520ebe8757fea7d2e9ffe3d0c610dd6b9b9cc6
Author: Richard Levitte &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">levitte at openssl.org</A>&gt;
Date:   Sun Aug 9 06:52:50 2015 +0200

    Check the validity of MINFO
    
    MINFO may be an old file lying around, which might have
    00-check_testexes.t produce incorrect results.  To make sure this
    doesn't happen, check the variable VERSION in it against the same
    variable in the top Makefile.
    
    Reviewed-by: Rich Salz &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">rsalz at openssl.org</A>&gt;

commit 2511c12bf2d5f07f329d1e90cde8791817e4357e
Author: Richard Levitte &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">levitte at openssl.org</A>&gt;
Date:   Sun Aug 9 05:35:57 2015 +0200

    Better method of skipping all the tests in 00-check_testexes.t
    
    Before trying to read MINFO, we have no idea how many to test for, and
    because skip expects to get an exact number somehow, it's better to
    use 'plan skip_all'.
    
    Reviewed-by: Rich Salz &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">rsalz at openssl.org</A>&gt;

commit 8de4f3d3a63f5eb5afa4bd92043953b501d0d7eb
Author: Richard Levitte &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">levitte at openssl.org</A>&gt;
Date:   Sat Aug 8 11:45:54 2015 +0200

    Remove special x509 test conversions
    
    Following the commit from July 2 that removed netscape formated certs,
    it is no longer necessary to have conversion tests for it.
    
    Reviewed-by: Rich Salz &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">rsalz at openssl.org</A>&gt;

commit 2a74b62e3ae1b6916190ff19276ed49a9b728b8f
Author: Richard Levitte &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">levitte at openssl.org</A>&gt;
Date:   Sat Aug 8 11:33:10 2015 +0200

    Add a few missing tests
    
    test_clienthello
    test_packet
    test_verify_extra
    test_secmem
    
    Reviewed-by: Rich Salz &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">rsalz at openssl.org</A>&gt;

commit ca904707b6df0f5077f9eff94f29bd8035d042a7
Author: Richard Levitte &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">levitte at openssl.org</A>&gt;
Date:   Thu Apr 30 19:52:36 2015 +0200

    Push the line buffer filter on the out BIO on VMS
    
    VMS files are normally record oriented rather than stream oriented.
    This means that every write() will create a new record, which is seen
    as a line of its own, regardless of if there was a \n in there or not.
    bntest uses BN_print, which prints out number with more than one
    write(), thereby dividing up the numbers in several lines, which
    greatly disturbs the post-bntest checks that expect to find a full
    formula to calculate on one line.
    
    So, for VMS, we need to push the linebuffer filter on the out BIO.
    
    Reviewed-by: Rich Salz &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">rsalz at openssl.org</A>&gt;

commit 8368d46bcadf13dd2c675da8113fcc9400ae12fc
Author: Richard Levitte &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">levitte at openssl.org</A>&gt;
Date:   Thu Apr 30 19:38:47 2015 +0200

    Rework 00-test_checkexes.t for VMS
    
    Unfortunately, a file spec with character range globs interfere with
    paths on VMS, and are therefore disabled.  Rework this test to collect
    a list of expected tests and a list of all recipes and compare the two
    using grep.
    
    Reviewed-by: Rich Salz &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">rsalz at openssl.org</A>&gt;

commit f5098edb14ce7da8db814dd392358d53c2b81496
Author: Richard Levitte &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">levitte at openssl.org</A>&gt;
Date:   Thu Apr 30 14:30:15 2015 +0200

    Document OpenSSL::Test and OpenSSL::Test::Simple
    
    For OpenSSL::Test, it meant rearranging the code to better suite the
    structure of the documentation.
    
    Reviewed-by: Rich Salz &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">rsalz at openssl.org</A>&gt;

commit fd99c6b599a8ed87b726caaa6d88c6915a60e0f4
Author: Richard Levitte &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">levitte at openssl.org</A>&gt;
Date:   Thu Apr 30 08:51:24 2015 +0200

    Change OpenSSL::Test to be an extension of Test::More
    
    It became tedious as well as error prone to have all recipes use
    Test::More as well as OpenSSL::Test.  The easier way is to make
    OpenSSL::Test an extension of Test::More, thereby having all version
    checks as well as future checks firmly there.  Additionally, that
    allows us to extend existing Test::More functions if the need would
    arise.
    
    Reviewed-by: Rich Salz &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">rsalz at openssl.org</A>&gt;

commit caadc54381af04dd49d9812737d40fea320c8674
Author: Richard Levitte &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">levitte at openssl.org</A>&gt;
Date:   Wed Apr 29 21:51:25 2015 +0200

    New feature: STOPTEST
    
    When the environment variable STOPTEST is defined (with any value other
    than the empty string), the test machinery in OpenSSL::Test goes into a
    different mode that will stop all testing at the end of a failing recipe.
    
    Reviewed-by: Rich Salz &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">rsalz at openssl.org</A>&gt;

commit fb921436f3dc03daf4a7ac1fec9f1e458772e17b
Author: Richard Levitte &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">levitte at openssl.org</A>&gt;
Date:   Tue Apr 28 20:39:09 2015 +0200

    Add version numbers on some modules we use.
    
    Reviewed-by: Rich Salz &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">rsalz at openssl.org</A>&gt;

commit d6c5b66c1c9457a7f8c8f69c1ad3b4557dcd3fa2
Author: Richard Levitte &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">levitte at openssl.org</A>&gt;
Date:   Tue Apr 28 17:59:06 2015 +0200

    Have 'make clean' clean away the log files.
    
    Reviewed-by: Rich Salz &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">rsalz at openssl.org</A>&gt;

commit 204e41ed504b6deb370bdbf85fd988c03eff363b
Author: Richard Levitte &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">levitte at openssl.org</A>&gt;
Date:   Thu Apr 23 11:11:14 2015 +0200

    Tone down the requirements of a test that will go away.
    
    00-check_testexes.t was a way for me to check that I didn't forget a
    compiled test app.  The way it worked was to require MINFO to be present.
    Considering the need for this test has diminished considerably at this
    point, I might as well tone down the requirement, and have it skip the
    test (and not fail it) if MINFO isn't present.
    
    Reviewed-by: Rich Salz &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">rsalz at openssl.org</A>&gt;

commit 71a4f2832c3fe02d026af8241767ee80f440e876
Author: Richard Levitte &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">levitte at openssl.org</A>&gt;
Date:   Tue Apr 21 21:10:01 2015 +0200

    Remove old testing scripts out of the way.
    
    For now, I'm moving them into Attic/.  They will be removed later.
    
    Reviewed-by: Rich Salz &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">rsalz at openssl.org</A>&gt;

commit fd9ad2300b280c0f71d24456bfbf04579331bc94
Author: Richard Levitte &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">levitte at openssl.org</A>&gt;
Date:   Tue Apr 21 20:09:36 2015 +0200

    Adapt mk1mf.pl and helpers to the new testing framework.
    
    With the new testing framework, building a test target with mk1mf.pl
    becomes a very simple thing.  And especially, no more need to do the
    amount of hackery in unix.pl we did.
    
    Also, some tests need a working apps/CA.pl as well as rehashed certs
    in certs/demo.  So, move the code creating those files so it gets done
    regardless, not just in non-mk1mf environments.
    
    Reviewed-by: Rich Salz &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">rsalz at openssl.org</A>&gt;

commit 93de4f58ef8be2cb764343cb3102d41c81f11593
Author: Richard Levitte &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">levitte at openssl.org</A>&gt;
Date:   Tue Apr 21 19:29:01 2015 +0200

    Simplify very simple test recipes further.
    
    Very simple test recipes easily become tedious, so they might benefit
    from being made as simple as possible.  Therefore, OpenSSL::Test::Simple
    is born.  It currently provides but one function, simple_test(), which
    takes a minimum of two parameters (test name and program to run), with
    the optional third, being the algorithm to be checked for before
    running the test itself.
    
    All recipes with that simple thing to do have been rewritten to be as
    minimal as possible.
    
    Reviewed-by: Rich Salz &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">rsalz at openssl.org</A>&gt;

commit d11b43fdd30f084c19136359d0e3e4a06631abf9
Author: Richard Levitte &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">levitte at openssl.org</A>&gt;
Date:   Sun Apr 19 23:49:30 2015 +0200

    Remove test targets from Makefile, have it use run_tests.pl
    
    Also remove recipes/00-check_testalltests.t, since it will lack the
    information from the now gone alltests target.
    
    Reviewed-by: Rich Salz &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">rsalz at openssl.org</A>&gt;

commit 7dc11227a385fd7e248e1292653761ec9ce9c105
Author: Richard Levitte &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">levitte at openssl.org</A>&gt;
Date:   Sun Apr 19 22:29:46 2015 +0200

    Ignore the log files
    
    The new test framework produces a lot of log files (one for each
    test).  Git doesn't need to know.
    
    Reviewed-by: Rich Salz &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">rsalz at openssl.org</A>&gt;

commit 127d25903fc705756ac211ea373104d8e8858ae1
Author: Richard Levitte &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">levitte at openssl.org</A>&gt;
Date:   Sun Apr 19 22:26:12 2015 +0200

    Add recipes for misc other things we want to test
    
    Note that this required a change in constant_time_test.c, as it says
    &quot;ok&quot;, which interferes with what Test::Harness expects to see.  I had
    constant_time_test.c say &quot;success&quot; instead.
    
    Reviewed-by: Rich Salz &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">rsalz at openssl.org</A>&gt;

commit 88b8a5279f452027c193c2de7909dd9f7c9736c6
Author: Richard Levitte &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">levitte at openssl.org</A>&gt;
Date:   Sun Apr 19 22:24:17 2015 +0200

    Add recipes for the larger protocols
    
    This covers the certificate authority commands, the cms and smime
    commands, OCSP, SSL and TSA.
    
    Reviewed-by: Rich Salz &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">rsalz at openssl.org</A>&gt;

commit 4fb35f8fcba5b49bdf8223e1964ef4cf640ea0ca
Author: Richard Levitte &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">levitte at openssl.org</A>&gt;
Date:   Fri Apr 17 20:16:13 2015 +0200

    Add engine and evp test recipes.
    
    Reviewed-by: Rich Salz &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">rsalz at openssl.org</A>&gt;

commit 4650de3e431d123e988821215f6473e93c3d4b17
Author: Richard Levitte &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">levitte at openssl.org</A>&gt;
Date:   Fri Apr 17 20:15:22 2015 +0200

    Add recipes for tests related to certificates
    
    Some of them make use of recipes/tconversion.pl.
    
    Reviewed-by: Rich Salz &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">rsalz at openssl.org</A>&gt;

commit 0c85cc506916039bba86e8335aa71e0e44f038b0
Author: Richard Levitte &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">levitte at openssl.org</A>&gt;
Date:   Fri Apr 17 20:13:58 2015 +0200

    Add asymetric cipher test recipes
    
    Some of them make use of recipes/tconversion.pl.
    
    Reviewed-by: Rich Salz &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">rsalz at openssl.org</A>&gt;

commit 904ae3342600fe1dae3e0835a784c73b7c237106
Author: Richard Levitte &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">levitte at openssl.org</A>&gt;
Date:   Fri Apr 17 20:10:24 2015 +0200

    Add a helper script for key file format conversion tests
    
    As tests are done until now, there are a few scripts that look almost,
    but not quite the same.  tkey, tx509, tcrl, tpkcs7, treq, tsid and
    probably a few more.
    
    recipes/tconversions.pl is a helper script that generalises the
    function of each of those, and can then be used in a general manner
    from test recipes.
    
    Reviewed-by: Rich Salz &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">rsalz at openssl.org</A>&gt;

commit 13350a0c0eb8937c299c394a88d6cb51d3356d1f
Author: Richard Levitte &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">levitte at openssl.org</A>&gt;
Date:   Fri Apr 17 20:07:13 2015 +0200

    Add the encryption test recipe
    
    This tests all available openssl cipher commands.
    
    Reviewed-by: Rich Salz &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">rsalz at openssl.org</A>&gt;

commit 894025c6428e7a78fb251e7a16522c3b7351f357
Author: Richard Levitte &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">levitte at openssl.org</A>&gt;
Date:   Fri Apr 17 20:04:19 2015 +0200

    Add recipes for individual block ciphers, stream ciphers and digests
    
    These recipes all correspond to a compiled test program.
    
    Reviewed-by: Rich Salz &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">rsalz at openssl.org</A>&gt;

commit f3356b7f49823ddf31683667dfd376312b0a92a3
Author: Richard Levitte &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">levitte at openssl.org</A>&gt;
Date:   Fri Apr 17 19:57:55 2015 +0200

    Add math tests recipes
    
    The math recipes are among the heavier, but also quite important.
    For the BN test, we have previously relied on bc to verify the numbers.
    Unfortunately, bc doesn't exist everywhere, making tests on some platforms
    rather painful.  With the new recipe (recipes/10-test_bn.t), we rely
    on perl's Math::BigInt and a homegrown simple calculator (recipes/bc.pl)
    that can do enough to cover for bc.
    
    Reviewed-by: Rich Salz &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">rsalz at openssl.org</A>&gt;

commit aec27d4d5210234560deab85c97bd453535f66ae
Author: Richard Levitte &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">levitte at openssl.org</A>&gt;
Date:   Fri Apr 17 19:44:48 2015 +0200

    Groundwork for a perl based testing framework
    
    The idea with this perl based testing framework is to make use of
    what's delivered with perl and exists on all sorts of platforms.
    
    The choice came to using Test::More and Test::Harness, as that seems
    to be the most widely spread foundation, even if perl is aged.
    
    The main runner of the show is run_tests.pl.  As it currently stands,
    it's designed to run from inside Makefile, but it's absolutely
    possible to run it from the command line as well, like so:
    
    	cd test
    	OPENSSL_SRCDIR=.. perl run_tests.pl
    
    The tester scripts themselves are stored in the subdirectory recipes/,
    and initially, we have two such scripts, recipes/00-check_testalltests.t
    and recipes/00-check_testexes.t.  recipes/00-check_testalltests.t will
    pick out the dependencies of &quot;alltests&quot; in test/Makefile, and check if
    it can find recipes with corresponding names.  recipes/00-check_testexes.t
    does something similar, but bases it on existing compiled test binaries.
    They make it easy to figure out what's to be added, and will be
    removed when this effort is finished.
    
    Individual recipes can be run as well, of course, as they are perl
    scripts in themselves.  For example, you can run only
    recipes/00-check_testexes.t like so:
    
    	cd test
    	OPENSSL_SRCDIR=.. perl recipes/00-check_testexes.t
    
    To make coding easier, there's a routine library OpenSSL::Test, which
    is reachable in a perl script like so:
    
    	use lib 'testlib';
    	use OpenSSL::Test;
    
    Reviewed-by: Rich Salz &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">rsalz at openssl.org</A>&gt;

-----------------------------------------------------------------------

Summary of changes:
 .gitignore                                         |   1 +
 CHANGES                                            |  15 +
 Configure                                          |  18 +-
 test/{ =&gt; Attic}/VMSca-response.1                  |   0
 test/{ =&gt; Attic}/VMSca-response.2                  |   0
 test/{ =&gt; Attic}/bctest                            |   0
 test/{ =&gt; Attic}/bctest.com                        |   0
 test/{ =&gt; Attic}/bntest.com                        |   0
 test/{ =&gt; Attic}/cms-test.pl                       |   0
 test/{ =&gt; Attic}/tcrl                              |   0
 test/{ =&gt; Attic}/tcrl.com                          |   0
 test/{ =&gt; Attic}/testca                            |   0
 test/{ =&gt; Attic}/testca.com                        |   0
 test/{ =&gt; Attic}/testenc                           |   0
 test/{ =&gt; Attic}/testenc.com                       |   0
 test/{ =&gt; Attic}/testgen                           |   0
 test/{ =&gt; Attic}/testgen.com                       |   0
 test/{ =&gt; Attic}/testss                            |   0
 test/{ =&gt; Attic}/testss.com                        |   0
 test/{ =&gt; Attic}/testssl                           |   0
 test/{ =&gt; Attic}/testssl.com                       |   0
 test/{ =&gt; Attic}/testsslproxy                      |   0
 test/{ =&gt; Attic}/testtsa                           |   0
 test/{ =&gt; Attic}/testtsa.com                       |   0
 test/{ =&gt; Attic}/tkey                              |   0
 test/{ =&gt; Attic}/tocsp                             |   0
 test/{ =&gt; Attic}/tocsp.com                         |   0
 test/{ =&gt; Attic}/tpkcs7                            |   0
 test/{ =&gt; Attic}/tpkcs7.com                        |   0
 test/{ =&gt; Attic}/tpkcs7d                           |   0
 test/{ =&gt; Attic}/tpkcs7d.com                       |   0
 test/{ =&gt; Attic}/treq                              |   0
 test/{ =&gt; Attic}/treq.com                          |   0
 test/{ =&gt; Attic}/trsa.com                          |   0
 test/{ =&gt; Attic}/tsid                              |   0
 test/{ =&gt; Attic}/tsid.com                          |   0
 test/{ =&gt; Attic}/tverify.com                       |   0
 test/{ =&gt; Attic}/tx509                             |   0
 test/{ =&gt; Attic}/tx509.com                         |   0
 test/Makefile                                      | 321 +--------
 test/README                                        | 107 +++
 test/bntest.c                                      |   6 +
 test/constant_time_test.c                          |   2 +-
 test/recipes/00-check_testexes.t                   |  59 ++
 test/recipes/05-test_bf.t                          |   5 +
 test/recipes/05-test_cast.t                        |   5 +
 test/recipes/05-test_des.t                         |   5 +
 test/recipes/05-test_hmac.t                        |   5 +
 test/recipes/05-test_idea.t                        |   5 +
 test/recipes/05-test_md2.t                         |   5 +
 test/recipes/05-test_md4.t                         |   5 +
 test/recipes/05-test_md5.t                         |   5 +
 test/recipes/05-test_mdc2.t                        |   5 +
 test/recipes/05-test_rand.t                        |   5 +
 test/recipes/05-test_rc2.t                         |   5 +
 test/recipes/05-test_rc4.t                         |   5 +
 test/recipes/05-test_rc5.t                         |   5 +
 test/recipes/05-test_rmd.t                         |   5 +
 test/recipes/05-test_sha1.t                        |   5 +
 test/recipes/05-test_sha256.t                      |   5 +
 test/recipes/05-test_sha512.t                      |   5 +
 test/recipes/05-test_wp.t                          |   5 +
 test/recipes/10-test_bn.t                          |  75 +++
 test/recipes/10-test_exp.t                         |   5 +
 test/recipes/15-test_dh.t                          |   5 +
 test/recipes/15-test_dsa.t                         |  32 +
 test/recipes/15-test_ec.t                          |  30 +
 test/recipes/15-test_ecdh.t                        |   5 +
 test/recipes/15-test_ecdsa.t                       |   5 +
 test/recipes/15-test_rsa.t                         |  31 +
 test/recipes/20-test_enc.t                         |  64 ++
 test/recipes/25-test_crl.t                         |  17 +
 test/recipes/25-test_gen.t                         |  43 ++
 test/recipes/25-test_pkcs7.t                       |  20 +
 test/recipes/25-test_req.t                         |  43 ++
 test/recipes/25-test_sid.t                         |  17 +
 test/recipes/25-test_verify.t                      |  15 +
 test/recipes/25-test_x509.t                        |  23 +
 test/recipes/30-test_engine.t                      |  11 +
 test/recipes/30-test_evp.t                         |  12 +
 test/recipes/30-test_evp_extra.t                   |  11 +
 test/recipes/30-test_pbelu.t                       |   5 +
 test/recipes/70-test_clienthello.t                 |   5 +
 test/recipes/70-test_packet.t                      |   5 +
 .../70-test_sslextension.t}                        |  20 +-
 .../70-test_sslsessiontick.t}                      |  91 +--
 .../70-test_sslskewith0p.t}                        |  20 +-
 .../70-test_sslvertol.t}                           |  22 +-
 test/recipes/70-test_verify_extra.t                |   5 +
 test/recipes/80-test_ca.t                          |  54 ++
 test/recipes/80-test_cms.t                         | 476 +++++++++++++
 test/recipes/80-test_ocsp.t                        | 193 ++++++
 test/recipes/80-test_ssl.t                         | 627 +++++++++++++++++
 test/recipes/80-test_tsa.t                         | 192 ++++++
 test/recipes/90-test_constant_time.t               |   5 +
 test/recipes/90-test_gmdiff.t                      |   5 +
 test/recipes/90-test_gost2814789.t                 |  13 +
 test/recipes/90-test_heartbeat.t                   |   5 +
 test/recipes/90-test_ige.t                         |   5 +
 test/recipes/90-test_jpake.t                       |   5 +
 test/recipes/90-test_np.t                          |   5 +
 test/recipes/90-test_p5_crpt2.t                    |   5 +
 test/recipes/90-test_secmem.t                      |   5 +
 test/recipes/90-test_srp.t                         |   5 +
 test/recipes/90-test_v3name.t                      |   5 +
 test/recipes/bc.pl                                 |  97 +++
 test/recipes/tconversion.pl                        |  88 +++
 test/run_tests.pl                                  |  45 ++
 test/testlib/OpenSSL/Test.pm                       | 741 +++++++++++++++++++++
 test/testlib/OpenSSL/Test/Simple.pm                |  78 +++
 util/mk1mf.pl                                      |  17 +-
 util/pl/BC-32.pl                                   |  23 +
 util/pl/VC-32.pl                                   |  23 +
 util/pl/unix.pl                                    | 279 +-------
 114 files changed, 3606 insertions(+), 646 deletions(-)
 rename test/{ =&gt; Attic}/VMSca-response.1 (100%)
 rename test/{ =&gt; Attic}/VMSca-response.2 (100%)
 rename test/{ =&gt; Attic}/bctest (100%)
 rename test/{ =&gt; Attic}/bctest.com (100%)
 rename test/{ =&gt; Attic}/bntest.com (100%)
 rename test/{ =&gt; Attic}/cms-test.pl (100%)
 rename test/{ =&gt; Attic}/tcrl (100%)
 rename test/{ =&gt; Attic}/tcrl.com (100%)
 rename test/{ =&gt; Attic}/testca (100%)
 rename test/{ =&gt; Attic}/testca.com (100%)
 rename test/{ =&gt; Attic}/testenc (100%)
 rename test/{ =&gt; Attic}/testenc.com (100%)
 rename test/{ =&gt; Attic}/testgen (100%)
 rename test/{ =&gt; Attic}/testgen.com (100%)
 rename test/{ =&gt; Attic}/testss (100%)
 rename test/{ =&gt; Attic}/testss.com (100%)
 rename test/{ =&gt; Attic}/testssl (100%)
 rename test/{ =&gt; Attic}/testssl.com (100%)
 rename test/{ =&gt; Attic}/testsslproxy (100%)
 rename test/{ =&gt; Attic}/testtsa (100%)
 rename test/{ =&gt; Attic}/testtsa.com (100%)
 rename test/{ =&gt; Attic}/tkey (100%)
 rename test/{ =&gt; Attic}/tocsp (100%)
 rename test/{ =&gt; Attic}/tocsp.com (100%)
 rename test/{ =&gt; Attic}/tpkcs7 (100%)
 rename test/{ =&gt; Attic}/tpkcs7.com (100%)
 rename test/{ =&gt; Attic}/tpkcs7d (100%)
 rename test/{ =&gt; Attic}/tpkcs7d.com (100%)
 rename test/{ =&gt; Attic}/treq (100%)
 rename test/{ =&gt; Attic}/treq.com (100%)
 rename test/{ =&gt; Attic}/trsa.com (100%)
 rename test/{ =&gt; Attic}/tsid (100%)
 rename test/{ =&gt; Attic}/tsid.com (100%)
 rename test/{ =&gt; Attic}/tverify.com (100%)
 rename test/{ =&gt; Attic}/tx509 (100%)
 rename test/{ =&gt; Attic}/tx509.com (100%)
 create mode 100644 test/README
 create mode 100644 test/recipes/00-check_testexes.t
 create mode 100644 test/recipes/05-test_bf.t
 create mode 100644 test/recipes/05-test_cast.t
 create mode 100644 test/recipes/05-test_des.t
 create mode 100644 test/recipes/05-test_hmac.t
 create mode 100644 test/recipes/05-test_idea.t
 create mode 100644 test/recipes/05-test_md2.t
 create mode 100644 test/recipes/05-test_md4.t
 create mode 100644 test/recipes/05-test_md5.t
 create mode 100644 test/recipes/05-test_mdc2.t
 create mode 100644 test/recipes/05-test_rand.t
 create mode 100644 test/recipes/05-test_rc2.t
 create mode 100644 test/recipes/05-test_rc4.t
 create mode 100644 test/recipes/05-test_rc5.t
 create mode 100644 test/recipes/05-test_rmd.t
 create mode 100644 test/recipes/05-test_sha1.t
 create mode 100644 test/recipes/05-test_sha256.t
 create mode 100644 test/recipes/05-test_sha512.t
 create mode 100644 test/recipes/05-test_wp.t
 create mode 100644 test/recipes/10-test_bn.t
 create mode 100644 test/recipes/10-test_exp.t
 create mode 100644 test/recipes/15-test_dh.t
 create mode 100644 test/recipes/15-test_dsa.t
 create mode 100644 test/recipes/15-test_ec.t
 create mode 100644 test/recipes/15-test_ecdh.t
 create mode 100644 test/recipes/15-test_ecdsa.t
 create mode 100644 test/recipes/15-test_rsa.t
 create mode 100644 test/recipes/20-test_enc.t
 create mode 100644 test/recipes/25-test_crl.t
 create mode 100644 test/recipes/25-test_gen.t
 create mode 100644 test/recipes/25-test_pkcs7.t
 create mode 100644 test/recipes/25-test_req.t
 create mode 100644 test/recipes/25-test_sid.t
 create mode 100644 test/recipes/25-test_verify.t
 create mode 100644 test/recipes/25-test_x509.t
 create mode 100644 test/recipes/30-test_engine.t
 create mode 100644 test/recipes/30-test_evp.t
 create mode 100644 test/recipes/30-test_evp_extra.t
 create mode 100644 test/recipes/30-test_pbelu.t
 create mode 100644 test/recipes/70-test_clienthello.t
 create mode 100644 test/recipes/70-test_packet.t
 rename test/{sslextensiontest.pl =&gt; recipes/70-test_sslextension.t} (85%)
 rename test/{sslsessionticktest.pl =&gt; recipes/70-test_sslsessiontick.t} (75%)
 rename test/{sslskewith0ptest.pl =&gt; recipes/70-test_sslskewith0p.t} (85%)
 rename test/{sslvertoltest.pl =&gt; recipes/70-test_sslvertol.t} (84%)
 create mode 100644 test/recipes/70-test_verify_extra.t
 create mode 100644 test/recipes/80-test_ca.t
 create mode 100644 test/recipes/80-test_cms.t
 create mode 100644 test/recipes/80-test_ocsp.t
 create mode 100644 test/recipes/80-test_ssl.t
 create mode 100644 test/recipes/80-test_tsa.t
 create mode 100644 test/recipes/90-test_constant_time.t
 create mode 100644 test/recipes/90-test_gmdiff.t
 create mode 100644 test/recipes/90-test_gost2814789.t
 create mode 100644 test/recipes/90-test_heartbeat.t
 create mode 100644 test/recipes/90-test_ige.t
 create mode 100644 test/recipes/90-test_jpake.t
 create mode 100644 test/recipes/90-test_np.t
 create mode 100644 test/recipes/90-test_p5_crpt2.t
 create mode 100644 test/recipes/90-test_secmem.t
 create mode 100644 test/recipes/90-test_srp.t
 create mode 100644 test/recipes/90-test_v3name.t
 create mode 100644 test/recipes/bc.pl
 create mode 100644 test/recipes/tconversion.pl
 create mode 100644 test/run_tests.pl
 create mode 100644 test/testlib/OpenSSL/Test.pm
 create mode 100644 test/testlib/OpenSSL/Test/Simple.pm

diff --git a/.gitignore b/.gitignore
index 3292837..92f17c6 100644
--- a/.gitignore
+++ b/.gitignore
@@ -27,6 +27,7 @@
 /test/.rnd
 /test/test*.pem
 /test/newkey.pem
+/test/*.log
 
 # Certificate symbolic links
 *.0
diff --git a/CHANGES b/CHANGES
index 384abf8..a7dab6c 100644
--- a/CHANGES
+++ b/CHANGES
@@ -4,6 +4,21 @@
 
  Changes between 1.0.2 and 1.1.0  [xx XXX xxxx]
 
+  *) New testing framework
+     The testing framework has been largely rewritten and is now using
+     perl and the perl modules Test::Harness and an extended variant of
+     Test::More called OpenSSL::Test to do its work.  All test scripts in
+     test/ have been rewritten into test recipes, and all direct calls to
+     executables in test/Makefile have become individual recipes using the
+     simplified testing OpenSSL::Test::Simple.
+
+     For documentation on our testing modules, do:
+
+        perldoc test/testlib/OpenSSL/Test/Simple.pm
+        perldoc test/testlib/OpenSSL/Test.pm
+
+     [Richard Levitte]
+
   *) In DSA_generate_parameters_ex, if the provided seed is too short,
      return an error
      [Rich Salz and Ismo Puustinen &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">ismo.puustinen at intel.com</A>&gt;]
diff --git a/Configure b/Configure
index f6007c1..2fc1e59 100755
--- a/Configure
+++ b/Configure
@@ -1983,6 +1983,16 @@ print &quot;RC2 uses u$type[$rc2_int]\n&quot; if $rc2_int != $def_int;
 print &quot;BF_PTR used\n&quot; if $bf_ptr == 1;
 print &quot;BF_PTR2 used\n&quot; if $bf_ptr == 2;
 
+{
+    my $perlguess = $perl =~ m@^/@ ? $perl : '/usr/local/bin/perl';
+
+    &amp;dofile(&quot;tools/c_rehash&quot;,$perlguess,
+	    '^#!/'		=&gt; '#!%s',
+	    '^my \$dir;$'	=&gt; 'my $dir = &quot;' . $openssldir . '&quot;;',
+	    '^my \$prefix;$'	=&gt; 'my $prefix = &quot;' . $prefix . '&quot;;');
+    &amp;dofile(&quot;apps/CA.pl&quot;,$perl,
+	    '^#!/'		=&gt; '#!%s');
+}
 if($IsMK1MF) {
 	open (OUT,&quot;&gt;crypto/buildinf.h&quot;) || die &quot;Can't open buildinf.h&quot;;
 	printf OUT &lt;&lt;EOF;
@@ -2001,14 +2011,6 @@ EOF
 	$make_targets .= &quot; depend&quot; if $depflags ne $default_depflags &amp;&amp; $make_depend;
 	(system $make_command.$make_targets) == 0 or die &quot;make $make_targets failed&quot;
 		if $make_targets ne &quot;&quot;;
-	if ( $perl =~ m@^/@) {
-	    &amp;dofile(&quot;tools/c_rehash&quot;,$perl,'^#!/', '#!%s','^my \$dir;$', 'my $dir = &quot;' . $openssldir . '&quot;;', '^my \$prefix;$', 'my $prefix = &quot;' . $prefix . '&quot;;');
-	    &amp;dofile(&quot;apps/CA.pl&quot;,$perl,'^#!/', '#!%s');
-	} else {
-	    # No path for Perl known ...
-	    &amp;dofile(&quot;tools/c_rehash&quot;,'/usr/local/bin/perl','^#!/', '#!%s','^my \$dir;$', 'my $dir = &quot;' . $openssldir . '&quot;;',  '^my \$prefix;$', 'my $prefix = &quot;' . $prefix . '&quot;;');
-	    &amp;dofile(&quot;apps/CA.pl&quot;,'/usr/local/bin/perl','^#!/', '#!%s');
-	}
 	if ($depflags ne $default_depflags &amp;&amp; !$make_depend) {
 		print &lt;&lt;EOF;
 
diff --git a/test/VMSca-response.1 b/test/Attic/VMSca-response.1
similarity index 100%
rename from test/VMSca-response.1
rename to test/Attic/VMSca-response.1
diff --git a/test/VMSca-response.2 b/test/Attic/VMSca-response.2
similarity index 100%
rename from test/VMSca-response.2
rename to test/Attic/VMSca-response.2
diff --git a/test/bctest b/test/Attic/bctest
similarity index 100%
rename from test/bctest
rename to test/Attic/bctest
diff --git a/test/bctest.com b/test/Attic/bctest.com
similarity index 100%
rename from test/bctest.com
rename to test/Attic/bctest.com
diff --git a/test/bntest.com b/test/Attic/bntest.com
similarity index 100%
rename from test/bntest.com
rename to test/Attic/bntest.com
diff --git a/test/cms-test.pl b/test/Attic/cms-test.pl
similarity index 100%
rename from test/cms-test.pl
rename to test/Attic/cms-test.pl
diff --git a/test/tcrl b/test/Attic/tcrl
similarity index 100%
rename from test/tcrl
rename to test/Attic/tcrl
diff --git a/test/tcrl.com b/test/Attic/tcrl.com
similarity index 100%
rename from test/tcrl.com
rename to test/Attic/tcrl.com
diff --git a/test/testca b/test/Attic/testca
similarity index 100%
rename from test/testca
rename to test/Attic/testca
diff --git a/test/testca.com b/test/Attic/testca.com
similarity index 100%
rename from test/testca.com
rename to test/Attic/testca.com
diff --git a/test/testenc b/test/Attic/testenc
similarity index 100%
rename from test/testenc
rename to test/Attic/testenc
diff --git a/test/testenc.com b/test/Attic/testenc.com
similarity index 100%
rename from test/testenc.com
rename to test/Attic/testenc.com
diff --git a/test/testgen b/test/Attic/testgen
similarity index 100%
rename from test/testgen
rename to test/Attic/testgen
diff --git a/test/testgen.com b/test/Attic/testgen.com
similarity index 100%
rename from test/testgen.com
rename to test/Attic/testgen.com
diff --git a/test/testss b/test/Attic/testss
similarity index 100%
rename from test/testss
rename to test/Attic/testss
diff --git a/test/testss.com b/test/Attic/testss.com
similarity index 100%
rename from test/testss.com
rename to test/Attic/testss.com
diff --git a/test/testssl b/test/Attic/testssl
similarity index 100%
rename from test/testssl
rename to test/Attic/testssl
diff --git a/test/testssl.com b/test/Attic/testssl.com
similarity index 100%
rename from test/testssl.com
rename to test/Attic/testssl.com
diff --git a/test/testsslproxy b/test/Attic/testsslproxy
similarity index 100%
rename from test/testsslproxy
rename to test/Attic/testsslproxy
diff --git a/test/testtsa b/test/Attic/testtsa
similarity index 100%
rename from test/testtsa
rename to test/Attic/testtsa
diff --git a/test/testtsa.com b/test/Attic/testtsa.com
similarity index 100%
rename from test/testtsa.com
rename to test/Attic/testtsa.com
diff --git a/test/tkey b/test/Attic/tkey
similarity index 100%
rename from test/tkey
rename to test/Attic/tkey
diff --git a/test/tocsp b/test/Attic/tocsp
similarity index 100%
rename from test/tocsp
rename to test/Attic/tocsp
diff --git a/test/tocsp.com b/test/Attic/tocsp.com
similarity index 100%
rename from test/tocsp.com
rename to test/Attic/tocsp.com
diff --git a/test/tpkcs7 b/test/Attic/tpkcs7
similarity index 100%
rename from test/tpkcs7
rename to test/Attic/tpkcs7
diff --git a/test/tpkcs7.com b/test/Attic/tpkcs7.com
similarity index 100%
rename from test/tpkcs7.com
rename to test/Attic/tpkcs7.com
diff --git a/test/tpkcs7d b/test/Attic/tpkcs7d
similarity index 100%
rename from test/tpkcs7d
rename to test/Attic/tpkcs7d
diff --git a/test/tpkcs7d.com b/test/Attic/tpkcs7d.com
similarity index 100%
rename from test/tpkcs7d.com
rename to test/Attic/tpkcs7d.com
diff --git a/test/treq b/test/Attic/treq
similarity index 100%
rename from test/treq
rename to test/Attic/treq
diff --git a/test/treq.com b/test/Attic/treq.com
similarity index 100%
rename from test/treq.com
rename to test/Attic/treq.com
diff --git a/test/trsa.com b/test/Attic/trsa.com
similarity index 100%
rename from test/trsa.com
rename to test/Attic/trsa.com
diff --git a/test/tsid b/test/Attic/tsid
similarity index 100%
rename from test/tsid
rename to test/Attic/tsid
diff --git a/test/tsid.com b/test/Attic/tsid.com
similarity index 100%
rename from test/tsid.com
rename to test/Attic/tsid.com
diff --git a/test/tverify.com b/test/Attic/tverify.com
similarity index 100%
rename from test/tverify.com
rename to test/Attic/tverify.com
diff --git a/test/tx509 b/test/Attic/tx509
similarity index 100%
rename from test/tx509
rename to test/Attic/tx509
diff --git a/test/tx509.com b/test/Attic/tx509.com
similarity index 100%
rename from test/tx509.com
rename to test/Attic/tx509.com
diff --git a/test/Makefile b/test/Makefile
index 0900a92..9ead38e 100644
--- a/test/Makefile
+++ b/test/Makefile
@@ -74,10 +74,10 @@ CONSTTIMETEST=  constant_time_test
 VERIFYEXTRATEST=	verify_extra_test
 CLIENTHELLOTEST=	clienthellotest
 PACKETTEST=	packettest
-SSLVERTOLTEST=	sslvertoltest.pl
-SSLEXTENSIONTEST=	sslextensiontest.pl
-SSLSESSIONTICKTEST= 	sslsessionticktest.pl
-SSLSKEWITH0PTEST=	sslskewith0ptest.pl
+SSLVERTOLTEST=	sslvertoltest
+SSLEXTENSIONTEST=	sslextensiontest
+SSLSESSIONTICKTEST= 	sslsessionticktest
+SSLSKEWITH0PTEST=	sslskewith0ptest
 
 TESTS=		alltests
 
@@ -151,319 +151,12 @@ errors:
 tags:
 	ctags $(SRC)
 
-tests:	exe apps $(TESTS)
+tests:	exe apps
+	TOP=$(TOP) PERL=$(PERL) $(PERL) run_tests.pl $(TESTS)
 
 apps:
 	@(cd ..; $(MAKE) DIRS=apps all)
 
-alltests: \
-	test_np \
-	test_des test_gmdiff test_idea test_sha test_md4 test_md5 test_hmac \
-	test_pbelu test_md2 test_mdc2 test_wp \
-	test_rmd test_rc2 test_rc4 test_rc5 test_bf test_cast \
-	test_rand test_bn test_ec test_ecdsa test_ecdh \
-	test_enc test_x509 test_rsa test_crl test_sid \
-	test_gen test_req test_pkcs7 test_verify test_dh test_dsa \
-	test_ss test_ca test_engine test_evp test_evp_extra test_ssl test_tsa \
-	test_ige test_jpake test_secmem \
-	test_srp test_cms test_v3name test_ocsp \
-	test_gost2814789 test_heartbeat test_p5_crpt2 \
-	test_constant_time test_verify_extra test_clienthello test_packet \
-	test_sslvertol test_sslextension test_sslsessionticket test_sslskewith0p
-
-test_np: $(NPTEST)$(EXE_EXT)
-	@echo $(START) $@
-	../util/shlib_wrap.sh ./$(NPTEST)
-
-test_evp: $(EVPTEST)$(EXE_EXT) evptests.txt
-	@echo $(START) $@
-	../util/shlib_wrap.sh ./$(EVPTEST) evptests.txt
-
-test_evp_extra: $(EVPEXTRATEST)$(EXE_EXT)
-	@echo $(START) $@
-	../util/shlib_wrap.sh ./$(EVPEXTRATEST)
-
-test_p5_crpt2: $(P5_CRPT2_TEST)$(EXE_EXT)
-	@echo $(START) $@
-	../util/shlib_wrap.sh ./$(P5_CRPT2_TEST)
-
-test_des: $(DESTEST)$(EXE_EXT)
-	@echo $(START) $@
-	../util/shlib_wrap.sh ./$(DESTEST)
-
-test_gmdiff: $(GMDIFFTEST)$(EXE_EXT)
-	@echo $(START) $@
-	../util/shlib_wrap.sh ./$(GMDIFFTEST)
-
-test_pbelu: $(PBELUTEST)$(EXE_EXT)
-	@echo $(START) $@
-	../util/shlib_wrap.sh ./$(PBELUTEST)
-
-test_idea: $(IDEATEST)$(EXE_EXT)
-	@echo $(START) $@
-	../util/shlib_wrap.sh ./$(IDEATEST)
-
-test_sha: $(SHA1TEST)$(EXE_EXT) $(SHA256TEST)$(EXE_EXT) $(SHA512TEST)$(EXE_EXT)
-	@echo $(START) $@ -- sha1
-	../util/shlib_wrap.sh ./$(SHA1TEST)
-	@echo $(START) $@ -- sha256
-	../util/shlib_wrap.sh ./$(SHA256TEST)
-	@echo $(START) $@ -- sha512
-	../util/shlib_wrap.sh ./$(SHA512TEST)
-
-test_mdc2: $(MDC2TEST)$(EXE_EXT)
-	@echo $(START) $@
-	../util/shlib_wrap.sh ./$(MDC2TEST)
-
-test_md5: $(MD5TEST)$(EXE_EXT)
-	@echo $(START) $@
-	../util/shlib_wrap.sh ./$(MD5TEST)
-
-test_md4: $(MD4TEST)$(EXE_EXT)
-	@echo $(START) $@
-	../util/shlib_wrap.sh ./$(MD4TEST)
-
-test_hmac: $(HMACTEST)$(EXE_EXT)
-	@echo $(START) $@
-	../util/shlib_wrap.sh ./$(HMACTEST)
-
-test_wp: $(WPTEST)$(EXE_EXT)
-	@echo $(START) $@
-	../util/shlib_wrap.sh ./$(WPTEST)
-
-test_md2: $(MD2TEST)$(EXE_EXT)
-	@echo $(START) $@
-	../util/shlib_wrap.sh ./$(MD2TEST)
-
-test_rmd: $(RMDTEST)$(EXE_EXT)
-	@echo $(START) $@
-	../util/shlib_wrap.sh ./$(RMDTEST)
-
-test_bf: $(BFTEST)$(EXE_EXT)
-	@echo $(START) $@
-	../util/shlib_wrap.sh ./$(BFTEST)
-
-test_cast: $(CASTTEST)$(EXE_EXT)
-	@echo $(START) $@
-	../util/shlib_wrap.sh ./$(CASTTEST)
-
-test_rc2: $(RC2TEST)$(EXE_EXT)
-	@echo $(START) $@
-	../util/shlib_wrap.sh ./$(RC2TEST)
-
-test_rc4: $(RC4TEST)$(EXE_EXT)
-	@echo $(START) $@
-	../util/shlib_wrap.sh ./$(RC4TEST)
-
-test_rc5: $(RC5TEST)$(EXE_EXT)
-	@echo $(START) $@
-	../util/shlib_wrap.sh ./$(RC5TEST)
-
-test_rand: $(RANDTEST)$(EXE_EXT)
-	@echo $(START) $@
-	../util/shlib_wrap.sh ./$(RANDTEST)
-
-test_gost2814789: $(GOST2814789TEST)$(EXE_EXT)
-	@echo $(START) $@
-	OPENSSL_ENGINES=../engines/ccgost ../util/shlib_wrap.sh ./$(GOST2814789TEST)
-
-test_enc: ../apps/openssl$(EXE_EXT) testenc
-	@echo $(START) $@
-	@sh ./testenc
-
-test_x509: ../apps/openssl$(EXE_EXT) tx509 testx509.pem v3-cert1.pem v3-cert2.pem
-	@echo $(START) $@ -- x509v1 certificate
-	sh ./tx509
-	@echo $(START) $@ -- first x509v3 certificate
-	sh ./tx509 v3-cert1.pem
-	@echo $(START) $@ -- second x509v3 certificate
-	sh ./tx509 v3-cert2.pem
-
-test_rsa: $(RSATEST)$(EXE_EXT) ../apps/openssl$(EXE_EXT) tkey testrsa.pem testrsapub.pem
-	@echo $(START) $@
-	../util/shlib_wrap.sh ./$(RSATEST)
-	@echo $(START) $@ -- private key
-	@sh ./tkey testrsa.pem rsa private
-	@echo $(START) $@ -- public public
-	@sh ./tkey testrsapub.pem rsa public
-
-test_crl: ../apps/openssl$(EXE_EXT) tcrl testcrl.pem
-	@echo $(START) $@
-	sh ./tcrl
-
-test_sid: ../apps/openssl$(EXE_EXT) tsid testsid.pem
-	@echo $(START) $@
-	@sh ./tsid
-
-test_req: ../apps/openssl$(EXE_EXT) treq testreq.pem testreq2.pem
-	@echo $(START) $@
-	@sh ./treq
-	@echo $(START) $@ -- testreq2
-	@sh ./treq testreq2.pem
-
-test_pkcs7: ../apps/openssl$(EXE_EXT) tpkcs7 tpkcs7d testp7.pem pkcs7-1.pem
-	@echo $(START) $@ -- pkcs7
-	@sh ./tpkcs7
-	@echo $(START) $@ -- pkcs7d
-	@sh ./tpkcs7d
-
-test_bn: $(BNTEST)$(EXE_EXT) $(EXPTEST)$(EXE_EXT) bctest
-	@echo $(START) $@ -- could take  a while.
-	@../util/shlib_wrap.sh ./$(BNTEST) &gt;tmp.bntest
-	@echo quit &gt;&gt;tmp.bntest
-	@echo $(START) $@ -- running bc
-	@&lt;tmp.bntest sh -c &quot;`sh ./bctest ignore`&quot; | $(PERL) -e '$$i=0; while (&lt;STDIN&gt;) {if (/^test (.*)/) {print STDERR &quot;\nverify $$1&quot;;} elsif (!/^0\r?$$/) {die &quot;\nFailed! bc: $$_&quot;;} else {print STDERR &quot;.&quot;; $$i++;}} print STDERR &quot;\n$$i tests passed\n&quot;'
-	@echo $(START) $@ -- $(EXPTEST)
-	../util/shlib_wrap.sh ./$(EXPTEST)
-
-test_ec: $(ECTEST)$(EXE_EXT) tkey testec-p256.pem testecpub-p256.pem
-	@echo $(START) $@
-	../util/shlib_wrap.sh ./$(ECTEST)
-	@echo $(START) $@ -- private
-	@sh ./tkey testec-p256.pem ec private
-	@echo $(START) $@ -- public
-	@sh ./tkey testecpub-p256.pem ec public
-
-test_ecdsa: $(ECDSATEST)$(EXE_EXT)
-	@echo $(START) $@
-	../util/shlib_wrap.sh ./$(ECDSATEST)
-
-test_ecdh: $(ECDHTEST)$(EXE_EXT)
-	@echo $(START) $@
-	../util/shlib_wrap.sh ./$(ECDHTEST)
-
-test_verify: ../apps/openssl$(EXE_EXT)
-	@echo $(START) $@ -- expect some failures and expired certificates
-	../util/shlib_wrap.sh ../apps/openssl verify -CApath ../certs/demo ../certs/demo/*.pem
-
-test_dh: $(DHTEST)$(EXE_EXT)
-	@echo $(START) $@
-	../util/shlib_wrap.sh ./$(DHTEST)
-
-test_dsa: $(DSATEST)$(EXE_EXT) tkey testdsa.pem testdsapub.pem
-	@echo $(START) $@
-	../util/shlib_wrap.sh ./$(DSATEST)
-	@echo $(START) $@ -- app2_1
-	../util/shlib_wrap.sh ./$(DSATEST) -app2_1
-	@echo $(START) $@ -- private
-	@sh ./tkey testdsa.pem dsa private
-	@echo $(START) $@ -- public
-	@sh ./tkey testdsapub.pem dsa public
-
-test_gen testreq.pem: ../apps/openssl$(EXE_EXT) testgen test.cnf
-	@echo $(START) test_gen
-	@sh ./testgen
-
-test_ss keyU.ss certU.ss certCA.ss certP1.ss keyP1.ss certP2.ss keyP2.ss \
-		intP1.ss intP2.ss: testss CAss.cnf Uss.cnf P1ss.cnf P2ss.cnf \
-                                   ../apps/openssl$(EXE_EXT)
-	@echo $(START) test_ss
-	@sh ./testss
-	@cat certCA.ss certU.ss &gt; intP1.ss
-	@cat certCA.ss certU.ss certP1.ss &gt; intP2.ss
-
-test_engine: $(ENGINETEST)$(EXE_EXT)
-	@echo $(START) $@
-	../util/shlib_wrap.sh ./$(ENGINETEST)
-
-test_ssl: keyU.ss certU.ss certCA.ss certP1.ss keyP1.ss certP2.ss keyP2.ss \
-		intP1.ss intP2.ss $(SSLTEST)$(EXE_EXT) testssl testsslproxy \
-		../apps/server2.pem serverinfo.pem
-	@echo $(START) $@
-	../util/shlib_wrap.sh ./$(SSLTEST) -test_cipherlist
-	@echo $(START) $@ -- key U
-	@sh ./testssl keyU.ss certU.ss certCA.ss
-	@echo $(START) $@ -- key P1
-	@sh ./testsslproxy keyP1.ss certP1.ss intP1.ss
-	@echo $(START) $@ -- key P2
-	@sh ./testsslproxy keyP2.ss certP2.ss intP2.ss
-
-test_ca: ../apps/openssl$(EXE_EXT) testca CAss.cnf Uss.cnf
-	@if ../util/shlib_wrap.sh ../apps/openssl no-rsa; then \
-	  echo SKIP $@ -- requires RSA; \
-	else \
-	  echo $(START) $@; \
-	  sh ./testca $(PERL); \
-	fi
-
-test_tsa: ../apps/openssl$(EXE_EXT) testtsa CAtsa.cnf ../util/shlib_wrap.sh
-	@if ../util/shlib_wrap.sh ../apps/openssl no-rsa; then \
-	    echo SKIP $@ -- requires RSA; \
-	else \
-	  echo $(START) $@; \
-	  sh ./testtsa; \
-	fi
-
-test_ige: $(IGETEST)$(EXE_EXT)
-	@echo $(START) $@
-	../util/shlib_wrap.sh ./$(IGETEST)
-
-test_jpake: $(JPAKETEST)$(EXE_EXT)
-	@echo $(START) $@
-	../util/shlib_wrap.sh ./$(JPAKETEST)
-
-test_cms: ../apps/openssl$(EXE_EXT) cms-test.pl smcont.txt
-	@echo $(START) $@
-	$(PERL) cms-test.pl
-
-test_secmem: $(SECMEMTEST)$(EXE_EXT)
-	@echo $(START) $@
-	../util/shlib_wrap.sh ./secmemtest
-
-test_srp: $(SRPTEST)$(EXE_EXT)
-	@echo $(START) $@
-	../util/shlib_wrap.sh ./srptest
-
-test_v3name: $(V3NAMETEST)$(EXE_EXT)
-	@echo $(START) $@
-	../util/shlib_wrap.sh ./$(V3NAMETEST)
-
-test_ocsp: ../apps/openssl$(EXE_EXT) tocsp
-	@echo $(START) $@
-	@sh ./tocsp
-
-test_heartbeat: $(HEARTBEATTEST)$(EXE_EXT)
-	@echo $(START) $@
-	../util/shlib_wrap.sh ./$(HEARTBEATTEST)
-
-test_constant_time: $(CONSTTIMETEST)$(EXE_EXT)
-	@echo $(START) $@
-	../util/shlib_wrap.sh ./$(CONSTTIMETEST)
-
-test_verify_extra: $(VERIFYEXTRATEST)$(EXE_EXT)
-	@echo $(START) $@
-	../util/shlib_wrap.sh ./$(VERIFYEXTRATEST) \
-                certs/roots.pem certs/untrusted.pem certs/bad.pem
-
-test_clienthello: $(CLIENTHELLOTEST)$(EXE_EXT)
-	@echo $(START) $@
-	../util/shlib_wrap.sh ./$(CLIENTHELLOTEST)
-
-test_packet: $(PACKETTEST)$(EXE_EXT)
-	@echo $(START) $@
-	../util/shlib_wrap.sh ./$(PACKETTEST)
-
-#OPENSSL_ia32cap=... in ssl tests below ensures AES-NI is switched off (AES-NI does not go through the testmode engine)
-test_sslvertol: ../apps/openssl$(EXE_EXT)
-	@echo $(START) $@
-	[ -z &quot;$(SHARED_LIBS)&quot; ] || OPENSSL_ENGINES=../engines ../util/shlib_wrap.sh $(PERL) -I../util -w ./$(SSLVERTOLTEST) &quot;OPENSSL_ia32cap='~0x200000200000000' ../apps/openssl$(EXE_EXT)&quot; ../apps/server.pem
-	@[ -n &quot;$(SHARED_LIBS)&quot; ] || echo test_sslvertol can only be performed with OpenSSL configured shared
-
-test_sslextension: ../apps/openssl$(EXE_EXT)
-	@echo $(START) $@
-	[ -z &quot;$(SHARED_LIBS)&quot; ] || OPENSSL_ENGINES=../engines ../util/shlib_wrap.sh $(PERL) -I../util -w ./$(SSLEXTENSIONTEST) &quot;OPENSSL_ia32cap='~0x200000200000000' ../apps/openssl$(EXE_EXT)&quot; ../apps/server.pem
-	@[ -n &quot;$(SHARED_LIBS)&quot; ] || echo test_sslextension can only be performed with OpenSSL configured shared
-
-test_sslsessionticket: ../apps/openssl$(EXE_EXT)
-	@echo $(START) $@
-	[ -z &quot;$(SHARED_LIBS)&quot; ] || PERL5LIB=$$PERL5LIB:../util OPENSSL_ENGINES=../engines ../util/shlib_wrap.sh ./$(SSLSESSIONTICKTEST) &quot;OPENSSL_ia32cap='~0x200000200000000' ../apps/openssl$(EXE_EXT)&quot; ../apps/server.pem
-	@[ -n &quot;$(SHARED_LIBS)&quot; ] || echo test_sslsessionticket can only be performed with OpenSSL configured shared
-
-test_sslskewith0p: ../apps/openssl$(EXE_EXT)
-	@echo $(START) $@
-	[ -z &quot;$(SHARED_LIBS)&quot; ] || OPENSSL_ENGINES=../engines ../util/shlib_wrap.sh $(PERL) -I../util -w ./$(SSLSKEWITH0PTEST) &quot;OPENSSL_ia32cap='~0x200000200000000' ../apps/openssl$(EXE_EXT)&quot; ../apps/server.pem
-	@[ -n &quot;$(SHARED_LIBS)&quot; ] || echo test_sslskewith0p can only be performed with OpenSSL configured shared
-
 update: local_depend
 	@if [ -z &quot;$(THIS)&quot; ]; then $(MAKE) -f $(TOP)/Makefile reflect THIS=$@; fi
 
@@ -478,7 +171,7 @@ dclean:
 	rm -f newkey.pem testkey.pem testreq.pem
 
 clean:
-	rm -f .rnd tmp.bntest tmp.bctest *.o *.obj *.dll lib tags core .pure .nfs* *.old *.bak fluff $(EXE) *.ss *.srl log dummytest
+	rm -f .rnd tmp.bntest tmp.bctest *.o *.obj *.dll lib tags core .pure .nfs* *.old *.bak fluff $(EXE) *.ss *.srl log *.log dummytest
 
 $(DLIBSSL):
 	(cd ..; $(MAKE) build_libssl)
diff --git a/test/README b/test/README
new file mode 100644
index 0000000..8df35fe
--- /dev/null
+++ b/test/README
@@ -0,0 +1,107 @@
+How to add recipes
+==================
+
+For any test that you want to perform, you write a script located in
+test/recipes/, named {nn}-test_{name}.t, where {nn} is a two digit number and
+{name} is a unique name of your choice.
+
+Please note that if a test involves a new testing executable, you will need to
+do some additions in test/Makefile.  More on this later.
+
+
+Naming convetions
+=================
+
+A test executable is named test/{name}test.c
+
+A test recipe is named test/recipes/{nn}-test_{name}.t, where {nn} is a two
+digit number and {name} is a unique name of your choice.
+
+The number {nn} is (somewhat loosely) grouped as follows:
+
+05  individual symmetric cipher algorithms
+10  math (bignum)
+15  individual asymmetric cipher algorithms
+20  openssl enc
+25  certificate forms, generation and verification
+30  engine and evp
+70  PACKET layer
+80  &quot;larger&quot; protocols (CA, CMS, OCSP, SSL, TSA)
+90  misc
+
+
+A recipe that just runs a test executable
+=========================================
+
+A script that just runs a program looks like this:
+
+    #! /usr/bin/perl
+    
+    use OpenSSL::Test::Simple;
+    
+    simple_test(&quot;test_{name}&quot;, &quot;{name}test&quot;, &quot;{name}&quot;);
+
+{name} is the unique name you have chosen for your test.
+
+The second argument to `simple_test' is the test executable, and `simple_test'
+expects it to be located in test/
+
+For documentation on OpenSSL::Test::Simple, do
+`perldoc test/testlib/OpenSSL/Test/Simple.pm'.
+
+
+A recipe that runs a more complex test
+======================================
+
+For more complex tests, you will need to read up on Test::More and
+OpenSSL::Test.  Test::More is normally preinstalled, do `man Test::More' for
+documentation.  For OpenSSL::Test, do `perldoc test/testlib/OpenSSL/Test.pm'.
+
+A script to start from could be this:
+
+    #! /usr/bin/perl
+    
+    use strict;
+    use warnings;
+    use OpenSSL::Test;
+    
+    setup(&quot;test_{name}&quot;);
+    
+    plan tests =&gt; 2;                # The number of tests being performed
+    
+    ok(test1, &quot;test1&quot;);
+    ok(test2, &quot;test1&quot;);
+    
+    sub test1
+    {
+        # test feature 1
+    }
+    
+    sub test2
+    {
+        # test feature 2
+    }
+    
+
+Changes to test/Makefile
+========================
+
+Whenever a new test involves a new test executable you need to do the
+following (at all times, replace {NAME} and {name} with the name of your
+test):
+
+* among the variables for test executables at the beginning, add a line like
+  this:
+
+    {NAME}TEST= {name}test
+
+* add `$({NAME}TEST)$(EXE_EXT)' to the assignment of EXE:
+
+* add `$({NAME}TEST).o' to the assignment of OBJ:
+
+* add `$({NAME}TEST).c' to the assignment of SRC:
+
+* add the following lines for building the executable:
+
+    $({NAME}TEST)$(EXE_EXT): $({NAME}TEST).o $(DLIBCRYPTO)
+           @target=$({NAME}TEST); $(BUILD_CMD)
diff --git a/test/bntest.c b/test/bntest.c
index 675d0eb..be358c8 100644
--- a/test/bntest.c
+++ b/test/bntest.c
@@ -175,6 +175,12 @@ int main(int argc, char *argv[])
             EXIT(1);
         }
     }
+#ifdef OPENSSL_SYS_VMS
+    {
+        BIO *tmpbio = BIO_new(BIO_f_linebuffer());
+        out = BIO_push(tmpbio, out);
+    }
+#endif
 
     if (!results)
         BIO_puts(out, &quot;obase=16\nibase=16\n&quot;);
diff --git a/test/constant_time_test.c b/test/constant_time_test.c
index ed3d7ea..1c04cb7 100644
--- a/test/constant_time_test.c
+++ b/test/constant_time_test.c
@@ -295,7 +295,7 @@ int main(int argc, char *argv[])
     }
 
     if (!num_failed) {
-        fprintf(stdout, &quot;ok (ran %d tests)\n&quot;, num_all);
+        fprintf(stdout, &quot;success (ran %d tests)\n&quot;, num_all);
         return EXIT_SUCCESS;
     } else {
         fprintf(stdout, &quot;%d of %d tests failed!\n&quot;, num_failed, num_all);
diff --git a/test/recipes/00-check_testexes.t b/test/recipes/00-check_testexes.t
new file mode 100644
index 0000000..3ab38c7
--- /dev/null
+++ b/test/recipes/00-check_testexes.t
@@ -0,0 +1,59 @@
+#! /usr/bin/perl
+
+use strict;
+
+use File::Spec::Functions;
+use File::Basename;
+use OpenSSL::Test qw/:DEFAULT top_file/;
+
+setup(&quot;check_testexes&quot;);
+
+my $OpenSSL_ver = &quot;&quot;;
+my $Makefile = top_file(&quot;Makefile&quot;);
+if (open(FH, $Makefile)) {
+    $OpenSSL_ver =
+	(map { chomp; s/^VERSION=([^\s]*)\s*$//; $1 } grep { /^VERSION=/ } &lt;FH&gt;)[0];
+    close FH;
+}
+
+my $MINFO = top_file(&quot;MINFO&quot;);
+
+plan skip_all =&gt; &quot;because MINFO not found. If you want this test to run, please do 'perl util/mkfiles.pl &gt; MINFO'&quot;
+    unless open(FH,$MINFO);
+
+my $MINFO_ver = &quot;&quot;;
+
+while(&lt;FH&gt;) {
+    chomp;
+    if (/^VERSION=([^\s]*)\s*$/) {
+	$MINFO_ver = $1;
+    }
+    last if /^RELATIVE_DIRECTORY=test$/;
+}
+while(&lt;FH&gt;) {
+    chomp;
+    last if /^EXE=/;
+}
+close FH;
+
+plan skip_all =&gt; &quot;because MINFO is not from this OpenSSL version. If you want this test to run, please do 'perl util/mkfiles.pl &gt; MINFO'&quot;
+    unless $OpenSSL_ver eq $MINFO_ver;
+
+s/^EXE=\s*//;
+s/\s*$//;
+my @expected_tests =
+    map { s/\..*$//;		# Remove extension
+	  s/_?test$//;		# Remove 'test', possibly prefixed with '_'
+	  s/(sha\d+)t/$1/;	# sha comes with no t at the end
+	  $_; } split(/\s+/, $_);
+
+plan tests =&gt; scalar @expected_tests;
+
+my @found_tests =
+    map { basename($_) } glob(top_file(&quot;test&quot;, &quot;recipes&quot;, &quot;*.t&quot;));
+
+foreach my $test (sort @expected_tests) {
+    ok(scalar(grep(/^[0-9][0-9]-test_$test\.t$/, @found_tests)),
+       &quot;check that a test for $test exists&quot;)
+	|| diag(&quot;Expected to find something matching '[0-9][0-9]-test_$test.t'&quot;);
+}
diff --git a/test/recipes/05-test_bf.t b/test/recipes/05-test_bf.t
new file mode 100644
index 0000000..4794bf0
--- /dev/null
+++ b/test/recipes/05-test_bf.t
@@ -0,0 +1,5 @@
+#! /usr/bin/perl
+
+use OpenSSL::Test::Simple;
+
+simple_test(&quot;test_bf&quot;, &quot;bftest&quot;, &quot;bf&quot;);
diff --git a/test/recipes/05-test_cast.t b/test/recipes/05-test_cast.t
new file mode 100644
index 0000000..621e1ae
--- /dev/null
+++ b/test/recipes/05-test_cast.t
@@ -0,0 +1,5 @@
+#! /usr/bin/perl
+
+use OpenSSL::Test::Simple;
+
+simple_test(&quot;test_cast&quot;, &quot;casttest&quot;, &quot;cast&quot;);
diff --git a/test/recipes/05-test_des.t b/test/recipes/05-test_des.t
new file mode 100644
index 0000000..71de4b4
--- /dev/null
+++ b/test/recipes/05-test_des.t
@@ -0,0 +1,5 @@
+#! /usr/bin/perl
+
+use OpenSSL::Test::Simple;
+
+simple_test(&quot;test_des&quot;, &quot;destest&quot;, &quot;des&quot;);
diff --git a/test/recipes/05-test_hmac.t b/test/recipes/05-test_hmac.t
new file mode 100644
index 0000000..469d43f
--- /dev/null
+++ b/test/recipes/05-test_hmac.t
@@ -0,0 +1,5 @@
+#! /usr/bin/perl
+
+use OpenSSL::Test::Simple;
+
+simple_test(&quot;test_hmac&quot;, &quot;hmactest&quot;, &quot;hmac&quot;);
diff --git a/test/recipes/05-test_idea.t b/test/recipes/05-test_idea.t
new file mode 100644
index 0000000..c43ba5c
--- /dev/null
+++ b/test/recipes/05-test_idea.t
@@ -0,0 +1,5 @@
+#! /usr/bin/perl
+
+use OpenSSL::Test::Simple;
+
+simple_test(&quot;test_idea&quot;, &quot;ideatest&quot;, &quot;idea&quot;);
diff --git a/test/recipes/05-test_md2.t b/test/recipes/05-test_md2.t
new file mode 100644
index 0000000..2175c5f
--- /dev/null
+++ b/test/recipes/05-test_md2.t
@@ -0,0 +1,5 @@
+#! /usr/bin/perl
+
+use OpenSSL::Test::Simple;
+
+simple_test(&quot;test_md2&quot;, &quot;md2test&quot;, &quot;md2&quot;);
diff --git a/test/recipes/05-test_md4.t b/test/recipes/05-test_md4.t
new file mode 100644
index 0000000..2337223
--- /dev/null
+++ b/test/recipes/05-test_md4.t
@@ -0,0 +1,5 @@
+#! /usr/bin/perl
+
+use OpenSSL::Test::Simple;
+
+simple_test(&quot;test_md4&quot;, &quot;md4test&quot;, &quot;md4&quot;);
diff --git a/test/recipes/05-test_md5.t b/test/recipes/05-test_md5.t
new file mode 100644
index 0000000..e9331e2
--- /dev/null
+++ b/test/recipes/05-test_md5.t
@@ -0,0 +1,5 @@
+#! /usr/bin/perl
+
+use OpenSSL::Test::Simple;
+
+simple_test(&quot;test_md5&quot;, &quot;md5test&quot;, &quot;md5&quot;);
diff --git a/test/recipes/05-test_mdc2.t b/test/recipes/05-test_mdc2.t
new file mode 100644
index 0000000..23e904c
--- /dev/null
+++ b/test/recipes/05-test_mdc2.t
@@ -0,0 +1,5 @@
+#! /usr/bin/perl
+
+use OpenSSL::Test::Simple;
+
+simple_test(&quot;test_mdc2&quot;, &quot;mdc2test&quot;, &quot;mdc2&quot;);
diff --git a/test/recipes/05-test_rand.t b/test/recipes/05-test_rand.t
new file mode 100644
index 0000000..afa66a6
--- /dev/null
+++ b/test/recipes/05-test_rand.t
@@ -0,0 +1,5 @@
+#! /usr/bin/perl
+
+use OpenSSL::Test::Simple;
+
+simple_test(&quot;test_rand&quot;, &quot;randtest&quot;, &quot;rand&quot;);
diff --git a/test/recipes/05-test_rc2.t b/test/recipes/05-test_rc2.t
new file mode 100644
index 0000000..423b3b7
--- /dev/null
+++ b/test/recipes/05-test_rc2.t
@@ -0,0 +1,5 @@
+#! /usr/bin/perl
+
+use OpenSSL::Test::Simple;
+
+simple_test(&quot;test_rc2&quot;, &quot;rc2test&quot;, &quot;rc2&quot;);
diff --git a/test/recipes/05-test_rc4.t b/test/recipes/05-test_rc4.t
new file mode 100644
index 0000000..a16455f
--- /dev/null
+++ b/test/recipes/05-test_rc4.t
@@ -0,0 +1,5 @@
+#! /usr/bin/perl
+
+use OpenSSL::Test::Simple;
+
+simple_test(&quot;test_rc4&quot;, &quot;rc4test&quot;, &quot;rc4&quot;);
diff --git a/test/recipes/05-test_rc5.t b/test/recipes/05-test_rc5.t
new file mode 100644
index 0000000..4c5390a
--- /dev/null
+++ b/test/recipes/05-test_rc5.t
@@ -0,0 +1,5 @@
+#! /usr/bin/perl
+
+use OpenSSL::Test::Simple;
+
+simple_test(&quot;test_rc5&quot;, &quot;rc5test&quot;, &quot;rc5&quot;);
diff --git a/test/recipes/05-test_rmd.t b/test/recipes/05-test_rmd.t
new file mode 100644
index 0000000..7ad91c4
--- /dev/null
+++ b/test/recipes/05-test_rmd.t
@@ -0,0 +1,5 @@
+#! /usr/bin/perl
+
+use OpenSSL::Test::Simple;
+
+simple_test(&quot;test_rmd&quot;, &quot;rmdtest&quot;, &quot;rmd&quot;);
diff --git a/test/recipes/05-test_sha1.t b/test/recipes/05-test_sha1.t
new file mode 100644
index 0000000..9f8a570
--- /dev/null
+++ b/test/recipes/05-test_sha1.t
@@ -0,0 +1,5 @@
+#! /usr/bin/perl
+
+use OpenSSL::Test::Simple;
+
+simple_test(&quot;test_sha1&quot;, &quot;sha1test&quot;, &quot;sha1&quot;);
diff --git a/test/recipes/05-test_sha256.t b/test/recipes/05-test_sha256.t
new file mode 100644
index 0000000..cb63aa8
--- /dev/null
+++ b/test/recipes/05-test_sha256.t
@@ -0,0 +1,5 @@
+#! /usr/bin/perl
+
+use OpenSSL::Test::Simple;
+
+simple_test(&quot;test_sha256&quot;, &quot;sha256t&quot;, &quot;sha256&quot;);
diff --git a/test/recipes/05-test_sha512.t b/test/recipes/05-test_sha512.t
new file mode 100644
index 0000000..f353ac1
--- /dev/null
+++ b/test/recipes/05-test_sha512.t
@@ -0,0 +1,5 @@
+#! /usr/bin/perl
+
+use OpenSSL::Test::Simple;
+
+simple_test(&quot;test_sha512&quot;, &quot;sha512t&quot;, &quot;sha512&quot;);
diff --git a/test/recipes/05-test_wp.t b/test/recipes/05-test_wp.t
new file mode 100644
index 0000000..c05be9c
--- /dev/null
+++ b/test/recipes/05-test_wp.t
@@ -0,0 +1,5 @@
+#! /usr/bin/perl
+
+use OpenSSL::Test::Simple;
+
+simple_test(&quot;test_wp&quot;, &quot;wptest&quot;, &quot;wp&quot;);
diff --git a/test/recipes/10-test_bn.t b/test/recipes/10-test_bn.t
new file mode 100644
index 0000000..29b449f
--- /dev/null
+++ b/test/recipes/10-test_bn.t
@@ -0,0 +1,75 @@
+#! /usr/bin/perl
+
+use strict;
+use warnings;
+
+use Math::BigInt;
+
+use OpenSSL::Test qw/:DEFAULT top_file/;
+
+setup(&quot;test_bn&quot;);
+
+plan tests =&gt; 3;
+
+require_ok(top_file(&quot;test&quot;,&quot;recipes&quot;,&quot;bc.pl&quot;));
+
+my $testresults = &quot;tmp.bntest&quot;;
+my $init = ok(run(test([&quot;bntest&quot;], stdout =&gt; $testresults)), 'initialize');
+
+ SKIP: {
+     skip &quot;Initializing failed, skipping&quot;, 1 if !$init;
+
+     subtest 'Checking the bn results' =&gt; sub {
+	 my @lines = ();
+	 if (open DATA, $testresults) {
+	     @lines = &lt;DATA&gt;;
+	     close DATA;
+	 }
+	 chomp(@lines);
+
+	 plan tests =&gt; scalar grep(/^print /, @lines);
+
+	 my $l = &quot;&quot;;
+
+	 while (scalar @lines) {
+	     $l = shift @lines;
+
+	     last if $l =~ /^print /;
+	 }
+
+	 while (1) {
+	     $l =~ s/^print &quot;//;
+	     $l =~ s/\\n&quot;//;
+	     my $t = $l;
+	     my @operations = ();
+
+	     $l = undef;
+	     while (scalar @lines) {
+		 $l = shift @lines;
+
+		 last if $l =~ /^print /;
+		 push @operations, $l;
+		 $l = undef;
+	     }
+
+	     ok(check_operations(@operations), &quot;verify $t&quot;);
+
+	     last unless $l;
+	 }
+     };
+}
+
+sub check_operations {
+    my $failcount = 0;
+
+    foreach my $line (@_) {
+	my $result = calc(split /\s+/, $line);
+
+	if ($result ne &quot;0&quot; &amp;&amp; $result ne &quot;0x0&quot;) {
+	    $failcount++;
+	    print STDERR &quot;Failed! $line =&gt; $result\n&quot;;
+	}
+    }
+
+    return $failcount == 0;
+}
diff --git a/test/recipes/10-test_exp.t b/test/recipes/10-test_exp.t
new file mode 100644
index 0000000..b8083e7
--- /dev/null
+++ b/test/recipes/10-test_exp.t
@@ -0,0 +1,5 @@
+#! /usr/bin/perl
+
+use OpenSSL::Test::Simple;
+
+simple_test(&quot;test_exp&quot;, &quot;exptest&quot;);
diff --git a/test/recipes/15-test_dh.t b/test/recipes/15-test_dh.t
new file mode 100644
index 0000000..35e9564
--- /dev/null
+++ b/test/recipes/15-test_dh.t
@@ -0,0 +1,5 @@
+#! /usr/bin/perl
+
+use OpenSSL::Test::Simple;
+
+simple_test(&quot;test_dh&quot;, &quot;dhtest&quot;, &quot;dh&quot;);
diff --git a/test/recipes/15-test_dsa.t b/test/recipes/15-test_dsa.t
new file mode 100644
index 0000000..e338b0b
--- /dev/null
+++ b/test/recipes/15-test_dsa.t
@@ -0,0 +1,32 @@
+#! /usr/bin/perl
+
+use strict;
+use warnings;
+
+use File::Spec;
+use OpenSSL::Test qw/:DEFAULT top_file/;
+
+setup(&quot;test_dsa&quot;);
+
+plan tests =&gt; 6;
+
+require_ok(top_file('test','recipes','tconversion.pl'));
+
+ok(run(test([&quot;dsatest&quot;])), &quot;running dsatest&quot;);
+ok(run(test([&quot;dsatest&quot;, &quot;-app2_1&quot;])), &quot;running dsatest -app2_1&quot;);
+
+ SKIP: {
+     skip &quot;Skipping dsa conversion test&quot;, 3
+	 if run(app([&quot;openssl&quot;,&quot;no-dsa&quot;], stdout =&gt; undef));
+
+     subtest 'dsa conversions -- private key' =&gt; sub {
+	 tconversion(&quot;dsa&quot;, top_file(&quot;test&quot;,&quot;testdsa.pem&quot;));
+     };
+     subtest 'dsa conversions -- private key PKCS#8' =&gt; sub {
+	 tconversion(&quot;dsa&quot;, top_file(&quot;test&quot;,&quot;testdsa.pem&quot;), &quot;pkey&quot;);
+     };
+     subtest 'dsa conversions -- public key' =&gt; sub {
+	 tconversion(&quot;dsa&quot;, top_file(&quot;test&quot;,&quot;testdsapub.pem&quot;), &quot;dsa&quot;,
+		     &quot;-pubin&quot;, &quot;-pubout&quot;);
+     };
+}
diff --git a/test/recipes/15-test_ec.t b/test/recipes/15-test_ec.t
new file mode 100644
index 0000000..bbda19a
--- /dev/null
+++ b/test/recipes/15-test_ec.t
@@ -0,0 +1,30 @@
+#! /usr/bin/perl
+
+use strict;
+use warnings;
+
+use File::Spec;
+use OpenSSL::Test qw/:DEFAULT top_file/;
+
+setup(&quot;test_ec&quot;);
+
+plan tests =&gt; 5;
+
+require_ok(top_file('test','recipes','tconversion.pl'));
+
+ok(run(test([&quot;ectest&quot;])), &quot;running ectest&quot;);
+
+ SKIP: {
+     skip &quot;Skipping ec conversion test&quot;, 3
+	 if run(app([&quot;openssl&quot;,&quot;no-ec&quot;], stdout =&gt; undef));
+
+     subtest 'ec conversions -- private key' =&gt; sub {
+	 tconversion(&quot;ec&quot;, top_file(&quot;test&quot;,&quot;testec-p256.pem&quot;));
+     };
+     subtest 'ec conversions -- private key PKCS#8' =&gt; sub {
+	 tconversion(&quot;ec&quot;, top_file(&quot;test&quot;,&quot;testec-p256.pem&quot;), &quot;pkey&quot;);
+     };
+     subtest 'ec conversions -- public key' =&gt; sub {
+	 tconversion(&quot;ec&quot;, top_file(&quot;test&quot;,&quot;testecpub-p256.pem&quot;), &quot;ec&quot;, &quot;-pubin&quot;, &quot;-pubout&quot;);
+     };
+}
diff --git a/test/recipes/15-test_ecdh.t b/test/recipes/15-test_ecdh.t
new file mode 100644
index 0000000..7cdfea6
--- /dev/null
+++ b/test/recipes/15-test_ecdh.t
@@ -0,0 +1,5 @@
+#! /usr/bin/perl
+
+use OpenSSL::Test::Simple;
+
+simple_test(&quot;test_ecdh&quot;, &quot;ecdhtest&quot;, &quot;ecdh&quot;);
diff --git a/test/recipes/15-test_ecdsa.t b/test/recipes/15-test_ecdsa.t
new file mode 100644
index 0000000..aa4622f
--- /dev/null
+++ b/test/recipes/15-test_ecdsa.t
@@ -0,0 +1,5 @@
+#! /usr/bin/perl
+
+use OpenSSL::Test::Simple;
+
+simple_test(&quot;test_ecdsa&quot;, &quot;ecdsatest&quot;, &quot;ecdsa&quot;);
diff --git a/test/recipes/15-test_rsa.t b/test/recipes/15-test_rsa.t
new file mode 100644
index 0000000..2eaeb0d
--- /dev/null
+++ b/test/recipes/15-test_rsa.t
@@ -0,0 +1,31 @@
+#! /usr/bin/perl
+
+use strict;
+use warnings;
+
+use File::Spec;
+use OpenSSL::Test qw/:DEFAULT top_file/;
+
+setup(&quot;test_rsa&quot;);
+
+plan tests =&gt; 5;
+
+require_ok(top_file('test','recipes','tconversion.pl'));
+
+ok(run(test([&quot;rsa_test&quot;])), &quot;running rsatest&quot;);
+
+ SKIP: {
+     skip &quot;Skipping rsa conversion test&quot;, 3
+	 if run(app([&quot;openssl&quot;,&quot;no-rsa&quot;], stdout =&gt; undef));
+
+     subtest 'rsa conversions -- private key' =&gt; sub {
+	 tconversion(&quot;rsa&quot;, top_file(&quot;test&quot;,&quot;testrsa.pem&quot;));
+     };
+     subtest 'rsa conversions -- private key PKCS#8' =&gt; sub {
+	 tconversion(&quot;rsa&quot;, top_file(&quot;test&quot;,&quot;testrsa.pem&quot;), &quot;pkey&quot;);
+     };
+     subtest 'rsa conversions -- public key' =&gt; sub {
+	 tconversion(&quot;rsa&quot;, top_file(&quot;test&quot;,&quot;testrsapub.pem&quot;), &quot;rsa&quot;,
+		     &quot;-pubin&quot;, &quot;-pubout&quot;);
+     };
+}
diff --git a/test/recipes/20-test_enc.t b/test/recipes/20-test_enc.t
new file mode 100644
index 0000000..bd5a436
--- /dev/null
+++ b/test/recipes/20-test_enc.t
@@ -0,0 +1,64 @@
+#! /usr/bin/perl
+
+use strict;
+use warnings;
+
+use File::Spec::Functions qw/catfile/;
+use File::Copy;
+use File::Compare qw/compare_text/;
+use File::Basename;
+use OpenSSL::Test qw/:DEFAULT top_file/;
+
+setup(&quot;test_enc&quot;);
+
+# We do it this way, because setup() may have moved us around,
+# so the directory portion of $0 might not be correct any more.
+# However, the name hasn't changed.
+my $testsrc = top_file(&quot;test&quot;,&quot;recipes&quot;,basename($0));
+
+my $test = catfile(&quot;.&quot;, &quot;p&quot;);
+
+my $cmd = &quot;openssl&quot;;
+
+my @ciphers =
+    map { chomp; s/^\s+//; s/\s+$//; split /\s+/ }
+    run(app([$cmd, &quot;list&quot;, &quot;-cipher-commands&quot;]), capture =&gt; 1);
+
+plan tests =&gt; 1 + (scalar @ciphers)*2;
+
+my $init = ok(copy($testsrc,$test));
+
+if (!$init) {
+    diag(&quot;Trying to copy $testsrc to $test : $!&quot;);
+}
+
+ SKIP: {
+     skip &quot;Not initialized, skipping...&quot;, 11 unless $init;
+
+     foreach my $c (@ciphers) {
+	 my %variant = (&quot;$c&quot; =&gt; [],
+			&quot;$c base64&quot; =&gt; [ &quot;-a&quot; ]);
+
+	 foreach my $t (sort keys %variant) {
+	     my $cipherfile = &quot;$test.$c.cipher&quot;;
+	     my $clearfile = &quot;$test.$c.clear&quot;;
+	     my @e = ( &quot;$c&quot;, &quot;-bufsize&quot;, &quot;113&quot;, @{$variant{$t}}, &quot;-e&quot;, &quot;-k&quot;, &quot;test&quot; );
+	     my @d = ( &quot;$c&quot;, &quot;-bufsize&quot;, &quot;157&quot;, @{$variant{$t}}, &quot;-d&quot;, &quot;-k&quot;, &quot;test&quot; );
+	     if ($c eq &quot;cat&quot;) {
+		 $cipherfile = &quot;$test.cipher&quot;;
+		 $clearfile = &quot;$test.clear&quot;;
+		 @e = ( &quot;enc&quot;, @{$variant{$t}}, &quot;-e&quot; );
+		 @d = ( &quot;enc&quot;, @{$variant{$t}}, &quot;-d&quot; );
+	     }
+
+	     ok(run(app([$cmd, @e],
+			stdin =&gt; $test, stdout =&gt; $cipherfile))
+		&amp;&amp; run(app([$cmd, @d],
+			   stdin =&gt; $cipherfile, stdout =&gt; $clearfile))
+		&amp;&amp; compare_text($test,$clearfile) == 0, $t);
+	     unlink $cipherfile, $clearfile;
+	 }
+     }
+}
+
+unlink $test;
diff --git a/test/recipes/25-test_crl.t b/test/recipes/25-test_crl.t
new file mode 100644
index 0000000..6779a0b
--- /dev/null
+++ b/test/recipes/25-test_crl.t
@@ -0,0 +1,17 @@
+#! /usr/bin/perl
+
+use strict;
+use warnings;
+
+use File::Spec;
+use OpenSSL::Test qw/:DEFAULT top_file/;
+
+setup(&quot;test_crl&quot;);
+
+plan tests =&gt; 2;
+
+require_ok(top_file('test','recipes','tconversion.pl'));
+
+subtest 'crl conversions' =&gt; sub {
+    tconversion(&quot;crl&quot;, top_file(&quot;test&quot;,&quot;testcrl.pem&quot;));
+};
diff --git a/test/recipes/25-test_gen.t b/test/recipes/25-test_gen.t
new file mode 100644
index 0000000..9427bde
--- /dev/null
+++ b/test/recipes/25-test_gen.t
@@ -0,0 +1,43 @@
+#! /usr/bin/perl
+
+use strict;
+use warnings;
+
+use File::Spec;
+use OpenSSL::Test qw/:DEFAULT top_file/;
+
+setup(&quot;test_gen&quot;);
+
+plan tests =&gt; 1;
+
+my $T = &quot;testcert&quot;;
+my $KEY = 512;
+my $CA = top_file(&quot;certs&quot;, &quot;testca.pem&quot;);
+
+unlink &quot;$T.1&quot;, &quot;$T.2&quot;, &quot;$T.key&quot;;
+open RND, &quot;&gt;&gt;&quot;, &quot;.rnd&quot;;
+print RND &quot;string to make the random number generator think it has entropy&quot;;
+close RND;
+
+subtest &quot;generating certificate requests&quot; =&gt; sub {
+    my @req_new;
+    if (run(app([&quot;openssl&quot;, &quot;no-rsa&quot;], stdout =&gt; undef))) {
+	@req_new = (&quot;-newkey&quot;, &quot;dsa:&quot;.top_file(&quot;apps&quot;, &quot;dsa512.pem&quot;));
+    } else {
+	@req_new = (&quot;-new&quot;);
+	note(&quot;There should be a 2 sequences of .'s and some +'s.&quot;);
+	note(&quot;There should not be more that at most 80 per line&quot;);
+    }
+
+    unlink &quot;testkey.pem&quot;, &quot;testreq.pem&quot;;
+
+    plan tests =&gt; 2;
+
+    ok(run(app([&quot;openssl&quot;, &quot;req&quot;, &quot;-config&quot;, top_file(&quot;test&quot;, &quot;test.cnf&quot;),
+		@req_new, &quot;-out&quot;, &quot;testreq.pem&quot;])),
+       &quot;Generating request&quot;);
+
+    ok(run(app([&quot;openssl&quot;, &quot;req&quot;, &quot;-config&quot;, top_file(&quot;test&quot;, &quot;test.cnf&quot;),
+		&quot;-verify&quot;, &quot;-in&quot;, &quot;testreq.pem&quot;, &quot;-noout&quot;])),
+       &quot;Verifying signature on request&quot;);
+};
diff --git a/test/recipes/25-test_pkcs7.t b/test/recipes/25-test_pkcs7.t
new file mode 100644
index 0000000..3a4dbb4
--- /dev/null
+++ b/test/recipes/25-test_pkcs7.t
@@ -0,0 +1,20 @@
+#! /usr/bin/perl
+
+use strict;
+use warnings;
+
+use File::Spec;
+use OpenSSL::Test qw/:DEFAULT top_file/;
+
+setup(&quot;test_pkcs7&quot;);
+
+plan tests =&gt; 3;
+
+require_ok(top_file('test','recipes','tconversion.pl'));
+
+subtest 'pkcs7 conversions -- pkcs7' =&gt; sub {
+    tconversion(&quot;p7&quot;, top_file(&quot;test&quot;, &quot;testp7.pem&quot;), &quot;pkcs7&quot;);
+};
+subtest 'pkcs7 conversions -- pkcs7d' =&gt; sub {
+    tconversion(&quot;p7d&quot;, top_file(&quot;test&quot;, &quot;pkcs7-1.pem&quot;), &quot;pkcs7&quot;);
+};
diff --git a/test/recipes/25-test_req.t b/test/recipes/25-test_req.t
new file mode 100644
index 0000000..4f9de77
--- /dev/null
+++ b/test/recipes/25-test_req.t
@@ -0,0 +1,43 @@
+#! /usr/bin/perl
+
+use strict;
+use warnings;
+
+use File::Spec;
+use OpenSSL::Test qw/:DEFAULT top_file/;
+
+setup(&quot;test_req&quot;);
+
+plan tests =&gt; 3;
+
+require_ok(top_file('test','recipes','tconversion.pl'));
+
+my @openssl_args = (&quot;req&quot;, &quot;-config&quot;, &quot;../apps/openssl.cnf&quot;);
+
+run_conversion('req conversions',
+	       &quot;testreq.pem&quot;);
+run_conversion('req conversions -- testreq2',
+	       &quot;testreq2.pem&quot;);
+
+sub run_conversion {
+    my $title = shift;
+    my $reqfile = shift;
+
+    subtest $title =&gt; sub {
+	run(app([&quot;openssl&quot;, @openssl_args,
+		 &quot;-in&quot;, $reqfile, &quot;-inform&quot;, &quot;p&quot;,
+		 &quot;-noout&quot;, &quot;-text&quot;],
+		stderr =&gt; &quot;req-check.err&quot;, stdout =&gt; undef));
+	open DATA, &quot;req-check.err&quot;;
+      SKIP: {
+	  plan skip_all =&gt; &quot;skipping req conversion test for $reqfile&quot;
+	      if grep /Unknown Public Key/, map { chomp } &lt;DATA&gt;;
+
+	  tconversion(&quot;req&quot;, &quot;testreq.pem&quot;, @openssl_args);
+	}
+	close DATA;
+	unlink &quot;req-check.err&quot;;
+
+	done_testing();
+    };
+}
diff --git a/test/recipes/25-test_sid.t b/test/recipes/25-test_sid.t
new file mode 100644
index 0000000..b223c0d
--- /dev/null
+++ b/test/recipes/25-test_sid.t
@@ -0,0 +1,17 @@
+#! /usr/bin/perl
+
+use strict;
+use warnings;
+
+use File::Spec;
+use OpenSSL::Test qw/:DEFAULT top_file/;
+
+setup(&quot;test_sid&quot;);
+
+plan tests =&gt; 2;
+
+require_ok(top_file('test','recipes','tconversion.pl'));
+
+subtest 'sid conversions' =&gt; sub {
+    tconversion(&quot;sid&quot;, top_file(&quot;test&quot;,&quot;testsid.pem&quot;), &quot;sess_id&quot;);
+};
diff --git a/test/recipes/25-test_verify.t b/test/recipes/25-test_verify.t
new file mode 100644
index 0000000..10897a1
--- /dev/null
+++ b/test/recipes/25-test_verify.t
@@ -0,0 +1,15 @@
+#! /usr/bin/perl
+
+use strict;
+use warnings;
+
+use File::Spec::Functions qw/canonpath/;
+use OpenSSL::Test qw/:DEFAULT top_dir top_file/;
+
+setup(&quot;test_verify&quot;);
+
+plan tests =&gt; 1;
+
+note(&quot;Expect some failures and expired certificate&quot;);
+ok(run(app([&quot;openssl&quot;, &quot;verify&quot;, &quot;-CApath&quot;, top_dir(&quot;certs&quot;, &quot;demo&quot;),
+	    glob(top_file(&quot;certs&quot;, &quot;demo&quot;, &quot;*.pem&quot;))])), &quot;verying demo certs&quot;);
diff --git a/test/recipes/25-test_x509.t b/test/recipes/25-test_x509.t
new file mode 100644
index 0000000..e2d795a
--- /dev/null
+++ b/test/recipes/25-test_x509.t
@@ -0,0 +1,23 @@
+#! /usr/bin/perl
+
+use strict;
+use warnings;
+
+use File::Spec;
+use OpenSSL::Test qw/:DEFAULT top_file/;
+
+setup(&quot;test_x509&quot;);
+
+plan tests =&gt; 4;
+
+require_ok(top_file('test','recipes','tconversion.pl'));
+
+subtest 'x509 -- x.509 v1 certificate' =&gt; sub {
+    tconversion(&quot;x509&quot;, top_file(&quot;test&quot;,&quot;testx509.pem&quot;));
+};
+subtest 'x509 -- first x.509 v3 certificate' =&gt; sub {
+    tconversion(&quot;x509&quot;, top_file(&quot;test&quot;,&quot;v3-cert1.pem&quot;));
+};
+subtest 'x509 -- second x.509 v3 certificate' =&gt; sub {
+    tconversion(&quot;x509&quot;, top_file(&quot;test&quot;,&quot;v3-cert2.pem&quot;));
+};
diff --git a/test/recipes/30-test_engine.t b/test/recipes/30-test_engine.t
new file mode 100644
index 0000000..c097b6f
--- /dev/null
+++ b/test/recipes/30-test_engine.t
@@ -0,0 +1,11 @@
+#! /usr/bin/perl
+
+use strict;
+use warnings;
+
+use OpenSSL::Test;
+
+setup(&quot;test_engine&quot;);
+
+plan tests =&gt; 1;
+ok(run(test([&quot;enginetest&quot;])), &quot;running enginetest&quot;);
diff --git a/test/recipes/30-test_evp.t b/test/recipes/30-test_evp.t
new file mode 100644
index 0000000..9d5ce6f
--- /dev/null
+++ b/test/recipes/30-test_evp.t
@@ -0,0 +1,12 @@
+#! /usr/bin/perl
+
+use strict;
+use warnings;
+
+use OpenSSL::Test qw/:DEFAULT top_file/;
+
+setup(&quot;test_evp&quot;);
+
+plan tests =&gt; 1;
+ok(run(test([&quot;evp_test&quot;, top_file(&quot;test&quot;, &quot;evptests.txt&quot;)])),
+   &quot;running evp_test evptests.txt&quot;);
diff --git a/test/recipes/30-test_evp_extra.t b/test/recipes/30-test_evp_extra.t
new file mode 100644
index 0000000..0f90b21
--- /dev/null
+++ b/test/recipes/30-test_evp_extra.t
@@ -0,0 +1,11 @@
+#! /usr/bin/perl
+
+use strict;
+use warnings;
+
+use OpenSSL::Test;
+
+setup(&quot;test_evp_extra&quot;);
+
+plan tests =&gt; 1;
+ok(run(test([&quot;evp_extra_test&quot;])), &quot;running evp_extra_test&quot;);
diff --git a/test/recipes/30-test_pbelu.t b/test/recipes/30-test_pbelu.t
new file mode 100644
index 0000000..635fb69
--- /dev/null
+++ b/test/recipes/30-test_pbelu.t
@@ -0,0 +1,5 @@
+#! /usr/bin/perl
+
+use OpenSSL::Test::Simple;
+
+simple_test(&quot;test_pbelu&quot;, &quot;pbelutest&quot;);
diff --git a/test/recipes/70-test_clienthello.t b/test/recipes/70-test_clienthello.t
new file mode 100644
index 0000000..73b83f2
--- /dev/null
+++ b/test/recipes/70-test_clienthello.t
@@ -0,0 +1,5 @@
+#! /usr/bin/perl
+
+use OpenSSL::Test::Simple;
+
+simple_test(&quot;test_clienthello&quot;, &quot;clienthellotest&quot;);
diff --git a/test/recipes/70-test_packet.t b/test/recipes/70-test_packet.t
new file mode 100644
index 0000000..b1609d5
--- /dev/null
+++ b/test/recipes/70-test_packet.t
@@ -0,0 +1,5 @@
+#! /usr/bin/perl
+
+use OpenSSL::Test::Simple;
+
+simple_test(&quot;test_packet&quot;, &quot;packettest&quot;);
diff --git a/test/sslextensiontest.pl b/test/recipes/70-test_sslextension.t
similarity index 85%
rename from test/sslextensiontest.pl
rename to test/recipes/70-test_sslextension.t
index 802bac1..4aa3f61 100755
--- a/test/sslextensiontest.pl
+++ b/test/recipes/70-test_sslextension.t
@@ -53,18 +53,30 @@
 # Hudson (<A HREF="../../../mailman/listinfo/openssl-commits.html">tjh at cryptsoft.com</A>).
 
 use strict;
+use OpenSSL::Test qw/:DEFAULT cmdstr top_file top_dir/;
 use TLSProxy::Proxy;
 
+my $test_name = &quot;test_sslextension&quot;;
+setup($test_name);
+
+plan skip_all =&gt; &quot;$test_name can only be performed with OpenSSL configured shared&quot;
+    unless (map { chomp; s/^SHARED_LIBS=\s*//; $_ }
+	    grep { /^SHARED_LIBS=/ }
+	    do { local @ARGV = ( top_file(&quot;Makefile&quot;) ); &lt;&gt; })[0] ne &quot;&quot;;
+
+$ENV{OPENSSL_ENGINES} = top_dir(&quot;engines&quot;);
+$ENV{OPENSSL_ia32cap} = '~0x200000200000000';
 my $proxy = TLSProxy::Proxy-&gt;new(
     \&amp;extension_filter,
-    @ARGV
+    cmdstr(app([&quot;openssl&quot;])),
+    top_file(&quot;apps&quot;, &quot;server.pem&quot;)
 );
 
+plan tests =&gt; 1;
+
 #Test 1: Sending a zero length extension block should pass
 $proxy-&gt;start();
-TLSProxy::Message-&gt;success or die &quot;FAILED: Zero extension length test\n&quot;;
-
-print &quot;SUCCESS: Extension test\n&quot;;
+ok(TLSProxy::Message-&gt;success, &quot;Zero extension length test&quot;);
 
 sub extension_filter
 {
diff --git a/test/sslsessionticktest.pl b/test/recipes/70-test_sslsessiontick.t
similarity index 75%
rename from test/sslsessionticktest.pl
rename to test/recipes/70-test_sslsessiontick.t
index 922a359..7f90bea 100755
--- a/test/sslsessionticktest.pl
+++ b/test/recipes/70-test_sslsessiontick.t
@@ -53,9 +53,24 @@
 # Hudson (<A HREF="../../../mailman/listinfo/openssl-commits.html">tjh at cryptsoft.com</A>).
 
 use strict;
+use OpenSSL::Test qw/:DEFAULT cmdstr top_file top_dir/;
 use TLSProxy::Proxy;
 use File::Temp qw(tempfile);
 
+my $test_name = &quot;test_sslsessiontick&quot;;
+setup($test_name);
+
+plan skip_all =&gt; &quot;$test_name can only be performed with OpenSSL configured shared&quot;
+    unless (map { chomp; s/^SHARED_LIBS=\s*//; $_ }
+	    grep { /^SHARED_LIBS=/ }
+	    do { local @ARGV = ( top_file(&quot;Makefile&quot;) ); &lt;&gt; })[0] ne &quot;&quot;;
+
+$ENV{OPENSSL_ENGINES} = top_dir(&quot;engines&quot;);
+$ENV{OPENSSL_ia32cap} = '~0x200000200000000';
+
+sub checkmessages($$$$$$);
+sub clearall();
+
 my $chellotickext = 0;
 my $shellotickext = 0;
 my $fullhand = 0;
@@ -63,9 +78,12 @@ my $ticketseen = 0;
 
 my $proxy = TLSProxy::Proxy-&gt;new(
     undef,
-    @ARGV
+    cmdstr(app([&quot;openssl&quot;])),
+    top_file(&quot;apps&quot;, &quot;server.pem&quot;)
 );
 
+plan tests =&gt; 5;
+
 #Test 1: By default with no existing session we should get a session ticket
 #Expected result: ClientHello extension seen; ServerHello extension seen
 #                 NewSessionTicket message seen; Full handshake
@@ -107,7 +125,7 @@ checkmessages(4, &quot;Session resumption session ticket test&quot;, 1, 0, 0, 0);
 #Expected result: ClientHello extension seen; ServerHello extension seen
 #                 NewSessionTicket message seen; Abbreviated handshake
 clearall();
-(my $fh, my $session) = tempfile();
+($fh, $session) = tempfile();
 $proxy-&gt;serverconnects(2);
 $proxy-&gt;clientflags(&quot;-sess_out &quot;.$session.&quot; -no_ticket&quot;);
 $proxy-&gt;start();
@@ -117,50 +135,45 @@ $proxy-&gt;clientstart();
 checkmessages(5, &quot;Session resumption with ticket capable client without a &quot;
                  .&quot;ticket&quot;, 1, 1, 1, 0);
 
-sub checkmessages()
+sub checkmessages($$$$$$)
 {
     my ($testno, $testname, $testch, $testsh, $testtickseen, $testhand) = @_;
 
-    foreach my $message (@{$proxy-&gt;message_list}) {
-        if ($message-&gt;mt == TLSProxy::Message::MT_CLIENT_HELLO
+    subtest $testname =&gt; sub {
+
+	foreach my $message (@{$proxy-&gt;message_list}) {
+	    if ($message-&gt;mt == TLSProxy::Message::MT_CLIENT_HELLO
                 || $message-&gt;mt == TLSProxy::Message::MT_SERVER_HELLO) {
-            #Get the extensions data
-            my %extensions = %{$message-&gt;extension_data};
-            if (defined
+		#Get the extensions data
+		my %extensions = %{$message-&gt;extension_data};
+		if (defined
                     $extensions{TLSProxy::ClientHello::EXT_SESSION_TICKET}) {
-                if ($message-&gt;mt == TLSProxy::Message::MT_CLIENT_HELLO) {
-                    $chellotickext = 1;
-                } else {
-                    $shellotickext = 1;
-                }
-            }
-        } elsif ($message-&gt;mt == TLSProxy::Message::MT_CLIENT_KEY_EXCHANGE) {
-            #Must be doing a full handshake
-            $fullhand = 1;
-        } elsif ($message-&gt;mt == TLSProxy::Message::MT_NEW_SESSION_TICKET) {
-            $ticketseen = 1;
-        }
-    }
+		    if ($message-&gt;mt == TLSProxy::Message::MT_CLIENT_HELLO) {
+			$chellotickext = 1;
+		    } else {
+			$shellotickext = 1;
+		    }
+		}
+	    } elsif ($message-&gt;mt == TLSProxy::Message::MT_CLIENT_KEY_EXCHANGE) {
+		#Must be doing a full handshake
+		$fullhand = 1;
+	    } elsif ($message-&gt;mt == TLSProxy::Message::MT_NEW_SESSION_TICKET) {
+		$ticketseen = 1;
+	    }
+	}
 
-    TLSProxy::Message-&gt;success or die &quot;FAILED: $testname: Hanshake failed &quot;
-                                      .&quot;(Test $testno)\n&quot;;
-    if (($testch &amp;&amp; !$chellotickext) || (!$testch &amp;&amp; $chellotickext)) {
-        die &quot;FAILED: $testname: ClientHello extension Session Ticket check &quot;
-            .&quot;failed (Test $testno)\n&quot;;
-    }
-    if (($testsh &amp;&amp; !$shellotickext) || (!$testsh &amp;&amp; $shellotickext)) {
-        die &quot;FAILED: $testname: ServerHello extension Session Ticket check &quot;
-            .&quot;failed (Test $testno)\n&quot;;
-    }
-    if (($testtickseen &amp;&amp; !$ticketseen) || (!$testtickseen &amp;&amp; $ticketseen)) {
-        die &quot;FAILED: $testname: Session Ticket message presence check failed &quot;
-            .&quot;(Test $testno)\n&quot;;
-    }
-    if (($testhand &amp;&amp; !$fullhand) || (!$testhand &amp;&amp; $fullhand)) {
-        die &quot;FAILED: $testname: Session Ticket full handshake check failed &quot;
-            .&quot;(Test $testno)\n&quot;;
+	plan tests =&gt; 5;
+
+	ok(TLSProxy::Message-&gt;success, &quot;Hanshake&quot;);
+	ok(($testch &amp;&amp; $chellotickext) || (!$testch &amp;&amp; !$chellotickext),
+	   &quot;ClientHello extension Session Ticket check&quot;);
+	ok(($testsh &amp;&amp; $shellotickext) || (!$testsh &amp;&amp; !$shellotickext),
+	   &quot;ServerHello extension Session Ticket check&quot;);
+	ok(($testtickseen &amp;&amp; $ticketseen) || (!$testtickseen &amp;&amp; !$ticketseen),
+	   &quot;Session Ticket message presence check&quot;);
+	ok(($testhand &amp;&amp; $fullhand) || (!$testhand &amp;&amp; !$fullhand),
+	   &quot;Session Ticket full handshake check&quot;);
     }
-    print &quot;SUCCESS: $testname (Test#$testno)\n&quot;;
 }
 
 sub clearall()
diff --git a/test/sslskewith0ptest.pl b/test/recipes/70-test_sslskewith0p.t
similarity index 85%
rename from test/sslskewith0ptest.pl
rename to test/recipes/70-test_sslskewith0p.t
index 63f8398..d8d74b3 100755
--- a/test/sslskewith0ptest.pl
+++ b/test/recipes/70-test_sslskewith0p.t
@@ -53,21 +53,33 @@
 # Hudson (<A HREF="../../../mailman/listinfo/openssl-commits.html">tjh at cryptsoft.com</A>).
 
 use strict;
+use OpenSSL::Test qw/:DEFAULT cmdstr top_file top_dir/;
 use TLSProxy::Proxy;
 
+my $test_name = &quot;test_sslskewith0p&quot;;
+setup($test_name);
+
+plan skip_all =&gt; &quot;$test_name can only be performed with OpenSSL configured shared&quot;
+    unless (map { chomp; s/^SHARED_LIBS=\s*//; $_ }
+	    grep { /^SHARED_LIBS=/ }
+	    do { local @ARGV = ( top_file(&quot;Makefile&quot;) ); &lt;&gt; })[0] ne &quot;&quot;;
+
+$ENV{OPENSSL_ENGINES} = top_dir(&quot;engines&quot;);
+$ENV{OPENSSL_ia32cap} = '~0x200000200000000';
 my $proxy = TLSProxy::Proxy-&gt;new(
     \&amp;ske_0_p_filter,
-    @ARGV
+    cmdstr(app([&quot;openssl&quot;])),
+    top_file(&quot;apps&quot;, &quot;server.pem&quot;)
 );
 
+plan tests =&gt; 1;
+
 #We must use an anon DHE cipher for this test
 $proxy-&gt;cipherc('ADH-AES128-SHA:@SECLEVEL=0');
 $proxy-&gt;ciphers('ADH-AES128-SHA:@SECLEVEL=0');
 
 $proxy-&gt;start();
-TLSProxy::Message-&gt;fail or die &quot;FAILED: ServerKeyExchange with 0 p\n&quot;;
-
-print &quot;SUCCESS: ServerKeyExchange with 0 p\n&quot;;
+ok(TLSProxy::Message-&gt;fail, &quot;ServerKeyExchange with 0 p&quot;);
 
 sub ske_0_p_filter
 {
diff --git a/test/sslvertoltest.pl b/test/recipes/70-test_sslvertol.t
similarity index 84%
rename from test/sslvertoltest.pl
rename to test/recipes/70-test_sslvertol.t
index 1828a7d..9717f80 100755
--- a/test/sslvertoltest.pl
+++ b/test/recipes/70-test_sslvertol.t
@@ -53,24 +53,36 @@
 # Hudson (<A HREF="../../../mailman/listinfo/openssl-commits.html">tjh at cryptsoft.com</A>).
 
 use strict;
+use OpenSSL::Test qw/:DEFAULT cmdstr top_file top_dir/;
 use TLSProxy::Proxy;
 
+my $test_name = &quot;test_sslextension&quot;;
+setup($test_name);
+
+plan skip_all =&gt; &quot;$test_name can only be performed with OpenSSL configured shared&quot;
+    unless (map { chomp; s/^SHARED_LIBS=\s*//; $_ }
+	    grep { /^SHARED_LIBS=/ }
+	    do { local @ARGV = ( top_file(&quot;Makefile&quot;) ); &lt;&gt; })[0] ne &quot;&quot;;
+
+$ENV{OPENSSL_ENGINES} = top_dir(&quot;engines&quot;);
+$ENV{OPENSSL_ia32cap} = '~0x200000200000000';
 my $proxy = TLSProxy::Proxy-&gt;new(
     \&amp;vers_tolerance_filter,
-    @ARGV
+    cmdstr(app([&quot;openssl&quot;])),
+    top_file(&quot;apps&quot;, &quot;server.pem&quot;)
 );
 
+plan tests =&gt; 2;
+
 #Test 1: Asking for TLS1.3 should pass
 my $client_version = TLSProxy::Record::VERS_TLS_1_3;
 $proxy-&gt;start();
-TLSProxy::Message-&gt;success or die &quot;FAILED: Version tolerance test\n&quot;;
+ok(TLSProxy::Message-&gt;success(), &quot;Version tolerance test, TLS 1.3&quot;);
 
 #Test 2: Testing something below SSLv3 should fail
 $client_version = TLSProxy::Record::VERS_SSL_3_0 - 1;
 $proxy-&gt;restart();
-TLSProxy::Message-&gt;success and die &quot;FAILED: Version tolerance test\n&quot;;
-
-print &quot;SUCCESS: Version tolerance test\n&quot;;
+ok(TLSProxy::Message-&gt;fail(), &quot;Version tolerance test, SSL &lt; 3.0&quot;);
 
 sub vers_tolerance_filter
 {
diff --git a/test/recipes/70-test_verify_extra.t b/test/recipes/70-test_verify_extra.t
new file mode 100644
index 0000000..3ef4a27
--- /dev/null
+++ b/test/recipes/70-test_verify_extra.t
@@ -0,0 +1,5 @@
+#! /usr/bin/perl
+
+use OpenSSL::Test::Simple;
+
+simple_test(&quot;test_verify_extra&quot;, &quot;verify_extra_test&quot;);
diff --git a/test/recipes/80-test_ca.t b/test/recipes/80-test_ca.t
new file mode 100644
index 0000000..f57fb3c
--- /dev/null
+++ b/test/recipes/80-test_ca.t
@@ -0,0 +1,54 @@
+#! /usr/bin/perl
+
+use strict;
+use warnings;
+
+use POSIX;
+use File::Spec::Functions qw/splitdir curdir catfile devnull/;
+use File::Path 2.00 qw/remove_tree/;
+use OpenSSL::Test qw/:DEFAULT cmdstr top_file quotify/;
+
+setup(&quot;test_ca&quot;);
+
+my $perl = $^X;
+$ENV{OPENSSL} = cmdstr(app([&quot;openssl&quot;]));
+my $CA_pl = top_file(&quot;apps&quot;, &quot;CA.pl&quot;);
+my $std_openssl_cnf = top_file(&quot;apps&quot;, &quot;openssl.cnf&quot;);
+
+($perl) = quotify($perl) unless $^O eq &quot;VMS&quot;; # never quotify a command on VMS. Ever!
+
+remove_tree(&quot;demoCA&quot;, { safe =&gt; 0 });
+
+plan tests =&gt; 4;
+ SKIP: {
+     $ENV{SSLEAY_CONFIG} = &quot;-config &quot;.top_file(&quot;test&quot;, &quot;CAss.cnf&quot;);
+     skip &quot;failed creating CA structure&quot;, 3
+	 if !is(system(&quot;$perl &quot;.$CA_pl.&quot; -newca &lt; &quot;.devnull().&quot; 2&gt;&amp;1&quot;), 0,
+		'creating CA structure');
+
+     $ENV{SSLEAY_CONFIG} = &quot;-config &quot;.top_file(&quot;test&quot;, &quot;Uss.cnf&quot;);
+     skip &quot;failed creating new certificate request&quot;, 2
+	 if !is(system(&quot;$perl &quot;.$CA_pl.&quot; -newreq 2&gt;&amp;1&quot;), 0,
+		'creating new certificate request');
+
+     $ENV{SSLEAY_CONFIG} = &quot;-config &quot;.$std_openssl_cnf;
+     skip &quot;failed to sign certificate request&quot;, 1
+	 if !is(yes(&quot;$perl &quot;.$CA_pl.&quot; -sign 2&gt;&amp;1&quot;), 0,
+		'signing certificate request');
+
+     is(system(&quot;$perl &quot;.$CA_pl.&quot; -verify newcert.pem 2&gt;&amp;1&quot;), 0,
+	'verifying new certificate');
+}
+
+
+remove_tree(&quot;demoCA&quot;, { safe =&gt; 0 });
+unlink &quot;newcert.pem&quot;, &quot;newreq.pem&quot;;
+
+
+sub yes {
+    open(PIPE, &quot;|-&quot;, join(&quot; &quot;<A HREF="../../../mailman/listinfo/openssl-commits.html">, at _</A>));
+    local $SIG{PIPE} = &quot;IGNORE&quot;;
+    1 while print PIPE &quot;y\n&quot;;
+    close PIPE;
+    return 0;
+}
diff --git a/test/recipes/80-test_cms.t b/test/recipes/80-test_cms.t
new file mode 100644
index 0000000..cc2786f
--- /dev/null
+++ b/test/recipes/80-test_cms.t
@@ -0,0 +1,476 @@
+#! /usr/bin/perl
+
+use strict;
+use warnings;
+
+use POSIX;
+use File::Spec::Functions qw/catfile/;
+use File::Compare qw/compare_text/;
+use OpenSSL::Test qw/:DEFAULT top_dir top_file/;
+
+setup(&quot;test_cms&quot;);
+
+my $smdir    = top_dir(&quot;test&quot;, &quot;smime-certs&quot;);
+my $smcont   = top_file(&quot;test&quot;, &quot;smcont.txt&quot;);
+my $no_ec    = run(app([&quot;openssl&quot;, &quot;no-ec&quot;], stdout =&gt; undef));
+my $no_ec2m  = run(app([&quot;openssl&quot;, &quot;no-ec2m&quot;], stdout =&gt; undef));
+my $no_ecdh  = run(app([&quot;openssl&quot;, &quot;no-ecdh&quot;], stdout =&gt; undef));
+
+plan tests =&gt; 4;
+
+my @smime_pkcs7_tests = (
+
+    [ &quot;signed content DER format, RSA key&quot;,
+      [ &quot;-sign&quot;, &quot;-in&quot;, $smcont, &quot;-outform&quot;, &quot;DER&quot;, &quot;-nodetach&quot;,
+	&quot;-certfile&quot;, catfile($smdir, &quot;smroot.pem&quot;),
+	&quot;-signer&quot;, catfile($smdir, &quot;smrsa1.pem&quot;), &quot;-out&quot;, &quot;test.cms&quot; ],
+      [ &quot;-verify&quot;, &quot;-in&quot;, &quot;test.cms&quot;, &quot;-inform&quot;, &quot;DER&quot;,
+	&quot;-CAfile&quot;, catfile($smdir, &quot;smroot.pem&quot;), &quot;-out&quot;, &quot;smtst.txt&quot; ]
+    ],
+
+    [ &quot;signed detached content DER format, RSA key&quot;,
+      [ &quot;-sign&quot;, &quot;-in&quot;, $smcont, &quot;-outform&quot;, &quot;DER&quot;,
+	&quot;-signer&quot;, catfile($smdir, &quot;smrsa1.pem&quot;), &quot;-out&quot;, &quot;test.cms&quot; ],
+      [ &quot;-verify&quot;, &quot;-in&quot;, &quot;test.cms&quot;, &quot;-inform&quot;, &quot;DER&quot;,
+	&quot;-CAfile&quot;, catfile($smdir, &quot;smroot.pem&quot;), &quot;-out&quot;, &quot;smtst.txt&quot;,
+	&quot;-content&quot;, $smcont ]
+    ],
+
+    [ &quot;signed content test streaming BER format, RSA&quot;,
+      [ &quot;-sign&quot;, &quot;-in&quot;, $smcont, &quot;-outform&quot;, &quot;DER&quot;, &quot;-nodetach&quot;,
+	&quot;-stream&quot;,
+	&quot;-signer&quot;, catfile($smdir, &quot;smrsa1.pem&quot;), &quot;-out&quot;, &quot;test.cms&quot; ],
+      [ &quot;-verify&quot;, &quot;-in&quot;, &quot;test.cms&quot;, &quot;-inform&quot;, &quot;DER&quot;,
+	&quot;-CAfile&quot;, catfile($smdir, &quot;smroot.pem&quot;), &quot;-out&quot;, &quot;smtst.txt&quot; ]
+    ],
+
+    [ &quot;signed content DER format, DSA key&quot;,
+      [ &quot;-sign&quot;, &quot;-in&quot;, $smcont, &quot;-outform&quot;, &quot;DER&quot;, &quot;-nodetach&quot;,
+	&quot;-signer&quot;, catfile($smdir, &quot;smdsa1.pem&quot;), &quot;-out&quot;, &quot;test.cms&quot; ],
+      [ &quot;-verify&quot;, &quot;-in&quot;, &quot;test.cms&quot;, &quot;-inform&quot;, &quot;DER&quot;,
+	&quot;-CAfile&quot;, catfile($smdir, &quot;smroot.pem&quot;), &quot;-out&quot;, &quot;smtst.txt&quot; ]
+    ],
+
+    [ &quot;signed detached content DER format, DSA key&quot;,
+      [ &quot;-sign&quot;, &quot;-in&quot;, $smcont, &quot;-outform&quot;, &quot;DER&quot;,
+	&quot;-signer&quot;, catfile($smdir, &quot;smdsa1.pem&quot;), &quot;-out&quot;, &quot;test.cms&quot; ],
+      [ &quot;-verify&quot;, &quot;-in&quot;, &quot;test.cms&quot;, &quot;-inform&quot;, &quot;DER&quot;,
+	&quot;-CAfile&quot;, catfile($smdir, &quot;smroot.pem&quot;), &quot;-out&quot;, &quot;smtst.txt&quot;,
+	&quot;-content&quot;, $smcont ]
+    ],
+
+    [ &quot;signed detached content DER format, add RSA signer&quot;,
+      [ &quot;-resign&quot;, &quot;-inform&quot;, &quot;DER&quot;, &quot;-in&quot;, &quot;test.cms&quot;, &quot;-outform&quot;, &quot;DER&quot;,
+	&quot;-signer&quot;, catfile($smdir, &quot;smrsa1.pem&quot;), &quot;-out&quot;, &quot;test2.cms&quot; ],
+      [ &quot;-verify&quot;, &quot;-in&quot;, &quot;test2.cms&quot;, &quot;-inform&quot;, &quot;DER&quot;,
+	&quot;-CAfile&quot;, catfile($smdir, &quot;smroot.pem&quot;), &quot;-out&quot;, &quot;smtst.txt&quot;,
+	&quot;-content&quot;, $smcont ]
+    ],
+
+    [ &quot;signed content test streaming BER format, DSA key&quot;,
+      [ &quot;-sign&quot;, &quot;-in&quot;, $smcont, &quot;-outform&quot;, &quot;DER&quot;, &quot;-nodetach&quot;,
+	&quot;-stream&quot;,
+	&quot;-signer&quot;, catfile($smdir, &quot;smdsa1.pem&quot;), &quot;-out&quot;, &quot;test.cms&quot; ],
+      [ &quot;-verify&quot;, &quot;-in&quot;, &quot;test.cms&quot;, &quot;-inform&quot;, &quot;DER&quot;,
+	&quot;-CAfile&quot;, catfile($smdir, &quot;smroot.pem&quot;), &quot;-out&quot;, &quot;smtst.txt&quot; ]
+    ],
+
+    [ &quot;signed content test streaming BER format, 2 DSA and 2 RSA keys&quot;,
+      [ &quot;-sign&quot;, &quot;-in&quot;, $smcont, &quot;-outform&quot;, &quot;DER&quot;, &quot;-nodetach&quot;,
+	&quot;-signer&quot;, catfile($smdir, &quot;smrsa1.pem&quot;),
+	&quot;-signer&quot;, catfile($smdir, &quot;smrsa2.pem&quot;),
+	&quot;-signer&quot;, catfile($smdir, &quot;smdsa1.pem&quot;),
+	&quot;-signer&quot;, catfile($smdir, &quot;smdsa2.pem&quot;),
+	&quot;-stream&quot;, &quot;-out&quot;, &quot;test.cms&quot; ],
+      [ &quot;-verify&quot;, &quot;-in&quot;, &quot;test.cms&quot;, &quot;-inform&quot;, &quot;DER&quot;,
+	&quot;-CAfile&quot;, catfile($smdir, &quot;smroot.pem&quot;), &quot;-out&quot;, &quot;smtst.txt&quot; ]
+    ],
+
+    [ &quot;signed content test streaming BER format, 2 DSA and 2 RSA keys, no attributes&quot;,
+      [ &quot;-sign&quot;, &quot;-in&quot;, $smcont, &quot;-outform&quot;, &quot;DER&quot;, &quot;-noattr&quot;, &quot;-nodetach&quot;,
+	&quot;-signer&quot;, catfile($smdir, &quot;smrsa1.pem&quot;),
+	&quot;-signer&quot;, catfile($smdir, &quot;smrsa2.pem&quot;),
+	&quot;-signer&quot;, catfile($smdir, &quot;smdsa1.pem&quot;),
+	&quot;-signer&quot;, catfile($smdir, &quot;smdsa2.pem&quot;),
+	&quot;-stream&quot;, &quot;-out&quot;, &quot;test.cms&quot; ],
+      [ &quot;-verify&quot;, &quot;-in&quot;, &quot;test.cms&quot;, &quot;-inform&quot;, &quot;DER&quot;,
+	&quot;-CAfile&quot;, catfile($smdir, &quot;smroot.pem&quot;), &quot;-out&quot;, &quot;smtst.txt&quot; ]
+    ],
+
+    [ &quot;signed content test streaming S/MIME format, 2 DSA and 2 RSA keys&quot;,
+      [ &quot;-sign&quot;, &quot;-in&quot;, $smcont, &quot;-nodetach&quot;,
+	&quot;-signer&quot;, catfile($smdir, &quot;smrsa1.pem&quot;),
+	&quot;-signer&quot;, catfile($smdir, &quot;smrsa2.pem&quot;),
+	&quot;-signer&quot;, catfile($smdir, &quot;smdsa1.pem&quot;),
+	&quot;-signer&quot;, catfile($smdir, &quot;smdsa2.pem&quot;),
+	&quot;-stream&quot;, &quot;-out&quot;, &quot;test.cms&quot; ],
+      [ &quot;-verify&quot;, &quot;-in&quot;, &quot;test.cms&quot;,
+	&quot;-CAfile&quot;, catfile($smdir, &quot;smroot.pem&quot;), &quot;-out&quot;, &quot;smtst.txt&quot; ]
+    ],
+
+    [ &quot;signed content test streaming multipart S/MIME format, 2 DSA and 2 RSA keys&quot;,
+      [ &quot;-sign&quot;, &quot;-in&quot;, $smcont,
+	&quot;-signer&quot;, catfile($smdir, &quot;smrsa1.pem&quot;),
+	&quot;-signer&quot;, catfile($smdir, &quot;smrsa2.pem&quot;),
+	&quot;-signer&quot;, catfile($smdir, &quot;smdsa1.pem&quot;),
+	&quot;-signer&quot;, catfile($smdir, &quot;smdsa2.pem&quot;),
+	&quot;-stream&quot;, &quot;-out&quot;, &quot;test.cms&quot; ],
+      [ &quot;-verify&quot;, &quot;-in&quot;, &quot;test.cms&quot;,
+	&quot;-CAfile&quot;, catfile($smdir, &quot;smroot.pem&quot;), &quot;-out&quot;, &quot;smtst.txt&quot; ]
+    ],
+
+    [ &quot;enveloped content test streaming S/MIME format, 3 recipients&quot;,
+      [ &quot;-encrypt&quot;, &quot;-in&quot;, $smcont,
+	&quot;-stream&quot;, &quot;-out&quot;, &quot;test.cms&quot;,
+	catfile($smdir, &quot;smrsa1.pem&quot;),
+	catfile($smdir, &quot;smrsa2.pem&quot;),
+	catfile($smdir, &quot;smrsa3.pem&quot;) ],
+      [ &quot;-decrypt&quot;, &quot;-recip&quot;, catfile($smdir, &quot;smrsa1.pem&quot;),
+	&quot;-in&quot;, &quot;test.cms&quot;, &quot;-out&quot;, &quot;smtst.txt&quot; ]
+    ],
+
+    [ &quot;enveloped content test streaming S/MIME format, 3 recipients, 3rd used&quot;,
+      [ &quot;-encrypt&quot;, &quot;-in&quot;, $smcont,
+	&quot;-stream&quot;, &quot;-out&quot;, &quot;test.cms&quot;,
+	catfile($smdir, &quot;smrsa1.pem&quot;),
+	catfile($smdir, &quot;smrsa2.pem&quot;),
+	catfile($smdir, &quot;smrsa3.pem&quot;) ],
+      [ &quot;-decrypt&quot;, &quot;-recip&quot;, catfile($smdir, &quot;smrsa3.pem&quot;),
+	&quot;-in&quot;, &quot;test.cms&quot;, &quot;-out&quot;, &quot;smtst.txt&quot; ]
+    ],
+
+    [ &quot;enveloped content test streaming S/MIME format, 3 recipients, key only used&quot;,
+      [ &quot;-encrypt&quot;, &quot;-in&quot;, $smcont,
+	&quot;-stream&quot;, &quot;-out&quot;, &quot;test.cms&quot;,
+	catfile($smdir, &quot;smrsa1.pem&quot;),
+	catfile($smdir, &quot;smrsa2.pem&quot;),
+	catfile($smdir, &quot;smrsa3.pem&quot;) ],
+      [ &quot;-decrypt&quot;, &quot;-inkey&quot;, catfile($smdir, &quot;smrsa3.pem&quot;),
+	&quot;-in&quot;, &quot;test.cms&quot;, &quot;-out&quot;, &quot;smtst.txt&quot; ]
+    ],
+
+    [ &quot;enveloped content test streaming S/MIME format, AES-256 cipher, 3 recipients&quot;,
+      [ &quot;-encrypt&quot;, &quot;-in&quot;, $smcont,
+	&quot;-aes256&quot;, &quot;-stream&quot;, &quot;-out&quot;, &quot;test.cms&quot;,
+	catfile($smdir, &quot;smrsa1.pem&quot;),
+	catfile($smdir, &quot;smrsa2.pem&quot;),
+	catfile($smdir, &quot;smrsa3.pem&quot;) ],
+      [ &quot;-decrypt&quot;, &quot;-recip&quot;, catfile($smdir, &quot;smrsa1.pem&quot;),
+	&quot;-in&quot;, &quot;test.cms&quot;, &quot;-out&quot;, &quot;smtst.txt&quot; ]
+    ],
+
+);
+
+my @smime_cms_tests = (
+
+    [ &quot;signed content test streaming BER format, 2 DSA and 2 RSA keys, keyid&quot;,
+      [ &quot;-sign&quot;, &quot;-in&quot;, $smcont, &quot;-outform&quot;, &quot;DER&quot;, &quot;-nodetach&quot;, &quot;-keyid&quot;,
+	&quot;-signer&quot;, catfile($smdir, &quot;smrsa1.pem&quot;),
+	&quot;-signer&quot;, catfile($smdir, &quot;smrsa2.pem&quot;),
+	&quot;-signer&quot;, catfile($smdir, &quot;smdsa1.pem&quot;),
+	&quot;-signer&quot;, catfile($smdir, &quot;smdsa2.pem&quot;),
+	&quot;-stream&quot;, &quot;-out&quot;, &quot;test.cms&quot; ],
+      [ &quot;-verify&quot;, &quot;-in&quot;, &quot;test.cms&quot;, &quot;-inform&quot;, &quot;DER&quot;,
+	&quot;-CAfile&quot;, catfile($smdir, &quot;smroot.pem&quot;), &quot;-out&quot;, &quot;smtst.txt&quot; ]
+    ],
+
+    [ &quot;signed content test streaming PEM format, 2 DSA and 2 RSA keys&quot;,
+      [ &quot;-sign&quot;, &quot;-in&quot;, $smcont, &quot;-outform&quot;, &quot;PEM&quot;, &quot;-nodetach&quot;,
+	&quot;-signer&quot;, catfile($smdir, &quot;smrsa1.pem&quot;),
+	&quot;-signer&quot;, catfile($smdir, &quot;smrsa2.pem&quot;),
+	&quot;-signer&quot;, catfile($smdir, &quot;smdsa1.pem&quot;),
+	&quot;-signer&quot;, catfile($smdir, &quot;smdsa2.pem&quot;),
+	&quot;-stream&quot;, &quot;-out&quot;, &quot;test.cms&quot; ],
+      [ &quot;-verify&quot;, &quot;-in&quot;, &quot;test.cms&quot;, &quot;-inform&quot;, &quot;PEM&quot;,
+	&quot;-CAfile&quot;, catfile($smdir, &quot;smroot.pem&quot;), &quot;-out&quot;, &quot;smtst.txt&quot; ]
+    ],
+
+    [ &quot;signed content MIME format, RSA key, signed receipt request&quot;,
+      [ &quot;-sign&quot;, &quot;-in&quot;, $smcont, &quot;-signer&quot;, catfile($smdir, &quot;smrsa1.pem&quot;), &quot;-nodetach&quot;,
+	&quot;-receipt_request_to&quot;, &quot;test\@openssl.org&quot;, &quot;-receipt_request_all&quot;,
+	&quot;-out&quot;, &quot;test.cms&quot; ],
+      [ &quot;-verify&quot;, &quot;-in&quot;, &quot;test.cms&quot;,
+	&quot;-CAfile&quot;, catfile($smdir, &quot;smroot.pem&quot;), &quot;-out&quot;, &quot;smtst.txt&quot; ]
+    ],
+
+    [ &quot;signed receipt MIME format, RSA key&quot;,
+      [ &quot;-sign_receipt&quot;, &quot;-in&quot;, &quot;test.cms&quot;,
+	&quot;-signer&quot;, catfile($smdir, &quot;smrsa2.pem&quot;),
+	&quot;-out&quot;, &quot;test2.cms&quot; ],
+      [ &quot;-verify_receipt&quot;, &quot;test2.cms&quot;, &quot;-in&quot;, &quot;test.cms&quot;,
+	&quot;-CAfile&quot;, catfile($smdir, &quot;smroot.pem&quot;) ]
+    ],
+
+    [ &quot;enveloped content test streaming S/MIME format, 3 recipients, keyid&quot;,
+      [ &quot;-encrypt&quot;, &quot;-in&quot;, $smcont,
+	&quot;-stream&quot;, &quot;-out&quot;, &quot;test.cms&quot;, &quot;-keyid&quot;,
+	catfile($smdir, &quot;smrsa1.pem&quot;),
+	catfile($smdir, &quot;smrsa2.pem&quot;),
+	catfile($smdir, &quot;smrsa3.pem&quot;) ],
+      [ &quot;-decrypt&quot;, &quot;-recip&quot;, catfile($smdir, &quot;smrsa1.pem&quot;),
+	&quot;-in&quot;, &quot;test.cms&quot;, &quot;-out&quot;, &quot;smtst.txt&quot; ]
+    ],
+
+    [ &quot;enveloped content test streaming PEM format, KEK&quot;,
+      [ &quot;-encrypt&quot;, &quot;-in&quot;, $smcont, &quot;-outform&quot;, &quot;PEM&quot;, &quot;-aes128&quot;,
+	&quot;-stream&quot;, &quot;-out&quot;, &quot;test.cms&quot;,
+	&quot;-secretkey&quot;, &quot;000102030405060708090A0B0C0D0E0F&quot;,
+	&quot;-secretkeyid&quot;, &quot;C0FEE0&quot; ],
+      [ &quot;-decrypt&quot;, &quot;-in&quot;, &quot;test.cms&quot;, &quot;-out&quot;, &quot;smtst.txt&quot;, &quot;-inform&quot;, &quot;PEM&quot;,
+	&quot;-secretkey&quot;, &quot;000102030405060708090A0B0C0D0E0F&quot;,
+	&quot;-secretkeyid&quot;, &quot;C0FEE0&quot; ]
+    ],
+
+    [ &quot;enveloped content test streaming PEM format, KEK, key only&quot;,
+      [ &quot;-encrypt&quot;, &quot;-in&quot;, $smcont, &quot;-outform&quot;, &quot;PEM&quot;, &quot;-aes128&quot;,
+	&quot;-stream&quot;, &quot;-out&quot;, &quot;test.cms&quot;,
+	&quot;-secretkey&quot;, &quot;000102030405060708090A0B0C0D0E0F&quot;,
+	&quot;-secretkeyid&quot;, &quot;C0FEE0&quot; ],
+      [ &quot;-decrypt&quot;, &quot;-in&quot;, &quot;test.cms&quot;, &quot;-out&quot;, &quot;smtst.txt&quot;, &quot;-inform&quot;, &quot;PEM&quot;,
+	&quot;-secretkey&quot;, &quot;000102030405060708090A0B0C0D0E0F&quot; ]
+    ],
+
+    [ &quot;data content test streaming PEM format&quot;,
+      [ &quot;-data_create&quot;, &quot;-in&quot;, $smcont, &quot;-outform&quot;, &quot;PEM&quot;, &quot;-nodetach&quot;,
+	&quot;-stream&quot;, &quot;-out&quot;, &quot;test.cms&quot; ],
+      [ &quot;-data_out&quot;, &quot;-in&quot;, &quot;test.cms&quot;, &quot;-inform&quot;, &quot;PEM&quot;, &quot;-out&quot;, &quot;smtst.txt&quot; ]
+    ],
+
+    [ &quot;encrypted content test streaming PEM format, 128 bit RC2 key&quot;,
+      [ &quot;-EncryptedData_encrypt&quot;, &quot;-in&quot;, $smcont, &quot;-outform&quot;, &quot;PEM&quot;,
+	&quot;-rc2&quot;, &quot;-secretkey&quot;, &quot;000102030405060708090A0B0C0D0E0F&quot;,
+	&quot;-stream&quot;, &quot;-out&quot;, &quot;test.cms&quot; ],
+      [ &quot;-EncryptedData_decrypt&quot;, &quot;-in&quot;, &quot;test.cms&quot;, &quot;-inform&quot;, &quot;PEM&quot;,
+	&quot;-secretkey&quot;, &quot;000102030405060708090A0B0C0D0E0F&quot;, &quot;-out&quot;, &quot;smtst.txt&quot; ]
+    ],
+
+    [ &quot;encrypted content test streaming PEM format, 40 bit RC2 key&quot;,
+      [ &quot;-EncryptedData_encrypt&quot;, &quot;-in&quot;, $smcont, &quot;-outform&quot;, &quot;PEM&quot;,
+	&quot;-rc2&quot;, &quot;-secretkey&quot;, &quot;0001020304&quot;,
+	&quot;-stream&quot;, &quot;-out&quot;, &quot;test.cms&quot; ],
+      [ &quot;-EncryptedData_decrypt&quot;, &quot;-in&quot;, &quot;test.cms&quot;, &quot;-inform&quot;, &quot;PEM&quot;,
+	&quot;-secretkey&quot;, &quot;0001020304&quot;, &quot;-out&quot;, &quot;smtst.txt&quot; ]
+    ],
+
+    [ &quot;encrypted content test streaming PEM format, triple DES key&quot;,
+      [ &quot;-EncryptedData_encrypt&quot;, &quot;-in&quot;, $smcont, &quot;-outform&quot;, &quot;PEM&quot;,
+	&quot;-des3&quot;, &quot;-secretkey&quot;, &quot;000102030405060708090A0B0C0D0E0F1011121314151617&quot;,
+	&quot;-stream&quot;, &quot;-out&quot;, &quot;test.cms&quot; ],
+      [ &quot;-EncryptedData_decrypt&quot;, &quot;-in&quot;, &quot;test.cms&quot;, &quot;-inform&quot;, &quot;PEM&quot;,
+	&quot;-secretkey&quot;, &quot;000102030405060708090A0B0C0D0E0F1011121314151617&quot;,
+	&quot;-out&quot;, &quot;smtst.txt&quot; ]
+    ],
+
+    [ &quot;encrypted content test streaming PEM format, 128 bit AES key&quot;,
+      [ &quot;-EncryptedData_encrypt&quot;, &quot;-in&quot;, $smcont, &quot;-outform&quot;, &quot;PEM&quot;,
+	&quot;-aes128&quot;, &quot;-secretkey&quot;, &quot;000102030405060708090A0B0C0D0E0F&quot;,
+	&quot;-stream&quot;, &quot;-out&quot;, &quot;test.cms&quot; ],
+      [ &quot;-EncryptedData_decrypt&quot;, &quot;-in&quot;, &quot;test.cms&quot;, &quot;-inform&quot;, &quot;PEM&quot;,
+	&quot;-secretkey&quot;, &quot;000102030405060708090A0B0C0D0E0F&quot;, &quot;-out&quot;, &quot;smtst.txt&quot; ]
+    ],
+
+);
+
+my @smime_cms_comp_tests = (
+
+    [ &quot;compressed content test streaming PEM format&quot;,
+      [ &quot;-compress&quot;, &quot;-in&quot;, $smcont, &quot;-outform&quot;, &quot;PEM&quot;, &quot;-nodetach&quot;,
+	&quot;-stream&quot;, &quot;-out&quot;, &quot;test.cms&quot; ],
+      [ &quot;-uncompress&quot;, &quot;-in&quot;, &quot;test.cms&quot;, &quot;-inform&quot;, &quot;PEM&quot;, &quot;-out&quot;, &quot;smtst.txt&quot; ]
+    ]
+
+);
+
+my @smime_cms_param_tests = (
+    [ &quot;signed content test streaming PEM format, RSA keys, PSS signature&quot;,
+      [ &quot;-sign&quot;, &quot;-in&quot;, $smcont, &quot;-outform&quot;, &quot;PEM&quot;, &quot;-nodetach&quot;,
+	&quot;-signer&quot;, catfile($smdir, &quot;smrsa1.pem&quot;), &quot;-keyopt&quot;, &quot;rsa_padding_mode:pss&quot;,
+	&quot;-out&quot;, &quot;test.cms&quot; ],
+      [ &quot;-verify&quot;, &quot;-in&quot;, &quot;test.cms&quot;, &quot;-inform&quot;, &quot;PEM&quot;,
+	&quot;-CAfile&quot;, catfile($smdir, &quot;smroot.pem&quot;), &quot;-out&quot;, &quot;smtst.txt&quot; ]
+    ],
+
+    [ &quot;signed content test streaming PEM format, RSA keys, PSS signature, no attributes&quot;,
+      [ &quot;-sign&quot;, &quot;-in&quot;, $smcont, &quot;-outform&quot;, &quot;PEM&quot;, &quot;-nodetach&quot;, &quot;-noattr&quot;,
+	&quot;-signer&quot;, catfile($smdir, &quot;smrsa1.pem&quot;), &quot;-keyopt&quot;, &quot;rsa_padding_mode:pss&quot;,
+	&quot;-out&quot;, &quot;test.cms&quot; ],
+      [ &quot;-verify&quot;, &quot;-in&quot;, &quot;test.cms&quot;, &quot;-inform&quot;, &quot;PEM&quot;,
+	&quot;-CAfile&quot;, catfile($smdir, &quot;smroot.pem&quot;), &quot;-out&quot;, &quot;smtst.txt&quot; ]
+    ],
+
+    [ &quot;signed content test streaming PEM format, RSA keys, PSS signature, SHA384 MGF1&quot;,
+      [ &quot;-sign&quot;, &quot;-in&quot;, $smcont, &quot;-outform&quot;, &quot;PEM&quot;, &quot;-nodetach&quot;,
+	&quot;-signer&quot;, catfile($smdir, &quot;smrsa1.pem&quot;), &quot;-keyopt&quot;, &quot;rsa_padding_mode:pss&quot;,
+	&quot;-keyopt&quot;, &quot;rsa_mgf1_md:sha384&quot;, &quot;-out&quot;, &quot;test.cms&quot; ],
+      [ &quot;-verify&quot;, &quot;-in&quot;, &quot;test.cms&quot;, &quot;-inform&quot;, &quot;PEM&quot;,
+	&quot;-CAfile&quot;, catfile($smdir, &quot;smroot.pem&quot;), &quot;-out&quot;, &quot;smtst.txt&quot; ]
+    ],
+
+    [ &quot;enveloped content test streaming S/MIME format, OAEP default parameters&quot;,
+      [ &quot;-encrypt&quot;, &quot;-in&quot;, $smcont,
+	&quot;-stream&quot;, &quot;-out&quot;, &quot;test.cms&quot;,
+	&quot;-recip&quot;, catfile($smdir, &quot;smrsa1.pem&quot;), &quot;-keyopt&quot;, &quot;rsa_padding_mode:oaep&quot; ],
+      [ &quot;-decrypt&quot;, &quot;-recip&quot;, catfile($smdir, &quot;smrsa1.pem&quot;),
+	&quot;-in&quot;, &quot;test.cms&quot;, &quot;-out&quot;, &quot;smtst.txt&quot; ]
+    ],
+
+    [ &quot;enveloped content test streaming S/MIME format, OAEP SHA256&quot;,
+      [ &quot;-encrypt&quot;, &quot;-in&quot;, $smcont,
+	&quot;-stream&quot;, &quot;-out&quot;, &quot;test.cms&quot;,
+	&quot;-recip&quot;, catfile($smdir, &quot;smrsa1.pem&quot;), &quot;-keyopt&quot;, &quot;rsa_padding_mode:oaep&quot;,
+	&quot;-keyopt&quot;, &quot;rsa_oaep_md:sha256&quot; ],
+      [ &quot;-decrypt&quot;, &quot;-recip&quot;, catfile($smdir, &quot;smrsa1.pem&quot;),
+	&quot;-in&quot;, &quot;test.cms&quot;, &quot;-out&quot;, &quot;smtst.txt&quot; ]
+    ],
+
+    [ &quot;enveloped content test streaming S/MIME format, ECDH&quot;,
+      [ &quot;-encrypt&quot;, &quot;-in&quot;, $smcont,
+	&quot;-stream&quot;, &quot;-out&quot;, &quot;test.cms&quot;,
+	&quot;-recip&quot;, catfile($smdir, &quot;smec1.pem&quot;) ],
+      [ &quot;-decrypt&quot;, &quot;-recip&quot;, catfile($smdir, &quot;smec1.pem&quot;),
+	&quot;-in&quot;, &quot;test.cms&quot;, &quot;-out&quot;, &quot;smtst.txt&quot; ]
+    ],
+
+    [ &quot;enveloped content test streaming S/MIME format, ECDH, key identifier&quot;,
+      [ &quot;-encrypt&quot;, &quot;-keyid&quot;, &quot;-in&quot;, $smcont,
+	&quot;-stream&quot;, &quot;-out&quot;, &quot;test.cms&quot;,
+	&quot;-recip&quot;, catfile($smdir, &quot;smec1.pem&quot;) ],
+      [ &quot;-decrypt&quot;, &quot;-recip&quot;, catfile($smdir, &quot;smec1.pem&quot;),
+	&quot;-in&quot;, &quot;test.cms&quot;, &quot;-out&quot;, &quot;smtst.txt&quot; ]
+    ],
+
+    [ &quot;enveloped content test streaming S/MIME format, ECDH, AES128, SHA256 KDF&quot;,
+      [ &quot;-encrypt&quot;, &quot;-in&quot;, $smcont,
+	&quot;-stream&quot;, &quot;-out&quot;, &quot;test.cms&quot;,
+	&quot;-recip&quot;, catfile($smdir, &quot;smec1.pem&quot;), &quot;-aes128&quot;, &quot;-keyopt&quot;, &quot;ecdh_kdf_md:sha256&quot; ],
+      [ &quot;-decrypt&quot;, &quot;-recip&quot;, catfile($smdir, &quot;smec1.pem&quot;),
+	&quot;-in&quot;, &quot;test.cms&quot;, &quot;-out&quot;, &quot;smtst.txt&quot; ]
+    ],
+
+    [ &quot;enveloped content test streaming S/MIME format, ECDH, K-283, cofactor DH&quot;,
+      [ &quot;-encrypt&quot;, &quot;-in&quot;, $smcont,
+	&quot;-stream&quot;, &quot;-out&quot;, &quot;test.cms&quot;,
+	&quot;-recip&quot;, catfile($smdir, &quot;smec2.pem&quot;), &quot;-aes128&quot;,
+	&quot;-keyopt&quot;, &quot;ecdh_kdf_md:sha256&quot;, &quot;-keyopt&quot;, &quot;ecdh_cofactor_mode:1&quot; ],
+      [ &quot;-decrypt&quot;, &quot;-recip&quot;, catfile($smdir, &quot;smec2.pem&quot;),
+	&quot;-in&quot;, &quot;test.cms&quot;, &quot;-out&quot;, &quot;smtst.txt&quot; ]
+    ],
+
+    [ &quot;enveloped content test streaming S/MIME format, X9.42 DH&quot;,
+      [ &quot;-encrypt&quot;, &quot;-in&quot;, $smcont,
+	&quot;-stream&quot;, &quot;-out&quot;, &quot;test.cms&quot;,
+	&quot;-recip&quot;, catfile($smdir, &quot;smdh.pem&quot;), &quot;-aes128&quot; ],
+      [ &quot;-decrypt&quot;, &quot;-recip&quot;, catfile($smdir, &quot;smdh.pem&quot;),
+	&quot;-in&quot;, &quot;test.cms&quot;, &quot;-out&quot;, &quot;smtst.txt&quot; ]
+    ]
+    );
+
+subtest &quot;CMS =&gt; PKCS#7 compatibility tests\n&quot; =&gt; sub {
+    plan tests =&gt; scalar @smime_pkcs7_tests;
+
+    foreach (@smime_pkcs7_tests) {
+      SKIP: {
+	  my $skip_reason = check_availability($$_[0]);
+	  skip $skip_reason, 1 if $skip_reason;
+
+	  ok(run(app([&quot;openssl&quot;, &quot;cms&quot;, @{$$_[1]}]))
+	     &amp;&amp; run(app([&quot;openssl&quot;, &quot;smime&quot;, @{$$_[2]}]))
+	     &amp;&amp; compare_text($smcont, &quot;smtst.txt&quot;) == 0,
+	     $$_[0]);
+	}
+    }
+};
+subtest &quot;CMS &lt;= PKCS#7 compatibility tests\n&quot; =&gt; sub {
+    plan tests =&gt; scalar @smime_pkcs7_tests;
+
+    foreach (@smime_pkcs7_tests) {
+      SKIP: {
+	  my $skip_reason = check_availability($$_[0]);
+	  skip $skip_reason, 1 if $skip_reason;
+
+	  ok(run(app([&quot;openssl&quot;, &quot;smime&quot;, @{$$_[1]}]))
+	     &amp;&amp; run(app([&quot;openssl&quot;, &quot;cms&quot;, @{$$_[2]}]))
+	     &amp;&amp; compare_text($smcont, &quot;smtst.txt&quot;) == 0,
+	     $$_[0]);
+	}
+    }
+};
+
+subtest &quot;CMS &lt;=&gt; CMS consistency tests\n&quot; =&gt; sub {
+    plan tests =&gt; (scalar @smime_pkcs7_tests) + (scalar @smime_cms_tests);
+
+    foreach (@smime_pkcs7_tests) {
+      SKIP: {
+	  my $skip_reason = check_availability($$_[0]);
+	  skip $skip_reason, 1 if $skip_reason;
+
+	  ok(run(app([&quot;openssl&quot;, &quot;cms&quot;, @{$$_[1]}]))
+	     &amp;&amp; run(app([&quot;openssl&quot;, &quot;cms&quot;, @{$$_[2]}]))
+	     &amp;&amp; compare_text($smcont, &quot;smtst.txt&quot;) == 0,
+	     $$_[0]);
+	}
+    }
+    foreach (@smime_cms_tests) {
+      SKIP: {
+	  my $skip_reason = check_availability($$_[0]);
+	  skip $skip_reason, 1 if $skip_reason;
+
+	  ok(run(app([&quot;openssl&quot;, &quot;cms&quot;, @{$$_[1]}]))
+	     &amp;&amp; run(app([&quot;openssl&quot;, &quot;cms&quot;, @{$$_[2]}]))
+	     &amp;&amp; compare_text($smcont, &quot;smtst.txt&quot;) == 0,
+	     $$_[0]);
+	}
+    }
+};
+
+subtest &quot;CMS &lt;=&gt; CMS consistency tests, modified key parameters\n&quot; =&gt; sub {
+    plan tests =&gt;
+	(scalar @smime_cms_param_tests) + (scalar @smime_cms_comp_tests);
+
+    foreach (@smime_cms_param_tests) {
+      SKIP: {
+	  my $skip_reason = check_availability($$_[0]);
+	  skip $skip_reason, 1 if $skip_reason;
+
+	  ok(run(app([&quot;openssl&quot;, &quot;cms&quot;, @{$$_[1]}]))
+	     &amp;&amp; run(app([&quot;openssl&quot;, &quot;cms&quot;, @{$$_[2]}]))
+	     &amp;&amp; compare_text($smcont, &quot;smtst.txt&quot;) == 0,
+	     $$_[0]);
+	}
+    }
+
+  SKIP: {
+      skip(&quot;Zlib not supported: compression tests skipped&quot;,
+	   scalar @smime_cms_comp_tests)
+	  unless grep /ZLIB/, run(app([&quot;openssl&quot;, &quot;version&quot;, &quot;-f&quot;]),
+				  capture =&gt; 1);
+
+      foreach (@smime_cms_param_tests) {
+	SKIP: {
+	    my $skip_reason = check_availability($$_[0]);
+	    skip $skip_reason, 1 if $skip_reason;
+
+	    ok(run(app([&quot;openssl&quot;, &quot;cms&quot;, @{$$_[1]}]))
+	       &amp;&amp; run(app([&quot;openssl&quot;, &quot;cms&quot;, @{$$_[2]}]))
+	       &amp;&amp; compare_text($smcont, &quot;smtst.txt&quot;) == 0,
+	       $$_[0]);
+	  }
+      }
+    }
+};
+
+unlink &quot;test.cms&quot;;
+unlink &quot;test2.cms&quot;;
+unlink &quot;smtst.txt&quot;;
+
+sub check_availability {
+    my $tnam = shift;
+
+    return &quot;$tnam: skipped, EC disabled\n&quot;
+	if ($no_ec &amp;&amp; $tnam =~ /ECDH/);
+    return &quot;$tnam: skipped, ECDH disabled\n&quot;
+	if ($no_ecdh &amp;&amp; $tnam =~ /ECDH/);
+    return &quot;$tnam: skipped, EC2M disabled\n&quot;
+	if ($no_ec2m &amp;&amp; $tnam =~ /K-283/);
+    return &quot;&quot;;
+}
diff --git a/test/recipes/80-test_ocsp.t b/test/recipes/80-test_ocsp.t
new file mode 100644
index 0000000..7d7c96e
--- /dev/null
+++ b/test/recipes/80-test_ocsp.t
@@ -0,0 +1,193 @@
+#! /usr/bin/perl
+
+use strict;
+use warnings;
+
+use POSIX;
+use File::Spec::Functions qw/devnull catfile/;
+use File::Copy;
+use OpenSSL::Test qw/:DEFAULT with pipe top_dir/;
+
+setup(&quot;test_ocsp&quot;);
+
+my $ocspdir=top_dir(&quot;test&quot;, &quot;ocsp-tests&quot;);
+# 17 December 2012 so we don't get certificate expiry errors.
+my @check_time=(&quot;-attime&quot;, &quot;1355875200&quot;);
+
+sub test_ocsp {
+    my $title = shift;
+    my $inputfile = shift;
+    my $CAfile = shift;
+    my $expected_exit = shift;
+
+    with({ exit_checker =&gt; sub { return shift == $expected_exit; } },
+	 sub { ok(run(pipe(app([&quot;openssl&quot;, &quot;base64&quot;, &quot;-d&quot;,
+				&quot;-in&quot;, catfile($ocspdir,$inputfile)]),
+			   app([&quot;openssl&quot;, &quot;ocsp&quot;, &quot;-respin&quot;, &quot;-&quot;,
+				&quot;-partial_chain&quot;, @check_time,
+				&quot;-CAfile&quot;, catfile($ocspdir, $CAfile),
+				&quot;-verify_other&quot;, catfile($ocspdir, $CAfile),
+				&quot;-CApath&quot;, devnull()]))),
+		  $title); });
+}
+
+plan tests =&gt; 10;
+
+subtest &quot;=== VALID OCSP RESPONSES ===&quot; =&gt; sub {
+    plan tests =&gt; 6;
+
+    test_ocsp(&quot;NON-DELEGATED; Intermediate CA -&gt; EE&quot;,
+	      &quot;ND1.ors&quot;, &quot;ND1_Issuer_ICA.pem&quot;, 0);
+    test_ocsp(&quot;NON-DELEGATED; Root CA -&gt; Intermediate CA&quot;,
+	      &quot;ND2.ors&quot;, &quot;ND2_Issuer_Root.pem&quot;, 0);
+    test_ocsp(&quot;NON-DELEGATED; Root CA -&gt; EE&quot;,
+	      &quot;ND3.ors&quot;, &quot;ND3_Issuer_Root.pem&quot;, 0);
+    test_ocsp(&quot;DELEGATED; Intermediate CA -&gt; EE&quot;,
+	      &quot;D1.ors&quot;, &quot;D1_Issuer_ICA.pem&quot;, 0);
+    test_ocsp(&quot;DELEGATED; Root CA -&gt; Intermediate CA&quot;,
+	      &quot;D2.ors&quot;, &quot;D2_Issuer_Root.pem&quot;, 0);
+    test_ocsp(&quot;DELEGATED; Root CA -&gt; EE&quot;,
+	      &quot;D3.ors&quot;, &quot;D3_Issuer_Root.pem&quot;, 0);
+};
+
+subtest &quot;=== INVALID SIGNATURE on the OCSP RESPONSE ===&quot; =&gt; sub {
+    plan tests =&gt; 6;
+
+    test_ocsp(&quot;NON-DELEGATED; Intermediate CA -&gt; EE&quot;,
+	      &quot;ISOP_ND1.ors&quot;, &quot;ND1_Issuer_ICA.pem&quot;, 1);
+    test_ocsp(&quot;NON-DELEGATED; Root CA -&gt; Intermediate CA&quot;,
+	      &quot;ISOP_ND2.ors&quot;, &quot;ND2_Issuer_Root.pem&quot;, 1);
+    test_ocsp(&quot;NON-DELEGATED; Root CA -&gt; EE&quot;,
+	      &quot;ISOP_ND3.ors&quot;, &quot;ND3_Issuer_Root.pem&quot;, 1);
+    test_ocsp(&quot;DELEGATED; Intermediate CA -&gt; EE&quot;,
+	      &quot;ISOP_D1.ors&quot;, &quot;D1_Issuer_ICA.pem&quot;, 1);
+    test_ocsp(&quot;DELEGATED; Root CA -&gt; Intermediate CA&quot;,
+	      &quot;ISOP_D2.ors&quot;, &quot;D2_Issuer_Root.pem&quot;, 1);
+    test_ocsp(&quot;DELEGATED; Root CA -&gt; EE&quot;,
+	      &quot;ISOP_D3.ors&quot;, &quot;D3_Issuer_Root.pem&quot;, 1);
+};
+
+subtest &quot;=== WRONG RESPONDERID in the OCSP RESPONSE ===&quot; =&gt; sub {
+    plan tests =&gt; 6;
+
+    test_ocsp(&quot;NON-DELEGATED; Intermediate CA -&gt; EE&quot;,
+	      &quot;WRID_ND1.ors&quot;, &quot;ND1_Issuer_ICA.pem&quot;, 1);
+    test_ocsp(&quot;NON-DELEGATED; Root CA -&gt; Intermediate CA&quot;,
+	      &quot;WRID_ND2.ors&quot;, &quot;ND2_Issuer_Root.pem&quot;, 1);
+    test_ocsp(&quot;NON-DELEGATED; Root CA -&gt; EE&quot;,
+	      &quot;WRID_ND3.ors&quot;, &quot;ND3_Issuer_Root.pem&quot;, 1);
+    test_ocsp(&quot;DELEGATED; Intermediate CA -&gt; EE&quot;,
+	      &quot;WRID_D1.ors&quot;, &quot;D1_Issuer_ICA.pem&quot;, 1);
+    test_ocsp(&quot;DELEGATED; Root CA -&gt; Intermediate CA&quot;,
+	      &quot;WRID_D2.ors&quot;, &quot;D2_Issuer_Root.pem&quot;, 1);
+    test_ocsp(&quot;DELEGATED; Root CA -&gt; EE&quot;,
+	      &quot;WRID_D3.ors&quot;, &quot;D3_Issuer_Root.pem&quot;, 1);
+};
+
+subtest &quot;=== WRONG ISSUERNAMEHASH in the OCSP RESPONSE ===&quot; =&gt; sub {
+    plan tests =&gt; 6;
+
+    test_ocsp(&quot;NON-DELEGATED; Intermediate CA -&gt; EE&quot;,
+	      &quot;WINH_ND1.ors&quot;, &quot;ND1_Issuer_ICA.pem&quot;, 1);
+    test_ocsp(&quot;NON-DELEGATED; Root CA -&gt; Intermediate CA&quot;,
+	      &quot;WINH_ND2.ors&quot;, &quot;ND2_Issuer_Root.pem&quot;, 1);
+    test_ocsp(&quot;NON-DELEGATED; Root CA -&gt; EE&quot;,
+	      &quot;WINH_ND3.ors&quot;, &quot;ND3_Issuer_Root.pem&quot;, 1);
+    test_ocsp(&quot;DELEGATED; Intermediate CA -&gt; EE&quot;,
+	      &quot;WINH_D1.ors&quot;, &quot;D1_Issuer_ICA.pem&quot;, 1);
+    test_ocsp(&quot;DELEGATED; Root CA -&gt; Intermediate CA&quot;,
+	      &quot;WINH_D2.ors&quot;, &quot;D2_Issuer_Root.pem&quot;, 1);
+    test_ocsp(&quot;DELEGATED; Root CA -&gt; EE&quot;,
+	      &quot;WINH_D3.ors&quot;, &quot;D3_Issuer_Root.pem&quot;, 1);
+};
+
+subtest &quot;=== WRONG ISSUERKEYHASH in the OCSP RESPONSE ===&quot; =&gt; sub {
+    plan tests =&gt; 6;
+
+    test_ocsp(&quot;NON-DELEGATED; Intermediate CA -&gt; EE&quot;,
+	      &quot;WIKH_ND1.ors&quot;, &quot;ND1_Issuer_ICA.pem&quot;, 1);
+    test_ocsp(&quot;NON-DELEGATED; Root CA -&gt; Intermediate CA&quot;,
+	      &quot;WIKH_ND2.ors&quot;, &quot;ND2_Issuer_Root.pem&quot;, 1);
+    test_ocsp(&quot;NON-DELEGATED; Root CA -&gt; EE&quot;,
+	      &quot;WIKH_ND3.ors&quot;, &quot;ND3_Issuer_Root.pem&quot;, 1);
+    test_ocsp(&quot;DELEGATED; Intermediate CA -&gt; EE&quot;,
+	      &quot;WIKH_D1.ors&quot;, &quot;D1_Issuer_ICA.pem&quot;, 1);
+    test_ocsp(&quot;DELEGATED; Root CA -&gt; Intermediate CA&quot;,
+	      &quot;WIKH_D2.ors&quot;, &quot;D2_Issuer_Root.pem&quot;, 1);
+    test_ocsp(&quot;DELEGATED; Root CA -&gt; EE&quot;,
+	      &quot;WIKH_D3.ors&quot;, &quot;D3_Issuer_Root.pem&quot;, 1);
+};
+
+subtest &quot;=== WRONG KEY in the DELEGATED OCSP SIGNING CERTIFICATE ===&quot; =&gt; sub {
+    plan tests =&gt; 3;
+
+    test_ocsp(&quot;DELEGATED; Intermediate CA -&gt; EE&quot;,
+	      &quot;WKDOSC_D1.ors&quot;, &quot;D1_Issuer_ICA.pem&quot;, 1);
+    test_ocsp(&quot;DELEGATED; Root CA -&gt; Intermediate CA&quot;,
+	      &quot;WKDOSC_D2.ors&quot;, &quot;D2_Issuer_Root.pem&quot;, 1);
+    test_ocsp(&quot;DELEGATED; Root CA -&gt; EE&quot;,
+	      &quot;WKDOSC_D3.ors&quot;, &quot;D3_Issuer_Root.pem&quot;, 1);
+};
+
+subtest &quot;=== INVALID SIGNATURE on the DELEGATED OCSP SIGNING CERTIFICATE ===&quot; =&gt; sub {
+    plan tests =&gt; 3;
+
+    test_ocsp(&quot;DELEGATED; Intermediate CA -&gt; EE&quot;,
+	      &quot;ISDOSC_D1.ors&quot;, &quot;D1_Issuer_ICA.pem&quot;, 1);
+    test_ocsp(&quot;DELEGATED; Root CA -&gt; Intermediate CA&quot;,
+	      &quot;ISDOSC_D2.ors&quot;, &quot;D2_Issuer_Root.pem&quot;, 1);
+    test_ocsp(&quot;DELEGATED; Root CA -&gt; EE&quot;,
+	      &quot;ISDOSC_D3.ors&quot;, &quot;D3_Issuer_Root.pem&quot;, 1);
+};
+
+subtest &quot;=== WRONG SUBJECT NAME in the ISSUER CERTIFICATE ===&quot; =&gt; sub {
+    plan tests =&gt; 6;
+
+    test_ocsp(&quot;NON-DELEGATED; Intermediate CA -&gt; EE&quot;,
+	      &quot;ND1.ors&quot;, &quot;WSNIC_ND1_Issuer_ICA.pem&quot;, 1);
+    test_ocsp(&quot;NON-DELEGATED; Root CA -&gt; Intermediate CA&quot;,
+	      &quot;ND2.ors&quot;, &quot;WSNIC_ND2_Issuer_Root.pem&quot;, 1);
+    test_ocsp(&quot;NON-DELEGATED; Root CA -&gt; EE&quot;,
+	      &quot;ND3.ors&quot;, &quot;WSNIC_ND3_Issuer_Root.pem&quot;, 1);
+    test_ocsp(&quot;DELEGATED; Intermediate CA -&gt; EE&quot;,
+	      &quot;D1.ors&quot;, &quot;WSNIC_D1_Issuer_ICA.pem&quot;, 1);
+    test_ocsp(&quot;DELEGATED; Root CA -&gt; Intermediate CA&quot;,
+	      &quot;D2.ors&quot;, &quot;WSNIC_D2_Issuer_Root.pem&quot;, 1);
+    test_ocsp(&quot;DELEGATED; Root CA -&gt; EE&quot;,
+	      &quot;D3.ors&quot;, &quot;WSNIC_D3_Issuer_Root.pem&quot;, 1);
+};
+
+subtest &quot;=== WRONG KEY in the ISSUER CERTIFICATE ===&quot; =&gt; sub {
+    plan tests =&gt; 6;
+
+    test_ocsp(&quot;NON-DELEGATED; Intermediate CA -&gt; EE&quot;,
+	      &quot;ND1.ors&quot;, &quot;WKIC_ND1_Issuer_ICA.pem&quot;, 1);
+    test_ocsp(&quot;NON-DELEGATED; Root CA -&gt; Intermediate CA&quot;,
+	      &quot;ND2.ors&quot;, &quot;WKIC_ND2_Issuer_Root.pem&quot;, 1);
+    test_ocsp(&quot;NON-DELEGATED; Root CA -&gt; EE&quot;,
+	      &quot;ND3.ors&quot;, &quot;WKIC_ND3_Issuer_Root.pem&quot;, 1);
+    test_ocsp(&quot;DELEGATED; Intermediate CA -&gt; EE&quot;,
+	      &quot;D1.ors&quot;, &quot;WKIC_D1_Issuer_ICA.pem&quot;, 1);
+    test_ocsp(&quot;DELEGATED; Root CA -&gt; Intermediate CA&quot;,
+	      &quot;D2.ors&quot;, &quot;WKIC_D2_Issuer_Root.pem&quot;, 1);
+    test_ocsp(&quot;DELEGATED; Root CA -&gt; EE&quot;,
+	      &quot;D3.ors&quot;, &quot;WKIC_D3_Issuer_Root.pem&quot;, 1);
+};
+
+subtest &quot;=== INVALID SIGNATURE on the ISSUER CERTIFICATE ===&quot; =&gt; sub {
+    plan tests =&gt; 6;
+
+    # Expect success, because we're explicitly trusting the issuer certificate.
+    test_ocsp(&quot;NON-DELEGATED; Intermediate CA -&gt; EE&quot;,
+	      &quot;ND1.ors&quot;, &quot;ISIC_ND1_Issuer_ICA.pem&quot;, 0);
+    test_ocsp(&quot;NON-DELEGATED; Root CA -&gt; Intermediate CA&quot;,
+	      &quot;ND2.ors&quot;, &quot;ISIC_ND2_Issuer_Root.pem&quot;, 0);
+    test_ocsp(&quot;NON-DELEGATED; Root CA -&gt; EE&quot;,
+	      &quot;ND3.ors&quot;, &quot;ISIC_ND3_Issuer_Root.pem&quot;, 0);
+    test_ocsp(&quot;DELEGATED; Intermediate CA -&gt; EE&quot;,
+	      &quot;D1.ors&quot;, &quot;ISIC_D1_Issuer_ICA.pem&quot;, 0);
+    test_ocsp(&quot;DELEGATED; Root CA -&gt; Intermediate CA&quot;,
+	      &quot;D2.ors&quot;, &quot;ISIC_D2_Issuer_Root.pem&quot;, 0);
+    test_ocsp(&quot;DELEGATED; Root CA -&gt; EE&quot;,
+	      &quot;D3.ors&quot;, &quot;ISIC_D3_Issuer_Root.pem&quot;, 0);
+};
diff --git a/test/recipes/80-test_ssl.t b/test/recipes/80-test_ssl.t
new file mode 100644
index 0000000..409e68f
--- /dev/null
+++ b/test/recipes/80-test_ssl.t
@@ -0,0 +1,627 @@
+#! /usr/bin/perl
+
+use strict;
+use warnings;
+
+use POSIX;
+use File::Spec;
+use File::Copy;
+use OpenSSL::Test qw/:DEFAULT with top_file cmdstr/;
+
+setup(&quot;test_ssl&quot;);
+
+my $digest = &quot;-sha1&quot;;
+my @reqcmd = (&quot;openssl&quot;, &quot;req&quot;);
+my @x509cmd = (&quot;openssl&quot;, &quot;x509&quot;, $digest);
+my @verifycmd = (&quot;openssl&quot;, &quot;verify&quot;);
+my $dummycnf = top_file(&quot;apps&quot;, &quot;openssl.cnf&quot;);
+
+my $CAkey = &quot;keyCA.ss&quot;;
+my $CAcert=&quot;certCA.ss&quot;;
+my $CAserial=&quot;certCA.srl&quot;;
+my $CAreq=&quot;reqCA.ss&quot;;
+my $CAconf=top_file(&quot;test&quot;,&quot;CAss.cnf&quot;);
+my $CAreq2=&quot;req2CA.ss&quot;;	# temp
+
+my $Uconf=top_file(&quot;test&quot;,&quot;Uss.cnf&quot;);
+my $Ukey=&quot;keyU.ss&quot;;
+my $Ureq=&quot;reqU.ss&quot;;
+my $Ucert=&quot;certU.ss&quot;;
+
+my $Dkey=&quot;keyD.ss&quot;;
+my $Dreq=&quot;reqD.ss&quot;;
+my $Dcert=&quot;certD.ss&quot;;
+
+my $Ekey=&quot;keyE.ss&quot;;
+my $Ereq=&quot;reqE.ss&quot;;
+my $Ecert=&quot;certE.ss&quot;;
+
+my $P1conf=top_file(&quot;test&quot;,&quot;P1ss.cnf&quot;);
+my $P1key=&quot;keyP1.ss&quot;;
+my $P1req=&quot;reqP1.ss&quot;;
+my $P1cert=&quot;certP1.ss&quot;;
+my $P1intermediate=&quot;tmp_intP1.ss&quot;;
+
+my $P2conf=top_file(&quot;test&quot;,&quot;P2ss.cnf&quot;);
+my $P2key=&quot;keyP2.ss&quot;;
+my $P2req=&quot;reqP2.ss&quot;;
+my $P2cert=&quot;certP2.ss&quot;;
+my $P2intermediate=&quot;tmp_intP2.ss&quot;;
+
+plan tests =&gt;
+    1				# For testss
+    + 1				# For ssltest -test_cipherlist
+    + 8				# For the first testssl
+    + 16			# For the first testsslproxy
+    + 16			# For the second testsslproxy
+    ;
+
+subtest 'test_ss' =&gt; sub {
+    if (testss()) {
+	open OUT, &quot;&gt;&quot;, &quot;intP1.ss&quot;;
+	copy($CAcert, \*OUT); copy($Ucert, \*OUT);
+	close OUT;
+
+	open OUT, &quot;&gt;&quot;, &quot;intP2.ss&quot;;
+	copy($CAcert, \*OUT); copy($Ucert, \*OUT); copy($P1cert, \*OUT);
+	close OUT;
+    }
+};
+
+my $check = ok(run(test([&quot;ssltest&quot;,&quot;-test_cipherlist&quot;])), &quot;running ssltest&quot;);
+
+  SKIP: {
+      skip &quot;ssltest ended with error, skipping the rest&quot;, 3
+	  if !$check;
+
+      note('test_ssl -- key U');
+      testssl(&quot;keyU.ss&quot;, $Ucert, $CAcert);
+
+      note('test_ssl -- key P1');
+      testsslproxy(&quot;keyP1.ss&quot;, &quot;certP1.ss&quot;, &quot;intP1.ss&quot;, &quot;AB&quot;);
+
+      note('test_ssl -- key P2');
+      testsslproxy(&quot;keyP2.ss&quot;, &quot;certP2.ss&quot;, &quot;intP2.ss&quot;, &quot;BC&quot;);
+    }
+
+# -----------
+# subtest functions
+sub testss {
+    open RND, &quot;&gt;&gt;&quot;, &quot;.rnd&quot;;
+    print RND &quot;string to make the random number generator think it has entropy&quot;;
+    close RND;
+
+    my @req_dsa = (&quot;-newkey&quot;,
+                   &quot;dsa:&quot;.File::Spec-&gt;catfile(&quot;..&quot;, &quot;apps&quot;, &quot;dsa1024.pem&quot;));;
+    my @req_new;
+    if (run(app([&quot;openssl&quot;, &quot;no-rsa&quot;], stdout =&gt; undef))) {
+	@req_new = @req_dsa;
+    } else {
+	@req_new = (&quot;-new&quot;);
+    }
+
+    plan tests =&gt; 17;
+
+  SKIP: {
+      skip 'failure', 16 unless
+	  ok(run(app([@reqcmd, &quot;-config&quot;, $CAconf,
+		      &quot;-out&quot;, $CAreq, &quot;-keyout&quot;, $CAkey,
+		      @req_new])),
+	     'make cert request');
+
+      skip 'failure', 15 unless
+	  ok(run(app([@x509cmd, &quot;-CAcreateserial&quot;, &quot;-in&quot;, $CAreq, &quot;-days&quot;, &quot;30&quot;,
+		      &quot;-req&quot;, &quot;-out&quot;, $CAcert, &quot;-signkey&quot;, $CAkey,
+		      &quot;-extfile&quot;, $CAconf, &quot;-extensions&quot;, &quot;v3_ca&quot;],
+		     stdout =&gt; &quot;err.ss&quot;)),
+	     'convert request into self-signed cert');
+
+      skip 'failure', 14 unless
+	  ok(run(app([@x509cmd, &quot;-in&quot;, $CAcert,
+		      &quot;-x509toreq&quot;, &quot;-signkey&quot;, $CAkey, &quot;-out&quot;, $CAreq2],
+		     stdout =&gt; &quot;err.ss&quot;)),
+	     'convert cert into a cert request');
+
+      skip 'failure', 13 unless
+	  ok(run(app([@reqcmd, &quot;-config&quot;, $dummycnf,
+		      &quot;-verify&quot;, &quot;-in&quot;, $CAreq, &quot;-noout&quot;])),
+	     'verify request 1');
+
+
+      skip 'failure', 12 unless
+	  ok(run(app([@reqcmd, &quot;-config&quot;, $dummycnf,
+		      &quot;-verify&quot;, &quot;-in&quot;, $CAreq2, &quot;-noout&quot;])),
+	     'verify request 2');
+
+      skip 'failure', 11 unless
+	  ok(run(app([@verifycmd, &quot;-CAfile&quot;, $CAcert, $CAcert])),
+	     'verify signature');
+
+      skip 'failure', 10 unless
+	  ok(run(app([@reqcmd, &quot;-config&quot;, $Uconf,
+		      &quot;-out&quot;, $Ureq, &quot;-keyout&quot;, $Ukey, @req_new],
+		     stdout =&gt; &quot;err.ss&quot;)),
+	     'make a user cert request');
+
+      skip 'failure', 9 unless
+	  ok(run(app([@x509cmd, &quot;-CAcreateserial&quot;, &quot;-in&quot;, $Ureq, &quot;-days&quot;, &quot;30&quot;,
+		      &quot;-req&quot;, &quot;-out&quot;, $Ucert,
+		      &quot;-CA&quot;, $CAcert, &quot;-CAkey&quot;, $CAkey, &quot;-CAserial&quot;, $CAserial,
+		      &quot;-extfile&quot;, $Uconf, &quot;-extensions&quot;, &quot;v3_ee&quot;],
+		     stdout =&gt; &quot;err.ss&quot;))
+	     &amp;&amp; run(app([@verifycmd, &quot;-CAfile&quot;, $CAcert, $Ucert])),
+	     'sign user cert request');
+
+      skip 'failure', 8 unless
+	  ok(run(app([@x509cmd,
+		      &quot;-subject&quot;, &quot;-issuer&quot;, &quot;-startdate&quot;, &quot;-enddate&quot;,
+		      &quot;-noout&quot;, &quot;-in&quot;, $Ucert])),
+	     'Certificate details');
+
+      skip 'failure', 7 unless
+          subtest 'DSA certificate creation' =&gt; sub {
+              plan skip_all =&gt; &quot;skipping DSA certificate creation&quot;
+                  if run(app([&quot;openssl&quot;, &quot;no-dsa&quot;], stdout =&gt; undef));
+
+              plan tests =&gt; 4;
+
+            SKIP: {
+                $ENV{CN2} = &quot;DSA Certificate&quot;;
+                skip 'failure', 3 unless
+                    ok(run(app([@reqcmd, &quot;-config&quot;, $Uconf,
+                                &quot;-out&quot;, $Dreq, &quot;-keyout&quot;, $Dkey,
+                                @req_dsa],
+                               stdout =&gt; &quot;err.ss&quot;)),
+                       &quot;make a DSA user cert request&quot;);
+                skip 'failure', 2 unless
+                    ok(run(app([@x509cmd, &quot;-CAcreateserial&quot;,
+                                &quot;-in&quot;, $Dreq,
+                                &quot;-days&quot;, &quot;30&quot;,
+                                &quot;-req&quot;,
+                                &quot;-out&quot;, $Dcert,
+                                &quot;-CA&quot;, $CAcert, &quot;-CAkey&quot;, $CAkey,
+                                &quot;-CAserial&quot;, $CAserial,
+                                &quot;-extfile&quot;, $Uconf,
+                                &quot;-extensions&quot;, &quot;v3_ee_dsa&quot;],
+                               stdout =&gt; &quot;err.ss&quot;)),
+                       &quot;sign DSA user cert request&quot;);
+                skip 'failure', 1 unless
+                    ok(run(app([@verifycmd, &quot;-CAfile&quot;, $CAcert, $Dcert])),
+                       &quot;verify DSA user cert&quot;);
+                skip 'failure', 0 unless
+                    ok(run(app([@x509cmd,
+                                &quot;-subject&quot;, &quot;-issuer&quot;,
+                                &quot;-startdate&quot;, &quot;-enddate&quot;, &quot;-noout&quot;,
+                                &quot;-in&quot;, $Dcert])),
+                       &quot;DSA Certificate details&quot;);
+              }
+      };
+
+      skip 'failure', 6 unless
+          subtest 'ECDSA/ECDH certificate creation' =&gt; sub {
+              plan skip_all =&gt; &quot;skipping ECDSA/ECDH certificate creation&quot;
+                  if run(app([&quot;openssl&quot;, &quot;no-ec&quot;], stdout =&gt; undef));
+
+              plan tests =&gt; 5;
+
+            SKIP: {
+                $ENV{CN2} = &quot;ECDSA Certificate&quot;;
+                skip 'failure', 4 unless
+                    ok(run(app([&quot;openssl&quot;, &quot;ecparam&quot;, &quot;-name&quot;, &quot;P-256&quot;,
+                                &quot;-out&quot;, &quot;ecp.ss&quot;])),
+                       &quot;make EC parameters&quot;);
+                skip 'failure', 3 unless
+                    ok(run(app([@reqcmd, &quot;-config&quot;, $Uconf,
+                                &quot;-out&quot;, $Ereq, &quot;-keyout&quot;, $Ekey,
+                                &quot;-newkey&quot;, &quot;ec:ecp.ss&quot;],
+                               stdout =&gt; &quot;err.ss&quot;)),
+                       &quot;make a ECDSA/ECDH user cert request&quot;);
+                skip 'failure', 2 unless
+                    ok(run(app([@x509cmd, &quot;-CAcreateserial&quot;,
+                                &quot;-in&quot;, $Ereq,
+                                &quot;-days&quot;, &quot;30&quot;,
+                                &quot;-req&quot;,
+                                &quot;-out&quot;, $Ecert,
+                                &quot;-CA&quot;, $CAcert, &quot;-CAkey&quot;, $CAkey,
+                                &quot;-CAserial&quot;, $CAserial,
+                                &quot;-extfile&quot;, $Uconf,
+                                &quot;-extensions&quot;, &quot;v3_ee_ec&quot;],
+                               stdout =&gt; &quot;err.ss&quot;)),
+                       &quot;sign ECDSA/ECDH user cert request&quot;);
+                skip 'failure', 1 unless
+                    ok(run(app([@verifycmd, &quot;-CAfile&quot;, $CAcert, $Ecert])),
+                       &quot;verify ECDSA/ECDH user cert&quot;);
+                skip 'failure', 0 unless
+                    ok(run(app([@x509cmd,
+                                &quot;-subject&quot;, &quot;-issuer&quot;,
+                                &quot;-startdate&quot;, &quot;-enddate&quot;, &quot;-noout&quot;,
+                                &quot;-in&quot;, $Ecert])),
+                       &quot;ECDSA Certificate details&quot;);
+              }
+      };
+
+      skip 'failure', 5 unless
+	  ok(run(app([@reqcmd, &quot;-config&quot;, $P1conf,
+		      &quot;-out&quot;, $P1req, &quot;-keyout&quot;, $P1key, @req_new],
+		     stdout =&gt; &quot;err.ss&quot;)),
+	     'make a proxy cert request');
+
+
+      skip 'failure', 4 unless
+	  ok(run(app([@x509cmd, &quot;-CAcreateserial&quot;, &quot;-in&quot;, $P1req, &quot;-days&quot;, &quot;30&quot;,
+		      &quot;-req&quot;, &quot;-out&quot;, $P1cert,
+		      &quot;-CA&quot;, $Ucert, &quot;-CAkey&quot;, $Ukey,
+		      &quot;-extfile&quot;, $P1conf, &quot;-extensions&quot;, &quot;v3_proxy&quot;],
+		     stdout =&gt; &quot;err.ss&quot;)),
+	     'sign proxy with user cert');
+
+      copy($Ucert, $P1intermediate);
+      run(app([@verifycmd, &quot;-CAfile&quot;, $CAcert,
+	       &quot;-untrusted&quot;, $P1intermediate, $P1cert]));
+      ok(run(app([@x509cmd,
+		  &quot;-subject&quot;, &quot;-issuer&quot;, &quot;-startdate&quot;, &quot;-enddate&quot;,
+		  &quot;-noout&quot;, &quot;-in&quot;, $P1cert])),
+	 'Certificate details');
+
+      skip 'failure', 2 unless
+	  ok(run(app([@reqcmd, &quot;-config&quot;, $P2conf,
+		      &quot;-out&quot;, $P2req, &quot;-keyout&quot;, $P2key,
+		      @req_new],
+		     stdout =&gt; &quot;err.ss&quot;)),
+	     'make another proxy cert request');
+
+
+      skip 'failure', 1 unless
+	  ok(run(app([@x509cmd, &quot;-CAcreateserial&quot;, &quot;-in&quot;, $P2req, &quot;-days&quot;, &quot;30&quot;,
+		      &quot;-req&quot;, &quot;-out&quot;, $P2cert,
+		      &quot;-CA&quot;, $P1cert, &quot;-CAkey&quot;, $P1key,
+		      &quot;-extfile&quot;, $P2conf, &quot;-extensions&quot;, &quot;v3_proxy&quot;],
+		     stdout =&gt; &quot;err.ss&quot;)),
+	     'sign second proxy cert request with the first proxy cert');
+
+
+      open OUT, &quot;&gt;&quot;, $P2intermediate;
+      copy($Ucert, \*OUT); copy($P1cert, \*OUT);
+      close OUT;
+      run(app([@verifycmd, &quot;-CAfile&quot;, $CAcert,
+	       &quot;-untrusted&quot;, $P2intermediate, $P2cert]));
+      ok(run(app([@x509cmd,
+		  &quot;-subject&quot;, &quot;-issuer&quot;, &quot;-startdate&quot;, &quot;-enddate&quot;,
+		  &quot;-noout&quot;, &quot;-in&quot;, $P2cert])),
+	 'Certificate details');
+    }
+}
+
+sub testssl {
+    my $key = shift || top_file(&quot;apps&quot;,&quot;server.pem&quot;);
+    my $cert = shift || top_file(&quot;apps&quot;,&quot;server.pem&quot;);
+    my $CAtmp = shift;
+    my @CA = $CAtmp ? (&quot;-CAfile&quot;, $CAtmp) : (&quot;-CApath&quot;, top_dir(&quot;certs&quot;));
+    my @extra = @_;
+
+    my @ssltest = (&quot;ssltest&quot;,
+		   &quot;-s_key&quot;, $key, &quot;-s_cert&quot;, $cert,
+		   &quot;-c_key&quot;, $key, &quot;-c_cert&quot;, $cert);
+
+    my $serverinfo = top_file(&quot;test&quot;,&quot;serverinfo.pem&quot;);
+
+    my $dsa_cert = 0;
+    if (grep /DSA Public Key/, run(app([&quot;openssl&quot;, &quot;x509&quot;, &quot;-in&quot;, $cert,
+					&quot;-text&quot;, &quot;-noout&quot;]), capture =&gt; 1)) {
+	$dsa_cert = 1;
+    }
+
+
+    # plan tests =&gt; 7;
+
+    subtest 'standard SSL tests' =&gt; sub {
+	######################################################################
+	plan tests =&gt; 27;
+
+	ok(run(test([@ssltest, &quot;-ssl3&quot;, @extra])),
+	   'test sslv3');
+	ok(run(test([@ssltest, &quot;-ssl3&quot;, &quot;-server_auth&quot;, @CA, @extra])),
+	   'test sslv3 with server authentication');
+	ok(run(test([@ssltest, &quot;-ssl3&quot;, &quot;-client_auth&quot;, @CA, @extra])),
+	   'test sslv3 with client authentication');
+	ok(run(test([@ssltest, &quot;-ssl3&quot;, &quot;-server_auth&quot;, &quot;-client_auth&quot;, @CA, @extra])),
+	   'test sslv3 with both server and client authentication');
+	ok(run(test([@ssltest, @extra])),
+	   'test sslv2/sslv3');
+	ok(run(test([@ssltest, &quot;-server_auth&quot;, @CA, @extra])),
+	   'test sslv2/sslv3 with server authentication');
+	ok(run(test([@ssltest, &quot;-client_auth&quot;, @CA, @extra])),
+	   'test sslv2/sslv3 with client authentication');
+	ok(run(test([@ssltest, &quot;-server_auth&quot;, &quot;-client_auth&quot;, @CA, @extra])),
+	   'test sslv2/sslv3 with both server and client authentication');
+	ok(run(test([@ssltest, &quot;-bio_pair&quot;, &quot;-ssl3&quot;, @extra])),
+	   'test sslv3 via BIO pair');
+	ok(run(test([@ssltest, &quot;-bio_pair&quot;, &quot;-ssl3&quot;, &quot;-server_auth&quot;, @CA, @extra])),
+	   'test sslv3 with server authentication via BIO pair');
+	ok(run(test([@ssltest, &quot;-bio_pair&quot;, &quot;-ssl3&quot;, &quot;-client_auth&quot;, @CA, @extra])),
+	   'test sslv3 with client authentication via BIO pair');
+	ok(run(test([@ssltest, &quot;-bio_pair&quot;, &quot;-ssl3&quot;, &quot;-server_auth&quot;, &quot;-client_auth&quot;, @CA, @extra])),
+	   'test sslv3 with both server and client authentication via BIO pair');
+	ok(run(test([@ssltest, &quot;-bio_pair&quot;, @extra])),
+	   'test sslv2/sslv3 via BIO pair');
+	ok(run(test([@ssltest, &quot;-dtls1&quot;, @extra])),
+	   'test dtlsv1');
+	ok(run(test([@ssltest, &quot;-dtls1&quot;, &quot;-server_auth&quot;, @CA, @extra])),
+	   'test dtlsv1 with server authentication');
+	ok(run(test([@ssltest, &quot;-dtls1&quot;, &quot;-client_auth&quot;, @CA, @extra])),
+	   'test dtlsv1 with client authentication');
+	ok(run(test([@ssltest, &quot;-dtls1&quot;, &quot;-server_auth&quot;, &quot;-client_auth&quot;, @CA, @extra])),
+	   'test dtlsv1 with both server and client authentication');
+	ok(run(test([@ssltest, &quot;-dtls12&quot;, @extra])),
+	   'test dtlsv1.2');
+	ok(run(test([@ssltest, &quot;-dtls12&quot;, &quot;-server_auth&quot;, @CA, @extra])),
+	   'test dtlsv1.2 with server authentication');
+	ok(run(test([@ssltest, &quot;-dtls12&quot;, &quot;-client_auth&quot;, @CA, @extra])),
+	   'test dtlsv1.2 with client authentication');
+	ok(run(test([@ssltest, &quot;-dtls12&quot;, &quot;-server_auth&quot;, &quot;-client_auth&quot;, @CA, @extra])),
+	   'test dtlsv1.2 with both server and client authentication');
+	{
+	  SKIP: {
+	      skip &quot;skipping test of sslv2/sslv3 w/o (EC)DHE test&quot;, 1 if $dsa_cert;
+
+	      ok(run(test([@ssltest, &quot;-bio_pair&quot;, &quot;-no_dhe&quot;, &quot;-no_ecdhe&quot;, @extra])),
+		 'test sslv2/sslv3 w/o (EC)DHE via BIO pair');
+	    }
+	}
+	ok(run(test([@ssltest, &quot;-bio_pair&quot;, &quot;-dhe1024dsa&quot;, &quot;-v&quot;, @extra])),
+	   'test sslv2/sslv3 with 1024bit DHE via BIO pair');
+	ok(run(test([@ssltest, &quot;-bio_pair&quot;, &quot;-server_auth&quot;, @CA, @extra])),
+	   'test sslv2/sslv3 with server authentication');
+	ok(run(test([@ssltest, &quot;-bio_pair&quot;, &quot;-client_auth&quot;, @CA, @extra])),
+	   'test sslv2/sslv3 with client authentication via BIO pair');
+	ok(run(test([@ssltest, &quot;-bio_pair&quot;, &quot;-server_auth&quot;, &quot;-client_auth&quot;, @CA, @extra])),
+	   'test sslv2/sslv3 with both client and server authentication via BIO pair');
+	ok(run(test([@ssltest, &quot;-bio_pair&quot;, &quot;-server_auth&quot;, &quot;-client_auth&quot;, &quot;-app_verify&quot;, @CA, @extra])),
+	   'test sslv2/sslv3 with both client and server authentication via BIO pair and app verify');
+    };
+
+    subtest &quot;Testing ciphersuites&quot; =&gt; sub {
+
+        my @exkeys = ();
+        my $ciphers = &quot;-EXP:-PSK:-SRP:-kDH:-kECDHe&quot;;
+
+        if (run(app([&quot;openssl&quot;, &quot;no-dhparam&quot;], stdout =&gt; undef))) {
+            note &quot;skipping DHE tests\n&quot;;
+            $ciphers .= &quot;:-kDHE&quot;;
+        }
+        if (run(app([&quot;openssl&quot;, &quot;no-dsa&quot;], stdout =&gt; undef))) {
+            note &quot;skipping DSA tests\n&quot;;
+            $ciphers .= &quot;:-aDSA&quot;;
+        } else {
+            push @exkeys, &quot;-s_cert&quot;, &quot;certD.ss&quot;, &quot;-s_key&quot;, &quot;keyD.ss&quot;;
+        }
+
+        if (run(app([&quot;openssl&quot;, &quot;no-ec&quot;], stdout =&gt; undef))) {
+            note &quot;skipping EC tests\n&quot;;
+            $ciphers .= &quot;:!aECDSA:!kECDH&quot;;
+        } else {
+            push @exkeys, &quot;-s_cert&quot;, &quot;certE.ss&quot;, &quot;-s_key&quot;, &quot;keyE.ss&quot;;
+        }
+
+	my @protocols = (&quot;TLSv1.2&quot;, &quot;SSLv3&quot;);
+	my $protocolciphersuitcount = 0;
+	my %ciphersuites =
+	    map { my @c =
+		      map { split(/:/, $_) }
+		      run(app([&quot;openssl&quot;, &quot;ciphers&quot;, &quot;${_}:$ciphers&quot;]),
+                          capture =&gt; 1);
+		  chomp @c;
+		  $protocolciphersuitcount += scalar @c;
+		  $_ =&gt; [ @c ] } @protocols;
+
+        # The count of protocols is because in addition to the ciphersuits
+        # we got above, we're running a weak DH test for each protocol
+	plan tests =&gt; $protocolciphersuitcount + scalar(@protocols);
+
+	foreach my $protocol (@protocols) {
+	    note &quot;Testing ciphersuites for $protocol&quot;;
+	    foreach my $cipher (@{$ciphersuites{$protocol}}) {
+		ok(run(test([@ssltest, @exkeys, &quot;-cipher&quot;, $cipher,
+			     $protocol eq &quot;SSLv3&quot; ? (&quot;-ssl3&quot;) : ()])),
+		   &quot;Testing $cipher&quot;);
+	    }
+            is(run(test([@ssltest,
+                         &quot;-s_cipher&quot;, &quot;EDH&quot;,
+                         &quot;-c_cipher&quot;, 'EDH:@SECLEVEL=1',
+                         &quot;-dhe512&quot;,
+                         $protocol eq &quot;SSLv3&quot; ? (&quot;-ssl3&quot;) : ()])), 0,
+               &quot;testing connection with weak DH, expecting failure&quot;);
+	}
+    };
+
+    subtest 'RSA/(EC)DHE/PSK tests' =&gt; sub {
+	######################################################################
+
+	plan tests =&gt; 5;
+
+	{
+	  SKIP: {
+	      skip &quot;skipping anonymous DH tests&quot;, 1
+		  if (run(app([&quot;openssl&quot;, &quot;no-dhparam&quot;], stdout =&gt; undef)));
+
+	      ok(run(test([@ssltest, &quot;-v&quot;, &quot;-bio_pair&quot;, &quot;-tls1&quot;, &quot;-cipher&quot;, &quot;ADH&quot;, &quot;-dhe1024dsa&quot;, &quot;-num&quot;, &quot;10&quot;, &quot;-f&quot;, &quot;-time&quot;, @extra])),
+		 'test tlsv1 with 1024bit anonymous DH, multiple handshakes');
+	    }
+	}
+
+	{
+	  SKIP: {
+	      skip &quot;skipping RSA tests&quot;, 2
+		  if (run(app([&quot;openssl&quot;, &quot;no-rsa&quot;], stdout =&gt; undef)));
+
+	      ok(run(test([&quot;ssltest&quot;, &quot;-v&quot;, &quot;-bio_pair&quot;, &quot;-tls1&quot;, &quot;-s_cert&quot;, top_file(&quot;apps&quot;,&quot;server2.pem&quot;), &quot;-no_dhe&quot;, &quot;-no_ecdhe&quot;, &quot;-num&quot;, &quot;10&quot;, &quot;-f&quot;, &quot;-time&quot;, @extra])),
+		 'test tlsv1 with 1024bit RSA, no (EC)DHE, multiple handshakes');
+
+	      skip &quot;skipping RSA+DHE tests&quot;, 1
+		  if (run(app([&quot;openssl&quot;, &quot;no-dhparam&quot;], stdout =&gt; undef)));
+
+	      ok(run(test([&quot;ssltest&quot;, &quot;-v&quot;, &quot;-bio_pair&quot;, &quot;-tls1&quot;, &quot;-s_cert&quot;, top_file(&quot;apps&quot;,&quot;server2.pem&quot;), &quot;-dhe1024dsa&quot;, &quot;-num&quot;, &quot;10&quot;, &quot;-f&quot;, &quot;-time&quot;, @extra])),
+		 'test tlsv1 with 1024bit RSA, 1024bit DHE, multiple handshakes');
+	    }
+	}
+	ok(run(test([@ssltest, &quot;-tls1&quot;, &quot;-cipher&quot;, &quot;PSK&quot;, &quot;-psk&quot;, &quot;abc123&quot;, @extra])),
+	   'test tls1 with PSK');
+
+	ok(run(test([@ssltest, &quot;-bio_pair&quot;, &quot;-tls1&quot;, &quot;-cipher&quot;, &quot;PSK&quot;, &quot;-psk&quot;, &quot;abc123&quot;, @extra])),
+	   'test tls1 with PSK via BIO pair');
+    };
+
+    subtest 'Next Protocol Negotiation Tests' =&gt; sub {
+	######################################################################
+
+	plan tests =&gt; 7;
+
+	ok(run(test([@ssltest, &quot;-bio_pair&quot;, &quot;-tls1&quot;, &quot;-npn_client&quot;])));
+	ok(run(test([@ssltest, &quot;-bio_pair&quot;, &quot;-tls1&quot;, &quot;-npn_server&quot;])));
+	ok(run(test([@ssltest, &quot;-bio_pair&quot;, &quot;-tls1&quot;, &quot;-npn_server_reject&quot;])));
+	ok(run(test([@ssltest, &quot;-bio_pair&quot;, &quot;-tls1&quot;, &quot;-npn_client&quot;, &quot;-npn_server_reject&quot;])));
+	ok(run(test([@ssltest, &quot;-bio_pair&quot;, &quot;-tls1&quot;, &quot;-npn_client&quot;, &quot;-npn_server&quot;])));
+	ok(run(test([@ssltest, &quot;-bio_pair&quot;, &quot;-tls1&quot;, &quot;-npn_client&quot;, &quot;-npn_server&quot;, &quot;-num&quot;, &quot;2&quot;])));
+	ok(run(test([@ssltest, &quot;-bio_pair&quot;, &quot;-tls1&quot;, &quot;-npn_client&quot;, &quot;-npn_server&quot;, &quot;-num&quot;, &quot;2&quot;, &quot;-reuse&quot;])));
+    };
+
+    subtest 'Custom Extension tests' =&gt; sub {
+	######################################################################
+
+	plan tests =&gt; 1;
+
+	ok(run(test([@ssltest, &quot;-bio_pair&quot;, &quot;-tls1&quot;, &quot;-custom_ext&quot;])),
+	   'test tls1 with custom extensions');
+    };
+
+    subtest 'Serverinfo tests' =&gt; sub {
+	######################################################################
+
+	plan tests =&gt; 5;
+
+	note('echo test tls1 with serverinfo');
+	ok(run(test([@ssltest, &quot;-bio_pair&quot;, &quot;-tls1&quot;, &quot;-serverinfo_file&quot;, $serverinfo])));
+	ok(run(test([@ssltest, &quot;-bio_pair&quot;, &quot;-tls1&quot;, &quot;-serverinfo_file&quot;, $serverinfo, &quot;-serverinfo_sct&quot;])));
+	ok(run(test([@ssltest, &quot;-bio_pair&quot;, &quot;-tls1&quot;, &quot;-serverinfo_file&quot;, $serverinfo, &quot;-serverinfo_tack&quot;])));
+	ok(run(test([@ssltest, &quot;-bio_pair&quot;, &quot;-tls1&quot;, &quot;-serverinfo_file&quot;, $serverinfo, &quot;-serverinfo_sct&quot;, &quot;-serverinfo_tack&quot;])));
+	ok(run(test([@ssltest, &quot;-bio_pair&quot;, &quot;-tls1&quot;, &quot;-custom_ext&quot;, &quot;-serverinfo_file&quot;, $serverinfo, &quot;-serverinfo_sct&quot;, &quot;-serverinfo_tack&quot;])));
+    };
+
+    subtest 'ALPN tests' =&gt; sub {
+	######################################################################
+
+	plan tests =&gt; 12;
+
+	ok(run(test([@ssltest, &quot;-bio_pair&quot;, &quot;-tls1&quot;, &quot;-alpn_client&quot;, &quot;foo&quot;, &quot;-alpn_server&quot;, &quot;bar&quot;])));
+	ok(run(test([@ssltest, &quot;-bio_pair&quot;, &quot;-tls1&quot;, &quot;-alpn_client&quot;, &quot;foo&quot;, &quot;-alpn_server&quot;, &quot;foo&quot;, &quot;-alpn_expected&quot;, &quot;foo&quot;])));
+	ok(run(test([@ssltest, &quot;-bio_pair&quot;, &quot;-tls1&quot;, &quot;-alpn_client&quot;, &quot;foo,bar&quot;, &quot;-alpn_server&quot;, &quot;foo&quot;, &quot;-alpn_expected&quot;, &quot;foo&quot;])));
+	ok(run(test([@ssltest, &quot;-bio_pair&quot;, &quot;-tls1&quot;, &quot;-alpn_client&quot;, &quot;bar,foo&quot;, &quot;-alpn_server&quot;, &quot;foo&quot;, &quot;-alpn_expected&quot;, &quot;foo&quot;])));
+	ok(run(test([@ssltest, &quot;-bio_pair&quot;, &quot;-tls1&quot;, &quot;-alpn_client&quot;, &quot;bar,foo&quot;, &quot;-alpn_server&quot;, &quot;foo,bar&quot;, &quot;-alpn_expected&quot;, &quot;foo&quot;])));
+	ok(run(test([@ssltest, &quot;-bio_pair&quot;, &quot;-tls1&quot;, &quot;-alpn_client&quot;, &quot;bar,foo&quot;, &quot;-alpn_server&quot;, &quot;bar,foo&quot;, &quot;-alpn_expected&quot;, &quot;bar&quot;])));
+	ok(run(test([@ssltest, &quot;-bio_pair&quot;, &quot;-tls1&quot;, &quot;-alpn_client&quot;, &quot;foo,bar&quot;, &quot;-alpn_server&quot;, &quot;bar,foo&quot;, &quot;-alpn_expected&quot;, &quot;bar&quot;])));
+	ok(run(test([@ssltest, &quot;-bio_pair&quot;, &quot;-tls1&quot;, &quot;-alpn_client&quot;, &quot;baz&quot;, &quot;-alpn_server&quot;, &quot;bar,foo&quot;])));
+
+	{
+	  SKIP: {
+	      skip &quot;skipping SRP tests&quot;, 4
+		  if run(app([&quot;openssl&quot;, &quot;no-srp&quot;], stdout =&gt; undef));
+
+	      ok(run(test([@ssltest, &quot;-tls1&quot;, &quot;-cipher&quot;, &quot;SRP&quot;, &quot;-srpuser&quot;, &quot;test&quot;, &quot;-srppass&quot;, &quot;abc123&quot;])),
+		 'test tls1 with SRP');
+
+	      ok(run(test([@ssltest, &quot;-bio_pair&quot;, &quot;-tls1&quot;, &quot;-cipher&quot;, &quot;SRP&quot;, &quot;-srpuser&quot;, &quot;test&quot;, &quot;-srppass&quot;, &quot;abc123&quot;])),
+		 'test tls1 with SRP via BIO pair');
+
+	      ok(run(test([@ssltest, &quot;-tls1&quot;, &quot;-cipher&quot;, &quot;aSRP&quot;, &quot;-srpuser&quot;, &quot;test&quot;, &quot;-srppass&quot;, &quot;abc123&quot;])),
+		 'test tls1 with SRP auth');
+
+	      ok(run(test([@ssltest, &quot;-bio_pair&quot;, &quot;-tls1&quot;, &quot;-cipher&quot;, &quot;aSRP&quot;, &quot;-srpuser&quot;, &quot;test&quot;, &quot;-srppass&quot;, &quot;abc123&quot;])),
+		 'test tls1 with SRP auth via BIO pair');
+	    }
+	}
+    };
+
+    subtest 'Multi-buffer tests' =&gt; sub {
+	######################################################################
+
+	plan tests =&gt; 2;
+
+	{
+	  SKIP: {
+	      skip &quot;skipping multi-buffer tests&quot;, 2
+		  if @extra || (POSIX::uname())[4] ne &quot;x86_64&quot;;
+	      ok(run(test([@ssltest, &quot;-cipher&quot;, &quot;AES128-SHA&quot;,    &quot;-bytes&quot;, &quot;8m&quot;])));
+	      ok(run(test([@ssltest, &quot;-cipher&quot;, &quot;AES128-SHA256&quot;, &quot;-bytes&quot;, &quot;8m&quot;])));
+	    }
+	}
+    };
+}
+
+sub testsslproxy {
+    my $key = shift || top_file(&quot;apps&quot;,&quot;server.pem&quot;);
+    my $cert = shift || top_file(&quot;apps&quot;,&quot;server.pem&quot;);
+    my $CAtmp = shift;
+    my @CA = $CAtmp ? (&quot;-CAfile&quot;, $CAtmp) : (&quot;-CApath&quot;, top_dir(&quot;certs&quot;));
+    my @extra = @_;
+
+    my @ssltest = (&quot;ssltest&quot;,
+		   &quot;-s_key&quot;, $key, &quot;-s_cert&quot;, $cert,
+		   &quot;-c_key&quot;, $key, &quot;-c_cert&quot;, $cert);
+
+    # plan tests =&gt; 16;
+
+    note('Testing a lot of proxy conditions.');
+
+    # We happen to know that certP1.ss has policy letters &quot;AB&quot; and
+    # certP2.ss has policy letters &quot;BC&quot;.  However, because certP2.ss
+    # has certP1.ss as issuer, when it's used, both their policy
+    # letters get combined into just &quot;B&quot;.
+    # The policy letter(s) then get filtered with the given auth letter
+    # in the table below, and the result gets tested with the given
+    # condition.  For details, read ssltest.c
+    #
+    # certfilename =&gt; [ [ auth, cond, expected result ] ... ]
+    my %expected = ( &quot;certP1.ss&quot; =&gt; [ [ [ 'A',  'A'      ], 1 ],
+                                      [ [ 'A',  'B'      ], 0 ],
+                                      [ [ 'A',  'C'      ], 0 ],
+                                      [ [ 'A',  'A|B&amp;!C' ], 1 ],
+                                      [ [ 'B',  'A'      ], 0 ],
+                                      [ [ 'B',  'B'      ], 1 ],
+                                      [ [ 'B',  'C'      ], 0 ],
+                                      [ [ 'B',  'A|B&amp;!C' ], 1 ],
+                                      [ [ 'C',  'A'      ], 0 ],
+                                      [ [ 'C',  'B'      ], 0 ],
+                                      [ [ 'C',  'C'      ], 0 ],
+                                      [ [ 'C',  'A|B&amp;!C' ], 0 ],
+                                      [ [ 'BC', 'A'      ], 0 ],
+                                      [ [ 'BC', 'B'      ], 1 ],
+                                      [ [ 'BC', 'C'      ], 0 ],
+                                      [ [ 'BC', 'A|B&amp;!C' ], 1 ] ],
+                     &quot;certP2.ss&quot; =&gt; [ [ [ 'A',  'A'      ], 0 ],
+                                      [ [ 'A',  'B'      ], 0 ],
+                                      [ [ 'A',  'C'      ], 0 ],
+                                      [ [ 'A',  'A|B&amp;!C' ], 0 ],
+                                      [ [ 'B',  'A'      ], 0 ],
+                                      [ [ 'B',  'B'      ], 1 ],
+                                      [ [ 'B',  'C'      ], 0 ],
+                                      [ [ 'B',  'A|B&amp;!C' ], 1 ],
+                                      [ [ 'C',  'A'      ], 0 ],
+                                      [ [ 'C',  'B'      ], 0 ],
+                                      [ [ 'C',  'C'      ], 0 ],
+                                      [ [ 'C',  'A|B&amp;!C' ], 0 ],
+                                      [ [ 'BC', 'A'      ], 0 ],
+                                      [ [ 'BC', 'B'      ], 1 ],
+                                      [ [ 'BC', 'C'      ], 0 ],
+                                      [ [ 'BC', 'A|B&amp;!C' ], 1 ] ] );
+
+    foreach (@{$expected{$cert}}) {
+        my $auth = $_-&gt;[0]-&gt;[0];
+        my $cond = $_-&gt;[0]-&gt;[1];
+        my $res  = $_-&gt;[1];
+	is(run(test([@ssltest, &quot;-ssl3&quot;, &quot;-server_auth&quot;, @CA,
+                     &quot;-proxy&quot;, &quot;-proxy_auth&quot;, $auth,
+                     &quot;-proxy_cond&quot;, $cond])), $res,
+	   &quot;test tlsv1, server auth, proxy auth $auth and cond $cond (expect &quot;
+           .($res ? &quot;success&quot; : &quot;failure&quot;).&quot;)&quot;);
+    }
+}
diff --git a/test/recipes/80-test_tsa.t b/test/recipes/80-test_tsa.t
new file mode 100644
index 0000000..171592a
--- /dev/null
+++ b/test/recipes/80-test_tsa.t
@@ -0,0 +1,192 @@
+#! /usr/bin/perl
+
+use strict;
+use warnings;
+
+use POSIX;
+use File::Spec::Functions qw/splitdir curdir catfile/;
+use File::Compare;
+use OpenSSL::Test qw/:DEFAULT cmdstr top_file/;
+
+setup(&quot;test_tsa&quot;);
+
+# All these are modified inside indir further down. They need to exist
+# here, however, to be available in all subroutines.
+my $testtsa;
+my $CAtsa;
+my @RUN = (&quot;openssl&quot;, &quot;ts&quot;);
+
+sub create_tsa_cert {
+    my $INDEX = shift;
+    my $EXT = shift;
+    my $r = 1;
+    $ENV{TSDNSECT} = &quot;ts_cert_dn&quot;;
+
+    ok(run(app([&quot;openssl&quot;, &quot;req&quot;, &quot;-new&quot;,
+                &quot;-out&quot;, &quot;tsa_req${INDEX}.pem&quot;,
+                &quot;-keyout&quot;, &quot;tsa_key${INDEX}.pem&quot;])));
+    note &quot;using extension $EXT&quot;;
+    ok(run(app([&quot;openssl&quot;, &quot;x509&quot;, &quot;-req&quot;,
+                &quot;-in&quot;, &quot;tsa_req${INDEX}.pem&quot;,
+                &quot;-out&quot;, &quot;tsa_cert${INDEX}.pem&quot;,
+                &quot;-CA&quot;, &quot;tsaca.pem&quot;, &quot;-CAkey&quot;, &quot;tsacakey.pem&quot;,
+                &quot;-CAcreateserial&quot;,
+                &quot;-extfile&quot;, $ENV{OPENSSL_CONF}, &quot;-extensions&quot;, $EXT])));
+}
+
+sub create_time_stamp_response {
+    my $queryfile = shift;
+    my $outputfile = shift;
+    my $datafile = shift;
+
+    ok(run(app([@RUN, &quot;-reply&quot;, &quot;-section&quot;, &quot;$datafile&quot;,
+                &quot;-queryfile&quot;, &quot;$queryfile&quot;, &quot;-out&quot;, &quot;$outputfile&quot;])));
+}
+
+sub verify_time_stamp_response {
+    my $queryfile = shift;
+    my $inputfile = shift;
+    my $datafile = shift;
+
+    ok(run(app([@RUN, &quot;-verify&quot;, &quot;-queryfile&quot;, &quot;$queryfile&quot;,
+                &quot;-in&quot;, &quot;$inputfile&quot;, &quot;-CAfile&quot;, &quot;tsaca.pem&quot;,
+                &quot;-untrusted&quot;, &quot;tsa_cert1.pem&quot;])));
+    ok(run(app([@RUN, &quot;-verify&quot;, &quot;-data&quot;, &quot;$datafile&quot;,
+                &quot;-in&quot;, &quot;$inputfile&quot;, &quot;-CAfile&quot;, &quot;tsaca.pem&quot;,
+                &quot;-untrusted&quot;, &quot;tsa_cert1.pem&quot;])));
+}
+
+sub verify_time_stamp_response_fail {
+    my $queryfile = shift;
+    my $inputfile = shift;
+
+    ok(!run(app([@RUN, &quot;-verify&quot;, &quot;-queryfile&quot;, &quot;$queryfile&quot;,
+                 &quot;-in&quot;, &quot;$inputfile&quot;, &quot;-CAfile&quot;, &quot;tsaca.pem&quot;,
+                 &quot;-untrusted&quot;, &quot;tsa_cert1.pem&quot;])));
+}
+
+# main functions
+
+plan tests =&gt; 20;
+
+note &quot;setting up TSA test directory&quot;;
+indir &quot;tsa&quot; =&gt; sub
+{
+    $ENV{OPENSSL_CONF} = top_file(&quot;test&quot;, &quot;CAtsa.cnf&quot;);
+    # Because that's what ../apps/CA.pl really looks at
+    $ENV{SSLEAY_CONFIG} = &quot;-config &quot;.$ENV{OPENSSL_CONF};
+    $ENV{OPENSSL} = cmdstr(app([&quot;openssl&quot;]));
+    $testtsa = top_file(&quot;test&quot;, &quot;recipes&quot;, &quot;80-test_tsa.t&quot;);
+    $CAtsa = top_file(&quot;test&quot;, &quot;CAtsa.cnf&quot;);
+
+ SKIP: {
+     $ENV{TSDNSECT} = &quot;ts_ca_dn&quot;;
+     skip &quot;failed&quot;, 19
+         unless ok(run(app([&quot;openssl&quot;, &quot;req&quot;, &quot;-new&quot;, &quot;-x509&quot;, &quot;-nodes&quot;,
+                            &quot;-out&quot;, &quot;tsaca.pem&quot;, &quot;-keyout&quot;, &quot;tsacakey.pem&quot;])),
+                   'creating a new CA for the TSA tests');
+
+     skip &quot;failed&quot;, 18
+         unless subtest 'creating tsa_cert1.pem TSA server cert' =&gt; sub {
+             create_tsa_cert(&quot;1&quot;, &quot;tsa_cert&quot;)
+     };
+
+     skip &quot;failed&quot;, 17
+         unless subtest 'creating tsa_cert2.pem non-TSA server cert' =&gt; sub {
+             create_tsa_cert(&quot;2&quot;, &quot;non_tsa_cert&quot;)
+     };
+
+     skip &quot;failed&quot;, 16
+         unless ok(run(app([@RUN, &quot;-query&quot;, &quot;-data&quot;, $testtsa,
+                            &quot;-policy&quot;, &quot;tsa_policy1&quot;, &quot;-cert&quot;,
+                            &quot;-out&quot;, &quot;req1.tsq&quot;])),
+                   'creating req1.req time stamp request for file testtsa');
+
+     ok(run(app([@RUN, &quot;-query&quot;, &quot;-in&quot;, &quot;req1.tsq&quot;, &quot;-text&quot;])),
+        'printing req1.req');
+
+     subtest 'generating valid response for req1.req' =&gt; sub {
+         create_time_stamp_response(&quot;req1.tsq&quot;, &quot;resp1.tsr&quot;, &quot;tsa_config1&quot;)
+     };
+
+     ok(run(app([@RUN, &quot;-reply&quot;, &quot;-in&quot;, &quot;resp1.tsr&quot;, &quot;-text&quot;])),
+        'printing response');
+
+     subtest 'verifying valid response' =&gt; sub {
+         verify_time_stamp_response(&quot;req1.tsq&quot;, &quot;resp1.tsr&quot;, $testtsa)
+     };
+
+     skip &quot;failed&quot;, 11
+         unless subtest 'verifying valid token' =&gt; sub {
+             ok(run(app([@RUN, &quot;-reply&quot;, &quot;-in&quot;, &quot;resp1.tsr&quot;,
+                         &quot;-out&quot;, &quot;resp1.tsr.token&quot;, &quot;-token_out&quot;])));
+             ok(run(app([@RUN, &quot;-verify&quot;, &quot;-queryfile&quot;, &quot;req1.tsq&quot;,
+                         &quot;-in&quot;, &quot;resp1.tsr.token&quot;, &quot;-token_in&quot;,
+                         &quot;-CAfile&quot;, &quot;tsaca.pem&quot;,
+                         &quot;-untrusted&quot;, &quot;tsa_cert1.pem&quot;])));
+             ok(run(app([@RUN, &quot;-verify&quot;, &quot;-data&quot;, $testtsa,
+                         &quot;-in&quot;, &quot;resp1.tsr.token&quot;, &quot;-token_in&quot;,
+                         &quot;-CAfile&quot;, &quot;tsaca.pem&quot;,
+                         &quot;-untrusted&quot;, &quot;tsa_cert1.pem&quot;])));
+     };
+
+     skip &quot;failed&quot;, 10
+         unless ok(run(app([@RUN, &quot;-query&quot;, &quot;-data&quot;, $testtsa,
+                            &quot;-policy&quot;, &quot;tsa_policy2&quot;, &quot;-no_nonce&quot;,
+                            &quot;-out&quot;, &quot;req2.tsq&quot;])),
+                   'creating req2.req time stamp request for file testtsa');
+
+     ok(run(app([@RUN, &quot;-query&quot;, &quot;-in&quot;, &quot;req2.tsq&quot;, &quot;-text&quot;])),
+        'printing req2.req');
+
+     skip &quot;failed&quot;, 8
+         unless subtest 'generating valid response for req2.req' =&gt; sub {
+             create_time_stamp_response(&quot;req2.tsq&quot;, &quot;resp2.tsr&quot;, &quot;tsa_config1&quot;)
+     };
+
+     skip &quot;failed&quot;, 7
+         unless subtest 'checking -token_in and -token_out options with -reply' =&gt; sub {
+             my $RESPONSE2=&quot;resp2.tsr.copy.tsr&quot;;
+             my $TOKEN_DER=&quot;resp2.tsr.token.der&quot;;
+
+             ok(run(app([@RUN, &quot;-reply&quot;, &quot;-in&quot;, &quot;resp2.tsr&quot;,
+                         &quot;-out&quot;, &quot;$TOKEN_DER&quot;, &quot;-token_out&quot;])));
+             ok(run(app([@RUN, &quot;-reply&quot;, &quot;-in&quot;, &quot;$TOKEN_DER&quot;,
+                         &quot;-token_in&quot;, &quot;-out&quot;, &quot;$RESPONSE2&quot;])));
+             is(compare($RESPONSE2, &quot;resp2.tsr&quot;), 0);
+             ok(run(app([@RUN, &quot;-reply&quot;, &quot;-in&quot;, &quot;resp2.tsr&quot;,
+                         &quot;-text&quot;, &quot;-token_out&quot;])));
+             ok(run(app([@RUN, &quot;-reply&quot;, &quot;-in&quot;, &quot;$TOKEN_DER&quot;,
+                         &quot;-token_in&quot;, &quot;-text&quot;, &quot;-token_out&quot;])));
+             ok(run(app([@RUN, &quot;-reply&quot;, &quot;-queryfile&quot;, &quot;req2.tsq&quot;,
+                         &quot;-text&quot;, &quot;-token_out&quot;])));
+     };
+
+     ok(run(app([@RUN, &quot;-reply&quot;, &quot;-in&quot;, &quot;resp2.tsr&quot;, &quot;-text&quot;])),
+        'printing response');
+
+     subtest 'verifying valid response' =&gt; sub {
+         verify_time_stamp_response(&quot;req2.tsq&quot;, &quot;resp2.tsr&quot;, $testtsa)
+     };
+
+     subtest 'verifying response against wrong request, it should fail' =&gt; sub {
+         verify_time_stamp_response_fail(&quot;req1.tsq&quot;, &quot;resp2.tsr&quot;)
+     };
+
+     subtest 'verifying response against wrong request, it should fail' =&gt; sub {
+         verify_time_stamp_response_fail(&quot;req2.tsq&quot;, &quot;resp1.tsr&quot;)
+     };
+
+     skip &quot;failure&quot;, 2
+         unless ok(run(app([@RUN, &quot;-query&quot;, &quot;-data&quot;, $CAtsa,
+                            &quot;-no_nonce&quot;, &quot;-out&quot;, &quot;req3.tsq&quot;])),
+                   &quot;creating req3.req time stamp request for file CAtsa.cnf&quot;);
+
+     ok(run(app([@RUN, &quot;-query&quot;, &quot;-in&quot;, &quot;req3.tsq&quot;, &quot;-text&quot;])),
+        'printing req3.req');
+
+     subtest 'verifying response against wrong request, it should fail' =&gt; sub {
+         verify_time_stamp_response_fail(&quot;req3.tsq&quot;, &quot;resp1.tsr&quot;)
+     };
+    }
+}, create =&gt; 1, cleanup =&gt; 1
diff --git a/test/recipes/90-test_constant_time.t b/test/recipes/90-test_constant_time.t
new file mode 100644
index 0000000..cfdb578
--- /dev/null
+++ b/test/recipes/90-test_constant_time.t
@@ -0,0 +1,5 @@
+#! /usr/bin/perl
+
+use OpenSSL::Test::Simple;
+
+simple_test(&quot;test_constant_time&quot;, &quot;constant_time_test&quot;);
diff --git a/test/recipes/90-test_gmdiff.t b/test/recipes/90-test_gmdiff.t
new file mode 100644
index 0000000..115445e
--- /dev/null
+++ b/test/recipes/90-test_gmdiff.t
@@ -0,0 +1,5 @@
+#! /usr/bin/perl
+
+use OpenSSL::Test::Simple;
+
+simple_test(&quot;test_gmdiff&quot;, &quot;gmdifftest&quot;);
diff --git a/test/recipes/90-test_gost2814789.t b/test/recipes/90-test_gost2814789.t
new file mode 100644
index 0000000..e97128f
--- /dev/null
+++ b/test/recipes/90-test_gost2814789.t
@@ -0,0 +1,13 @@
+#! /usr/bin/perl
+
+use strict;
+use warnings;
+use OpenSSL::Test qw/:DEFAULT top_dir/;
+
+setup(&quot;test_gost2814789&quot;);
+
+$ENV{OPENSSL_ENGINES} =
+    $ENV{BIN_D} ? top_dir($ENV{BIN_D}) : top_dir(&quot;engines&quot;, &quot;ccgost&quot;);
+
+plan tests =&gt; 1;
+ok(run(test([&quot;gost2814789test&quot;])), 'running gost2814789test');
diff --git a/test/recipes/90-test_heartbeat.t b/test/recipes/90-test_heartbeat.t
new file mode 100644
index 0000000..660f630
--- /dev/null
+++ b/test/recipes/90-test_heartbeat.t
@@ -0,0 +1,5 @@
+#! /usr/bin/perl
+
+use OpenSSL::Test::Simple;
+
+simple_test(&quot;test_heartbeat&quot;, &quot;heartbeat_test&quot;);
diff --git a/test/recipes/90-test_ige.t b/test/recipes/90-test_ige.t
new file mode 100644
index 0000000..f008350
--- /dev/null
+++ b/test/recipes/90-test_ige.t
@@ -0,0 +1,5 @@
+#! /usr/bin/perl
+
+use OpenSSL::Test::Simple;
+
+simple_test(&quot;test_ige&quot;, &quot;igetest&quot;);
diff --git a/test/recipes/90-test_jpake.t b/test/recipes/90-test_jpake.t
new file mode 100644
index 0000000..fa1292a
--- /dev/null
+++ b/test/recipes/90-test_jpake.t
@@ -0,0 +1,5 @@
+#! /usr/bin/perl
+
+use OpenSSL::Test::Simple;
+
+simple_test(&quot;test_jpake&quot;, &quot;jpaketest&quot;);
diff --git a/test/recipes/90-test_np.t b/test/recipes/90-test_np.t
new file mode 100644
index 0000000..a0d8b4b
--- /dev/null
+++ b/test/recipes/90-test_np.t
@@ -0,0 +1,5 @@
+#! /usr/bin/perl
+
+use OpenSSL::Test::Simple;
+
+simple_test(&quot;test_np&quot;, &quot;nptest&quot;);
diff --git a/test/recipes/90-test_p5_crpt2.t b/test/recipes/90-test_p5_crpt2.t
new file mode 100644
index 0000000..838e0d7
--- /dev/null
+++ b/test/recipes/90-test_p5_crpt2.t
@@ -0,0 +1,5 @@
+#! /usr/bin/perl
+
+use OpenSSL::Test::Simple;
+
+simple_test(&quot;test_p5_crpt2&quot;, &quot;p5_crpt2_test&quot;);
diff --git a/test/recipes/90-test_secmem.t b/test/recipes/90-test_secmem.t
new file mode 100644
index 0000000..59f3bdd
--- /dev/null
+++ b/test/recipes/90-test_secmem.t
@@ -0,0 +1,5 @@
+#! /usr/bin/perl
+
+use OpenSSL::Test::Simple;
+
+simple_test(&quot;test_secmem&quot;, &quot;secmemtest&quot;);
diff --git a/test/recipes/90-test_srp.t b/test/recipes/90-test_srp.t
new file mode 100644
index 0000000..6be2c39
--- /dev/null
+++ b/test/recipes/90-test_srp.t
@@ -0,0 +1,5 @@
+#! /usr/bin/perl
+
+use OpenSSL::Test::Simple;
+
+simple_test(&quot;test_srp&quot;, &quot;srptest&quot;);
diff --git a/test/recipes/90-test_v3name.t b/test/recipes/90-test_v3name.t
new file mode 100644
index 0000000..2a8a472
--- /dev/null
+++ b/test/recipes/90-test_v3name.t
@@ -0,0 +1,5 @@
+#! /usr/bin/perl
+
+use OpenSSL::Test::Simple;
+
+simple_test(&quot;test_v3name&quot;, &quot;v3nametest&quot;);
diff --git a/test/recipes/bc.pl b/test/recipes/bc.pl
new file mode 100644
index 0000000..29a4a8a
--- /dev/null
+++ b/test/recipes/bc.pl
@@ -0,0 +1,97 @@
+#! /usr/bin/perl
+
+use strict;
+use warnings;
+
+use Math::BigInt;
+
+sub calc {
+    @_ = __adder(@_);
+    if (scalar @_ != 1) { return &quot;NaN&quot;; }
+    return shift;
+}
+
+sub __canonhex {
+    my ($sign, $hex) = (shift =~ /^([+\-]?)(.*)$/);
+    $hex = &quot;0x&quot;.$hex if $hex !~ /^0x/;
+    return $sign.$hex;
+}
+
+sub __adder {
+    @_ = __multiplier(@_);
+    while (scalar @_ &gt; 1 &amp;&amp; $_[1] =~ /^[\+\-]$/) {
+	my $operand1 = Math::BigInt-&gt;from_hex(__canonhex(shift));
+	my $operator = shift;
+	@_ = __multiplier(@_);
+	my $operand2 = Math::BigInt-&gt;from_hex(__canonhex(shift));
+	if ($operator eq &quot;+&quot;) {
+	    $operand1-&gt;badd($operand2);
+	} elsif ($operator eq &quot;-&quot;) {
+	    $operand1-&gt;bsub($operand2);
+	} else {
+	    die &quot;SOMETHING WENT AWFULLY WRONG&quot;;
+	}
+	unshift @_, $operand1-&gt;as_hex();
+    }
+    return @_;
+}
+
+sub __multiplier {
+    @_ = __power(@_);
+    while (scalar @_ &gt; 1 &amp;&amp; $_[1] =~ /^[\*\/%]$/) {
+	my $operand1 = Math::BigInt-&gt;from_hex(__canonhex(shift));
+	my $operator = shift;
+	@_ = __power(@_);
+	my $operand2 = Math::BigInt-&gt;from_hex(__canonhex(shift));
+	if ($operator eq &quot;*&quot;) {
+	    $operand1-&gt;bmul($operand2);
+	} elsif ($operator eq &quot;/&quot;) {
+	    $operand1-&gt;bdiv($operand2);
+	} elsif ($operator eq &quot;%&quot;) {
+	    # Here's a bit of a quirk...
+	    # With OpenSSL's BN, as well as bc, the result of -10 % 3 is -1
+	    # while Math::BigInt, the result is 2.
+	    # The latter is mathematically more correct, but...
+	    my $o1isneg = $operand1-&gt;is_neg();
+	    $operand1-&gt;babs();
+	    # Math::BigInt does something different with a negative modulus,
+	    # while OpenSSL's BN and bc treat it like a positive number...
+	    $operand2-&gt;babs();
+	    $operand1-&gt;bmod($operand2);
+	    if ($o1isneg) { $operand1-&gt;bneg(); }
+	} else {
+	    die &quot;SOMETHING WENT AWFULLY WRONG&quot;;
+	}
+	unshift @_, $operand1-&gt;as_hex();
+    }
+    return @_;
+}
+
+sub __power {
+    @_ = __paren(@_);
+    while (scalar @_ &gt; 1 &amp;&amp; $_[1] eq &quot;^&quot;) {
+	my $operand1 = Math::BigInt-&gt;from_hex(__canonhex(shift));
+	shift;
+	@_ = __paren(@_);
+	my $operand2 = Math::BigInt-&gt;from_hex(__canonhex(shift));
+	$operand1-&gt;bpow($operand2);
+	unshift @_, $operand1-&gt;as_hex();
+    }
+    return @_;
+}
+
+# returns array ( $result, @remaining )
+sub __paren {
+    if (scalar @_ &gt; 0 &amp;&amp; $_[0] eq &quot;(&quot;) {
+	shift;
+	my @result = __adder(@_);
+	if (scalar @_ == 0 || $_[0] ne &quot;)&quot;) {
+	    return (&quot;NaN&quot;);
+	}
+	shift;
+	return @result;
+    }
+    return @_;
+}
+
+1;
diff --git a/test/recipes/tconversion.pl b/test/recipes/tconversion.pl
new file mode 100644
index 0000000..011dcbf
--- /dev/null
+++ b/test/recipes/tconversion.pl
@@ -0,0 +1,88 @@
+#! /usr/bin/perl
+
+use strict;
+use warnings;
+
+use File::Compare qw/compare_text/;
+use File::Copy;
+use lib 'testlib';
+use OpenSSL::Test qw/:DEFAULT top_file/;
+
+my %conversionforms = (
+    # Default conversion forms.  Other series may be added with
+    # specific test types as key.
+    &quot;*&quot;		=&gt; [ &quot;d&quot;, &quot;p&quot; ],
+    );
+sub tconversion {
+    my $testtype = shift;
+    my $t = shift;
+    my @conversionforms = 
+	defined($conversionforms{$testtype}) ?
+	@{$conversionforms{$testtype}} :
+	@{$conversionforms{&quot;*&quot;}};
+    my @openssl_args = @_;
+    if (!@openssl_args) { @openssl_args = ($testtype); }
+
+    my $n = scalar @conversionforms;
+    my $totaltests =
+	1			# for initializing
+	+ $n			# initial conversions from p to all forms (A)
+	+ $n*$n			# conversion from result of A to all forms (B)
+	+ 1			# comparing original test file to p form of A
+	+ $n*($n-1);		# comparing first conversion to each fom in A with B
+    $totaltests-- if ($testtype eq &quot;p7d&quot;); # no comparison of original test file
+    plan tests =&gt; $totaltests;
+
+    my @cmd = (&quot;openssl&quot;, @openssl_args);
+
+    my $init;
+    if (scalar @openssl_args &gt; 0 &amp;&amp; $openssl_args[0] eq &quot;pkey&quot;) {
+	$init = ok(run(app([@cmd, &quot;-in&quot;, $t, &quot;-out&quot;, &quot;$testtype-fff.p&quot;])),
+		   'initializing');
+    } else {
+	$init = ok(copy($t, &quot;$testtype-fff.p&quot;), 'initializing');
+    }
+    if (!$init) {
+	diag(&quot;Trying to copy $t to $testtype-fff.p : $!&quot;);
+    }
+
+  SKIP: {
+      skip &quot;Not initialized, skipping...&quot;, 22 unless $init;
+
+      foreach my $to (@conversionforms) {
+	  ok(run(app([@cmd,
+		      &quot;-in&quot;, &quot;$testtype-fff.p&quot;,
+		      &quot;-inform&quot;, &quot;p&quot;,
+		      &quot;-outform&quot;, $to],
+		     stdout =&gt; &quot;$testtype-f.$to&quot;)), &quot;p -&gt; $to&quot;);
+      }
+
+      foreach my $to (@conversionforms) {
+	  foreach my $from (@conversionforms) {
+	      ok(run(app([@cmd,
+			  &quot;-in&quot;, &quot;$testtype-f.$from&quot;,
+			  &quot;-inform&quot;, $from,
+			  &quot;-outform&quot;, $to],
+			 stdout =&gt; &quot;$testtype-ff.$from$to&quot;)), &quot;$from -&gt; $to&quot;);
+	  }
+      }
+
+      if ($testtype ne &quot;p7d&quot;) {
+	  is(compare_text(&quot;$testtype-fff.p&quot;, &quot;$testtype-f.p&quot;), 0,
+	     'comparing orig to p');
+      }
+
+      foreach my $to (@conversionforms) {
+	  next if $to eq &quot;d&quot;;
+	  foreach my $from (@conversionforms) {
+	      is(compare_text(&quot;$testtype-f.$to&quot;, &quot;$testtype-ff.$from$to&quot;), 0,
+		 &quot;comparing $to to $from$to&quot;);
+	  }
+      }
+    }
+    unlink glob &quot;$testtype-f.*&quot;;
+    unlink glob &quot;$testtype-ff.*&quot;;
+    unlink glob &quot;$testtype-fff.*&quot;;
+}
+
+1;
diff --git a/test/run_tests.pl b/test/run_tests.pl
new file mode 100644
index 0000000..7e61282
--- /dev/null
+++ b/test/run_tests.pl
@@ -0,0 +1,45 @@
+#! /usr/bin/perl
+
+use strict;
+use warnings;
+
+use File::Spec::Functions qw/catdir catfile curdir abs2rel rel2abs/;
+use File::Basename;
+use Test::Harness qw/runtests $switches/;
+
+my $top = $ENV{TOP};
+my $recipesdir = catdir($top, &quot;test&quot;, &quot;recipes&quot;);
+my $testlib = catdir($top, &quot;test&quot;, &quot;testlib&quot;);
+my $utillib = catdir($top, &quot;util&quot;);
+
+# It seems that $switches is getting interpretted with 'eval' or something
+# like that, and that we need to take care of backslashes or they will
+# disappear along the way.
+$testlib =~ s|\\|\\\\|g if $^O eq &quot;MSWin32&quot;;
+$utillib =~ s|\\|\\\\|g if $^O eq &quot;MSWin32&quot;;
+
+# Test::Harness provides the variable $switches to give it
+# switches to be used when it calls our recipes.
+$switches = &quot;-w \&quot;-I$testlib\&quot; \&quot;-I$utillib\&quot;&quot;;
+
+my @tests = ( &quot;alltests&quot; );
+if (@ARGV) {
+    @tests = @ARGV;
+}
+if (grep /^alltests$/, @tests) {
+    @tests = grep {
+	basename($_) =~ /^[0-9][0-9]-[^\.]*\.t$/
+    } glob(catfile($recipesdir,&quot;*.t&quot;));
+} else {
+    my @t = ();
+    foreach (@tests) {
+	push @t, grep {
+	    basename($_) =~ /^[0-9][0-9]-[^\.]*\.t$/
+	} glob(catfile($recipesdir,&quot;*-$_.t&quot;));
+    }
+    @tests = @t;
+}
+
<A HREF="../../../mailman/listinfo/openssl-commits.html">+ at tests</A> = map { abs2rel($_, rel2abs(curdir())); } @tests;
+
+runtests(sort @tests);
diff --git a/test/testlib/OpenSSL/Test.pm b/test/testlib/OpenSSL/Test.pm
new file mode 100644
index 0000000..f378351
--- /dev/null
+++ b/test/testlib/OpenSSL/Test.pm
@@ -0,0 +1,741 @@
+package OpenSSL::Test;
+
+use strict;
+use warnings;
+
+use Test::More 0.96;
+
+use Exporter;
+use vars qw($VERSION @ISA @EXPORT @EXPORT_OK %EXPORT_TAGS);
+$VERSION = &quot;0.7&quot;;
<A HREF="../../../mailman/listinfo/openssl-commits.html">+ at ISA</A> = qw(Exporter);
<A HREF="../../../mailman/listinfo/openssl-commits.html">+ at EXPORT</A> = (@Test::More::EXPORT, qw(setup indir app test run));
<A HREF="../../../mailman/listinfo/openssl-commits.html">+ at EXPORT_OK</A> = (@Test::More::EXPORT_OK, qw(top_dir top_file pipe with cmdstr
+                                         quotify));
+
+=head1 NAME
+
+OpenSSL::Test - a private extension of Test::More
+
+=head1 SYNOPSIS
+
+  use OpenSSL::Test;
+
+  setup(&quot;my_test_name&quot;);
+
+  ok(run(app([&quot;openssl&quot;, &quot;version&quot;])), &quot;check for openssl presence&quot;);
+
+  indir &quot;subdir&quot; =&gt; sub {
+    ok(run(test([&quot;sometest&quot;, &quot;arg1&quot;], stdout =&gt; &quot;foo.txt&quot;)),
+       &quot;run sometest with output to foo.txt&quot;);
+  };
+
+=head1 DESCRIPTION
+
+This module is a private extension of L&lt;Test::More&gt; for testing OpenSSL.
+In addition to the Test::More functions, it also provides functions that
+easily find the diverse programs within a OpenSSL build tree, as well as
+some other useful functions.
+
+This module I&lt;depends&gt; on the environment variable C&lt;$TOP&gt;.  Without it,
+it refuses to work.  See L&lt;/ENVIRONMENT&gt; below.
+
+=cut
+
+use File::Copy;
+use File::Spec::Functions qw/file_name_is_absolute curdir canonpath splitdir
+                             catdir catfile splitpath catpath devnull abs2rel
+                             rel2abs/;
+use File::Path 2.00 qw/remove_tree mkpath/;
+
+
+# The name of the test.  This is set by setup() and is used in the other
+# functions to verify that setup() has been used.
+my $test_name = undef;
+
+# Directories we want to keep track of TOP, APPS, TEST and RESULTS are the
+# ones we're interested in, corresponding to the environment variables TOP
+# (mandatory), BIN_D, TEST_D and RESULT_D.
+my %directories = ();
+
+# A bool saying if we shall stop all testing if the current recipe has failing
+# tests or not.  This is set by setup() if the environment variable STOPTEST
+# is defined with a non-empty value.
+my $end_with_bailout = 0;
+
+# A set of hooks that is affected by with() and may be used in diverse places.
+# All hooks are expected to be CODE references.
+my %hooks = (
+
+    # exit_checker is used by run() directly after completion of a command.
+    # it receives the exit code from that command and is expected to return
+    # 1 (for success) or 0 (for failure).  This is the value that will be
+    # returned by run().
+    # NOTE: When run() gets the option 'capture =&gt; 1', this hook is ignored.
+    exit_checker =&gt; sub { return shift == 0 ? 1 : 0 },
+
+    );
+
+# Declare some utility functions that are defined at the end
+sub top_file;
+sub top_dir;
+sub quotify;
+
+# Declare some private functions that are defined at the end
+sub __env;
+sub __cwd;
+sub __apps_file;
+sub __results_file;
+sub __test_log;
+sub __cwd;
+sub __fixup_cmd;
+sub __build_cmd;
+
+=head2 Main functions
+
+The following functions are exported by default when using C&lt;OpenSSL::Test&gt;.
+
+=cut
+
+=over 4
+
+=item B&lt;setup &quot;NAME&quot;&gt;
+
+C&lt;setup&gt; is used for initial setup, and it is mandatory that it's used.
+If it's not used in a OpenSSL test recipe, the rest of the recipe will
+most likely refuse to run.
+
+C&lt;setup&gt; checks for environment variables (see L&lt;/ENVIRONMENT&gt; below),
+check that C&lt;$TOP/Configure&gt; exists, C&lt;chdir&gt; into the results directory
+(defined by the C&lt;$RESULT_D&gt; environment variable if defined, otherwise
+C&lt;$TEST_D&gt; if defined, otherwise C&lt;$TOP/test&gt;).
+
+=back
+
+=cut
+
+sub setup {
+    $test_name = shift;
+
+    BAIL_OUT(&quot;setup() must receive a name&quot;) unless $test_name;
+    BAIL_OUT(&quot;setup() needs \$TOP to be defined&quot;) unless $ENV{TOP};
+
+    __env();
+
+    BAIL_OUT(&quot;setup() expects the file Configure in the \$TOP directory&quot;)
+	unless -f top_file(&quot;Configure&quot;);
+
+    __cwd($directories{RESULTS});
+
+    # Loop in case we're on a platform with more than one file generation
+    1 while unlink(__test_log());
+}
+
+=over 4
+
+=item B&lt;indir &quot;SUBDIR&quot; =E&lt;gt&gt; sub BLOCK, OPTS&gt;
+
+C&lt;indir&gt; is used to run a part of the recipe in a different directory than
+the one C&lt;setup&gt; moved into, usually a subdirectory, given by SUBDIR.
+The part of the recipe that's run there is given by the codeblock BLOCK.
+
+C&lt;indir&gt; takes some additional options OPTS that affect the subdirectory:
+
+=over 4
+
+=item B&lt;create =E&lt;gt&gt; 0|1&gt;
+
+When set to 1 (or any value that perl preceives as true), the subdirectory
+will be created if it doesn't already exist.  This happens before BLOCK
+is executed.
+
+=item B&lt;cleanup =E&lt;gt&gt; 0|1&gt;
+
+When set to 1 (or any value that perl preceives as true), the subdirectory
+will be cleaned out and removed.  This happens both before and after BLOCK
+is executed.
+
+=back
+
+An example:
+
+  indir &quot;foo&quot; =&gt; sub {
+      ok(run(app([&quot;openssl&quot;, &quot;version&quot;]), stdout =&gt; &quot;foo.txt&quot;));
+      if (ok(open(RESULT, &quot;foo.txt&quot;), &quot;reading foo.txt&quot;)) {
+          my $line = &lt;RESULT&gt;;
+          close RESULT;
+          is($line, qr/^OpenSSL 1\./,
+             &quot;check that we're using OpenSSL 1.x.x&quot;);
+      }
+  }, create =&gt; 1, cleanup =&gt; 1;
+
+=back
+
+=cut
+
+sub indir {
+    my $subdir = shift;
+    my $codeblock = shift;
+    my %opts = @_;
+
+    my $reverse = __cwd($subdir,%opts);
+    BAIL_OUT(&quot;FAILURE: indir, \&quot;$subdir\&quot; wasn't possible to move into&quot;)
+	unless $reverse;
+
+    $codeblock-&gt;();
+
+    __cwd($reverse);
+
+    if ($opts{cleanup}) {
+	remove_tree($subdir, { safe =&gt; 0 });
+    }
+}
+
+=over 4
+
+=item B&lt;app ARRAYREF, OPTS&gt;
+
+=item B&lt;test ARRAYREF, OPTS&gt;
+
+Both of these functions take a reference to a list that is a command and
+its arguments, and some additional options (described further on).
+
+C&lt;app&gt; expects to find the given command (the first item in the given list
+reference) as an executable in C&lt;$BIN_D&gt; (if defined, otherwise C&lt;$TOP/apps&gt;).
+
+C&lt;test&gt; expects to find the given command (the first item in the given list
+reference) as an executable in C&lt;$TEST_D&gt; (if defined, otherwise C&lt;$TOP/test&gt;).
+
+Both return a CODEREF to be used by C&lt;run&gt;, C&lt;pipe&gt; or C&lt;cmdstr&gt;.
+
+The options that both C&lt;app&gt; and C&lt;test&gt; can take are in the form of hash
+values:
+
+=over 4
+
+=item B&lt;stdin =E&lt;gt&gt; PATH&gt;
+
+=item B&lt;stdout =E&lt;gt&gt; PATH&gt;
+
+=item B&lt;stderr =E&lt;gt&gt; PATH&gt;
+
+In all three cases, the corresponding standard input, output or error is
+redirected from (for stdin) or to (for the others) a file given by the
+string PATH, I&lt;or&gt;, if the value is C&lt;undef&gt;, C&lt;/dev/null&gt; or similar.
+
+=back
+
+=back
+
+=cut
+
+sub app {
+    my $cmd = shift;
+    my %opts = @_;
+    return sub { my $num = shift;
+		 return __build_cmd($num, \&amp;__apps_file, $cmd, %opts); }
+}
+
+sub test {
+    my $cmd = shift;
+    my %opts = @_;
+    return sub { my $num = shift;
+		 return __build_cmd($num, \&amp;__test_file, $cmd, %opts); }
+}
+
+=over 4
+
+=item B&lt;run CODEREF, OPTS&gt;
+
+This CODEREF is expected to be the value return by C&lt;app&gt; or C&lt;test&gt;,
+anything else will most likely cause an error unless you know what you're
+doing.
+
+C&lt;run&gt; executes the command returned by CODEREF and return either the
+resulting output (if the option C&lt;capture&gt; is set true) or a boolean indicating
+if the command succeeded or not.
+
+The options that C&lt;run&gt; can take are in the form of hash values:
+
+=over 4
+
+=item B&lt;capture =E&lt;gt&gt; 0|1&gt;
+
+If true, the command will be executed with a perl backtick, and C&lt;run&gt; will
+return the resulting output as an array of lines.  If false or not given,
+the command will be executed with C&lt;system()&gt;, and C&lt;run&gt; will return 1 if
+the command was successful or 0 if it wasn't.
+
+=back
+
+For further discussion on what is considered a successful command or not, see
+the function C&lt;with&gt; further down.
+
+=back
+
+=cut
+
+sub run {
+    my ($cmd, $display_cmd, %errlogs) = shift-&gt;(0);
+    my %opts = @_;
+
+    return () if !$cmd;
+
+    my $prefix = &quot;&quot;;
+    if ( $^O eq &quot;VMS&quot; ) {	# VMS
+	$prefix = &quot;pipe &quot;;
+    } elsif ($^O eq &quot;MSWin32&quot;) { # MSYS
+	$prefix = &quot;cmd /c &quot;;
+    }
+
+    my @r = ();
+    my $r = 0;
+    my $e = 0;
+    if ($opts{capture}) {
+	@r = `$prefix$cmd`;
+	$e = $? &gt;&gt; 8;
+    } else {
+	system(&quot;$prefix$cmd&quot;);
+	$e = $? &gt;&gt; 8;
+	$r = $hooks{exit_checker}-&gt;($e);
+    }
+
+    # At this point, $? stops being interesting, and unfortunately,
+    # there are Test::More versions that get picky if we leave it
+    # non-zero.
+    $? = 0;
+
+    open ERR, &quot;&gt;&gt;&quot;, __test_log();
+    { local $| = 1; print ERR &quot;$display_cmd =&gt; $e\n&quot;; }
+    foreach (keys %errlogs) {
+	copy($_,\*ERR);
+	copy($_,$errlogs{$_}) if defined($errlogs{$_});
+	unlink($_);
+    }
+    close ERR;
+
+    if ($opts{capture}) {
+	return @r;
+    } else {
+	return $r;
+    }
+}
+
+END {
+    my $tb = Test::More-&gt;builder;
+    my $failure = scalar(grep { $_ == 0; } $tb-&gt;summary);
+    if ($failure &amp;&amp; $end_with_bailout) {
+	BAIL_OUT(&quot;Stoptest!&quot;);
+    }
+}
+
+=head2 Utility functions
+
+The following functions are exported on request when using C&lt;OpenSSL::Test&gt;.
+
+  # To only get the top_file function.
+  use OpenSSL::Test qw/top_file/;
+
+  # To only get the top_file function in addition to the default ones.
+  use OpenSSL::Test qw/:DEFAULT top_file/;
+
+=cut
+
+# Utility functions, exported on request
+
+=over 4
+
+=item B&lt;top_dir LIST&gt;
+
+LIST is a list of directories that make up a path from the top of the OpenSSL
+source directory (as indicated by the environment variable C&lt;$TOP&gt;).
+C&lt;top_dir&gt; returns the resulting directory as a string, adapted to the local
+operating system.
+
+=back
+
+=cut
+
+sub top_dir {
+    return __top_file(@_, &quot;&quot;);	# This caters for operating systems that have
+				# a very distinct syntax for directories.
+}
+
+=over 4
+
+=item B&lt;top_file LIST, FILENAME&gt;
+
+LIST is a list of directories that make up a path from the top of the OpenSSL
+source directory (as indicated by the environment variable C&lt;$TOP&gt;) and
+FILENAME is the name of a file located in that directory path.
+C&lt;top_file&gt; returns the resulting file path as a string, adapted to the local
+operating system.
+
+=back
+
+=cut
+
+sub top_file {
+    return __top_file(@_);
+}
+
+=over 4
+
+=item B&lt;pipe LIST&gt;
+
+LIST is a list of CODEREFs returned by C&lt;app&gt; or C&lt;test&gt;, from which C&lt;pipe&gt;
+creates a new command composed of all the given commands put together in a
+pipe.  C&lt;pipe&gt; returns a new CODEREF in the same manner as C&lt;app&gt; or C&lt;test&gt;,
+to be passed to C&lt;run&gt; for execution.
+
+=back
+
+=cut
+
+sub pipe {
+    my @cmds = @_;
+    return
+	sub {
+	    my @cs  = ();
+	    my @dcs = ();
+	    my @els = ();
+	    my $counter = 0;
+	    foreach (@cmds) {
+		my ($c, $dc, @el) = $_-&gt;(++$counter);
+
+		return () if !$c;
+
+		push @cs, $c;
+		push @dcs, $dc;
+		push @els, @el;
+	    }
+	    return (
+		join(&quot; | &quot;, @cs),
+		join(&quot; | &quot;, @dcs),
+		@els
+		);
+    };
+}
+
+=over 4
+
+=item B&lt;with HASHREF, CODEREF&gt;
+
+C&lt;with&gt; will temporarly install hooks given by the HASHREF and then execute
+the given CODEREF.  Hooks are usually expected to have a coderef as value.
+
+The currently available hoosk are:
+
+=over 4
+
+=item B&lt;exit_checker =E&lt;gt&gt; CODEREF&gt;
+
+This hook is executed after C&lt;run&gt; has performed its given command.  The
+CODEREF receives the exit code as only argument and is expected to return
+1 (if the exit code indicated success) or 0 (if the exit code indicated
+failure).
+
+=back
+
+=back
+
+=cut
+
+sub with {
+    my $opts = shift;
+    my %opts = %{$opts};
+    my $codeblock = shift;
+
+    my %saved_hooks = ();
+
+    foreach (keys %opts) {
+	$saved_hooks{$_} = $hooks{$_}	if exists($hooks{$_});
+	$hooks{$_} = $opts{$_};
+    }
+
+    $codeblock-&gt;();
+
+    foreach (keys %saved_hooks) {
+	$hooks{$_} = $saved_hooks{$_};
+    }
+}
+
+=over 4
+
+=item B&lt;cmdstr CODEREF&gt;
+
+C&lt;cmdstr&gt; takes a CODEREF from C&lt;app&gt; or C&lt;test&gt; and simply returns the
+command as a string.
+
+=back
+
+=cut
+
+sub cmdstr {
+    my ($cmd, $display_cmd, %errlogs) = shift-&gt;(0);
+
+    return $display_cmd;
+}
+
+=over 4
+
+=item B&lt;quotify LIST&gt;
+
+LIST is a list of strings that are going to be used as arguments for a
+command, and makes sure to inject quotes and escapes as necessary depending
+on the content of each string.
+
+This can also be used to put quotes around the executable of a command.
+I&lt;This must never ever be done on VMS.&gt;
+
+=back
+
+=cut
+
+sub quotify {
+    # Unix setup (default if nothing else is mentioned)
+    my $arg_formatter =
+	sub { $_ = shift; /\s|[\{\}\\\$\[\]\*\?\|\&amp;:;&lt;&gt;]/ ? &quot;'$_'&quot; : $_ };
+
+    if ( $^O eq &quot;VMS&quot;) {	# VMS setup
+	$arg_formatter = sub {
+	    $_ = shift;
+	    if (/\s|[&quot;[:upper:]]/) {
+		s/&quot;/&quot;&quot;/g;
+		'&quot;'.$_.'&quot;';
+	    } else {
+		$_;
+	    }
+	};
+    } elsif ( $^O eq &quot;MSWin32&quot;) { # MSWin setup
+	$arg_formatter = sub {
+	    $_ = shift;
+	    if (/\s|[&quot;\|\&amp;\*\;&lt;&gt;]/) {
+		s/([&quot;\\])/\\$1/g;
+		'&quot;'.$_.'&quot;';
+	    } else {
+		$_;
+	    }
+	};
+    }
+
+    return map { $arg_formatter-&gt;($_) } @_;
+}
+
+######################################################################
+# private functions.  These are never exported.
+
+=head1 ENVIRONMENT
+
+OpenSSL::Test depends on some environment variables.
+
+=over 4
+
+=item B&lt;TOP&gt;
+
+This environment variable is mandatory.  C&lt;setup&gt; will check that it's
+defined and that it's a directory that contains the file C&lt;Configure&gt;.
+If this isn't so, C&lt;setup&gt; will C&lt;BAIL_OUT&gt;.
+
+=item B&lt;BIN_D&gt;
+
+If defined, its value should be the directory where the openssl application
+is located.  Defaults to C&lt;$TOP/apps&gt; (adapted to the operating system).
+
+=item B&lt;TEST_D&gt;
+
+If defined, its value should be the directory where the test applications
+are located.  Defaults to C&lt;$TOP/test&gt; (adapted to the operating system).
+
+=item B&lt;RESULT_D&gt;
+
+If defined, its value should be the directory where the log files are
+located.  Defaults to C&lt;$TEST_D&gt;.
+
+=item B&lt;STOPTEST&gt;
+
+If defined, it puts testing in a different mode, where a recipe with
+failures will result in a C&lt;BAIL_OUT&gt; at the end of its run.
+
+=back
+
+=cut
+
+sub __env {
+    $directories{TOP}     = $ENV{TOP},
+    $directories{APPS}    = $ENV{BIN_D}    || catdir($directories{TOP},&quot;apps&quot;);
+    $directories{TEST}    = $ENV{TEST_D}   || catdir($directories{TOP},&quot;test&quot;);
+    $directories{RESULTS} = $ENV{RESULT_D} || $directories{TEST};
+
+    $end_with_bailout	  = $ENV{STOPTEST} ? 1 : 0;
+};
+
+sub __top_file {
+    BAIL_OUT(&quot;Must run setup() first&quot;) if (! $test_name);
+
+    my $f = pop;
+    return catfile($directories{TOP}<A HREF="../../../mailman/listinfo/openssl-commits.html">, at _</A>,$f);
+}
+
+sub __test_file {
+    BAIL_OUT(&quot;Must run setup() first&quot;) if (! $test_name);
+
+    my $f = pop;
+    return catfile($directories{TEST}<A HREF="../../../mailman/listinfo/openssl-commits.html">, at _</A>,$f);
+}
+
+sub __apps_file {
+    BAIL_OUT(&quot;Must run setup() first&quot;) if (! $test_name);
+
+    my $f = pop;
+    return catfile($directories{APPS}<A HREF="../../../mailman/listinfo/openssl-commits.html">, at _</A>,$f);
+}
+
+sub __results_file {
+    BAIL_OUT(&quot;Must run setup() first&quot;) if (! $test_name);
+
+    my $f = pop;
+    return catfile($directories{RESULTS}<A HREF="../../../mailman/listinfo/openssl-commits.html">, at _</A>,$f);
+}
+
+sub __test_log {
+    return __results_file(&quot;$test_name.log&quot;);
+}
+
+sub __cwd {
+    my $dir = shift;
+    my %opts = @_;
+    my $abscurdir = rel2abs(curdir());
+    my $absdir = rel2abs($dir);
+    my $reverse = abs2rel($abscurdir, $absdir);
+
+    # PARANOIA: if we're not moving anywhere, we do nothing more
+    if ($abscurdir eq $absdir) {
+	return $reverse;
+    }
+
+    # Do not support a move to a different volume for now.  Maybe later.
+    BAIL_OUT(&quot;FAILURE: \&quot;$dir\&quot; moves to a different volume, not supported&quot;)
+	if $reverse eq $abscurdir;
+
+    # If someone happened to give a directory that leads back to the current,
+    # it's extremely silly to do anything more, so just simulate that we did
+    # move.
+    # In this case, we won't even clean it out, for safety's sake.
+    return &quot;.&quot; if $reverse eq &quot;&quot;;
+
+    $dir = canonpath($dir);
+    if ($opts{create}) {
+	mkpath($dir);
+    }
+
+    # Should we just bail out here as well?  I'm unsure.
+    return undef unless chdir($dir);
+
+    if ($opts{cleanup}) {
+	remove_tree(&quot;.&quot;, { safe =&gt; 0, keep_root =&gt; 1 });
+    }
+
+    # For each of these directory variables, figure out where they are relative
+    # to the directory we want to move to if they aren't absolute (if they are,
+    # they don't change!)
+    my @dirtags = (&quot;TOP&quot;, &quot;TEST&quot;, &quot;APPS&quot;, &quot;RESULTS&quot;);
+    foreach (@dirtags) {
+	if (!file_name_is_absolute($directories{$_})) {
+	    my $newpath = abs2rel(rel2abs($directories{$_}), rel2abs($dir));
+	    $directories{$_} = $newpath;
+	}
+    }
+
+    if (0) {
+	print STDERR &quot;DEBUG: __cwd(), directories and files:\n&quot;;
+	print STDERR &quot;  \$directories{TEST}    = \&quot;$directories{TEST}\&quot;\n&quot;;
+	print STDERR &quot;  \$directories{RESULTS} = \&quot;$directories{RESULTS}\&quot;\n&quot;;
+	print STDERR &quot;  \$directories{APPS}    = \&quot;$directories{APPS}\&quot;\n&quot;;
+	print STDERR &quot;  \$directories{TOP}     = \&quot;$directories{TOP}\&quot;\n&quot;;
+	print STDERR &quot;  \$test_log             = \&quot;&quot;,__test_log(),&quot;\&quot;\n&quot;;
+	print STDERR &quot;\n&quot;;
+	print STDERR &quot;  current directory is \&quot;&quot;,curdir(),&quot;\&quot;\n&quot;;
+	print STDERR &quot;  the way back is \&quot;$reverse\&quot;\n&quot;;
+    }
+
+    return $reverse;
+}
+
+sub __fixup_cmd {
+    my $prog = shift;
+
+    my $prefix = __top_file(&quot;util&quot;, &quot;shlib_wrap.sh&quot;).&quot; &quot;;
+    my $ext = $ENV{&quot;EXE_EXT&quot;} || &quot;&quot;;
+
+    if ( $^O eq &quot;VMS&quot; ) {	# VMS
+	$prefix = &quot;mcr &quot;;
+	$ext = &quot;.exe&quot;;
+    } elsif ($^O eq &quot;MSWin32&quot;) { # Windows
+	$prefix = &quot;&quot;;
+	$ext = &quot;.exe&quot;;
+    }
+
+    # We test both with and without extension.  The reason
+    # is that we might, for example, be passed a Perl script
+    # ending with .pl...
+    my $file = &quot;$prog$ext&quot;;
+    if ( -x $file ) {
+	return $prefix.$file;
+    } elsif ( -f $prog ) {
+	return $prog;
+    }
+
+    print STDERR &quot;$prog not found\n&quot;;
+    return undef;
+}
+
+sub __build_cmd {
+    BAIL_OUT(&quot;Must run setup() first&quot;) if (! $test_name);
+
+    my $num = shift;
+    my $path_builder = shift;
+    # Make a copy to not destroy the caller's array
+    my @cmdarray = ( @{$_[0]} ); shift;
+    my $cmd = __fixup_cmd($path_builder-&gt;(shift @cmdarray));
+    my @args = @cmdarray;
+    my %opts = @_;
+
+    return () if !$cmd;
+
+    my $arg_str = &quot;&quot;;
+    my $null = devnull();
+
+
+    $arg_str = &quot; &quot;.join(&quot; &quot;, quotify @args) if @args;
+
+    my $fileornull = sub { $_[0] ? $_[0] : $null; };
+    my $stdin = &quot;&quot;;
+    my $stdout = &quot;&quot;;
+    my $stderr = &quot;&quot;;
+    my $saved_stderr = undef;
+    $stdin = &quot; &lt; &quot;.$fileornull-&gt;($opts{stdin})  if exists($opts{stdin});
+    $stdout= &quot; &gt; &quot;.$fileornull-&gt;($opts{stdout}) if exists($opts{stdout});
+    $stderr=&quot; 2&gt; &quot;.$fileornull-&gt;($opts{stderr}) if exists($opts{stderr});
+
+    $saved_stderr = $opts{stderr}		if defined($opts{stderr});
+
+    my $errlog = $num ? &quot;$test_name.$num.tmp_err&quot; : &quot;$test_name.tmp_err&quot;;
+    my $display_cmd = &quot;$cmd$arg_str$stdin$stdout$stderr&quot;;
+    $cmd .= &quot;$arg_str$stdin$stdout 2&gt; $errlog&quot;;
+
+    return ($cmd, $display_cmd, $errlog =&gt; $saved_stderr);
+}
+
+=head1 SEE ALSO
+
+L&lt;Test::More&gt;, L&lt;Test::Harness&gt;
+
+=head1 AUTHORS
+
+Richard Levitte E&lt;lt&gt;<A HREF="../../../mailman/listinfo/openssl-commits.html">levitte at openssl.orgE</A>&lt;gt&gt; with assitance and
+inspiration from Andy Polyakov E&lt;lt&gt;<A HREF="../../../mailman/listinfo/openssl-commits.html">appro at openssl.org</A>&lt;gt&gt;.
+
+=cut
+
+1;
diff --git a/test/testlib/OpenSSL/Test/Simple.pm b/test/testlib/OpenSSL/Test/Simple.pm
new file mode 100644
index 0000000..874a156
--- /dev/null
+++ b/test/testlib/OpenSSL/Test/Simple.pm
@@ -0,0 +1,78 @@
+package OpenSSL::Test::Simple;
+
+use strict;
+use warnings;
+
+use Exporter;
+use vars qw($VERSION @ISA @EXPORT @EXPORT_OK %EXPORT_TAGS);
+$VERSION = &quot;0.2&quot;;
<A HREF="../../../mailman/listinfo/openssl-commits.html">+ at ISA</A> = qw(Exporter);
<A HREF="../../../mailman/listinfo/openssl-commits.html">+ at EXPORT</A> = qw(simple_test);
+
+=head1 NAME
+
+OpenSSL::Test::Simple - a few very simple test functions
+
+=head1 SYNOPSIS
+
+  use OpenSSL::Test::Simple;
+
+  simple_test(&quot;my_test_name&quot;, &quot;des&quot;, &quot;destest&quot;);
+
+=head1 DESCRIPTION
+
+Sometimes, the functions in L&lt;OpenSSL::Test&gt; are quite tedious for some
+repetitive tasks.  This module provides functions to make life easier.
+You could call them hacks if you wish.
+
+=cut
+
+use OpenSSL::Test;
+
+=over 4
+
+=item B&lt;simple_test NAME, PROGRAM, ALGORITHM&gt;
+
+Runs a test named NAME, running the program PROGRAM with no arguments,
+to test the algorithm ALGORITHM.
+
+A complete recipe looks like this:
+
+  use OpenSSL::Test::Simple;
+
+  simple_test(&quot;test_bf&quot;, &quot;bftest&quot;, &quot;bf&quot;);
+
+=back
+
+=cut
+
+# args:
+#  name			(used with setup())
+#  algorithm		(used to check if it's at all supported)
+#  name of binary	(the program that does the actual test)
+sub simple_test {
+    my ($name, $prgr, $algo, @rest) = @_;
+
+    setup($name);
+
+    plan tests =&gt; 1;
+  SKIP: {
+      skip &quot;$algo is not supported by this OpenSSL build, skipping this test...&quot;, 1
+	  if $algo &amp;&amp; run(app([&quot;openssl&quot;, &quot;no-$algo&quot;]));
+
+      ok(run(test([$prgr])), &quot;running $prgr&quot;);
+    }
+}
+
+=head1 SEE ALSO
+
+L&lt;OpenSSL::Test&gt;
+
+=head1 AUTHORS
+
+Richard Levitte E&lt;lt&gt;<A HREF="../../../mailman/listinfo/openssl-commits.html">levitte at openssl.orgE</A>&lt;gt&gt; with inspiration
+from Rich Salz E&lt;lt&gt;<A HREF="../../../mailman/listinfo/openssl-commits.html">rsalz at openssl.org</A>&lt;gt&gt;.
+
+=cut
+
+1;
diff --git a/util/mk1mf.pl b/util/mk1mf.pl
index 6091a69..9d8a47d 100755
--- a/util/mk1mf.pl
+++ b/util/mk1mf.pl
@@ -752,7 +752,9 @@ headers: \$(HEADER)
 
 lib: \$(LIBS_DEP) \$(E_SHLIB)
 
-exe: \$(T_EXE) \$(BIN_D)$o\$(E_EXE)$exep
+exe: apps testapps
+apps: \$(BIN_D)$o\$(E_EXE)$exep
+testapps: \$(T_EXE)
 
 install: all
 	\$(MKDIR) \&quot;\$(INSTALLTOP)\&quot;
@@ -777,15 +779,8 @@ reallyclean:
 
 EOF
 
-if ($orig_platform ne 'copy')
-	{
-        $rules .= &lt;&lt;&quot;EOF&quot;;
-test: \$(T_EXE)
-	cd \$(BIN_D)
-	..${o}ms${o}test
-
-EOF
-	}
+$rules .= &amp;do_rehash_rule(&quot;rehash&quot;, &quot;certs apps&quot;);
+$rules .= &amp;do_test_rule(&quot;test&quot;, &quot;rehash&quot;, &quot;run_tests.pl&quot;);
 
 my $platform_cpp_symbol = &quot;MK1MF_PLATFORM_$platform&quot;;
 $platform_cpp_symbol =~ s/-/_/g;
@@ -1004,8 +999,6 @@ if ($fips)
 
 $rules.=&amp;do_link_rule(&quot;\$(BIN_D)$o\$(E_EXE)$exep&quot;,&quot;\$(E_OBJ)&quot;,&quot;\$(LIBS_DEP)&quot;,&quot;\$(L_LIBS) \$(EX_LIBS)&quot;, ($fips &amp;&amp; !$shlib) ? 2 : 0);
 
-$rules .= get_tests('test/Makefile') if $orig_platform eq 'copy';
-
 print $defs;
 
 if ($platform eq &quot;linux-elf&quot;) {
diff --git a/util/pl/BC-32.pl b/util/pl/BC-32.pl
index fd5c4b6..3b2b854 100644
--- a/util/pl/BC-32.pl
+++ b/util/pl/BC-32.pl
@@ -94,6 +94,29 @@ if ($shlib)
 	$tmp_def=&quot;tmp32dll&quot;;
 	}
 
+sub do_rehash_rule {
+    my ($target, $deps) = @_;
+    my $ret = &lt;&lt;&quot;EOF&quot;;
+$target: $deps
+	set OPENSSL=\$(BIN_D)${o}openssl.exe
+	set OPENSSL_DEBUG_MEMORY=on
+	\$(PERL) tools/c_rehash certs/demo
+EOF
+    return $ret
+}
+sub do_test_rule {
+    my ($target, $deps, $test_cmd) = @_;
+    my $ret = &lt;&lt;&quot;EOF&quot;;
+$target: $deps force.$target
+	set TOP=.
+	set BIN_D=\$(BIN_D)
+	set TEST_D=\$(TEST_D)
+	set PERL=\$(PERL)
+	\$(PERL) test\\$test_cmd
+force.$target:
+EOF
+}
+
 sub do_lib_rule
 	{
 	local($objs,$target,$name,$shlib)=@_;
diff --git a/util/pl/VC-32.pl b/util/pl/VC-32.pl
index bf6aebf..a2d35c6 100644
--- a/util/pl/VC-32.pl
+++ b/util/pl/VC-32.pl
@@ -300,6 +300,29 @@ elsif ($shlib &amp;&amp; $FLAVOR =~ /CE/)
 	$lib_cflag.=&quot; -D_DLL&quot; if (!$fipscanisterbuild);
 	}
 
+sub do_rehash_rule {
+    my ($target, $deps) = @_;
+    my $ret = &lt;&lt;&quot;EOF&quot;;
+$target: $deps
+	set OPENSSL=\$(BIN_D)${o}openssl.exe
+	set OPENSSL_DEBUG_MEMORY=on
+	\$(PERL) tools/c_rehash certs/demo
+EOF
+    return $ret
+}
+sub do_test_rule {
+    my ($target, $deps, $test_cmd) = @_;
+    my $ret = &lt;&lt;&quot;EOF&quot;;
+$target: $deps force.$target
+	set TOP=.
+	set BIN_D=\$(BIN_D)
+	set TEST_D=\$(TEST_D)
+	set PERL=\$(PERL)
+	\$(PERL) test\\$test_cmd
+force.$target:
+EOF
+}
+
 sub do_lib_rule
 	{
 	my($objs,$target,$name,$shlib,$ign,$base_addr) = @_;
diff --git a/util/pl/unix.pl b/util/pl/unix.pl
index 40bbe0d..528d4d0 100644
--- a/util/pl/unix.pl
+++ b/util/pl/unix.pl
@@ -186,267 +186,28 @@ sub which
 		}
 	}
 
-sub fixtests
-  {
-  my ($str, $tests) = @_;
-
-  foreach my $t (keys %$tests)
-    {
-    $str =~ s/(\.\/)?\$\($t\)/\$(TEST_D)\/$tests-&gt;{$t}/g;
-    }
-
-  return $str;
-  }
-
-sub fixdeps
-  {
-  my ($str, $fakes) = @_;
-
-  my @t = split(/\s+/, $str);
-  $str = '';
-  foreach my $t (@t)
-    {
-    $str .= ' ' if $str ne '';
-    if (exists($fakes-&gt;{$t}))
-      {
-      $str .= $fakes-&gt;{$t};
-      next;
-      }
-    if ($t =~ /^[^\/]+$/)
-      {
-      $str .= '$(TEST_D)/' . $t;
-      }
-    else
-      {
-      $str .= $t;
-      }
-    }
-
-  return $str;
-  }
-
-sub fixrules
-  {
-  my ($str) = @_;
-
-  # Compatible with -j...
-#  $str =~ s/^(\s+@?)/$1cd \$(TEST_D) &amp;&amp; /;
-#  return $str;
-
-  # Compatible with not -j.
-  my @t = split(&quot;\n&quot;, $str);
-  $str = '';
-  my $prev;
-  foreach my $t (@t)
-    {
-    $t =~ s/^\s+//;
-    if (!$prev)
-      {
-      if ($t =~ /^@/)
-        {
-        $t =~ s/^@/\@cd \$(TEST_D) &amp;&amp; /;
-        }
-      elsif ($t !~ /^\s*#/ &amp;&amp; $t !~ /^echo/)
-        {
-        $t = 'cd $(TEST_D) &amp;&amp; ' . $t;
-        }
-      }
-    $str .= &quot;\t$t\n&quot;;
-    $prev = $t =~/\\$/;
-    }
-  return $str;
+sub do_rehash_rule {
+    my ($target, $deps) = @_;
+    my $ret = &lt;&lt;&quot;EOF&quot;;
+$target: $deps
+	(OPENSSL=&quot;`pwd`/util/opensslwrap.sh&quot;; \\
+	OPENSSL_DEBUG_MEMORY=on; \\
+	export OPENSSL OPENSSL_DEBUG_MEMORY; \\
+	\$(PERL) tools/c_rehash certs/demo)
+EOF
+    return $ret
 }
+sub do_test_rule {
+    my ($target, $deps, $test_cmd) = @_;
+    my $ret = &lt;&lt;&quot;EOF&quot;;
+$target: $deps force.$target
+	TOP=. BIN_D=\$(BIN_D) TEST_D=\$(TEST_D) \\
+	    PERL=\$(PERL) \$(PERL) test/$test_cmd
+force.$target:
 
-sub copy_scripts
-  {
-  my ($sed, $src, @targets) = @_;
-
-  my $s = '';
-  foreach my $t (@targets)
-    {
-    # Copy first so we get file modes...
-    $s .= &quot;\$(TEST_D)/$t: \$(SRC_D)/$src/$t\n\tcp \$(SRC_D)/$src/$t \$(TEST_D)/$t\n&quot;;
-    $s .= &quot;\tsed -e 's/\\.\\.\\/apps/..\\/\$(OUT_D)/' -e 's/\\.\\.\\/util/..\\/\$(TEST_D)/' &lt; \$(SRC_D)/$src/$t &gt; \$(TEST_D)/$t\n&quot; if $sed;
-    $s .= &quot;\n&quot;;
-    }
-  return $s;
-  }
-
-sub get_tests
-  {
-  my ($makefile) = @_;
-
-  open(M, $makefile) || die &quot;Can't open $makefile: $!&quot;;
-  my %targets;
-  my %deps;
-  my %tests;
-  my %alltests;
-  my %fakes;
-  while (my $line = &lt;M&gt;)
-    {
-    chomp $line;
-    while ($line =~ /^(.*)\\$/)
-      {
-      $line = $1 . &lt;M&gt;;
-      }
-
-    if ($line =~ /^alltests:(.*)$/)
-      {
-      my @t = split(/\s+/, $1);
-      foreach my $t (@t)
-	{
-	$targets{$t} = '';
-	$alltests{$t} = undef;
-        }
-      }
-
-    if (($line =~ /^(?&lt;t&gt;\S+):(?&lt;d&gt;.*)$/ &amp;&amp; exists $targets{$1})
-	|| $line =~ /^(?&lt;t&gt;test_(ss|gen) .*):(?&lt;d&gt;.*)/)
-      {
-      my $t = $+{t};
-      my $d = $+{d};
-      # If there are multiple targets stupid FreeBSD make runs the
-      # rules once for each dependency that matches one of the
-      # targets. Running the same rule twice concurrently causes
-      # breakage, so replace with a fake target.
-      if ($t =~ /\s/)
-        {
-	++$fake;
-	my @targets = split /\s+/, $t;
-	$t = &quot;_fake$fake&quot;;
-	foreach my $f (@targets)
-	  {
-	  $fakes{$f} = $t;
-	  }
-	}
-      $deps{$t} = $d;
-      $deps{$t} =~ s/#.*$//;
-      for (;;)
-	{
-	$line = &lt;M&gt;;
-	chomp $line;
-	last if $line eq '';
-	$targets{$t} .= &quot;$line\n&quot;;
-        }
-      next;
-      }
-
-    if ($line =~ /^(\S+TEST)=\s*(\S+)$/)
-      {
-      $tests{$1} = $2;
-      next;
-      }
-    }
-
-  delete $alltests{test_jpake} if $no_jpake;
-  delete $targets{test_ige} if $no_ige;
-  delete $alltests{test_md2} if $no_md2;
-  delete $alltests{test_rc5} if $no_rc5;
-
-  my $tests;
-  foreach my $t (keys %tests)
-    {
-    $tests .= &quot;$t = $tests{$t}\n&quot;;
-    }
-
-  my $each;
-  foreach my $t (keys %targets)
-    {
-    next if $t eq '';
-
-    my $d = $deps{$t};
-    $d =~ s/\.\.\/apps/\$(BIN_D)/g;
-    $d =~ s/\.\.\/util/\$(TEST_D)/g;
-    $d = fixtests($d, \%tests);
-    $d = fixdeps($d, \%fakes);
-
-    my $r = $targets{$t};
-    $r =~ s/\.\.\/apps/..\/\$(BIN_D)/g;
-    $r =~ s/\.\.\/util/..\/\$(TEST_D)/g;
-    $r =~ s/\.\.\/(\S+)/\$(SRC_D)\/$1/g;
-    $r = fixrules($r);
-
-    next if $r eq '';
-
-    $t =~ s/\s+/ \$(TEST_D)\//g;
-
-    $each .= &quot;$t: test_scripts $d\n\t\@echo '$t test started'\n$r\t\@echo '$t test done'\n\n&quot;;
-    }
-
-  # FIXME: Might be a clever way to figure out what needs copying
-  my @copies = ( 'bctest',
-		 'testgen',
-		 'cms-test.pl',
-		 'tx509',
-		 'test.cnf',
-		 'testenc',
-		 'tocsp',
-		 'testca',
-		 'CAss.cnf',
-		 'testtsa',
-		 'CAtsa.cnf',
-		 'Uss.cnf',
-		 'P1ss.cnf',
-		 'P2ss.cnf',
-		 'tcrl',
-		 'tsid',
-		 'treq',
-		 'tpkcs7',
-		 'tpkcs7d',
-		 'tkey',
-		 'testcrl.pem',
-		 'testx509.pem',
-		 'v3-cert1.pem',
-		 'v3-cert2.pem',
-		 'testreq2.pem',
-		 'testp7.pem',
-		 'pkcs7-1.pem',
-		 'trsa',
-		 'testdsa.pem',
-		 'testdsapub.pem',
-		 'testec-p256.pem',
-		 'testecpub-p256.pem',
-		 'testrsa.pem',
-		 'testrsapub.pem',
-		 'testsid.pem',
-		 'testss',
-		 'testssl',
-		 'testsslproxy',
-		 'serverinfo.pem',
-	       );
-  my $copies = copy_scripts(1, 'test', @copies);
-  $copies .= copy_scripts(0, 'test', ('smcont.txt', 'evptests.txt'));
-
-
-  my @utils = ( 'shlib_wrap.sh',
-		'opensslwrap.sh',
-	      );
-  $copies .= copy_scripts(1, 'util', @utils);
-
-  my @apps = ( 'CA.pl',
-	       'openssl.cnf',
-	       'server2.pem',
-	     );
-  $copies .= copy_scripts(1, 'apps', @apps);
-
-  $scripts = &quot;test_scripts: \$(TEST_D)/CA.pl \$(TEST_D)/opensslwrap.sh \$(TEST_D)/openssl.cnf \$(TEST_D)/shlib_wrap.sh ocsp smime\n&quot;;
-  $scripts .= &quot;\nocsp:\n\tcp -R test/ocsp-tests \$(TEST_D)\n&quot;;
-  $scripts .= &quot;\smime:\n\tcp -R test/smime-certs \$(TEST_D)\n&quot;;
-
-  my $all = 'test:';
-  foreach my $t (keys %alltests)
-    {
-    if (exists($fakes{$t}))
-      {
-      $all .= &quot; $fakes{$t}&quot;;
-      }
-    else
-      {
-      $all .= &quot; $t&quot;;
-      }
-    }
+EOF
+    return $ret;
+}
 
-  return &quot;$scripts\n$copies\n$tests\n$all\n\n$each&quot;;
-  }
 
 1;
</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="001772.html">[openssl-commits] [openssl]  master update
</A></li>
	<LI>Next message: <A HREF="001774.html">[openssl-commits] [openssl]  master update
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1773">[ date ]</a>
              <a href="thread.html#1773">[ thread ]</a>
              <a href="subject.html#1773">[ subject ]</a>
              <a href="author.html#1773">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="../../../mailman/listinfo/openssl-commits.html">More information about the openssl-commits
mailing list</a><br>
</body></html>
