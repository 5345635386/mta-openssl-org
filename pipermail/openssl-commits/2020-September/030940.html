<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [openssl]  master update
   </TITLE>
   <LINK REL="Index" HREF="https://mta.openssl.org/pipermail/openssl-commits/2020-September/index.html" >
   <LINK REL="made" HREF="mailto:openssl-commits%40openssl.org?Subject=Re%3A%20%5Bopenssl%5D%20%20master%20update&In-Reply-To=%3C1601121915.190229.22454.nullmailer%40dev.openssl.org%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="030938.html">
   <LINK REL="Next"  HREF="030944.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[openssl]  master update</H1>
    <B>dev at ddvo.net</B> 
    <A HREF="mailto:openssl-commits%40openssl.org?Subject=Re%3A%20%5Bopenssl%5D%20%20master%20update&In-Reply-To=%3C1601121915.190229.22454.nullmailer%40dev.openssl.org%3E"
       TITLE="[openssl]  master update">dev at ddvo.net
       </A><BR>
    <I>Sat Sep 26 12:05:15 UTC 2020</I>
    <P><UL>
        <LI>Previous message: <A HREF="030938.html">[openssl]  master update
</A></li>
        <LI>Next message: <A HREF="030944.html">[openssl]  master update
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#30940">[ date ]</a>
              <a href="thread.html#30940">[ thread ]</a>
              <a href="subject.html#30940">[ subject ]</a>
              <a href="author.html#30940">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>The branch master has been updated
       via  4ff993d7912516a2fd1d5c1e97a6f26a4644c1c6 (commit)
       via  cf61b97d5fb9208ac254e999d86b1cf40c12b442 (commit)
       via  37326895b75297071560eb09d167f3ac90af71b4 (commit)
       via  7d5ea3fecbfb12cdbcfce32cc4ea00b96ee4218d (commit)
      from  4f5b222b84432a11c44d8c9a11c7fa98351db79b (commit)


- Log -----------------------------------------------------------------
commit 4ff993d7912516a2fd1d5c1e97a6f26a4644c1c6
Author: Dr. David von Oheimb &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">David.von.Oheimb at siemens.com</A>&gt;
Date:   Tue Sep 22 08:36:22 2020 +0200

    Implement treatment of id-pkix-ocsp-no-check extension for OCSP_basic_verify()
    
    Fixes #7761
    
    Reviewed-by: Tomas Mraz &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">tmraz at fedoraproject.org</A>&gt;
    (Merged from <A HREF="https://github.com/openssl/openssl/pull/12947">https://github.com/openssl/openssl/pull/12947</A>)

commit cf61b97d5fb9208ac254e999d86b1cf40c12b442
Author: Tomas Mraz &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">tmraz at fedoraproject.org</A>&gt;
Date:   Wed Sep 23 09:43:43 2020 +0200

    Generate a certificate with critical id-pkix-ocsp-nocheck extension
    
    Reviewed-by: David von Oheimb &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">david.von.oheimb at siemens.com</A>&gt;
    (Merged from <A HREF="https://github.com/openssl/openssl/pull/12947">https://github.com/openssl/openssl/pull/12947</A>)

commit 37326895b75297071560eb09d167f3ac90af71b4
Author: Dr. David von Oheimb &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">David.von.Oheimb at siemens.com</A>&gt;
Date:   Tue Sep 22 08:31:17 2020 +0200

    OCSP_resp_find_status.pod: Slightly improve the documentation of various flags
    
    Reviewed-by: Tomas Mraz &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">tmraz at fedoraproject.org</A>&gt;
    (Merged from <A HREF="https://github.com/openssl/openssl/pull/12947">https://github.com/openssl/openssl/pull/12947</A>)

commit 7d5ea3fecbfb12cdbcfce32cc4ea00b96ee4218d
Author: Dr. David von Oheimb &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">David.von.Oheimb at siemens.com</A>&gt;
Date:   Tue Sep 22 08:18:31 2020 +0200

    OCSP_resp_find_status.pod: Replace function arg references B&lt;...&gt; by I&lt;...&gt;
    
    Reviewed-by: Tomas Mraz &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">tmraz at fedoraproject.org</A>&gt;
    (Merged from <A HREF="https://github.com/openssl/openssl/pull/12947">https://github.com/openssl/openssl/pull/12947</A>)

-----------------------------------------------------------------------

Summary of changes:
 crypto/ocsp/ocsp_vfy.c                     |  19 +++--
 crypto/x509/v3_purp.c                      |   1 +
 doc/man3/OCSP_resp_find_status.pod         | 109 +++++++++++++++--------------
 test/certs/ee-cert-crit-unknown-ext.pem    |  20 ++++++
 test/certs/ee-cert-noncrit-unknown-ext.pem |  20 ++++++
 test/certs/ee-cert-ocsp-nocheck.pem        |  20 ++++++
 test/certs/mkcert.sh                       |  36 +++++++++-
 test/certs/setup.sh                        |   9 +++
 test/recipes/25-test_verify.t              |  11 ++-
 9 files changed, 185 insertions(+), 60 deletions(-)
 create mode 100644 test/certs/ee-cert-crit-unknown-ext.pem
 create mode 100644 test/certs/ee-cert-noncrit-unknown-ext.pem
 create mode 100644 test/certs/ee-cert-ocsp-nocheck.pem

diff --git a/crypto/ocsp/ocsp_vfy.c b/crypto/ocsp/ocsp_vfy.c
index 92512829c9..0cd59f9221 100644
--- a/crypto/ocsp/ocsp_vfy.c
+++ b/crypto/ocsp/ocsp_vfy.c
@@ -26,7 +26,8 @@ static int ocsp_req_find_signer(X509 **psigner, OCSP_REQUEST *req,
                                 unsigned long flags);
 
 /* Returns 1 on success, 0 on failure, or -1 on fatal error */
-static int ocsp_verify_signer(X509 *signer, X509_STORE *st, unsigned long flags,
+static int ocsp_verify_signer(X509 *signer, int response,
+                              X509_STORE *st, unsigned long flags,
                               STACK_OF(X509) *untrusted, STACK_OF(X509) **chain)
 {
     X509_STORE_CTX *ctx = X509_STORE_CTX_new();
@@ -41,9 +42,17 @@ static int ocsp_verify_signer(X509 *signer, X509_STORE *st, unsigned long flags,
         OCSPerr(0, ERR_R_X509_LIB);
         goto end;
     }
-    if ((flags &amp; OCSP_PARTIAL_CHAIN) != 0
-            &amp;&amp; (vp = X509_STORE_CTX_get0_param(ctx)) != NULL)
+    if ((vp = X509_STORE_CTX_get0_param(ctx)) == NULL)
+        goto end;
+    if ((flags &amp; OCSP_PARTIAL_CHAIN) != 0)
         X509_VERIFY_PARAM_set_flags(vp, X509_V_FLAG_PARTIAL_CHAIN);
+    if (response
+            &amp;&amp; X509_get_ext_by_NID(signer, NID_id_pkix_OCSP_noCheck, -1) &gt;= 0)
+        /*
+         * Locally disable revocation status checking for OCSP responder cert.
+         * Done here for CRLs; TODO should be done also for OCSP-based checks.
+         */
+        X509_VERIFY_PARAM_clear_flags(vp, X509_V_FLAG_CRL_CHECK);
     X509_STORE_CTX_set_purpose(ctx, X509_PURPOSE_OCSP_HELPER);
     X509_STORE_CTX_set_trust(ctx, X509_TRUST_OCSP_REQUEST);
     /* TODO: why is X509_TRUST_OCSP_REQUEST set? Seems to get ignored. */
@@ -117,7 +126,7 @@ int OCSP_basic_verify(OCSP_BASICRESP *bs, STACK_OF(X509) *certs,
         } else {
             untrusted = bs-&gt;certs;
         }
-        ret = ocsp_verify_signer(signer, st, flags, untrusted, &amp;chain);
+        ret = ocsp_verify_signer(signer, 1, st, flags, untrusted, &amp;chain);
         if (ret &lt;= 0)
             goto end;
         if ((flags &amp; OCSP_NOCHECKS) != 0) {
@@ -390,7 +399,7 @@ int OCSP_request_verify(OCSP_REQUEST *req, STACK_OF(X509) *certs,
         return 0; /* not returning 'ret' here for backward compatibility*/
     if ((flags &amp; OCSP_NOVERIFY) != 0)
         return 1;
-    return ocsp_verify_signer(signer, store, flags,
+    return ocsp_verify_signer(signer, 0, store, flags,
                               (flags &amp; OCSP_NOCHAIN) != 0 ?
                               NULL : req-&gt;optionalSignature-&gt;certs, NULL) &gt; 0;
     /* using '&gt; 0' here to avoid breaking backward compatibility returning -1 */
diff --git a/crypto/x509/v3_purp.c b/crypto/x509/v3_purp.c
index 8b0dfd9759..fd512419f0 100644
--- a/crypto/x509/v3_purp.c
+++ b/crypto/x509/v3_purp.c
@@ -283,6 +283,7 @@ int X509_supported_extension(X509_EXTENSION *ex)
         NID_sbgp_ipAddrBlock,   /* 290 */
         NID_sbgp_autonomousSysNum, /* 291 */
 #endif
+        NID_id_pkix_OCSP_noCheck, /* 369 */
         NID_policy_constraints, /* 401 */
         NID_proxyCertInfo,      /* 663 */
         NID_name_constraints,   /* 666 */
diff --git a/doc/man3/OCSP_resp_find_status.pod b/doc/man3/OCSP_resp_find_status.pod
index 7dd90837b6..7c16b8c889 100644
--- a/doc/man3/OCSP_resp_find_status.pod
+++ b/doc/man3/OCSP_resp_find_status.pod
@@ -60,12 +60,12 @@ OCSP_basic_verify
 
 =head1 DESCRIPTION
 
-OCSP_resp_find_status() searches B&lt;bs&gt; for an OCSP response for B&lt;id&gt;. If it is
-successful the fields of the response are returned in B&lt;*status&gt;, B&lt;*reason&gt;,
-B&lt;*revtime&gt;, B&lt;*thisupd&gt; and B&lt;*nextupd&gt;.  The B&lt;*status&gt; value will be one of
+OCSP_resp_find_status() searches I&lt;bs&gt; for an OCSP response for I&lt;id&gt;. If it is
+successful the fields of the response are returned in I&lt;*status&gt;, I&lt;*reason&gt;,
+I&lt;*revtime&gt;, I&lt;*thisupd&gt; and I&lt;*nextupd&gt;.  The I&lt;*status&gt; value will be one of
 B&lt;V_OCSP_CERTSTATUS_GOOD&gt;, B&lt;V_OCSP_CERTSTATUS_REVOKED&gt; or
-B&lt;V_OCSP_CERTSTATUS_UNKNOWN&gt;. The B&lt;*reason&gt; and B&lt;*revtime&gt; fields are only
-set if the status is B&lt;V_OCSP_CERTSTATUS_REVOKED&gt;. If set the B&lt;*reason&gt; field
+B&lt;V_OCSP_CERTSTATUS_UNKNOWN&gt;. The I&lt;*reason&gt; and I&lt;*revtime&gt; fields are only
+set if the status is B&lt;V_OCSP_CERTSTATUS_REVOKED&gt;. If set the I&lt;*reason&gt; field
 will be set to the revocation reason which will be one of
 B&lt;OCSP_REVOKED_STATUS_NOSTATUS&gt;, B&lt;OCSP_REVOKED_STATUS_UNSPECIFIED&gt;,
 B&lt;OCSP_REVOKED_STATUS_KEYCOMPROMISE&gt;, B&lt;OCSP_REVOKED_STATUS_CACOMPROMISE&gt;,
@@ -73,88 +73,91 @@ B&lt;OCSP_REVOKED_STATUS_AFFILIATIONCHANGED&gt;, B&lt;OCSP_REVOKED_STATUS_SUPERSEDED&gt;,
 B&lt;OCSP_REVOKED_STATUS_CESSATIONOFOPERATION&gt;,
 B&lt;OCSP_REVOKED_STATUS_CERTIFICATEHOLD&gt; or B&lt;OCSP_REVOKED_STATUS_REMOVEFROMCRL&gt;.
 
-OCSP_resp_count() returns the number of B&lt;OCSP_SINGLERESP&gt; structures in B&lt;bs&gt;.
+OCSP_resp_count() returns the number of B&lt;OCSP_SINGLERESP&gt; structures in I&lt;bs&gt;.
 
-OCSP_resp_get0() returns the B&lt;OCSP_SINGLERESP&gt; structure in B&lt;bs&gt;
-corresponding to index B&lt;idx&gt;. Where B&lt;idx&gt; runs from 0 to
+OCSP_resp_get0() returns the B&lt;OCSP_SINGLERESP&gt; structure in I&lt;bs&gt;
+corresponding to index I&lt;idx&gt;. Where I&lt;idx&gt; runs from 0 to
 OCSP_resp_count(bs) - 1.
 
-OCSP_resp_find() searches B&lt;bs&gt; for B&lt;id&gt; and returns the index of the first
-matching entry after B&lt;last&gt; or starting from the beginning if B&lt;last&gt; is -1.
+OCSP_resp_find() searches I&lt;bs&gt; for I&lt;id&gt; and returns the index of the first
+matching entry after I&lt;last&gt; or starting from the beginning if I&lt;last&gt; is -1.
 
-OCSP_single_get0_status() extracts the fields of B&lt;single&gt; in B&lt;*reason&gt;,
-B&lt;*revtime&gt;, B&lt;*thisupd&gt; and B&lt;*nextupd&gt;.
+OCSP_single_get0_status() extracts the fields of I&lt;single&gt; in I&lt;*reason&gt;,
+I&lt;*revtime&gt;, I&lt;*thisupd&gt; and I&lt;*nextupd&gt;.
 
 OCSP_resp_get0_produced_at() extracts the B&lt;producedAt&gt; field from the
-single response B&lt;bs&gt;.
+single response I&lt;bs&gt;.
 
-OCSP_resp_get0_signature() returns the signature from B&lt;bs&gt;.
+OCSP_resp_get0_signature() returns the signature from I&lt;bs&gt;.
 
-OCSP_resp_get0_tbs_sigalg() returns the B&lt;signatureAlgorithm&gt; from B&lt;bs&gt;.
+OCSP_resp_get0_tbs_sigalg() returns the B&lt;signatureAlgorithm&gt; from I&lt;bs&gt;.
 
-OCSP_resp_get0_respdata() returns the B&lt;tbsResponseData&gt; from B&lt;bs&gt;.
+OCSP_resp_get0_respdata() returns the B&lt;tbsResponseData&gt; from I&lt;bs&gt;.
 
-OCSP_resp_get0_certs() returns any certificates included in B&lt;bs&gt;.
+OCSP_resp_get0_certs() returns any certificates included in I&lt;bs&gt;.
 
 OCSP_resp_get0_signer() attempts to retrieve the certificate that directly
-signed B&lt;bs&gt;.  The OCSP protocol does not require that this certificate
+signed I&lt;bs&gt;.  The OCSP protocol does not require that this certificate
 is included in the B&lt;certs&gt; field of the response, so additional certificates
-can be supplied in B&lt;extra_certs&gt; if the certificates that may have
+can be supplied via the I&lt;extra_certs&gt; if the certificates that may have
 signed the response are known via some out-of-band mechanism.
 
-OCSP_resp_get0_id() gets the responder id of B&lt;bs&gt;. If the responder ID is
-a name then &lt;*pname&gt; is set to the name and B&lt;*pid&gt; is set to NULL. If the
-responder ID is by key ID then B&lt;*pid&gt; is set to the key ID and B&lt;*pname&gt;
-is set to NULL. OCSP_resp_get1_id() leaves ownership of B&lt;*pid&gt; and B&lt;*pname&gt;
+OCSP_resp_get0_id() gets the responder id of I&lt;bs&gt;. If the responder ID is
+a name then &lt;*pname&gt; is set to the name and I&lt;*pid&gt; is set to NULL. If the
+responder ID is by key ID then I&lt;*pid&gt; is set to the key ID and I&lt;*pname&gt;
+is set to NULL. OCSP_resp_get1_id() leaves ownership of I&lt;*pid&gt; and I&lt;*pname&gt;
 with the caller, who is responsible for freeing them. Both functions return 1
 in case of success and 0 in case of failure. If OCSP_resp_get1_id() returns 0,
 no freeing of the results is necessary.
 
-OCSP_check_validity() checks the validity of B&lt;thisupd&gt; and B&lt;nextupd&gt; values
-which will be typically obtained from OCSP_resp_find_status() or
-OCSP_single_get0_status(). If B&lt;sec&gt; is nonzero it indicates how many seconds
-leeway should be allowed in the check. If B&lt;maxsec&gt; is positive it indicates
-the maximum age of B&lt;thisupd&gt; in seconds.
+OCSP_check_validity() checks the validity of its I&lt;thisupd&gt; and I&lt;nextupd&gt;
+arguments, which will be typically obtained from OCSP_resp_find_status() or
+OCSP_single_get0_status(). If I&lt;sec&gt; is nonzero it indicates how many seconds
+leeway should be allowed in the check. If I&lt;maxsec&gt; is positive it indicates
+the maximum age of I&lt;thisupd&gt; in seconds.
 
-OCSP_basic_verify() checks that the basic response message B&lt;bs&gt; is correctly
-signed and that the signer certificate can be validated. It takes B&lt;st&gt; as
-the trusted store and B&lt;certs&gt; as a set of untrusted intermediate certificates.
+OCSP_basic_verify() checks that the basic response message I&lt;bs&gt; is correctly
+signed and that the signer certificate can be validated. It takes I&lt;st&gt; as
+the trusted store and I&lt;certs&gt; as a set of untrusted intermediate certificates.
 The function first tries to find the signer certificate of the response
-in B&lt;certs&gt;. It also searches the certificates the responder may have included
-in B&lt;bs&gt; unless the B&lt;flags&gt; contain B&lt;OCSP_NOINTERN&gt;.
+in I&lt;certs&gt;. It then searches the certificates the responder may have included
+in I&lt;bs&gt; unless I&lt;flags&gt; contains B&lt;OCSP_NOINTERN&gt;.
 It fails if the signer certificate cannot be found.
-Next, the function checks the signature of B&lt;bs&gt; and fails on error
-unless the B&lt;flags&gt; contain B&lt;OCSP_NOSIGS&gt;. Then the function already returns
-success if the B&lt;flags&gt; contain B&lt;OCSP_NOVERIFY&gt; or if the signer certificate
-was found in B&lt;certs&gt; and the B&lt;flags&gt; contain B&lt;OCSP_TRUSTOTHER&gt;.
+Next, unless I&lt;flags&gt; contains B&lt;OCSP_NOSIGS&gt;, the function checks
+the signature of I&lt;bs&gt; and fails on error. Then the function already returns
+success if I&lt;flags&gt; contains B&lt;OCSP_NOVERIFY&gt; or if the signer certificate
+was found in I&lt;certs&gt; and I&lt;flags&gt; contains B&lt;OCSP_TRUSTOTHER&gt;.
 Otherwise the function continues by validating the signer certificate.
-If B&lt;flags&gt; contains B&lt;OCSP_PARTIAL_CHAIN&gt;, intermediate CA certificates
-in B&lt;st&gt; are trust-anchors.
+If I&lt;flags&gt; contains B&lt;OCSP_PARTIAL_CHAIN&gt; it takes intermediate CA
+certificates in I&lt;st&gt; as trust anchors.
 For more details, see the description of B&lt;X509_V_FLAG_PARTIAL_CHAIN&gt;
 in L&lt;X509_VERIFY_PARAM_set_flags(3)/VERIFICATION FLAGS&gt;.
-To this end, all certificates in B&lt;cert&gt; and in B&lt;bs&gt; are considered as
-untrusted certificates for the construction of the validation path for the
-signer certificate unless the B&lt;OCSP_NOCHAIN&gt; flag is set. After successful path
+If I&lt;flags&gt; contains B&lt;OCSP_NOCHAIN&gt; it ignores all certificates in I&lt;certs&gt;
+and in I&lt;bs&gt;, else it takes them as untrusted intermediate CA certificates
+and uses them for constructing the validation path for the signer certificate.
+Certicate revocation status checks using CRLs is disabled during path validation
+if the signer certificate contains the B&lt;id-pkix-ocsp-no-check&gt; extension.
+After successful path
 validation the function returns success if the B&lt;OCSP_NOCHECKS&gt; flag is set.
 Otherwise it verifies that the signer certificate meets the OCSP issuer
 criteria including potential delegation. If this does not succeed and the
-B&lt;flags&gt; do not contain B&lt;OCSP_NOEXPLICIT&gt; the function checks for explicit
+B&lt;OCSP_NOEXPLICIT&gt; flag is not set the function checks for explicit
 trust for OCSP signing in the root CA certificate.
 
 =head1 RETURN VALUES
 
-OCSP_resp_find_status() returns 1 if B&lt;id&gt; is found in B&lt;bs&gt; and 0 otherwise.
+OCSP_resp_find_status() returns 1 if I&lt;id&gt; is found in I&lt;bs&gt; and 0 otherwise.
 
 OCSP_resp_count() returns the total number of B&lt;OCSP_SINGLERESP&gt; fields in
-B&lt;bs&gt;.
+I&lt;bs&gt;.
 
 OCSP_resp_get0() returns a pointer to an B&lt;OCSP_SINGLERESP&gt; structure or
-B&lt;NULL&gt; if B&lt;idx&gt; is out of range.
+NULL if I&lt;idx&gt; is out of range.
 
-OCSP_resp_find() returns the index of B&lt;id&gt; in B&lt;bs&gt; (which may be 0) or -1 if
-B&lt;id&gt; was not found.
+OCSP_resp_find() returns the index of I&lt;id&gt; in I&lt;bs&gt; (which may be 0) or -1 if
+I&lt;id&gt; was not found.
 
-OCSP_single_get0_status() returns the status of B&lt;single&gt; or -1 if an error
+OCSP_single_get0_status() returns the status of I&lt;single&gt; or -1 if an error
 occurred.
 
 OCSP_resp_get0_signer() returns 1 if the signing certificate was located,
@@ -171,15 +174,15 @@ can then take appropriate action based on the status of the certificate.
 
 An OCSP response for a certificate contains B&lt;thisUpdate&gt; and B&lt;nextUpdate&gt;
 fields. Normally the current time should be between these two values. To
-account for clock skew the B&lt;maxsec&gt; field can be set to nonzero in
+account for clock skew the I&lt;maxsec&gt; field can be set to nonzero in
 OCSP_check_validity(). Some responders do not set the B&lt;nextUpdate&gt; field, this
 would otherwise mean an ancient response would be considered valid: the
-B&lt;maxsec&gt; parameter to OCSP_check_validity() can be used to limit the permitted
+I&lt;maxsec&gt; parameter to OCSP_check_validity() can be used to limit the permitted
 age of responses.
 
-The values written to B&lt;*revtime&gt;, B&lt;*thisupd&gt; and B&lt;*nextupd&gt; by
+The values written to I&lt;*revtime&gt;, I&lt;*thisupd&gt; and I&lt;*nextupd&gt; by
 OCSP_resp_find_status() and OCSP_single_get0_status() are internal pointers
-which B&lt;MUST NOT&gt; be freed up by the calling application. Any or all of these
+which MUST NOT be freed up by the calling application. Any or all of these
 parameters can be set to NULL if their value is not required.
 
 =head1 SEE ALSO
diff --git a/test/certs/ee-cert-crit-unknown-ext.pem b/test/certs/ee-cert-crit-unknown-ext.pem
new file mode 100644
index 0000000000..34f69357c1
--- /dev/null
+++ b/test/certs/ee-cert-crit-unknown-ext.pem
@@ -0,0 +1,20 @@
+-----BEGIN CERTIFICATE-----
+MIIDMDCCAhigAwIBAgIBAjANBgkqhkiG9w0BAQsFADANMQswCQYDVQQDDAJDQTAg
+Fw0yMDA5MjMxMDM5MTNaGA8yMTIwMDkyNDEwMzkxM1owGTEXMBUGA1UEAwwOc2Vy
+dmVyLmV4YW1wbGUwggEiMA0GCSqGSIb3DQEBAQUAA4IBDwAwggEKAoIBAQCo/4lY
+YYWu3tssD9Vz++K3qBt6dWAr1H08c3a1rt6TL38kkG3JHPSKOM2fooAWVsu0LLuT
+5Rcf/w3GQ/4xNPgo2HXpo7uIgu+jcuJTYgVFTeAxl++qnRDSWA2eBp4yuxsIVl1l
+Dz9mjsI2oBH/wFk1/Ukc3RxCMwZ4rgQ4I+XndWfTlK1aqUAfrFkQ9QzBZK1KxMY1
+U7OWaoIbFYvRmavknm+UqtKW5Vf7jJFkijwkFsbSGb6CYBM7YrDtPh2zyvlr3zG5
+ep5LR2inKcc/SuIiJ7TvkGPX79ByST5brbkb1Ctvhmjd1XMSuEPJ3EEPoqNGT4tn
+iIQPYf55NB9KiR+3AgMBAAGjgYwwgYkwHQYDVR0OBBYEFOeb4iqtimw6y3ZR5Y4H
+mCKX4XOiMB8GA1UdIwQYMBaAFLQRM/HX4l73U54gIhBPhga/H8leMAkGA1UdEwQC
+MAAwEwYDVR0lBAwwCgYIKwYBBQUHAwEwGQYDVR0RBBIwEIIOc2VydmVyLmV4YW1w
+bGUwDAYDKgMEAQH/BAIFADANBgkqhkiG9w0BAQsFAAOCAQEAOjBX/mPKtROMdd3S
+jGMxScTndXy+OMCTGmRMpFGrR8yQAgUDhcPytxN7FU+5Uo1qaV6+9xH9Q80mtJ6i
+Db5qHdxAw/1CTDKMzVUU3eVq1AMPbERSC/JYSeQct+rQ0N4QfOjEpTXnVMbeaL+Q
+yCsetPK2I8o8e63wuCYgWWIFQtszunGnKdbF60n9MI8uAryaCCDUptOdXIiHBDIW
+1ZLnhAAr9RvwK5+ph4pBefHMC9P/tZ/eB14kszaAPBhv8cJKEvM6dgboEbU1KMoz
+VY7rT7+7rTE6/2AoL6c5z+RE0oC/UE/i1vgEjO9GwBuL9QVhmkt7ejJR0+oM9EqA
+0l7sxw==
+-----END CERTIFICATE-----
diff --git a/test/certs/ee-cert-noncrit-unknown-ext.pem b/test/certs/ee-cert-noncrit-unknown-ext.pem
new file mode 100644
index 0000000000..8c4695a5d8
--- /dev/null
+++ b/test/certs/ee-cert-noncrit-unknown-ext.pem
@@ -0,0 +1,20 @@
+-----BEGIN CERTIFICATE-----
+MIIDLTCCAhWgAwIBAgIBAjANBgkqhkiG9w0BAQsFADANMQswCQYDVQQDDAJDQTAg
+Fw0yMDA5MjMxMDM5NTJaGA8yMTIwMDkyNDEwMzk1MlowGTEXMBUGA1UEAwwOc2Vy
+dmVyLmV4YW1wbGUwggEiMA0GCSqGSIb3DQEBAQUAA4IBDwAwggEKAoIBAQCo/4lY
+YYWu3tssD9Vz++K3qBt6dWAr1H08c3a1rt6TL38kkG3JHPSKOM2fooAWVsu0LLuT
+5Rcf/w3GQ/4xNPgo2HXpo7uIgu+jcuJTYgVFTeAxl++qnRDSWA2eBp4yuxsIVl1l
+Dz9mjsI2oBH/wFk1/Ukc3RxCMwZ4rgQ4I+XndWfTlK1aqUAfrFkQ9QzBZK1KxMY1
+U7OWaoIbFYvRmavknm+UqtKW5Vf7jJFkijwkFsbSGb6CYBM7YrDtPh2zyvlr3zG5
+ep5LR2inKcc/SuIiJ7TvkGPX79ByST5brbkb1Ctvhmjd1XMSuEPJ3EEPoqNGT4tn
+iIQPYf55NB9KiR+3AgMBAAGjgYkwgYYwHQYDVR0OBBYEFOeb4iqtimw6y3ZR5Y4H
+mCKX4XOiMB8GA1UdIwQYMBaAFLQRM/HX4l73U54gIhBPhga/H8leMAkGA1UdEwQC
+MAAwEwYDVR0lBAwwCgYIKwYBBQUHAwEwGQYDVR0RBBIwEIIOc2VydmVyLmV4YW1w
+bGUwCQYDKgMEBAIFADANBgkqhkiG9w0BAQsFAAOCAQEAGPgQHSiAqGMAur2KW4BS
+opArthSh7ZT1wVEX0lP5lI/BUv/Q1YYnKEWuR9o+8vP1w4gUhFzg9Zrwj3rCNoC5
+x2JipZt8kRo5ycXv4tzr6V4n1zSgGByjradc0VEfuqmw1WpxvLoHeV9hbiXFQf8/
+PiLVF5BZ0ZSJjTDqMWfqYGSZnWqLglAqhZtHXkdaGIS+MJ2MhwPaUgLNATzptJ4a
+fjUF9apbCLtz0UzvojF/Wmby/fzbnPbKDyV6P8IzsfLgrH9NXN/9OBG5evVZo4PR
+32eZwgjdftu64b2QwoZi0dInHOwJO30UfgkeypYTjnQLSXhrz56EPu9sWCNGXs61
+LA==
+-----END CERTIFICATE-----
diff --git a/test/certs/ee-cert-ocsp-nocheck.pem b/test/certs/ee-cert-ocsp-nocheck.pem
new file mode 100644
index 0000000000..d70ffa7553
--- /dev/null
+++ b/test/certs/ee-cert-ocsp-nocheck.pem
@@ -0,0 +1,20 @@
+-----BEGIN CERTIFICATE-----
+MIIDNjCCAh6gAwIBAgIBAjANBgkqhkiG9w0BAQsFADANMQswCQYDVQQDDAJDQTAg
+Fw0yMDA5MjMxMDM4NDlaGA8yMTIwMDkyNDEwMzg0OVowGTEXMBUGA1UEAwwOc2Vy
+dmVyLmV4YW1wbGUwggEiMA0GCSqGSIb3DQEBAQUAA4IBDwAwggEKAoIBAQCo/4lY
+YYWu3tssD9Vz++K3qBt6dWAr1H08c3a1rt6TL38kkG3JHPSKOM2fooAWVsu0LLuT
+5Rcf/w3GQ/4xNPgo2HXpo7uIgu+jcuJTYgVFTeAxl++qnRDSWA2eBp4yuxsIVl1l
+Dz9mjsI2oBH/wFk1/Ukc3RxCMwZ4rgQ4I+XndWfTlK1aqUAfrFkQ9QzBZK1KxMY1
+U7OWaoIbFYvRmavknm+UqtKW5Vf7jJFkijwkFsbSGb6CYBM7YrDtPh2zyvlr3zG5
+ep5LR2inKcc/SuIiJ7TvkGPX79ByST5brbkb1Ctvhmjd1XMSuEPJ3EEPoqNGT4tn
+iIQPYf55NB9KiR+3AgMBAAGjgZIwgY8wHQYDVR0OBBYEFOeb4iqtimw6y3ZR5Y4H
+mCKX4XOiMB8GA1UdIwQYMBaAFLQRM/HX4l73U54gIhBPhga/H8leMAkGA1UdEwQC
+MAAwEwYDVR0lBAwwCgYIKwYBBQUHAwEwGQYDVR0RBBIwEIIOc2VydmVyLmV4YW1w
+bGUwEgYJKwYBBQUHMAEFAQH/BAIFADANBgkqhkiG9w0BAQsFAAOCAQEADK7EvoaQ
+Q/hwA48Vt+umuaquwUTn7IP5eWD6TivgTxnx5Qj1vqCC4AqZF4L8fV4RW2kXhbW+
+gwJIWr0w2EzzZnaObJK/zWyXdb+fpyLsl65BAABDjm2GVZEuX7Zvm+4cJ9mUozWz
+/r1d4x9s2bmuo+6S3HH+ceXhyYPHnMc9gkzLubMZp7yO9FaDNmC9UoSnv1W0Ijkf
+D+jV4ErjON9eCuFTt7xxa9xVNCnB1shXLvoyiGd9yCyO4cScpxNPl3/VY9kx5W2G
+OeRYsJw4DZOY6hRkJq2ftDiOsDWiAXBkWuItf0hynOkSyBh1bcW+h94iBZ9uB1X+
+LRAbn7Qf3ITyCw==
+-----END CERTIFICATE-----
diff --git a/test/certs/mkcert.sh b/test/certs/mkcert.sh
index 32fd5874d9..a564e30c6b 100755
--- a/test/certs/mkcert.sh
+++ b/test/certs/mkcert.sh
@@ -233,6 +233,40 @@ genee() {
 	    -set_serial 2 -days &quot;${DAYS}&quot; &quot;$@&quot;
 }
 
+geneeextra() {
+    local OPTIND=1
+    local purpose=serverAuth
+
+    while getopts p: o
+    do
+        case $o in
+        p) purpose=&quot;$OPTARG&quot;;;
+        *) echo &quot;Usage: $0 geneeextra [-p EKU] cn keyname certname cakeyname cacertname extraext&quot; &gt;&amp;2
+           return 1;;
+        esac
+    done
+
+    shift $((OPTIND - 1))
+    local cn=$1; shift
+    local key=$1; shift
+    local cert=$1; shift
+    local cakey=$1; shift
+    local ca=$1; shift
+    local extraext=$1; shift
+
+    exts=$(printf &quot;%s\n%s\n%s\n%s\n%s\n%s\n[alts]\n%s\n&quot; \
+	    &quot;subjectKeyIdentifier = hash&quot; \
+	    &quot;authorityKeyIdentifier = keyid, issuer&quot; \
+	    &quot;basicConstraints = CA:false&quot; \
+	    &quot;extendedKeyUsage = $purpose&quot; \
+	    &quot;subjectAltName = @alts&quot;\
+	    &quot;$extraext&quot; &quot;DNS=${cn}&quot;)
+    csr=$(req &quot;$key&quot; &quot;CN = $cn&quot;) || return 1
+    echo &quot;$csr&quot; |
+	cert &quot;$cert&quot; &quot;$exts&quot; -CA &quot;${ca}.pem&quot; -CAkey &quot;${cakey}.pem&quot; \
+	    -set_serial 2 -days &quot;${DAYS}&quot; &quot;$@&quot;
+}
+
 geneenocsr() {
     local OPTIND=1
     local purpose=serverAuth
@@ -241,7 +275,7 @@ geneenocsr() {
     do
         case $o in
         p) purpose=&quot;$OPTARG&quot;;;
-        *) echo &quot;Usage: $0 genee [-p EKU] cn certname cakeyname cacertname&quot; &gt;&amp;2
+        *) echo &quot;Usage: $0 geneenocsr [-p EKU] cn certname cakeyname cacertname&quot; &gt;&amp;2
            return 1;;
         esac
     done
diff --git a/test/certs/setup.sh b/test/certs/setup.sh
index ee3d678219..eb7f77e231 100755
--- a/test/certs/setup.sh
+++ b/test/certs/setup.sh
@@ -400,3 +400,12 @@ OPENSSL_SIGALG=ED448 OPENSSL_KEYALG=ed448 ./mkcert.sh genroot &quot;Root Ed448&quot; \
     root-ed448-key root-ed448-cert
 OPENSSL_SIGALG=ED448 OPENSSL_KEYALG=ed448 ./mkcert.sh genee ed448 \
     server-ed448-key server-ed448-cert root-ed448-key root-ed448-cert
+
+# non-critical unknown extension
+./mkcert.sh geneeextra server.example ee-key ee-cert-noncrit-unknown-ext ca-key ca-cert &quot;1.2.3.4=DER:05:00&quot;
+
+# critical unknown extension
+./mkcert.sh geneeextra server.example ee-key ee-cert-crit-unknown-ext ca-key ca-cert &quot;1.2.3.4=critical,DER:05:00&quot;
+
+# critical id-pkix-ocsp-no-check extension
+./mkcert.sh geneeextra server.example ee-key ee-cert-ocsp-nocheck ca-key ca-cert &quot;1.3.6.1.5.5.7.48.1.5=critical,DER:05:00&quot;
diff --git a/test/recipes/25-test_verify.t b/test/recipes/25-test_verify.t
index 6d8f78c978..9bbabd0fa3 100644
--- a/test/recipes/25-test_verify.t
+++ b/test/recipes/25-test_verify.t
@@ -27,7 +27,7 @@ sub verify {
     run(app([@args]));
 }
 
-plan tests =&gt; 148;
+plan tests =&gt; 151;
 
 # Canonical success
 ok(verify(&quot;ee-cert&quot;, &quot;sslserver&quot;, [&quot;root-cert&quot;], [&quot;ca-cert&quot;]),
@@ -45,6 +45,15 @@ ok(!verify(&quot;ee-cert&quot;, &quot;sslserver&quot;, [qw(root-cert2)], [qw(ca-cert)]),
 ok(!verify(&quot;ee-cert&quot;, &quot;sslserver&quot;, [qw(root-name2)], [qw(ca-cert)]),
    &quot;fail wrong root DN&quot;);
 
+# Critical extensions
+
+ok(verify(&quot;ee-cert-noncrit-unknown-ext&quot;, &quot;sslserver&quot;, [qw(root-cert)], [qw(ca-cert)]),
+   &quot;accept non-critical unknown extension&quot;);
+ok(!verify(&quot;ee-cert-crit-unknown-ext&quot;, &quot;sslserver&quot;, [qw(root-cert)], [qw(ca-cert)]),
+   &quot;reject critical unknown extension&quot;);
+ok(verify(&quot;ee-cert-ocsp-nocheck&quot;, &quot;sslserver&quot;, [qw(root-cert)], [qw(ca-cert)]),
+   &quot;accept critical OCSP No Check&quot;);
+
 # Explicit trust/purpose combinations
 #
 ok(verify(&quot;ee-cert&quot;, &quot;sslserver&quot;, [qw(sroot-cert)], [qw(ca-cert)]),
</PRE>





<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="030938.html">[openssl]  master update
</A></li>
	<LI>Next message: <A HREF="030944.html">[openssl]  master update
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#30940">[ date ]</a>
              <a href="thread.html#30940">[ thread ]</a>
              <a href="subject.html#30940">[ subject ]</a>
              <a href="author.html#30940">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="../../../mailman/listinfo/openssl-commits.html">More information about the openssl-commits
mailing list</a><br>
</body></html>
