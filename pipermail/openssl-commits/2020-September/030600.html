<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [openssl]  master update
   </TITLE>
   <LINK REL="Index" HREF="https://mta.openssl.org/pipermail/openssl-commits/2020-September/index.html" >
   <LINK REL="made" HREF="mailto:openssl-commits%40openssl.org?Subject=Re%3A%20%5Bopenssl%5D%20%20master%20update&In-Reply-To=%3C1599803224.660369.19504.nullmailer%40dev.openssl.org%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="030593.html">
   <LINK REL="Next"  HREF="030607.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[openssl]  master update</H1>
    <B>dev at ddvo.net</B> 
    <A HREF="mailto:openssl-commits%40openssl.org?Subject=Re%3A%20%5Bopenssl%5D%20%20master%20update&In-Reply-To=%3C1599803224.660369.19504.nullmailer%40dev.openssl.org%3E"
       TITLE="[openssl]  master update">dev at ddvo.net
       </A><BR>
    <I>Fri Sep 11 05:47:04 UTC 2020</I>
    <P><UL>
        <LI>Previous message: <A HREF="030593.html">[openssl]  master update
</A></li>
        <LI>Next message: <A HREF="030607.html">[openssl]  master update
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#30600">[ date ]</a>
              <a href="thread.html#30600">[ thread ]</a>
              <a href="subject.html#30600">[ subject ]</a>
              <a href="author.html#30600">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>The branch master has been updated
       via  82bdd6419361136e7be533d31a990ba0476fced3 (commit)
       via  e41a2c4c609a8f64dfab2d832e975b0b37ff286d (commit)
       via  d72c8b457b77c31a20cf66e9c92aa19a4b7b5884 (commit)
       via  bb377c8d6c61920d889b961bd5c862eaac8b28e4 (commit)
       via  da6c691d6d417ad413fdc1e7a7a183d005e7fefd (commit)
       via  89f13ca4342be5b541b0885e3058617e5cce0de8 (commit)
       via  8a639b9d7234ed490f85ea46e4e8c74620452acd (commit)
       via  1e41dadfa7b9f792ed0f4714a3d3d36f070cf30e (commit)
      from  b0a4cbead384e2ac8dbb697795ace242e1b07c18 (commit)


- Log -----------------------------------------------------------------
commit 82bdd6419361136e7be533d31a990ba0476fced3
Author: Dr. David von Oheimb &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">David.von.Oheimb at siemens.com</A>&gt;
Date:   Tue Sep 8 09:39:33 2020 +0200

    check_chain_extensions(): Require X.509 v3 if extensions are present
    
    Reviewed-by: Kurt Roeckx &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">kurt at roeckx.be</A>&gt;
    Reviewed-by: Tomas Mraz &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">tmraz at fedoraproject.org</A>&gt;
    (Merged from <A HREF="https://github.com/openssl/openssl/pull/12478">https://github.com/openssl/openssl/pull/12478</A>)

commit e41a2c4c609a8f64dfab2d832e975b0b37ff286d
Author: Dr. David von Oheimb &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">David.von.Oheimb at siemens.com</A>&gt;
Date:   Mon Sep 7 22:38:46 2020 +0200

    check_chain_extensions(): Change exclusion condition w.r.t. RFC 6818 section 2
    
    Reviewed-by: Kurt Roeckx &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">kurt at roeckx.be</A>&gt;
    Reviewed-by: Tomas Mraz &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">tmraz at fedoraproject.org</A>&gt;
    (Merged from <A HREF="https://github.com/openssl/openssl/pull/12478">https://github.com/openssl/openssl/pull/12478</A>)

commit d72c8b457b77c31a20cf66e9c92aa19a4b7b5884
Author: Dr. David von Oheimb &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">David.von.Oheimb at siemens.com</A>&gt;
Date:   Wed Aug 26 09:45:11 2020 +0200

    x509_vfy.c: Make sure that strict checks are not done for self-issued EE certs
    
    Reviewed-by: Kurt Roeckx &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">kurt at roeckx.be</A>&gt;
    Reviewed-by: Tomas Mraz &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">tmraz at fedoraproject.org</A>&gt;
    (Merged from <A HREF="https://github.com/openssl/openssl/pull/12478">https://github.com/openssl/openssl/pull/12478</A>)

commit bb377c8d6c61920d889b961bd5c862eaac8b28e4
Author: Dr. David von Oheimb &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">David.von.Oheimb at siemens.com</A>&gt;
Date:   Tue Aug 25 16:58:36 2020 +0200

    check_chain_extensions(): Add check that CA cert includes key usage extension
    
    Reviewed-by: Kurt Roeckx &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">kurt at roeckx.be</A>&gt;
    Reviewed-by: Tomas Mraz &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">tmraz at fedoraproject.org</A>&gt;
    (Merged from <A HREF="https://github.com/openssl/openssl/pull/12478">https://github.com/openssl/openssl/pull/12478</A>)

commit da6c691d6d417ad413fdc1e7a7a183d005e7fefd
Author: Dr. David von Oheimb &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">David.von.Oheimb at siemens.com</A>&gt;
Date:   Tue Aug 25 16:46:18 2020 +0200

    check_chain_extensions(): Add check that on empty Subject the SAN must be marked critical
    
    Reviewed-by: Kurt Roeckx &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">kurt at roeckx.be</A>&gt;
    Reviewed-by: Tomas Mraz &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">tmraz at fedoraproject.org</A>&gt;
    (Merged from <A HREF="https://github.com/openssl/openssl/pull/12478">https://github.com/openssl/openssl/pull/12478</A>)

commit 89f13ca4342be5b541b0885e3058617e5cce0de8
Author: Dr. David von Oheimb &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">David.von.Oheimb at siemens.com</A>&gt;
Date:   Tue Aug 25 16:13:40 2020 +0200

    check_chain_extensions(): Add check that AKID and SKID are not marked critical
    
    Reviewed-by: Kurt Roeckx &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">kurt at roeckx.be</A>&gt;
    Reviewed-by: Tomas Mraz &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">tmraz at fedoraproject.org</A>&gt;
    (Merged from <A HREF="https://github.com/openssl/openssl/pull/12478">https://github.com/openssl/openssl/pull/12478</A>)

commit 8a639b9d7234ed490f85ea46e4e8c74620452acd
Author: Dr. David von Oheimb &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">David.von.Oheimb at siemens.com</A>&gt;
Date:   Tue Aug 25 15:37:46 2020 +0200

    check_chain_extensions(): Add check that Basic Constraints of CA cert are marked critical
    
    Reviewed-by: Kurt Roeckx &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">kurt at roeckx.be</A>&gt;
    Reviewed-by: Tomas Mraz &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">tmraz at fedoraproject.org</A>&gt;
    (Merged from <A HREF="https://github.com/openssl/openssl/pull/12478">https://github.com/openssl/openssl/pull/12478</A>)

commit 1e41dadfa7b9f792ed0f4714a3d3d36f070cf30e
Author: Dr. David von Oheimb &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">David.von.Oheimb at siemens.com</A>&gt;
Date:   Sat Jun 27 16:16:12 2020 +0200

    Extend X509 cert checks and error reporting in v3_{purp,crld}.c and x509_{set,vfy}.c
    
    add various checks for malformedness to static check_chain_extensions() in x509_vfc.c
    improve error reporting of X509v3_cache_extensions() in v3_purp.c
    add error reporting to x509_init_sig_info() in x509_set.c
    improve static setup_dp() and related functions in v3_purp.c and v3_crld.c
    add test case for non-conforming cert from <A HREF="https://tools.ietf.org/html/rfc8410#section-10.2">https://tools.ietf.org/html/rfc8410#section-10.2</A>
    
    Reviewed-by: Kurt Roeckx &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">kurt at roeckx.be</A>&gt;
    Reviewed-by: Tomas Mraz &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">tmraz at fedoraproject.org</A>&gt;
    (Merged from <A HREF="https://github.com/openssl/openssl/pull/12478">https://github.com/openssl/openssl/pull/12478</A>)

-----------------------------------------------------------------------

Summary of changes:
 crypto/err/openssl.txt                        |   7 +
 crypto/x509/v3_crld.c                         |  27 ++--
 crypto/x509/v3_purp.c                         | 118 +++++++++++++----
 crypto/x509/v3err.c                           |   5 +
 crypto/x509/x509_err.c                        |   7 +
 crypto/x509/x509_set.c                        |  97 ++++++++------
 crypto/x509/x509_txt.c                        |  42 +++++-
 crypto/x509/x509_vfy.c                        |  78 ++++++++++-
 doc/internal/man3/x509v3_cache_extensions.pod |  40 ++++++
 doc/man1/openssl.pod                          |   1 +
 include/crypto/x509.h                         |   6 +-
 include/openssl/x509_vfy.h                    | 179 ++++++++++++++------------
 include/openssl/x509err.h                     |   4 +
 include/openssl/x509v3.h                      |  11 +-
 include/openssl/x509v3err.h                   |   3 +
 test/recipes/25-test_verify.t                 |   7 +-
 test/testx509.pem                             |  16 +--
 17 files changed, 463 insertions(+), 185 deletions(-)
 create mode 100644 doc/internal/man3/x509v3_cache_extensions.pod

diff --git a/crypto/err/openssl.txt b/crypto/err/openssl.txt
index df8a7af26c..d0ba9c47be 100644
--- a/crypto/err/openssl.txt
+++ b/crypto/err/openssl.txt
@@ -3487,6 +3487,7 @@ X509V3_R_BN_TO_ASN1_INTEGER_ERROR:101:bn to asn1 integer error
 X509V3_R_DIRNAME_ERROR:149:dirname error
 X509V3_R_DISTPOINT_ALREADY_SET:160:distpoint already set
 X509V3_R_DUPLICATE_ZONE_ID:133:duplicate zone id
+X509V3_R_EMPTY_KEY_USAGE:169:empty key usage
 X509V3_R_ERROR_CONVERTING_ZONE:131:error converting zone
 X509V3_R_ERROR_CREATING_EXTENSION:144:error creating extension
 X509V3_R_ERROR_IN_EXTENSION:128:error in extension
@@ -3501,6 +3502,7 @@ X509V3_R_INCORRECT_POLICY_SYNTAX_TAG:152:incorrect policy syntax tag
 X509V3_R_INVALID_ASNUMBER:162:invalid asnumber
 X509V3_R_INVALID_ASRANGE:163:invalid asrange
 X509V3_R_INVALID_BOOLEAN_STRING:104:invalid boolean string
+X509V3_R_INVALID_CERTIFICATE:158:invalid certificate
 X509V3_R_INVALID_EMPTY_NAME:108:invalid empty name
 X509V3_R_INVALID_EXTENSION_STRING:105:invalid extension string
 X509V3_R_INVALID_INHERITANCE:165:invalid inheritance
@@ -3522,6 +3524,7 @@ X509V3_R_INVALID_SYNTAX:143:invalid syntax
 X509V3_R_ISSUER_DECODE_ERROR:126:issuer decode error
 X509V3_R_MISSING_VALUE:124:missing value
 X509V3_R_NEED_ORGANIZATION_AND_NUMBERS:142:need organization and numbers
+X509V3_R_NEGATIVE_PATHLEN:168:negative pathlen
 X509V3_R_NO_CONFIG_DATABASE:136:no config database
 X509V3_R_NO_ISSUER_CERTIFICATE:121:no issuer certificate
 X509V3_R_NO_ISSUER_DETAILS:127:no issuer details
@@ -3557,9 +3560,12 @@ X509_R_CERTIFICATE_VERIFICATION_FAILED:139:certificate verification failed
 X509_R_CERT_ALREADY_IN_HASH_TABLE:101:cert already in hash table
 X509_R_CRL_ALREADY_DELTA:127:crl already delta
 X509_R_CRL_VERIFY_FAILURE:131:crl verify failure
+X509_R_ERROR_GETTING_MD_BY_NID:141:error getting md by nid
+X509_R_ERROR_USING_SIGINF_SET:142:error using siginf set
 X509_R_IDP_MISMATCH:128:idp mismatch
 X509_R_INVALID_ATTRIBUTES:138:invalid attributes
 X509_R_INVALID_DIRECTORY:113:invalid directory
+X509_R_INVALID_DISTPOINT:143:invalid distpoint
 X509_R_INVALID_FIELD_NAME:119:invalid field name
 X509_R_INVALID_TRUST:123:invalid trust
 X509_R_ISSUER_MISMATCH:129:issuer mismatch
@@ -3583,6 +3589,7 @@ X509_R_UNABLE_TO_GET_CERTS_PUBLIC_KEY:108:unable to get certs public key
 X509_R_UNKNOWN_KEY_TYPE:117:unknown key type
 X509_R_UNKNOWN_NID:109:unknown nid
 X509_R_UNKNOWN_PURPOSE_ID:121:unknown purpose id
+X509_R_UNKNOWN_SIGID_ALGS:144:unknown sigid algs
 X509_R_UNKNOWN_TRUST_ID:120:unknown trust id
 X509_R_UNSUPPORTED_ALGORITHM:111:unsupported algorithm
 X509_R_WRONG_LOOKUP_TYPE:112:wrong lookup type
diff --git a/crypto/x509/v3_crld.c b/crypto/x509/v3_crld.c
index b54346d036..8b4e100714 100644
--- a/crypto/x509/v3_crld.c
+++ b/crypto/x509/v3_crld.c
@@ -485,30 +485,31 @@ static int i2r_crldp(const X509V3_EXT_METHOD *method, void *pcrldp, BIO *out,
     return 1;
 }
 
+/* Append any nameRelativeToCRLIssuer in dpn to iname, set in dpn-&gt;dpname */
 int DIST_POINT_set_dpname(DIST_POINT_NAME *dpn, const X509_NAME *iname)
 {
     int i;
     STACK_OF(X509_NAME_ENTRY) *frag;
     X509_NAME_ENTRY *ne;
-    if (!dpn || (dpn-&gt;type != 1))
+
+    if (dpn == NULL || dpn-&gt;type != 1)
         return 1;
     frag = dpn-&gt;name.relativename;
+    X509_NAME_free(dpn-&gt;dpname); /* just in case it was already set */
     dpn-&gt;dpname = X509_NAME_dup(iname);
-    if (!dpn-&gt;dpname)
+    if (dpn-&gt;dpname == NULL)
         return 0;
     for (i = 0; i &lt; sk_X509_NAME_ENTRY_num(frag); i++) {
         ne = sk_X509_NAME_ENTRY_value(frag, i);
-        if (!X509_NAME_add_entry(dpn-&gt;dpname, ne, -1, i ? 0 : 1)) {
-            X509_NAME_free(dpn-&gt;dpname);
-            dpn-&gt;dpname = NULL;
-            return 0;
-        }
+        if (!X509_NAME_add_entry(dpn-&gt;dpname, ne, -1, i ? 0 : 1))
+            goto err;
     }
     /* generate cached encoding of name */
-    if (i2d_X509_NAME(dpn-&gt;dpname, NULL) &lt; 0) {
-        X509_NAME_free(dpn-&gt;dpname);
-        dpn-&gt;dpname = NULL;
-        return 0;
-    }
-    return 1;
+    if (i2d_X509_NAME(dpn-&gt;dpname, NULL) &gt;= 0)
+        return 1;
+
+ err:
+    X509_NAME_free(dpn-&gt;dpname);
+    dpn-&gt;dpname = NULL;
+    return 0;
 }
diff --git a/crypto/x509/v3_purp.c b/crypto/x509/v3_purp.c
index d7d0aae3b3..2d4098b629 100644
--- a/crypto/x509/v3_purp.c
+++ b/crypto/x509/v3_purp.c
@@ -305,34 +305,49 @@ int X509_supported_extension(X509_EXTENSION *ex)
     return 0;
 }
 
-static int setup_dp(X509 *x, DIST_POINT *dp)
+/* return 1 on success, 0 if x is invalid, -1 on (internal) error */
+static int setup_dp(const X509 *x, DIST_POINT *dp)
 {
     const X509_NAME *iname = NULL;
     int i;
 
-    if (dp-&gt;reasons) {
+    if (dp-&gt;distpoint == NULL &amp;&amp; sk_GENERAL_NAME_num(dp-&gt;CRLissuer) &lt;= 0) {
+        X509err(0, X509_R_INVALID_DISTPOINT);
+        return 0;
+    }
+    if (dp-&gt;reasons != NULL) {
         if (dp-&gt;reasons-&gt;length &gt; 0)
             dp-&gt;dp_reasons = dp-&gt;reasons-&gt;data[0];
         if (dp-&gt;reasons-&gt;length &gt; 1)
             dp-&gt;dp_reasons |= (dp-&gt;reasons-&gt;data[1] &lt;&lt; 8);
         dp-&gt;dp_reasons &amp;= CRLDP_ALL_REASONS;
-    } else
+    } else {
         dp-&gt;dp_reasons = CRLDP_ALL_REASONS;
-    if (!dp-&gt;distpoint || (dp-&gt;distpoint-&gt;type != 1))
+    }
+    if (dp-&gt;distpoint == NULL || dp-&gt;distpoint-&gt;type != 1)
         return 1;
+
+    /* handle name fragment given by nameRelativeToCRLIssuer */
+    /*
+     * Note that the below way of determining iname is not really compliant
+     * with <A HREF="https://tools.ietf.org/html/rfc5280#section-4.2.1.13">https://tools.ietf.org/html/rfc5280#section-4.2.1.13</A>
+     * According to it, sk_GENERAL_NAME_num(dp-&gt;CRLissuer) MUST be &lt;= 1
+     * and any CRLissuer could be of type different to GEN_DIRNAME.
+     */
     for (i = 0; i &lt; sk_GENERAL_NAME_num(dp-&gt;CRLissuer); i++) {
         GENERAL_NAME *gen = sk_GENERAL_NAME_value(dp-&gt;CRLissuer, i);
+
         if (gen-&gt;type == GEN_DIRNAME) {
             iname = gen-&gt;d.directoryName;
             break;
         }
     }
-    if (!iname)
+    if (iname == NULL)
         iname = X509_get_issuer_name(x);
-
-    return DIST_POINT_set_dpname(dp-&gt;distpoint, iname);
+    return DIST_POINT_set_dpname(dp-&gt;distpoint, iname) ? 1 : -1;
 }
 
+/* return 1 on success, 0 if x is invalid, -1 on (internal) error */
 static int setup_crldp(X509 *x)
 {
     int i;
@@ -340,9 +355,12 @@ static int setup_crldp(X509 *x)
     x-&gt;crldp = X509_get_ext_d2i(x, NID_crl_distribution_points, &amp;i, NULL);
     if (x-&gt;crldp == NULL &amp;&amp; i != -1)
         return 0;
+
     for (i = 0; i &lt; sk_DIST_POINT_num(x-&gt;crldp); i++) {
-        if (!setup_dp(x, sk_DIST_POINT_value(x-&gt;crldp, i)))
-            return 0;
+        int res = setup_dp(x, sk_DIST_POINT_value(x-&gt;crldp, i));
+
+        if (res &lt; 1)
+            return res;
     }
     return 1;
 }
@@ -373,6 +391,7 @@ static int check_sig_alg_match(const EVP_PKEY *pkey, const X509 *subject)
 /*
  * Cache info on various X.509v3 extensions and further derived information,
  * e.g., if cert 'x' is self-issued, in x-&gt;ex_flags and other internal fields.
+ * X509_SIG_INFO_VALID is set in x-&gt;flags if x-&gt;siginf was filled successfully.
  * Set EXFLAG_INVALID and return 0 in case the certificate is invalid.
  */
 int x509v3_cache_extensions(X509 *x)
@@ -382,8 +401,8 @@ int x509v3_cache_extensions(X509 *x)
     ASN1_BIT_STRING *usage;
     ASN1_BIT_STRING *ns;
     EXTENDED_KEY_USAGE *extusage;
-    X509_EXTENSION *ex;
     int i;
+    int res;
 
 #ifdef tsan_ld_acq
     /* fast lock-free check, see end of the function for details. */
@@ -398,30 +417,34 @@ int x509v3_cache_extensions(X509 *x)
     }
     ERR_set_mark();
 
+    /* Cache the SHA1 digest of the cert */
     if (!X509_digest(x, EVP_sha1(), x-&gt;sha1_hash, NULL))
-            x-&gt;ex_flags |= EXFLAG_INVALID;
+        /*
+         * Note that the cert is marked invalid also on internal malloc failure
+         * or on failure of EVP_MD_fetch(), potentially called by X509_digest().
+         */
+        x-&gt;ex_flags |= EXFLAG_INVALID;
 
     /* V1 should mean no extensions ... */
     if (X509_get_version(x) == 0)
         x-&gt;ex_flags |= EXFLAG_V1;
 
     /* Handle basic constraints */
+    x-&gt;ex_pathlen = -1;
     if ((bs = X509_get_ext_d2i(x, NID_basic_constraints, &amp;i, NULL)) != NULL) {
         if (bs-&gt;ca)
             x-&gt;ex_flags |= EXFLAG_CA;
         if (bs-&gt;pathlen != NULL) {
+            /*
+             * the error case !bs-&gt;ca is checked by check_chain_extensions()
+             * in case ctx-&gt;param-&gt;flags &amp; X509_V_FLAG_X509_STRICT
+             */
             if (bs-&gt;pathlen-&gt;type == V_ASN1_NEG_INTEGER) {
+                X509err(0, X509V3_R_NEGATIVE_PATHLEN);
                 x-&gt;ex_flags |= EXFLAG_INVALID;
-                x-&gt;ex_pathlen = 0;
             } else {
                 x-&gt;ex_pathlen = ASN1_INTEGER_get(bs-&gt;pathlen);
-                if (!bs-&gt;ca &amp;&amp; x-&gt;ex_pathlen != 0) {
-                    x-&gt;ex_flags |= EXFLAG_INVALID;
-                    x-&gt;ex_pathlen = 0;
-                }
             }
-        } else {
-            x-&gt;ex_pathlen = -1;
         }
         BASIC_CONSTRAINTS_free(bs);
         x-&gt;ex_flags |= EXFLAG_BCONS;
@@ -436,9 +459,9 @@ int x509v3_cache_extensions(X509 *x)
             || X509_get_ext_by_NID(x, NID_issuer_alt_name, -1) &gt;= 0) {
             x-&gt;ex_flags |= EXFLAG_INVALID;
         }
-        if (pci-&gt;pcPathLengthConstraint) {
+        if (pci-&gt;pcPathLengthConstraint != NULL)
             x-&gt;ex_pcpathlen = ASN1_INTEGER_get(pci-&gt;pcPathLengthConstraint);
-        } else
+        else
             x-&gt;ex_pcpathlen = -1;
         PROXY_CERT_INFO_EXTENSION_free(pci);
         x-&gt;ex_flags |= EXFLAG_PROXY;
@@ -446,7 +469,7 @@ int x509v3_cache_extensions(X509 *x)
         x-&gt;ex_flags |= EXFLAG_INVALID;
     }
 
-    /* Handle (basic and extended) key usage */
+    /* Handle (basic) key usage */
     if ((usage = X509_get_ext_d2i(x, NID_key_usage, &amp;i, NULL)) != NULL) {
         x-&gt;ex_kusage = 0;
         if (usage-&gt;length &gt; 0) {
@@ -456,9 +479,16 @@ int x509v3_cache_extensions(X509 *x)
         }
         x-&gt;ex_flags |= EXFLAG_KUSAGE;
         ASN1_BIT_STRING_free(usage);
+        /* Check for empty key usage according to RFC 5280 section 4.2.1.3 */
+        if (x-&gt;ex_kusage == 0) {
+            X509err(0, X509V3_R_EMPTY_KEY_USAGE);
+            x-&gt;ex_flags |= EXFLAG_INVALID;
+        }
     } else if (i != -1) {
         x-&gt;ex_flags |= EXFLAG_INVALID;
     }
+
+    /* Handle extended key usage */
     x-&gt;ex_xkusage = 0;
     if ((extusage = X509_get_ext_d2i(x, NID_ext_key_usage, &amp;i, NULL)) != NULL) {
         x-&gt;ex_flags |= EXFLAG_XKUSAGE;
@@ -493,6 +523,7 @@ int x509v3_cache_extensions(X509 *x)
                 x-&gt;ex_xkusage |= XKU_ANYEKU;
                 break;
             default:
+                /* ignore unknown extended key usage */
                 break;
             }
         }
@@ -517,6 +548,7 @@ int x509v3_cache_extensions(X509 *x)
     x-&gt;skid = X509_get_ext_d2i(x, NID_subject_key_identifier, &amp;i, NULL);
     if (x-&gt;skid == NULL &amp;&amp; i != -1)
         x-&gt;ex_flags |= EXFLAG_INVALID;
+
     x-&gt;akid = X509_get_ext_d2i(x, NID_authority_key_identifier, &amp;i, NULL);
     if (x-&gt;akid == NULL &amp;&amp; i != -1)
         x-&gt;ex_flags |= EXFLAG_INVALID;
@@ -538,8 +570,13 @@ int x509v3_cache_extensions(X509 *x)
     x-&gt;nc = X509_get_ext_d2i(x, NID_name_constraints, &amp;i, NULL);
     if (x-&gt;nc == NULL &amp;&amp; i != -1)
         x-&gt;ex_flags |= EXFLAG_INVALID;
-    if (!setup_crldp(x))
+
+    /* Handle CRL distribution point entries */
+    res = setup_crldp(x);
+    if (res == 0)
         x-&gt;ex_flags |= EXFLAG_INVALID;
+    else if (res &lt; 0)
+        goto err;
 
 #ifndef OPENSSL_NO_RFC3779
     x-&gt;rfc3779_addr = X509_get_ext_d2i(x, NID_sbgp_ipAddrBlock, &amp;i, NULL);
@@ -550,9 +587,10 @@ int x509v3_cache_extensions(X509 *x)
         x-&gt;ex_flags |= EXFLAG_INVALID;
 #endif
     for (i = 0; i &lt; X509_get_ext_count(x); i++) {
-        ex = X509_get_ext(x, i);
-        if (OBJ_obj2nid(X509_EXTENSION_get_object(ex))
-            == NID_freshest_crl)
+        X509_EXTENSION *ex = X509_get_ext(x, i);
+        int nid = OBJ_obj2nid(X509_EXTENSION_get_object(ex));
+
+        if (nid == NID_freshest_crl)
             x-&gt;ex_flags |= EXFLAG_FRESHEST;
         if (!X509_EXTENSION_get_critical(ex))
             continue;
@@ -560,9 +598,26 @@ int x509v3_cache_extensions(X509 *x)
             x-&gt;ex_flags |= EXFLAG_CRITICAL;
             break;
         }
+        switch (nid) {
+        case NID_basic_constraints:
+            x-&gt;ex_flags |= EXFLAG_BCONS_CRITICAL;
+            break;
+        case NID_authority_key_identifier:
+            x-&gt;ex_flags |= EXFLAG_AKID_CRITICAL;
+            break;
+        case NID_subject_key_identifier:
+            x-&gt;ex_flags |= EXFLAG_SKID_CRITICAL;
+            break;
+        case NID_subject_alt_name:
+            x-&gt;ex_flags |= EXFLAG_SAN_CRITICAL;
+            break;
+        default:
+            break;
+        }
     }
 
-    x509_init_sig_info(x);
+    /* Set x-&gt;siginf, ignoring errors due to unsupported algos */
+    (void)x509_init_sig_info(x);
 
     x-&gt;ex_flags |= EXFLAG_SET; /* indicate that cert has been processed */
 #ifdef tsan_st_rel
@@ -574,9 +629,16 @@ int x509v3_cache_extensions(X509 *x)
      */
 #endif
     ERR_pop_to_mark();
-    CRYPTO_THREAD_unlock(x-&gt;lock);
+    if ((x-&gt;ex_flags &amp; EXFLAG_INVALID) == 0) {
+        CRYPTO_THREAD_unlock(x-&gt;lock);
+        return 1;
+    }
+    X509err(0, X509V3_R_INVALID_CERTIFICATE);
 
-    return (x-&gt;ex_flags &amp; EXFLAG_INVALID) == 0;
+ err:
+    x-&gt;ex_flags |= EXFLAG_SET; /* indicate that cert has been processed */
+    CRYPTO_THREAD_unlock(x-&gt;lock);
+    return 0;
 }
 
 /*-
diff --git a/crypto/x509/v3err.c b/crypto/x509/v3err.c
index 4c62e59db9..5124908089 100644
--- a/crypto/x509/v3err.c
+++ b/crypto/x509/v3err.c
@@ -24,6 +24,7 @@ static const ERR_STRING_DATA X509V3_str_reasons[] = {
     &quot;distpoint already set&quot;},
     {ERR_PACK(ERR_LIB_X509V3, 0, X509V3_R_DUPLICATE_ZONE_ID),
     &quot;duplicate zone id&quot;},
+    {ERR_PACK(ERR_LIB_X509V3, 0, X509V3_R_EMPTY_KEY_USAGE), &quot;empty key usage&quot;},
     {ERR_PACK(ERR_LIB_X509V3, 0, X509V3_R_ERROR_CONVERTING_ZONE),
     &quot;error converting zone&quot;},
     {ERR_PACK(ERR_LIB_X509V3, 0, X509V3_R_ERROR_CREATING_EXTENSION),
@@ -51,6 +52,8 @@ static const ERR_STRING_DATA X509V3_str_reasons[] = {
     {ERR_PACK(ERR_LIB_X509V3, 0, X509V3_R_INVALID_ASRANGE), &quot;invalid asrange&quot;},
     {ERR_PACK(ERR_LIB_X509V3, 0, X509V3_R_INVALID_BOOLEAN_STRING),
     &quot;invalid boolean string&quot;},
+    {ERR_PACK(ERR_LIB_X509V3, 0, X509V3_R_INVALID_CERTIFICATE),
+    &quot;invalid certificate&quot;},
     {ERR_PACK(ERR_LIB_X509V3, 0, X509V3_R_INVALID_EXTENSION_STRING),
     &quot;invalid extension string&quot;},
     {ERR_PACK(ERR_LIB_X509V3, 0, X509V3_R_INVALID_INHERITANCE),
@@ -84,6 +87,8 @@ static const ERR_STRING_DATA X509V3_str_reasons[] = {
     {ERR_PACK(ERR_LIB_X509V3, 0, X509V3_R_MISSING_VALUE), &quot;missing value&quot;},
     {ERR_PACK(ERR_LIB_X509V3, 0, X509V3_R_NEED_ORGANIZATION_AND_NUMBERS),
     &quot;need organization and numbers&quot;},
+    {ERR_PACK(ERR_LIB_X509V3, 0, X509V3_R_NEGATIVE_PATHLEN),
+    &quot;negative pathlen&quot;},
     {ERR_PACK(ERR_LIB_X509V3, 0, X509V3_R_NO_CONFIG_DATABASE),
     &quot;no config database&quot;},
     {ERR_PACK(ERR_LIB_X509V3, 0, X509V3_R_NO_ISSUER_CERTIFICATE),
diff --git a/crypto/x509/x509_err.c b/crypto/x509/x509_err.c
index 450f2a7930..330fed3406 100644
--- a/crypto/x509/x509_err.c
+++ b/crypto/x509/x509_err.c
@@ -27,10 +27,15 @@ static const ERR_STRING_DATA X509_str_reasons[] = {
     {ERR_PACK(ERR_LIB_X509, 0, X509_R_CRL_ALREADY_DELTA), &quot;crl already delta&quot;},
     {ERR_PACK(ERR_LIB_X509, 0, X509_R_CRL_VERIFY_FAILURE),
     &quot;crl verify failure&quot;},
+    {ERR_PACK(ERR_LIB_X509, 0, X509_R_ERROR_GETTING_MD_BY_NID),
+    &quot;error getting md by nid&quot;},
+    {ERR_PACK(ERR_LIB_X509, 0, X509_R_ERROR_USING_SIGINF_SET),
+    &quot;error using siginf set&quot;},
     {ERR_PACK(ERR_LIB_X509, 0, X509_R_IDP_MISMATCH), &quot;idp mismatch&quot;},
     {ERR_PACK(ERR_LIB_X509, 0, X509_R_INVALID_ATTRIBUTES),
     &quot;invalid attributes&quot;},
     {ERR_PACK(ERR_LIB_X509, 0, X509_R_INVALID_DIRECTORY), &quot;invalid directory&quot;},
+    {ERR_PACK(ERR_LIB_X509, 0, X509_R_INVALID_DISTPOINT), &quot;invalid distpoint&quot;},
     {ERR_PACK(ERR_LIB_X509, 0, X509_R_INVALID_FIELD_NAME),
     &quot;invalid field name&quot;},
     {ERR_PACK(ERR_LIB_X509, 0, X509_R_INVALID_TRUST), &quot;invalid trust&quot;},
@@ -66,6 +71,8 @@ static const ERR_STRING_DATA X509_str_reasons[] = {
     {ERR_PACK(ERR_LIB_X509, 0, X509_R_UNKNOWN_NID), &quot;unknown nid&quot;},
     {ERR_PACK(ERR_LIB_X509, 0, X509_R_UNKNOWN_PURPOSE_ID),
     &quot;unknown purpose id&quot;},
+    {ERR_PACK(ERR_LIB_X509, 0, X509_R_UNKNOWN_SIGID_ALGS),
+    &quot;unknown sigid algs&quot;},
     {ERR_PACK(ERR_LIB_X509, 0, X509_R_UNKNOWN_TRUST_ID), &quot;unknown trust id&quot;},
     {ERR_PACK(ERR_LIB_X509, 0, X509_R_UNSUPPORTED_ALGORITHM),
     &quot;unsupported algorithm&quot;},
diff --git a/crypto/x509/x509_set.c b/crypto/x509/x509_set.c
index 46cabc4b42..79e4c03ca3 100644
--- a/crypto/x509/x509_set.c
+++ b/crypto/x509/x509_set.c
@@ -192,60 +192,85 @@ int X509_get_signature_info(X509 *x, int *mdnid, int *pknid, int *secbits,
     return X509_SIG_INFO_get(&amp;x-&gt;siginf, mdnid, pknid, secbits, flags);
 }
 
-static void x509_sig_info_init(X509_SIG_INFO *siginf, const X509_ALGOR *alg,
-                               const ASN1_STRING *sig)
+/* Modify *siginf according to alg and sig. Return 1 on success, else 0. */
+static int x509_sig_info_init(X509_SIG_INFO *siginf, const X509_ALGOR *alg,
+                              const ASN1_STRING *sig)
 {
     int pknid, mdnid;
     const EVP_MD *md;
+    const EVP_PKEY_ASN1_METHOD *ameth;
 
     siginf-&gt;mdnid = NID_undef;
     siginf-&gt;pknid = NID_undef;
     siginf-&gt;secbits = -1;
     siginf-&gt;flags = 0;
     if (!OBJ_find_sigid_algs(OBJ_obj2nid(alg-&gt;algorithm), &amp;mdnid, &amp;pknid)
-            || pknid == NID_undef)
-        return;
+            || pknid == NID_undef) {
+        X509err(0, X509_R_UNKNOWN_SIGID_ALGS);
+        return 0;
+    }
+    siginf-&gt;mdnid = mdnid;
     siginf-&gt;pknid = pknid;
-    if (mdnid == NID_undef) {
+
+    switch (mdnid) {
+    case NID_undef:
         /* If we have one, use a custom handler for this algorithm */
-        const EVP_PKEY_ASN1_METHOD *ameth = EVP_PKEY_asn1_find(NULL, pknid);
+        ameth = EVP_PKEY_asn1_find(NULL, pknid);
         if (ameth == NULL || ameth-&gt;siginf_set == NULL
-                || ameth-&gt;siginf_set(siginf, alg, sig) == 0)
-            return;
-        siginf-&gt;flags |= X509_SIG_INFO_VALID;
-        return;
-    }
-    siginf-&gt;flags |= X509_SIG_INFO_VALID;
-    siginf-&gt;mdnid = mdnid;
-    md = EVP_get_digestbynid(mdnid);
-    if (md == NULL)
-        return;
-    /* Security bits: half number of bits in digest */
-    siginf-&gt;secbits = EVP_MD_size(md) * 4;
-    /*
-     * SHA1 and MD5 are known to be broken. Reduce security bits so that
-     * they're no longer accepted at security level 1. The real values don't
-     * really matter as long as they're lower than 80, which is our security
-     * level 1.
-     * <A HREF="https://eprint.iacr.org/2020/014">https://eprint.iacr.org/2020/014</A> puts a chosen-prefix attack for SHA1 at
-     * 2^63.4
-     * <A HREF="https://documents.epfl.ch/users/l/le/lenstra/public/papers/lat.pdf">https://documents.epfl.ch/users/l/le/lenstra/public/papers/lat.pdf</A>
-     * puts a chosen-prefix attack for MD5 at 2^39.
-     */
-    if (mdnid == NID_sha1)
+                || !ameth-&gt;siginf_set(siginf, alg, sig)) {
+            X509err(0, X509_R_ERROR_USING_SIGINF_SET);
+            return 0;
+        }
+        break;
+        /*
+         * SHA1 and MD5 are known to be broken. Reduce security bits so that
+         * they're no longer accepted at security level 1.
+         * The real values don't really matter as long as they're lower than 80,
+         * which is our security level 1.
+         */
+    case NID_sha1:
+        /*
+         * <A HREF="https://eprint.iacr.org/2020/014">https://eprint.iacr.org/2020/014</A> puts a chosen-prefix attack
+         * for SHA1 at2^63.4
+         */
         siginf-&gt;secbits = 63;
-    else if (mdnid == NID_md5)
+        break;
+    case NID_md5:
+        /*
+         * <A HREF="https://documents.epfl.ch/users/l/le/lenstra/public/papers/lat.pdf">https://documents.epfl.ch/users/l/le/lenstra/public/papers/lat.pdf</A>
+         * puts a chosen-prefix attack for MD5 at 2^39.
+         */
         siginf-&gt;secbits = 39;
+        break;
+    case NID_id_GostR3411_94:
+        /*
+         * There is a collision attack on GOST R 34.11-94 at 2^105, see
+         * <A HREF="https://link.springer.com/chapter/10.1007%2F978-3-540-85174-5_10">https://link.springer.com/chapter/10.1007%2F978-3-540-85174-5_10</A>
+         */
+        siginf-&gt;secbits = 105;
+        break;
+    default:
+        /* Security bits: half number of bits in digest */
+        if ((md = EVP_get_digestbynid(mdnid)) == NULL) {
+            X509err(0, X509_R_ERROR_GETTING_MD_BY_NID);
+            return 0;
+        }
+        siginf-&gt;secbits = EVP_MD_size(md) * 4;
+        break;
+    }
     switch (mdnid) {
-        case NID_sha1:
-        case NID_sha256:
-        case NID_sha384:
-        case NID_sha512:
+    case NID_sha1:
+    case NID_sha256:
+    case NID_sha384:
+    case NID_sha512:
         siginf-&gt;flags |= X509_SIG_INFO_TLS;
     }
+    siginf-&gt;flags |= X509_SIG_INFO_VALID;
+    return 1;
 }
 
-void x509_init_sig_info(X509 *x)
+/* Returns 1 on success, 0 on failure */
+int x509_init_sig_info(X509 *x)
 {
-    x509_sig_info_init(&amp;x-&gt;siginf, &amp;x-&gt;sig_alg, &amp;x-&gt;signature);
+    return x509_sig_info_init(&amp;x-&gt;siginf, &amp;x-&gt;sig_alg, &amp;x-&gt;signature);
 }
diff --git a/crypto/x509/x509_txt.c b/crypto/x509/x509_txt.c
index 63d8d95f3f..53b19e46df 100644
--- a/crypto/x509/x509_txt.c
+++ b/crypto/x509/x509_txt.c
@@ -69,8 +69,8 @@ const char *X509_verify_cert_error_string(long n)
         return &quot;certificate chain too long&quot;;
     case X509_V_ERR_CERT_REVOKED:
         return &quot;certificate revoked&quot;;
-    case X509_V_ERR_INVALID_CA:
-        return &quot;invalid CA certificate&quot;;
+    case X509_V_ERR_NO_ISSUER_PUBLIC_KEY:
+        return &quot;issuer certificate doesn't have a public key&quot;;
     case X509_V_ERR_PATH_LENGTH_EXCEEDED:
         return &quot;path length constraint exceeded&quot;;
     case X509_V_ERR_INVALID_PURPOSE:
@@ -174,12 +174,42 @@ const char *X509_verify_cert_error_string(long n)
         return &quot;OCSP verification failed&quot;;
     case X509_V_ERR_OCSP_CERT_UNKNOWN:
         return &quot;OCSP unknown cert&quot;;
-    case X509_V_ERR_SIGNATURE_ALGORITHM_MISMATCH:
-        return &quot;subject signature algorithm and issuer public key algorithm mismatch&quot;;
-    case X509_V_ERR_NO_ISSUER_PUBLIC_KEY:
-        return &quot;issuer certificate doesn't have a public key&quot;;
     case X509_V_ERR_UNSUPPORTED_SIGNATURE_ALGORITHM:
         return &quot;Cannot find certificate signature algorithm&quot;;
+    case X509_V_ERR_SIGNATURE_ALGORITHM_MISMATCH:
+        return &quot;subject signature algorithm and issuer public key algorithm mismatch&quot;;
+    case X509_V_ERR_SIGNATURE_ALGORITHM_INCONSISTENCY:
+        return &quot;cert info siganature and signature algorithm mismatch&quot;;
+    case X509_V_ERR_INVALID_CA:
+        return &quot;invalid CA certificate&quot;;
+    case X509_V_ERR_PATHLEN_INVALID_FOR_NON_CA:
+        return &quot;Path length invalid for non-CA cert&quot;;
+    case X509_V_ERR_PATHLEN_WITHOUT_KU_KEY_CERT_SIGN:
+        return &quot;Path length given without key usage keyCertSign&quot;;
+    case X509_V_ERR_KU_KEY_CERT_SIGN_INVALID_FOR_NON_CA:
+        return &quot;Key usage keyCertSign invalid for non-CA cert&quot;;
+    case X509_V_ERR_ISSUER_NAME_EMPTY:
+        return &quot;Issuer name empty&quot;;
+    case X509_V_ERR_SUBJECT_NAME_EMPTY:
+        return &quot;Subject name empty&quot;;
+    case X509_V_ERR_MISSING_AUTHORITY_KEY_IDENTIFIER:
+        return &quot;Missing Authority Key Identifier&quot;;
+    case X509_V_ERR_MISSING_SUBJECT_KEY_IDENTIFIER:
+        return &quot;Missing Subject Key Identifier&quot;;
+    case X509_V_ERR_EMPTY_SUBJECT_ALT_NAME:
+        return &quot;Empty Subject Alternative Name extension&quot;;
+    case X509_V_ERR_CA_BCONS_NOT_CRITICAL:
+        return &quot;Basic Constraints of CA cert not marked critical&quot;;
+    case X509_V_ERR_EMPTY_SUBJECT_SAN_NOT_CRITICAL:
+        return &quot;Subject empty and Subject Alt Name extension not critical&quot;;
+    case X509_V_ERR_AUTHORITY_KEY_IDENTIFIER_CRITICAL:
+        return &quot;Authority Key Identifier marked critical&quot;;
+    case X509_V_ERR_SUBJECT_KEY_IDENTIFIER_CRITICAL:
+        return &quot;Subject Key Identifier marked critical&quot;;
+    case X509_V_ERR_CA_CERT_MISSING_KEY_USAGE:
+        return &quot;CA cert does not include key usage extension&quot;;
+    case X509_V_ERR_EXTENSIONS_REQUIRE_VERSION_3:
+        return &quot;Using cert extension requires at least X509v3&quot;;
 
     default:
         /* Printing an error number into a static buffer is not thread-safe */
diff --git a/crypto/x509/x509_vfy.c b/crypto/x509/x509_vfy.c
index 843b65f022..4a067e5ff4 100644
--- a/crypto/x509/x509_vfy.c
+++ b/crypto/x509/x509_vfy.c
@@ -26,6 +26,7 @@
 #include &quot;x509_local.h&quot;
 
 DEFINE_STACK_OF(X509)
+DEFINE_STACK_OF(X509_EXTENSION)
 DEFINE_STACK_OF(X509_REVOKED)
 DEFINE_STACK_OF(GENERAL_NAME)
 DEFINE_STACK_OF(X509_CRL)
@@ -479,6 +480,7 @@ static int check_chain_extensions(X509_STORE_CTX *ctx)
 
     for (i = 0; i &lt; num; i++) {
         int ret;
+
         x = sk_X509_value(ctx-&gt;chain, i);
         if (!(ctx-&gt;param-&gt;flags &amp; X509_V_FLAG_IGNORE_CRITICAL)
             &amp;&amp; (x-&gt;ex_flags &amp; EXFLAG_CRITICAL)) {
@@ -519,12 +521,78 @@ static int check_chain_extensions(X509_STORE_CTX *ctx)
                 ret = 1;
             break;
         }
-        if ((x-&gt;ex_flags &amp; EXFLAG_CA) == 0
-            &amp;&amp; x-&gt;ex_pathlen != -1
-            &amp;&amp; (ctx-&gt;param-&gt;flags &amp; X509_V_FLAG_X509_STRICT)) {
-            ctx-&gt;error = X509_V_ERR_INVALID_EXTENSION;
-            ret = 0;
+        /*
+         * Do the following set of checks only if strict checking is requrested
+         * and not for self-issued (including self-signed) EE (non-CA) certs
+         * because RFC 5280 does not apply to them according RFC 6818 section 2.
+         */
+        if ((ctx-&gt;param-&gt;flags &amp; X509_V_FLAG_X509_STRICT) != 0
+            &amp;&amp; num &gt; 1) { /*
+                           * this should imply
+                           * !(i == 0 &amp;&amp; (x-&gt;ex_flags &amp; EXFLAG_CA) == 0
+                           *          &amp;&amp; (x-&gt;ex_flags &amp; EXFLAG_SI) != 0)
+                           */
+            /* Check Basic Constraints according to RFC 5280 section 4.2.1.9 */
+            if (x-&gt;ex_pathlen != -1) {
+                if ((x-&gt;ex_flags &amp; EXFLAG_CA) == 0)
+                    ctx-&gt;error = X509_V_ERR_PATHLEN_INVALID_FOR_NON_CA;
+                if ((x-&gt;ex_kusage &amp; KU_KEY_CERT_SIGN) == 0)
+                    ctx-&gt;error = X509_V_ERR_PATHLEN_WITHOUT_KU_KEY_CERT_SIGN;
+            }
+            if ((x-&gt;ex_flags &amp; EXFLAG_CA) != 0
+                    &amp;&amp; (x-&gt;ex_flags &amp; EXFLAG_BCONS) != 0
+                    &amp;&amp; (x-&gt;ex_flags &amp; EXFLAG_BCONS_CRITICAL) == 0)
+                ctx-&gt;error = X509_V_ERR_CA_BCONS_NOT_CRITICAL;
+            /* Check Key Usage according to RFC 5280 section 4.2.1.3 */
+            if ((x-&gt;ex_flags &amp; EXFLAG_CA) != 0) {
+                if ((x-&gt;ex_flags &amp; EXFLAG_KUSAGE) == 0)
+                    ctx-&gt;error = X509_V_ERR_CA_CERT_MISSING_KEY_USAGE;
+            } else {
+                if ((x-&gt;ex_kusage &amp; KU_KEY_CERT_SIGN) != 0)
+                    ctx-&gt;error = X509_V_ERR_KU_KEY_CERT_SIGN_INVALID_FOR_NON_CA;
+            }
+            /* Check issuer is non-empty acc. to RFC 5280 section 4.1.2.4 */
+            if (X509_NAME_entry_count(X509_get_issuer_name(x)) == 0)
+                ctx-&gt;error = X509_V_ERR_ISSUER_NAME_EMPTY;
+            /* Check subject is non-empty acc. to RFC 5280 section 4.1.2.6 */
+            if (((x-&gt;ex_flags &amp; EXFLAG_CA) != 0
+                 || (x-&gt;ex_kusage &amp; KU_CRL_SIGN) != 0
+                 || x-&gt;altname == NULL
+                 ) &amp;&amp; X509_NAME_entry_count(X509_get_subject_name(x)) == 0)
+                ctx-&gt;error = X509_V_ERR_SUBJECT_NAME_EMPTY;
+            if (X509_NAME_entry_count(X509_get_subject_name(x)) == 0
+                    &amp;&amp; x-&gt;altname != NULL
+                    &amp;&amp; (x-&gt;ex_flags &amp; EXFLAG_SAN_CRITICAL) == 0)
+                ctx-&gt;error = X509_V_ERR_EMPTY_SUBJECT_SAN_NOT_CRITICAL;
+            /* Check SAN is non-empty according to RFC 5280 section 4.2.1.6 */
+            if (x-&gt;altname != NULL &amp;&amp; sk_GENERAL_NAME_num(x-&gt;altname) &lt;= 0)
+                ctx-&gt;error = X509_V_ERR_EMPTY_SUBJECT_ALT_NAME;
+            /* TODO add more checks on SAN entries */
+            /* Check sig alg consistency acc. to RFC 5280 section 4.1.1.2 */
+            if (X509_ALGOR_cmp(&amp;x-&gt;sig_alg, &amp;x-&gt;cert_info.signature) != 0)
+                ctx-&gt;error = X509_V_ERR_SIGNATURE_ALGORITHM_INCONSISTENCY;
+            if (x-&gt;akid != NULL &amp;&amp; (x-&gt;ex_flags &amp; EXFLAG_AKID_CRITICAL) != 0)
+                ctx-&gt;error = X509_V_ERR_AUTHORITY_KEY_IDENTIFIER_CRITICAL;
+            if (x-&gt;skid != NULL &amp;&amp; (x-&gt;ex_flags &amp; EXFLAG_SKID_CRITICAL) != 0)
+                ctx-&gt;error = X509_V_ERR_SUBJECT_KEY_IDENTIFIER_CRITICAL;
+            if (X509_get_version(x) &gt;= 2) { /* at least X.509v3 */
+                /* Check AKID presence acc. to RFC 5280 section 4.2.1.1 */
+                if (i + 1 &lt; num /*
+                                 * this means not last cert in chain,
+                                 * taken as &quot;generated by conforming CAs&quot;
+                                 */
+                        &amp;&amp; (x-&gt;akid == NULL || x-&gt;akid-&gt;keyid == NULL))
+                    ctx-&gt;error = X509_V_ERR_MISSING_AUTHORITY_KEY_IDENTIFIER;
+                /* Check SKID presence acc. to RFC 5280 section 4.2.1.2 */
+                if ((x-&gt;ex_flags &amp; EXFLAG_CA) != 0 &amp;&amp; x-&gt;skid == NULL)
+                    ctx-&gt;error = X509_V_ERR_MISSING_SUBJECT_KEY_IDENTIFIER;
+            } else {
+                if (sk_X509_EXTENSION_num(X509_get0_extensions(x)) &gt; 0)
+                    ctx-&gt;error = X509_V_ERR_EXTENSIONS_REQUIRE_VERSION_3;
+            }
         }
+        if (ctx-&gt;error != X509_V_OK)
+            ret = 0;
         if (ret == 0 &amp;&amp; !verify_cb_cert(ctx, x, i, X509_V_OK))
             return 0;
         /* check_purpose() makes the callback as needed */
diff --git a/doc/internal/man3/x509v3_cache_extensions.pod b/doc/internal/man3/x509v3_cache_extensions.pod
new file mode 100644
index 0000000000..3fb7609daa
--- /dev/null
+++ b/doc/internal/man3/x509v3_cache_extensions.pod
@@ -0,0 +1,40 @@
+=pod
+
+=head1 NAME
+
+x509v3_cache_extensions
+- cache info on various X.509v3 extensions and further derived certificate data
+
+=head1 SYNOPSIS
+
+ #include &lt;openssl/x509v3.h&gt;
+
+ int x509v3_cache_extensions(X509 *x, OPENSSL_CTX *libctx, const char *propq);
+
+=head1 DESCRIPTION
+
+This function processes any X509v3 extensions present in an X509 object I&lt;x&gt;
+and caches the result of that processing as well as further derived info,
+for instance whether the certificate is self-issued or has version X.509v1.
+It computes the SHA1 digest of the certificate using the default library context
+and property query string and stores the result in x-&gt;sha1_hash.
+It sets B&lt;X509_SIG_INFO_VALID&gt; in x-&gt;flags if x-&gt;siginf was filled successfully,
+which may not be possible if a referenced algorithm is unknown or not available.
+Many OpenSSL functions that use an X509 object call this function implicitly.
+
+=head1 RETURN VALUES
+
+This function returns 0 if the extensions or other portions of the certificate
+are invalid or an error occurred.
+Otherwise it returns 1.
+
+=head1 COPYRIGHT
+
+Copyright 2020 The OpenSSL Project Authors. All Rights Reserved.
+
+Licensed under the Apache License 2.0 (the &quot;License&quot;).  You may not use
+this file except in compliance with the License.  You can obtain a copy
+in the file LICENSE in the source distribution or at
+L&lt;<A HREF="https://www.openssl.org/source/license.html">https://www.openssl.org/source/license.html</A>&gt;.
+
+=cut
diff --git a/doc/man1/openssl.pod b/doc/man1/openssl.pod
index 1f344217a2..3ae273b5bf 100644
--- a/doc/man1/openssl.pod
+++ b/doc/man1/openssl.pod
@@ -906,6 +906,7 @@ a verification time, the check is not suppressed.
 =item B&lt;-x509_strict&gt;
 
 This disables non-compliant workarounds for broken certificates.
+Thus errors are thrown on certificates not compliant with RFC 5280.
 
 =item B&lt;-ignore_critical&gt;
 
diff --git a/include/crypto/x509.h b/include/crypto/x509.h
index bd8f9ba52d..8c9a288cbc 100644
--- a/include/crypto/x509.h
+++ b/include/crypto/x509.h
@@ -304,9 +304,13 @@ int a2i_ipadd(unsigned char *ipout, const char *ipasc);
 int x509_set1_time(ASN1_TIME **ptm, const ASN1_TIME *tm);
 int x509_print_ex_brief(BIO *bio, X509 *cert, unsigned long neg_cflags);
 int x509v3_cache_extensions(X509 *x);
+int x509_init_sig_info(X509 *x);
+int x509_check_issued_int(X509 *issuer, X509 *subject, OPENSSL_CTX *libctx,
+                          const char *propq);
+
 int x509_set0_libctx(X509 *x, OPENSSL_CTX *libctx, const char *propq);
 int x509_crl_set0_libctx(X509_CRL *x, OPENSSL_CTX *libctx, const char *propq);
-void x509_init_sig_info(X509 *x);
+int x509_init_sig_info(X509 *x);
 int asn1_item_digest_with_libctx(const ASN1_ITEM *it, const EVP_MD *type,
                                  void *data, unsigned char *md,
                                  unsigned int *len, OPENSSL_CTX *libctx,
diff --git a/include/openssl/x509_vfy.h b/include/openssl/x509_vfy.h
index 2d3bd70ae2..d43a442fc7 100644
--- a/include/openssl/x509_vfy.h
+++ b/include/openssl/x509_vfy.h
@@ -124,103 +124,118 @@ X509_LOOKUP_ctrl_with_libctx((x), X509_L_LOAD_STORE, (name), 0, NULL,          \
 X509_LOOKUP_ctrl_with_libctx((x), X509_L_ADD_STORE, (name), 0, NULL,           \
                              (libctx), (propq))
 
+# define X509_V_OK                                       0
+# define X509_V_ERR_UNSPECIFIED                          1
+# define X509_V_ERR_UNABLE_TO_GET_ISSUER_CERT            2
+# define X509_V_ERR_UNABLE_TO_GET_CRL                    3
+# define X509_V_ERR_UNABLE_TO_DECRYPT_CERT_SIGNATURE     4
+# define X509_V_ERR_UNABLE_TO_DECRYPT_CRL_SIGNATURE      5
+# define X509_V_ERR_UNABLE_TO_DECODE_ISSUER_PUBLIC_KEY   6
+# define X509_V_ERR_CERT_SIGNATURE_FAILURE               7
+# define X509_V_ERR_CRL_SIGNATURE_FAILURE                8
+# define X509_V_ERR_CERT_NOT_YET_VALID                   9
+# define X509_V_ERR_CERT_HAS_EXPIRED                     10
+# define X509_V_ERR_CRL_NOT_YET_VALID                    11
+# define X509_V_ERR_CRL_HAS_EXPIRED                      12
+# define X509_V_ERR_ERROR_IN_CERT_NOT_BEFORE_FIELD       13
+# define X509_V_ERR_ERROR_IN_CERT_NOT_AFTER_FIELD        14
+# define X509_V_ERR_ERROR_IN_CRL_LAST_UPDATE_FIELD       15
+# define X509_V_ERR_ERROR_IN_CRL_NEXT_UPDATE_FIELD       16
+# define X509_V_ERR_OUT_OF_MEM                           17
+# define X509_V_ERR_DEPTH_ZERO_SELF_SIGNED_CERT          18
+# define X509_V_ERR_SELF_SIGNED_CERT_IN_CHAIN            19
+# define X509_V_ERR_UNABLE_TO_GET_ISSUER_CERT_LOCALLY    20
+# define X509_V_ERR_UNABLE_TO_VERIFY_LEAF_SIGNATURE      21
+# define X509_V_ERR_CERT_CHAIN_TOO_LONG                  22
+# define X509_V_ERR_CERT_REVOKED                         23
+# define X509_V_ERR_NO_ISSUER_PUBLIC_KEY                 24
+# define X509_V_ERR_PATH_LENGTH_EXCEEDED                 25
+# define X509_V_ERR_INVALID_PURPOSE                      26
+# define X509_V_ERR_CERT_UNTRUSTED                       27
+# define X509_V_ERR_CERT_REJECTED                        28
 
-# define         X509_V_OK                                       0
-# define         X509_V_ERR_UNSPECIFIED                          1
-# define         X509_V_ERR_UNABLE_TO_GET_ISSUER_CERT            2
-# define         X509_V_ERR_UNABLE_TO_GET_CRL                    3
-# define         X509_V_ERR_UNABLE_TO_DECRYPT_CERT_SIGNATURE     4
-# define         X509_V_ERR_UNABLE_TO_DECRYPT_CRL_SIGNATURE      5
-# define         X509_V_ERR_UNABLE_TO_DECODE_ISSUER_PUBLIC_KEY   6
-# define         X509_V_ERR_CERT_SIGNATURE_FAILURE               7
-# define         X509_V_ERR_CRL_SIGNATURE_FAILURE                8
-# define         X509_V_ERR_CERT_NOT_YET_VALID                   9
-# define         X509_V_ERR_CERT_HAS_EXPIRED                     10
-# define         X509_V_ERR_CRL_NOT_YET_VALID                    11
-# define         X509_V_ERR_CRL_HAS_EXPIRED                      12
-# define         X509_V_ERR_ERROR_IN_CERT_NOT_BEFORE_FIELD       13
-# define         X509_V_ERR_ERROR_IN_CERT_NOT_AFTER_FIELD        14
-# define         X509_V_ERR_ERROR_IN_CRL_LAST_UPDATE_FIELD       15
-# define         X509_V_ERR_ERROR_IN_CRL_NEXT_UPDATE_FIELD       16
-# define         X509_V_ERR_OUT_OF_MEM                           17
-# define         X509_V_ERR_DEPTH_ZERO_SELF_SIGNED_CERT          18
-# define         X509_V_ERR_SELF_SIGNED_CERT_IN_CHAIN            19
-# define         X509_V_ERR_UNABLE_TO_GET_ISSUER_CERT_LOCALLY    20
-# define         X509_V_ERR_UNABLE_TO_VERIFY_LEAF_SIGNATURE      21
-# define         X509_V_ERR_CERT_CHAIN_TOO_LONG                  22
-# define         X509_V_ERR_CERT_REVOKED                         23
-# define         X509_V_ERR_INVALID_CA                           24
-# define         X509_V_ERR_PATH_LENGTH_EXCEEDED                 25
-# define         X509_V_ERR_INVALID_PURPOSE                      26
-# define         X509_V_ERR_CERT_UNTRUSTED                       27
-# define         X509_V_ERR_CERT_REJECTED                        28
 /* These are 'informational' when looking for issuer cert */
-# define         X509_V_ERR_SUBJECT_ISSUER_MISMATCH              29
-# define         X509_V_ERR_AKID_SKID_MISMATCH                   30
-# define         X509_V_ERR_AKID_ISSUER_SERIAL_MISMATCH          31
-# define         X509_V_ERR_KEYUSAGE_NO_CERTSIGN                 32
-# define         X509_V_ERR_UNABLE_TO_GET_CRL_ISSUER             33
-# define         X509_V_ERR_UNHANDLED_CRITICAL_EXTENSION         34
-# define         X509_V_ERR_KEYUSAGE_NO_CRL_SIGN                 35
-# define         X509_V_ERR_UNHANDLED_CRITICAL_CRL_EXTENSION     36
-# define         X509_V_ERR_INVALID_NON_CA                       37
-# define         X509_V_ERR_PROXY_PATH_LENGTH_EXCEEDED           38
-# define         X509_V_ERR_KEYUSAGE_NO_DIGITAL_SIGNATURE        39
-# define         X509_V_ERR_PROXY_CERTIFICATES_NOT_ALLOWED       40
-# define         X509_V_ERR_INVALID_EXTENSION                    41
-# define         X509_V_ERR_INVALID_POLICY_EXTENSION             42
-# define         X509_V_ERR_NO_EXPLICIT_POLICY                   43
-# define         X509_V_ERR_DIFFERENT_CRL_SCOPE                  44
-# define         X509_V_ERR_UNSUPPORTED_EXTENSION_FEATURE        45
-# define         X509_V_ERR_UNNESTED_RESOURCE                    46
-# define         X509_V_ERR_PERMITTED_VIOLATION                  47
-# define         X509_V_ERR_EXCLUDED_VIOLATION                   48
-# define         X509_V_ERR_SUBTREE_MINMAX                       49
+# define X509_V_ERR_SUBJECT_ISSUER_MISMATCH              29
+# define X509_V_ERR_AKID_SKID_MISMATCH                   30
+# define X509_V_ERR_AKID_ISSUER_SERIAL_MISMATCH          31
+# define X509_V_ERR_KEYUSAGE_NO_CERTSIGN                 32
+# define X509_V_ERR_UNABLE_TO_GET_CRL_ISSUER             33
+# define X509_V_ERR_UNHANDLED_CRITICAL_EXTENSION         34
+# define X509_V_ERR_KEYUSAGE_NO_CRL_SIGN                 35
+# define X509_V_ERR_UNHANDLED_CRITICAL_CRL_EXTENSION     36
+# define X509_V_ERR_INVALID_NON_CA                       37
+# define X509_V_ERR_PROXY_PATH_LENGTH_EXCEEDED           38
+# define X509_V_ERR_KEYUSAGE_NO_DIGITAL_SIGNATURE        39
+# define X509_V_ERR_PROXY_CERTIFICATES_NOT_ALLOWED       40
+# define X509_V_ERR_INVALID_EXTENSION                    41
+# define X509_V_ERR_INVALID_POLICY_EXTENSION             42
+# define X509_V_ERR_NO_EXPLICIT_POLICY                   43
+# define X509_V_ERR_DIFFERENT_CRL_SCOPE                  44
+# define X509_V_ERR_UNSUPPORTED_EXTENSION_FEATURE        45
+# define X509_V_ERR_UNNESTED_RESOURCE                    46
+# define X509_V_ERR_PERMITTED_VIOLATION                  47
+# define X509_V_ERR_EXCLUDED_VIOLATION                   48
+# define X509_V_ERR_SUBTREE_MINMAX                       49
 /* The application is not happy */
-# define         X509_V_ERR_APPLICATION_VERIFICATION             50
-# define         X509_V_ERR_UNSUPPORTED_CONSTRAINT_TYPE          51
-# define         X509_V_ERR_UNSUPPORTED_CONSTRAINT_SYNTAX        52
-# define         X509_V_ERR_UNSUPPORTED_NAME_SYNTAX              53
-# define         X509_V_ERR_CRL_PATH_VALIDATION_ERROR            54
+# define X509_V_ERR_APPLICATION_VERIFICATION             50
+# define X509_V_ERR_UNSUPPORTED_CONSTRAINT_TYPE          51
+# define X509_V_ERR_UNSUPPORTED_CONSTRAINT_SYNTAX        52
+# define X509_V_ERR_UNSUPPORTED_NAME_SYNTAX              53
+# define X509_V_ERR_CRL_PATH_VALIDATION_ERROR            54
 /* Another issuer check debug option */
-# define         X509_V_ERR_PATH_LOOP                            55
+# define X509_V_ERR_PATH_LOOP                            55
 /* Suite B mode algorithm violation */
-# define         X509_V_ERR_SUITE_B_INVALID_VERSION              56
-# define         X509_V_ERR_SUITE_B_INVALID_ALGORITHM            57
-# define         X509_V_ERR_SUITE_B_INVALID_CURVE                58
-# define         X509_V_ERR_SUITE_B_INVALID_SIGNATURE_ALGORITHM  59
-# define         X509_V_ERR_SUITE_B_LOS_NOT_ALLOWED              60
-# define         X509_V_ERR_SUITE_B_CANNOT_SIGN_P_384_WITH_P_256 61
+# define X509_V_ERR_SUITE_B_INVALID_VERSION              56
+# define X509_V_ERR_SUITE_B_INVALID_ALGORITHM            57
+# define X509_V_ERR_SUITE_B_INVALID_CURVE                58
+# define X509_V_ERR_SUITE_B_INVALID_SIGNATURE_ALGORITHM  59
+# define X509_V_ERR_SUITE_B_LOS_NOT_ALLOWED              60
+# define X509_V_ERR_SUITE_B_CANNOT_SIGN_P_384_WITH_P_256 61
 /* Host, email and IP check errors */
-# define         X509_V_ERR_HOSTNAME_MISMATCH                    62
-# define         X509_V_ERR_EMAIL_MISMATCH                       63
-# define         X509_V_ERR_IP_ADDRESS_MISMATCH                  64
+# define X509_V_ERR_HOSTNAME_MISMATCH                    62
+# define X509_V_ERR_EMAIL_MISMATCH                       63
+# define X509_V_ERR_IP_ADDRESS_MISMATCH                  64
 /* DANE TLSA errors */
-# define         X509_V_ERR_DANE_NO_MATCH                        65
+# define X509_V_ERR_DANE_NO_MATCH                        65
 /* security level errors */
-# define         X509_V_ERR_EE_KEY_TOO_SMALL                     66
-# define         X509_V_ERR_CA_KEY_TOO_SMALL                     67
-# define         X509_V_ERR_CA_MD_TOO_WEAK                       68
+# define X509_V_ERR_EE_KEY_TOO_SMALL                     66
+# define X509_V_ERR_CA_KEY_TOO_SMALL                     67
+# define X509_V_ERR_CA_MD_TOO_WEAK                       68
 /* Caller error */
-# define         X509_V_ERR_INVALID_CALL                         69
+# define X509_V_ERR_INVALID_CALL                         69
 /* Issuer lookup error */
-# define         X509_V_ERR_STORE_LOOKUP                         70
+# define X509_V_ERR_STORE_LOOKUP                         70
 /* Certificate transparency */
-# define         X509_V_ERR_NO_VALID_SCTS                        71
+# define X509_V_ERR_NO_VALID_SCTS                        71
 
-# define         X509_V_ERR_PROXY_SUBJECT_NAME_VIOLATION         72
+# define X509_V_ERR_PROXY_SUBJECT_NAME_VIOLATION         72
 /* OCSP status errors */
-# define         X509_V_ERR_OCSP_VERIFY_NEEDED                   73  /* Need OCSP verification */
-# define         X509_V_ERR_OCSP_VERIFY_FAILED                   74  /* Couldn't verify cert through OCSP */
-# define         X509_V_ERR_OCSP_CERT_UNKNOWN                    75  /* Certificate wasn't recognized by the OCSP responder */
-
-# define         X509_V_ERR_SIGNATURE_ALGORITHM_MISMATCH         76
-# define         X509_V_ERR_NO_ISSUER_PUBLIC_KEY                 77
-# define         X509_V_ERR_UNSUPPORTED_SIGNATURE_ALGORITHM      78
-
+# define X509_V_ERR_OCSP_VERIFY_NEEDED                   73  /* Need OCSP verification */
+# define X509_V_ERR_OCSP_VERIFY_FAILED                   74  /* Couldn't verify cert through OCSP */
+# define X509_V_ERR_OCSP_CERT_UNKNOWN                    75  /* Certificate wasn't recognized by the OCSP responder */
+
+# define X509_V_ERR_UNSUPPORTED_SIGNATURE_ALGORITHM      76
+# define X509_V_ERR_SIGNATURE_ALGORITHM_MISMATCH         77
+
+/* Errors in case a check in X509_V_FLAG_X509_STRICT mode fails */
+# define X509_V_ERR_SIGNATURE_ALGORITHM_INCONSISTENCY    78
+# define X509_V_ERR_INVALID_CA                           79
+# define X509_V_ERR_PATHLEN_INVALID_FOR_NON_CA           80
+# define X509_V_ERR_PATHLEN_WITHOUT_KU_KEY_CERT_SIGN     81
+# define X509_V_ERR_KU_KEY_CERT_SIGN_INVALID_FOR_NON_CA  82
+# define X509_V_ERR_ISSUER_NAME_EMPTY                    83
+# define X509_V_ERR_SUBJECT_NAME_EMPTY                   84
+# define X509_V_ERR_MISSING_AUTHORITY_KEY_IDENTIFIER     85
+# define X509_V_ERR_MISSING_SUBJECT_KEY_IDENTIFIER       86
+# define X509_V_ERR_EMPTY_SUBJECT_ALT_NAME               87
+# define X509_V_ERR_EMPTY_SUBJECT_SAN_NOT_CRITICAL       88
+# define X509_V_ERR_CA_BCONS_NOT_CRITICAL                89
+# define X509_V_ERR_AUTHORITY_KEY_IDENTIFIER_CRITICAL    90
+# define X509_V_ERR_SUBJECT_KEY_IDENTIFIER_CRITICAL      91
+# define X509_V_ERR_CA_CERT_MISSING_KEY_USAGE            92
+# define X509_V_ERR_EXTENSIONS_REQUIRE_VERSION_3         93
 
 /* Certificate verify flags */
-
 # ifndef OPENSSL_NO_DEPRECATED_1_1_0
 #  define X509_V_FLAG_CB_ISSUER_CHECK             0x0   /* Deprecated */
 # endif
diff --git a/include/openssl/x509err.h b/include/openssl/x509err.h
index 19743b5987..94c5c5b75e 100644
--- a/include/openssl/x509err.h
+++ b/include/openssl/x509err.h
@@ -107,9 +107,12 @@ int ERR_load_X509_strings(void);
 # define X509_R_CERT_ALREADY_IN_HASH_TABLE                101
 # define X509_R_CRL_ALREADY_DELTA                         127
 # define X509_R_CRL_VERIFY_FAILURE                        131
+# define X509_R_ERROR_GETTING_MD_BY_NID                   141
+# define X509_R_ERROR_USING_SIGINF_SET                    142
 # define X509_R_IDP_MISMATCH                              128
 # define X509_R_INVALID_ATTRIBUTES                        138
 # define X509_R_INVALID_DIRECTORY                         113
+# define X509_R_INVALID_DISTPOINT                         143
 # define X509_R_INVALID_FIELD_NAME                        119
 # define X509_R_INVALID_TRUST                             123
 # define X509_R_ISSUER_MISMATCH                           129
@@ -133,6 +136,7 @@ int ERR_load_X509_strings(void);
 # define X509_R_UNKNOWN_KEY_TYPE                          117
 # define X509_R_UNKNOWN_NID                               109
 # define X509_R_UNKNOWN_PURPOSE_ID                        121
+# define X509_R_UNKNOWN_SIGID_ALGS                        144
 # define X509_R_UNKNOWN_TRUST_ID                          120
 # define X509_R_UNSUPPORTED_ALGORITHM                     111
 # define X509_R_WRONG_LOOKUP_TYPE                         112
diff --git a/include/openssl/x509v3.h b/include/openssl/x509v3.h
index 24f5a361d0..a3ef7ced3a 100644
--- a/include/openssl/x509v3.h
+++ b/include/openssl/x509v3.h
@@ -364,8 +364,7 @@ struct ISSUING_DIST_POINT_st {
 # define EXFLAG_NSCERT           0x8
 
 # define EXFLAG_CA               0x10
-/* Really self issued not necessarily self signed */
-# define EXFLAG_SI               0x20
+# define EXFLAG_SI               0x20 /* self-issued, maybe not self-signed */
 # define EXFLAG_V1               0x40
 # define EXFLAG_INVALID          0x80
 /* EXFLAG_SET is set to indicate that some values have been precomputed */
@@ -375,8 +374,12 @@ struct ISSUING_DIST_POINT_st {
 
 # define EXFLAG_INVALID_POLICY   0x800
 # define EXFLAG_FRESHEST         0x1000
-/* Self signed */
-# define EXFLAG_SS               0x2000
+# define EXFLAG_SS               0x2000 /* cert is apparently self-signed */
+
+# define EXFLAG_BCONS_CRITICAL   0x10000
+# define EXFLAG_AKID_CRITICAL    0x20000
+# define EXFLAG_SKID_CRITICAL    0x40000
+# define EXFLAG_SAN_CRITICAL     0x80000
 
 # define KU_DIGITAL_SIGNATURE    0x0080
 # define KU_NON_REPUDIATION      0x0040
diff --git a/include/openssl/x509v3err.h b/include/openssl/x509v3err.h
index d7aa5da6ac..b245a63902 100644
--- a/include/openssl/x509v3err.h
+++ b/include/openssl/x509v3err.h
@@ -107,6 +107,7 @@ int ERR_load_X509V3_strings(void);
 # define X509V3_R_DIRNAME_ERROR                           149
 # define X509V3_R_DISTPOINT_ALREADY_SET                   160
 # define X509V3_R_DUPLICATE_ZONE_ID                       133
+# define X509V3_R_EMPTY_KEY_USAGE                         169
 # define X509V3_R_ERROR_CONVERTING_ZONE                   131
 # define X509V3_R_ERROR_CREATING_EXTENSION                144
 # define X509V3_R_ERROR_IN_EXTENSION                      128
@@ -121,6 +122,7 @@ int ERR_load_X509V3_strings(void);
 # define X509V3_R_INVALID_ASNUMBER                        162
 # define X509V3_R_INVALID_ASRANGE                         163
 # define X509V3_R_INVALID_BOOLEAN_STRING                  104
+# define X509V3_R_INVALID_CERTIFICATE                     158
 # define X509V3_R_INVALID_EXTENSION_STRING                105
 # define X509V3_R_INVALID_INHERITANCE                     165
 # define X509V3_R_INVALID_IPADDRESS                       166
@@ -142,6 +144,7 @@ int ERR_load_X509V3_strings(void);
 # define X509V3_R_ISSUER_DECODE_ERROR                     126
 # define X509V3_R_MISSING_VALUE                           124
 # define X509V3_R_NEED_ORGANIZATION_AND_NUMBERS           142
+# define X509V3_R_NEGATIVE_PATHLEN                        168
 # define X509V3_R_NO_CONFIG_DATABASE                      136
 # define X509V3_R_NO_ISSUER_CERTIFICATE                   121
 # define X509V3_R_NO_ISSUER_DETAILS                       127
diff --git a/test/recipes/25-test_verify.t b/test/recipes/25-test_verify.t
index 42d44dcdce..aaa7fa3d90 100644
--- a/test/recipes/25-test_verify.t
+++ b/test/recipes/25-test_verify.t
@@ -27,7 +27,7 @@ sub verify {
     run(app([@args]));
 }
 
-plan tests =&gt; 144;
+plan tests =&gt; 145;
 
 # Canonical success
 ok(verify(&quot;ee-cert&quot;, &quot;sslserver&quot;, [&quot;root-cert&quot;], [&quot;ca-cert&quot;]),
@@ -372,13 +372,16 @@ ok(verify(&quot;root-cert-rsa2&quot;, &quot;sslserver&quot;, [&quot;root-cert-rsa2&quot;], [], &quot;-check_ss_sig&quot;
        &quot;accept trusted self-signed EE cert excluding key usage keyCertSign&quot;);
 
 SKIP: {
-    skip &quot;Ed25519 is not supported by this OpenSSL build&quot;, 5
+    skip &quot;Ed25519 is not supported by this OpenSSL build&quot;, 6
 	      if disabled(&quot;ec&quot;);
 
     # ED25519 certificate from draft-ietf-curdle-pkix-04
     ok(verify(&quot;ee-ed25519&quot;, &quot;sslserver&quot;, [&quot;root-ed25519&quot;], []),
        &quot;accept X25519 EE cert issued by trusted Ed25519 self-signed CA cert&quot;);
 
+    ok(!verify(&quot;ee-ed25519&quot;, &quot;sslserver&quot;, [&quot;root-ed25519&quot;], [], &quot;-x509_strict&quot;),
+       &quot;reject X25519 EE cert in strict mode since AKID is missing&quot;);
+
     ok(!verify(&quot;root-ed25519&quot;, &quot;sslserver&quot;, [&quot;ee-ed25519&quot;], []),
        &quot;fail Ed25519 CA and EE certs swapped&quot;);
 
diff --git a/test/testx509.pem b/test/testx509.pem
index 8a85d14964..e0c7a1f9af 100644
--- a/test/testx509.pem
+++ b/test/testx509.pem
@@ -1,10 +1,10 @@
 -----BEGIN CERTIFICATE-----
-MIIBWzCCAQYCARgwDQYJKoZIhvcNAQEEBQAwODELMAkGA1UEBhMCQVUxDDAKBgNV
-BAgTA1FMRDEbMBkGA1UEAxMSU1NMZWF5L3JzYSB0ZXN0IENBMB4XDTk1MDYxOTIz
-MzMxMloXDTk1MDcxNzIzMzMxMlowOjELMAkGA1UEBhMCQVUxDDAKBgNVBAgTA1FM
-RDEdMBsGA1UEAxMUU1NMZWF5L3JzYSB0ZXN0IGNlcnQwXDANBgkqhkiG9w0BAQEF
-AANLADBIAkEAqtt6qS5GTxVxGZYWa0/4u+IwHf7p2LNZbcPBp9/OfIcYAXBQn8hO
-/Re1uwLKXdCjIoaGs4DLdG88rkzfyK5dPQIDAQABMAwGCCqGSIb3DQIFBQADQQAE
-Wc7EcF8po2/ZO6kNCwK/ICH6DobgLekA5lSLr5EvuioZniZp5lFzAw4+YzPQ7XKJ
-zl9HYIMxATFyqSiD9jsx
+MIIBczCCAR0CFEqkMs9xq0qfdNflIpoqdDaOU/ThMA0GCSqGSIb3DQEBBAUAMDox
+CzAJBgNVBAYTAkFVMQwwCgYDVQQIDANRTEQxHTAbBgNVBAMMFFNTTGVheSByc2Eg
+dGVzdCBjZXJ0MCAXDTIwMDczMTE3MTM0NVoYDzIxMjAwNzA3MTcxMzQ1WjA6MQsw
+CQYDVQQGEwJBVTEMMAoGA1UECAwDUUxEMR0wGwYDVQQDDBRTU0xlYXkgcnNhIHRl
+c3QgY2VydDBcMA0GCSqGSIb3DQEBAQUAA0sAMEgCQQDUZKgYSMuJdiw2aIQIG4LD
+vm9HbUnyJyj6WgPkpw98dVKTj0jo3F6n/e3anYzvSpOiPkTuvw209yslzJs40Sf7
+AgMBAAEwDQYJKoZIhvcNAQEEBQADQQBV1bQAvyLvJQrNt7WEKmo/inigwjsvQYwd
+nxmV6zWhqpQZmo86/ixumUa6zTlq+y4+wiiFngMZ7Bt0O769Nlzx
 -----END CERTIFICATE-----
</PRE>























<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="030593.html">[openssl]  master update
</A></li>
	<LI>Next message: <A HREF="030607.html">[openssl]  master update
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#30600">[ date ]</a>
              <a href="thread.html#30600">[ thread ]</a>
              <a href="subject.html#30600">[ subject ]</a>
              <a href="author.html#30600">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="../../../mailman/listinfo/openssl-commits.html">More information about the openssl-commits
mailing list</a><br>
</body></html>
