<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [openssl]  master update
   </TITLE>
   <LINK REL="Index" HREF="https://mta.openssl.org/pipermail/openssl-commits/2021-September/index.html" >
   <LINK REL="made" HREF="mailto:openssl-commits%40openssl.org?Subject=Re%3A%20%5Bopenssl%5D%20%20master%20update&In-Reply-To=%3C1632816619.508952.31725.nullmailer%40dev.openssl.org%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="035377.html">
   <LINK REL="Next"  HREF="035380.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[openssl]  master update</H1>
    <B>Dr. Paul Dale</B> 
    <A HREF="mailto:openssl-commits%40openssl.org?Subject=Re%3A%20%5Bopenssl%5D%20%20master%20update&In-Reply-To=%3C1632816619.508952.31725.nullmailer%40dev.openssl.org%3E"
       TITLE="[openssl]  master update">pauli at openssl.org
       </A><BR>
    <I>Tue Sep 28 08:10:19 UTC 2021</I>
    <P><UL>
        <LI>Previous message: <A HREF="035377.html">[openssl]  master update
</A></li>
        <LI>Next message: <A HREF="035380.html">[openssl]  master update
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#35379">[ date ]</a>
              <a href="thread.html#35379">[ thread ]</a>
              <a href="subject.html#35379">[ subject ]</a>
              <a href="author.html#35379">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>The branch master has been updated
       via  2d34e5b2ecf6a5db982c53bb56c62249b7791051 (commit)
       via  c8ffd2201b8685e149dd3244d6772339263d4a17 (commit)
       via  5fae7b432e3e2e14916bdcd1ad0fe594a27628c6 (commit)
       via  4eb27149f066d567393771986f01267707982a7e (commit)
       via  4667b0f0731a8bb8d6236ea18b8c0591016f53d7 (commit)
       via  fc9eda53bcf7d41c8159b7161c663db86dda5481 (commit)
       via  1ffac6ca174d25a61f2e1e70dd0fd1eb7eaacbf5 (commit)
       via  722fe8edf224ecc0921481b47fdd06a54d82e4ff (commit)
      from  8ba65c35ea3af347c3b2adc8e665066b541a1c35 (commit)


- Log -----------------------------------------------------------------
commit 2d34e5b2ecf6a5db982c53bb56c62249b7791051
Author: Pauli &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">pauli at openssl.org</A>&gt;
Date:   Mon Sep 27 09:20:20 2021 +1000

    test: add some PVK KDF unit test cases
    
    These cases were generated using OpenSSL.
    
    Reviewed-by: Tomas Mraz &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">tomas at openssl.org</A>&gt;
    (Merged from <A HREF="https://github.com/openssl/openssl/pull/15968">https://github.com/openssl/openssl/pull/15968</A>)

commit c8ffd2201b8685e149dd3244d6772339263d4a17
Author: Pauli &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">pauli at openssl.org</A>&gt;
Date:   Mon Sep 27 09:06:01 2021 +1000

    changes: note that PVK KDF has moved to the legacy provider
    
    Reviewed-by: Tomas Mraz &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">tomas at openssl.org</A>&gt;
    (Merged from <A HREF="https://github.com/openssl/openssl/pull/15968">https://github.com/openssl/openssl/pull/15968</A>)

commit 5fae7b432e3e2e14916bdcd1ad0fe594a27628c6
Author: Pauli &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">pauli at openssl.org</A>&gt;
Date:   Mon Sep 27 09:05:32 2021 +1000

    doc: note that these KDFs require the legacy provider to be available
    
    Reviewed-by: Tomas Mraz &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">tomas at openssl.org</A>&gt;
    (Merged from <A HREF="https://github.com/openssl/openssl/pull/15968">https://github.com/openssl/openssl/pull/15968</A>)

commit 4eb27149f066d567393771986f01267707982a7e
Author: Pauli &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">pauli at openssl.org</A>&gt;
Date:   Thu Jul 1 14:48:49 2021 +1000

    doc: include PVK KDFdocumentation in build.info
    
    Reviewed-by: Tomas Mraz &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">tomas at openssl.org</A>&gt;
    (Merged from <A HREF="https://github.com/openssl/openssl/pull/15968">https://github.com/openssl/openssl/pull/15968</A>)

commit 4667b0f0731a8bb8d6236ea18b8c0591016f53d7
Author: Pauli &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">pauli at openssl.org</A>&gt;
Date:   Thu Jul 1 14:40:44 2021 +1000

    include PVK KDF in legacy provider algorithm list
    
    Reviewed-by: Tomas Mraz &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">tomas at openssl.org</A>&gt;
    (Merged from <A HREF="https://github.com/openssl/openssl/pull/15968">https://github.com/openssl/openssl/pull/15968</A>)

commit fc9eda53bcf7d41c8159b7161c663db86dda5481
Author: Pauli &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">pauli at openssl.org</A>&gt;
Date:   Thu Jul 1 14:40:27 2021 +1000

    doc: add page for PVK KDF
    
    Reviewed-by: Tomas Mraz &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">tomas at openssl.org</A>&gt;
    (Merged from <A HREF="https://github.com/openssl/openssl/pull/15968">https://github.com/openssl/openssl/pull/15968</A>)

commit 1ffac6ca174d25a61f2e1e70dd0fd1eb7eaacbf5
Author: Pauli &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">pauli at openssl.org</A>&gt;
Date:   Thu Jul 1 14:11:17 2021 +1000

    pvk: use PVK KDF
    
    Reviewed-by: Tomas Mraz &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">tomas at openssl.org</A>&gt;
    (Merged from <A HREF="https://github.com/openssl/openssl/pull/15968">https://github.com/openssl/openssl/pull/15968</A>)

commit 722fe8edf224ecc0921481b47fdd06a54d82e4ff
Author: Pauli &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">pauli at openssl.org</A>&gt;
Date:   Thu Jul 1 14:10:04 2021 +1000

    kdf: Add PVK KDF to providers.
    
    Add PIN Verification Key key derevation function to providers.
    
    Reviewed-by: Tomas Mraz &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">tomas at openssl.org</A>&gt;
    (Merged from <A HREF="https://github.com/openssl/openssl/pull/15968">https://github.com/openssl/openssl/pull/15968</A>)

-----------------------------------------------------------------------

Summary of changes:
 CHANGES.md                                         |   6 +
 crypto/pem/pvkfmt.c                                |  45 ++--
 doc/build.info                                     |   6 +
 doc/man7/EVP_KDF-PBKDF1.pod                        |   5 +-
 .../{EVP_KDF-PBKDF1.pod =&gt; EVP_KDF-PVKKDF.pod}     |  29 +--
 doc/man7/OSSL_PROVIDER-legacy.pod                  |   2 +
 .../implementations/include/prov/implementations.h |   1 +
 providers/implementations/include/prov/names.h     |   1 +
 providers/implementations/kdfs/build.info          |   3 +
 providers/implementations/kdfs/pvkkdf.c            | 227 +++++++++++++++++++++
 providers/legacyprov.c                             |   1 +
 test/recipes/30-test_evp_data/evpkdf_pvkkdf.txt    |  36 ++++
 12 files changed, 322 insertions(+), 40 deletions(-)
 copy doc/man7/{EVP_KDF-PBKDF1.pod =&gt; EVP_KDF-PVKKDF.pod} (59%)
 create mode 100644 providers/implementations/kdfs/pvkkdf.c
 create mode 100644 test/recipes/30-test_evp_data/evpkdf_pvkkdf.txt

diff --git a/CHANGES.md b/CHANGES.md
index dc3008f814..c14bec916d 100644
--- a/CHANGES.md
+++ b/CHANGES.md
@@ -24,6 +24,12 @@ OpenSSL 3.1
 
 ### Changes between 3.0 and 3.1 [xx XXX xxxx]
 
+ * The PVK key derivation function has been moved from b2i_PVK_bio_ex() into
+   the legacy crypto provider as an EVP_KDF. Applications requiring this KDF
+   will need to load the legacy crypto provider.
+
+   *Paul Dale*
+
  * The various OBJ_* functions have been made thread safe.
 
    *Paul Dale*
diff --git a/crypto/pem/pvkfmt.c b/crypto/pem/pvkfmt.c
index 11ac0a7c40..6f5207abd1 100644
--- a/crypto/pem/pvkfmt.c
+++ b/crypto/pem/pvkfmt.c
@@ -23,6 +23,8 @@
 #include &lt;openssl/bn.h&gt;
 #include &lt;openssl/dsa.h&gt;
 #include &lt;openssl/rsa.h&gt;
+#include &lt;openssl/kdf.h&gt;
+#include &lt;openssl/core_names.h&gt;
 #include &quot;internal/cryptlib.h&quot;
 #include &quot;crypto/pem.h&quot;
 #include &quot;crypto/evp.h&quot;
@@ -790,29 +792,34 @@ int ossl_do_PVK_header(const unsigned char **in, unsigned int length,
 }
 
 #ifndef OPENSSL_NO_RC4
-static int derive_pvk_key(unsigned char *key,
+static int derive_pvk_key(unsigned char *key, size_t keylen,
                           const unsigned char *salt, unsigned int saltlen,
                           const unsigned char *pass, int passlen,
                           OSSL_LIB_CTX *libctx, const char *propq)
 {
-    EVP_MD_CTX *mctx = EVP_MD_CTX_new();
-    int rv = 0;
-    EVP_MD *sha1 = NULL;
+    EVP_KDF *kdf;
+    EVP_KDF_CTX *ctx;
+    OSSL_PARAM params[5], *p = params;
+    int rv;
 
-    if ((sha1 = EVP_MD_fetch(libctx, SN_sha1, propq)) == NULL)
-        goto err;
-
-    if (mctx == NULL
-        || !EVP_DigestInit_ex(mctx, sha1, NULL)
-        || !EVP_DigestUpdate(mctx, salt, saltlen)
-        || !EVP_DigestUpdate(mctx, pass, passlen)
-        || !EVP_DigestFinal_ex(mctx, key, NULL))
-        goto err;
+    if ((kdf = EVP_KDF_fetch(libctx, &quot;PVKKDF&quot;, propq)) == NULL)
+        return 0;
+    ctx = EVP_KDF_CTX_new(kdf);
+    EVP_KDF_free(kdf);
+    if (ctx == NULL)
+        return 0;
 
-    rv = 1;
-err:
-    EVP_MD_CTX_free(mctx);
-    EVP_MD_free(sha1);
+    *p++ = OSSL_PARAM_construct_octet_string(OSSL_KDF_PARAM_SALT,
+                                             (void *)salt, saltlen);
+    *p++ = OSSL_PARAM_construct_octet_string(OSSL_KDF_PARAM_PASSWORD,
+                                             (void *)pass, passlen);
+    *p++ = OSSL_PARAM_construct_utf8_string(OSSL_KDF_PARAM_DIGEST, SN_sha1, 0);
+    *p++ = OSSL_PARAM_construct_utf8_string(OSSL_KDF_PARAM_PROPERTIES,
+                                            (char *)propq, 0);
+    *p = OSSL_PARAM_construct_end();
+
+    rv = EVP_KDF_derive(ctx, key, keylen, params);
+    EVP_KDF_CTX_free(ctx);
     return rv;
 }
 #endif
@@ -852,7 +859,7 @@ static void *do_PVK_body_key(const unsigned char **in,
             ERR_raise(ERR_LIB_PEM, ERR_R_MALLOC_FAILURE);
             goto err;
         }
-        if (!derive_pvk_key(keybuf, p, saltlen,
+        if (!derive_pvk_key(keybuf, sizeof(keybuf), p, saltlen,
                             (unsigned char *)psbuf, inlen, libctx, propq))
             goto err;
         p += saltlen;
@@ -1058,7 +1065,7 @@ static int i2b_PVK(unsigned char **out, const EVP_PKEY *pk, int enclevel,
             ERR_raise(ERR_LIB_PEM, PEM_R_BAD_PASSWORD_READ);
             goto error;
         }
-        if (!derive_pvk_key(keybuf, salt, PVK_SALTLEN,
+        if (!derive_pvk_key(keybuf, sizeof(keybuf), salt, PVK_SALTLEN,
                             (unsigned char *)psbuf, inlen, libctx, propq))
             goto error;
         if ((rc4 = EVP_CIPHER_fetch(libctx, &quot;RC4&quot;, propq)) == NULL)
diff --git a/doc/build.info b/doc/build.info
index fcf2c1cacf..5f446e3868 100644
--- a/doc/build.info
+++ b/doc/build.info
@@ -4119,6 +4119,10 @@ DEPEND[html/man7/EVP_KDF-PKCS12KDF.html]=man7/EVP_KDF-PKCS12KDF.pod
 GENERATE[html/man7/EVP_KDF-PKCS12KDF.html]=man7/EVP_KDF-PKCS12KDF.pod
 DEPEND[man/man7/EVP_KDF-PKCS12KDF.7]=man7/EVP_KDF-PKCS12KDF.pod
 GENERATE[man/man7/EVP_KDF-PKCS12KDF.7]=man7/EVP_KDF-PKCS12KDF.pod
+DEPEND[html/man7/EVP_KDF-PVKKDF.html]=man7/EVP_KDF-PVKKDF.pod
+GENERATE[html/man7/EVP_KDF-PVKKDF.html]=man7/EVP_KDF-PVKKDF.pod
+DEPEND[man/man7/EVP_KDF-PVKKDF.7]=man7/EVP_KDF-PVKKDF.pod
+GENERATE[man/man7/EVP_KDF-PVKKDF.7]=man7/EVP_KDF-PVKKDF.pod
 DEPEND[html/man7/EVP_KDF-SCRYPT.html]=man7/EVP_KDF-SCRYPT.pod
 GENERATE[html/man7/EVP_KDF-SCRYPT.html]=man7/EVP_KDF-SCRYPT.pod
 DEPEND[man/man7/EVP_KDF-SCRYPT.7]=man7/EVP_KDF-SCRYPT.pod
@@ -4563,6 +4567,7 @@ html/man7/EVP_KDF-KRB5KDF.html \
 html/man7/EVP_KDF-PBKDF1.html \
 html/man7/EVP_KDF-PBKDF2.html \
 html/man7/EVP_KDF-PKCS12KDF.html \
+html/man7/EVP_KDF-PVKKDF.html \
 html/man7/EVP_KDF-SCRYPT.html \
 html/man7/EVP_KDF-SS.html \
 html/man7/EVP_KDF-SSHKDF.html \
@@ -4687,6 +4692,7 @@ man/man7/EVP_KDF-KRB5KDF.7 \
 man/man7/EVP_KDF-PBKDF1.7 \
 man/man7/EVP_KDF-PBKDF2.7 \
 man/man7/EVP_KDF-PKCS12KDF.7 \
+man/man7/EVP_KDF-PVKKDF.7 \
 man/man7/EVP_KDF-SCRYPT.7 \
 man/man7/EVP_KDF-SS.7 \
 man/man7/EVP_KDF-SSHKDF.7 \
diff --git a/doc/man7/EVP_KDF-PBKDF1.pod b/doc/man7/EVP_KDF-PBKDF1.pod
index ae13765211..0d24325cd9 100644
--- a/doc/man7/EVP_KDF-PBKDF1.pod
+++ b/doc/man7/EVP_KDF-PBKDF1.pod
@@ -53,6 +53,8 @@ of candidate passwords.
 No assumption is made regarding the given password; it is simply treated as a
 byte sequence.
 
+The legacy provider needs to be available in order to access this algorithm.
+
 =head1 CONFORMING TO
 
 RFC 8018
@@ -64,7 +66,8 @@ L&lt;EVP_KDF_CTX_new(3)&gt;,
 L&lt;EVP_KDF_CTX_free(3)&gt;,
 L&lt;EVP_KDF_CTX_set_params(3)&gt;,
 L&lt;EVP_KDF_derive(3)&gt;,
-L&lt;EVP_KDF(3)/PARAMETERS&gt;
+L&lt;EVP_KDF(3)/PARAMETERS&gt;,
+L&lt;OSSL_PROVIDER-legacy(7)&gt;
 
 =head1 HISTORY
 
diff --git a/doc/man7/EVP_KDF-PBKDF1.pod b/doc/man7/EVP_KDF-PVKKDF.pod
similarity index 59%
copy from doc/man7/EVP_KDF-PBKDF1.pod
copy to doc/man7/EVP_KDF-PVKKDF.pod
index ae13765211..08aff0c9e7 100644
--- a/doc/man7/EVP_KDF-PBKDF1.pod
+++ b/doc/man7/EVP_KDF-PVKKDF.pod
@@ -2,20 +2,19 @@
 
 =head1 NAME
 
-EVP_KDF-PBKDF1 - The PBKDF1 EVP_KDF implementation
+EVP_KDF-PVKKDF - The PVK EVP_KDF implementation
 
 =head1 DESCRIPTION
 
-Support for computing the B&lt;PBKDF1&gt; password-based KDF through the B&lt;EVP_KDF&gt;
+Support for computing the B&lt;PVK KDF&gt; PIN-based KDF through the B&lt;EVP_KDF&gt;
 API.
 
-The EVP_KDF-PBKDF1 algorithm implements the PBKDF1 password-based key
-derivation function, as described in RFC 8018; it derives a key from a password
-using a salt and iteration count.
+The EVP_KDF-PVKKDF algorithm implements a PVK PIN-based key
+derivation function; it derives a key from a password using a salt.
 
 =head2 Identity
 
-&quot;PBKDF1&quot; is the name for this implementation; it
+&quot;PVKKDF&quot; is the name for this implementation; it
 can be used with the EVP_KDF_fetch() function.
 
 =head2 Supported parameters
@@ -28,10 +27,6 @@ The supported parameters are:
 
 =item &quot;salt&quot; (B&lt;OSSL_KDF_PARAM_SALT&gt;) &lt;octet string&gt;
 
-=item &quot;iter&quot; (B&lt;OSSL_KDF_PARAM_ITER&gt;) &lt;unsigned integer&gt;
-
-This parameter has a default value of 0 and should be set.
-
 =item &quot;properties&quot; (B&lt;OSSL_KDF_PARAM_PROPERTIES&gt;) &lt;UTF8 string&gt;
 
 =item &quot;digest&quot; (B&lt;OSSL_KDF_PARAM_DIGEST&gt;) &lt;UTF8 string&gt;
@@ -43,19 +38,12 @@ These parameters work as described in L&lt;EVP_KDF(3)/PARAMETERS&gt;.
 =head1 NOTES
 
 A typical application of this algorithm is to derive keying material for an
-encryption algorithm from a password in the &quot;pass&quot;, a salt in &quot;salt&quot;,
-and an iteration count.
-
-Increasing the &quot;iter&quot; parameter slows down the algorithm which makes it
-harder for an attacker to perform a brute force attack using a large number
-of candidate passwords.
+encryption algorithm from a password in the &quot;pass&quot; and a salt in &quot;salt&quot;.
 
 No assumption is made regarding the given password; it is simply treated as a
 byte sequence.
 
-=head1 CONFORMING TO
-
-RFC 8018
+The legacy provider needs to be available in order to access this algorithm.
 
 =head1 SEE ALSO
 
@@ -64,7 +52,8 @@ L&lt;EVP_KDF_CTX_new(3)&gt;,
 L&lt;EVP_KDF_CTX_free(3)&gt;,
 L&lt;EVP_KDF_CTX_set_params(3)&gt;,
 L&lt;EVP_KDF_derive(3)&gt;,
-L&lt;EVP_KDF(3)/PARAMETERS&gt;
+L&lt;EVP_KDF(3)/PARAMETERS&gt;,
+L&lt;OSSL_PROVIDER-legacy(7)&gt;
 
 =head1 HISTORY
 
diff --git a/doc/man7/OSSL_PROVIDER-legacy.pod b/doc/man7/OSSL_PROVIDER-legacy.pod
index d2fdfe3676..5724996fdc 100644
--- a/doc/man7/OSSL_PROVIDER-legacy.pod
+++ b/doc/man7/OSSL_PROVIDER-legacy.pod
@@ -87,6 +87,8 @@ Disabled by default. Use I&lt;enable-rc5&gt; config option to enable.
 
 =item PBKDF1
 
+=item PVKKDF
+
 =back
 
 =begin comment
diff --git a/providers/implementations/include/prov/implementations.h b/providers/implementations/include/prov/implementations.h
index e2573ebb4a..66817fa104 100644
--- a/providers/implementations/include/prov/implementations.h
+++ b/providers/implementations/include/prov/implementations.h
@@ -258,6 +258,7 @@ extern const OSSL_DISPATCH ossl_poly1305_functions[];
 /* KDFs / PRFs */
 extern const OSSL_DISPATCH ossl_kdf_pbkdf1_functions[];
 extern const OSSL_DISPATCH ossl_kdf_pbkdf2_functions[];
+extern const OSSL_DISPATCH ossl_kdf_pvk_functions[];
 extern const OSSL_DISPATCH ossl_kdf_pkcs12_functions[];
 #ifndef OPENSSL_NO_SCRYPT
 extern const OSSL_DISPATCH ossl_kdf_scrypt_functions[];
diff --git a/providers/implementations/include/prov/names.h b/providers/implementations/include/prov/names.h
index 1509598ffc..62aa7bd725 100644
--- a/providers/implementations/include/prov/names.h
+++ b/providers/implementations/include/prov/names.h
@@ -261,6 +261,7 @@
 #define PROV_NAMES_SSKDF &quot;SSKDF&quot;
 #define PROV_NAMES_PBKDF1 &quot;PBKDF1&quot;
 #define PROV_NAMES_PBKDF2 &quot;PBKDF2:1.2.840.113549.1.5.12&quot;
+#define PROV_NAMES_PVKKDF &quot;PVKKDF&quot;
 #define PROV_NAMES_SSHKDF &quot;SSHKDF&quot;
 #define PROV_NAMES_X963KDF &quot;X963KDF:X942KDF-CONCAT&quot;
 #define PROV_NAMES_X942KDF_ASN1 &quot;X942KDF-ASN1:X942KDF&quot;
diff --git a/providers/implementations/kdfs/build.info b/providers/implementations/kdfs/build.info
index f4620adce2..ddc3eabca2 100644
--- a/providers/implementations/kdfs/build.info
+++ b/providers/implementations/kdfs/build.info
@@ -7,6 +7,7 @@ $KBKDF_GOAL=../../libdefault.a ../../libfips.a
 $KRB5KDF_GOAL=../../libdefault.a
 $PBKDF1_GOAL=../../liblegacy.a
 $PBKDF2_GOAL=../../libdefault.a ../../libfips.a
+$PVKKDF_GOAL=../../liblegacy.a
 $PKCS12KDF_GOAL=../../libdefault.a
 $SSKDF_GOAL=../../libdefault.a ../../libfips.a
 $SCRYPT_GOAL=../../libdefault.a
@@ -28,6 +29,8 @@ SOURCE[$PBKDF2_GOAL]=pbkdf2.c
 # When the PBKDF2 moves to legacy, this can be removed.
 SOURCE[$PBKDF2_GOAL]=pbkdf2_fips.c
 
+SOURCE[$PBKDF1_GOAL]=pvkkdf.c
+
 SOURCE[$PKCS12KDF_GOAL]=pkcs12kdf.c
 
 SOURCE[$SSKDF_GOAL]=sskdf.c
diff --git a/providers/implementations/kdfs/pvkkdf.c b/providers/implementations/kdfs/pvkkdf.c
new file mode 100644
index 0000000000..2dad6309b9
--- /dev/null
+++ b/providers/implementations/kdfs/pvkkdf.c
@@ -0,0 +1,227 @@
+/*
+ * Copyright 2018-2021 The OpenSSL Project Authors. All Rights Reserved.
+ *
+ * Licensed under the Apache License 2.0 (the &quot;License&quot;).  You may not use
+ * this file except in compliance with the License.  You can obtain a copy
+ * in the file LICENSE in the source distribution or at
+ * <A HREF="https://www.openssl.org/source/license.html">https://www.openssl.org/source/license.html</A>
+ */
+
+#include &lt;openssl/evp.h&gt;
+#include &lt;openssl/core_names.h&gt;
+#include &lt;openssl/proverr.h&gt;
+#include &lt;openssl/err.h&gt;
+#include &quot;prov/provider_ctx.h&quot;
+#include &quot;prov/providercommon.h&quot;
+#include &quot;prov/implementations.h&quot;
+#include &quot;prov/provider_util.h&quot;
+
+static OSSL_FUNC_kdf_newctx_fn kdf_pvk_new;
+static OSSL_FUNC_kdf_freectx_fn kdf_pvk_free;
+static OSSL_FUNC_kdf_reset_fn kdf_pvk_reset;
+static OSSL_FUNC_kdf_derive_fn kdf_pvk_derive;
+static OSSL_FUNC_kdf_settable_ctx_params_fn kdf_pvk_settable_ctx_params;
+static OSSL_FUNC_kdf_set_ctx_params_fn kdf_pvk_set_ctx_params;
+static OSSL_FUNC_kdf_gettable_ctx_params_fn kdf_pvk_gettable_ctx_params;
+static OSSL_FUNC_kdf_get_ctx_params_fn kdf_pvk_get_ctx_params;
+
+typedef struct {
+    void *provctx;
+    unsigned char *pass;
+    size_t pass_len;
+    unsigned char *salt;
+    size_t salt_len;
+    PROV_DIGEST digest;
+} KDF_PVK;
+
+static void kdf_pvk_init(KDF_PVK *ctx);
+
+static void *kdf_pvk_new(void *provctx)
+{
+    KDF_PVK *ctx;
+
+    if (!ossl_prov_is_running())
+        return NULL;
+
+    ctx = OPENSSL_zalloc(sizeof(*ctx));
+    if (ctx == NULL) {
+        ERR_raise(ERR_LIB_PROV, ERR_R_MALLOC_FAILURE);
+        return NULL;
+    }
+    ctx-&gt;provctx = provctx;
+    kdf_pvk_init(ctx);
+    return ctx;
+}
+
+static void kdf_pvk_cleanup(KDF_PVK *ctx)
+{
+    ossl_prov_digest_reset(&amp;ctx-&gt;digest);
+    OPENSSL_free(ctx-&gt;salt);
+    OPENSSL_clear_free(ctx-&gt;pass, ctx-&gt;pass_len);
+    OPENSSL_cleanse(ctx, sizeof(*ctx));
+}
+
+static void kdf_pvk_free(void *vctx)
+{
+    KDF_PVK *ctx = (KDF_PVK *)vctx;
+
+    if (ctx != NULL) {
+        kdf_pvk_cleanup(ctx);
+        OPENSSL_free(ctx);
+    }
+}
+
+static void kdf_pvk_reset(void *vctx)
+{
+    KDF_PVK *ctx = (KDF_PVK *)vctx;
+    void *provctx = ctx-&gt;provctx;
+
+    kdf_pvk_cleanup(ctx);
+    ctx-&gt;provctx = provctx;
+    kdf_pvk_init(ctx);
+}
+
+static void kdf_pvk_init(KDF_PVK *ctx)
+{
+    OSSL_PARAM params[2] = { OSSL_PARAM_END, OSSL_PARAM_END };
+    OSSL_LIB_CTX *provctx = PROV_LIBCTX_OF(ctx-&gt;provctx);
+
+    params[0] = OSSL_PARAM_construct_utf8_string(OSSL_KDF_PARAM_DIGEST,
+                                                 SN_sha1, 0);
+    if (!ossl_prov_digest_load_from_params(&amp;ctx-&gt;digest, params, provctx))
+        /* This is an error, but there is no way to indicate such directly */
+        ossl_prov_digest_reset(&amp;ctx-&gt;digest);
+}
+
+static int pvk_set_membuf(unsigned char **buffer, size_t *buflen,
+                             const OSSL_PARAM *p)
+{
+    OPENSSL_clear_free(*buffer, *buflen);
+    if (p-&gt;data_size == 0) {
+        if ((*buffer = OPENSSL_malloc(1)) == NULL) {
+            ERR_raise(ERR_LIB_PROV, ERR_R_MALLOC_FAILURE);
+            return 0;
+        }
+    } else if (p-&gt;data != NULL) {
+        *buffer = NULL;
+        if (!OSSL_PARAM_get_octet_string(p, (void **)buffer, 0, buflen))
+            return 0;
+    }
+    return 1;
+}
+
+static int kdf_pvk_derive(void *vctx, unsigned char *key, size_t keylen,
+                             const OSSL_PARAM params[])
+{
+    KDF_PVK *ctx = (KDF_PVK *)vctx;
+    const EVP_MD *md;
+    EVP_MD_CTX *mctx;
+    int res;
+
+    if (!ossl_prov_is_running() || !kdf_pvk_set_ctx_params(ctx, params))
+        return 0;
+
+    if (ctx-&gt;pass == NULL) {
+        ERR_raise(ERR_LIB_PROV, PROV_R_MISSING_PASS);
+        return 0;
+    }
+
+    if (ctx-&gt;salt == NULL) {
+        ERR_raise(ERR_LIB_PROV, PROV_R_MISSING_SALT);
+        return 0;
+    }
+
+    md = ossl_prov_digest_md(&amp;ctx-&gt;digest);
+    if (md == NULL) {
+        ERR_raise(ERR_LIB_PROV, PROV_R_INVALID_DIGEST);
+        return 0;
+    }
+    res = EVP_MD_get_size(md);
+    if (res &lt;= 0) {
+        ERR_raise(ERR_LIB_PROV, PROV_R_BAD_LENGTH);
+        return 0;
+    }
+    if ((size_t)res &gt; keylen) {
+        ERR_raise(ERR_LIB_PROV, PROV_R_LENGTH_TOO_LARGE);
+        return 0;
+    }
+
+    mctx = EVP_MD_CTX_new();
+    res = mctx != NULL
+          &amp;&amp; EVP_DigestInit_ex(mctx, md, NULL)
+          &amp;&amp; EVP_DigestUpdate(mctx, ctx-&gt;salt, ctx-&gt;salt_len)
+          &amp;&amp; EVP_DigestUpdate(mctx, ctx-&gt;pass, ctx-&gt;pass_len)
+          &amp;&amp; EVP_DigestFinal_ex(mctx, key, NULL);
+    EVP_MD_CTX_free(mctx);
+    return res;
+}
+
+static int kdf_pvk_set_ctx_params(void *vctx, const OSSL_PARAM params[])
+{
+    const OSSL_PARAM *p;
+    KDF_PVK *ctx = vctx;
+    OSSL_LIB_CTX *provctx = PROV_LIBCTX_OF(ctx-&gt;provctx);
+
+    if (params == NULL)
+        return 1;
+
+    if (!ossl_prov_digest_load_from_params(&amp;ctx-&gt;digest, params, provctx))
+        return 0;
+
+    if ((p = OSSL_PARAM_locate_const(params, OSSL_KDF_PARAM_PASSWORD)) != NULL)
+        if (!pvk_set_membuf(&amp;ctx-&gt;pass, &amp;ctx-&gt;pass_len, p))
+            return 0;
+
+    if ((p = OSSL_PARAM_locate_const(params, OSSL_KDF_PARAM_SALT)) != NULL) {
+        if (!pvk_set_membuf(&amp;ctx-&gt;salt, &amp;ctx-&gt;salt_len,p))
+            return 0;
+    }
+
+    return 1;
+}
+
+static const OSSL_PARAM *kdf_pvk_settable_ctx_params(ossl_unused void *ctx,
+                                                        ossl_unused void *p_ctx)
+{
+    static const OSSL_PARAM known_settable_ctx_params[] = {
+        OSSL_PARAM_utf8_string(OSSL_KDF_PARAM_PROPERTIES, NULL, 0),
+        OSSL_PARAM_utf8_string(OSSL_KDF_PARAM_DIGEST, NULL, 0),
+        OSSL_PARAM_octet_string(OSSL_KDF_PARAM_PASSWORD, NULL, 0),
+        OSSL_PARAM_octet_string(OSSL_KDF_PARAM_SALT, NULL, 0),
+        OSSL_PARAM_END
+    };
+    return known_settable_ctx_params;
+}
+
+static int kdf_pvk_get_ctx_params(void *vctx, OSSL_PARAM params[])
+{
+    OSSL_PARAM *p;
+
+    if ((p = OSSL_PARAM_locate(params, OSSL_KDF_PARAM_SIZE)) != NULL)
+        return OSSL_PARAM_set_size_t(p, SIZE_MAX);
+    return -2;
+}
+
+static const OSSL_PARAM *kdf_pvk_gettable_ctx_params(ossl_unused void *ctx,
+                                                        ossl_unused void *p_ctx)
+{
+    static const OSSL_PARAM known_gettable_ctx_params[] = {
+        OSSL_PARAM_size_t(OSSL_KDF_PARAM_SIZE, NULL),
+        OSSL_PARAM_END
+    };
+    return known_gettable_ctx_params;
+}
+
+const OSSL_DISPATCH ossl_kdf_pvk_functions[] = {
+    { OSSL_FUNC_KDF_NEWCTX, (void(*)(void))kdf_pvk_new },
+    { OSSL_FUNC_KDF_FREECTX, (void(*)(void))kdf_pvk_free },
+    { OSSL_FUNC_KDF_RESET, (void(*)(void))kdf_pvk_reset },
+    { OSSL_FUNC_KDF_DERIVE, (void(*)(void))kdf_pvk_derive },
+    { OSSL_FUNC_KDF_SETTABLE_CTX_PARAMS,
+      (void(*)(void))kdf_pvk_settable_ctx_params },
+    { OSSL_FUNC_KDF_SET_CTX_PARAMS, (void(*)(void))kdf_pvk_set_ctx_params },
+    { OSSL_FUNC_KDF_GETTABLE_CTX_PARAMS,
+      (void(*)(void))kdf_pvk_gettable_ctx_params },
+    { OSSL_FUNC_KDF_GET_CTX_PARAMS, (void(*)(void))kdf_pvk_get_ctx_params },
+    { 0, NULL }
+};
diff --git a/providers/legacyprov.c b/providers/legacyprov.c
index a5999c5f8b..93c4223a15 100644
--- a/providers/legacyprov.c
+++ b/providers/legacyprov.c
@@ -145,6 +145,7 @@ static const OSSL_ALGORITHM legacy_ciphers[] = {
 
 static const OSSL_ALGORITHM legacy_kdfs[] = {
     ALG(PROV_NAMES_PBKDF1, ossl_kdf_pbkdf1_functions),
+    ALG(PROV_NAMES_PVKKDF, ossl_kdf_pvk_functions),
     { NULL, NULL, NULL }
 };
 
diff --git a/test/recipes/30-test_evp_data/evpkdf_pvkkdf.txt b/test/recipes/30-test_evp_data/evpkdf_pvkkdf.txt
new file mode 100644
index 0000000000..46ebec4ab2
--- /dev/null
+++ b/test/recipes/30-test_evp_data/evpkdf_pvkkdf.txt
@@ -0,0 +1,36 @@
+#
+# Copyright 2021 The OpenSSL Project Authors. All Rights Reserved.
+#
+# Licensed under the Apache License 2.0 (the &quot;License&quot;).  You may not use
+# this file except in compliance with the License.  You can obtain a copy
+# in the file LICENSE in the source distribution or at
+# <A HREF="https://www.openssl.org/source/license.html">https://www.openssl.org/source/license.html</A>
+
+# Tests start with one of these keywords
+#       Cipher Decrypt Derive Digest Encoding KDF MAC PBE
+#       PrivPubKeyPair Sign Verify VerifyRecover
+# and continue until a blank line. Lines starting with a pound sign are ignored.
+
+# Test cases created using OpenSSL
+Title = PVKKDF tests
+
+Availablein = legacy
+KDF = PVKKDF
+Ctrl.pass = pass:password
+Ctrl.salt = salt:saltsalt
+Ctrl.digest = digest:md5
+Output = AE7CF6D3A33A2117FA4F008D66F6D26F
+
+Availablein = legacy
+KDF = PVKKDF
+Ctrl.pass = pass:password
+Ctrl.salt = salt:salt
+Ctrl.digest = digest:md5
+Output = 67A1E09BB1F83F5007DC119C14D663AA
+
+Availablein = legacy
+KDF = PVKKDF
+Ctrl.pass = pass:password
+Ctrl.salt = salt:saltsalt
+Ctrl.digest = digest:md4
+Output = E85DE988BB00EF61067A0506DFB044EE
</PRE>




<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="035377.html">[openssl]  master update
</A></li>
	<LI>Next message: <A HREF="035380.html">[openssl]  master update
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#35379">[ date ]</a>
              <a href="thread.html#35379">[ thread ]</a>
              <a href="subject.html#35379">[ subject ]</a>
              <a href="author.html#35379">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="../../../mailman/listinfo/openssl-commits.html">More information about the openssl-commits
mailing list</a><br>
</body></html>
