<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [openssl-commits] [openssl]  master update
   </TITLE>
   <LINK REL="Index" HREF="https://mta.openssl.org/pipermail/openssl-commits/2015-October/index.html" >
   <LINK REL="made" HREF="mailto:openssl-commits%40openssl.org?Subject=Re%3A%20%5Bopenssl-commits%5D%20%5Bopenssl%5D%20%20master%20update&In-Reply-To=%3C1444919856.871755.31350.nullmailer%40dev.openssl.org%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="002016.html">
   <LINK REL="Next"  HREF="002019.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[openssl-commits] [openssl]  master update</H1>
    <B>Dr. Stephen Henson</B> 
    <A HREF="mailto:openssl-commits%40openssl.org?Subject=Re%3A%20%5Bopenssl-commits%5D%20%5Bopenssl%5D%20%20master%20update&In-Reply-To=%3C1444919856.871755.31350.nullmailer%40dev.openssl.org%3E"
       TITLE="[openssl-commits] [openssl]  master update">steve at openssl.org
       </A><BR>
    <I>Thu Oct 15 14:37:36 UTC 2015</I>
    <P><UL>
        <LI>Previous message: <A HREF="002016.html">[openssl-commits] [openssl]  master update
</A></li>
        <LI>Next message: <A HREF="002019.html">[openssl-commits] [openssl]  master update
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2017">[ date ]</a>
              <a href="thread.html#2017">[ thread ]</a>
              <a href="subject.html#2017">[ subject ]</a>
              <a href="author.html#2017">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>The branch master has been updated
       via  f51e5ed6b4b91d12228da873db72aa28109d1797 (commit)
       via  34a42e1489bf4f45bfad069eceba56315d4713be (commit)
       via  81e4943843773a04067703e0dc1668ec5d3b4cf1 (commit)
       via  4392479c08392feb4be2ecb9d1b5decc50e32df0 (commit)
       via  272d917deb0534a6a9b13e22ff16e4c95406d1ed (commit)
       via  4002da0f52828dc4a495f7ac163d9e77c2774f3e (commit)
      from  f4f78ff7daf15f609a8bef1179d01cc982e37478 (commit)


- Log -----------------------------------------------------------------
commit f51e5ed6b4b91d12228da873db72aa28109d1797
Author: Dr. Stephen Henson &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">steve at openssl.org</A>&gt;
Date:   Wed Aug 5 03:21:40 2015 +0100

    Fix self signed handling.
    
    Don't mark a certificate as self signed if keyUsage is present and
    certificate signing not asserted.
    
    PR#3979
    
    Reviewed-by: Matt Caswell &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">matt at openssl.org</A>&gt;

commit 34a42e1489bf4f45bfad069eceba56315d4713be
Author: Dr. Stephen Henson &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">steve at openssl.org</A>&gt;
Date:   Sun Oct 11 21:13:42 2015 +0100

    embed CRL serial number and signature fields
    
    Reviewed-by: Rich Salz &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">rsalz at openssl.org</A>&gt;

commit 81e4943843773a04067703e0dc1668ec5d3b4cf1
Author: Dr. Stephen Henson &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">steve at openssl.org</A>&gt;
Date:   Sun Oct 11 21:05:49 2015 +0100

    embed certificate serial number and signature fields
    
    Reviewed-by: Rich Salz &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">rsalz at openssl.org</A>&gt;

commit 4392479c08392feb4be2ecb9d1b5decc50e32df0
Author: Dr. Stephen Henson &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">steve at openssl.org</A>&gt;
Date:   Sun Oct 11 20:44:07 2015 +0100

    embed value field of X509_EXTENSION
    
    Reviewed-by: Rich Salz &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">rsalz at openssl.org</A>&gt;

commit 272d917deb0534a6a9b13e22ff16e4c95406d1ed
Author: Dr. Stephen Henson &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">steve at openssl.org</A>&gt;
Date:   Sun Oct 11 21:20:19 2015 +0100

    add CHANGES entry for embed
    
    Reviewed-by: Rich Salz &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">rsalz at openssl.org</A>&gt;

commit 4002da0f52828dc4a495f7ac163d9e77c2774f3e
Author: Dr. Stephen Henson &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">steve at openssl.org</A>&gt;
Date:   Sun Oct 11 23:25:08 2015 +0100

    Handle embed flag in ASN1_STRING_copy().
    
    Reviewed-by: Rich Salz &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">rsalz at openssl.org</A>&gt;

-----------------------------------------------------------------------

Summary of changes:
 CHANGES                            | 21 +++++++++++++++++++++
 crypto/asn1/asn1_lib.c             |  4 +++-
 crypto/include/internal/x509_int.h |  8 ++++----
 crypto/x509/t_x509.c               |  2 +-
 crypto/x509/x509_cmp.c             | 10 +++++-----
 crypto/x509/x509_lcl.h             |  2 +-
 crypto/x509/x509_set.c             | 15 +++++----------
 crypto/x509/x509_v3.c              |  4 ++--
 crypto/x509/x509_vfy.c             |  2 +-
 crypto/x509/x509cset.c             | 17 ++++++-----------
 crypto/x509/x_all.c                | 11 ++++++-----
 crypto/x509/x_crl.c                | 14 +++++++-------
 crypto/x509/x_exten.c              |  2 +-
 crypto/x509/x_x509.c               |  6 +++---
 crypto/x509v3/v3_purp.c            | 19 ++++++++++---------
 15 files changed, 76 insertions(+), 61 deletions(-)

diff --git a/CHANGES b/CHANGES
index 3d9c183..cfbb7a7 100644
--- a/CHANGES
+++ b/CHANGES
@@ -3,6 +3,27 @@
  _______________
 
  Changes between 1.0.2 and 1.1.0  [xx XXX xxxx]
+
+  *) New ASN.1 embed macro.
+
+     New ASN.1 macro ASN1_EMBED. This is the same as ASN1_SIMPLE except the
+     structure is not allocated: it is part of the parent. That is instead of
+
+     FOO *x;
+
+     it must be:
+
+     FOO x;
+
+     This reduces memory fragmentation and make it impossible to accidentally
+     set a mandatory field to NULL.
+
+     This currently only works for some fields specifically a SEQUENCE, CHOICE,
+     or ASN1_STRING type which is part of a parent SEQUENCE. Since it is
+     equivalent to ASN1_SIMPLE it cannot be tagged, OPTIONAL, SET OF or
+     SEQUENCE OF.
+     [Steve Henson]
+
   *) Remove EVP_CHECK_DES_KEY, a compile-time option that never compiled.
      [Emilia K&#228;sper]
 
diff --git a/crypto/asn1/asn1_lib.c b/crypto/asn1/asn1_lib.c
index 12248db..ef9223c 100644
--- a/crypto/asn1/asn1_lib.c
+++ b/crypto/asn1/asn1_lib.c
@@ -284,7 +284,9 @@ int ASN1_STRING_copy(ASN1_STRING *dst, const ASN1_STRING *str)
     dst-&gt;type = str-&gt;type;
     if (!ASN1_STRING_set(dst, str-&gt;data, str-&gt;length))
         return 0;
-    dst-&gt;flags = str-&gt;flags;
+    /* Copy flags but preserve embed value */
+    dst-&gt;flags &amp;= ASN1_STRING_FLAG_EMBED;
+    dst-&gt;flags |= str-&gt;flags &amp; ~ASN1_STRING_FLAG_EMBED;
     return 1;
 }
 
diff --git a/crypto/include/internal/x509_int.h b/crypto/include/internal/x509_int.h
index 8fd0bcf..5997a21 100644
--- a/crypto/include/internal/x509_int.h
+++ b/crypto/include/internal/x509_int.h
@@ -121,7 +121,7 @@ struct X509_crl_info_st {
 struct X509_crl_st {
     X509_CRL_INFO crl;          /* signed CRL data */
     X509_ALGOR sig_alg;         /* CRL signature algorithm */
-    ASN1_BIT_STRING *signature; /* CRL signature */
+    ASN1_BIT_STRING signature; /* CRL signature */
     int references;
     int flags;
     /*
@@ -145,7 +145,7 @@ struct X509_crl_st {
 };
 
 struct x509_revoked_st {
-    ASN1_INTEGER *serialNumber; /* revoked entry serial number */
+    ASN1_INTEGER serialNumber; /* revoked entry serial number */
     ASN1_TIME *revocationDate;  /* revocation date */
     STACK_OF(X509_EXTENSION) *extensions;   /* CRL entry extensions: optional */
     /* decoded value of CRLissuer extension: set if indirect CRL */
@@ -176,7 +176,7 @@ struct x509_cert_aux_st {
 
 struct x509_cinf_st {
     ASN1_INTEGER *version;      /* [ 0 ] default of v1 */
-    ASN1_INTEGER *serialNumber;
+    ASN1_INTEGER serialNumber;
     X509_ALGOR signature;
     X509_NAME *issuer;
     X509_VAL validity;
@@ -191,7 +191,7 @@ struct x509_cinf_st {
 struct x509_st {
     X509_CINF cert_info;
     X509_ALGOR sig_alg;
-    ASN1_BIT_STRING *signature;
+    ASN1_BIT_STRING signature;
     int valid;
     int references;
     char *name;
diff --git a/crypto/x509/t_x509.c b/crypto/x509/t_x509.c
index 4cab108..5a73db1 100644
--- a/crypto/x509/t_x509.c
+++ b/crypto/x509/t_x509.c
@@ -238,7 +238,7 @@ int X509_print_ex(BIO *bp, X509 *x, unsigned long nmflags,
                                 ci-&gt;extensions, cflag, 8);
 
     if (!(cflag &amp; X509_FLAG_NO_SIGDUMP)) {
-        if (X509_signature_print(bp, &amp;x-&gt;sig_alg, x-&gt;signature) &lt;= 0)
+        if (X509_signature_print(bp, &amp;x-&gt;sig_alg, &amp;x-&gt;signature) &lt;= 0)
             goto err;
     }
     if (!(cflag &amp; X509_FLAG_NO_AUX)) {
diff --git a/crypto/x509/x509_cmp.c b/crypto/x509/x509_cmp.c
index 1e469f9..4017545 100644
--- a/crypto/x509/x509_cmp.c
+++ b/crypto/x509/x509_cmp.c
@@ -72,7 +72,7 @@ int X509_issuer_and_serial_cmp(const X509 *a, const X509 *b)
 
     ai = &amp;a-&gt;cert_info;
     bi = &amp;b-&gt;cert_info;
-    i = ASN1_INTEGER_cmp(ai-&gt;serialNumber, bi-&gt;serialNumber);
+    i = ASN1_INTEGER_cmp(&amp;ai-&gt;serialNumber, &amp;bi-&gt;serialNumber);
     if (i)
         return (i);
     return (X509_NAME_cmp(ai-&gt;issuer, bi-&gt;issuer));
@@ -94,8 +94,8 @@ unsigned long X509_issuer_and_serial_hash(X509 *a)
         goto err;
     OPENSSL_free(f);
     if (!EVP_DigestUpdate
-        (&amp;ctx, (unsigned char *)a-&gt;cert_info.serialNumber-&gt;data,
-         (unsigned long)a-&gt;cert_info.serialNumber-&gt;length))
+        (&amp;ctx, (unsigned char *)a-&gt;cert_info.serialNumber.data,
+         (unsigned long)a-&gt;cert_info.serialNumber.length))
         goto err;
     if (!EVP_DigestFinal_ex(&amp;ctx, &amp;(md[0]), NULL))
         goto err;
@@ -152,7 +152,7 @@ X509_NAME *X509_get_subject_name(X509 *a)
 
 ASN1_INTEGER *X509_get_serialNumber(X509 *a)
 {
-    return (a-&gt;cert_info.serialNumber);
+    return &amp;a-&gt;cert_info.serialNumber;
 }
 
 unsigned long X509_subject_name_hash(X509 *x)
@@ -278,7 +278,7 @@ X509 *X509_find_by_issuer_and_serial(STACK_OF(X509) *sk, X509_NAME *name,
     if (!sk)
         return NULL;
 
-    x.cert_info.serialNumber = serial;
+    x.cert_info.serialNumber = *serial;
     x.cert_info.issuer = name;
 
     for (i = 0; i &lt; sk_X509_num(sk); i++) {
diff --git a/crypto/x509/x509_lcl.h b/crypto/x509/x509_lcl.h
index 71c8a2a..af04341 100644
--- a/crypto/x509/x509_lcl.h
+++ b/crypto/x509/x509_lcl.h
@@ -98,7 +98,7 @@ struct x509_attributes_st {
 struct X509_extension_st {
     ASN1_OBJECT *object;
     ASN1_BOOLEAN critical;
-    ASN1_OCTET_STRING *value;
+    ASN1_OCTET_STRING value;
 };
 
 /*
diff --git a/crypto/x509/x509_set.c b/crypto/x509/x509_set.c
index 7873edf..38ec0db 100644
--- a/crypto/x509/x509_set.c
+++ b/crypto/x509/x509_set.c
@@ -85,16 +85,11 @@ int X509_set_serialNumber(X509 *x, ASN1_INTEGER *serial)
     ASN1_INTEGER *in;
 
     if (x == NULL)
-        return (0);
-    in = x-&gt;cert_info.serialNumber;
-    if (in != serial) {
-        in = ASN1_INTEGER_dup(serial);
-        if (in != NULL) {
-            ASN1_INTEGER_free(x-&gt;cert_info.serialNumber);
-            x-&gt;cert_info.serialNumber = in;
-        }
-    }
-    return (in != NULL);
+        return 0;
+    in = &amp;x-&gt;cert_info.serialNumber;
+    if (in != serial)
+        return ASN1_STRING_copy(in, serial);
+    return 1;
 }
 
 int X509_set_issuer_name(X509 *x, X509_NAME *name)
diff --git a/crypto/x509/x509_v3.c b/crypto/x509/x509_v3.c
index 4e9c8f5..f192979 100644
--- a/crypto/x509/x509_v3.c
+++ b/crypto/x509/x509_v3.c
@@ -253,7 +253,7 @@ int X509_EXTENSION_set_data(X509_EXTENSION *ex, ASN1_OCTET_STRING *data)
 
     if (ex == NULL)
         return (0);
-    i = ASN1_OCTET_STRING_set(ex-&gt;value, data-&gt;data, data-&gt;length);
+    i = ASN1_OCTET_STRING_set(&amp;ex-&gt;value, data-&gt;data, data-&gt;length);
     if (!i)
         return (0);
     return (1);
@@ -270,7 +270,7 @@ ASN1_OCTET_STRING *X509_EXTENSION_get_data(X509_EXTENSION *ex)
 {
     if (ex == NULL)
         return (NULL);
-    return (ex-&gt;value);
+    return &amp;ex-&gt;value;
 }
 
 int X509_EXTENSION_get_critical(X509_EXTENSION *ex)
diff --git a/crypto/x509/x509_vfy.c b/crypto/x509/x509_vfy.c
index 9cecde7..1ae3675 100644
--- a/crypto/x509/x509_vfy.c
+++ b/crypto/x509/x509_vfy.c
@@ -2088,7 +2088,7 @@ X509_CRL *X509_CRL_diff(X509_CRL *base, X509_CRL *newer,
          * Add only if not also in base. TODO: need something cleverer here
          * for some more complex CRLs covering multiple CAs.
          */
-        if (!X509_CRL_get0_by_serial(base, &amp;rvtmp, rvn-&gt;serialNumber)) {
+        if (!X509_CRL_get0_by_serial(base, &amp;rvtmp, &amp;rvn-&gt;serialNumber)) {
             rvtmp = X509_REVOKED_dup(rvn);
             if (!rvtmp)
                 goto memerr;
diff --git a/crypto/x509/x509cset.c b/crypto/x509/x509cset.c
index a779fd4..899d492 100644
--- a/crypto/x509/x509cset.c
+++ b/crypto/x509/x509cset.c
@@ -172,7 +172,7 @@ void X509_CRL_get0_signature(ASN1_BIT_STRING **psig, X509_ALGOR **palg,
                              X509_CRL *crl)
 {
     if (psig != NULL)
-        *psig = crl-&gt;signature;
+        *psig = &amp;crl-&gt;signature;
     if (palg != NULL)
         *palg = &amp;crl-&gt;sig_alg;
 }
@@ -206,7 +206,7 @@ int X509_REVOKED_set_revocationDate(X509_REVOKED *x, ASN1_TIME *tm)
 
 ASN1_INTEGER *X509_REVOKED_get0_serialNumber(X509_REVOKED *x)
 {
-    return x-&gt;serialNumber;
+    return &amp;x-&gt;serialNumber;
 }
 
 int X509_REVOKED_set_serialNumber(X509_REVOKED *x, ASN1_INTEGER *serial)
@@ -215,15 +215,10 @@ int X509_REVOKED_set_serialNumber(X509_REVOKED *x, ASN1_INTEGER *serial)
 
     if (x == NULL)
         return (0);
-    in = x-&gt;serialNumber;
-    if (in != serial) {
-        in = ASN1_INTEGER_dup(serial);
-        if (in != NULL) {
-            ASN1_INTEGER_free(x-&gt;serialNumber);
-            x-&gt;serialNumber = in;
-        }
-    }
-    return (in != NULL);
+    in = &amp;x-&gt;serialNumber;
+    if (in != serial)
+        return ASN1_STRING_copy(in, serial);
+    return 1;
 }
 
 STACK_OF(X509_EXTENSION) *X509_REVOKED_get0_extensions(X509_REVOKED *r)
diff --git a/crypto/x509/x_all.c b/crypto/x509/x_all.c
index 1db66f6..5c5f573 100644
--- a/crypto/x509/x_all.c
+++ b/crypto/x509/x_all.c
@@ -77,7 +77,7 @@ int X509_verify(X509 *a, EVP_PKEY *r)
     if (X509_ALGOR_cmp(&amp;a-&gt;sig_alg, &amp;a-&gt;cert_info.signature))
         return 0;
     return (ASN1_item_verify(ASN1_ITEM_rptr(X509_CINF), &amp;a-&gt;sig_alg,
-                             a-&gt;signature, &amp;a-&gt;cert_info, r));
+                             &amp;a-&gt;signature, &amp;a-&gt;cert_info, r));
 }
 
 int X509_REQ_verify(X509_REQ *a, EVP_PKEY *r)
@@ -96,7 +96,8 @@ int X509_sign(X509 *x, EVP_PKEY *pkey, const EVP_MD *md)
 {
     x-&gt;cert_info.enc.modified = 1;
     return (ASN1_item_sign(ASN1_ITEM_rptr(X509_CINF), &amp;x-&gt;cert_info.signature,
-                           &amp;x-&gt;sig_alg, x-&gt;signature, &amp;x-&gt;cert_info, pkey, md));
+                           &amp;x-&gt;sig_alg, &amp;x-&gt;signature, &amp;x-&gt;cert_info, pkey,
+                           md));
 }
 
 int X509_sign_ctx(X509 *x, EVP_MD_CTX *ctx)
@@ -104,7 +105,7 @@ int X509_sign_ctx(X509 *x, EVP_MD_CTX *ctx)
     x-&gt;cert_info.enc.modified = 1;
     return ASN1_item_sign_ctx(ASN1_ITEM_rptr(X509_CINF),
                               &amp;x-&gt;cert_info.signature,
-                              &amp;x-&gt;sig_alg, x-&gt;signature, &amp;x-&gt;cert_info, ctx);
+                              &amp;x-&gt;sig_alg, &amp;x-&gt;signature, &amp;x-&gt;cert_info, ctx);
 }
 
 int X509_http_nbio(OCSP_REQ_CTX *rctx, X509 **pcert)
@@ -130,14 +131,14 @@ int X509_CRL_sign(X509_CRL *x, EVP_PKEY *pkey, const EVP_MD *md)
 {
     x-&gt;crl.enc.modified = 1;
     return (ASN1_item_sign(ASN1_ITEM_rptr(X509_CRL_INFO), &amp;x-&gt;crl.sig_alg,
-                           &amp;x-&gt;sig_alg, x-&gt;signature, &amp;x-&gt;crl, pkey, md));
+                           &amp;x-&gt;sig_alg, &amp;x-&gt;signature, &amp;x-&gt;crl, pkey, md));
 }
 
 int X509_CRL_sign_ctx(X509_CRL *x, EVP_MD_CTX *ctx)
 {
     x-&gt;crl.enc.modified = 1;
     return ASN1_item_sign_ctx(ASN1_ITEM_rptr(X509_CRL_INFO),
-                              &amp;x-&gt;crl.sig_alg, &amp;x-&gt;sig_alg, x-&gt;signature,
+                              &amp;x-&gt;crl.sig_alg, &amp;x-&gt;sig_alg, &amp;x-&gt;signature,
                               &amp;x-&gt;crl, ctx);
 }
 
diff --git a/crypto/x509/x_crl.c b/crypto/x509/x_crl.c
index c8889d1..79fa5ca 100644
--- a/crypto/x509/x_crl.c
+++ b/crypto/x509/x_crl.c
@@ -69,7 +69,7 @@ static int X509_REVOKED_cmp(const X509_REVOKED *const *a,
 static void setup_idp(X509_CRL *crl, ISSUING_DIST_POINT *idp);
 
 ASN1_SEQUENCE(X509_REVOKED) = {
-        ASN1_SIMPLE(X509_REVOKED,serialNumber, ASN1_INTEGER),
+        ASN1_EMBED(X509_REVOKED,serialNumber, ASN1_INTEGER),
         ASN1_SIMPLE(X509_REVOKED,revocationDate, ASN1_TIME),
         ASN1_SEQUENCE_OF_OPT(X509_REVOKED,extensions, X509_EXTENSION)
 } ASN1_SEQUENCE_END(X509_REVOKED)
@@ -333,7 +333,7 @@ static void setup_idp(X509_CRL *crl, ISSUING_DIST_POINT *idp)
 ASN1_SEQUENCE_ref(X509_CRL, crl_cb, CRYPTO_LOCK_X509_CRL) = {
         ASN1_EMBED(X509_CRL, crl, X509_CRL_INFO),
         ASN1_EMBED(X509_CRL, sig_alg, X509_ALGOR),
-        ASN1_SIMPLE(X509_CRL, signature, ASN1_BIT_STRING)
+        ASN1_EMBED(X509_CRL, signature, ASN1_BIT_STRING)
 } ASN1_SEQUENCE_END_ref(X509_CRL, X509_CRL)
 
 IMPLEMENT_ASN1_FUNCTIONS(X509_REVOKED)
@@ -349,8 +349,8 @@ IMPLEMENT_ASN1_DUP_FUNCTION(X509_CRL)
 static int X509_REVOKED_cmp(const X509_REVOKED *const *a,
                             const X509_REVOKED *const *b)
 {
-    return (ASN1_STRING_cmp((ASN1_STRING *)(*a)-&gt;serialNumber,
-                            (ASN1_STRING *)(*b)-&gt;serialNumber));
+    return (ASN1_STRING_cmp((ASN1_STRING *)&amp;(*a)-&gt;serialNumber,
+                            (ASN1_STRING *)&amp;(*b)-&gt;serialNumber));
 }
 
 int X509_CRL_add0_revoked(X509_CRL *crl, X509_REVOKED *rev)
@@ -394,7 +394,7 @@ int X509_CRL_get0_by_cert(X509_CRL *crl, X509_REVOKED **ret, X509 *x)
 static int def_crl_verify(X509_CRL *crl, EVP_PKEY *r)
 {
     return (ASN1_item_verify(ASN1_ITEM_rptr(X509_CRL_INFO),
-                             &amp;crl-&gt;sig_alg, crl-&gt;signature, &amp;crl-&gt;crl, r));
+                             &amp;crl-&gt;sig_alg, &amp;crl-&gt;signature, &amp;crl-&gt;crl, r));
 }
 
 static int crl_revoked_issuer_match(X509_CRL *crl, X509_NAME *nm,
@@ -430,7 +430,7 @@ static int def_crl_lookup(X509_CRL *crl,
 {
     X509_REVOKED rtmp, *rev;
     int idx;
-    rtmp.serialNumber = serial;
+    rtmp.serialNumber = *serial;
     /*
      * Sort revoked into serial number order if not already sorted. Do this
      * under a lock to avoid race condition.
@@ -446,7 +446,7 @@ static int def_crl_lookup(X509_CRL *crl,
     /* Need to look for matching name */
     for (; idx &lt; sk_X509_REVOKED_num(crl-&gt;crl.revoked); idx++) {
         rev = sk_X509_REVOKED_value(crl-&gt;crl.revoked, idx);
-        if (ASN1_INTEGER_cmp(rev-&gt;serialNumber, serial))
+        if (ASN1_INTEGER_cmp(&amp;rev-&gt;serialNumber, serial))
             return 0;
         if (crl_revoked_issuer_match(crl, issuer, rev)) {
             if (ret)
diff --git a/crypto/x509/x_exten.c b/crypto/x509/x_exten.c
index c0d4c96..c5b391f 100644
--- a/crypto/x509/x_exten.c
+++ b/crypto/x509/x_exten.c
@@ -66,7 +66,7 @@
 ASN1_SEQUENCE(X509_EXTENSION) = {
         ASN1_SIMPLE(X509_EXTENSION, object, ASN1_OBJECT),
         ASN1_OPT(X509_EXTENSION, critical, ASN1_BOOLEAN),
-        ASN1_SIMPLE(X509_EXTENSION, value, ASN1_OCTET_STRING)
+        ASN1_EMBED(X509_EXTENSION, value, ASN1_OCTET_STRING)
 } ASN1_SEQUENCE_END(X509_EXTENSION)
 
 ASN1_ITEM_TEMPLATE(X509_EXTENSIONS) =
diff --git a/crypto/x509/x_x509.c b/crypto/x509/x_x509.c
index 92d4fa3..ad2309c 100644
--- a/crypto/x509/x_x509.c
+++ b/crypto/x509/x_x509.c
@@ -66,7 +66,7 @@
 
 ASN1_SEQUENCE_enc(X509_CINF, enc, 0) = {
         ASN1_EXP_OPT(X509_CINF, version, ASN1_INTEGER, 0),
-        ASN1_SIMPLE(X509_CINF, serialNumber, ASN1_INTEGER),
+        ASN1_EMBED(X509_CINF, serialNumber, ASN1_INTEGER),
         ASN1_EMBED(X509_CINF, signature, X509_ALGOR),
         ASN1_SIMPLE(X509_CINF, issuer, X509_NAME),
         ASN1_EMBED(X509_CINF, validity, X509_VAL),
@@ -135,7 +135,7 @@ static int x509_cb(int operation, ASN1_VALUE **pval, const ASN1_ITEM *it,
 ASN1_SEQUENCE_ref(X509, x509_cb, CRYPTO_LOCK_X509) = {
         ASN1_EMBED(X509, cert_info, X509_CINF),
         ASN1_EMBED(X509, sig_alg, X509_ALGOR),
-        ASN1_SIMPLE(X509, signature, ASN1_BIT_STRING)
+        ASN1_EMBED(X509, signature, ASN1_BIT_STRING)
 } ASN1_SEQUENCE_END_ref(X509, X509)
 
 IMPLEMENT_ASN1_FUNCTIONS(X509)
@@ -215,7 +215,7 @@ int i2d_re_X509_tbs(X509 *x, unsigned char **pp)
 void X509_get0_signature(ASN1_BIT_STRING **psig, X509_ALGOR **palg, X509 *x)
 {
     if (psig)
-        *psig = x-&gt;signature;
+        *psig = &amp;x-&gt;signature;
     if (palg)
         *palg = &amp;x-&gt;sig_alg;
 }
diff --git a/crypto/x509v3/v3_purp.c b/crypto/x509v3/v3_purp.c
index 43f3551..90b3abc 100644
--- a/crypto/x509v3/v3_purp.c
+++ b/crypto/x509v3/v3_purp.c
@@ -380,6 +380,14 @@ static void setup_crldp(X509 *x)
         setup_dp(x, sk_DIST_POINT_value(x-&gt;crldp, i));
 }
 
+#define V1_ROOT (EXFLAG_V1|EXFLAG_SS)
+#define ku_reject(x, usage) \
+        (((x)-&gt;ex_flags &amp; EXFLAG_KUSAGE) &amp;&amp; !((x)-&gt;ex_kusage &amp; (usage)))
+#define xku_reject(x, usage) \
+        (((x)-&gt;ex_flags &amp; EXFLAG_XKUSAGE) &amp;&amp; !((x)-&gt;ex_xkusage &amp; (usage)))
+#define ns_reject(x, usage) \
+        (((x)-&gt;ex_flags &amp; EXFLAG_NSCERT) &amp;&amp; !((x)-&gt;ex_nscert &amp; (usage)))
+
 static void x509v3_cache_extensions(X509 *x)
 {
     BASIC_CONSTRAINTS *bs;
@@ -497,7 +505,8 @@ static void x509v3_cache_extensions(X509 *x)
     if (!X509_NAME_cmp(X509_get_subject_name(x), X509_get_issuer_name(x))) {
         x-&gt;ex_flags |= EXFLAG_SI;
         /* If SKID matches AKID also indicate self signed */
-        if (X509_check_akid(x, x-&gt;akid) == X509_V_OK)
+        if (X509_check_akid(x, x-&gt;akid) == X509_V_OK &amp;&amp;
+            !ku_reject(x, KU_KEY_CERT_SIGN))
             x-&gt;ex_flags |= EXFLAG_SS;
     }
     x-&gt;altname = X509_get_ext_d2i(x, NID_subject_alt_name, NULL, NULL);
@@ -536,14 +545,6 @@ static void x509v3_cache_extensions(X509 *x)
  * 4 basicConstraints absent but keyUsage present and keyCertSign asserted.
  */
 
-#define V1_ROOT (EXFLAG_V1|EXFLAG_SS)
-#define ku_reject(x, usage) \
-        (((x)-&gt;ex_flags &amp; EXFLAG_KUSAGE) &amp;&amp; !((x)-&gt;ex_kusage &amp; (usage)))
-#define xku_reject(x, usage) \
-        (((x)-&gt;ex_flags &amp; EXFLAG_XKUSAGE) &amp;&amp; !((x)-&gt;ex_xkusage &amp; (usage)))
-#define ns_reject(x, usage) \
-        (((x)-&gt;ex_flags &amp; EXFLAG_NSCERT) &amp;&amp; !((x)-&gt;ex_nscert &amp; (usage)))
-
 static int check_ca(const X509 *x)
 {
     /* keyUsage if present should allow cert signing */
</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="002016.html">[openssl-commits] [openssl]  master update
</A></li>
	<LI>Next message: <A HREF="002019.html">[openssl-commits] [openssl]  master update
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2017">[ date ]</a>
              <a href="thread.html#2017">[ thread ]</a>
              <a href="subject.html#2017">[ subject ]</a>
              <a href="author.html#2017">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="../../../mailman/listinfo/openssl-commits.html">More information about the openssl-commits
mailing list</a><br>
</body></html>
