<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [openssl-commits] [openssl]  OpenSSL_1_1_1-stable update
   </TITLE>
   <LINK REL="Index" HREF="https://mta.openssl.org/pipermail/openssl-commits/2018-December/index.html" >
   <LINK REL="made" HREF="mailto:openssl-commits%40openssl.org?Subject=Re%3A%20%5Bopenssl-commits%5D%20%5Bopenssl%5D%20%20OpenSSL_1_1_1-stable%20update&In-Reply-To=%3C1544444667.533920.32137.nullmailer%40dev.openssl.org%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="021065.html">
   <LINK REL="Next"  HREF="021075.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[openssl-commits] [openssl]  OpenSSL_1_1_1-stable update</H1>
    <B>Richard Levitte</B> 
    <A HREF="mailto:openssl-commits%40openssl.org?Subject=Re%3A%20%5Bopenssl-commits%5D%20%5Bopenssl%5D%20%20OpenSSL_1_1_1-stable%20update&In-Reply-To=%3C1544444667.533920.32137.nullmailer%40dev.openssl.org%3E"
       TITLE="[openssl-commits] [openssl]  OpenSSL_1_1_1-stable update">levitte at openssl.org
       </A><BR>
    <I>Mon Dec 10 12:24:27 UTC 2018</I>
    <P><UL>
        <LI>Previous message: <A HREF="021065.html">[openssl-commits] [openssl]  OpenSSL_1_1_1-stable update
</A></li>
        <LI>Next message: <A HREF="021075.html">[openssl-commits] [openssl]  OpenSSL_1_1_1-stable update
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#21067">[ date ]</a>
              <a href="thread.html#21067">[ thread ]</a>
              <a href="subject.html#21067">[ subject ]</a>
              <a href="author.html#21067">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>The branch OpenSSL_1_1_1-stable has been updated
       via  488521d77fdc1de5ae256ce0d9203e35ebc92993 (commit)
       via  2887a5c8f9a385b3ebee12b98f68e7d1f9cc0ea0 (commit)
       via  a19d1a1d370e2959555fccbafc4e970634840352 (commit)
       via  5378c582c8d3f1130b17abb2950bfd09cde099c6 (commit)
       via  68b02a8ab798b7e916c8141a36ab69d7493fc707 (commit)
       via  add2ab1f289c24a1563c5b895d5cd133fe874f12 (commit)
       via  be5cf61caa425070ec4f3e925d4e9aa484c8315b (commit)
       via  72b8228a9c0711bdc1f5f2a9f49bef0bb50ffb58 (commit)
      from  23abea6307a6df4dcefc1219b49ef0f2846ed844 (commit)


- Log -----------------------------------------------------------------
commit 488521d77fdc1de5ae256ce0d9203e35ebc92993
Author: Eneas U de Queiroz &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">cote2004-github at yahoo.com</A>&gt;
Date:   Sat Dec 8 18:01:04 2018 -0200

    eng_devcrypto: make sure digest can do copy
    
    Digest must be able to do partial-state copy to be used.
    
    Signed-off-by: Eneas U de Queiroz &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">cote2004-github at yahoo.com</A>&gt;
    
    Reviewed-by: Matthias St. Pierre &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">Matthias.St.Pierre at ncp-e.com</A>&gt;
    Reviewed-by: Richard Levitte &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">levitte at openssl.org</A>&gt;
    (Merged from <A HREF="https://github.com/openssl/openssl/pull/7585">https://github.com/openssl/openssl/pull/7585</A>)
    
    (cherry picked from commit 16e252a01b754a13e83d5e5e87afbe389997926b)

commit 2887a5c8f9a385b3ebee12b98f68e7d1f9cc0ea0
Author: Eneas U de Queiroz &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">cote2004-github at yahoo.com</A>&gt;
Date:   Wed Nov 28 11:26:27 2018 -0200

    eng_devcrypto: fix ctr mode
    
    Make CTR mode behave like a stream cipher.
    
    Signed-off-by: Eneas U de Queiroz &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">cote2004-github at yahoo.com</A>&gt;
    
    Reviewed-by: Matthias St. Pierre &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">Matthias.St.Pierre at ncp-e.com</A>&gt;
    Reviewed-by: Richard Levitte &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">levitte at openssl.org</A>&gt;
    (Merged from <A HREF="https://github.com/openssl/openssl/pull/7585">https://github.com/openssl/openssl/pull/7585</A>)
    
    (cherry picked from commit b5015e834aa7d3f0a5d7585a8fae05cecbdbb848)

commit a19d1a1d370e2959555fccbafc4e970634840352
Author: Eneas U de Queiroz &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">cote2004-github at yahoo.com</A>&gt;
Date:   Tue Nov 13 09:23:22 2018 -0200

    eng_devcrypto: add cipher CTX copy function
    
    The engine needs a custom cipher context copy function to open a new
    /dev/crypto session.
    
    Signed-off-by: Eneas U de Queiroz &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">cote2004-github at yahoo.com</A>&gt;
    
    Reviewed-by: Matthias St. Pierre &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">Matthias.St.Pierre at ncp-e.com</A>&gt;
    Reviewed-by: Richard Levitte &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">levitte at openssl.org</A>&gt;
    (Merged from <A HREF="https://github.com/openssl/openssl/pull/7585">https://github.com/openssl/openssl/pull/7585</A>)
    
    (cherry picked from commit 6d99e238397859f2df58c60e28905193b2dd6762)

commit 5378c582c8d3f1130b17abb2950bfd09cde099c6
Author: Eneas U de Queiroz &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">cote2004-github at yahoo.com</A>&gt;
Date:   Mon Nov 5 15:59:44 2018 -0200

    eng_devcrypto: close session on cleanup, not final
    
    Close the session in digest_cleanup instead of digest_final.  A failure
    in closing the session does not mean a previous successful digest final
    has failed as well.
    
    Signed-off-by: Eneas U de Queiroz &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">cote2004-github at yahoo.com</A>&gt;
    
    Reviewed-by: Matthias St. Pierre &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">Matthias.St.Pierre at ncp-e.com</A>&gt;
    Reviewed-by: Richard Levitte &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">levitte at openssl.org</A>&gt;
    (Merged from <A HREF="https://github.com/openssl/openssl/pull/7585">https://github.com/openssl/openssl/pull/7585</A>)
    
    (cherry picked from commit a67203a19d379a8cc8b369587c60c46eb4e19014)

commit 68b02a8ab798b7e916c8141a36ab69d7493fc707
Author: Eneas U de Queiroz &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">cote2004-github at yahoo.com</A>&gt;
Date:   Wed Nov 14 13:58:06 2018 -0200

    eng_devcrypto: fix copy of unitilialized digest
    
    If the source ctx has not been initialized, don't initialize the copy
    either.
    
    Signed-off-by: Eneas U de Queiroz &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">cote2004-github at yahoo.com</A>&gt;
    
    Reviewed-by: Matthias St. Pierre &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">Matthias.St.Pierre at ncp-e.com</A>&gt;
    Reviewed-by: Richard Levitte &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">levitte at openssl.org</A>&gt;
    (Merged from <A HREF="https://github.com/openssl/openssl/pull/7585">https://github.com/openssl/openssl/pull/7585</A>)
    
    (cherry picked from commit ae8183690fa53b978d4647563f5a521c4cafe94c)

commit add2ab1f289c24a1563c5b895d5cd133fe874f12
Author: Eneas U de Queiroz &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">cote2004-github at yahoo.com</A>&gt;
Date:   Wed Nov 14 11:22:14 2018 -0200

    eng_devcrypto: expand digest failure cases
    
    Return failure when the digest_ctx is null in digest_update and
    digest_final, and when md is null in digest_final.
    
    Signed-off-by: Eneas U de Queiroz &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">cote2004-github at yahoo.com</A>&gt;
    
    Reviewed-by: Matthias St. Pierre &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">Matthias.St.Pierre at ncp-e.com</A>&gt;
    Reviewed-by: Richard Levitte &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">levitte at openssl.org</A>&gt;
    (Merged from <A HREF="https://github.com/openssl/openssl/pull/7585">https://github.com/openssl/openssl/pull/7585</A>)
    
    (cherry picked from commit 4d9f99654441e36fdcb49540a1dbc9d4c70ccb68)

commit be5cf61caa425070ec4f3e925d4e9aa484c8315b
Author: Eneas U de Queiroz &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">cote2004-github at yahoo.com</A>&gt;
Date:   Mon Nov 5 17:59:42 2018 -0200

    eng_devcrypto: don't leak methods tables
    
    Call functions to prepare methods after confirming that /dev/crytpo was
    sucessfully open and that the destroy function has been set.
    
    Signed-off-by: Eneas U de Queiroz &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">cote2004-github at yahoo.com</A>&gt;
    
    Reviewed-by: Matthias St. Pierre &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">Matthias.St.Pierre at ncp-e.com</A>&gt;
    Reviewed-by: Richard Levitte &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">levitte at openssl.org</A>&gt;
    (Merged from <A HREF="https://github.com/openssl/openssl/pull/7585">https://github.com/openssl/openssl/pull/7585</A>)
    
    (cherry picked from commit d9d4dff5c640990d45af115353fc9f88a497a56c)

commit 72b8228a9c0711bdc1f5f2a9f49bef0bb50ffb58
Author: Eneas U de Queiroz &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">cote2004-github at yahoo.com</A>&gt;
Date:   Thu Nov 8 11:16:20 2018 -0200

    INSTALL: add note about devcrypto engine
    
    Signed-off-by: Eneas U de Queiroz &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">cote2004-github at yahoo.com</A>&gt;
    
    Reviewed-by: Matthias St. Pierre &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">Matthias.St.Pierre at ncp-e.com</A>&gt;
    Reviewed-by: Richard Levitte &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">levitte at openssl.org</A>&gt;
    (Merged from <A HREF="https://github.com/openssl/openssl/pull/7585">https://github.com/openssl/openssl/pull/7585</A>)
    
    (cherry picked from commit eb3fe0ee5411449230cff46b7f13ebef37aa950e)

-----------------------------------------------------------------------

Summary of changes:
 INSTALL                       |   5 +
 crypto/engine/eng_devcrypto.c | 217 ++++++++++++++++++++++++++++++++----------
 2 files changed, 174 insertions(+), 48 deletions(-)

diff --git a/INSTALL b/INSTALL
index 4ce6651..86412c7 100644
--- a/INSTALL
+++ b/INSTALL
@@ -326,6 +326,11 @@
                    Don't build support for datagram based BIOs. Selecting this
                    option will also force the disabling of DTLS.
 
+  enable-devcryptoeng
+                   Build the /dev/crypto engine.  It is automatically selected
+                   on BSD implementations, in which case it can be disabled with
+                   no-devcryptoeng.
+
   no-dso
                    Don't build support for loading Dynamic Shared Objects.
 
diff --git a/crypto/engine/eng_devcrypto.c b/crypto/engine/eng_devcrypto.c
index 4a0ba09..65f1720 100644
--- a/crypto/engine/eng_devcrypto.c
+++ b/crypto/engine/eng_devcrypto.c
@@ -47,10 +47,12 @@ static int cfd;
 
 struct cipher_ctx {
     struct session_op sess;
-
-    /* to pass from init to do_cipher */
-    const unsigned char *iv;
     int op;                      /* COP_ENCRYPT or COP_DECRYPT */
+    unsigned long mode;          /* EVP_CIPH_*_MODE */
+
+    /* to handle ctr mode being a stream cipher */
+    unsigned char partial[EVP_MAX_BLOCK_LENGTH];
+    unsigned int blocksize, num;
 };
 
 static const struct cipher_data_st {
@@ -87,9 +89,9 @@ static const struct cipher_data_st {
     { NID_aes_256_xts, 16, 256 / 8 * 2, 16, EVP_CIPH_XTS_MODE, CRYPTO_AES_XTS },
 #endif
 #if !defined(CHECK_BSD_STYLE_MACROS) || defined(CRYPTO_AES_ECB)
-    { NID_aes_128_ecb, 16, 128 / 8, 16, EVP_CIPH_ECB_MODE, CRYPTO_AES_ECB },
-    { NID_aes_192_ecb, 16, 192 / 8, 16, EVP_CIPH_ECB_MODE, CRYPTO_AES_ECB },
-    { NID_aes_256_ecb, 16, 256 / 8, 16, EVP_CIPH_ECB_MODE, CRYPTO_AES_ECB },
+    { NID_aes_128_ecb, 16, 128 / 8, 0, EVP_CIPH_ECB_MODE, CRYPTO_AES_ECB },
+    { NID_aes_192_ecb, 16, 192 / 8, 0, EVP_CIPH_ECB_MODE, CRYPTO_AES_ECB },
+    { NID_aes_256_ecb, 16, 256 / 8, 0, EVP_CIPH_ECB_MODE, CRYPTO_AES_ECB },
 #endif
 #if 0                            /* Not yet supported */
     { NID_aes_128_gcm, 16, 128 / 8, 16, EVP_CIPH_GCM_MODE, CRYPTO_AES_GCM },
@@ -146,6 +148,8 @@ static int cipher_init(EVP_CIPHER_CTX *ctx, const unsigned char *key,
     cipher_ctx-&gt;sess.keylen = cipher_d-&gt;keylen;
     cipher_ctx-&gt;sess.key = (void *)key;
     cipher_ctx-&gt;op = enc ? COP_ENCRYPT : COP_DECRYPT;
+    cipher_ctx-&gt;mode = cipher_d-&gt;flags &amp; EVP_CIPH_MODE;
+    cipher_ctx-&gt;blocksize = cipher_d-&gt;blocksize;
     if (ioctl(cfd, CIOCGSESSION, &amp;cipher_ctx-&gt;sess) &lt; 0) {
         SYSerr(SYS_F_IOCTL, errno);
         return 0;
@@ -160,8 +164,11 @@ static int cipher_do_cipher(EVP_CIPHER_CTX *ctx, unsigned char *out,
     struct cipher_ctx *cipher_ctx =
         (struct cipher_ctx *)EVP_CIPHER_CTX_get_cipher_data(ctx);
     struct crypt_op cryp;
+    unsigned char *iv = EVP_CIPHER_CTX_iv_noconst(ctx);
 #if !defined(COP_FLAG_WRITE_IV)
     unsigned char saved_iv[EVP_MAX_IV_LENGTH];
+    const unsigned char *ivptr;
+    size_t nblocks, ivlen;
 #endif
 
     memset(&amp;cryp, 0, sizeof(cryp));
@@ -169,19 +176,28 @@ static int cipher_do_cipher(EVP_CIPHER_CTX *ctx, unsigned char *out,
     cryp.len = inl;
     cryp.src = (void *)in;
     cryp.dst = (void *)out;
-    cryp.iv = (void *)EVP_CIPHER_CTX_iv_noconst(ctx);
+    cryp.iv = (void *)iv;
     cryp.op = cipher_ctx-&gt;op;
 #if !defined(COP_FLAG_WRITE_IV)
     cryp.flags = 0;
 
-    if (EVP_CIPHER_CTX_iv_length(ctx) &gt; 0) {
-        assert(inl &gt;= EVP_CIPHER_CTX_iv_length(ctx));
-        if (!EVP_CIPHER_CTX_encrypting(ctx)) {
-            unsigned char *ivptr = in + inl - EVP_CIPHER_CTX_iv_length(ctx);
-
-            memcpy(saved_iv, ivptr, EVP_CIPHER_CTX_iv_length(ctx));
+    ivlen = EVP_CIPHER_CTX_iv_length(ctx);
+    if (ivlen &gt; 0)
+        switch (cipher_ctx-&gt;mode) {
+        case EVP_CIPH_CBC_MODE:
+            assert(inl &gt;= ivlen);
+            if (!EVP_CIPHER_CTX_encrypting(ctx)) {
+                ivptr = in + inl - ivlen;
+                memcpy(saved_iv, ivptr, ivlen);
+            }
+            break;
+
+        case EVP_CIPH_CTR_MODE:
+            break;
+
+        default: /* should not happen */
+            return 0;
         }
-    }
 #else
     cryp.flags = COP_FLAG_WRITE_IV;
 #endif
@@ -192,21 +208,94 @@ static int cipher_do_cipher(EVP_CIPHER_CTX *ctx, unsigned char *out,
     }
 
 #if !defined(COP_FLAG_WRITE_IV)
-    if (EVP_CIPHER_CTX_iv_length(ctx) &gt; 0) {
-        unsigned char *ivptr = saved_iv;
+    if (ivlen &gt; 0)
+        switch (cipher_ctx-&gt;mode) {
+        case EVP_CIPH_CBC_MODE:
+            assert(inl &gt;= ivlen);
+            if (EVP_CIPHER_CTX_encrypting(ctx))
+                ivptr = out + inl - ivlen;
+            else
+                ivptr = saved_iv;
+
+            memcpy(iv, ivptr, ivlen);
+            break;
+
+        case EVP_CIPH_CTR_MODE:
+            nblocks = (inl + cipher_ctx-&gt;blocksize - 1)
+                      / cipher_ctx-&gt;blocksize;
+            do {
+                ivlen--;
+                nblocks += iv[ivlen];
+                iv[ivlen] = (uint8_t) nblocks;
+                nblocks &gt;&gt;= 8;
+            } while (ivlen);
+            break;
+
+        default: /* should not happen */
+            return 0;
+        }
+#endif
 
-        assert(inl &gt;= EVP_CIPHER_CTX_iv_length(ctx));
-        if (!EVP_CIPHER_CTX_encrypting(ctx))
-            ivptr = out + inl - EVP_CIPHER_CTX_iv_length(ctx);
+    return 1;
+}
 
-        memcpy(EVP_CIPHER_CTX_iv_noconst(ctx), ivptr,
-               EVP_CIPHER_CTX_iv_length(ctx));
+static int ctr_do_cipher(EVP_CIPHER_CTX *ctx, unsigned char *out,
+                         const unsigned char *in, size_t inl)
+{
+    struct cipher_ctx *cipher_ctx =
+        (struct cipher_ctx *)EVP_CIPHER_CTX_get_cipher_data(ctx);
+    size_t nblocks, len;
+
+    /* initial partial block */
+    while (cipher_ctx-&gt;num &amp;&amp; inl) {
+        (*out++) = *(in++) ^ cipher_ctx-&gt;partial[cipher_ctx-&gt;num];
+        --inl;
+        cipher_ctx-&gt;num = (cipher_ctx-&gt;num + 1) % cipher_ctx-&gt;blocksize;
+    }
+
+    /* full blocks */
+    if (inl &gt; (unsigned int) cipher_ctx-&gt;blocksize) {
+        nblocks = inl/cipher_ctx-&gt;blocksize;
+        len = nblocks * cipher_ctx-&gt;blocksize;
+        if (cipher_do_cipher(ctx, out, in, len) &lt; 1)
+            return 0;
+        inl -= len;
+        out += len;
+        in += len;
+    }
+
+    /* final partial block */
+    if (inl) {
+        memset(cipher_ctx-&gt;partial, 0, cipher_ctx-&gt;blocksize);
+        if (cipher_do_cipher(ctx, cipher_ctx-&gt;partial, cipher_ctx-&gt;partial,
+            cipher_ctx-&gt;blocksize) &lt; 1)
+            return 0;
+        while (inl--) {
+            out[cipher_ctx-&gt;num] = in[cipher_ctx-&gt;num]
+                                   ^ cipher_ctx-&gt;partial[cipher_ctx-&gt;num];
+            cipher_ctx-&gt;num++;
+        }
     }
-#endif
 
     return 1;
 }
 
+static int cipher_ctrl(EVP_CIPHER_CTX *ctx, int type, int p1, void* p2)
+{
+    EVP_CIPHER_CTX *to_ctx = (EVP_CIPHER_CTX *)p2;
+    struct cipher_ctx *cipher_ctx;
+
+    if (type == EVP_CTRL_COPY) {
+        /* when copying the context, a new session needs to be initialized */
+        cipher_ctx = (struct cipher_ctx *)EVP_CIPHER_CTX_get_cipher_data(ctx);
+        return (cipher_ctx == NULL)
+            || cipher_init(to_ctx, cipher_ctx-&gt;sess.key, EVP_CIPHER_CTX_iv(ctx),
+                           (cipher_ctx-&gt;op == COP_ENCRYPT));
+    }
+
+    return -1;
+}
+
 static int cipher_cleanup(EVP_CIPHER_CTX *ctx)
 {
     struct cipher_ctx *cipher_ctx =
@@ -233,6 +322,7 @@ static void prepare_cipher_methods(void)
 {
     size_t i;
     struct session_op sess;
+    unsigned long cipher_mode;
 
     memset(&amp;sess, 0, sizeof(sess));
     sess.key = (void *)&quot;01234567890123456789012345678901234567890123456789&quot;;
@@ -250,18 +340,25 @@ static void prepare_cipher_methods(void)
             || ioctl(cfd, CIOCFSESSION, &amp;sess.ses) &lt; 0)
             continue;
 
+        cipher_mode = cipher_data[i].flags &amp; EVP_CIPH_MODE;
+
         if ((known_cipher_methods[i] =
                  EVP_CIPHER_meth_new(cipher_data[i].nid,
-                                     cipher_data[i].blocksize,
+                                     cipher_mode == EVP_CIPH_CTR_MODE ? 1 :
+                                                    cipher_data[i].blocksize,
                                      cipher_data[i].keylen)) == NULL
             || !EVP_CIPHER_meth_set_iv_length(known_cipher_methods[i],
                                               cipher_data[i].ivlen)
             || !EVP_CIPHER_meth_set_flags(known_cipher_methods[i],
                                           cipher_data[i].flags
+                                          | EVP_CIPH_CUSTOM_COPY
                                           | EVP_CIPH_FLAG_DEFAULT_ASN1)
             || !EVP_CIPHER_meth_set_init(known_cipher_methods[i], cipher_init)
             || !EVP_CIPHER_meth_set_do_cipher(known_cipher_methods[i],
+                                     cipher_mode == EVP_CIPH_CTR_MODE ?
+                                              ctr_do_cipher :
                                               cipher_do_cipher)
+            || !EVP_CIPHER_meth_set_ctrl(known_cipher_methods[i], cipher_ctrl)
             || !EVP_CIPHER_meth_set_cleanup(known_cipher_methods[i],
                                             cipher_cleanup)
             || !EVP_CIPHER_meth_set_impl_ctx_size(known_cipher_methods[i],
@@ -338,7 +435,8 @@ static int devcrypto_ciphers(ENGINE *e, const EVP_CIPHER **cipher,
 
 struct digest_ctx {
     struct session_op sess;
-    int init;
+    /* This signals that the init function was called, not that it succeeded. */
+    int init_called;
 };
 
 static const struct digest_data_st {
@@ -403,7 +501,7 @@ static int digest_init(EVP_MD_CTX *ctx)
     const struct digest_data_st *digest_d =
         get_digest_data(EVP_MD_CTX_type(ctx));
 
-    digest_ctx-&gt;init = 1;
+    digest_ctx-&gt;init_called = 1;
 
     memset(&amp;digest_ctx-&gt;sess, 0, sizeof(digest_ctx-&gt;sess));
     digest_ctx-&gt;sess.mac = digest_d-&gt;devcryptoid;
@@ -438,6 +536,9 @@ static int digest_update(EVP_MD_CTX *ctx, const void *data, size_t count)
     if (count == 0)
         return 1;
 
+    if (digest_ctx == NULL)
+        return 0;
+
     if (digest_op(digest_ctx, data, count, NULL, COP_FLAG_UPDATE) &lt; 0) {
         SYSerr(SYS_F_IOCTL, errno);
         return 0;
@@ -451,11 +552,9 @@ static int digest_final(EVP_MD_CTX *ctx, unsigned char *md)
     struct digest_ctx *digest_ctx =
         (struct digest_ctx *)EVP_MD_CTX_md_data(ctx);
 
-    if (digest_op(digest_ctx, NULL, 0, md, COP_FLAG_FINAL) &lt; 0) {
-        SYSerr(SYS_F_IOCTL, errno);
+    if (md == NULL || digest_ctx == NULL)
         return 0;
-    }
-    if (ioctl(cfd, CIOCFSESSION, &amp;digest_ctx-&gt;sess.ses) &lt; 0) {
+    if (digest_op(digest_ctx, NULL, 0, md, COP_FLAG_FINAL) &lt; 0) {
         SYSerr(SYS_F_IOCTL, errno);
         return 0;
     }
@@ -471,14 +570,9 @@ static int digest_copy(EVP_MD_CTX *to, const EVP_MD_CTX *from)
         (struct digest_ctx *)EVP_MD_CTX_md_data(to);
     struct cphash_op cphash;
 
-    if (digest_from == NULL)
+    if (digest_from == NULL || digest_from-&gt;init_called != 1)
         return 1;
 
-    if (digest_from-&gt;init != 1) {
-        SYSerr(SYS_F_IOCTL, EINVAL);
-        return 0;
-    }
-
     if (!digest_init(to)) {
         SYSerr(SYS_F_IOCTL, errno);
         return 0;
@@ -495,9 +589,42 @@ static int digest_copy(EVP_MD_CTX *to, const EVP_MD_CTX *from)
 
 static int digest_cleanup(EVP_MD_CTX *ctx)
 {
+    struct digest_ctx *digest_ctx =
+        (struct digest_ctx *)EVP_MD_CTX_md_data(ctx);
+
+    if (digest_ctx == NULL)
+        return 1;
+    if (ioctl(cfd, CIOCFSESSION, &amp;digest_ctx-&gt;sess.ses) &lt; 0) {
+        SYSerr(SYS_F_IOCTL, errno);
+        return 0;
+    }
     return 1;
 }
 
+static int devcrypto_test_digest(size_t digest_data_index)
+{
+    struct session_op sess1, sess2;
+    struct cphash_op cphash;
+    int ret=0;
+
+    memset(&amp;sess1, 0, sizeof(sess1));
+    memset(&amp;sess2, 0, sizeof(sess2));
+    sess1.mac = digest_data[digest_data_index].devcryptoid;
+    if (ioctl(cfd, CIOCGSESSION, &amp;sess1) &lt; 0)
+        return 0;
+    /* Make sure the driver is capable of hash state copy */
+    sess2.mac = sess1.mac;
+    if (ioctl(cfd, CIOCGSESSION, &amp;sess2) &gt;= 0) {
+        cphash.src_ses = sess1.ses;
+        cphash.dst_ses = sess2.ses;
+        if (ioctl(cfd, CIOCCPHASH, &amp;cphash) &gt;= 0)
+            ret = 1;
+        ioctl(cfd, CIOCFSESSION, &amp;sess2.ses);
+    }
+    ioctl(cfd, CIOCFSESSION, &amp;sess1.ses);
+    return ret;
+}
+
 /*
  * Keep a table of known nids and associated methods.
  * Note that known_digest_nids[] isn't necessarily indexed the same way as
@@ -510,20 +637,14 @@ static EVP_MD *known_digest_methods[OSSL_NELEM(digest_data)] = { NULL, };
 static void prepare_digest_methods(void)
 {
     size_t i;
-    struct session_op sess;
-
-    memset(&amp;sess, 0, sizeof(sess));
 
     for (i = 0, known_digest_nids_amount = 0; i &lt; OSSL_NELEM(digest_data);
          i++) {
 
         /*
-         * Check that the algo is really availably by trying to open and close
-         * a session.
+         * Check that the algo is usable
          */
-        sess.mac = digest_data[i].devcryptoid;
-        if (ioctl(cfd, CIOCGSESSION, &amp;sess) &lt; 0
-            || ioctl(cfd, CIOCFSESSION, &amp;sess.ses) &lt; 0)
+        if (!devcrypto_test_digest(i))
             continue;
 
         if ((known_digest_methods[i] = EVP_MD_meth_new(digest_data[i].nid,
@@ -619,11 +740,6 @@ void engine_load_devcrypto_int()
         return;
     }
 
-    prepare_cipher_methods();
-#ifdef IMPLEMENT_DIGEST
-    prepare_digest_methods();
-#endif
-
     if ((e = ENGINE_new()) == NULL
         || !ENGINE_set_destroy_function(e, devcrypto_unload)) {
         ENGINE_free(e);
@@ -636,6 +752,11 @@ void engine_load_devcrypto_int()
         return;
     }
 
+    prepare_cipher_methods();
+#ifdef IMPLEMENT_DIGEST
+    prepare_digest_methods();
+#endif
+
     if (!ENGINE_set_id(e, &quot;devcrypto&quot;)
         || !ENGINE_set_name(e, &quot;/dev/crypto engine&quot;)
 
</PRE>





































<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="021065.html">[openssl-commits] [openssl]  OpenSSL_1_1_1-stable update
</A></li>
	<LI>Next message: <A HREF="021075.html">[openssl-commits] [openssl]  OpenSSL_1_1_1-stable update
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#21067">[ date ]</a>
              <a href="thread.html#21067">[ thread ]</a>
              <a href="subject.html#21067">[ subject ]</a>
              <a href="author.html#21067">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="../../../mailman/listinfo/openssl-commits.html">More information about the openssl-commits
mailing list</a><br>
</body></html>
