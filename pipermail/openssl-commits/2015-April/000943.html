<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [openssl-commits] [openssl]  master update
   </TITLE>
   <LINK REL="Index" HREF="https://mta.openssl.org/pipermail/openssl-commits/2015-April/index.html" >
   <LINK REL="made" HREF="mailto:openssl-commits%40openssl.org?Subject=Re%3A%20%5Bopenssl-commits%5D%20%5Bopenssl%5D%20%20master%20update&In-Reply-To=%3C1429903662.646479.24393.nullmailer%40dev.openssl.org%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000942.html">
   <LINK REL="Next"  HREF="000944.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[openssl-commits] [openssl]  master update</H1>
    <B>Rich Salz</B> 
    <A HREF="mailto:openssl-commits%40openssl.org?Subject=Re%3A%20%5Bopenssl-commits%5D%20%5Bopenssl%5D%20%20master%20update&In-Reply-To=%3C1429903662.646479.24393.nullmailer%40dev.openssl.org%3E"
       TITLE="[openssl-commits] [openssl]  master update">rsalz at openssl.org
       </A><BR>
    <I>Fri Apr 24 19:27:42 UTC 2015</I>
    <P><UL>
        <LI>Previous message: <A HREF="000942.html">[openssl-commits] [openssl]  master update
</A></li>
        <LI>Next message: <A HREF="000944.html">[openssl-commits] [openssl]  master update
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#943">[ date ]</a>
              <a href="thread.html#943">[ thread ]</a>
              <a href="subject.html#943">[ subject ]</a>
              <a href="author.html#943">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>The branch master has been updated
       via  7e1b7485706c2b11091b5fa897fe496a2faa56cc (commit)
      from  53dd4ddf71ad79a64be934ca19445b1cf560adab (commit)


- Log -----------------------------------------------------------------
commit 7e1b7485706c2b11091b5fa897fe496a2faa56cc
Author: Rich Salz &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">rsalz at openssl.org</A>&gt;
Date:   Fri Apr 24 15:26:15 2015 -0400

    Big apps cleanup (option-parsing, etc)
    
    This is merges the old &quot;rsalz-monolith&quot; branch over to master.  The biggest
    change is that option parsing switch from cascasding 'else if strcmp(&quot;-foo&quot;)'
    to a utility routine and somethin akin to getopt.  Also, an error in the
    command line no longer prints the full summary; use -help (or --help :)
    for that.  There have been many other changes and code-cleanup, see
    bullet list below.
    
    Special thanks to Matt for the long and detailed code review.
    
    TEMPORARY:
            For now, comment out CRYPTO_mem_leaks() at end of main
    
    Tickets closed:
            RT3515: Use 3DES in pkcs12 if built with no-rc2
            RT1766: s_client -reconnect and -starttls broke
            RT2932: Catch write errors
            RT2604: port should be 'unsigned short'
            RT2983: total_bytes undeclared #ifdef RENEG
            RT1523: Add -nocert to fix output in x509 app
            RT3508: Remove unused variable introduced by b09eb24
            RT3511: doc fix; req default serial is random
            RT1325,2973: Add more extensions to c_rehash
            RT2119,3407: Updated to dgst.pod
            RT2379: Additional typo fix
            RT2693: Extra include of string.h
            RT2880: HFS is case-insensitive filenames
            RT3246: req command prints version number wrong
    
    Other changes; incompatibilities marked with *:
            Add SCSV support
            Add -misalign to speed command
            Make dhparam, dsaparam, ecparam, x509 output C in proper style
            Make some internal ocsp.c functions void
            Only display cert usages with -help in verify
            Use global bio_err, remove &quot;BIO*err&quot; parameter from functions
            For filenames, - always means stdin (or stdout as appropriate)
            Add aliases for -des/aes &quot;wrap&quot; ciphers.
            *Remove support for IISSGC (server gated crypto)
            *The undocumented OCSP -header flag is now &quot;-header name=value&quot;
            *Documented the OCSP -header flag
    
    Reviewed-by: Matt Caswell &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">matt at openssl.org</A>&gt;

-----------------------------------------------------------------------

Summary of changes:
 apps/Makefile        |  264 +++++-----
 apps/app_rand.c      |   25 +-
 apps/apps.c          |  884 ++++++++------------------------
 apps/apps.h          |  362 ++++++++++----
 apps/asn1pars.c      |  269 ++++------
 apps/ca.c            | 1035 +++++++++++++++++---------------------
 apps/ciphers.c       |  163 +++---
 apps/cms.c           |  923 +++++++++++++++++-----------------
 apps/crl.c           |  317 +++++-------
 apps/crl2p7.c        |  183 +++----
 apps/dgst.c          |  370 ++++++--------
 apps/dh.c            |  325 ------------
 apps/dhparam.c       |  351 +++++--------
 apps/dsa.c           |  314 +++++-------
 apps/dsaparam.c      |  329 +++++-------
 apps/ec.c            |  311 +++++-------
 apps/ecparam.c       |  518 +++++++------------
 apps/enc.c           |  505 ++++++++-----------
 apps/engine.c        |  232 ++++-----
 apps/errstr.c        |   85 ++--
 apps/gendh.c         |  243 ---------
 apps/gendsa.c        |  223 +++------
 apps/genpkey.c       |  242 ++++-----
 apps/genrsa.c        |  250 +++-------
 apps/makeapps.com    |    2 +-
 apps/nseq.c          |  116 ++---
 apps/ocsp.c          |  929 ++++++++++++++--------------------
 apps/openssl.c       |  731 ++++++++++++++++-----------
 apps/opt.c           |  915 ++++++++++++++++++++++++++++++++++
 apps/passwd.c        |  326 ++++++------
 apps/pkcs12.c        |  710 ++++++++++----------------
 apps/pkcs7.c         |  257 +++++-----
 apps/pkcs8.c         |  307 +++++-------
 apps/pkey.c          |  220 ++++----
 apps/pkeyparam.c     |  143 ++----
 apps/pkeyutl.c       |  370 ++++++--------
 apps/prime.c         |  135 +++--
 apps/progs.h         |  417 +++++++++-------
 apps/progs.pl        |  161 +++---
 apps/rand.c          |  183 +++----
 apps/req.c           |  686 +++++++++++--------------
 apps/rsa.c           |  362 +++++++-------
 apps/rsautl.c        |  278 +++++------
 apps/s_apps.h        |   15 +-
 apps/s_cb.c          |  240 +++------
 apps/s_client.c      | 1356 ++++++++++++++++++++++++--------------------------
 apps/s_server.c      | 1211 +++++++++++++++++++++-----------------------
 apps/s_socket.c      |   70 ++-
 apps/s_time.c        |  414 ++++++---------
 apps/sess_id.c       |  185 +++----
 apps/smime.c         |  635 +++++++++++------------
 apps/speed.c         | 1253 ++++++++++++++++++----------------------------
 apps/spkac.c         |  237 ++++-----
 apps/srp.c           |  464 ++++++++---------
 apps/testdsa.h       |   53 +-
 apps/ts.c            |  442 ++++++++--------
 apps/verify.c        |  261 +++++-----
 apps/version.c       |   88 ++--
 apps/vms_decc_init.c |  104 +++-
 apps/winrand.c       |    1 -
 apps/x509.c          |  883 +++++++++++++++-----------------
 crypto/evp/c_allc.c  |    7 +
 ssl/ssl_conf.c       |    2 +
 util/indent.pro      |    2 +
 util/ssleay.num      |    2 +
 65 files changed, 10760 insertions(+), 13136 deletions(-)
 delete mode 100644 apps/dh.c
 delete mode 100644 apps/gendh.c
 create mode 100644 apps/opt.c

diff --git a/apps/Makefile b/apps/Makefile
index c7a6094..b6f7b2c 100644
--- a/apps/Makefile
+++ b/apps/Makefile
@@ -6,7 +6,7 @@ DIR=		apps
 TOP=		..
 CC=		cc
 INCLUDES=	-I$(TOP) -I../include $(KRB5_INCLUDES)
-CFLAG=		-g -static
+CFLAG=		-g -static -Wswitch
 MAKEFILE=	Makefile
 PERL=		perl
 RM=		rm -f
@@ -20,7 +20,7 @@ EXE_EXT=
 
 SHLIB_TARGET=
 
-CFLAGS= -DMONOLITH $(INCLUDES) $(CFLAG)
+CFLAGS= $(INCLUDES) $(CFLAG)
 
 GENERAL=Makefile makeapps.com install.com
 
@@ -29,49 +29,48 @@ DLIBSSL=../libssl.a
 LIBCRYPTO=-L.. -lcrypto
 LIBSSL=-L.. -lssl
 
-PROGRAM= openssl
-
 SCRIPTS=CA.pl tsget
+EXE= openssl$(EXE_EXT)
 
-EXE= $(PROGRAM)$(EXE_EXT)
-
-E_EXE=	verify asn1pars req dgst dh dhparam enc passwd gendh errstr \
-	ca crl rsa rsautl dsa dsaparam ec ecparam \
-	x509 genrsa gendsa genpkey s_server s_client speed \
-	s_time version pkcs7 cms crl2pkcs7 sess_id ciphers nseq pkcs12 \
-	pkcs8 pkey pkeyparam pkeyutl spkac smime rand engine ocsp prime ts srp
-
-PROGS= $(PROGRAM).c
+COMMANDS= \
+	asn1pars.o ca.o ciphers.o cms.o crl.o crl2p7.o dgst.o dhparam.o \
+	dsa.o dsaparam.o ec.o ecparam.o enc.o engine.o errstr.o gendsa.o \
+	genpkey.o genrsa.o nseq.o ocsp.o passwd.o pkcs12.o pkcs7.o pkcs8.o \
+	pkey.o pkeyparam.o pkeyutl.o prime.o rand.o req.o rsa.o rsautl.o \
+	s_client.o s_server.o s_time.o sess_id.o smime.o speed.o spkac.o \
+	srp.o ts.o verify.o version.o x509.o
 
-A_OBJ=apps.o
-A_SRC=apps.c
+A_OBJ=apps.o opt.o
+A_SRC=apps.c opt.c
 S_OBJ=	s_cb.o s_socket.o
 S_SRC=	s_cb.c s_socket.c
 RAND_OBJ=app_rand.o
 RAND_SRC=app_rand.c
 
-E_OBJ=	verify.o asn1pars.o req.o dgst.o dh.o dhparam.o enc.o passwd.o gendh.o errstr.o \
-	ca.o pkcs7.o crl2p7.o crl.o \
-	rsa.o rsautl.o dsa.o dsaparam.o ec.o ecparam.o \
-	x509.o genrsa.o gendsa.o genpkey.o s_server.o s_client.o speed.o \
-	s_time.o $(A_OBJ) $(S_OBJ) $(RAND_OBJ) version.o sess_id.o \
-	ciphers.o nseq.o pkcs12.o pkcs8.o pkey.o pkeyparam.o pkeyutl.o \
-	spkac.o smime.o cms.o rand.o engine.o ocsp.o prime.o ts.o srp.o
+OBJ	= \
+	asn1pars.o ca.o ciphers.o cms.o crl.o crl2p7.o dgst.o dhparam.o \
+	dsa.o dsaparam.o ec.o ecparam.o enc.o engine.o errstr.o gendsa.o \
+	genpkey.o genrsa.o nseq.o ocsp.o passwd.o pkcs12.o pkcs7.o pkcs8.o \
+	pkey.o pkeyparam.o pkeyutl.o prime.o rand.o req.o rsa.o rsautl.o \
+	s_client.o s_server.o s_time.o sess_id.o smime.o speed.o spkac.o \
+	srp.o ts.o verify.o version.o x509.o
 
-E_SRC=	verify.c asn1pars.c req.c dgst.c dh.c enc.c passwd.c gendh.c errstr.c ca.c \
-	pkcs7.c crl2p7.c crl.c \
-	rsa.c rsautl.c dsa.c dsaparam.c ec.c ecparam.c \
-	x509.c genrsa.c gendsa.c genpkey.c s_server.c s_client.c speed.c \
-	s_time.c $(A_SRC) $(S_SRC) $(RAND_SRC) version.c sess_id.c \
-	ciphers.c nseq.c pkcs12.c pkcs8.c pkey.c pkeyparam.c pkeyutl.c \
-	spkac.c smime.c cms.c rand.c engine.c ocsp.c prime.c ts.c srp.c
 
-SRC=$(E_SRC)
+SRC	= \
+	asn1pars.c ca.c ciphers.c cms.c crl.c crl2p7.c dgst.c dhparam.c \
+	dsa.c dsaparam.c ec.c ecparam.c enc.c engine.c errstr.c gendsa.c \
+	genpkey.c genrsa.c nseq.c ocsp.c passwd.c pkcs12.c pkcs7.c pkcs8.c \
+	pkey.c pkeyparam.c pkeyutl.c prime.c rand.c req.c rsa.c rsautl.c \
+	s_client.c s_server.c s_time.c sess_id.c smime.c speed.c spkac.c \
+	srp.c ts.c verify.c version.c x509.c
+
+EXE_OBJ	= openssl.o $(OBJ) $(A_OBJ) $(S_OBJ) $(RAND_OBJ)
+EXE_SRC = openssl.c $(SRC) $(A_SRC) $(S_SRC) $(RAND_SRC)
 
 HEADER=	apps.h progs.h s_apps.h \
-	testdsa.h testrsa.h
+	testdsa.h testrsa.h timeouts.h
 
-ALL=	$(GENERAL) $(SRC) $(HEADER)
+ALL=    $(GENERAL) $(EXE_SRC) $(HEADER)
 
 top:
 	@(cd ..; $(MAKE) DIRS=$(DIR) all)
@@ -80,18 +79,6 @@ all:	exe
 
 exe:	$(EXE)
 
-req: sreq.o $(A_OBJ) $(DLIBCRYPTO)
-	shlib_target=; if [ -n &quot;$(SHARED_LIBS)&quot; ]; then \
-		shlib_target=&quot;$(SHLIB_TARGET)&quot;; \
-	fi; \
-	$(MAKE) -f $(TOP)/Makefile.shared -e \
-		APPNAME=req OBJECTS=&quot;sreq.o $(A_OBJ) $(RAND_OBJ)&quot; \
-		LIBDEPS=&quot;$(PEX_LIBS) $(LIBCRYPTO) $(EX_LIBS)&quot; \
-		link_app.$${shlib_target}
-
-sreq.o: req.c 
-	$(CC) -c $(INCLUDES) $(CFLAG) -o sreq.o req.c
-
 files:
 	$(PERL) $(TOP)/util/files.pl Makefile &gt;&gt; $(TOP)/MINFO
 
@@ -129,18 +116,18 @@ uninstall:
 	$(RM) $(INSTALL_PREFIX)$(OPENSSLDIR)/openssl.cnf
 
 tags:
-	ctags $(SRC)
+	ctags $(EXE_SRC) $(HEADER)
 
 tests:
 
 lint:
-	lint -DLINT $(INCLUDES) $(SRC)&gt;fluff
+	echo nope &gt;fluff
 
 depend:
 	@if [ -z &quot;$(THIS)&quot; ]; then \
 	    $(MAKE) -f $(TOP)/Makefile reflect THIS=$@; \
 	else \
-	    $(MAKEDEPEND) -- $(CFLAG) $(INCLUDES) $(DEPFLAG) -- $(PROGS) $(SRC); \
+	    $(MAKEDEPEND) -- $(CFLAG) $(INCLUDES) $(DEPFLAG) -- $(EXE_SRC); \
 	fi
 
 dclean:
@@ -157,21 +144,22 @@ $(DLIBSSL):
 $(DLIBCRYPTO):
 	(cd ..; $(MAKE) DIRS=crypto all)
 
-$(EXE): progs.h $(E_OBJ) $(PROGRAM).o $(DLIBCRYPTO) $(DLIBSSL)
+$(EXE): progs.h $(EXE_OBJ) $(DLIBCRYPTO) $(DLIBSSL)
 	$(RM) $(EXE)
 	shlib_target=; if [ -n &quot;$(SHARED_LIBS)&quot; ]; then \
 		shlib_target=&quot;$(SHLIB_TARGET)&quot;; \
 	fi; \
 	LIBRARIES=&quot;$(LIBSSL) $(LIBKRB5) $(LIBCRYPTO)&quot; ; \
 	$(MAKE) -f $(TOP)/Makefile.shared -e \
-		APPNAME=$(EXE) OBJECTS=&quot;$(PROGRAM).o $(E_OBJ)&quot; \
+		APPNAME=$(EXE) OBJECTS=&quot;$(EXE_OBJ)&quot; \
 		LIBDEPS=&quot;$(PEX_LIBS) $$LIBRARIES $(EX_LIBS)&quot; \
 		link_app.$${shlib_target}
 	@(cd ..; $(MAKE) rehash)
 
-progs.h: progs.pl
-	$(PERL) progs.pl $(E_EXE) &gt;progs.h
-	$(RM) $(PROGRAM).o
+progs.h: progs.pl Makefile
+	$(RM) progs.h
+	$(PERL) progs.pl $(COMMANDS) &gt;progs.h
+	$(RM) openssl.o
 
 # DO NOT DELETE THIS LINE -- make depend depends on it.
 
@@ -189,24 +177,30 @@ app_rand.o: ../include/openssl/safestack.h ../include/openssl/sha.h
 app_rand.o: ../include/openssl/stack.h ../include/openssl/symhacks.h
 app_rand.o: ../include/openssl/txt_db.h ../include/openssl/x509.h
 app_rand.o: ../include/openssl/x509_vfy.h ../include/openssl/x509v3.h
-app_rand.o: app_rand.c apps.h
+app_rand.o: app_rand.c apps.h progs.h
 apps.o: ../e_os.h ../include/openssl/asn1.h ../include/openssl/bio.h
 apps.o: ../include/openssl/bn.h ../include/openssl/buffer.h
-apps.o: ../include/openssl/conf.h ../include/openssl/crypto.h
+apps.o: ../include/openssl/comp.h ../include/openssl/conf.h
+apps.o: ../include/openssl/crypto.h ../include/openssl/dtls1.h
 apps.o: ../include/openssl/e_os2.h ../include/openssl/ec.h
 apps.o: ../include/openssl/ecdh.h ../include/openssl/ecdsa.h
 apps.o: ../include/openssl/engine.h ../include/openssl/err.h
-apps.o: ../include/openssl/evp.h ../include/openssl/lhash.h
+apps.o: ../include/openssl/evp.h ../include/openssl/hmac.h
+apps.o: ../include/openssl/kssl.h ../include/openssl/lhash.h
 apps.o: ../include/openssl/obj_mac.h ../include/openssl/objects.h
 apps.o: ../include/openssl/ocsp.h ../include/openssl/opensslconf.h
 apps.o: ../include/openssl/opensslv.h ../include/openssl/ossl_typ.h
 apps.o: ../include/openssl/pem.h ../include/openssl/pem2.h
 apps.o: ../include/openssl/pkcs12.h ../include/openssl/pkcs7.h
-apps.o: ../include/openssl/rsa.h ../include/openssl/safestack.h
-apps.o: ../include/openssl/sha.h ../include/openssl/stack.h
-apps.o: ../include/openssl/symhacks.h ../include/openssl/txt_db.h
-apps.o: ../include/openssl/ui.h ../include/openssl/x509.h
-apps.o: ../include/openssl/x509_vfy.h ../include/openssl/x509v3.h apps.c apps.h
+apps.o: ../include/openssl/pqueue.h ../include/openssl/rsa.h
+apps.o: ../include/openssl/safestack.h ../include/openssl/sha.h
+apps.o: ../include/openssl/srtp.h ../include/openssl/ssl.h
+apps.o: ../include/openssl/ssl2.h ../include/openssl/ssl23.h
+apps.o: ../include/openssl/ssl3.h ../include/openssl/stack.h
+apps.o: ../include/openssl/symhacks.h ../include/openssl/tls1.h
+apps.o: ../include/openssl/txt_db.h ../include/openssl/ui.h
+apps.o: ../include/openssl/x509.h ../include/openssl/x509_vfy.h
+apps.o: ../include/openssl/x509v3.h apps.c apps.h progs.h
 asn1pars.o: ../e_os.h ../include/openssl/asn1.h ../include/openssl/bio.h
 asn1pars.o: ../include/openssl/buffer.h ../include/openssl/conf.h
 asn1pars.o: ../include/openssl/crypto.h ../include/openssl/e_os2.h
@@ -222,7 +216,7 @@ asn1pars.o: ../include/openssl/safestack.h ../include/openssl/sha.h
 asn1pars.o: ../include/openssl/stack.h ../include/openssl/symhacks.h
 asn1pars.o: ../include/openssl/txt_db.h ../include/openssl/x509.h
 asn1pars.o: ../include/openssl/x509_vfy.h ../include/openssl/x509v3.h apps.h
-asn1pars.o: asn1pars.c
+asn1pars.o: asn1pars.c progs.h
 ca.o: ../e_os.h ../include/openssl/asn1.h ../include/openssl/bio.h
 ca.o: ../include/openssl/bn.h ../include/openssl/buffer.h
 ca.o: ../include/openssl/conf.h ../include/openssl/crypto.h
@@ -238,7 +232,7 @@ ca.o: ../include/openssl/pkcs7.h ../include/openssl/safestack.h
 ca.o: ../include/openssl/sha.h ../include/openssl/stack.h
 ca.o: ../include/openssl/symhacks.h ../include/openssl/txt_db.h
 ca.o: ../include/openssl/x509.h ../include/openssl/x509_vfy.h
-ca.o: ../include/openssl/x509v3.h apps.h ca.c
+ca.o: ../include/openssl/x509v3.h apps.h ca.c progs.h
 ciphers.o: ../e_os.h ../include/openssl/asn1.h ../include/openssl/bio.h
 ciphers.o: ../include/openssl/buffer.h ../include/openssl/comp.h
 ciphers.o: ../include/openssl/conf.h ../include/openssl/crypto.h
@@ -259,7 +253,7 @@ ciphers.o: ../include/openssl/ssl23.h ../include/openssl/ssl3.h
 ciphers.o: ../include/openssl/stack.h ../include/openssl/symhacks.h
 ciphers.o: ../include/openssl/tls1.h ../include/openssl/txt_db.h
 ciphers.o: ../include/openssl/x509.h ../include/openssl/x509_vfy.h
-ciphers.o: ../include/openssl/x509v3.h apps.h ciphers.c
+ciphers.o: ../include/openssl/x509v3.h apps.h ciphers.c progs.h
 cms.o: ../e_os.h ../include/openssl/asn1.h ../include/openssl/bio.h
 cms.o: ../include/openssl/buffer.h ../include/openssl/cms.h
 cms.o: ../include/openssl/conf.h ../include/openssl/crypto.h
@@ -275,7 +269,7 @@ cms.o: ../include/openssl/pkcs7.h ../include/openssl/safestack.h
 cms.o: ../include/openssl/sha.h ../include/openssl/stack.h
 cms.o: ../include/openssl/symhacks.h ../include/openssl/txt_db.h
 cms.o: ../include/openssl/x509.h ../include/openssl/x509_vfy.h
-cms.o: ../include/openssl/x509v3.h apps.h cms.c
+cms.o: ../include/openssl/x509v3.h apps.h cms.c progs.h
 crl.o: ../e_os.h ../include/openssl/asn1.h ../include/openssl/bio.h
 crl.o: ../include/openssl/buffer.h ../include/openssl/conf.h
 crl.o: ../include/openssl/crypto.h ../include/openssl/e_os2.h
@@ -291,6 +285,7 @@ crl.o: ../include/openssl/safestack.h ../include/openssl/sha.h
 crl.o: ../include/openssl/stack.h ../include/openssl/symhacks.h
 crl.o: ../include/openssl/txt_db.h ../include/openssl/x509.h
 crl.o: ../include/openssl/x509_vfy.h ../include/openssl/x509v3.h apps.h crl.c
+crl.o: progs.h
 crl2p7.o: ../e_os.h ../include/openssl/asn1.h ../include/openssl/bio.h
 crl2p7.o: ../include/openssl/buffer.h ../include/openssl/conf.h
 crl2p7.o: ../include/openssl/crypto.h ../include/openssl/e_os2.h
@@ -306,7 +301,7 @@ crl2p7.o: ../include/openssl/safestack.h ../include/openssl/sha.h
 crl2p7.o: ../include/openssl/stack.h ../include/openssl/symhacks.h
 crl2p7.o: ../include/openssl/txt_db.h ../include/openssl/x509.h
 crl2p7.o: ../include/openssl/x509_vfy.h ../include/openssl/x509v3.h apps.h
-crl2p7.o: crl2p7.c
+crl2p7.o: crl2p7.c progs.h
 dgst.o: ../e_os.h ../include/openssl/asn1.h ../include/openssl/bio.h
 dgst.o: ../include/openssl/buffer.h ../include/openssl/conf.h
 dgst.o: ../include/openssl/crypto.h ../include/openssl/e_os2.h
@@ -322,23 +317,24 @@ dgst.o: ../include/openssl/pkcs7.h ../include/openssl/safestack.h
 dgst.o: ../include/openssl/sha.h ../include/openssl/stack.h
 dgst.o: ../include/openssl/symhacks.h ../include/openssl/txt_db.h
 dgst.o: ../include/openssl/x509.h ../include/openssl/x509_vfy.h
-dgst.o: ../include/openssl/x509v3.h apps.h dgst.c
-dh.o: ../e_os.h ../include/openssl/asn1.h ../include/openssl/bio.h
-dh.o: ../include/openssl/bn.h ../include/openssl/buffer.h
-dh.o: ../include/openssl/conf.h ../include/openssl/crypto.h
-dh.o: ../include/openssl/dh.h ../include/openssl/e_os2.h
-dh.o: ../include/openssl/ec.h ../include/openssl/ecdh.h
-dh.o: ../include/openssl/ecdsa.h ../include/openssl/engine.h
-dh.o: ../include/openssl/err.h ../include/openssl/evp.h
-dh.o: ../include/openssl/lhash.h ../include/openssl/obj_mac.h
-dh.o: ../include/openssl/objects.h ../include/openssl/ocsp.h
-dh.o: ../include/openssl/opensslconf.h ../include/openssl/opensslv.h
-dh.o: ../include/openssl/ossl_typ.h ../include/openssl/pem.h
-dh.o: ../include/openssl/pem2.h ../include/openssl/pkcs7.h
-dh.o: ../include/openssl/safestack.h ../include/openssl/sha.h
-dh.o: ../include/openssl/stack.h ../include/openssl/symhacks.h
-dh.o: ../include/openssl/txt_db.h ../include/openssl/x509.h
-dh.o: ../include/openssl/x509_vfy.h ../include/openssl/x509v3.h apps.h dh.c
+dgst.o: ../include/openssl/x509v3.h apps.h dgst.c progs.h
+dhparam.o: ../e_os.h ../include/openssl/asn1.h ../include/openssl/bio.h
+dhparam.o: ../include/openssl/bn.h ../include/openssl/buffer.h
+dhparam.o: ../include/openssl/conf.h ../include/openssl/crypto.h
+dhparam.o: ../include/openssl/dh.h ../include/openssl/dsa.h
+dhparam.o: ../include/openssl/e_os2.h ../include/openssl/ec.h
+dhparam.o: ../include/openssl/ecdh.h ../include/openssl/ecdsa.h
+dhparam.o: ../include/openssl/engine.h ../include/openssl/err.h
+dhparam.o: ../include/openssl/evp.h ../include/openssl/lhash.h
+dhparam.o: ../include/openssl/obj_mac.h ../include/openssl/objects.h
+dhparam.o: ../include/openssl/ocsp.h ../include/openssl/opensslconf.h
+dhparam.o: ../include/openssl/opensslv.h ../include/openssl/ossl_typ.h
+dhparam.o: ../include/openssl/pem.h ../include/openssl/pem2.h
+dhparam.o: ../include/openssl/pkcs7.h ../include/openssl/safestack.h
+dhparam.o: ../include/openssl/sha.h ../include/openssl/stack.h
+dhparam.o: ../include/openssl/symhacks.h ../include/openssl/txt_db.h
+dhparam.o: ../include/openssl/x509.h ../include/openssl/x509_vfy.h
+dhparam.o: ../include/openssl/x509v3.h apps.h dhparam.c progs.h
 dsa.o: ../e_os.h ../include/openssl/asn1.h ../include/openssl/bio.h
 dsa.o: ../include/openssl/bn.h ../include/openssl/buffer.h
 dsa.o: ../include/openssl/conf.h ../include/openssl/crypto.h
@@ -355,6 +351,7 @@ dsa.o: ../include/openssl/safestack.h ../include/openssl/sha.h
 dsa.o: ../include/openssl/stack.h ../include/openssl/symhacks.h
 dsa.o: ../include/openssl/txt_db.h ../include/openssl/x509.h
 dsa.o: ../include/openssl/x509_vfy.h ../include/openssl/x509v3.h apps.h dsa.c
+dsa.o: progs.h
 dsaparam.o: ../e_os.h ../include/openssl/asn1.h ../include/openssl/bio.h
 dsaparam.o: ../include/openssl/bn.h ../include/openssl/buffer.h
 dsaparam.o: ../include/openssl/conf.h ../include/openssl/crypto.h
@@ -371,7 +368,7 @@ dsaparam.o: ../include/openssl/safestack.h ../include/openssl/sha.h
 dsaparam.o: ../include/openssl/stack.h ../include/openssl/symhacks.h
 dsaparam.o: ../include/openssl/txt_db.h ../include/openssl/x509.h
 dsaparam.o: ../include/openssl/x509_vfy.h ../include/openssl/x509v3.h apps.h
-dsaparam.o: dsaparam.c
+dsaparam.o: dsaparam.c progs.h
 ec.o: ../e_os.h ../include/openssl/asn1.h ../include/openssl/bio.h
 ec.o: ../include/openssl/buffer.h ../include/openssl/conf.h
 ec.o: ../include/openssl/crypto.h ../include/openssl/e_os2.h
@@ -387,6 +384,7 @@ ec.o: ../include/openssl/safestack.h ../include/openssl/sha.h
 ec.o: ../include/openssl/stack.h ../include/openssl/symhacks.h
 ec.o: ../include/openssl/txt_db.h ../include/openssl/x509.h
 ec.o: ../include/openssl/x509_vfy.h ../include/openssl/x509v3.h apps.h ec.c
+ec.o: progs.h
 ecparam.o: ../e_os.h ../include/openssl/asn1.h ../include/openssl/bio.h
 ecparam.o: ../include/openssl/bn.h ../include/openssl/buffer.h
 ecparam.o: ../include/openssl/conf.h ../include/openssl/crypto.h
@@ -402,7 +400,7 @@ ecparam.o: ../include/openssl/pkcs7.h ../include/openssl/safestack.h
 ecparam.o: ../include/openssl/sha.h ../include/openssl/stack.h
 ecparam.o: ../include/openssl/symhacks.h ../include/openssl/txt_db.h
 ecparam.o: ../include/openssl/x509.h ../include/openssl/x509_vfy.h
-ecparam.o: ../include/openssl/x509v3.h apps.h ecparam.c
+ecparam.o: ../include/openssl/x509v3.h apps.h ecparam.c progs.h
 enc.o: ../e_os.h ../include/openssl/asn1.h ../include/openssl/bio.h
 enc.o: ../include/openssl/buffer.h ../include/openssl/comp.h
 enc.o: ../include/openssl/conf.h ../include/openssl/crypto.h
@@ -419,6 +417,7 @@ enc.o: ../include/openssl/safestack.h ../include/openssl/sha.h
 enc.o: ../include/openssl/stack.h ../include/openssl/symhacks.h
 enc.o: ../include/openssl/txt_db.h ../include/openssl/x509.h
 enc.o: ../include/openssl/x509_vfy.h ../include/openssl/x509v3.h apps.h enc.c
+enc.o: progs.h
 engine.o: ../e_os.h ../include/openssl/asn1.h ../include/openssl/bio.h
 engine.o: ../include/openssl/buffer.h ../include/openssl/comp.h
 engine.o: ../include/openssl/conf.h ../include/openssl/crypto.h
@@ -439,7 +438,7 @@ engine.o: ../include/openssl/ssl23.h ../include/openssl/ssl3.h
 engine.o: ../include/openssl/stack.h ../include/openssl/symhacks.h
 engine.o: ../include/openssl/tls1.h ../include/openssl/txt_db.h
 engine.o: ../include/openssl/x509.h ../include/openssl/x509_vfy.h
-engine.o: ../include/openssl/x509v3.h apps.h engine.c
+engine.o: ../include/openssl/x509v3.h apps.h engine.c progs.h
 errstr.o: ../e_os.h ../include/openssl/asn1.h ../include/openssl/bio.h
 errstr.o: ../include/openssl/buffer.h ../include/openssl/comp.h
 errstr.o: ../include/openssl/conf.h ../include/openssl/crypto.h
@@ -460,24 +459,7 @@ errstr.o: ../include/openssl/ssl23.h ../include/openssl/ssl3.h
 errstr.o: ../include/openssl/stack.h ../include/openssl/symhacks.h
 errstr.o: ../include/openssl/tls1.h ../include/openssl/txt_db.h
 errstr.o: ../include/openssl/x509.h ../include/openssl/x509_vfy.h
-errstr.o: ../include/openssl/x509v3.h apps.h errstr.c
-gendh.o: ../e_os.h ../include/openssl/asn1.h ../include/openssl/bio.h
-gendh.o: ../include/openssl/bn.h ../include/openssl/buffer.h
-gendh.o: ../include/openssl/conf.h ../include/openssl/crypto.h
-gendh.o: ../include/openssl/dh.h ../include/openssl/e_os2.h
-gendh.o: ../include/openssl/ec.h ../include/openssl/ecdh.h
-gendh.o: ../include/openssl/ecdsa.h ../include/openssl/engine.h
-gendh.o: ../include/openssl/err.h ../include/openssl/evp.h
-gendh.o: ../include/openssl/lhash.h ../include/openssl/obj_mac.h
-gendh.o: ../include/openssl/objects.h ../include/openssl/ocsp.h
-gendh.o: ../include/openssl/opensslconf.h ../include/openssl/opensslv.h
-gendh.o: ../include/openssl/ossl_typ.h ../include/openssl/pem.h
-gendh.o: ../include/openssl/pem2.h ../include/openssl/pkcs7.h
-gendh.o: ../include/openssl/rand.h ../include/openssl/safestack.h
-gendh.o: ../include/openssl/sha.h ../include/openssl/stack.h
-gendh.o: ../include/openssl/symhacks.h ../include/openssl/txt_db.h
-gendh.o: ../include/openssl/x509.h ../include/openssl/x509_vfy.h
-gendh.o: ../include/openssl/x509v3.h apps.h gendh.c
+errstr.o: ../include/openssl/x509v3.h apps.h errstr.c progs.h
 gendsa.o: ../e_os.h ../include/openssl/asn1.h ../include/openssl/bio.h
 gendsa.o: ../include/openssl/bn.h ../include/openssl/buffer.h
 gendsa.o: ../include/openssl/conf.h ../include/openssl/crypto.h
@@ -494,7 +476,7 @@ gendsa.o: ../include/openssl/safestack.h ../include/openssl/sha.h
 gendsa.o: ../include/openssl/stack.h ../include/openssl/symhacks.h
 gendsa.o: ../include/openssl/txt_db.h ../include/openssl/x509.h
 gendsa.o: ../include/openssl/x509_vfy.h ../include/openssl/x509v3.h apps.h
-gendsa.o: gendsa.c
+gendsa.o: gendsa.c progs.h
 genpkey.o: ../e_os.h ../include/openssl/asn1.h ../include/openssl/bio.h
 genpkey.o: ../include/openssl/buffer.h ../include/openssl/conf.h
 genpkey.o: ../include/openssl/crypto.h ../include/openssl/e_os2.h
@@ -510,7 +492,7 @@ genpkey.o: ../include/openssl/safestack.h ../include/openssl/sha.h
 genpkey.o: ../include/openssl/stack.h ../include/openssl/symhacks.h
 genpkey.o: ../include/openssl/txt_db.h ../include/openssl/x509.h
 genpkey.o: ../include/openssl/x509_vfy.h ../include/openssl/x509v3.h apps.h
-genpkey.o: genpkey.c
+genpkey.o: genpkey.c progs.h
 genrsa.o: ../e_os.h ../include/openssl/asn1.h ../include/openssl/bio.h
 genrsa.o: ../include/openssl/bn.h ../include/openssl/buffer.h
 genrsa.o: ../include/openssl/conf.h ../include/openssl/crypto.h
@@ -527,7 +509,7 @@ genrsa.o: ../include/openssl/rsa.h ../include/openssl/safestack.h
 genrsa.o: ../include/openssl/sha.h ../include/openssl/stack.h
 genrsa.o: ../include/openssl/symhacks.h ../include/openssl/txt_db.h
 genrsa.o: ../include/openssl/x509.h ../include/openssl/x509_vfy.h
-genrsa.o: ../include/openssl/x509v3.h apps.h genrsa.c
+genrsa.o: ../include/openssl/x509v3.h apps.h genrsa.c progs.h
 nseq.o: ../e_os.h ../include/openssl/asn1.h ../include/openssl/bio.h
 nseq.o: ../include/openssl/buffer.h ../include/openssl/conf.h
 nseq.o: ../include/openssl/crypto.h ../include/openssl/e_os2.h
@@ -543,6 +525,7 @@ nseq.o: ../include/openssl/safestack.h ../include/openssl/sha.h
 nseq.o: ../include/openssl/stack.h ../include/openssl/symhacks.h
 nseq.o: ../include/openssl/txt_db.h ../include/openssl/x509.h
 nseq.o: ../include/openssl/x509_vfy.h ../include/openssl/x509v3.h apps.h nseq.c
+nseq.o: progs.h
 ocsp.o: ../e_os.h ../include/openssl/asn1.h ../include/openssl/bio.h
 ocsp.o: ../include/openssl/bn.h ../include/openssl/buffer.h
 ocsp.o: ../include/openssl/comp.h ../include/openssl/conf.h
@@ -564,6 +547,7 @@ ocsp.o: ../include/openssl/ssl3.h ../include/openssl/stack.h
 ocsp.o: ../include/openssl/symhacks.h ../include/openssl/tls1.h
 ocsp.o: ../include/openssl/txt_db.h ../include/openssl/x509.h
 ocsp.o: ../include/openssl/x509_vfy.h ../include/openssl/x509v3.h apps.h ocsp.c
+ocsp.o: progs.h
 openssl.o: ../e_os.h ../include/openssl/asn1.h ../include/openssl/bio.h
 openssl.o: ../include/openssl/buffer.h ../include/openssl/comp.h
 openssl.o: ../include/openssl/conf.h ../include/openssl/crypto.h
@@ -586,6 +570,20 @@ openssl.o: ../include/openssl/symhacks.h ../include/openssl/tls1.h
 openssl.o: ../include/openssl/txt_db.h ../include/openssl/x509.h
 openssl.o: ../include/openssl/x509_vfy.h ../include/openssl/x509v3.h apps.h
 openssl.o: openssl.c progs.h s_apps.h
+opt.o: ../e_os.h ../include/openssl/asn1.h ../include/openssl/bio.h
+opt.o: ../include/openssl/buffer.h ../include/openssl/conf.h
+opt.o: ../include/openssl/crypto.h ../include/openssl/e_os2.h
+opt.o: ../include/openssl/ec.h ../include/openssl/ecdh.h
+opt.o: ../include/openssl/ecdsa.h ../include/openssl/engine.h
+opt.o: ../include/openssl/evp.h ../include/openssl/lhash.h
+opt.o: ../include/openssl/obj_mac.h ../include/openssl/objects.h
+opt.o: ../include/openssl/ocsp.h ../include/openssl/opensslconf.h
+opt.o: ../include/openssl/opensslv.h ../include/openssl/ossl_typ.h
+opt.o: ../include/openssl/pkcs7.h ../include/openssl/safestack.h
+opt.o: ../include/openssl/sha.h ../include/openssl/stack.h
+opt.o: ../include/openssl/symhacks.h ../include/openssl/txt_db.h
+opt.o: ../include/openssl/x509.h ../include/openssl/x509_vfy.h
+opt.o: ../include/openssl/x509v3.h apps.h opt.c progs.h
 passwd.o: ../e_os.h ../include/openssl/asn1.h ../include/openssl/bio.h
 passwd.o: ../include/openssl/buffer.h ../include/openssl/conf.h
 passwd.o: ../include/openssl/crypto.h ../include/openssl/des.h
@@ -601,7 +599,7 @@ passwd.o: ../include/openssl/rand.h ../include/openssl/safestack.h
 passwd.o: ../include/openssl/sha.h ../include/openssl/stack.h
 passwd.o: ../include/openssl/symhacks.h ../include/openssl/txt_db.h
 passwd.o: ../include/openssl/x509.h ../include/openssl/x509_vfy.h
-passwd.o: ../include/openssl/x509v3.h apps.h passwd.c
+passwd.o: ../include/openssl/x509v3.h apps.h passwd.c progs.h
 pkcs12.o: ../e_os.h ../include/openssl/asn1.h ../include/openssl/bio.h
 pkcs12.o: ../include/openssl/buffer.h ../include/openssl/conf.h
 pkcs12.o: ../include/openssl/crypto.h ../include/openssl/e_os2.h
@@ -617,7 +615,7 @@ pkcs12.o: ../include/openssl/pkcs7.h ../include/openssl/safestack.h
 pkcs12.o: ../include/openssl/sha.h ../include/openssl/stack.h
 pkcs12.o: ../include/openssl/symhacks.h ../include/openssl/txt_db.h
 pkcs12.o: ../include/openssl/x509.h ../include/openssl/x509_vfy.h
-pkcs12.o: ../include/openssl/x509v3.h apps.h pkcs12.c
+pkcs12.o: ../include/openssl/x509v3.h apps.h pkcs12.c progs.h
 pkcs7.o: ../e_os.h ../include/openssl/asn1.h ../include/openssl/bio.h
 pkcs7.o: ../include/openssl/buffer.h ../include/openssl/conf.h
 pkcs7.o: ../include/openssl/crypto.h ../include/openssl/e_os2.h
@@ -633,7 +631,7 @@ pkcs7.o: ../include/openssl/safestack.h ../include/openssl/sha.h
 pkcs7.o: ../include/openssl/stack.h ../include/openssl/symhacks.h
 pkcs7.o: ../include/openssl/txt_db.h ../include/openssl/x509.h
 pkcs7.o: ../include/openssl/x509_vfy.h ../include/openssl/x509v3.h apps.h
-pkcs7.o: pkcs7.c
+pkcs7.o: pkcs7.c progs.h
 pkcs8.o: ../e_os.h ../include/openssl/asn1.h ../include/openssl/bio.h
 pkcs8.o: ../include/openssl/buffer.h ../include/openssl/conf.h
 pkcs8.o: ../include/openssl/crypto.h ../include/openssl/e_os2.h
@@ -649,7 +647,7 @@ pkcs8.o: ../include/openssl/pkcs7.h ../include/openssl/safestack.h
 pkcs8.o: ../include/openssl/sha.h ../include/openssl/stack.h
 pkcs8.o: ../include/openssl/symhacks.h ../include/openssl/txt_db.h
 pkcs8.o: ../include/openssl/x509.h ../include/openssl/x509_vfy.h
-pkcs8.o: ../include/openssl/x509v3.h apps.h pkcs8.c
+pkcs8.o: ../include/openssl/x509v3.h apps.h pkcs8.c progs.h
 pkey.o: ../e_os.h ../include/openssl/asn1.h ../include/openssl/bio.h
 pkey.o: ../include/openssl/buffer.h ../include/openssl/conf.h
 pkey.o: ../include/openssl/crypto.h ../include/openssl/e_os2.h
@@ -665,6 +663,7 @@ pkey.o: ../include/openssl/safestack.h ../include/openssl/sha.h
 pkey.o: ../include/openssl/stack.h ../include/openssl/symhacks.h
 pkey.o: ../include/openssl/txt_db.h ../include/openssl/x509.h
 pkey.o: ../include/openssl/x509_vfy.h ../include/openssl/x509v3.h apps.h pkey.c
+pkey.o: progs.h
 pkeyparam.o: ../e_os.h ../include/openssl/asn1.h ../include/openssl/bio.h
 pkeyparam.o: ../include/openssl/buffer.h ../include/openssl/conf.h
 pkeyparam.o: ../include/openssl/crypto.h ../include/openssl/e_os2.h
@@ -680,7 +679,7 @@ pkeyparam.o: ../include/openssl/safestack.h ../include/openssl/sha.h
 pkeyparam.o: ../include/openssl/stack.h ../include/openssl/symhacks.h
 pkeyparam.o: ../include/openssl/txt_db.h ../include/openssl/x509.h
 pkeyparam.o: ../include/openssl/x509_vfy.h ../include/openssl/x509v3.h apps.h
-pkeyparam.o: pkeyparam.c
+pkeyparam.o: pkeyparam.c progs.h
 pkeyutl.o: ../e_os.h ../include/openssl/asn1.h ../include/openssl/bio.h
 pkeyutl.o: ../include/openssl/buffer.h ../include/openssl/conf.h
 pkeyutl.o: ../include/openssl/crypto.h ../include/openssl/e_os2.h
@@ -696,7 +695,7 @@ pkeyutl.o: ../include/openssl/safestack.h ../include/openssl/sha.h
 pkeyutl.o: ../include/openssl/stack.h ../include/openssl/symhacks.h
 pkeyutl.o: ../include/openssl/txt_db.h ../include/openssl/x509.h
 pkeyutl.o: ../include/openssl/x509_vfy.h ../include/openssl/x509v3.h apps.h
-pkeyutl.o: pkeyutl.c
+pkeyutl.o: pkeyutl.c progs.h
 prime.o: ../e_os.h ../include/openssl/asn1.h ../include/openssl/bio.h
 prime.o: ../include/openssl/bn.h ../include/openssl/buffer.h
 prime.o: ../include/openssl/conf.h ../include/openssl/crypto.h
@@ -711,7 +710,7 @@ prime.o: ../include/openssl/safestack.h ../include/openssl/sha.h
 prime.o: ../include/openssl/stack.h ../include/openssl/symhacks.h
 prime.o: ../include/openssl/txt_db.h ../include/openssl/x509.h
 prime.o: ../include/openssl/x509_vfy.h ../include/openssl/x509v3.h apps.h
-prime.o: prime.c
+prime.o: prime.c progs.h
 rand.o: ../e_os.h ../include/openssl/asn1.h ../include/openssl/bio.h
 rand.o: ../include/openssl/buffer.h ../include/openssl/conf.h
 rand.o: ../include/openssl/crypto.h ../include/openssl/e_os2.h
@@ -726,7 +725,7 @@ rand.o: ../include/openssl/rand.h ../include/openssl/safestack.h
 rand.o: ../include/openssl/sha.h ../include/openssl/stack.h
 rand.o: ../include/openssl/symhacks.h ../include/openssl/txt_db.h
 rand.o: ../include/openssl/x509.h ../include/openssl/x509_vfy.h
-rand.o: ../include/openssl/x509v3.h apps.h rand.c
+rand.o: ../include/openssl/x509v3.h apps.h progs.h rand.c
 req.o: ../e_os.h ../include/openssl/asn1.h ../include/openssl/bio.h
 req.o: ../include/openssl/bn.h ../include/openssl/buffer.h
 req.o: ../include/openssl/conf.h ../include/openssl/crypto.h
@@ -743,7 +742,7 @@ req.o: ../include/openssl/rsa.h ../include/openssl/safestack.h
 req.o: ../include/openssl/sha.h ../include/openssl/stack.h
 req.o: ../include/openssl/symhacks.h ../include/openssl/txt_db.h
 req.o: ../include/openssl/x509.h ../include/openssl/x509_vfy.h
-req.o: ../include/openssl/x509v3.h apps.h req.c
+req.o: ../include/openssl/x509v3.h apps.h progs.h req.c
 rsa.o: ../e_os.h ../include/openssl/asn1.h ../include/openssl/bio.h
 rsa.o: ../include/openssl/bn.h ../include/openssl/buffer.h
 rsa.o: ../include/openssl/conf.h ../include/openssl/crypto.h
@@ -759,7 +758,8 @@ rsa.o: ../include/openssl/pkcs7.h ../include/openssl/rsa.h
 rsa.o: ../include/openssl/safestack.h ../include/openssl/sha.h
 rsa.o: ../include/openssl/stack.h ../include/openssl/symhacks.h
 rsa.o: ../include/openssl/txt_db.h ../include/openssl/x509.h
-rsa.o: ../include/openssl/x509_vfy.h ../include/openssl/x509v3.h apps.h rsa.c
+rsa.o: ../include/openssl/x509_vfy.h ../include/openssl/x509v3.h apps.h progs.h
+rsa.o: rsa.c
 rsautl.o: ../e_os.h ../include/openssl/asn1.h ../include/openssl/bio.h
 rsautl.o: ../include/openssl/buffer.h ../include/openssl/conf.h
 rsautl.o: ../include/openssl/crypto.h ../include/openssl/e_os2.h
@@ -775,7 +775,7 @@ rsautl.o: ../include/openssl/rsa.h ../include/openssl/safestack.h
 rsautl.o: ../include/openssl/sha.h ../include/openssl/stack.h
 rsautl.o: ../include/openssl/symhacks.h ../include/openssl/txt_db.h
 rsautl.o: ../include/openssl/x509.h ../include/openssl/x509_vfy.h
-rsautl.o: ../include/openssl/x509v3.h apps.h rsautl.c
+rsautl.o: ../include/openssl/x509v3.h apps.h progs.h rsautl.c
 s_cb.o: ../e_os.h ../include/openssl/asn1.h ../include/openssl/bio.h
 s_cb.o: ../include/openssl/bn.h ../include/openssl/buffer.h
 s_cb.o: ../include/openssl/comp.h ../include/openssl/conf.h
@@ -798,7 +798,7 @@ s_cb.o: ../include/openssl/ssl3.h ../include/openssl/stack.h
 s_cb.o: ../include/openssl/symhacks.h ../include/openssl/tls1.h
 s_cb.o: ../include/openssl/txt_db.h ../include/openssl/x509.h
 s_cb.o: ../include/openssl/x509_vfy.h ../include/openssl/x509v3.h apps.h
-s_cb.o: s_apps.h s_cb.c
+s_cb.o: progs.h s_apps.h s_cb.c
 s_client.o: ../e_os.h ../include/openssl/asn1.h ../include/openssl/bio.h
 s_client.o: ../include/openssl/bn.h ../include/openssl/buffer.h
 s_client.o: ../include/openssl/comp.h ../include/openssl/conf.h
@@ -821,7 +821,7 @@ s_client.o: ../include/openssl/ssl3.h ../include/openssl/stack.h
 s_client.o: ../include/openssl/symhacks.h ../include/openssl/tls1.h
 s_client.o: ../include/openssl/txt_db.h ../include/openssl/x509.h
 s_client.o: ../include/openssl/x509_vfy.h ../include/openssl/x509v3.h apps.h
-s_client.o: s_apps.h s_client.c timeouts.h
+s_client.o: progs.h s_apps.h s_client.c timeouts.h
 s_server.o: ../e_os.h ../include/openssl/asn1.h ../include/openssl/bio.h
 s_server.o: ../include/openssl/bn.h ../include/openssl/buffer.h
 s_server.o: ../include/openssl/comp.h ../include/openssl/conf.h
@@ -845,7 +845,7 @@ s_server.o: ../include/openssl/ssl3.h ../include/openssl/stack.h
 s_server.o: ../include/openssl/symhacks.h ../include/openssl/tls1.h
 s_server.o: ../include/openssl/txt_db.h ../include/openssl/x509.h
 s_server.o: ../include/openssl/x509_vfy.h ../include/openssl/x509v3.h apps.h
-s_server.o: s_apps.h s_server.c timeouts.h
+s_server.o: progs.h s_apps.h s_server.c timeouts.h
 s_socket.o: ../e_os.h ../include/openssl/asn1.h ../include/openssl/bio.h
 s_socket.o: ../include/openssl/buffer.h ../include/openssl/comp.h
 s_socket.o: ../include/openssl/conf.h ../include/openssl/crypto.h
@@ -866,7 +866,7 @@ s_socket.o: ../include/openssl/ssl3.h ../include/openssl/stack.h
 s_socket.o: ../include/openssl/symhacks.h ../include/openssl/tls1.h
 s_socket.o: ../include/openssl/txt_db.h ../include/openssl/x509.h
 s_socket.o: ../include/openssl/x509_vfy.h ../include/openssl/x509v3.h apps.h
-s_socket.o: s_apps.h s_socket.c
+s_socket.o: progs.h s_apps.h s_socket.c
 s_time.o: ../e_os.h ../include/openssl/asn1.h ../include/openssl/bio.h
 s_time.o: ../include/openssl/buffer.h ../include/openssl/comp.h
 s_time.o: ../include/openssl/conf.h ../include/openssl/crypto.h
@@ -887,7 +887,7 @@ s_time.o: ../include/openssl/ssl23.h ../include/openssl/ssl3.h
 s_time.o: ../include/openssl/stack.h ../include/openssl/symhacks.h
 s_time.o: ../include/openssl/tls1.h ../include/openssl/txt_db.h
 s_time.o: ../include/openssl/x509.h ../include/openssl/x509_vfy.h
-s_time.o: ../include/openssl/x509v3.h apps.h s_apps.h s_time.c
+s_time.o: ../include/openssl/x509v3.h apps.h progs.h s_apps.h s_time.c
 sess_id.o: ../e_os.h ../include/openssl/asn1.h ../include/openssl/bio.h
 sess_id.o: ../include/openssl/buffer.h ../include/openssl/comp.h
 sess_id.o: ../include/openssl/conf.h ../include/openssl/crypto.h
@@ -908,7 +908,7 @@ sess_id.o: ../include/openssl/ssl23.h ../include/openssl/ssl3.h
 sess_id.o: ../include/openssl/stack.h ../include/openssl/symhacks.h
 sess_id.o: ../include/openssl/tls1.h ../include/openssl/txt_db.h
 sess_id.o: ../include/openssl/x509.h ../include/openssl/x509_vfy.h
-sess_id.o: ../include/openssl/x509v3.h apps.h sess_id.c
+sess_id.o: ../include/openssl/x509v3.h apps.h progs.h sess_id.c
 smime.o: ../e_os.h ../include/openssl/asn1.h ../include/openssl/bio.h
 smime.o: ../include/openssl/buffer.h ../include/openssl/conf.h
 smime.o: ../include/openssl/crypto.h ../include/openssl/e_os2.h
@@ -924,7 +924,7 @@ smime.o: ../include/openssl/safestack.h ../include/openssl/sha.h
 smime.o: ../include/openssl/stack.h ../include/openssl/symhacks.h
 smime.o: ../include/openssl/txt_db.h ../include/openssl/x509.h
 smime.o: ../include/openssl/x509_vfy.h ../include/openssl/x509v3.h apps.h
-smime.o: smime.c
+smime.o: progs.h smime.c
 speed.o: ../e_os.h ../include/openssl/aes.h ../include/openssl/asn1.h
 speed.o: ../include/openssl/bio.h ../include/openssl/blowfish.h
 speed.o: ../include/openssl/bn.h ../include/openssl/buffer.h
@@ -949,7 +949,7 @@ speed.o: ../include/openssl/sha.h ../include/openssl/stack.h
 speed.o: ../include/openssl/symhacks.h ../include/openssl/txt_db.h
 speed.o: ../include/openssl/whrlpool.h ../include/openssl/x509.h
 speed.o: ../include/openssl/x509_vfy.h ../include/openssl/x509v3.h apps.h
-speed.o: speed.c testdsa.h testrsa.h
+speed.o: progs.h speed.c testdsa.h testrsa.h
 spkac.o: ../e_os.h ../include/openssl/asn1.h ../include/openssl/bio.h
 spkac.o: ../include/openssl/buffer.h ../include/openssl/conf.h
 spkac.o: ../include/openssl/crypto.h ../include/openssl/e_os2.h
@@ -965,7 +965,7 @@ spkac.o: ../include/openssl/safestack.h ../include/openssl/sha.h
 spkac.o: ../include/openssl/stack.h ../include/openssl/symhacks.h
 spkac.o: ../include/openssl/txt_db.h ../include/openssl/x509.h
 spkac.o: ../include/openssl/x509_vfy.h ../include/openssl/x509v3.h apps.h
-spkac.o: spkac.c
+spkac.o: progs.h spkac.c
 srp.o: ../e_os.h ../include/openssl/asn1.h ../include/openssl/bio.h
 srp.o: ../include/openssl/bn.h ../include/openssl/buffer.h
 srp.o: ../include/openssl/conf.h ../include/openssl/crypto.h
@@ -980,7 +980,8 @@ srp.o: ../include/openssl/pkcs7.h ../include/openssl/safestack.h
 srp.o: ../include/openssl/sha.h ../include/openssl/srp.h
 srp.o: ../include/openssl/stack.h ../include/openssl/symhacks.h
 srp.o: ../include/openssl/txt_db.h ../include/openssl/x509.h
-srp.o: ../include/openssl/x509_vfy.h ../include/openssl/x509v3.h apps.h srp.c
+srp.o: ../include/openssl/x509_vfy.h ../include/openssl/x509v3.h apps.h progs.h
+srp.o: srp.c
 ts.o: ../e_os.h ../include/openssl/asn1.h ../include/openssl/bio.h
 ts.o: ../include/openssl/bn.h ../include/openssl/buffer.h
 ts.o: ../include/openssl/conf.h ../include/openssl/crypto.h
@@ -998,7 +999,8 @@ ts.o: ../include/openssl/rsa.h ../include/openssl/safestack.h
 ts.o: ../include/openssl/sha.h ../include/openssl/stack.h
 ts.o: ../include/openssl/symhacks.h ../include/openssl/ts.h
 ts.o: ../include/openssl/txt_db.h ../include/openssl/x509.h
-ts.o: ../include/openssl/x509_vfy.h ../include/openssl/x509v3.h apps.h ts.c
+ts.o: ../include/openssl/x509_vfy.h ../include/openssl/x509v3.h apps.h progs.h
+ts.o: ts.c
 verify.o: ../e_os.h ../include/openssl/asn1.h ../include/openssl/bio.h
 verify.o: ../include/openssl/buffer.h ../include/openssl/conf.h
 verify.o: ../include/openssl/crypto.h ../include/openssl/e_os2.h
@@ -1014,7 +1016,7 @@ verify.o: ../include/openssl/safestack.h ../include/openssl/sha.h
 verify.o: ../include/openssl/stack.h ../include/openssl/symhacks.h
 verify.o: ../include/openssl/txt_db.h ../include/openssl/x509.h
 verify.o: ../include/openssl/x509_vfy.h ../include/openssl/x509v3.h apps.h
-verify.o: verify.c
+verify.o: progs.h verify.c
 version.o: ../e_os.h ../include/openssl/asn1.h ../include/openssl/bio.h
 version.o: ../include/openssl/blowfish.h ../include/openssl/bn.h
 version.o: ../include/openssl/buffer.h ../include/openssl/conf.h
@@ -1031,7 +1033,7 @@ version.o: ../include/openssl/safestack.h ../include/openssl/sha.h
 version.o: ../include/openssl/stack.h ../include/openssl/symhacks.h
 version.o: ../include/openssl/txt_db.h ../include/openssl/x509.h
 version.o: ../include/openssl/x509_vfy.h ../include/openssl/x509v3.h apps.h
-version.o: version.c
+version.o: progs.h version.c
 x509.o: ../e_os.h ../include/openssl/asn1.h ../include/openssl/bio.h
 x509.o: ../include/openssl/bn.h ../include/openssl/buffer.h
 x509.o: ../include/openssl/conf.h ../include/openssl/crypto.h
@@ -1048,4 +1050,4 @@ x509.o: ../include/openssl/rsa.h ../include/openssl/safestack.h
 x509.o: ../include/openssl/sha.h ../include/openssl/stack.h
 x509.o: ../include/openssl/symhacks.h ../include/openssl/txt_db.h
 x509.o: ../include/openssl/x509.h ../include/openssl/x509_vfy.h
-x509.o: ../include/openssl/x509v3.h apps.h x509.c
+x509.o: ../include/openssl/x509v3.h apps.h progs.h x509.c
diff --git a/apps/app_rand.c b/apps/app_rand.c
index 595fc78..906144b 100644
--- a/apps/app_rand.c
+++ b/apps/app_rand.c
@@ -1,4 +1,3 @@
-/* apps/app_rand.c */
 /* Copyright (C) 1995-1998 Eric Young (<A HREF="../../../mailman/listinfo/openssl-commits.html">eay at cryptsoft.com</A>)
  * All rights reserved.
  *
@@ -109,25 +108,23 @@
  *
  */
 
-#define NON_MAIN
 #include &quot;apps.h&quot;
-#undef NON_MAIN
 #include &lt;openssl/bio.h&gt;
 #include &lt;openssl/rand.h&gt;
 
 static int seeded = 0;
 static int egdsocket = 0;
 
-int app_RAND_load_file(const char *file, BIO *bio_e, int dont_warn)
+int app_RAND_load_file(const char *file, int dont_warn)
 {
     int consider_randfile = (file == NULL);
     char buffer[200];
 
 #ifdef OPENSSL_SYS_WINDOWS
-    BIO_printf(bio_e, &quot;Loading 'screen' into random state -&quot;);
-    BIO_flush(bio_e);
+    BIO_printf(bio_err, &quot;Loading 'screen' into random state -&quot;);
+    BIO_flush(bio_err);
     RAND_screen();
-    BIO_printf(bio_e, &quot; done\n&quot;);
+    BIO_printf(bio_err, &quot; done\n&quot;);
 #endif
 
     if (file == NULL)
@@ -143,15 +140,15 @@ int app_RAND_load_file(const char *file, BIO *bio_e, int dont_warn)
     if (file == NULL || !RAND_load_file(file, -1)) {
         if (RAND_status() == 0) {
             if (!dont_warn) {
-                BIO_printf(bio_e, &quot;unable to load 'random state'\n&quot;);
-                BIO_printf(bio_e,
+                BIO_printf(bio_err, &quot;unable to load 'random state'\n&quot;);
+                BIO_printf(bio_err,
                            &quot;This means that the random number generator has not been seeded\n&quot;);
-                BIO_printf(bio_e, &quot;with much random data.\n&quot;);
+                BIO_printf(bio_err, &quot;with much random data.\n&quot;);
                 if (consider_randfile) { /* explanation does not apply when a
                                           * file is explicitly named */
-                    BIO_printf(bio_e,
+                    BIO_printf(bio_err,
                                &quot;Consider setting the RANDFILE environment variable to point at a file that\n&quot;);
-                    BIO_printf(bio_e,
+                    BIO_printf(bio_err,
                                &quot;'random' data can be kept in (the file will be overwritten).\n&quot;);
                 }
             }
@@ -193,7 +190,7 @@ long app_RAND_load_files(char *name)
     return (tot);
 }
 
-int app_RAND_write_file(const char *file, BIO *bio_e)
+int app_RAND_write_file(const char *file)
 {
     char buffer[200];
 
@@ -208,7 +205,7 @@ int app_RAND_write_file(const char *file, BIO *bio_e)
     if (file == NULL)
         file = RAND_file_name(buffer, sizeof buffer);
     if (file == NULL || !RAND_write_file(file)) {
-        BIO_printf(bio_e, &quot;unable to write 'random state'\n&quot;);
+        BIO_printf(bio_err, &quot;unable to write 'random state'\n&quot;);
         return 0;
     }
     return 1;
diff --git a/apps/apps.c b/apps/apps.c
index 76e0ee3..7440d39 100644
--- a/apps/apps.c
+++ b/apps/apps.c
@@ -1,4 +1,3 @@
-/* apps/apps.c */
 /* Copyright (C) 1995-1998 Eric Young (<A HREF="../../../mailman/listinfo/openssl-commits.html">eay at cryptsoft.com</A>)
  * All rights reserved.
  *
@@ -143,10 +142,9 @@
 #ifndef OPENSSL_NO_JPAKE
 # include &lt;openssl/jpake.h&gt;
 #endif
+#include &lt;openssl/ssl.h&gt;
 
-#define NON_MAIN
 #include &quot;apps.h&quot;
-#undef NON_MAIN
 
 #ifdef _WIN32
 static int WIN32_rename(const char *from, const char *to);
@@ -168,285 +166,58 @@ static int set_multi_opts(unsigned long *flags, const char *arg,
 
 #if !defined(OPENSSL_NO_RC4) &amp;&amp; !defined(OPENSSL_NO_RSA)
 /* Looks like this stuff is worth moving into separate function */
-static EVP_PKEY *load_netscape_key(BIO *err, BIO *key, const char *file,
+static EVP_PKEY *load_netscape_key(BIO *key, const char *file,
                                    const char *key_descrip, int format);
 #endif
 
 int app_init(long mesgwin);
-#ifdef undef                    /* never finished - probably never will be
-                                 * :-) */
-int args_from_file(char *file, int *argc, char **argv[])
-{
-    FILE *fp;
-    int num, i;
-    unsigned int len;
-    static char *buf = NULL;
-    static char **arg = NULL;
-    char *p;
-
-    fp = fopen(file, &quot;r&quot;);
-    if (fp == NULL)
-        return (0);
-
-    if (fseek(fp, 0, SEEK_END) == 0)
-        len = ftell(fp), rewind(fp);
-    else
-        len = -1;
-    if (len &lt;= 0) {
-        fclose(fp);
-        return (0);
-    }
-
-    *argc = 0;
-    *argv = NULL;
 
-    if (buf != NULL)
-        OPENSSL_free(buf);
-    buf = (char *)OPENSSL_malloc(len + 1);
-    if (buf == NULL)
-        return (0);
-
-    len = fread(buf, 1, len, fp);
-    if (len &lt;= 1)
-        return (0);
-    buf[len] = '\0';
-
-    i = 0;
-    for (p = buf; *p; p++)
-        if (*p == '\n')
-            i++;
-    if (arg != NULL)
-        OPENSSL_free(arg);
-    arg = (char **)OPENSSL_malloc(sizeof(char *) * (i * 2));
-
-    *argv = arg;
-    num = 0;
-    p = buf;
-    for (;;) {
-        if (!*p)
-            break;
-        if (*p == '#') {        /* comment line */
-            while (*p &amp;&amp; (*p != '\n'))
-                p++;
-            continue;
-        }
-        /* else we have a line */
-        *(arg++) = p;
-        num++;
-        while (*p &amp;&amp; ((*p != ' ') &amp;&amp; (*p != '\t') &amp;&amp; (*p != '\n')))
-            p++;
-        if (!*p)
-            break;
-        if (*p == '\n') {
-            *(p++) = '\0';
-            continue;
-        }
-        /* else it is a tab or space */
-        p++;
-        while (*p &amp;&amp; ((*p == ' ') || (*p == '\t') || (*p == '\n')))
-            p++;
-        if (!*p)
-            break;
-        if (*p == '\n') {
-            p++;
-            continue;
-        }
-        *(arg++) = p++;
-        num++;
-        while (*p &amp;&amp; (*p != '\n'))
-            p++;
-        if (!*p)
-            break;
-        /* else *p == '\n' */
-        *(p++) = '\0';
-    }
-    *argc = num;
-    return (1);
-}
-#endif
-
-int str2fmt(char *s)
-{
-    if (s == NULL)
-        return FORMAT_UNDEF;
-    if ((*s == 'D') || (*s == 'd'))
-        return (FORMAT_ASN1);
-    else if ((*s == 'T') || (*s == 't'))
-        return (FORMAT_TEXT);
-    else if ((strcmp(s, &quot;NSS&quot;) == 0) || (strcmp(s, &quot;nss&quot;) == 0))
-        return (FORMAT_NSS);
-    else if ((*s == 'N') || (*s == 'n'))
-        return (FORMAT_NETSCAPE);
-    else if ((*s == 'S') || (*s == 's'))
-        return (FORMAT_SMIME);
-    else if ((*s == 'M') || (*s == 'm'))
-        return (FORMAT_MSBLOB);
-    else if ((*s == '1')
-             || (strcmp(s, &quot;PKCS12&quot;) == 0) || (strcmp(s, &quot;pkcs12&quot;) == 0)
-             || (strcmp(s, &quot;P12&quot;) == 0) || (strcmp(s, &quot;p12&quot;) == 0))
-        return (FORMAT_PKCS12);
-    else if ((*s == 'E') || (*s == 'e'))
-        return (FORMAT_ENGINE);
-    else if ((*s == 'H') || (*s == 'h'))
-        return FORMAT_HTTP;
-    else if ((*s == 'P') || (*s == 'p')) {
-        if (s[1] == 'V' || s[1] == 'v')
-            return FORMAT_PVK;
-        else
-            return (FORMAT_PEM);
-    } else
-        return (FORMAT_UNDEF);
-}
-
-#if defined(OPENSSL_SYS_MSDOS) || defined(OPENSSL_SYS_WIN32) || defined(OPENSSL_SYS_NETWARE)
-void program_name(char *in, char *out, int size)
-{
-    int i, n;
-    char *p = NULL;
-
-    n = strlen(in);
-    /* find the last '/', '\' or ':' */
-    for (i = n - 1; i &gt; 0; i--) {
-        if ((in[i] == '/') || (in[i] == '\\') || (in[i] == ':')) {
-            p = &amp;(in[i + 1]);
-            break;
-        }
-    }
-    if (p == NULL)
-        p = in;
-    n = strlen(p);
-
-# if defined(OPENSSL_SYS_NETWARE)
-    /* strip off trailing .nlm if present. */
-    if ((n &gt; 4) &amp;&amp; (p[n - 4] == '.') &amp;&amp;
-        ((p[n - 3] == 'n') || (p[n - 3] == 'N')) &amp;&amp;
-        ((p[n - 2] == 'l') || (p[n - 2] == 'L')) &amp;&amp;
-        ((p[n - 1] == 'm') || (p[n - 1] == 'M')))
-        n -= 4;
-# else
-    /* strip off trailing .exe if present. */
-    if ((n &gt; 4) &amp;&amp; (p[n - 4] == '.') &amp;&amp;
-        ((p[n - 3] == 'e') || (p[n - 3] == 'E')) &amp;&amp;
-        ((p[n - 2] == 'x') || (p[n - 2] == 'X')) &amp;&amp;
-        ((p[n - 1] == 'e') || (p[n - 1] == 'E')))
-        n -= 4;
-# endif
-
-    if (n &gt; size - 1)
-        n = size - 1;
-
-    for (i = 0; i &lt; n; i++) {
-        if ((p[i] &gt;= 'A') &amp;&amp; (p[i] &lt;= 'Z'))
-            out[i] = p[i] - 'A' + 'a';
-        else
-            out[i] = p[i];
-    }
-    out[n] = '\0';
-}
-#else
-# ifdef OPENSSL_SYS_VMS
-void program_name(char *in, char *out, int size)
+int chopup_args(ARGS *arg, char *buf)
 {
-    char *p = in, *q;
-    char *chars = &quot;:]&gt;&quot;;
-
-    while (*chars != '\0') {
-        q = strrchr(p, *chars);
-        if (q &gt; p)
-            p = q + 1;
-        chars++;
-    }
+    int quoted;
+    char c, *p;
 
-    q = strrchr(p, '.');
-    if (q == NULL)
-        q = p + strlen(p);
-    strncpy(out, p, size - 1);
-    if (q - p &gt;= size) {
-        out[size - 1] = '\0';
-    } else {
-        out[q - p] = '\0';
-    }
-}
-# else
-void program_name(char *in, char *out, int size)
-{
-    char *p;
-
-    p = strrchr(in, '/');
-    if (p != NULL)
-        p++;
-    else
-        p = in;
-    BUF_strlcpy(out, p, size);
-}
-# endif
-#endif
-
-int chopup_args(ARGS *arg, char *buf, int *argc, char **argv[])
-{
-    int num, i;
-    char *p;
-
-    *argc = 0;
-    *argv = NULL;
-
-    i = 0;
-    if (arg-&gt;count == 0) {
-        arg-&gt;count = 20;
-        arg-&gt;data = (char **)OPENSSL_malloc(sizeof(char *) * arg-&gt;count);
-        if (arg-&gt;data == NULL)
+    arg-&gt;argc = 0;
+    if (arg-&gt;size == 0) {
+        arg-&gt;size = 20;
+        arg-&gt;argv = (char **)OPENSSL_malloc(sizeof(char *) * arg-&gt;size);
+        if (arg-&gt;argv == NULL)
             return 0;
     }
-    for (i = 0; i &lt; arg-&gt;count; i++)
-        arg-&gt;data[i] = NULL;
 
-    num = 0;
-    p = buf;
-    for (;;) {
-        /* first scan over white space */
-        if (!*p)
-            break;
-        while (*p &amp;&amp; ((*p == ' ') || (*p == '\t') || (*p == '\n')))
+    for (p = buf;;) {
+        /* Skip whitespace. */
+        while (*p &amp;&amp; isspace(*p))
             p++;
         if (!*p)
             break;
 
         /* The start of something good :-) */
-        if (num &gt;= arg-&gt;count) {
-            char **tmp_p;
-            int tlen = arg-&gt;count + 20;
-            tmp_p = (char **)OPENSSL_realloc(arg-&gt;data,
-                                             sizeof(char *) * tlen);
-            if (tmp_p == NULL)
+        if (arg-&gt;argc &gt;= arg-&gt;size) {
+            arg-&gt;size += 20;
+            arg-&gt;argv = (char **)OPENSSL_realloc(arg-&gt;argv,
+                                                 sizeof(char *) * arg-&gt;size);
+            if (arg-&gt;argv == NULL)
                 return 0;
-            arg-&gt;data = tmp_p;
-            arg-&gt;count = tlen;
-            /* initialize newly allocated data */
-            for (i = num; i &lt; arg-&gt;count; i++)
-                arg-&gt;data[i] = NULL;
         }
-        arg-&gt;data[num++] = p;
+        quoted = *p == '\'' || *p == '&quot;';
+        if (quoted)
+            c = *p++;
+        arg-&gt;argv[arg-&gt;argc++] = p;
 
         /* now look for the end of this */
-        if ((*p == '\'') || (*p == '\&quot;')) { /* scan for closing quote */
-            i = *(p++);
-            arg-&gt;data[num - 1]++; /* jump over quote */
-            while (*p &amp;&amp; (*p != i))
+        if (quoted) {
+            while (*p &amp;&amp; *p != c)
                 p++;
-            *p = '\0';
+            *p++ = '\0';
         } else {
-            while (*p &amp;&amp; ((*p != ' ') &amp;&amp; (*p != '\t') &amp;&amp; (*p != '\n')))
+            while (*p &amp;&amp; !isspace(*p))
                 p++;
-
-            if (*p == '\0')
-                p--;
-            else
-                *p = '\0';
+            if (*p)
+                *p++ = '\0';
         }
-        p++;
     }
-    *argc = num;
-    *argv = arg-&gt;data;
+    arg-&gt;argv[arg-&gt;argc] = NULL;
     return (1);
 }
 
@@ -457,6 +228,14 @@ int app_init(long mesgwin)
 }
 #endif
 
+int ctx_set_verify_locations(SSL_CTX *ctx,
+                             const char *CAfile, const char *CApath)
+{
+    if (CAfile == NULL &amp;&amp; CApath == NULL)
+        return SSL_CTX_set_default_verify_paths(ctx);
+    return SSL_CTX_load_verify_locations(ctx, CAfile, CApath);
+}
+
 int dump_cert_text(BIO *out, X509 *x)
 {
     char *p;
@@ -573,7 +352,7 @@ int password_callback(char *buf, int bufsiz, int verify, PW_CB_DATA *cb_tmp)
         int ok = 0;
         char *buff = NULL;
         int ui_flags = 0;
-        char *prompt = NULL;
+        char *prompt;
 
         prompt = UI_construct_prompt(ui, &quot;pass phrase&quot;, prompt_info);
         if (!prompt) {
@@ -629,9 +408,9 @@ int password_callback(char *buf, int bufsiz, int verify, PW_CB_DATA *cb_tmp)
     return res;
 }
 
-static char *app_get_pass(BIO *err, char *arg, int keepbio);
+static char *app_get_pass(char *arg, int keepbio);
 
-int app_passwd(BIO *err, char *arg1, char *arg2, char **pass1, char **pass2)
+int app_passwd(char *arg1, char *arg2, char **pass1, char **pass2)
 {
     int same;
     if (!arg2 || !arg1 || strcmp(arg1, arg2))
@@ -639,13 +418,13 @@ int app_passwd(BIO *err, char *arg1, char *arg2, char **pass1, char **pass2)
     else
         same = 1;
     if (arg1) {
-        *pass1 = app_get_pass(err, arg1, same);
+        *pass1 = app_get_pass(arg1, same);
         if (!*pass1)
             return 0;
     } else if (pass1)
         *pass1 = NULL;
     if (arg2) {
-        *pass2 = app_get_pass(err, arg2, same ? 2 : 0);
+        *pass2 = app_get_pass(arg2, same ? 2 : 0);
         if (!*pass2)
             return 0;
     } else if (pass2)
@@ -653,7 +432,7 @@ int app_passwd(BIO *err, char *arg1, char *arg2, char **pass1, char **pass2)
     return 1;
 }
 
-static char *app_get_pass(BIO *err, char *arg, int keepbio)
+static char *app_get_pass(char *arg, int keepbio)
 {
     char *tmp, tpass[APP_PASS_LEN];
     static BIO *pwdbio = NULL;
@@ -663,7 +442,7 @@ static char *app_get_pass(BIO *err, char *arg, int keepbio)
     if (!strncmp(arg, &quot;env:&quot;, 4)) {
         tmp = getenv(arg + 4);
         if (!tmp) {
-            BIO_printf(err, &quot;Can't read environment variable %s\n&quot;, arg + 4);
+            BIO_printf(bio_err, &quot;Can't read environment variable %s\n&quot;, arg + 4);
             return NULL;
         }
         return BUF_strdup(tmp);
@@ -672,7 +451,7 @@ static char *app_get_pass(BIO *err, char *arg, int keepbio)
         if (!strncmp(arg, &quot;file:&quot;, 5)) {
             pwdbio = BIO_new_file(arg + 5, &quot;r&quot;);
             if (!pwdbio) {
-                BIO_printf(err, &quot;Can't open file %s\n&quot;, arg + 5);
+                BIO_printf(bio_err, &quot;Can't open file %s\n&quot;, arg + 5);
                 return NULL;
             }
 #if !defined(_WIN32)
@@ -690,7 +469,7 @@ static char *app_get_pass(BIO *err, char *arg, int keepbio)
             if (i &gt;= 0)
                 pwdbio = BIO_new_fd(i, BIO_NOCLOSE);
             if ((i &lt; 0) || !pwdbio) {
-                BIO_printf(err, &quot;Can't access file descriptor %s\n&quot;, arg + 3);
+                BIO_printf(bio_err, &quot;Can't access file descriptor %s\n&quot;, arg + 3);
                 return NULL;
             }
             /*
@@ -700,13 +479,13 @@ static char *app_get_pass(BIO *err, char *arg, int keepbio)
             pwdbio = BIO_push(btmp, pwdbio);
 #endif
         } else if (!strcmp(arg, &quot;stdin&quot;)) {
-            pwdbio = BIO_new_fp(stdin, BIO_NOCLOSE);
+            pwdbio = dup_bio_in();
             if (!pwdbio) {
-                BIO_printf(err, &quot;Can't open BIO for stdin\n&quot;);
+                BIO_printf(bio_err, &quot;Can't open BIO for stdin\n&quot;);
                 return NULL;
             }
         } else {
-            BIO_printf(err, &quot;Invalid password argument \&quot;%s\&quot;\n&quot;, arg);
+            BIO_printf(bio_err, &quot;Invalid password argument \&quot;%s\&quot;\n&quot;, arg);
             return NULL;
         }
     }
@@ -716,7 +495,7 @@ static char *app_get_pass(BIO *err, char *arg, int keepbio)
         pwdbio = NULL;
     }
     if (i &lt;= 0) {
-        BIO_printf(err, &quot;Error reading password from BIO\n&quot;);
+        BIO_printf(bio_err, &quot;Error reading password from BIO\n&quot;);
         return NULL;
     }
     tmp = strchr(tpass, '\n');
@@ -725,7 +504,7 @@ static char *app_get_pass(BIO *err, char *arg, int keepbio)
     return BUF_strdup(tpass);
 }
 
-int add_oid_section(BIO *err, CONF *conf)
+int add_oid_section(CONF *conf)
 {
     char *p;
     STACK_OF(CONF_VALUE) *sktmp;
@@ -736,13 +515,13 @@ int add_oid_section(BIO *err, CONF *conf)
         return 1;
     }
     if (!(sktmp = NCONF_get_section(conf, p))) {
-        BIO_printf(err, &quot;problem loading oid section %s\n&quot;, p);
+        BIO_printf(bio_err, &quot;problem loading oid section %s\n&quot;, p);
         return 0;
     }
     for (i = 0; i &lt; sk_CONF_VALUE_num(sktmp); i++) {
         cnf = sk_CONF_VALUE_value(sktmp, i);
         if (OBJ_create(cnf-&gt;value, cnf-&gt;name, cnf-&gt;name) == NID_undef) {
-            BIO_printf(err, &quot;problem creating object %s=%s\n&quot;,
+            BIO_printf(bio_err, &quot;problem creating object %s=%s\n&quot;,
                        cnf-&gt;name, cnf-&gt;value);
             return 0;
         }
@@ -750,7 +529,7 @@ int add_oid_section(BIO *err, CONF *conf)
     return 1;
 }
 
-static int load_pkcs12(BIO *err, BIO *in, const char *desc,
+static int load_pkcs12(BIO *in, const char *desc,
                        pem_password_cb *pem_cb, void *cb_data,
                        EVP_PKEY **pkey, X509 **cert, STACK_OF(X509) **ca)
 {
@@ -760,7 +539,7 @@ static int load_pkcs12(BIO *err, BIO *in, const char *desc,
     PKCS12 *p12;
     p12 = d2i_PKCS12_bio(in, NULL);
     if (p12 == NULL) {
-        BIO_printf(err, &quot;Error loading PKCS12 file for %s\n&quot;, desc);
+        BIO_printf(bio_err, &quot;Error loading PKCS12 file for %s\n&quot;, desc);
         goto die;
     }
     /* See if an empty password will do */
@@ -771,13 +550,13 @@ static int load_pkcs12(BIO *err, BIO *in, const char *desc,
             pem_cb = (pem_password_cb *)password_callback;
         len = pem_cb(tpass, PEM_BUFSIZE, 0, cb_data);
         if (len &lt; 0) {
-            BIO_printf(err, &quot;Passpharse callback error for %s\n&quot;, desc);
+            BIO_printf(bio_err, &quot;Passphrase callback error for %s\n&quot;, desc);
             goto die;
         }
         if (len &lt; PEM_BUFSIZE)
             tpass[len] = 0;
         if (!PKCS12_verify_mac(p12, tpass, len)) {
-            BIO_printf(err,
+            BIO_printf(bio_err,
                        &quot;Mac verify error (wrong password?) in PKCS12 file for %s\n&quot;,
                        desc);
             goto die;
@@ -790,8 +569,7 @@ static int load_pkcs12(BIO *err, BIO *in, const char *desc,
     return ret;
 }
 
-int load_cert_crl_http(const char *url, BIO *err,
-                       X509 **pcert, X509_CRL **pcrl)
+int load_cert_crl_http(const char *url, X509 **pcert, X509_CRL **pcrl)
 {
     char *host = NULL, *port = NULL, *path = NULL;
     BIO *bio = NULL;
@@ -800,8 +578,7 @@ int load_cert_crl_http(const char *url, BIO *err,
     if (!OCSP_parse_url(url, &amp;host, &amp;port, &amp;path, &amp;use_ssl))
         goto err;
     if (use_ssl) {
-        if (err)
-            BIO_puts(err, &quot;https not supported\n&quot;);
+        BIO_puts(bio_err, &quot;https not supported\n&quot;);
         goto err;
     }
     bio = BIO_new_connect(host);
@@ -817,8 +594,7 @@ int load_cert_crl_http(const char *url, BIO *err,
     if (pcert) {
         do {
             rv = X509_http_nbio(rctx, pcert);
-        }
-        while (rv == -1);
+        } while (rv == -1);
     } else {
         do {
             rv = X509_CRL_http_nbio(rctx, pcrl);
@@ -837,40 +613,31 @@ int load_cert_crl_http(const char *url, BIO *err,
     if (rctx)
         OCSP_REQ_CTX_free(rctx);
     if (rv != 1) {
-        if (bio &amp;&amp; err)
-            BIO_printf(bio_err, &quot;Error loading %s from %s\n&quot;,
-                       pcert ? &quot;certificate&quot; : &quot;CRL&quot;, url);
+        BIO_printf(bio_err, &quot;Error loading %s from %s\n&quot;,
+                   pcert ? &quot;certificate&quot; : &quot;CRL&quot;, url);
         ERR_print_errors(bio_err);
     }
     return rv;
 }
 
-X509 *load_cert(BIO *err, const char *file, int format,
+X509 *load_cert(const char *file, int format,
                 const char *pass, ENGINE *e, const char *cert_descrip)
 {
     X509 *x = NULL;
     BIO *cert;
 
     if (format == FORMAT_HTTP) {
-        load_cert_crl_http(file, err, &amp;x, NULL);
+        load_cert_crl_http(file, &amp;x, NULL);
         return x;
     }
 
-    if ((cert = BIO_new(BIO_s_file())) == NULL) {
-        ERR_print_errors(err);
-        goto end;
-    }
-
     if (file == NULL) {
-        setbuf(stdin, NULL); /* don't do buffered reads */
-        BIO_set_fp(cert, stdin, BIO_NOCLOSE);
-    } else {
-        if (BIO_read_filename(cert, file) &lt;= 0) {
-            BIO_printf(err, &quot;Error opening %s %s\n&quot;, cert_descrip, file);
-            ERR_print_errors(err);
-            goto end;
-        }
-    }
+        unbuffer(stdin);
+        cert = dup_bio_in();
+    } else
+        cert = bio_open_default(file, RB(format));
+    if (cert == NULL)
+        goto end;
 
     if (format == FORMAT_ASN1)
         x = d2i_X509_bio(cert, NULL);
@@ -883,7 +650,7 @@ X509 *load_cert(BIO *err, const char *file, int format,
         if ((strncmp(NETSCAPE_CERT_HDR, (char *)nx-&gt;header-&gt;data,
                      nx-&gt;header-&gt;length) != 0)) {
             NETSCAPE_X509_free(nx);
-            BIO_printf(err, &quot;Error reading header on certificate\n&quot;);
+            BIO_printf(bio_err, &quot;Error reading header on certificate\n&quot;);
             goto end;
         }
         x = nx-&gt;cert;
@@ -893,16 +660,16 @@ X509 *load_cert(BIO *err, const char *file, int format,
         x = PEM_read_bio_X509_AUX(cert, NULL,
                                   (pem_password_cb *)password_callback, NULL);
     else if (format == FORMAT_PKCS12) {
-        if (!load_pkcs12(err, cert, cert_descrip, NULL, NULL, NULL, &amp;x, NULL))
+        if (!load_pkcs12(cert, cert_descrip, NULL, NULL, NULL, &amp;x, NULL))
             goto end;
     } else {
-        BIO_printf(err, &quot;bad input format specified for %s\n&quot;, cert_descrip);
+        BIO_printf(bio_err, &quot;bad input format specified for %s\n&quot;, cert_descrip);
         goto end;
     }
  end:
     if (x == NULL) {
-        BIO_printf(err, &quot;unable to load certificate\n&quot;);
-        ERR_print_errors(err);
+        BIO_printf(bio_err, &quot;unable to load certificate\n&quot;);
+        ERR_print_errors(bio_err);
     }
     if (cert != NULL)
         BIO_free(cert);
@@ -915,24 +682,13 @@ X509_CRL *load_crl(const char *infile, int format)
     BIO *in = NULL;
 
     if (format == FORMAT_HTTP) {
-        load_cert_crl_http(infile, bio_err, NULL, &amp;x);
+        load_cert_crl_http(infile, NULL, &amp;x);
         return x;
     }
 
-    in = BIO_new(BIO_s_file());
-    if (in == NULL) {
-        ERR_print_errors(bio_err);
+    in = bio_open_default(infile, RB(format));
+    if (in == NULL)
         goto end;
-    }
-
-    if (infile == NULL)
-        BIO_set_fp(in, stdin, BIO_NOCLOSE);
-    else {
-        if (BIO_read_filename(in, infile) &lt;= 0) {
-            perror(infile);
-            goto end;
-        }
-    }
     if (format == FORMAT_ASN1)
         x = d2i_X509_CRL_bio(in, NULL);
     else if (format == FORMAT_PEM)
@@ -952,7 +708,7 @@ X509_CRL *load_crl(const char *infile, int format)
     return (x);
 }
 
-EVP_PKEY *load_key(BIO *err, const char *file, int format, int maybe_stdin,
+EVP_PKEY *load_key(const char *file, int format, int maybe_stdin,
                    const char *pass, ENGINE *e, const char *key_descrip)
 {
     BIO *key = NULL;
@@ -963,36 +719,30 @@ EVP_PKEY *load_key(BIO *err, const char *file, int format, int maybe_stdin,
     cb_data.prompt_info = file;
 
     if (file == NULL &amp;&amp; (!maybe_stdin || format == FORMAT_ENGINE)) {
-        BIO_printf(err, &quot;no keyfile specified\n&quot;);
+        BIO_printf(bio_err, &quot;no keyfile specified\n&quot;);
         goto end;
     }
 #ifndef OPENSSL_NO_ENGINE
     if (format == FORMAT_ENGINE) {
         if (!e)
-            BIO_printf(err, &quot;no engine specified\n&quot;);
+            BIO_printf(bio_err, &quot;no engine specified\n&quot;);
         else {
             pkey = ENGINE_load_private_key(e, file, ui_method, &amp;cb_data);
             if (!pkey) {
-                BIO_printf(err, &quot;cannot load %s from engine\n&quot;, key_descrip);
-                ERR_print_errors(err);
+                BIO_printf(bio_err, &quot;cannot load %s from engine\n&quot;, key_descrip);
+                ERR_print_errors(bio_err);
             }
         }
         goto end;
     }
 #endif
-    key = BIO_new(BIO_s_file());
-    if (key == NULL) {
-        ERR_print_errors(err);
-        goto end;
-    }
     if (file == NULL &amp;&amp; maybe_stdin) {
-        setbuf(stdin, NULL); /* don't do buffered reads */
-        BIO_set_fp(key, stdin, BIO_NOCLOSE);
-    } else if (BIO_read_filename(key, file) &lt;= 0) {
-        BIO_printf(err, &quot;Error opening %s %s\n&quot;, key_descrip, file);
-        ERR_print_errors(err);
+        unbuffer(stdin);
+        key = dup_bio_in();
+    } else
+        key = bio_open_default(file, RB(format));
+    if (key == NULL)
         goto end;
-    }
     if (format == FORMAT_ASN1) {
         pkey = d2i_PrivateKey_bio(key, NULL);
     } else if (format == FORMAT_PEM) {
@@ -1001,11 +751,11 @@ EVP_PKEY *load_key(BIO *err, const char *file, int format, int maybe_stdin,
                                        &amp;cb_data);
     }
 #if !defined(OPENSSL_NO_RC4) &amp;&amp; !defined(OPENSSL_NO_RSA)
-    else if (format == FORMAT_NETSCAPE || format == FORMAT_IISSGC)
-        pkey = load_netscape_key(err, key, file, key_descrip, format);
+    else if (format == FORMAT_NETSCAPE)
+        pkey = load_netscape_key(key, file, key_descrip, format);
 #endif
     else if (format == FORMAT_PKCS12) {
-        if (!load_pkcs12(err, key, key_descrip,
+        if (!load_pkcs12(key, key_descrip,
                          (pem_password_cb *)password_callback, &amp;cb_data,
                          &amp;pkey, NULL, NULL))
             goto end;
@@ -1018,20 +768,27 @@ EVP_PKEY *load_key(BIO *err, const char *file, int format, int maybe_stdin,
                            &amp;cb_data);
 #endif
     else {
-        BIO_printf(err, &quot;bad input format specified for key file\n&quot;);
+        BIO_printf(bio_err, &quot;bad input format specified for key file\n&quot;);
         goto end;
     }
  end:
     if (key != NULL)
         BIO_free(key);
     if (pkey == NULL) {
-        BIO_printf(err, &quot;unable to load %s\n&quot;, key_descrip);
-        ERR_print_errors(err);
+        BIO_printf(bio_err, &quot;unable to load %s\n&quot;, key_descrip);
+        ERR_print_errors(bio_err);
     }
     return (pkey);
 }
 
-EVP_PKEY *load_pubkey(BIO *err, const char *file, int format, int maybe_stdin,
+static const char *key_file_format(int format)
+{
+    if (format == FORMAT_PEM || format == FORMAT_PEMRSA)
+        return &quot;r&quot;;
+    return &quot;rb&quot;;
+}
+
+EVP_PKEY *load_pubkey(const char *file, int format, int maybe_stdin,
                       const char *pass, ENGINE *e, const char *key_descrip)
 {
     BIO *key = NULL;
@@ -1042,7 +799,7 @@ EVP_PKEY *load_pubkey(BIO *err, const char *file, int format, int maybe_stdin,
     cb_data.prompt_info = file;
 
     if (file == NULL &amp;&amp; (!maybe_stdin || format == FORMAT_ENGINE)) {
-        BIO_printf(err, &quot;no keyfile specified\n&quot;);
+        BIO_printf(bio_err, &quot;no keyfile specified\n&quot;);
         goto end;
     }
 #ifndef OPENSSL_NO_ENGINE
@@ -1054,19 +811,13 @@ EVP_PKEY *load_pubkey(BIO *err, const char *file, int format, int maybe_stdin,
         goto end;
     }
 #endif
-    key = BIO_new(BIO_s_file());
-    if (key == NULL) {
-        ERR_print_errors(err);
-        goto end;
-    }
     if (file == NULL &amp;&amp; maybe_stdin) {
-        setbuf(stdin, NULL); /* don't do buffered reads */
-        BIO_set_fp(key, stdin, BIO_NOCLOSE);
-    } else if (BIO_read_filename(key, file) &lt;= 0) {
-        BIO_printf(err, &quot;Error opening %s %s\n&quot;, key_descrip, file);
-        ERR_print_errors(err);
+        unbuffer(stdin);
+        key = dup_bio_in();
+    } else
+        key = bio_open_default(file, key_file_format(format));
+    if (key == NULL)
         goto end;
-    }
     if (format == FORMAT_ASN1) {
         pkey = d2i_PUBKEY_bio(key, NULL);
     }
@@ -1101,26 +852,23 @@ EVP_PKEY *load_pubkey(BIO *err, const char *file, int format, int maybe_stdin,
                                    &amp;cb_data);
     }
 #if !defined(OPENSSL_NO_RC4) &amp;&amp; !defined(OPENSSL_NO_RSA)
-    else if (format == FORMAT_NETSCAPE || format == FORMAT_IISSGC)
-        pkey = load_netscape_key(err, key, file, key_descrip, format);
+    else if (format == FORMAT_NETSCAPE)
+        pkey = load_netscape_key(key, file, key_descrip, format);
 #endif
 #if !defined(OPENSSL_NO_RSA) &amp;&amp; !defined(OPENSSL_NO_DSA)
     else if (format == FORMAT_MSBLOB)
         pkey = b2i_PublicKey_bio(key);
 #endif
-    else {
-        BIO_printf(err, &quot;bad input format specified for key file\n&quot;);
-        goto end;
-    }
  end:
-    BIO_free(key);
+    if (key != NULL)
+        BIO_free(key);
     if (pkey == NULL)
-        BIO_printf(err, &quot;unable to load %s\n&quot;, key_descrip);
+        BIO_printf(bio_err, &quot;unable to load %s\n&quot;, key_descrip);
     return (pkey);
 }
 
 #if !defined(OPENSSL_NO_RC4) &amp;&amp; !defined(OPENSSL_NO_RSA)
-static EVP_PKEY *load_netscape_key(BIO *err, BIO *key, const char *file,
+static EVP_PKEY *load_netscape_key(BIO *key, const char *file,
                                    const char *key_descrip, int format)
 {
     EVP_PKEY *pkey;
@@ -1142,13 +890,12 @@ static EVP_PKEY *load_netscape_key(BIO *err, BIO *key, const char *file,
         if (i == 0)
             break;
         if (i &lt; 0) {
-            BIO_printf(err, &quot;Error reading %s %s&quot;, key_descrip, file);
+            BIO_printf(bio_err, &quot;Error reading %s %s&quot;, key_descrip, file);
             goto error;
         }
     }
     p = (unsigned char *)buf-&gt;data;
-    rsa = d2i_RSA_NET(NULL, &amp;p, (long)size, NULL,
-                      (format == FORMAT_IISSGC ? 1 : 0));
+    rsa = d2i_RSA_NET(NULL, &amp;p, (long)size, NULL, 0);
     if (rsa == NULL)
         goto error;
     BUF_MEM_free(buf);
@@ -1161,7 +908,7 @@ static EVP_PKEY *load_netscape_key(BIO *err, BIO *key, const char *file,
 }
 #endif                          /* ndef OPENSSL_NO_RC4 */
 
-static int load_certs_crls(BIO *err, const char *file, int format,
+static int load_certs_crls(const char *file, int format,
                            const char *pass, ENGINE *e, const char *desc,
                            STACK_OF(X509) **pcerts,
                            STACK_OF(X509_CRL) **pcrls)
@@ -1177,20 +924,13 @@ static int load_certs_crls(BIO *err, const char *file, int format,
     cb_data.prompt_info = file;
 
     if (format != FORMAT_PEM) {
-        BIO_printf(err, &quot;bad input format specified for %s\n&quot;, desc);
+        BIO_printf(bio_err, &quot;bad input format specified for %s\n&quot;, desc);
         return 0;
     }
 
-    if (file == NULL)
-        bio = BIO_new_fp(stdin, BIO_NOCLOSE);
-    else
-        bio = BIO_new_file(file, &quot;r&quot;);
-
-    if (bio == NULL) {
-        BIO_printf(err, &quot;Error opening %s %s\n&quot;, desc, file ? file : &quot;stdin&quot;);
-        ERR_print_errors(err);
+    bio = bio_open_default(file, &quot;r&quot;);
+    if (bio == NULL)
         return 0;
-    }
 
     xis = PEM_X509_INFO_read_bio(bio, NULL,
                                  (pem_password_cb *)password_callback,
@@ -1244,27 +984,27 @@ static int load_certs_crls(BIO *err, const char *file, int format,
             sk_X509_CRL_pop_free(*pcrls, X509_CRL_free);
             *pcrls = NULL;
         }
-        BIO_printf(err, &quot;unable to load %s\n&quot;,
+        BIO_printf(bio_err, &quot;unable to load %s\n&quot;,
                    pcerts ? &quot;certificates&quot; : &quot;CRLs&quot;);
-        ERR_print_errors(err);
+        ERR_print_errors(bio_err);
     }
     return rv;
 }
 
-STACK_OF(X509) *load_certs(BIO *err, const char *file, int format,
+STACK_OF(X509) *load_certs(const char *file, int format,
                            const char *pass, ENGINE *e, const char *desc)
 {
     STACK_OF(X509) *certs;
-    if (!load_certs_crls(err, file, format, pass, e, desc, &amp;certs, NULL))
+    if (!load_certs_crls(file, format, pass, e, desc, &amp;certs, NULL))
         return NULL;
     return certs;
 }
 
-STACK_OF(X509_CRL) *load_crls(BIO *err, const char *file, int format,
+STACK_OF(X509_CRL) *load_crls(const char *file, int format,
                               const char *pass, ENGINE *e, const char *desc)
 {
     STACK_OF(X509_CRL) *crls;
-    if (!load_certs_crls(err, file, format, pass, e, desc, NULL, &amp;crls))
+    if (!load_certs_crls(file, format, pass, e, desc, NULL, &amp;crls))
         return NULL;
     return crls;
 }
@@ -1469,18 +1209,56 @@ void print_name(BIO *out, const char *title, X509_NAME *nm,
     }
 }
 
-X509_STORE *setup_verify(BIO *bp, char *CAfile, char *CApath)
+void print_bignum_var(BIO *out, BIGNUM *in, const char *var,
+                      int len, unsigned char *buffer)
 {
-    X509_STORE *store;
+    BIO_printf(out, &quot;    static unsigned char %s_%d[] = {&quot;, var, len);
+    if (BN_is_zero(in))
+        BIO_printf(out, &quot;\n\t0x00&quot;);
+    else {
+        int i, l;
+
+        l = BN_bn2bin(in, buffer);
+        for (i = 0; i &lt; l; i++) {
+            if ((i % 10) == 0)
+                BIO_printf(out, &quot;\n\t&quot;);
+            if (i &lt; l - 1)
+                BIO_printf(out, &quot;0x%02X, &quot;, buffer[i]);
+            else
+                BIO_printf(out, &quot;0x%02X&quot;, buffer[i]);
+        }
+    }
+    BIO_printf(out, &quot;\n    };\n&quot;);
+}
+void print_array(BIO *out, const char* title, int len, const unsigned char* d)
+{
+    int i;
+
+    BIO_printf(out, &quot;unsigned char %s[%d] = {&quot;, title, len);
+    for (i = 0; i &lt; len; i++) {
+        if ((i % 10) == 0)
+            BIO_printf(out, &quot;\n    &quot;);
+        if (i &lt; len - 1)
+            BIO_printf(out, &quot;0x%02X, &quot;, d[i]);
+        else
+            BIO_printf(out, &quot;0x%02X&quot;, d[i]);
+    }
+    BIO_printf(out, &quot;\n};\n&quot;);
+}
+
+X509_STORE *setup_verify(char *CAfile, char *CApath)
+{
+    X509_STORE *store = X509_STORE_new();
     X509_LOOKUP *lookup;
-    if (!(store = X509_STORE_new()))
+
+    if (!store)
         goto end;
     lookup = X509_STORE_add_lookup(store, X509_LOOKUP_file());
     if (lookup == NULL)
         goto end;
     if (CAfile) {
         if (!X509_LOOKUP_load_file(lookup, CAfile, X509_FILETYPE_PEM)) {
-            BIO_printf(bp, &quot;Error loading file %s\n&quot;, CAfile);
+            BIO_printf(bio_err, &quot;Error loading file %s\n&quot;, CAfile);
             goto end;
         }
     } else
@@ -1491,7 +1269,7 @@ X509_STORE *setup_verify(BIO *bp, char *CAfile, char *CApath)
         goto end;
     if (CApath) {
         if (!X509_LOOKUP_add_dir(lookup, CApath, X509_FILETYPE_PEM)) {
-            BIO_printf(bp, &quot;Error loading directory %s\n&quot;, CApath);
+            BIO_printf(bio_err, &quot;Error loading directory %s\n&quot;, CApath);
             goto end;
         }
     } else
@@ -1506,7 +1284,7 @@ X509_STORE *setup_verify(BIO *bp, char *CAfile, char *CApath)
 
 #ifndef OPENSSL_NO_ENGINE
 /* Try to load an engine in a shareable library */
-static ENGINE *try_load_engine(BIO *err, const char *engine, int debug)
+static ENGINE *try_load_engine(const char *engine, int debug)
 {
     ENGINE *e = ENGINE_by_id(&quot;dynamic&quot;);
     if (e) {
@@ -1519,34 +1297,34 @@ static ENGINE *try_load_engine(BIO *err, const char *engine, int debug)
     return e;
 }
 
-ENGINE *setup_engine(BIO *err, const char *engine, int debug)
+ENGINE *setup_engine(const char *engine, int debug)
 {
     ENGINE *e = NULL;
 
     if (engine) {
         if (strcmp(engine, &quot;auto&quot;) == 0) {
-            BIO_printf(err, &quot;enabling auto ENGINE support\n&quot;);
+            BIO_printf(bio_err, &quot;enabling auto ENGINE support\n&quot;);
             ENGINE_register_all_complete();
             return NULL;
         }
         if ((e = ENGINE_by_id(engine)) == NULL
-            &amp;&amp; (e = try_load_engine(err, engine, debug)) == NULL) {
-            BIO_printf(err, &quot;invalid engine \&quot;%s\&quot;\n&quot;, engine);
-            ERR_print_errors(err);
+            &amp;&amp; (e = try_load_engine(engine, debug)) == NULL) {
+            BIO_printf(bio_err, &quot;invalid engine \&quot;%s\&quot;\n&quot;, engine);
+            ERR_print_errors(bio_err);
             return NULL;
         }
         if (debug) {
-            ENGINE_ctrl(e, ENGINE_CTRL_SET_LOGSTREAM, 0, err, 0);
+            ENGINE_ctrl(e, ENGINE_CTRL_SET_LOGSTREAM, 0, bio_err, 0);
         }
         ENGINE_ctrl_cmd(e, &quot;SET_USER_INTERFACE&quot;, 0, ui_method, 0, 1);
         if (!ENGINE_set_default(e, ENGINE_METHOD_ALL)) {
-            BIO_printf(err, &quot;can't use that engine\n&quot;);
-            ERR_print_errors(err);
+            BIO_printf(bio_err, &quot;can't use that engine\n&quot;);
+            ERR_print_errors(bio_err);
             ENGINE_free(e);
             return NULL;
         }
 
-        BIO_printf(err, &quot;engine \&quot;%s\&quot; set.\n&quot;, ENGINE_get_id(e));
+        BIO_printf(bio_err, &quot;engine \&quot;%s\&quot; set.\n&quot;, ENGINE_get_id(e));
 
         /* Free our &quot;structural&quot; reference. */
         ENGINE_free(e);
@@ -1555,46 +1333,6 @@ ENGINE *setup_engine(BIO *err, const char *engine, int debug)
 }
 #endif
 
-int load_config(BIO *err, CONF *cnf)
-{
-    static int load_config_called = 0;
-    if (load_config_called)
-        return 1;
-    load_config_called = 1;
-    if (!cnf)
-        cnf = config;
-    if (!cnf)
-        return 1;
-
-    OPENSSL_load_builtin_modules();
-
-    if (CONF_modules_load(cnf, NULL, 0) &lt;= 0) {
-        BIO_printf(err, &quot;Error configuring OpenSSL\n&quot;);
-        ERR_print_errors(err);
-        return 0;
-    }
-    return 1;
-}
-
-char *make_config_name()
-{
-    const char *t = X509_get_default_cert_area();
-    size_t len;
-    char *p;
-
-    len = strlen(t) + strlen(OPENSSL_CONF) + 2;
-    p = OPENSSL_malloc(len);
-    if (p == NULL)
-        return NULL;
-    BUF_strlcpy(p, t, len);
-#ifndef OPENSSL_SYS_VMS
-    BUF_strlcat(p, &quot;/&quot;, len);
-#endif
-    BUF_strlcat(p, OPENSSL_CONF, len);
-
-    return p;
-}
-
 static unsigned long index_serial_hash(const OPENSSL_CSTRING *a)
 {
     const char *n;
@@ -1647,20 +1385,16 @@ BIGNUM *load_serial(char *serialfile, int create, ASN1_INTEGER **retai)
     if (ai == NULL)
         goto err;
 
-    if ((in = BIO_new(BIO_s_file())) == NULL) {
-        ERR_print_errors(bio_err);
-        goto err;
-    }
-
-    if (BIO_read_filename(in, serialfile) &lt;= 0) {
+    in = BIO_new_file(serialfile, &quot;r&quot;);
+    if (in == NULL) {
         if (!create) {
             perror(serialfile);
             goto err;
-        } else {
-            ret = BN_new();
-            if (ret == NULL || !rand_serial(ret, ai))
-                BIO_printf(bio_err, &quot;Out of memory\n&quot;);
         }
+        ERR_clear_error();
+        ret = BN_new();
+        if (ret == NULL || !rand_serial(ret, ai))
+            BIO_printf(bio_err, &quot;Out of memory\n&quot;);
     } else {
         if (!a2i_ASN1_INTEGER(in, ai, buf, 1024)) {
             BIO_printf(bio_err, &quot;unable to load number from %s\n&quot;,
@@ -1716,15 +1450,11 @@ int save_serial(char *serialfile, char *suffix, BIGNUM *serial,
 #ifdef RL_DEBUG
     BIO_printf(bio_err, &quot;DEBUG: writing \&quot;%s\&quot;\n&quot;, buf[0]);
 #endif
-    out = BIO_new(BIO_s_file());
+    out = BIO_new_file(buf[0], &quot;w&quot;);
     if (out == NULL) {
         ERR_print_errors(bio_err);
         goto err;
     }
-    if (BIO_write_filename(out, buf[0]) &lt;= 0) {
-        perror(serialfile);
-        goto err;
-    }
 
     if ((ai = BN_to_ASN1_INTEGER(serial, NULL)) == NULL) {
         BIO_printf(bio_err, &quot;error converting serial to ASN.1 format\n&quot;);
@@ -1828,20 +1558,16 @@ CA_DB *load_index(char *dbfile, DB_ATTR *db_attr)
 {
     CA_DB *retdb = NULL;
     TXT_DB *tmpdb = NULL;
-    BIO *in = BIO_new(BIO_s_file());
+    BIO *in;
     CONF *dbattr_conf = NULL;
     char buf[1][BSIZE];
     long errorline = -1;
 
+    in = BIO_new_file(dbfile, &quot;r&quot;);
     if (in == NULL) {
         ERR_print_errors(bio_err);
         goto err;
     }
-    if (BIO_read_filename(in, dbfile) &lt;= 0) {
-        perror(dbfile);
-        BIO_printf(bio_err, &quot;unable to open '%s'\n&quot;, dbfile);
-        goto err;
-    }
     if ((tmpdb = TXT_DB_read(in, DB_NUMBER)) == NULL)
         goto err;
 
@@ -1921,14 +1647,9 @@ int index_index(CA_DB *db)
 int save_index(const char *dbfile, const char *suffix, CA_DB *db)
 {
     char buf[3][BSIZE];
-    BIO *out = BIO_new(BIO_s_file());
+    BIO *out;
     int j;
 
-    if (out == NULL) {
-        ERR_print_errors(bio_err);
-        goto err;
-    }
-
     j = strlen(dbfile) + strlen(suffix);
     if (j + 6 &gt;= BSIZE) {
         BIO_printf(bio_err, &quot;file name too long\n&quot;);
@@ -1952,22 +1673,22 @@ int save_index(const char *dbfile, const char *suffix, CA_DB *db)
 #ifdef RL_DEBUG
     BIO_printf(bio_err, &quot;DEBUG: writing \&quot;%s\&quot;\n&quot;, buf[0]);
 #endif
-    if (BIO_write_filename(out, buf[0]) &lt;= 0) {
+    out = BIO_new_file(buf[0], &quot;w&quot;);
+    if (out == NULL) {
         perror(dbfile);
         BIO_printf(bio_err, &quot;unable to open '%s'\n&quot;, dbfile);
         goto err;
     }
     j = TXT_DB_write(out, db-&gt;db);
+    BIO_free(out);
     if (j &lt;= 0)
         goto err;
 
-    BIO_free(out);
-
-    out = BIO_new(BIO_s_file());
+    out = BIO_new_file(buf[1], &quot;w&quot;);
 #ifdef RL_DEBUG
     BIO_printf(bio_err, &quot;DEBUG: writing \&quot;%s\&quot;\n&quot;, buf[1]);
 #endif
-    if (BIO_write_filename(out, buf[1]) &lt;= 0) {
+    if (out == NULL) {
         perror(buf[2]);
         BIO_printf(bio_err, &quot;unable to open '%s'\n&quot;, buf[2]);
         goto err;
@@ -2239,189 +1960,6 @@ X509_NAME *parse_name(char *subject, long chtype, int multirdn)
     return NULL;
 }
 
-int args_verify(char ***pargs, int *pargc,
-                int *badarg, BIO *err, X509_VERIFY_PARAM **pm)
-{
-    ASN1_OBJECT *otmp = NULL;
-    unsigned long flags = 0;
-    int i;
-    int purpose = 0, depth = -1;
-    char **oldargs = *pargs;
-    char *arg = **pargs, *argn = (*pargs)[1];
-    const X509_VERIFY_PARAM *vpm = NULL;
-    time_t at_time = 0;
-    char *hostname = NULL;
-    char *email = NULL;
-    char *ipasc = NULL;
-    if (!strcmp(arg, &quot;-policy&quot;)) {
-        if (!argn)
-            *badarg = 1;
-        else {
-            otmp = OBJ_txt2obj(argn, 0);
-            if (!otmp) {
-                BIO_printf(err, &quot;Invalid Policy \&quot;%s\&quot;\n&quot;, argn);
-                *badarg = 1;
-            }
-        }
-        (*pargs)++;
-    } else if (strcmp(arg, &quot;-purpose&quot;) == 0) {
-        X509_PURPOSE *xptmp;
-        if (!argn)
-            *badarg = 1;
-        else {
-            i = X509_PURPOSE_get_by_sname(argn);
-            if (i &lt; 0) {
-                BIO_printf(err, &quot;unrecognized purpose\n&quot;);
-                *badarg = 1;
-            } else {
-                xptmp = X509_PURPOSE_get0(i);
-                purpose = X509_PURPOSE_get_id(xptmp);
-            }
-        }
-        (*pargs)++;
-    } else if (strcmp(arg, &quot;-verify_name&quot;) == 0) {
-        if (!argn)
-            *badarg = 1;
-        else {
-            vpm = X509_VERIFY_PARAM_lookup(argn);
-            if (!vpm) {
-                BIO_printf(err, &quot;unrecognized verify name\n&quot;);
-                *badarg = 1;
-            }
-        }
-        (*pargs)++;
-    } else if (strcmp(arg, &quot;-verify_depth&quot;) == 0) {
-        if (!argn)
-            *badarg = 1;
-        else {
-            depth = atoi(argn);
-            if (depth &lt; 0) {
-                BIO_printf(err, &quot;invalid depth\n&quot;);
-                *badarg = 1;
-            }
-        }
-        (*pargs)++;
-    } else if (strcmp(arg, &quot;-attime&quot;) == 0) {
-        if (!argn)
-            *badarg = 1;
-        else {
-            long timestamp;
-            /*
-             * interpret the -attime argument as seconds since Epoch
-             */
-            if (sscanf(argn, &quot;%li&quot;, &amp;timestamp) != 1) {
-                BIO_printf(bio_err, &quot;Error parsing timestamp %s\n&quot;, argn);
-                *badarg = 1;
-            }
-            /* on some platforms time_t may be a float */
-            at_time = (time_t)timestamp;
-        }
-        (*pargs)++;
-    } else if (strcmp(arg, &quot;-verify_hostname&quot;) == 0) {
-        if (!argn)
-            *badarg = 1;
-        hostname = argn;
-        (*pargs)++;
-    } else if (strcmp(arg, &quot;-verify_email&quot;) == 0) {
-        if (!argn)
-            *badarg = 1;
-        email = argn;
-        (*pargs)++;
-    } else if (strcmp(arg, &quot;-verify_ip&quot;) == 0) {
-        if (!argn)
-            *badarg = 1;
-        ipasc = argn;
-        (*pargs)++;
-    } else if (!strcmp(arg, &quot;-ignore_critical&quot;))
-        flags |= X509_V_FLAG_IGNORE_CRITICAL;
-    else if (!strcmp(arg, &quot;-issuer_checks&quot;))
-        flags |= X509_V_FLAG_CB_ISSUER_CHECK;
-    else if (!strcmp(arg, &quot;-crl_check&quot;))
-        flags |= X509_V_FLAG_CRL_CHECK;
-    else if (!strcmp(arg, &quot;-crl_check_all&quot;))
-        flags |= X509_V_FLAG_CRL_CHECK | X509_V_FLAG_CRL_CHECK_ALL;
-    else if (!strcmp(arg, &quot;-policy_check&quot;))
-        flags |= X509_V_FLAG_POLICY_CHECK;
-    else if (!strcmp(arg, &quot;-explicit_policy&quot;))
-        flags |= X509_V_FLAG_EXPLICIT_POLICY;
-    else if (!strcmp(arg, &quot;-inhibit_any&quot;))
-        flags |= X509_V_FLAG_INHIBIT_ANY;
-    else if (!strcmp(arg, &quot;-inhibit_map&quot;))
-        flags |= X509_V_FLAG_INHIBIT_MAP;
-    else if (!strcmp(arg, &quot;-x509_strict&quot;))
-        flags |= X509_V_FLAG_X509_STRICT;
-    else if (!strcmp(arg, &quot;-extended_crl&quot;))
-        flags |= X509_V_FLAG_EXTENDED_CRL_SUPPORT;
-    else if (!strcmp(arg, &quot;-use_deltas&quot;))
-        flags |= X509_V_FLAG_USE_DELTAS;
-    else if (!strcmp(arg, &quot;-policy_print&quot;))
-        flags |= X509_V_FLAG_NOTIFY_POLICY;
-    else if (!strcmp(arg, &quot;-check_ss_sig&quot;))
-        flags |= X509_V_FLAG_CHECK_SS_SIGNATURE;
-    else if (!strcmp(arg, &quot;-trusted_first&quot;))
-        flags |= X509_V_FLAG_TRUSTED_FIRST;
-    else if (!strcmp(arg, &quot;-suiteB_128_only&quot;))
-        flags |= X509_V_FLAG_SUITEB_128_LOS_ONLY;
-    else if (!strcmp(arg, &quot;-suiteB_128&quot;))
-        flags |= X509_V_FLAG_SUITEB_128_LOS;
-    else if (!strcmp(arg, &quot;-suiteB_192&quot;))
-        flags |= X509_V_FLAG_SUITEB_192_LOS;
-    else if (!strcmp(arg, &quot;-partial_chain&quot;))
-        flags |= X509_V_FLAG_PARTIAL_CHAIN;
-    else if (!strcmp(arg, &quot;-no_alt_chains&quot;))
-        flags |= X509_V_FLAG_NO_ALT_CHAINS;
-    else
-        return 0;
-
-    if (*badarg) {
-        if (*pm)
-            X509_VERIFY_PARAM_free(*pm);
-        *pm = NULL;
-        goto end;
-    }
-
-    if (!*pm &amp;&amp; !(*pm = X509_VERIFY_PARAM_new())) {
-        *badarg = 1;
-        goto end;
-    }
-
-    if (vpm)
-        X509_VERIFY_PARAM_set1(*pm, vpm);
-
-    if (otmp)
-        X509_VERIFY_PARAM_add0_policy(*pm, otmp);
-    if (flags)
-        X509_VERIFY_PARAM_set_flags(*pm, flags);
-
-    if (purpose)
-        X509_VERIFY_PARAM_set_purpose(*pm, purpose);
-
-    if (depth &gt;= 0)
-        X509_VERIFY_PARAM_set_depth(*pm, depth);
-
-    if (at_time)
-        X509_VERIFY_PARAM_set_time(*pm, at_time);
-
-    if (hostname &amp;&amp; !X509_VERIFY_PARAM_set1_host(*pm, hostname, 0))
-        *badarg = 1;
-
-    if (email &amp;&amp; !X509_VERIFY_PARAM_set1_email(*pm, email, 0))
-        *badarg = 1;
-
-    if (ipasc &amp;&amp; !X509_VERIFY_PARAM_set1_ip_asc(*pm, ipasc))
-        *badarg = 1;
-
- end:
-
-    (*pargs)++;
-
-    if (pargc)
-        *pargc -= *pargs - oldargs;
-
-    return 1;
-
-}
-
 /*
  * Read whole contents of a BIO into an allocated memory buffer and return
  * it.
@@ -2495,11 +2033,6 @@ void policies_print(BIO *out, X509_STORE_CTX *ctx)
 {
     X509_POLICY_TREE *tree;
     int explicit_policy;
-    int free_out = 0;
-    if (out == NULL) {
-        out = BIO_new_fp(stderr, BIO_NOCLOSE);
-        free_out = 1;
-    }
     tree = X509_STORE_CTX_get0_policy_tree(ctx);
     explicit_policy = X509_STORE_CTX_get_explicit_policy(ctx);
 
@@ -2508,8 +2041,6 @@ void policies_print(BIO *out, X509_STORE_CTX *ctx)
 
     nodes_print(out, &quot;Authority&quot;, X509_policy_tree_get0_policies(tree));
     nodes_print(out, &quot;User&quot;, X509_policy_tree_get0_user_policies(tree));
-    if (free_out)
-        BIO_free(out);
 }
 
 #if !defined(OPENSSL_NO_JPAKE) &amp;&amp; !defined(OPENSSL_NO_PSK)
@@ -2788,14 +2319,15 @@ void print_cert_checks(BIO *bio, X509 *x,
         return;
     if (checkhost) {
         BIO_printf(bio, &quot;Hostname %s does%s match certificate\n&quot;,
-                   checkhost, X509_check_host(x, checkhost, 0, 0, NULL) == 1
-                   ? &quot;&quot; : &quot; NOT&quot;);
+                   checkhost,
+                   X509_check_host(x, checkhost, 0, 0, NULL) == 1
+                       ? &quot;&quot; : &quot; NOT&quot;);
     }
 
     if (checkemail) {
         BIO_printf(bio, &quot;Email %s does%s match certificate\n&quot;,
-                   checkemail, X509_check_email(x, checkemail, 0,
-                                                0) ? &quot;&quot; : &quot; NOT&quot;);
+                   checkemail, X509_check_email(x, checkemail, 0, 0)
+                   ? &quot;&quot; : &quot; NOT&quot;);
     }
 
     if (checkip) {
@@ -2857,13 +2389,16 @@ static STACK_OF(X509_CRL) *crls_http_cb(X509_STORE_CTX *ctx, X509_NAME *nm)
     STACK_OF(X509_CRL) *crls = NULL;
     X509_CRL *crl;
     STACK_OF(DIST_POINT) *crldp;
+
+    crls = sk_X509_CRL_new_null();
+    if (!crls)
+        return NULL;
     x = X509_STORE_CTX_get_current_cert(ctx);
     crldp = X509_get_ext_d2i(x, NID_crl_distribution_points, NULL, NULL);
     crl = load_crl_crldp(crldp);
     sk_DIST_POINT_pop_free(crldp, DIST_POINT_free);
     if (!crl)
         return NULL;
-    crls = sk_X509_CRL_new_null();
     sk_X509_CRL_push(crls, crl);
     /* Try to download delta CRL */
     crldp = X509_get_ext_d2i(x, NID_freshest_crl, NULL, NULL);
@@ -2992,15 +2527,14 @@ double app_tminterval(int stop, int usertime)
 
     return (ret);
 }
-
 #elif defined(OPENSSL_SYS_NETWARE)
 # include &lt;time.h&gt;
 
 double app_tminterval(int stop, int usertime)
 {
-    double ret = 0;
     static clock_t tmstart;
     static int warning = 1;
+    double ret = 0;
 
     if (usertime &amp;&amp; warning) {
         BIO_printf(bio_err, &quot;To get meaningful results, run &quot;
@@ -3016,6 +2550,7 @@ double app_tminterval(int stop, int usertime)
     return (ret);
 }
 
+
 #elif defined(OPENSSL_SYSTEM_VXWORKS)
 # include &lt;time.h&gt;
 
@@ -3136,6 +2671,15 @@ double app_tminterval(int stop, int usertime)
 }
 #endif
 
+int app_access(const char* name, int flag)
+{
+#ifdef _WIN32
+    return _access(name, flag);
+#else
+    return access(name, flag);
+#endif
+}
+
 /* app_isdir section */
 #ifdef _WIN32
 int app_isdir(const char *name)
diff --git a/apps/apps.h b/apps/apps.h
index 2e346f9..ad17b1a 100644
--- a/apps/apps.h
+++ b/apps/apps.h
@@ -126,9 +126,18 @@
 #  include &lt;openssl/ocsp.h&gt;
 # endif
 # include &lt;openssl/ossl_typ.h&gt;
+# ifndef OPENSSL_SYS_NETWARE
+#  include &lt;signal.h&gt;
+# endif
 
-int app_RAND_load_file(const char *file, BIO *bio_e, int dont_warn);
-int app_RAND_write_file(const char *file, BIO *bio_e);
+# if defined(OPENSSL_SYS_WIN32) || defined(OPENSSL_SYS_WINCE)
+#  define openssl_fdset(a,b) FD_SET((unsigned int)a, b)
+# else
+#  define openssl_fdset(a,b) FD_SET(a, b)
+# endif
+
+int app_RAND_load_file(const char *file, int dont_warn);
+int app_RAND_write_file(const char *file);
 /*
  * When `file' is NULL, use defaults. `bio_e' is for error messages.
  */
@@ -138,82 +147,246 @@ long app_RAND_load_files(char *file); /* `file' is a list of files to read,
                                        * (see e_os.h).  The string is
                                        * destroyed! */
 
-# ifndef MONOLITH
-
-#  define MAIN(a,v)       main(a,v)
-
-#  ifndef NON_MAIN
-CONF *config = NULL;
-BIO *bio_err = NULL;
-#  else
-extern CONF *config;
-extern BIO *bio_err;
-#  endif
-
-# else
-
-#  define MAIN(a,v)       PROG(a,v)
 extern CONF *config;
 extern char *default_config_file;
+extern BIO *bio_in;
+extern BIO *bio_out;
 extern BIO *bio_err;
+BIO *dup_bio_in(void);
+BIO *dup_bio_out(void);
+BIO *bio_open_default(const char *filename, const char *mode);
+void unbuffer(FILE *fp);
 
-# endif
+/* Often used in calls to bio_open_default. */
+# define RB(xformat)  ((xformat) == FORMAT_ASN1 ? &quot;rb&quot; : &quot;r&quot;)
+# define WB(xformat)  ((xformat) == FORMAT_ASN1 ? &quot;wb&quot; : &quot;w&quot;)
 
-# ifndef OPENSSL_SYS_NETWARE
-#  include &lt;signal.h&gt;
-# endif
-
-# ifdef SIGPIPE
-#  define do_pipe_sig()   signal(SIGPIPE,SIG_IGN)
-# else
-#  define do_pipe_sig()
-# endif
+/*
+ * Common verification options.
+ */
+# define OPT_V_ENUM \
+        OPT_V__FIRST=2000, \
+        OPT_V_POLICY, OPT_V_PURPOSE, OPT_V_VERIFY_NAME, OPT_V_VERIFY_DEPTH, \
+        OPT_V_ATTIME, OPT_V_VERIFY_HOSTNAME, OPT_V_VERIFY_EMAIL, \
+        OPT_V_VERIFY_IP, OPT_V_IGNORE_CRITICAL, OPT_V_ISSUER_CHECKS, \
+        OPT_V_CRL_CHECK, OPT_V_CRL_CHECK_ALL, OPT_V_POLICY_CHECK, \
+        OPT_V_EXPLICIT_POLICY, OPT_V_INHIBIT_ANY, OPT_V_INHIBIT_MAP, \
+        OPT_V_X509_STRICT, OPT_V_EXTENDED_CRL, OPT_V_USE_DELTAS, \
+        OPT_V_POLICY_PRINT, OPT_V_CHECK_SS_SIG, OPT_V_TRUSTED_FIRST, \
+        OPT_V_SUITEB_128_ONLY, OPT_V_SUITEB_128, OPT_V_SUITEB_192, \
+        OPT_V_PARTIAL_CHAIN, OPT_V_NO_ALT_CHAINS, \
+        OPT_V__LAST
+
+# define OPT_V_OPTIONS \
+        { &quot;policy&quot;, OPT_V_POLICY, 's' }, \
+        { &quot;purpose&quot;, OPT_V_PURPOSE, 's' }, \
+        { &quot;verify_name&quot;, OPT_V_VERIFY_NAME, 's' }, \
+        { &quot;verify_depth&quot;, OPT_V_VERIFY_DEPTH, 'p' }, \
+        { &quot;attime&quot;, OPT_V_ATTIME, 'p' }, \
+        { &quot;verify_hostname&quot;, OPT_V_VERIFY_HOSTNAME, 's' }, \
+        { &quot;verify_email&quot;, OPT_V_VERIFY_EMAIL, 's' }, \
+        { &quot;verify_ip&quot;, OPT_V_VERIFY_IP, 's' }, \
+        { &quot;ignore_critical&quot;, OPT_V_IGNORE_CRITICAL, '-' }, \
+        { &quot;issuer_checks&quot;, OPT_V_ISSUER_CHECKS, '-' }, \
+        { &quot;crl_check&quot;, OPT_V_CRL_CHECK, '-', &quot;Check that peer cert has not been revoked&quot; }, \
+        { &quot;crl_check_all&quot;, OPT_V_CRL_CHECK_ALL, '-', &quot;Also check all certs in the chain&quot; }, \
+        { &quot;policy_check&quot;, OPT_V_POLICY_CHECK, '-' }, \
+        { &quot;explicit_policy&quot;, OPT_V_EXPLICIT_POLICY, '-' }, \
+        { &quot;inhibit_any&quot;, OPT_V_INHIBIT_ANY, '-' }, \
+        { &quot;inhibit_map&quot;, OPT_V_INHIBIT_MAP, '-' }, \
+        { &quot;x509_strict&quot;, OPT_V_X509_STRICT, '-' }, \
+        { &quot;extended_crl&quot;, OPT_V_EXTENDED_CRL, '-' }, \
+        { &quot;use_deltas&quot;, OPT_V_USE_DELTAS, '-' }, \
+        { &quot;policy_print&quot;, OPT_V_POLICY_PRINT, '-' }, \
+        { &quot;check_ss_sig&quot;, OPT_V_CHECK_SS_SIG, '-' }, \
+        { &quot;trusted_first&quot;, OPT_V_TRUSTED_FIRST, '-', &quot;Use locally-trusted CA's first in building chain&quot; }, \
+        { &quot;suiteB_128_only&quot;, OPT_V_SUITEB_128_ONLY, '-' }, \
+        { &quot;suiteB_128&quot;, OPT_V_SUITEB_128, '-' }, \
+        { &quot;suiteB_192&quot;, OPT_V_SUITEB_192, '-' }, \
+        { &quot;partial_chain&quot;, OPT_V_PARTIAL_CHAIN, '-' }, \
+        { &quot;no_alt_chains&quot;, OPT_V_NO_ALT_CHAINS, '-', &quot;Only use the first cert chain found&quot; }
+
+# define OPT_V_CASES \
+        OPT_V__FIRST: case OPT_V__LAST: break; \
+        case OPT_V_POLICY: \
+        case OPT_V_PURPOSE: \
+        case OPT_V_VERIFY_NAME: \
+        case OPT_V_VERIFY_DEPTH: \
+        case OPT_V_ATTIME: \
+        case OPT_V_VERIFY_HOSTNAME: \
+        case OPT_V_VERIFY_EMAIL: \
+        case OPT_V_VERIFY_IP: \
+        case OPT_V_IGNORE_CRITICAL: \
+        case OPT_V_ISSUER_CHECKS: \
+        case OPT_V_CRL_CHECK: \
+        case OPT_V_CRL_CHECK_ALL: \
+        case OPT_V_POLICY_CHECK: \
+        case OPT_V_EXPLICIT_POLICY: \
+        case OPT_V_INHIBIT_ANY: \
+        case OPT_V_INHIBIT_MAP: \
+        case OPT_V_X509_STRICT: \
+        case OPT_V_EXTENDED_CRL: \
+        case OPT_V_USE_DELTAS: \
+        case OPT_V_POLICY_PRINT: \
+        case OPT_V_CHECK_SS_SIG: \
+        case OPT_V_TRUSTED_FIRST: \
+        case OPT_V_SUITEB_128_ONLY: \
+        case OPT_V_SUITEB_128: \
+        case OPT_V_SUITEB_192: \
+        case OPT_V_PARTIAL_CHAIN: \
+        case OPT_V_NO_ALT_CHAINS
 
-# ifdef OPENSSL_NO_COMP
-#  define zlib_cleanup()
-# else
-#  define zlib_cleanup() COMP_zlib_cleanup()
-# endif
+/*
+ * Common &quot;extended&quot;? options.
+ */
+# define OPT_X_ENUM \
+        OPT_X__FIRST=1000, \
+        OPT_X_KEY, OPT_X_CERT, OPT_X_CHAIN, OPT_X_CHAIN_BUILD, \
+        OPT_X_CERTFORM, OPT_X_KEYFORM, \
+        OPT_X__LAST
+
+# define OPT_X_OPTIONS \
+        { &quot;xkey&quot;, OPT_X_KEY, '&lt;' }, \
+        { &quot;xcert&quot;, OPT_X_CERT, '&lt;' }, \
+        { &quot;xchain&quot;, OPT_X_CHAIN, '&lt;' }, \
+        { &quot;xchain_build&quot;, OPT_X_CHAIN_BUILD, '-' }, \
+        { &quot;xcertform&quot;, OPT_X_CERTFORM, 'F' }, \
+        { &quot;xkeyform&quot;, OPT_X_KEYFORM, 'F' }
+
+# define OPT_X_CASES \
+        OPT_X__FIRST: case OPT_X__LAST: break; \
+        case OPT_X_KEY: \
+        case OPT_X_CERT: \
+        case OPT_X_CHAIN: \
+        case OPT_X_CHAIN_BUILD: \
+        case OPT_X_CERTFORM: \
+        case OPT_X_KEYFORM
 
-# if defined(MONOLITH) &amp;&amp; !defined(OPENSSL_C)
-#  define apps_startup() \
-                do_pipe_sig()
-#  define apps_shutdown()
-# else
-#  ifndef OPENSSL_NO_ENGINE
-#   define apps_startup() \
-                        do { do_pipe_sig(); CRYPTO_malloc_init(); \
-                        ERR_load_crypto_strings(); OpenSSL_add_all_algorithms(); \
-                        ENGINE_load_builtin_engines(); setup_ui_method(); } while(0)
-#   define apps_shutdown() \
-                        do { CONF_modules_unload(1); destroy_ui_method(); \
-                        OBJ_cleanup(); EVP_cleanup(); ENGINE_cleanup(); \
-                        CRYPTO_cleanup_all_ex_data(); ERR_remove_thread_state(NULL); \
-                        RAND_cleanup(); \
-                        ERR_free_strings(); zlib_cleanup();} while(0)
-#  else
-#   define apps_startup() \
-                        do { do_pipe_sig(); CRYPTO_malloc_init(); \
-                        ERR_load_crypto_strings(); OpenSSL_add_all_algorithms(); \
-                        setup_ui_method(); } while(0)
-#   define apps_shutdown() \
-                        do { CONF_modules_unload(1); destroy_ui_method(); \
-                        OBJ_cleanup(); EVP_cleanup(); \
-                        CRYPTO_cleanup_all_ex_data(); ERR_remove_thread_state(NULL); \
-                        RAND_cleanup(); \
-                        ERR_free_strings(); zlib_cleanup(); } while(0)
-#  endif
-# endif
+/*
+ * Common SSL options.
+ * Any changes here must be coordinated with ../ssl/ssl_conf.c
+ */
+# define OPT_S_ENUM \
+        OPT_S__FIRST=3000, \
+        OPT_S_NOSSL3, OPT_S_NOTLS1, OPT_S_NOTLS1_1, OPT_S_NOTLS1_2, \
+        OPT_S_BUGS, OPT_S_NOCOMP, OPT_S_ECDHSINGLE, OPT_S_NOTICKET, \
+        OPT_S_SERVERPREF, OPT_S_LEGACYRENEG, OPT_S_LEGACYCONN, \
+        OPT_S_ONRESUMP, OPT_S_NOLEGACYCONN, OPT_S_STRICT, OPT_S_SIGALGS, \
+        OPT_S_CLIENTSIGALGS, OPT_S_CURVES, OPT_S_NAMEDCURVE, OPT_S_CIPHER, \
+        OPT_S_DHPARAM, OPT_S_DEBUGBROKE, \
+        OPT_S__LAST
+
+# define OPT_S_OPTIONS \
+        {&quot;no_ssl3&quot;, OPT_S_NOSSL3, '-' }, \
+        {&quot;no_tls1&quot;, OPT_S_NOTLS1, '-' }, \
+        {&quot;no_tls1_1&quot;, OPT_S_NOTLS1_1, '-' }, \
+        {&quot;no_tls1_2&quot;, OPT_S_NOTLS1_2, '-' }, \
+        {&quot;bugs&quot;, OPT_S_BUGS, '-' }, \
+        {&quot;no_comp&quot;, OPT_S_NOCOMP, '-' }, \
+        {&quot;ecdh_single&quot;, OPT_S_ECDHSINGLE, '-' }, \
+        {&quot;no_ticket&quot;, OPT_S_NOTICKET, '-' }, \
+        {&quot;serverpref&quot;, OPT_S_SERVERPREF, '-' }, \
+        {&quot;legacy_renegotiation&quot;, OPT_S_LEGACYRENEG, '-' }, \
+        {&quot;legacy_server_connect&quot;, OPT_S_LEGACYCONN, '-' }, \
+        {&quot;no_resumption_on_reneg&quot;, OPT_S_ONRESUMP, '-' }, \
+        {&quot;no_legacy_server_connect&quot;, OPT_S_NOLEGACYCONN, '-' }, \
+        {&quot;strict&quot;, OPT_S_STRICT, '-' }, \
+        {&quot;sigalgs&quot;, OPT_S_SIGALGS, 's', }, \
+        {&quot;client_sigalgs&quot;, OPT_S_CLIENTSIGALGS, 's', }, \
+        {&quot;curves&quot;, OPT_S_CURVES, 's', }, \
+        {&quot;named_curve&quot;, OPT_S_NAMEDCURVE, 's', }, \
+        {&quot;cipher&quot;, OPT_S_CIPHER, 's', }, \
+        {&quot;dhparam&quot;, OPT_S_DHPARAM, '&lt;' }, \
+        {&quot;debug_broken_protocol&quot;, OPT_S_DEBUGBROKE, '-' }
+
+# define OPT_S_CASES \
+        OPT_S__FIRST: case OPT_S__LAST: break; \
+        case OPT_S_NOSSL3: \
+        case OPT_S_NOTLS1: \
+        case OPT_S_NOTLS1_1: \
+        case OPT_S_NOTLS1_2: \
+        case OPT_S_BUGS: \
+        case OPT_S_NOCOMP: \
+        case OPT_S_ECDHSINGLE: \
+        case OPT_S_NOTICKET: \
+        case OPT_S_SERVERPREF: \
+        case OPT_S_LEGACYRENEG: \
+        case OPT_S_LEGACYCONN: \
+        case OPT_S_ONRESUMP: \
+        case OPT_S_NOLEGACYCONN: \
+        case OPT_S_STRICT: \
+        case OPT_S_SIGALGS: \
+        case OPT_S_CLIENTSIGALGS: \
+        case OPT_S_CURVES: \
+        case OPT_S_NAMEDCURVE: \
+        case OPT_S_CIPHER: \
+        case OPT_S_DHPARAM: \
+        case OPT_S_DEBUGBROKE
 
-# if defined(OPENSSL_SYS_WIN32) || defined(OPENSSL_SYS_WINCE)
-#  define openssl_fdset(a,b) FD_SET((unsigned int)a, b)
-# else
-#  define openssl_fdset(a,b) FD_SET(a, b)
-# endif
+/*
+ * Option parsing.
+ */
+extern const char OPT_HELP_STR[];
+extern const char OPT_MORE_STR[];
+typedef struct options_st {
+    const char *name;
+    int retval;
+    /*
+     * value type: - no value (also the value zero), n number, p positive
+     * number, u unsigned, s string, &lt; input file, &gt; output file, f der/pem
+     * format, F any format identifier.  n and u include zero; p does not.
+     */
+    int valtype;
+    const char *helpstr;
+} OPTIONS;
+
+typedef struct opt_pair_st {
+    const char *name;
+    int retval;
+} OPT_PAIR;
+
+/* Flags to pass into opt_format; see FORMAT_xxx, below. */
+# define OPT_FMT_PEMDER          (1L &lt;&lt;  1)
+# define OPT_FMT_PKCS12          (1L &lt;&lt;  2)
+# define OPT_FMT_SMIME           (1L &lt;&lt;  3)
+# define OPT_FMT_ENGINE          (1L &lt;&lt;  4)
+# define OPT_FMT_MSBLOB          (1L &lt;&lt;  5)
+# define OPT_FMT_NETSCAPE        (1L &lt;&lt;  6)
+# define OPT_FMT_NSS             (1L &lt;&lt;  7)
+# define OPT_FMT_TEXT            (1L &lt;&lt;  8)
+# define OPT_FMT_HTTP            (1L &lt;&lt;  9)
+# define OPT_FMT_PVK             (1L &lt;&lt; 10)
+# define OPT_FMT_ANY     ( \
+        OPT_FMT_PEMDER | OPT_FMT_PKCS12 | OPT_FMT_SMIME | \
+        OPT_FMT_ENGINE | OPT_FMT_MSBLOB | OPT_FMT_NETSCAPE | \
+        OPT_FMT_NSS | OPT_FMT_TEXT | OPT_FMT_HTTP | OPT_FMT_PVK)
+
+char *opt_progname(const char *argv0);
+char *opt_getprog(void);
+char *opt_init(int ac, char **av, const OPTIONS * o);
+int opt_next();
+int opt_format(const char *s, unsigned long flags, int *result);
+int opt_int(const char *arg, int *result);
+int opt_ulong(const char *arg, unsigned long *result);
+int opt_long(const char *arg, long *result);
+int opt_pair(const char *arg, const OPT_PAIR * pairs, int *result);
+int opt_cipher(const char *name, const EVP_CIPHER **cipherp);
+int opt_md(const char *name, const EVP_MD **mdp);
+char *opt_arg(void);
+char *opt_flag(void);
+char *opt_unknown(void);
+char *opt_reset(void);
+char **opt_rest(void);
+int opt_num_rest(void);
+int opt_verify(int i, X509_VERIFY_PARAM *vpm);
+void opt_help(const OPTIONS * list);
+int opt_format_error(const char *s, unsigned long flags);
+int opt_next(void);
 
 typedef struct args_st {
-    char **data;
-    int count;
+    int size;
+    int argc;
+    char **argv;
 } ARGS;
 
 # define PW_MIN_LENGTH 4
@@ -227,53 +400,48 @@ int password_callback(char *buf, int bufsiz, int verify, PW_CB_DATA *cb_data);
 int setup_ui_method(void);
 void destroy_ui_method(void);
 
-int should_retry(int i);
-int args_from_file(char *file, int *argc, char **argv[]);
-int str2fmt(char *s);
-void program_name(char *in, char *out, int size);
-int chopup_args(ARGS *arg, char *buf, int *argc, char **argv[]);
+int chopup_args(ARGS *arg, char *buf);
 # ifdef HEADER_X509_H
 int dump_cert_text(BIO *out, X509 *x);
 void print_name(BIO *out, const char *title, X509_NAME *nm,
                 unsigned long lflags);
 # endif
+void print_bignum_var(BIO *, BIGNUM *, const char*, int, unsigned char *);
+void print_array(BIO *, const char *, int, const unsigned char *);
 int set_cert_ex(unsigned long *flags, const char *arg);
 int set_name_ex(unsigned long *flags, const char *arg);
 int set_ext_copy(int *copy_type, const char *arg);
 int copy_extensions(X509 *x, X509_REQ *req, int copy_type);
-int app_passwd(BIO *err, char *arg1, char *arg2, char **pass1, char **pass2);
-int add_oid_section(BIO *err, CONF *conf);
-X509 *load_cert(BIO *err, const char *file, int format,
+int app_passwd(char *arg1, char *arg2, char **pass1, char **pass2);
+int add_oid_section(CONF *conf);
+X509 *load_cert(const char *file, int format,
                 const char *pass, ENGINE *e, const char *cert_descrip);
 X509_CRL *load_crl(const char *infile, int format);
-int load_cert_crl_http(const char *url, BIO *err,
-                       X509 **pcert, X509_CRL **pcrl);
-EVP_PKEY *load_key(BIO *err, const char *file, int format, int maybe_stdin,
+int load_cert_crl_http(const char *url, X509 **pcert, X509_CRL **pcrl);
+EVP_PKEY *load_key(const char *file, int format, int maybe_stdin,
                    const char *pass, ENGINE *e, const char *key_descrip);
-EVP_PKEY *load_pubkey(BIO *err, const char *file, int format, int maybe_stdin,
+EVP_PKEY *load_pubkey(const char *file, int format, int maybe_stdin,
                       const char *pass, ENGINE *e, const char *key_descrip);
-STACK_OF(X509) *load_certs(BIO *err, const char *file, int format,
+STACK_OF(X509) *load_certs(const char *file, int format,
                            const char *pass, ENGINE *e,
                            const char *cert_descrip);
-STACK_OF(X509_CRL) *load_crls(BIO *err, const char *file, int format,
+STACK_OF(X509_CRL) *load_crls(const char *file, int format,
                               const char *pass, ENGINE *e,
                               const char *cert_descrip);
-X509_STORE *setup_verify(BIO *bp, char *CAfile, char *CApath);
+X509_STORE *setup_verify(char *CAfile, char *CApath);
+int ctx_set_verify_locations(SSL_CTX *ctx,
+                             const char *CAfile, const char *CApath);
 # ifndef OPENSSL_NO_ENGINE
-ENGINE *setup_engine(BIO *err, const char *engine, int debug);
+ENGINE *setup_engine(const char *engine, int debug);
 # endif
-
 # ifndef OPENSSL_NO_OCSP
-OCSP_RESPONSE *process_responder(BIO *err, OCSP_REQUEST *req,
+OCSP_RESPONSE *process_responder(OCSP_REQUEST *req,
                                  const char *host, const char *path,
                                  const char *port, int use_ssl,
                                  const STACK_OF(CONF_VALUE) *headers,
                                  int req_timeout);
 # endif
 
-int load_config(BIO *err, CONF *cnf);
-char *make_config_name(void);
-
 /* Functions defined in ca.c and also used in ocsp.c */
 int unpack_revinfo(ASN1_TIME **prevtm, int *preason, ASN1_OBJECT **phold,
                    ASN1_GENERALIZEDTIME **pinvtm, const char *str);
@@ -318,17 +486,17 @@ int parse_yesno(const char *str, int def);
 
 X509_NAME *parse_name(char *str, long chtype, int multirdn);
 int args_verify(char ***pargs, int *pargc,
-                int *badarg, BIO *err, X509_VERIFY_PARAM **pm);
+                int *badarg, X509_VERIFY_PARAM **pm);
 void policies_print(BIO *out, X509_STORE_CTX *ctx);
 int bio_to_mem(unsigned char **out, int maxlen, BIO *in);
 int pkey_ctrl_string(EVP_PKEY_CTX *ctx, char *value);
-int init_gen_str(BIO *err, EVP_PKEY_CTX **pctx,
+int init_gen_str(EVP_PKEY_CTX **pctx,
                  const char *algname, ENGINE *e, int do_param);
-int do_X509_sign(BIO *err, X509 *x, EVP_PKEY *pkey, const EVP_MD *md,
+int do_X509_sign(X509 *x, EVP_PKEY *pkey, const EVP_MD *md,
                  STACK_OF(OPENSSL_STRING) *sigopts);
-int do_X509_REQ_sign(BIO *err, X509_REQ *x, EVP_PKEY *pkey, const EVP_MD *md,
+int do_X509_REQ_sign(X509_REQ *x, EVP_PKEY *pkey, const EVP_MD *md,
                      STACK_OF(OPENSSL_STRING) *sigopts);
-int do_X509_CRL_sign(BIO *err, X509_CRL *x, EVP_PKEY *pkey, const EVP_MD *md,
+int do_X509_CRL_sign(X509_CRL *x, EVP_PKEY *pkey, const EVP_MD *md,
                      STACK_OF(OPENSSL_STRING) *sigopts);
 # ifndef OPENSSL_NO_PSK
 extern char *psk_key;
@@ -348,6 +516,7 @@ void print_cert_checks(BIO *bio, X509 *x,
 
 void store_setup_crl_download(X509_STORE *st);
 
+/* See OPT_FMT_xxx, above. */
 # define FORMAT_UNDEF    0
 # define FORMAT_ASN1     1
 # define FORMAT_TEXT     2
@@ -356,8 +525,6 @@ void store_setup_crl_download(X509_STORE *st);
 # define FORMAT_PKCS12   5
 # define FORMAT_SMIME    6
 # define FORMAT_ENGINE   7
-# define FORMAT_IISSGC   8      /* XXX this stupid macro helps us to avoid
-                                 * adding yet another param to load_*key() */
 # define FORMAT_PEMRSA   9      /* PEM RSAPubicKey format */
 # define FORMAT_ASN1RSA  10     /* DER RSAPubicKey format */
 # define FORMAT_MSBLOB   11     /* MS Key blob format */
@@ -376,6 +543,7 @@ void store_setup_crl_download(X509_STORE *st);
 # define SERIAL_RAND_BITS        64
 
 int app_isdir(const char *);
+int app_access(const char *, int flag);
 int raw_read_stdin(void *, int);
 int raw_write_stdout(const void *, int);
 
@@ -383,4 +551,6 @@ int raw_write_stdout(const void *, int);
 # define TM_STOP         1
 double app_tminterval(int stop, int usertime);
 
+# include &quot;progs.h&quot;
+
 #endif
diff --git a/apps/asn1pars.c b/apps/asn1pars.c
index 1576f1c..e96491a 100644
--- a/apps/asn1pars.c
+++ b/apps/asn1pars.c
@@ -1,4 +1,3 @@
-/* apps/asn1pars.c */
 /* Copyright (C) 1995-1998 Eric Young (<A HREF="../../../mailman/listinfo/openssl-commits.html">eay at cryptsoft.com</A>)
  * All rights reserved.
  *
@@ -70,190 +69,136 @@
 #include &lt;openssl/x509.h&gt;
 #include &lt;openssl/pem.h&gt;
 
-/*-
- * -inform arg  - input format - default PEM (DER or PEM)
- * -in arg      - input file - default stdin
- * -i           - indent the details by depth
- * -offset      - where in the file to start
- * -length      - how many bytes to use
- * -oid file    - extra oid description file
- */
-
-#undef PROG
-#define PROG    asn1parse_main
-
-int MAIN(int, char **);
+typedef enum OPTION_choice {
+    OPT_ERR = -1, OPT_EOF = 0, OPT_HELP,
+    OPT_INFORM, OPT_IN, OPT_OUT, OPT_INDENT, OPT_NOOUT,
+    OPT_OID, OPT_OFFSET, OPT_LENGTH, OPT_DUMP, OPT_DLIMIT,
+    OPT_STRPARSE, OPT_GENSTR, OPT_GENCONF, OPT_STRICTPEM
+} OPTION_CHOICE;
+
+OPTIONS asn1parse_options[] = {
+    {&quot;help&quot;, OPT_HELP, '-', &quot;Display this summary&quot;},
+    {&quot;inform&quot;, OPT_INFORM, 'F', &quot;input format - one of DER PEM&quot;},
+    {&quot;in&quot;, OPT_IN, '&lt;', &quot;input file&quot;},
+    {&quot;out&quot;, OPT_OUT, '&gt;', &quot;output file (output format is always DER)&quot;},
+    {&quot;i&quot;, OPT_INDENT, 0, &quot;entries&quot;},
+    {&quot;noout&quot;, OPT_NOOUT, 0, &quot;don't produce any output&quot;},
+    {&quot;offset&quot;, OPT_OFFSET, 'p', &quot;offset into file&quot;},
+    {&quot;length&quot;, OPT_LENGTH, 'p', &quot;length of section in file&quot;},
+    {&quot;oid&quot;, OPT_OID, '&lt;', &quot;file of extra oid definitions&quot;},
+    {&quot;dump&quot;, OPT_DUMP, 0, &quot;unknown data in hex form&quot;},
+    {&quot;dlimit&quot;, OPT_DLIMIT, 'p',
+     &quot;dump the first arg bytes of unknown data in hex form&quot;},
+    {&quot;strparse&quot;, OPT_STRPARSE, 's',
+     &quot;offset; a series of these can be used to 'dig'&quot;},
+    {OPT_MORE_STR, 0, 0, &quot;into multiple ASN1 blob wrappings&quot;},
+    {&quot;genstr&quot;, OPT_GENSTR, 's', &quot;string to generate ASN1 structure from&quot;},
+    {&quot;genconf&quot;, OPT_GENCONF, 's', &quot;file to generate ASN1 structure from&quot;},
+    {OPT_MORE_STR, 0, 0, &quot;(-inform  will be ignored)&quot;},
+    {&quot;strictpem&quot;, OPT_STRICTPEM, 0,
+     &quot;do not attempt base64 decode outside PEM markers&quot;},
+    {NULL}
+};
 
 static int do_generate(BIO *bio, char *genstr, char *genconf, BUF_MEM *buf);
 
-int MAIN(int argc, char **argv)
+int asn1parse_main(int argc, char **argv)
 {
-    int i, badops = 0, offset = 0, ret = 1, j;
-    unsigned int length = 0;
-    long num, tmplen;
-    BIO *in = NULL, *out = NULL, *b64 = NULL, *derout = NULL;
-    int informat, indent = 0, noout = 0, dump = 0, strictpem = 0;
-    char *infile = NULL, *str = NULL, *prog, *oidfile = NULL, *derfile =
-        NULL, *name = NULL, *header = NULL;
-    char *genstr = NULL, *genconf = NULL;
-    unsigned char *tmpbuf;
-    const unsigned char *ctmpbuf;
+    ASN1_TYPE *at = NULL;
+    BIO *in = NULL, *b64 = NULL, *derout = NULL;
     BUF_MEM *buf = NULL;
     STACK_OF(OPENSSL_STRING) *osk = NULL;
-    ASN1_TYPE *at = NULL;
-
-    informat = FORMAT_PEM;
-
-    apps_startup();
-
-    if (bio_err == NULL)
-        if ((bio_err = BIO_new(BIO_s_file())) != NULL)
-            BIO_set_fp(bio_err, stderr, BIO_NOCLOSE | BIO_FP_TEXT);
+    char *genstr = NULL, *genconf = NULL;
+    char *infile = NULL, *str = NULL, *oidfile = NULL, *derfile = NULL;
+    char *name = NULL, *header = NULL, *prog;
+    const unsigned char *ctmpbuf;
+    int indent = 0, noout = 0, dump = 0, strictpem = 0, informat = FORMAT_PEM;
+    int offset = 0, ret = 1, i, j;
+    long num, tmplen;
+    unsigned char *tmpbuf;
+    unsigned int length = 0;
+    OPTION_CHOICE o;
 
-    if (!load_config(bio_err, NULL))
-        goto end;
+    prog = opt_init(argc, argv, asn1parse_options);
 
-    prog = argv[0];
-    argc--;
-    argv++;
     if ((osk = sk_OPENSSL_STRING_new_null()) == NULL) {
-        BIO_printf(bio_err, &quot;Memory allocation failure\n&quot;);
+        BIO_printf(bio_err, &quot;%s: Memory allocation failure\n&quot;, prog);
         goto end;
     }
-    while (argc &gt;= 1) {
-        if (strcmp(*argv, &quot;-inform&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            informat = str2fmt(*(++argv));
-        } else if (strcmp(*argv, &quot;-in&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            infile = *(++argv);
-        } else if (strcmp(*argv, &quot;-out&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            derfile = *(++argv);
-        } else if (strcmp(*argv, &quot;-i&quot;) == 0) {
+
+    while ((o = opt_next()) != OPT_EOF) {
+        switch (o) {
+        case OPT_EOF:
+        case OPT_ERR:
+ opthelp:
+            BIO_printf(bio_err, &quot;%s: Use -help for summary.\n&quot;, prog);
+            goto end;
+        case OPT_HELP:
+            opt_help(asn1parse_options);
+            ret = 0;
+            goto end;
+        case OPT_INFORM:
+            if (!opt_format(opt_arg(), OPT_FMT_PEMDER, &amp;informat))
+                goto opthelp;
+            goto end;
+        case OPT_IN:
+            infile = opt_arg();
+            break;
+        case OPT_OUT:
+            derfile = opt_arg();
+            break;
+        case OPT_INDENT:
             indent = 1;
-        } else if (strcmp(*argv, &quot;-noout&quot;) == 0)
+            break;
+        case OPT_NOOUT:
             noout = 1;
-        else if (strcmp(*argv, &quot;-oid&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            oidfile = *(++argv);
-        } else if (strcmp(*argv, &quot;-offset&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            offset = atoi(*(++argv));
-        } else if (strcmp(*argv, &quot;-length&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            length = atoi(*(++argv));
-            if (length == 0)
-                goto bad;
-        } else if (strcmp(*argv, &quot;-dump&quot;) == 0) {
+            break;
+        case OPT_OID:
+            oidfile = opt_arg();
+            break;
+        case OPT_OFFSET:
+            offset = strtol(opt_arg(), NULL, 0);
+            break;
+        case OPT_LENGTH:
+            length = atoi(opt_arg());
+            break;
+        case OPT_DUMP:
             dump = -1;
-        } else if (strcmp(*argv, &quot;-dlimit&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            dump = atoi(*(++argv));
-            if (dump &lt;= 0)
-                goto bad;
-        } else if (strcmp(*argv, &quot;-strparse&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            sk_OPENSSL_STRING_push(osk, *(++argv));
-        } else if (strcmp(*argv, &quot;-genstr&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            genstr = *(++argv);
-        } else if (strcmp(*argv, &quot;-genconf&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            genconf = *(++argv);
-        } else if (strcmp(*argv, &quot;-strictpem&quot;) == 0) {
+            break;
+        case OPT_DLIMIT:
+            dump = atoi(opt_arg());
+            break;
+        case OPT_STRPARSE:
+            sk_OPENSSL_STRING_push(osk, opt_arg());
+            break;
+        case OPT_GENSTR:
+            genstr = opt_arg();
+            break;
+        case OPT_GENCONF:
+            genconf = opt_arg();
+            break;
+        case OPT_STRICTPEM:
             strictpem = 1;
             informat = FORMAT_PEM;
-        } else {
-            BIO_printf(bio_err, &quot;unknown option %s\n&quot;, *argv);
-            badops = 1;
             break;
         }
-        argc--;
-        argv++;
     }
-
-    if (badops) {
- bad:
-        BIO_printf(bio_err, &quot;%s [options] &lt;infile\n&quot;, prog);
-        BIO_printf(bio_err, &quot;where options are\n&quot;);
-        BIO_printf(bio_err, &quot; -inform arg   input format - one of DER PEM\n&quot;);
-        BIO_printf(bio_err, &quot; -in arg       input file\n&quot;);
-        BIO_printf(bio_err,
-                   &quot; -out arg      output file (output format is always DER\n&quot;);
-        BIO_printf(bio_err, &quot; -noout arg    don't produce any output\n&quot;);
-        BIO_printf(bio_err, &quot; -offset arg   offset into file\n&quot;);
-        BIO_printf(bio_err, &quot; -length arg   length of section in file\n&quot;);
-        BIO_printf(bio_err, &quot; -i            indent entries\n&quot;);
-        BIO_printf(bio_err, &quot; -dump         dump unknown data in hex form\n&quot;);
-        BIO_printf(bio_err,
-                   &quot; -dlimit arg   dump the first arg bytes of unknown data in hex form\n&quot;);
-        BIO_printf(bio_err, &quot; -oid file     file of extra oid definitions\n&quot;);
-        BIO_printf(bio_err, &quot; -strparse offset\n&quot;);
-        BIO_printf(bio_err,
-                   &quot;               a series of these can be used to 'dig' into multiple\n&quot;);
-        BIO_printf(bio_err, &quot;               ASN1 blob wrappings\n&quot;);
-        BIO_printf(bio_err,
-                   &quot; -genstr str   string to generate ASN1 structure from\n&quot;);
-        BIO_printf(bio_err,
-                   &quot; -genconf file file to generate ASN1 structure from\n&quot;);
-        BIO_printf(bio_err,
-                   &quot; -strictpem    do not attempt base64 decode outside PEM markers (-inform \n&quot;);
-        BIO_printf(bio_err, &quot;               will be ignored)\n&quot;);
-        goto end;
-    }
-
-    ERR_load_crypto_strings();
-
-    in = BIO_new(BIO_s_file());
-    out = BIO_new(BIO_s_file());
-    if ((in == NULL) || (out == NULL)) {
-        ERR_print_errors(bio_err);
-        goto end;
-    }
-    BIO_set_fp(out, stdout, BIO_NOCLOSE | BIO_FP_TEXT);
-#ifdef OPENSSL_SYS_VMS
-    {
-        BIO *tmpbio = BIO_new(BIO_f_linebuffer());
-        out = BIO_push(tmpbio, out);
-    }
-#endif
+    argc = opt_num_rest();
+    argv = opt_rest();
 
     if (oidfile != NULL) {
-        if (BIO_read_filename(in, oidfile) &lt;= 0) {
-            BIO_printf(bio_err, &quot;problems opening %s\n&quot;, oidfile);
-            ERR_print_errors(bio_err);
+        in = bio_open_default(oidfile, &quot;r&quot;);
+        if (in == NULL)
             goto end;
-        }
         OBJ_create_objects(in);
+        BIO_free(in);
     }
 
-    if (infile == NULL)
-        BIO_set_fp(in, stdin, BIO_NOCLOSE);
-    else {
-        if (BIO_read_filename(in, infile) &lt;= 0) {
-            perror(infile);
-            goto end;
-        }
-    }
+    if ((in = bio_open_default(infile, &quot;r&quot;)) == NULL)
+        goto end;
 
-    if (derfile) {
-        if (!(derout = BIO_new_file(derfile, &quot;wb&quot;))) {
-            BIO_printf(bio_err, &quot;problems opening %s\n&quot;, derfile);
-            ERR_print_errors(bio_err);
-            goto end;
-        }
-    }
+    if (derfile &amp;&amp; (derout = bio_open_default(derfile, &quot;wb&quot;)) == NULL)
+        goto end;
 
     if (strictpem) {
         if (PEM_read_bio(in, &amp;name, &amp;header, (unsigned char **)&amp;str, &amp;num) !=
@@ -362,7 +307,7 @@ int MAIN(int argc, char **argv)
         }
     }
     if (!noout &amp;&amp;
-        !ASN1_parse_dump(out, (unsigned char *)&amp;(str[offset]), length,
+        !ASN1_parse_dump(bio_out, (unsigned char *)&amp;(str[offset]), length,
                          indent, dump)) {
         ERR_print_errors(bio_err);
         goto end;
@@ -371,7 +316,6 @@ int MAIN(int argc, char **argv)
  end:
     BIO_free(derout);
     BIO_free(in);
-    BIO_free_all(out);
     BIO_free(b64);
     if (ret != 0)
         ERR_print_errors(bio_err);
@@ -388,8 +332,7 @@ int MAIN(int argc, char **argv)
     if (osk != NULL)
         sk_OPENSSL_STRING_free(osk);
     OBJ_cleanup();
-    apps_shutdown();
-    OPENSSL_EXIT(ret);
+    return (ret);
 }
 
 static int do_generate(BIO *bio, char *genstr, char *genconf, BUF_MEM *buf)
diff --git a/apps/ca.c b/apps/ca.c
index e2eab91..af3afaa 100644
--- a/apps/ca.c
+++ b/apps/ca.c
@@ -1,4 +1,3 @@
-/* apps/ca.c */
 /* Copyright (C) 1995-1998 Eric Young (<A HREF="../../../mailman/listinfo/openssl-commits.html">eay at cryptsoft.com</A>)
  * All rights reserved.
  *
@@ -96,8 +95,8 @@
 # define R_OK 4
 #endif
 
-#undef PROG
-#define PROG ca_main
+#undef BSIZE
+#define BSIZE 256
 
 #define BASE_SECTION    &quot;ca&quot;
 #define CONFIG_FILE &quot;openssl.cnf&quot;
@@ -112,7 +111,7 @@
 #define ENV_CRL_DIR             &quot;crl_dir&quot;
 #define ENV_CA_DB               &quot;CA_DB&quot;
 #define ENV_NEW_CERTS_DIR       &quot;new_certs_dir&quot;
-#define ENV_CERTIFICATE         &quot;certificate&quot;
+#define ENV_CERTIFICATE &quot;certificate&quot;
 #define ENV_SERIAL              &quot;serial&quot;
 #define ENV_CRLNUMBER           &quot;crlnumber&quot;
 #define ENV_CRL                 &quot;crl&quot;
@@ -145,50 +144,6 @@
 #define REV_KEY_COMPROMISE      3 /* Value is cert key compromise time */
 #define REV_CA_COMPROMISE       4 /* Value is CA key compromise time */
 
-static const char *ca_usage[] = {
-    &quot;usage: ca args\n&quot;,
-    &quot;\n&quot;,
-    &quot; -verbose        - Talk a lot while doing things\n&quot;,
-    &quot; -config file    - A config file\n&quot;,
-    &quot; -name arg       - The particular CA definition to use\n&quot;,
-    &quot; -gencrl         - Generate a new CRL\n&quot;,
-    &quot; -crldays days   - Days is when the next CRL is due\n&quot;,
-    &quot; -crlhours hours - Hours is when the next CRL is due\n&quot;,
-    &quot; -startdate YYMMDDHHMMSSZ  - certificate validity notBefore\n&quot;,
-    &quot; -enddate YYMMDDHHMMSSZ    - certificate validity notAfter (overrides -days)\n&quot;,
-    &quot; -days arg       - number of days to certify the certificate for\n&quot;,
-    &quot; -md arg         - md to use, one of md2, md5, sha or sha1\n&quot;,
-    &quot; -policy arg     - The CA 'policy' to support\n&quot;,
-    &quot; -keyfile arg    - private key file\n&quot;,
-    &quot; -keyform arg    - private key file format (PEM or ENGINE)\n&quot;,
-    &quot; -key arg        - key to decode the private key if it is encrypted\n&quot;,
-    &quot; -cert file      - The CA certificate\n&quot;,
-    &quot; -selfsign       - sign a certificate with the key associated with it\n&quot;,
-    &quot; -in file        - The input PEM encoded certificate request(s)\n&quot;,
-    &quot; -out file       - Where to put the output file(s)\n&quot;,
-    &quot; -outdir dir     - Where to put output certificates\n&quot;,
-    &quot; -infiles ....   - The last argument, requests to process\n&quot;,
-    &quot; -spkac file     - File contains DN and signed public key and challenge\n&quot;,
-    &quot; -ss_cert file   - File contains a self signed cert to sign\n&quot;,
-    &quot; -preserveDN     - Don't re-order the DN\n&quot;,
-    &quot; -noemailDN      - Don't add the EMAIL field into certificate' subject\n&quot;,
-    &quot; -batch          - Don't ask questions\n&quot;,
-    &quot; -msie_hack      - msie modifications to handle all those universal strings\n&quot;,
-    &quot; -revoke file    - Revoke a certificate (given in file)\n&quot;,
-    &quot; -subj arg       - Use arg instead of request's subject\n&quot;,
-    &quot; -utf8           - input characters are UTF8 (default ASCII)\n&quot;,
-    &quot; -multivalue-rdn - enable support for multivalued RDNs\n&quot;,
-    &quot; -extensions ..  - Extension section (override value in config file)\n&quot;,
-    &quot; -extfile file   - Configuration file with X509v3 extensions to add\n&quot;,
-    &quot; -crlexts ..     - CRL extension section (override value in config file)\n&quot;,
-#ifndef OPENSSL_NO_ENGINE
-    &quot; -engine e       - use engine e, possibly a hardware device.\n&quot;,
-#endif
-    &quot; -status serial  - Shows certificate status given the serial number\n&quot;,
-    &quot; -updatedb       - Updates db for expired certificates\n&quot;,
-    NULL
-};
-
 #ifdef EFENCE
 extern int EF_PROTECT_FREE;
 extern int EF_PROTECT_BELOW;
@@ -239,97 +194,126 @@ static int check_time_format(const char *str);
 char *make_revocation_str(int rev_type, char *rev_arg);
 int make_revoked(X509_REVOKED *rev, const char *str);
 int old_entry_print(BIO *bp, ASN1_OBJECT *obj, ASN1_STRING *str);
+
 static CONF *conf = NULL;
 static CONF *extconf = NULL;
 static char *section = NULL;
-
 static int preserve = 0;
 static int msie_hack = 0;
 
-int MAIN(int, char **);
+typedef enum OPTION_choice {
+    OPT_ERR = -1, OPT_EOF = 0, OPT_HELP,
+    OPT_ENGINE, OPT_VERBOSE, OPT_CONFIG, OPT_NAME, OPT_SUBJ, OPT_UTF8,
+    OPT_CREATE_SERIAL, OPT_MULTIVALUE_RDN, OPT_STARTDATE, OPT_ENDDATE,
+    OPT_DAYS, OPT_MD, OPT_POLICY, OPT_KEYFILE, OPT_KEYFORM, OPT_PASSIN,
+    OPT_KEY, OPT_CERT, OPT_SELFSIGN, OPT_IN, OPT_OUT, OPT_OUTDIR,
+    OPT_SIGOPT, OPT_NOTEXT, OPT_BATCH, OPT_PRESERVEDN, OPT_NOEMAILDN,
+    OPT_GENCRL, OPT_MSIE_HACK, OPT_CRLDAYS, OPT_CRLHOURS, OPT_CRLSEC,
+    OPT_INFILES, OPT_SS_CERT, OPT_SPKAC, OPT_REVOKE, OPT_VALID,
+    OPT_EXTENSIONS, OPT_EXTFILE, OPT_STATUS, OPT_UPDATEDB, OPT_CRLEXTS,
+    OPT_CRL_REASON, OPT_CRL_HOLD, OPT_CRL_COMPROMISE,
+    OPT_CRL_CA_COMPROMISE
+} OPTION_CHOICE;
+
+OPTIONS ca_options[] = {
+    {&quot;help&quot;, OPT_HELP, '-', &quot;Display this summary&quot;},
+    {&quot;verbose&quot;, OPT_VERBOSE, '-', &quot;Verbose output during processing&quot;},
+    {&quot;config&quot;, OPT_CONFIG, 's', &quot;A config file&quot;},
+    {&quot;name&quot;, OPT_NAME, 's', &quot;The particular CA definition to use&quot;},
+    {&quot;subj&quot;, OPT_SUBJ, 's', &quot;Use arg instead of request's subject&quot;},
+    {&quot;utf8&quot;, OPT_UTF8, '-', &quot;Input characters are UTF8 (default ASCII)&quot;},
+    {&quot;create_serial&quot;, OPT_CREATE_SERIAL, '-'},
+    {&quot;multivalue-rdn&quot;, OPT_MULTIVALUE_RDN, '-',
+     &quot;Enable support for multivalued RDNs&quot;},
+    {&quot;startdate&quot;, OPT_STARTDATE, 's', &quot;Cert notBefore, YYMMDDHHMMSSZ&quot;},
+    {&quot;enddate&quot;, OPT_ENDDATE, 's',
+     &quot;YYMMDDHHMMSSZ cert notAfter (overrides -days)&quot;},
+    {&quot;days&quot;, OPT_DAYS, 'p', &quot;Number of days to certify the cert for&quot;},
+    {&quot;md&quot;, OPT_MD, 's', &quot;md to use; one of md2, md5, sha or sha1&quot;},
+    {&quot;policy&quot;, OPT_POLICY, 's', &quot;The CA 'policy' to support&quot;},
+    {&quot;keyfile&quot;, OPT_KEYFILE, '&lt;', &quot;Private key file&quot;},
+    {&quot;keyform&quot;, OPT_KEYFORM, 'f', &quot;Private key file format (PEM or ENGINE)&quot;},
+    {&quot;passin&quot;, OPT_PASSIN, 's'},
+    {&quot;key&quot;, OPT_KEY, 's', &quot;Key to decode the private key if it is encrypted&quot;},
+    {&quot;cert&quot;, OPT_CERT, '&lt;', &quot;The CA cert&quot;},
+    {&quot;selfsign&quot;, OPT_SELFSIGN, '-',
+     &quot;Sign a cert with the key associated with it&quot;},
+    {&quot;in&quot;, OPT_IN, '&lt;', &quot;The input PEM encoded cert request(s)&quot;},
+    {&quot;out&quot;, OPT_OUT, '&gt;', &quot;Where to put the output file(s)&quot;},
+    {&quot;outdir&quot;, OPT_OUTDIR, '/', &quot;Where to put output cert&quot;},
+    {&quot;sigopt&quot;, OPT_SIGOPT, 's'},
+    {&quot;notext&quot;, OPT_NOTEXT, '-'},
+    {&quot;batch&quot;, OPT_BATCH, '-', &quot;Don't ask questions&quot;},
+    {&quot;preserveDN&quot;, OPT_PRESERVEDN, '-', &quot;Don't re-order the DN&quot;},
+    {&quot;noemailDN&quot;, OPT_NOEMAILDN, '-', &quot;Don't add the EMAIL field to the DN&quot;},
+    {&quot;gencrl&quot;, OPT_GENCRL, '-', &quot;Generate a new CRL&quot;},
+    {&quot;msie_hack&quot;, OPT_MSIE_HACK, '-',
+     &quot;msie modifications to handle all those universal strings&quot;},
+    {&quot;crldays&quot;, OPT_CRLDAYS, 'p', &quot;Days is when the next CRL is due&quot;},
+    {&quot;crlhours&quot;, OPT_CRLHOURS, 'p', &quot;Hours is when the next CRL is due&quot;},
+    {&quot;crlsec&quot;, OPT_CRLSEC, 'p'},
+    {&quot;infiles&quot;, OPT_INFILES, '-', &quot;The last argument, requests to process&quot;},
+    {&quot;ss_cert&quot;, OPT_SS_CERT, '&lt;', &quot;File contains a self signed cert to sign&quot;},
+    {&quot;spkac&quot;, OPT_SPKAC, '&lt;',
+     &quot;File contains DN and signed public key and challenge&quot;},
+    {&quot;revoke&quot;, OPT_REVOKE, '&lt;', &quot;Revoke a cert (given in file)&quot;},
+    {&quot;valid&quot;, OPT_VALID, 's'},
+    {&quot;extensions&quot;, OPT_EXTENSIONS, 's',
+     &quot;Extension section (override value in config file)&quot;},
+    {&quot;extfile&quot;, OPT_EXTFILE, '&lt;',
+     &quot;Configuration file with X509v3 extensions to add&quot;},
+    {&quot;status&quot;, OPT_STATUS, 's', &quot;Shows cert status given the serial number&quot;},
+    {&quot;updatedb&quot;, OPT_UPDATEDB, '-', &quot;Updates db for expired cert&quot;},
+    {&quot;crlexts&quot;, OPT_CRLEXTS, 's',
+     &quot;CRL extension section (override value in config file)&quot;},
+    {&quot;crl_reason&quot;, OPT_CRL_REASON, 's'},
+    {&quot;crl_hold&quot;, OPT_CRL_HOLD, 's'},
+    {&quot;crl_compromise&quot;, OPT_CRL_COMPROMISE, 's'},
+    {&quot;crl_CA_compromise&quot;, OPT_CRL_CA_COMPROMISE, 's'},
+#ifndef OPENSSL_NO_ENGINE
+    {&quot;engine&quot;, OPT_ENGINE, 's', &quot;Use engine, possibly a hardware device&quot;},
+#endif
+    {NULL}
+};
 
-int MAIN(int argc, char **argv)
+int ca_main(int argc, char **argv)
 {
     ENGINE *e = NULL;
-    char *key = NULL, *passargin = NULL;
-    int create_ser = 0;
-    int free_key = 0;
-    int total = 0;
-    int total_done = 0;
-    int badops = 0;
-    int ret = 1;
-    int email_dn = 1;
-    int req = 0;
-    int verbose = 0;
-    int gencrl = 0;
-    int dorevoke = 0;
-    int doupdatedb = 0;
-    long crldays = 0;
-    long crlhours = 0;
-    long crlsec = 0;
-    long errorline = -1;
-    char *configfile = NULL;
-    char *md = NULL;
-    char *policy = NULL;
-    char *keyfile = NULL;
-    char *certfile = NULL;
-    int keyform = FORMAT_PEM;
-    char *infile = NULL;
-    char *spkac_file = NULL;
-    char *ss_cert_file = NULL;
-    char *ser_status = NULL;
+    BIGNUM *crlnumber = NULL, *serial = NULL;
     EVP_PKEY *pkey = NULL;
-    int output_der = 0;
-    char *outfile = NULL;
-    char *outdir = NULL;
-    char *serialfile = NULL;
-    char *crlnumberfile = NULL;
-    char *extensions = NULL;
-    char *extfile = NULL;
-    char *subj = NULL;
-    unsigned long chtype = MBSTRING_ASC;
-    int multirdn = 0;
-    char *tmp_email_dn = NULL;
-    char *crl_ext = NULL;
-    int rev_type = REV_NONE;
-    char *rev_arg = NULL;
-    BIGNUM *serial = NULL;
-    BIGNUM *crlnumber = NULL;
-    char *startdate = NULL;
-    char *enddate = NULL;
-    long days = 0;
-    int batch = 0;
-    int notext = 0;
-    unsigned long nameopt = 0, certopt = 0;
-    int default_op = 1;
-    int ext_copy = EXT_COPY_NONE;
-    int selfsign = 0;
-    X509 *x509 = NULL, *x509p = NULL;
-    X509 *x = NULL;
     BIO *in = NULL, *out = NULL, *Sout = NULL, *Cout = NULL;
-    char *dbfile = NULL;
-    CA_DB *db = NULL;
-    X509_CRL *crl = NULL;
-    X509_REVOKED *r = NULL;
-    ASN1_TIME *tmptm;
     ASN1_INTEGER *tmpser;
-    char *f;
-    const char *p;
-    char *const *pp;
-    int i, j;
-    const EVP_MD *dgst = NULL;
+    ASN1_TIME *tmptm;
+    CA_DB *db = NULL;
+    DB_ATTR db_attr;
     STACK_OF(CONF_VALUE) *attribs = NULL;
-    STACK_OF(X509) *cert_sk = NULL;
     STACK_OF(OPENSSL_STRING) *sigopts = NULL;
-#undef BSIZE
-#define BSIZE 256
+    STACK_OF(X509) *cert_sk = NULL;
+    X509_CRL *crl = NULL;
+    const EVP_MD *dgst = NULL;
+    char *configfile = NULL, *md = NULL, *policy = NULL, *keyfile = NULL;
+    char *certfile = NULL, *crl_ext = NULL, *crlnumberfile = NULL, *enddate =
+        NULL;
+    char *infile = NULL, *spkac_file = NULL, *ss_cert_file = NULL;
+    char *extensions = NULL, *extfile = NULL, *key = NULL, *passinarg = NULL;
+    char *outdir = NULL, *outfile = NULL, *rev_arg = NULL, *ser_status = NULL;
+    char *serialfile = NULL, *startdate = NULL, *subj = NULL, *tmp_email_dn =
+        NULL;
+    char *prog;
+    char *const *pp;
+    char *dbfile = NULL, *engine = NULL, *f, *randfile = NULL, *tofree = NULL;
     char buf[3][BSIZE];
-    char *randfile = NULL;
-#ifndef OPENSSL_NO_ENGINE
-    char *engine = NULL;
-#endif
-    char *tofree = NULL;
-    DB_ATTR db_attr;
+    const char *p;
+    int create_ser = 0, free_key = 0, total = 0, total_done = 0;
+    int batch = 0, default_op = 1, doupdatedb = 0, ext_copy = EXT_COPY_NONE;
+    int keyformat = FORMAT_PEM, multirdn = 0, notext = 0, output_der = 0;
+    int ret = 1, email_dn = 1, req = 0, verbose = 0, gencrl = 0, dorevoke = 0;
+    int i, j, rev_type = REV_NONE, selfsign = 0;
+    long crldays = 0, crlhours = 0, crlsec = 0, errorline = -1, days = 0;
+    unsigned long chtype = MBSTRING_ASC, nameopt = 0, certopt = 0;
+    X509 *x509 = NULL, *x509p = NULL, *x = NULL;
+    X509_REVOKED *r = NULL;
+    OPTION_CHOICE o;
 
 #ifdef EFENCE
     EF_PROTECT_FREE = 1;
@@ -337,220 +321,181 @@ int MAIN(int argc, char **argv)
     EF_ALIGNMENT = 0;
 #endif
 
-    apps_startup();
-
     conf = NULL;
-    key = NULL;
     section = NULL;
-
     preserve = 0;
     msie_hack = 0;
-    if (bio_err == NULL)
-        if ((bio_err = BIO_new(BIO_s_file())) != NULL)
-            BIO_set_fp(bio_err, stderr, BIO_NOCLOSE | BIO_FP_TEXT);
-
-    argc--;
-    argv++;
-    while (argc &gt;= 1) {
-        if (strcmp(*argv, &quot;-verbose&quot;) == 0)
-            verbose = 1;
-        else if (strcmp(*argv, &quot;-config&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            configfile = *(++argv);
-        } else if (strcmp(*argv, &quot;-name&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            section = *(++argv);
-        } else if (strcmp(*argv, &quot;-subj&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            subj = *(++argv);
-            /* preserve=1; */
-        } else if (strcmp(*argv, &quot;-utf8&quot;) == 0)
-            chtype = MBSTRING_UTF8;
-        else if (strcmp(*argv, &quot;-create_serial&quot;) == 0)
+
+    prog = opt_init(argc, argv, ca_options);
+    while ((o = opt_next()) != OPT_EOF) {
+        switch (o) {
+            case OPT_EOF:
+            case OPT_ERR:
+opthelp:
+                BIO_printf(bio_err, &quot;%s: Use -help for summary.\n&quot;, prog);
+                goto end;
+            case OPT_HELP:
+                opt_help(ca_options);
+                ret = 0;
+                goto end;
+            case OPT_IN:
+                infile = opt_arg();
+                break;
+            case OPT_OUT:
+                outfile = opt_arg();
+                break;
+            case OPT_VERBOSE:
+                verbose = 1;
+                break;
+            case OPT_CONFIG:
+                configfile = opt_arg();
+                break;
+            case OPT_NAME:
+                section = opt_arg();
+                break;
+            case OPT_SUBJ:
+                subj = opt_arg();
+                /* preserve=1; */
+                break;
+            case OPT_UTF8:
+                chtype = MBSTRING_UTF8;
+                break;
+        case OPT_CREATE_SERIAL:
             create_ser = 1;
-        else if (strcmp(*argv, &quot;-multivalue-rdn&quot;) == 0)
+            break;
+        case OPT_MULTIVALUE_RDN:
             multirdn = 1;
-        else if (strcmp(*argv, &quot;-startdate&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            startdate = *(++argv);
-        } else if (strcmp(*argv, &quot;-enddate&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            enddate = *(++argv);
-        } else if (strcmp(*argv, &quot;-days&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            days = atoi(*(++argv));
-        } else if (strcmp(*argv, &quot;-md&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            md = *(++argv);
-        } else if (strcmp(*argv, &quot;-policy&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            policy = *(++argv);
-        } else if (strcmp(*argv, &quot;-keyfile&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            keyfile = *(++argv);
-        } else if (strcmp(*argv, &quot;-keyform&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            keyform = str2fmt(*(++argv));
-        } else if (strcmp(*argv, &quot;-passin&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            passargin = *(++argv);
-        } else if (strcmp(*argv, &quot;-key&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            key = *(++argv);
-        } else if (strcmp(*argv, &quot;-cert&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            certfile = *(++argv);
-        } else if (strcmp(*argv, &quot;-selfsign&quot;) == 0)
+            break;
+        case OPT_STARTDATE:
+            startdate = opt_arg();
+            break;
+        case OPT_ENDDATE:
+            enddate = opt_arg();
+            break;
+        case OPT_DAYS:
+            days = atoi(opt_arg());
+            break;
+        case OPT_MD:
+            md = opt_arg();
+            break;
+        case OPT_POLICY:
+            policy = opt_arg();
+            break;
+        case OPT_KEYFILE:
+            keyfile = opt_arg();
+            break;
+        case OPT_KEYFORM:
+            if (!opt_format(opt_arg(), OPT_FMT_ANY, &amp;keyformat))
+                goto opthelp;
+            break;
+        case OPT_PASSIN:
+            passinarg = opt_arg();
+            break;
+        case OPT_KEY:
+            key = opt_arg();
+            break;
+        case OPT_CERT:
+            certfile = opt_arg();
+            break;
+        case OPT_SELFSIGN:
             selfsign = 1;
-        else if (strcmp(*argv, &quot;-in&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            infile = *(++argv);
-            req = 1;
-        } else if (strcmp(*argv, &quot;-out&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            outfile = *(++argv);
-        } else if (strcmp(*argv, &quot;-outdir&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            outdir = *(++argv);
-        } else if (strcmp(*argv, &quot;-sigopt&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            if (!sigopts)
+            break;
+        case OPT_OUTDIR:
+            outdir = opt_arg();
+            break;
+        case OPT_SIGOPT:
+            if (sigopts == NULL)
                 sigopts = sk_OPENSSL_STRING_new_null();
-            if (!sigopts || !sk_OPENSSL_STRING_push(sigopts, *(++argv)))
-                goto bad;
-        } else if (strcmp(*argv, &quot;-notext&quot;) == 0)
+            if (sigopts == NULL
+                || !sk_OPENSSL_STRING_push(sigopts, opt_arg()))
+                goto end;
+            break;
+        case OPT_NOTEXT:
             notext = 1;
-        else if (strcmp(*argv, &quot;-batch&quot;) == 0)
+            break;
+        case OPT_BATCH:
             batch = 1;
-        else if (strcmp(*argv, &quot;-preserveDN&quot;) == 0)
+            break;
+        case OPT_PRESERVEDN:
             preserve = 1;
-        else if (strcmp(*argv, &quot;-noemailDN&quot;) == 0)
+            break;
+        case OPT_NOEMAILDN:
             email_dn = 0;
-        else if (strcmp(*argv, &quot;-gencrl&quot;) == 0)
+            break;
+        case OPT_GENCRL:
             gencrl = 1;
-        else if (strcmp(*argv, &quot;-msie_hack&quot;) == 0)
+            break;
+        case OPT_MSIE_HACK:
             msie_hack = 1;
-        else if (strcmp(*argv, &quot;-crldays&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            crldays = atol(*(++argv));
-        } else if (strcmp(*argv, &quot;-crlhours&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            crlhours = atol(*(++argv));
-        } else if (strcmp(*argv, &quot;-crlsec&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            crlsec = atol(*(++argv));
-        } else if (strcmp(*argv, &quot;-infiles&quot;) == 0) {
-            argc--;
-            argv++;
-            req = 1;
             break;
-        } else if (strcmp(*argv, &quot;-ss_cert&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            ss_cert_file = *(++argv);
+        case OPT_CRLDAYS:
+            crldays = atol(opt_arg());
+            break;
+        case OPT_CRLHOURS:
+            crlhours = atol(opt_arg());
+            break;
+        case OPT_CRLSEC:
+            crlsec = atol(opt_arg());
+            break;
+        case OPT_INFILES:
             req = 1;
-        } else if (strcmp(*argv, &quot;-spkac&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            spkac_file = *(++argv);
+            goto end_of_options;
+        case OPT_SS_CERT:
+            ss_cert_file = opt_arg();
             req = 1;
-        } else if (strcmp(*argv, &quot;-revoke&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            infile = *(++argv);
+            break;
+        case OPT_SPKAC:
+            spkac_file = opt_arg();
+            req = 1;
+            break;
+        case OPT_REVOKE:
+            infile = opt_arg();
             dorevoke = 1;
-        } else if (strcmp(*argv, &quot;-valid&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            infile = *(++argv);
+            break;
+        case OPT_VALID:
+            infile = opt_arg();
             dorevoke = 2;
-        } else if (strcmp(*argv, &quot;-extensions&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            extensions = *(++argv);
-        } else if (strcmp(*argv, &quot;-extfile&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            extfile = *(++argv);
-        } else if (strcmp(*argv, &quot;-status&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            ser_status = *(++argv);
-        } else if (strcmp(*argv, &quot;-updatedb&quot;) == 0) {
+            break;
+        case OPT_EXTENSIONS:
+            extensions = opt_arg();
+            break;
+        case OPT_EXTFILE:
+            extfile = opt_arg();
+            break;
+        case OPT_STATUS:
+            ser_status = opt_arg();
+            break;
+        case OPT_UPDATEDB:
             doupdatedb = 1;
-        } else if (strcmp(*argv, &quot;-crlexts&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            crl_ext = *(++argv);
-        } else if (strcmp(*argv, &quot;-crl_reason&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            rev_arg = *(++argv);
+            break;
+        case OPT_CRLEXTS:
+            crl_ext = opt_arg();
+            break;
+        case OPT_CRL_REASON:
+            rev_arg = opt_arg();
             rev_type = REV_CRL_REASON;
-        } else if (strcmp(*argv, &quot;-crl_hold&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            rev_arg = *(++argv);
+            break;
+        case OPT_CRL_HOLD:
+            rev_arg = opt_arg();
             rev_type = REV_HOLD;
-        } else if (strcmp(*argv, &quot;-crl_compromise&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            rev_arg = *(++argv);
+            break;
+        case OPT_CRL_COMPROMISE:
+            rev_arg = opt_arg();
             rev_type = REV_KEY_COMPROMISE;
-        } else if (strcmp(*argv, &quot;-crl_CA_compromise&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            rev_arg = *(++argv);
+            break;
+        case OPT_CRL_CA_COMPROMISE:
+            rev_arg = opt_arg();
             rev_type = REV_CA_COMPROMISE;
-        }
-#ifndef OPENSSL_NO_ENGINE
-        else if (strcmp(*argv, &quot;-engine&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            engine = *(++argv);
-        }
-#endif
-        else {
- bad:
-            BIO_printf(bio_err, &quot;unknown option %s\n&quot;, *argv);
-            badops = 1;
+            break;
+        case OPT_ENGINE:
+            engine = opt_arg();
             break;
         }
-        argc--;
-        argv++;
     }
+end_of_options:
+    argc = opt_num_rest();
+    argv = opt_rest();
 
-    if (badops) {
-        const char **pp2;
-
-        for (pp2 = ca_usage; (*pp2 != NULL); pp2++)
-            BIO_printf(bio_err, &quot;%s&quot;, *pp2);
-        goto err;
-    }
-
-    ERR_load_crypto_strings();
-
-        /*****************************************************************/
     tofree = NULL;
     if (configfile == NULL)
         configfile = getenv(&quot;OPENSSL_CONF&quot;);
@@ -565,7 +510,7 @@ int MAIN(int argc, char **argv)
         tofree = OPENSSL_malloc(len);
         if (!tofree) {
             BIO_printf(bio_err, &quot;Out of memory\n&quot;);
-            goto err;
+            goto end;
         }
         strcpy(tofree, s);
 #else
@@ -573,7 +518,7 @@ int MAIN(int argc, char **argv)
         tofree = OPENSSL_malloc(len);
         if (!tofree) {
             BIO_printf(bio_err, &quot;Out of memory\n&quot;);
-            goto err;
+            goto end;
         }
         BUF_strlcpy(tofree, s, len);
         BUF_strlcat(tofree, &quot;/&quot;, len);
@@ -591,18 +536,14 @@ int MAIN(int argc, char **argv)
         else
             BIO_printf(bio_err, &quot;error on line %ld of config file '%s'\n&quot;,
                        errorline, configfile);
-        goto err;
+        goto end;
     }
     if (tofree) {
         OPENSSL_free(tofree);
         tofree = NULL;
     }
-
-    if (!load_config(bio_err, conf))
-        goto err;
-
 #ifndef OPENSSL_NO_ENGINE
-    e = setup_engine(bio_err, engine, 0);
+    e = setup_engine(engine, 0);
 #endif
 
     /* Lets get the config section we are using */
@@ -610,7 +551,7 @@ int MAIN(int argc, char **argv)
         section = NCONF_get_string(conf, BASE_SECTION, ENV_DEFAULT_CA);
         if (section == NULL) {
             lookup_fail(BASE_SECTION, ENV_DEFAULT_CA);
-            goto err;
+            goto end;
         }
     }
 
@@ -633,16 +574,16 @@ int MAIN(int argc, char **argv)
                 BIO_free(oid_bio);
             }
         }
-        if (!add_oid_section(bio_err, conf)) {
+        if (!add_oid_section(conf)) {
             ERR_print_errors(bio_err);
-            goto err;
+            goto end;
         }
     }
 
     randfile = NCONF_get_string(conf, BASE_SECTION, &quot;RANDFILE&quot;);
     if (randfile == NULL)
         ERR_clear_error();
-    app_RAND_load_file(randfile, bio_err, 0);
+    app_RAND_load_file(randfile, 0);
 
     f = NCONF_get_string(conf, section, STRING_MASK);
     if (!f)
@@ -650,7 +591,7 @@ int MAIN(int argc, char **argv)
 
     if (f &amp;&amp; !ASN1_STRING_set_default_mask_asc(f)) {
         BIO_printf(bio_err, &quot;Invalid global string mask setting %s\n&quot;, f);
-        goto err;
+        goto end;
     }
 
     if (chtype != MBSTRING_UTF8) {
@@ -664,47 +605,27 @@ int MAIN(int argc, char **argv)
     db_attr.unique_subject = 1;
     p = NCONF_get_string(conf, section, ENV_UNIQUE_SUBJECT);
     if (p) {
-#ifdef RL_DEBUG
-        BIO_printf(bio_err, &quot;DEBUG: unique_subject = \&quot;%s\&quot;\n&quot;, p);
-#endif
         db_attr.unique_subject = parse_yesno(p, 1);
     } else
         ERR_clear_error();
-#ifdef RL_DEBUG
-    if (!p)
-        BIO_printf(bio_err, &quot;DEBUG: unique_subject undefined\n&quot;);
-#endif
-#ifdef RL_DEBUG
-    BIO_printf(bio_err, &quot;DEBUG: configured unique_subject is %d\n&quot;,
-               db_attr.unique_subject);
-#endif
-
-    in = BIO_new(BIO_s_file());
-    out = BIO_new(BIO_s_file());
-    Sout = BIO_new(BIO_s_file());
-    Cout = BIO_new(BIO_s_file());
-    if ((in == NULL) || (out == NULL) || (Sout == NULL) || (Cout == NULL)) {
-        ERR_print_errors(bio_err);
-        goto err;
-    }
 
         /*****************************************************************/
     /* report status of cert with serial number given on command line */
     if (ser_status) {
         if ((dbfile = NCONF_get_string(conf, section, ENV_DATABASE)) == NULL) {
             lookup_fail(section, ENV_DATABASE);
-            goto err;
+            goto end;
         }
         db = load_index(dbfile, &amp;db_attr);
         if (db == NULL)
-            goto err;
+            goto end;
 
         if (!index_index(db))
-            goto err;
+            goto end;
 
         if (get_certificate_status(ser_status, db) != 1)
             BIO_printf(bio_err, &quot;Error verifying serial %s!\n&quot;, ser_status);
-        goto err;
+        goto end;
     }
 
         /*****************************************************************/
@@ -715,21 +636,21 @@ int MAIN(int argc, char **argv)
                                                           ENV_PRIVATE_KEY)) ==
                               NULL)) {
         lookup_fail(section, ENV_PRIVATE_KEY);
-        goto err;
+        goto end;
     }
     if (!key) {
         free_key = 1;
-        if (!app_passwd(bio_err, passargin, NULL, &amp;key, NULL)) {
+        if (!app_passwd(passinarg, NULL, &amp;key, NULL)) {
             BIO_printf(bio_err, &quot;Error getting password\n&quot;);
-            goto err;
+            goto end;
         }
     }
-    pkey = load_key(bio_err, keyfile, keyform, 0, key, e, &quot;CA private key&quot;);
+    pkey = load_key(keyfile, keyformat, 0, key, e, &quot;CA private key&quot;);
     if (key)
         OPENSSL_cleanse(key, strlen(key));
     if (pkey == NULL) {
         /* load_key() has already printed an appropriate message */
-        goto err;
+        goto end;
     }
 
         /*****************************************************************/
@@ -740,17 +661,16 @@ int MAIN(int argc, char **argv)
                                              section,
                                              ENV_CERTIFICATE)) == NULL)) {
             lookup_fail(section, ENV_CERTIFICATE);
-            goto err;
+            goto end;
         }
-        x509 = load_cert(bio_err, certfile, FORMAT_PEM, NULL, e,
-                         &quot;CA certificate&quot;);
+        x509 = load_cert(certfile, FORMAT_PEM, NULL, e, &quot;CA certificate&quot;);
         if (x509 == NULL)
-            goto err;
+            goto end;
 
         if (!X509_check_private_key(x509, pkey)) {
             BIO_printf(bio_err,
                        &quot;CA certificate and CA private key do not match\n&quot;);
-            goto err;
+            goto end;
         }
     }
     if (!selfsign)
@@ -772,7 +692,7 @@ int MAIN(int argc, char **argv)
     if (f) {
         if (!set_name_ex(&amp;nameopt, f)) {
             BIO_printf(bio_err, &quot;Invalid name options: \&quot;%s\&quot;\n&quot;, f);
-            goto err;
+            goto end;
         }
         default_op = 0;
     } else
@@ -783,7 +703,7 @@ int MAIN(int argc, char **argv)
     if (f) {
         if (!set_cert_ex(&amp;certopt, f)) {
             BIO_printf(bio_err, &quot;Invalid certificate options: \&quot;%s\&quot;\n&quot;, f);
-            goto err;
+            goto end;
         }
         default_op = 0;
     } else
@@ -794,7 +714,7 @@ int MAIN(int argc, char **argv)
     if (f) {
         if (!set_ext_copy(&amp;ext_copy, f)) {
             BIO_printf(bio_err, &quot;Invalid extension copy option: \&quot;%s\&quot;\n&quot;, f);
-            goto err;
+            goto end;
         }
     } else
         ERR_clear_error();
@@ -807,7 +727,7 @@ int MAIN(int argc, char **argv)
             == NULL) {
             BIO_printf(bio_err,
                        &quot;there needs to be defined a directory for new certificate to be placed in\n&quot;);
-            goto err;
+            goto end;
         }
 #ifndef OPENSSL_SYS_VMS
         /*
@@ -820,22 +740,18 @@ int MAIN(int argc, char **argv)
          * routines to convert the directory syntax to Unixly, and give that
          * to access().  However, time's too short to do that just now.
          */
-# ifndef _WIN32
-        if (access(outdir, R_OK | W_OK | X_OK) != 0)
-# else
-        if (_access(outdir, R_OK | W_OK | X_OK) != 0)
-# endif
+        if (app_access(outdir, R_OK | W_OK | X_OK) != 0)
         {
             BIO_printf(bio_err, &quot;I am unable to access the %s directory\n&quot;,
                        outdir);
             perror(outdir);
-            goto err;
+            goto end;
         }
 
         if (app_isdir(outdir) &lt;= 0) {
             BIO_printf(bio_err, &quot;%s need to be a directory\n&quot;, outdir);
             perror(outdir);
-            goto err;
+            goto end;
         }
 #endif
     }
@@ -844,11 +760,11 @@ int MAIN(int argc, char **argv)
     /* we need to load the database file */
     if ((dbfile = NCONF_get_string(conf, section, ENV_DATABASE)) == NULL) {
         lookup_fail(section, ENV_DATABASE);
-        goto err;
+        goto end;
     }
     db = load_index(dbfile, &amp;db_attr);
     if (db == NULL)
-        goto err;
+        goto end;
 
     /* Lets check some fields */
     for (i = 0; i &lt; sk_OPENSSL_PSTRING_num(db-&gt;db-&gt;data); i++) {
@@ -857,16 +773,16 @@ int MAIN(int argc, char **argv)
             BIO_printf(bio_err,
                        &quot;entry %d: not revoked yet, but has a revocation date\n&quot;,
                        i + 1);
-            goto err;
+            goto end;
         }
         if ((pp[DB_type][0] == DB_TYPE_REV) &amp;&amp;
             !make_revoked(NULL, pp[DB_rev_date])) {
             BIO_printf(bio_err, &quot; in entry %d\n&quot;, i + 1);
-            goto err;
+            goto end;
         }
         if (!check_time_format((char *)pp[DB_exp_date])) {
             BIO_printf(bio_err, &quot;entry %d: invalid expiry date\n&quot;, i + 1);
-            goto err;
+            goto end;
         }
         p = pp[DB_serial];
         j = strlen(p);
@@ -877,7 +793,7 @@ int MAIN(int argc, char **argv)
         if ((j &amp; 1) || (j &lt; 2)) {
             BIO_printf(bio_err, &quot;entry %d: bad serial number length (%d)\n&quot;,
                        i + 1, j);
-            goto err;
+            goto end;
         }
         while (*p) {
             if (!(((*p &gt;= '0') &amp;&amp; (*p &lt;= '9')) ||
@@ -886,27 +802,20 @@ int MAIN(int argc, char **argv)
                 BIO_printf(bio_err,
                            &quot;entry %d: bad serial number characters, char pos %ld, char is '%c'\n&quot;,
                            i + 1, (long)(p - pp[DB_serial]), *p);
-                goto err;
+                goto end;
             }
             p++;
         }
     }
     if (verbose) {
-        BIO_set_fp(out, stdout, BIO_NOCLOSE | BIO_FP_TEXT); /* cannot fail */
-#ifdef OPENSSL_SYS_VMS
-        {
-            BIO *tmpbio = BIO_new(BIO_f_linebuffer());
-            out = BIO_push(tmpbio, out);
-        }
-#endif
-        TXT_DB_write(out, db-&gt;db);
+        TXT_DB_write(bio_out, db-&gt;db);
         BIO_printf(bio_err, &quot;%d entries loaded from the database\n&quot;,
                    sk_OPENSSL_PSTRING_num(db-&gt;db-&gt;data));
         BIO_printf(bio_err, &quot;generating index\n&quot;);
     }
 
     if (!index_index(db))
-        goto err;
+        goto end;
 
         /*****************************************************************/
     /* Update the db file for expired certificates */
@@ -917,16 +826,16 @@ int MAIN(int argc, char **argv)
         i = do_updatedb(db);
         if (i == -1) {
             BIO_printf(bio_err, &quot;Malloc failure\n&quot;);
-            goto err;
+            goto end;
         } else if (i == 0) {
             if (verbose)
                 BIO_printf(bio_err, &quot;No entries found to mark expired\n&quot;);
         } else {
             if (!save_index(dbfile, &quot;new&quot;, db))
-                goto err;
+                goto end;
 
             if (!rotate_index(dbfile, &quot;new&quot;, &quot;old&quot;))
-                goto err;
+                goto end;
 
             if (verbose)
                 BIO_printf(bio_err,
@@ -947,7 +856,7 @@ int MAIN(int argc, char **argv)
                            &quot;ERROR: on line %ld of config file '%s'\n&quot;,
                            errorline, extfile);
             ret = 1;
-            goto err;
+            goto end;
         }
 
         if (verbose)
@@ -963,41 +872,29 @@ int MAIN(int argc, char **argv)
 
         /*****************************************************************/
     if (req || gencrl) {
-        if (outfile != NULL) {
-            if (BIO_write_filename(Sout, outfile) &lt;= 0) {
-                perror(outfile);
-                goto err;
-            }
-        } else {
-            BIO_set_fp(Sout, stdout, BIO_NOCLOSE | BIO_FP_TEXT);
-#ifdef OPENSSL_SYS_VMS
-            {
-                BIO *tmpbio = BIO_new(BIO_f_linebuffer());
-                Sout = BIO_push(tmpbio, Sout);
-            }
-#endif
-        }
+        Sout = bio_open_default(outfile, &quot;w&quot;);
+        if (Sout == NULL)
+            goto end;
     }
 
     if ((md == NULL) &amp;&amp; ((md = NCONF_get_string(conf,
                                                 section,
                                                 ENV_DEFAULT_MD)) == NULL)) {
         lookup_fail(section, ENV_DEFAULT_MD);
-        goto err;
+        goto end;
     }
 
     if (!strcmp(md, &quot;default&quot;)) {
         int def_nid;
         if (EVP_PKEY_get_default_digest_nid(pkey, &amp;def_nid) &lt;= 0) {
             BIO_puts(bio_err, &quot;no default digest\n&quot;);
-            goto err;
+            goto end;
         }
         md = (char *)OBJ_nid2sn(def_nid);
     }
 
-    if ((dgst = EVP_get_digestbyname(md)) == NULL) {
-        BIO_printf(bio_err, &quot;%s is an unsupported message digest type\n&quot;, md);
-        goto err;
+    if (!opt_md(md, &amp;dgst)) {
+        goto end;
     }
 
     if (req) {
@@ -1016,7 +913,7 @@ int MAIN(int argc, char **argv)
                                                             ENV_POLICY)) ==
                                  NULL)) {
             lookup_fail(section, ENV_POLICY);
-            goto err;
+            goto end;
         }
         if (verbose)
             BIO_printf(bio_err, &quot;policy is %s\n&quot;, policy);
@@ -1024,7 +921,7 @@ int MAIN(int argc, char **argv)
         if ((serialfile = NCONF_get_string(conf, section, ENV_SERIAL))
             == NULL) {
             lookup_fail(section, ENV_SERIAL);
-            goto err;
+            goto end;
         }
 
         if (!extconf) {
@@ -1047,7 +944,7 @@ int MAIN(int argc, char **argv)
                                &quot;Error Loading extension section %s\n&quot;,
                                extensions);
                     ret = 1;
-                    goto err;
+                    goto end;
                 }
             }
         }
@@ -1061,7 +958,7 @@ int MAIN(int argc, char **argv)
         if (startdate &amp;&amp; !ASN1_TIME_set_string(NULL, startdate)) {
             BIO_printf(bio_err,
                        &quot;start date is invalid, it should be YYMMDDHHMMSSZ or YYYYMMDDHHMMSSZ\n&quot;);
-            goto err;
+            goto end;
         }
         if (startdate == NULL)
             startdate = &quot;today&quot;;
@@ -1074,7 +971,7 @@ int MAIN(int argc, char **argv)
         if (enddate &amp;&amp; !ASN1_TIME_set_string(NULL, enddate)) {
             BIO_printf(bio_err,
                        &quot;end date is invalid, it should be YYMMDDHHMMSSZ or YYYYMMDDHHMMSSZ\n&quot;);
-            goto err;
+            goto end;
         }
 
         if (days == 0) {
@@ -1084,19 +981,19 @@ int MAIN(int argc, char **argv)
         if (!enddate &amp;&amp; (days == 0)) {
             BIO_printf(bio_err,
                        &quot;cannot lookup how many days to certify for\n&quot;);
-            goto err;
+            goto end;
         }
 
         if ((serial = load_serial(serialfile, create_ser, NULL)) == NULL) {
             BIO_printf(bio_err, &quot;error while loading serial number\n&quot;);
-            goto err;
+            goto end;
         }
         if (verbose) {
             if (BN_is_zero(serial))
                 BIO_printf(bio_err, &quot;next serial number is 00\n&quot;);
             else {
                 if ((f = BN_bn2hex(serial)) == NULL)
-                    goto err;
+                    goto end;
                 BIO_printf(bio_err, &quot;next serial number is %s\n&quot;, f);
                 OPENSSL_free(f);
             }
@@ -1104,12 +1001,12 @@ int MAIN(int argc, char **argv)
 
         if ((attribs = NCONF_get_section(conf, policy)) == NULL) {
             BIO_printf(bio_err, &quot;unable to find 'section' for %s\n&quot;, policy);
-            goto err;
+            goto end;
         }
 
         if ((cert_sk = sk_X509_new_null()) == NULL) {
             BIO_printf(bio_err, &quot;Memory allocation failure\n&quot;);
-            goto err;
+            goto end;
         }
         if (spkac_file != NULL) {
             total++;
@@ -1119,15 +1016,15 @@ int MAIN(int argc, char **argv)
                               conf, verbose, certopt, nameopt, default_op,
                               ext_copy);
             if (j &lt; 0)
-                goto err;
+                goto end;
             if (j &gt; 0) {
                 total_done++;
                 BIO_printf(bio_err, &quot;\n&quot;);
                 if (!BN_add_word(serial, 1))
-                    goto err;
+                    goto end;
                 if (!sk_X509_push(cert_sk, x)) {
                     BIO_printf(bio_err, &quot;Memory allocation failure\n&quot;);
-                    goto err;
+                    goto end;
                 }
                 if (outfile) {
                     output_der = 1;
@@ -1144,15 +1041,15 @@ int MAIN(int argc, char **argv)
                              conf, verbose, certopt, nameopt, default_op,
                              ext_copy, e);
             if (j &lt; 0)
-                goto err;
+                goto end;
             if (j &gt; 0) {
                 total_done++;
                 BIO_printf(bio_err, &quot;\n&quot;);
                 if (!BN_add_word(serial, 1))
-                    goto err;
+                    goto end;
                 if (!sk_X509_push(cert_sk, x)) {
                     BIO_printf(bio_err, &quot;Memory allocation failure\n&quot;);
-                    goto err;
+                    goto end;
                 }
             }
         }
@@ -1163,15 +1060,15 @@ int MAIN(int argc, char **argv)
                         enddate, days, batch, extensions, conf, verbose,
                         certopt, nameopt, default_op, ext_copy, selfsign);
             if (j &lt; 0)
-                goto err;
+                goto end;
             if (j &gt; 0) {
                 total_done++;
                 BIO_printf(bio_err, &quot;\n&quot;);
                 if (!BN_add_word(serial, 1))
-                    goto err;
+                    goto end;
                 if (!sk_X509_push(cert_sk, x)) {
                     BIO_printf(bio_err, &quot;Memory allocation failure\n&quot;);
-                    goto err;
+                    goto end;
                 }
             }
         }
@@ -1182,15 +1079,15 @@ int MAIN(int argc, char **argv)
                         enddate, days, batch, extensions, conf, verbose,
                         certopt, nameopt, default_op, ext_copy, selfsign);
             if (j &lt; 0)
-                goto err;
+                goto end;
             if (j &gt; 0) {
                 total_done++;
                 BIO_printf(bio_err, &quot;\n&quot;);
                 if (!BN_add_word(serial, 1))
-                    goto err;
+                    goto end;
                 if (!sk_X509_push(cert_sk, x)) {
                     BIO_printf(bio_err, &quot;Memory allocation failure\n&quot;);
-                    goto err;
+                    goto end;
                 }
             }
         }
@@ -1210,12 +1107,12 @@ int MAIN(int argc, char **argv)
                     BIO_printf(bio_err,
                                &quot;CERTIFICATION CANCELED: I/O error\n&quot;);
                     ret = 0;
-                    goto err;
+                    goto end;
                 }
                 if ((buf[0][0] != 'y') &amp;&amp; (buf[0][0] != 'Y')) {
                     BIO_printf(bio_err, &quot;CERTIFICATION CANCELED\n&quot;);
                     ret = 0;
-                    goto err;
+                    goto end;
                 }
             }
 
@@ -1223,10 +1120,10 @@ int MAIN(int argc, char **argv)
                        sk_X509_num(cert_sk));
 
             if (!save_serial(serialfile, &quot;new&quot;, serial, NULL))
-                goto err;
+                goto end;
 
             if (!save_index(dbfile, &quot;new&quot;, db))
-                goto err;
+                goto end;
         }
 
         if (verbose)
@@ -1242,7 +1139,7 @@ int MAIN(int argc, char **argv)
 
             if (strlen(outdir) &gt;= (size_t)(j ? BSIZE - j * 2 - 6 : BSIZE - 8)) {
                 BIO_printf(bio_err, &quot;certificate file name too long\n&quot;);
-                goto err;
+                goto end;
             }
 
             strcpy(buf[2], outdir);
@@ -1273,9 +1170,10 @@ int MAIN(int argc, char **argv)
             if (verbose)
                 BIO_printf(bio_err, &quot;writing %s\n&quot;, buf[2]);
 
-            if (BIO_write_filename(Cout, buf[2]) &lt;= 0) {
+            Cout = BIO_new_file(buf[2], &quot;w&quot;);
+            if (Cout == NULL) {
                 perror(buf[2]);
-                goto err;
+                goto end;
             }
             write_new_certificate(Cout, x, 0, notext);
             write_new_certificate(Sout, x, output_der, notext);
@@ -1284,10 +1182,10 @@ int MAIN(int argc, char **argv)
         if (sk_X509_num(cert_sk)) {
             /* Rename the database and the serial file */
             if (!rotate_serial(serialfile, &quot;new&quot;, &quot;old&quot;))
-                goto err;
+                goto end;
 
             if (!rotate_index(dbfile, &quot;new&quot;, &quot;old&quot;))
-                goto err;
+                goto end;
 
             BIO_printf(bio_err, &quot;Data Base Updated\n&quot;);
         }
@@ -1311,7 +1209,7 @@ int MAIN(int argc, char **argv)
                            &quot;Error Loading CRL extension section %s\n&quot;,
                            crl_ext);
                 ret = 1;
-                goto err;
+                goto end;
             }
         }
 
@@ -1319,7 +1217,7 @@ int MAIN(int argc, char **argv)
             != NULL)
             if ((crlnumber = load_serial(crlnumberfile, 0, NULL)) == NULL) {
                 BIO_printf(bio_err, &quot;error while loading CRL number\n&quot;);
-                goto err;
+                goto end;
             }
 
         if (!crldays &amp;&amp; !crlhours &amp;&amp; !crlsec) {
@@ -1334,25 +1232,25 @@ int MAIN(int argc, char **argv)
         if ((crldays == 0) &amp;&amp; (crlhours == 0) &amp;&amp; (crlsec == 0)) {
             BIO_printf(bio_err,
                        &quot;cannot lookup how long until the next CRL is issued\n&quot;);
-            goto err;
+            goto end;
         }
 
         if (verbose)
             BIO_printf(bio_err, &quot;making CRL\n&quot;);
         if ((crl = X509_CRL_new()) == NULL)
-            goto err;
+            goto end;
         if (!X509_CRL_set_issuer_name(crl, X509_get_subject_name(x509)))
-            goto err;
+            goto end;
 
         tmptm = ASN1_TIME_new();
         if (!tmptm)
-            goto err;
+            goto end;
         X509_gmtime_adj(tmptm, 0);
         X509_CRL_set_lastUpdate(crl, tmptm);
         if (!X509_time_adj_ex(tmptm, crldays, crlhours * 60 * 60 + crlsec,
                               NULL)) {
             BIO_puts(bio_err, &quot;error setting CRL nextUpdate\n&quot;);
-            goto err;
+            goto end;
         }
         X509_CRL_set_nextUpdate(crl, tmptm);
 
@@ -1362,19 +1260,19 @@ int MAIN(int argc, char **argv)
             pp = sk_OPENSSL_PSTRING_value(db-&gt;db-&gt;data, i);
             if (pp[DB_type][0] == DB_TYPE_REV) {
                 if ((r = X509_REVOKED_new()) == NULL)
-                    goto err;
+                    goto end;
                 j = make_revoked(r, pp[DB_rev_date]);
                 if (!j)
-                    goto err;
+                    goto end;
                 if (j == 2)
                     crl_v2 = 1;
                 if (!BN_hex2bn(&amp;serial, pp[DB_serial]))
-                    goto err;
+                    goto end;
                 tmpser = BN_to_ASN1_INTEGER(serial, NULL);
                 BN_free(serial);
                 serial = NULL;
                 if (!tmpser)
-                    goto err;
+                    goto end;
                 X509_REVOKED_set_serialNumber(r, tmpser);
                 ASN1_INTEGER_free(tmpser);
                 X509_CRL_add0_revoked(crl, r);
@@ -1399,72 +1297,72 @@ int MAIN(int argc, char **argv)
 
             if (crl_ext)
                 if (!X509V3_EXT_CRL_add_nconf(conf, &amp;crlctx, crl_ext, crl))
-                    goto err;
+                    goto end;
             if (crlnumberfile != NULL) {
                 tmpser = BN_to_ASN1_INTEGER(crlnumber, NULL);
                 if (!tmpser)
-                    goto err;
+                    goto end;
                 X509_CRL_add1_ext_i2d(crl, NID_crl_number, tmpser, 0, 0);
                 ASN1_INTEGER_free(tmpser);
                 crl_v2 = 1;
                 if (!BN_add_word(crlnumber, 1))
-                    goto err;
+                    goto end;
             }
         }
         if (crl_ext || crl_v2) {
             if (!X509_CRL_set_version(crl, 1))
-                goto err;       /* version 2 CRL */
+                goto end;       /* version 2 CRL */
         }
 
         /* we have a CRL number that need updating */
         if (crlnumberfile != NULL)
             if (!save_serial(crlnumberfile, &quot;new&quot;, crlnumber, NULL))
-                goto err;
+                goto end;
 
         if (crlnumber) {
             BN_free(crlnumber);
             crlnumber = NULL;
         }
 
-        if (!do_X509_CRL_sign(bio_err, crl, pkey, dgst, sigopts))
-            goto err;
+        if (!do_X509_CRL_sign(crl, pkey, dgst, sigopts))
+            goto end;
 
         PEM_write_bio_X509_CRL(Sout, crl);
 
         if (crlnumberfile != NULL) /* Rename the crlnumber file */
             if (!rotate_serial(crlnumberfile, &quot;new&quot;, &quot;old&quot;))
-                goto err;
+                goto end;
 
     }
         /*****************************************************************/
     if (dorevoke) {
         if (infile == NULL) {
             BIO_printf(bio_err, &quot;no input files\n&quot;);
-            goto err;
+            goto end;
         } else {
             X509 *revcert;
-            revcert = load_cert(bio_err, infile, FORMAT_PEM, NULL, e, infile);
+            revcert = load_cert(infile, FORMAT_PEM, NULL, e, infile);
             if (revcert == NULL)
-                goto err;
+                goto end;
             if (dorevoke == 2)
                 rev_type = -1;
             j = do_revoke(revcert, db, rev_type, rev_arg);
             if (j &lt;= 0)
-                goto err;
+                goto end;
             X509_free(revcert);
 
             if (!save_index(dbfile, &quot;new&quot;, db))
-                goto err;
+                goto end;
 
             if (!rotate_index(dbfile, &quot;new&quot;, &quot;old&quot;))
-                goto err;
+                goto end;
 
             BIO_printf(bio_err, &quot;Data Base Updated\n&quot;);
         }
     }
         /*****************************************************************/
     ret = 0;
- err:
+ end:
     if (tofree)
         OPENSSL_free(tofree);
     BIO_free_all(Cout);
@@ -1477,7 +1375,7 @@ int MAIN(int argc, char **argv)
 
     if (ret)
         ERR_print_errors(bio_err);
-    app_RAND_write_file(randfile, bio_err);
+    app_RAND_write_file(randfile);
     if (free_key &amp;&amp; key)
         OPENSSL_free(key);
     BN_free(serial);
@@ -1492,8 +1390,7 @@ int MAIN(int argc, char **argv)
     NCONF_free(conf);
     NCONF_free(extconf);
     OBJ_cleanup();
-    apps_shutdown();
-    OPENSSL_EXIT(ret);
+    return (ret);
 }
 
 static void lookup_fail(const char *name, const char *tag)
@@ -1515,16 +1412,15 @@ static int certify(X509 **xret, char *infile, EVP_PKEY *pkey, X509 *x509,
     EVP_PKEY *pktmp = NULL;
     int ok = -1, i;
 
-    in = BIO_new(BIO_s_file());
-
-    if (BIO_read_filename(in, infile) &lt;= 0) {
-        perror(infile);
-        goto err;
+    in = BIO_new_file(infile, &quot;r&quot;);
+    if (in == NULL) {
+        ERR_print_errors(bio_err);
+        goto end;
     }
     if ((req = PEM_read_bio_X509_REQ(in, NULL, NULL, NULL)) == NULL) {
         BIO_printf(bio_err, &quot;Error reading certificate request in %s\n&quot;,
                    infile);
-        goto err;
+        goto end;
     }
     if (verbose)
         X509_REQ_print(bio_err, req);
@@ -1535,11 +1431,11 @@ static int certify(X509 **xret, char *infile, EVP_PKEY *pkey, X509 *x509,
         BIO_printf(bio_err,
                    &quot;Certificate request and CA private key do not match\n&quot;);
         ok = 0;
-        goto err;
+        goto end;
     }
     if ((pktmp = X509_REQ_get_pubkey(req)) == NULL) {
         BIO_printf(bio_err, &quot;error unpacking public key\n&quot;);
-        goto err;
+        goto end;
     }
     i = X509_REQ_verify(req, pktmp);
     EVP_PKEY_free(pktmp);
@@ -1547,14 +1443,14 @@ static int certify(X509 **xret, char *infile, EVP_PKEY *pkey, X509 *x509,
         ok = 0;
         BIO_printf(bio_err, &quot;Signature verification problems....\n&quot;);
         ERR_print_errors(bio_err);
-        goto err;
+        goto end;
     }
     if (i == 0) {
         ok = 0;
         BIO_printf(bio_err,
                    &quot;Signature did not match the certificate request\n&quot;);
         ERR_print_errors(bio_err);
-        goto err;
+        goto end;
     } else
         BIO_printf(bio_err, &quot;Signature ok\n&quot;);
 
@@ -1563,7 +1459,7 @@ static int certify(X509 **xret, char *infile, EVP_PKEY *pkey, X509 *x509,
                  verbose, req, ext_sect, lconf, certopt, nameopt, default_op,
                  ext_copy, selfsign);
 
- err:
+ end:
     if (req != NULL)
         X509_REQ_free(req);
     BIO_free(in);
@@ -1585,9 +1481,8 @@ static int certify_cert(X509 **xret, char *infile, EVP_PKEY *pkey, X509 *x509,
     EVP_PKEY *pktmp = NULL;
     int ok = -1, i;
 
-    if ((req =
-         load_cert(bio_err, infile, FORMAT_PEM, NULL, e, infile)) == NULL)
-        goto err;
+    if ((req = load_cert(infile, FORMAT_PEM, NULL, e, infile)) == NULL)
+        goto end;
     if (verbose)
         X509_print(bio_err, req);
 
@@ -1595,31 +1490,31 @@ static int certify_cert(X509 **xret, char *infile, EVP_PKEY *pkey, X509 *x509,
 
     if ((pktmp = X509_get_pubkey(req)) == NULL) {
         BIO_printf(bio_err, &quot;error unpacking public key\n&quot;);
-        goto err;
+        goto end;
     }
     i = X509_verify(req, pktmp);
     EVP_PKEY_free(pktmp);
     if (i &lt; 0) {
         ok = 0;
         BIO_printf(bio_err, &quot;Signature verification problems....\n&quot;);
-        goto err;
+        goto end;
     }
     if (i == 0) {
         ok = 0;
         BIO_printf(bio_err, &quot;Signature did not match the certificate\n&quot;);
-        goto err;
+        goto end;
     } else
         BIO_printf(bio_err, &quot;Signature ok\n&quot;);
 
     if ((rreq = X509_to_X509_REQ(req, NULL, EVP_md5())) == NULL)
-        goto err;
+        goto end;
 
     ok = do_body(xret, pkey, x509, dgst, sigopts, policy, db, serial, subj,
                  chtype, multirdn, email_dn, startdate, enddate, days, batch,
                  verbose, rreq, ext_sect, lconf, certopt, nameopt, default_op,
                  ext_copy, 0);
 
- err:
+ end:
     if (rreq != NULL)
         X509_REQ_free(rreq);
     if (req != NULL)
@@ -1668,7 +1563,7 @@ static int do_body(X509 **xret, EVP_PKEY *pkey, X509 *x509,
 
         if (!n) {
             ERR_print_errors(bio_err);
-            goto err;
+            goto end;
         }
         X509_REQ_set_subject_name(req, n);
         req-&gt;req_info-&gt;enc.modified = 1;
@@ -1710,7 +1605,7 @@ static int do_body(X509 **xret, EVP_PKEY *pkey, X509 *x509,
             (str-&gt;type != V_ASN1_IA5STRING)) {
             BIO_printf(bio_err,
                        &quot;\nemailAddress type needs to be of type IA5STRING\n&quot;);
-            goto err;
+            goto end;
         }
         if ((str-&gt;type != V_ASN1_BMPSTRING)
             &amp;&amp; (str-&gt;type != V_ASN1_UTF8STRING)) {
@@ -1721,7 +1616,7 @@ static int do_body(X509 **xret, EVP_PKEY *pkey, X509 *x509,
                  (str-&gt;type == V_ASN1_PRINTABLESTRING))) {
                 BIO_printf(bio_err,
                            &quot;\nThe string contains characters that are illegal for the ASN.1 type\n&quot;);
-                goto err;
+                goto end;
             }
         }
 
@@ -1732,7 +1627,7 @@ static int do_body(X509 **xret, EVP_PKEY *pkey, X509 *x509,
     /* Ok, now we check the 'policy' stuff. */
     if ((subject = X509_NAME_new()) == NULL) {
         BIO_printf(bio_err, &quot;Memory allocation failure\n&quot;);
-        goto err;
+        goto end;
     }
 
     /* take a copy of the issuer name before we mess with it. */
@@ -1741,7 +1636,7 @@ static int do_body(X509 **xret, EVP_PKEY *pkey, X509 *x509,
     else
         CAname = X509_NAME_dup(x509-&gt;cert_info-&gt;subject);
     if (CAname == NULL)
-        goto err;
+        goto end;
     str = str2 = NULL;
 
     for (i = 0; i &lt; sk_CONF_VALUE_num(policy); i++) {
@@ -1750,7 +1645,7 @@ static int do_body(X509 **xret, EVP_PKEY *pkey, X509 *x509,
             BIO_printf(bio_err,
                        &quot;%s:unknown object type in 'policy' configuration\n&quot;,
                        cv-&gt;name);
-            goto err;
+            goto end;
         }
         obj = OBJ_nid2obj(j);
 
@@ -1777,7 +1672,7 @@ static int do_body(X509 **xret, EVP_PKEY *pkey, X509 *x509,
                     BIO_printf(bio_err,
                                &quot;The %s field needed to be supplied and was missing\n&quot;,
                                cv-&gt;name);
-                    goto err;
+                    goto end;
                 } else
                     push = tne;
             } else if (strcmp(cv-&gt;value, &quot;match&quot;) == 0) {
@@ -1787,7 +1682,7 @@ static int do_body(X509 **xret, EVP_PKEY *pkey, X509 *x509,
                     BIO_printf(bio_err,
                                &quot;The mandatory %s field was missing\n&quot;,
                                cv-&gt;name);
-                    goto err;
+                    goto end;
                 }
 
                 last2 = -1;
@@ -1798,7 +1693,7 @@ static int do_body(X509 **xret, EVP_PKEY *pkey, X509 *x509,
                     BIO_printf(bio_err,
                                &quot;The %s field does not exist in the CA certificate,\nthe 'policy' is misconfigured\n&quot;,
                                cv-&gt;name);
-                    goto err;
+                    goto end;
                 }
                 if (j &gt;= 0) {
                     push = X509_NAME_get_entry(CAname, j);
@@ -1814,13 +1709,13 @@ static int do_body(X509 **xret, EVP_PKEY *pkey, X509 *x509,
                                cv-&gt;name,
                                ((str2 == NULL) ? &quot;NULL&quot; : (char *)str2-&gt;data),
                                ((str == NULL) ? &quot;NULL&quot; : (char *)str-&gt;data));
-                    goto err;
+                    goto end;
                 }
             } else {
                 BIO_printf(bio_err,
                            &quot;%s:invalid type in 'policy' configuration\n&quot;,
                            cv-&gt;value);
-                goto err;
+                goto end;
             }
 
             if (push != NULL) {
@@ -1828,7 +1723,7 @@ static int do_body(X509 **xret, EVP_PKEY *pkey, X509 *x509,
                     if (push != NULL)
                         X509_NAME_ENTRY_free(push);
                     BIO_printf(bio_err, &quot;Memory allocation failure\n&quot;);
-                    goto err;
+                    goto end;
                 }
             }
             if (j &lt; 0)
@@ -1841,7 +1736,7 @@ static int do_body(X509 **xret, EVP_PKEY *pkey, X509 *x509,
         /* subject=X509_NAME_dup(X509_REQ_get_subject_name(req)); */
         subject = X509_NAME_dup(name);
         if (subject == NULL)
-            goto err;
+            goto end;
     }
 
     if (verbose)
@@ -1864,7 +1759,7 @@ static int do_body(X509 **xret, EVP_PKEY *pkey, X509 *x509,
          */
         if (!(dn_subject = X509_NAME_dup(subject))) {
             BIO_printf(bio_err, &quot;Memory allocation failure\n&quot;);
-            goto err;
+            goto end;
         }
         while ((i = X509_NAME_get_index_by_NID(dn_subject,
                                                NID_pkcs9_emailAddress,
@@ -1881,7 +1776,7 @@ static int do_body(X509 **xret, EVP_PKEY *pkey, X509 *x509,
         row[DB_serial] = BN_bn2hex(serial);
     if (row[DB_serial] == NULL) {
         BIO_printf(bio_err, &quot;Memory allocation failure\n&quot;);
-        goto err;
+        goto end;
     }
 
     if (db-&gt;attributes.unique_subject) {
@@ -1939,7 +1834,7 @@ static int do_body(X509 **xret, EVP_PKEY *pkey, X509 *x509,
             p = &quot;undef&quot;;
         BIO_printf(bio_err, &quot;Subject Name  :%s\n&quot;, p);
         ok = -1;                /* This is now a 'bad' error. */
-        goto err;
+        goto end;
     }
 
     /* We are now totally happy, lets make and sign the certificate */
@@ -1948,23 +1843,23 @@ static int do_body(X509 **xret, EVP_PKEY *pkey, X509 *x509,
                    &quot;Everything appears to be ok, creating and signing the certificate\n&quot;);
 
     if ((ret = X509_new()) == NULL)
-        goto err;
+        goto end;
     ci = ret-&gt;cert_info;
 
 #ifdef X509_V3
     /* Make it an X509 v3 certificate. */
     if (!X509_set_version(ret, 2))
-        goto err;
+        goto end;
 #endif
 
     if (BN_to_ASN1_INTEGER(serial, ci-&gt;serialNumber) == NULL)
-        goto err;
+        goto end;
     if (selfsign) {
         if (!X509_set_issuer_name(ret, subject))
-            goto err;
+            goto end;
     } else {
         if (!X509_set_issuer_name(ret, X509_get_subject_name(x509)))
-            goto err;
+            goto end;
     }
 
     if (strcmp(startdate, &quot;today&quot;) == 0)
@@ -1982,20 +1877,20 @@ static int do_body(X509 **xret, EVP_PKEY *pkey, X509 *x509,
     }
 
     if (!X509_set_subject_name(ret, subject))
-        goto err;
+        goto end;
 
     pktmp = X509_REQ_get_pubkey(req);
     i = X509_set_pubkey(ret, pktmp);
     EVP_PKEY_free(pktmp);
     if (!i)
-        goto err;
+        goto end;
 
     /* Lets add the extensions, if there are any */
     if (ext_sect) {
         X509V3_CTX ctx;
         if (ci-&gt;version == NULL)
             if ((ci-&gt;version = ASN1_INTEGER_new()) == NULL)
-                goto err;
+                goto end;
         ASN1_INTEGER_set(ci-&gt;version, 2); /* version 3 certificate */
 
         /*
@@ -2028,7 +1923,7 @@ static int do_body(X509 **xret, EVP_PKEY *pkey, X509 *x509,
                            &quot;ERROR: adding extensions in section %s\n&quot;,
                            ext_sect);
                 ERR_print_errors(bio_err);
-                goto err;
+                goto end;
             }
             if (verbose)
                 BIO_printf(bio_err,
@@ -2042,7 +1937,7 @@ static int do_body(X509 **xret, EVP_PKEY *pkey, X509 *x509,
                            &quot;ERROR: adding extensions in section %s\n&quot;,
                            ext_sect);
                 ERR_print_errors(bio_err);
-                goto err;
+                goto end;
             }
 
             if (verbose)
@@ -2056,13 +1951,13 @@ static int do_body(X509 **xret, EVP_PKEY *pkey, X509 *x509,
     if (!copy_extensions(ret, req, ext_copy)) {
         BIO_printf(bio_err, &quot;ERROR: adding extensions from request\n&quot;);
         ERR_print_errors(bio_err);
-        goto err;
+        goto end;
     }
 
     /* Set the right value for the noemailDN option */
     if (email_dn == 0) {
         if (!X509_set_subject_name(ret, dn_subject))
-            goto err;
+            goto end;
     }
 
     if (!default_op) {
@@ -2089,12 +1984,12 @@ static int do_body(X509 **xret, EVP_PKEY *pkey, X509 *x509,
             BIO_printf(bio_err,
                        &quot;CERTIFICATE WILL NOT BE CERTIFIED: I/O error\n&quot;);
             ok = 0;
-            goto err;
+            goto end;
         }
         if (!((buf[0] == 'y') || (buf[0] == 'Y'))) {
             BIO_printf(bio_err, &quot;CERTIFICATE WILL NOT BE CERTIFIED\n&quot;);
             ok = 0;
-            goto err;
+            goto end;
         }
     }
 
@@ -2104,8 +1999,8 @@ static int do_body(X509 **xret, EVP_PKEY *pkey, X509 *x509,
         EVP_PKEY_copy_parameters(pktmp, pkey);
     EVP_PKEY_free(pktmp);
 
-    if (!do_X509_sign(bio_err, ret, pkey, dgst, sigopts))
-        goto err;
+    if (!do_X509_sign(ret, pkey, dgst, sigopts))
+        goto end;
 
     /* We now just add it to the database */
     row[DB_type] = (char *)OPENSSL_malloc(2);
@@ -2124,7 +2019,7 @@ static int do_body(X509 **xret, EVP_PKEY *pkey, X509 *x509,
     if ((row[DB_type] == NULL) || (row[DB_exp_date] == NULL) ||
         (row[DB_file] == NULL) || (row[DB_name] == NULL)) {
         BIO_printf(bio_err, &quot;Memory allocation failure\n&quot;);
-        goto err;
+        goto end;
     }
     BUF_strlcpy(row[DB_file], &quot;unknown&quot;, 8);
     row[DB_type][0] = 'V';
@@ -2133,7 +2028,7 @@ static int do_body(X509 **xret, EVP_PKEY *pkey, X509 *x509,
     if ((irow =
          (char **)OPENSSL_malloc(sizeof(char *) * (DB_NUMBER + 1))) == NULL) {
         BIO_printf(bio_err, &quot;Memory allocation failure\n&quot;);
-        goto err;
+        goto end;
     }
 
     for (i = 0; i &lt; DB_NUMBER; i++) {
@@ -2145,10 +2040,10 @@ static int do_body(X509 **xret, EVP_PKEY *pkey, X509 *x509,
     if (!TXT_DB_insert(db-&gt;db, irow)) {
         BIO_printf(bio_err, &quot;failed to update database\n&quot;);
         BIO_printf(bio_err, &quot;TXT_DB error number %ld\n&quot;, db-&gt;db-&gt;error);
-        goto err;
+        goto end;
     }
     ok = 1;
- err:
+ end:
     for (i = 0; i &lt; DB_NUMBER; i++)
         if (row[i] != NULL)
             OPENSSL_free(row[i]);
@@ -2216,14 +2111,14 @@ static int certify_spkac(X509 **xret, char *infile, EVP_PKEY *pkey,
     if (parms == NULL) {
         BIO_printf(bio_err, &quot;error on line %ld of %s\n&quot;, errline, infile);
         ERR_print_errors(bio_err);
-        goto err;
+        goto end;
     }
 
     sk = CONF_get_section(parms, &quot;default&quot;);
     if (sk_CONF_VALUE_num(sk) == 0) {
         BIO_printf(bio_err, &quot;no name/value pairs found in %s\n&quot;, infile);
         CONF_free(parms);
-        goto err;
+        goto end;
     }
 
     /*
@@ -2236,7 +2131,7 @@ static int certify_spkac(X509 **xret, char *infile, EVP_PKEY *pkey,
     req = X509_REQ_new();
     if (req == NULL) {
         ERR_print_errors(bio_err);
-        goto err;
+        goto end;
     }
 
     /*
@@ -2270,7 +2165,7 @@ static int certify_spkac(X509 **xret, char *infile, EVP_PKEY *pkey,
                     BIO_printf(bio_err,
                                &quot;unable to load Netscape SPKAC structure\n&quot;);
                     ERR_print_errors(bio_err);
-                    goto err;
+                    goto end;
                 }
             }
             continue;
@@ -2278,12 +2173,12 @@ static int certify_spkac(X509 **xret, char *infile, EVP_PKEY *pkey,
 
         if (!X509_NAME_add_entry_by_NID(n, nid, chtype,
                                         (unsigned char *)buf, -1, -1, 0))
-            goto err;
+            goto end;
     }
     if (spki == NULL) {
         BIO_printf(bio_err, &quot;Netscape SPKAC structure not found in %s\n&quot;,
                    infile);
-        goto err;
+        goto end;
     }
 
     /*
@@ -2295,14 +2190,14 @@ static int certify_spkac(X509 **xret, char *infile, EVP_PKEY *pkey,
 
     if ((pktmp = NETSCAPE_SPKI_get_pubkey(spki)) == NULL) {
         BIO_printf(bio_err, &quot;error unpacking SPKAC public key\n&quot;);
-        goto err;
+        goto end;
     }
 
     j = NETSCAPE_SPKI_verify(spki, pktmp);
     if (j &lt;= 0) {
         BIO_printf(bio_err,
                    &quot;signature verification failed on SPKAC public key\n&quot;);
-        goto err;
+        goto end;
     }
     BIO_printf(bio_err, &quot;Signature ok\n&quot;);
 
@@ -2312,7 +2207,7 @@ static int certify_spkac(X509 **xret, char *infile, EVP_PKEY *pkey,
                  chtype, multirdn, email_dn, startdate, enddate, days, 1,
                  verbose, req, ext_sect, lconf, certopt, nameopt, default_op,
                  ext_copy, 0);
- err:
+ end:
     if (req != NULL)
         X509_REQ_free(req);
     if (parms != NULL)
@@ -2343,7 +2238,7 @@ static int do_revoke(X509 *x509, CA_DB *db, int type, char *value)
     row[DB_name] = X509_NAME_oneline(X509_get_subject_name(x509), NULL, 0);
     bn = ASN1_INTEGER_to_BN(X509_get_serialNumber(x509), NULL);
     if (!bn)
-        goto err;
+        goto end;
     if (BN_is_zero(bn))
         row[DB_serial] = BUF_strdup(&quot;00&quot;);
     else
@@ -2351,7 +2246,7 @@ static int do_revoke(X509 *x509, CA_DB *db, int type, char *value)
     BN_free(bn);
     if ((row[DB_name] == NULL) || (row[DB_serial] == NULL)) {
         BIO_printf(bio_err, &quot;Memory allocation failure\n&quot;);
-        goto err;
+        goto end;
     }
     /*
      * We have to lookup by serial number because name lookup skips revoked
@@ -2381,7 +2276,7 @@ static int do_revoke(X509 *x509, CA_DB *db, int type, char *value)
         if ((row[DB_type] == NULL) || (row[DB_exp_date] == NULL) ||
             (row[DB_file] == NULL)) {
             BIO_printf(bio_err, &quot;Memory allocation failure\n&quot;);
-            goto err;
+            goto end;
         }
         BUF_strlcpy(row[DB_file], &quot;unknown&quot;, 8);
         row[DB_type][0] = 'V';
@@ -2391,7 +2286,7 @@ static int do_revoke(X509 *x509, CA_DB *db, int type, char *value)
              (char **)OPENSSL_malloc(sizeof(char *) * (DB_NUMBER + 1))) ==
             NULL) {
             BIO_printf(bio_err, &quot;Memory allocation failure\n&quot;);
-            goto err;
+            goto end;
         }
 
         for (i = 0; i &lt; DB_NUMBER; i++) {
@@ -2403,7 +2298,7 @@ static int do_revoke(X509 *x509, CA_DB *db, int type, char *value)
         if (!TXT_DB_insert(db-&gt;db, irow)) {
             BIO_printf(bio_err, &quot;failed to update database\n&quot;);
             BIO_printf(bio_err, &quot;TXT_DB error number %ld\n&quot;, db-&gt;db-&gt;error);
-            goto err;
+            goto end;
         }
 
         /* Revoke Certificate */
@@ -2412,32 +2307,32 @@ static int do_revoke(X509 *x509, CA_DB *db, int type, char *value)
         else
             ok = do_revoke(x509, db, type, value);
 
-        goto err;
+        goto end;
 
     } else if (index_name_cmp_noconst(row, rrow)) {
         BIO_printf(bio_err, &quot;ERROR:name does not match %s\n&quot;, row[DB_name]);
-        goto err;
+        goto end;
     } else if (type == -1) {
         BIO_printf(bio_err, &quot;ERROR:Already present, serial number %s\n&quot;,
                    row[DB_serial]);
-        goto err;
+        goto end;
     } else if (rrow[DB_type][0] == 'R') {
         BIO_printf(bio_err, &quot;ERROR:Already revoked, serial number %s\n&quot;,
                    row[DB_serial]);
-        goto err;
+        goto end;
     } else {
         BIO_printf(bio_err, &quot;Revoking Certificate %s.\n&quot;, rrow[DB_serial]);
         rev_str = make_revocation_str(type, value);
         if (!rev_str) {
             BIO_printf(bio_err, &quot;Error in revocation arguments\n&quot;);
-            goto err;
+            goto end;
         }
         rrow[DB_type][0] = 'R';
         rrow[DB_type][1] = '\0';
         rrow[DB_rev_date] = rev_str;
     }
     ok = 1;
- err:
+ end:
     for (i = 0; i &lt; DB_NUMBER; i++) {
         if (row[i] != NULL)
             OPENSSL_free(row[i]);
@@ -2458,7 +2353,7 @@ static int get_certificate_status(const char *serial, CA_DB *db)
     row[DB_serial] = OPENSSL_malloc(strlen(serial) + 2);
     if (row[DB_serial] == NULL) {
         BIO_printf(bio_err, &quot;Malloc failure\n&quot;);
-        goto err;
+        goto end;
     }
 
     if (strlen(serial) % 2) {
@@ -2487,29 +2382,29 @@ static int get_certificate_status(const char *serial, CA_DB *db)
     if (rrow == NULL) {
         BIO_printf(bio_err, &quot;Serial %s not present in db.\n&quot;, row[DB_serial]);
         ok = -1;
-        goto err;
+        goto end;
     } else if (rrow[DB_type][0] == 'V') {
         BIO_printf(bio_err, &quot;%s=Valid (%c)\n&quot;,
                    row[DB_serial], rrow[DB_type][0]);
-        goto err;
+        goto end;
     } else if (rrow[DB_type][0] == 'R') {
         BIO_printf(bio_err, &quot;%s=Revoked (%c)\n&quot;,
                    row[DB_serial], rrow[DB_type][0]);
-        goto err;
+        goto end;
     } else if (rrow[DB_type][0] == 'E') {
         BIO_printf(bio_err, &quot;%s=Expired (%c)\n&quot;,
                    row[DB_serial], rrow[DB_type][0]);
-        goto err;
+        goto end;
     } else if (rrow[DB_type][0] == 'S') {
         BIO_printf(bio_err, &quot;%s=Suspended (%c)\n&quot;,
                    row[DB_serial], rrow[DB_type][0]);
-        goto err;
+        goto end;
     } else {
         BIO_printf(bio_err, &quot;%s=Unknown (%c).\n&quot;,
                    row[DB_serial], rrow[DB_type][0]);
         ok = -1;
     }
- err:
+ end:
     for (i = 0; i &lt; DB_NUMBER; i++) {
         if (row[i] != NULL)
             OPENSSL_free(row[i]);
@@ -2531,7 +2426,7 @@ static int do_updatedb(CA_DB *db)
     a_tm_s = (char *)OPENSSL_malloc(a_tm-&gt;length + 1);
     if (a_tm_s == NULL) {
         cnt = -1;
-        goto err;
+        goto end;
     }
 
     memcpy(a_tm_s, a_tm-&gt;data, a_tm-&gt;length);
@@ -2572,7 +2467,7 @@ static int do_updatedb(CA_DB *db)
         }
     }
 
- err:
+ end:
 
     ASN1_UTCTIME_free(a_tm);
     OPENSSL_free(a_tm_s);
@@ -2716,28 +2611,28 @@ int make_revoked(X509_REVOKED *rev, const char *str)
     i = unpack_revinfo(&amp;revDate, &amp;reason_code, &amp;hold, &amp;comp_time, str);
 
     if (i == 0)
-        goto err;
+        goto end;
 
     if (rev &amp;&amp; !X509_REVOKED_set_revocationDate(rev, revDate))
-        goto err;
+        goto end;
 
     if (rev &amp;&amp; (reason_code != OCSP_REVOKED_STATUS_NOSTATUS)) {
         rtmp = ASN1_ENUMERATED_new();
         if (!rtmp || !ASN1_ENUMERATED_set(rtmp, reason_code))
-            goto err;
+            goto end;
         if (!X509_REVOKED_add1_ext_i2d(rev, NID_crl_reason, rtmp, 0, 0))
-            goto err;
+            goto end;
     }
 
     if (rev &amp;&amp; comp_time) {
         if (!X509_REVOKED_add1_ext_i2d
             (rev, NID_invalidity_date, comp_time, 0, 0))
-            goto err;
+            goto end;
     }
     if (rev &amp;&amp; hold) {
         if (!X509_REVOKED_add1_ext_i2d
             (rev, NID_hold_instruction_code, hold, 0, 0))
-            goto err;
+            goto end;
     }
 
     if (reason_code != OCSP_REVOKED_STATUS_NOSTATUS)
@@ -2745,7 +2640,7 @@ int make_revoked(X509_REVOKED *rev, const char *str)
     else
         ret = 1;
 
- err:
+ end:
 
     if (tmp)
         OPENSSL_free(tmp);
@@ -2799,18 +2694,18 @@ int old_entry_print(BIO *bp, ASN1_OBJECT *obj, ASN1_STRING *str)
 int unpack_revinfo(ASN1_TIME **prevtm, int *preason, ASN1_OBJECT **phold,
                    ASN1_GENERALIZEDTIME **pinvtm, const char *str)
 {
-    char *tmp = NULL;
+    char *tmp;
     char *rtime_str, *reason_str = NULL, *arg_str = NULL, *p;
     int reason_code = -1;
     int ret = 0;
     unsigned int i;
     ASN1_OBJECT *hold = NULL;
     ASN1_GENERALIZEDTIME *comp_time = NULL;
-    tmp = BUF_strdup(str);
 
+    tmp = BUF_strdup(str);
     if (!tmp) {
         BIO_printf(bio_err, &quot;memory allocation failure\n&quot;);
-        goto err;
+        goto end;
     }
 
     p = strchr(tmp, ',');
@@ -2832,11 +2727,11 @@ int unpack_revinfo(ASN1_TIME **prevtm, int *preason, ASN1_OBJECT **phold,
         *prevtm = ASN1_UTCTIME_new();
         if (!*prevtm) {
             BIO_printf(bio_err, &quot;memory allocation failure\n&quot;);
-            goto err;
+            goto end;
         }
         if (!ASN1_UTCTIME_set_string(*prevtm, rtime_str)) {
             BIO_printf(bio_err, &quot;invalid revocation date %s\n&quot;, rtime_str);
-            goto err;
+            goto end;
         }
     }
     if (reason_str) {
@@ -2848,7 +2743,7 @@ int unpack_revinfo(ASN1_TIME **prevtm, int *preason, ASN1_OBJECT **phold,
         }
         if (reason_code == OCSP_REVOKED_STATUS_NOSTATUS) {
             BIO_printf(bio_err, &quot;invalid reason code %s\n&quot;, reason_str);
-            goto err;
+            goto end;
         }
 
         if (reason_code == 7)
@@ -2856,7 +2751,7 @@ int unpack_revinfo(ASN1_TIME **prevtm, int *preason, ASN1_OBJECT **phold,
         else if (reason_code == 8) { /* Hold instruction */
             if (!arg_str) {
                 BIO_printf(bio_err, &quot;missing hold instruction\n&quot;);
-                goto err;
+                goto end;
             }
             reason_code = OCSP_REVOKED_STATUS_CERTIFICATEHOLD;
             hold = OBJ_txt2obj(arg_str, 0);
@@ -2864,23 +2759,23 @@ int unpack_revinfo(ASN1_TIME **prevtm, int *preason, ASN1_OBJECT **phold,
             if (!hold) {
                 BIO_printf(bio_err, &quot;invalid object identifier %s\n&quot;,
                            arg_str);
-                goto err;
+                goto end;
             }
             if (phold)
                 *phold = hold;
         } else if ((reason_code == 9) || (reason_code == 10)) {
             if (!arg_str) {
                 BIO_printf(bio_err, &quot;missing compromised time\n&quot;);
-                goto err;
+                goto end;
             }
             comp_time = ASN1_GENERALIZEDTIME_new();
             if (!comp_time) {
                 BIO_printf(bio_err, &quot;memory allocation failure\n&quot;);
-                goto err;
+                goto end;
             }
             if (!ASN1_GENERALIZEDTIME_set_string(comp_time, arg_str)) {
                 BIO_printf(bio_err, &quot;invalid compromised time %s\n&quot;, arg_str);
-                goto err;
+                goto end;
             }
             if (reason_code == 9)
                 reason_code = OCSP_REVOKED_STATUS_KEYCOMPROMISE;
@@ -2898,7 +2793,7 @@ int unpack_revinfo(ASN1_TIME **prevtm, int *preason, ASN1_OBJECT **phold,
 
     ret = 1;
 
- err:
+ end:
 
     if (tmp)
         OPENSSL_free(tmp);
diff --git a/apps/ciphers.c b/apps/ciphers.c
index 4b9a114..3d84a2b 100644
--- a/apps/ciphers.c
+++ b/apps/ciphers.c
@@ -1,4 +1,3 @@
-/* apps/ciphers.c */
 /* Copyright (C) 1995-1998 Eric Young (<A HREF="../../../mailman/listinfo/openssl-commits.html">eay at cryptsoft.com</A>)
  * All rights reserved.
  *
@@ -63,91 +62,91 @@
 #include &lt;openssl/err.h&gt;
 #include &lt;openssl/ssl.h&gt;
 
-#undef PROG
-#define PROG    ciphers_main
-
-static const char *ciphers_usage[] = {
-    &quot;usage: ciphers args\n&quot;,
-    &quot; -v          - verbose mode, a textual listing of the SSL/TLS ciphers in OpenSSL\n&quot;,
-    &quot; -V          - even more verbose\n&quot;,
-    &quot; -ssl3       - SSL3 mode\n&quot;,
-    &quot; -tls1       - TLS1 mode\n&quot;,
-    NULL
+typedef enum OPTION_choice {
+    OPT_ERR = -1, OPT_EOF = 0, OPT_HELP,
+#ifndef OPENSSL_NO_SSL_TRACE
+    OPT_STDNAME,
+#endif
+#ifndef OPENSSL_NO_SSL3
+    OPT_SSL3,
+#endif
+    OPT_TLS1,
+    OPT_V, OPT_UPPER_V, OPT_S
+} OPTION_CHOICE;
+
+OPTIONS ciphers_options[] = {
+    {&quot;help&quot;, OPT_HELP, '-', &quot;Display this summary&quot;},
+    {&quot;v&quot;, OPT_V, '-', &quot;Verbose listing of the SSL/TLS ciphers&quot;},
+    {&quot;V&quot;, OPT_UPPER_V, '-', &quot;Even more verbose&quot;},
+    {&quot;s&quot;, OPT_S, '-', &quot;Only supported ciphers&quot;},
+#ifndef OPENSSL_NO_SSL_TRACE
+    {&quot;stdname&quot;, OPT_STDNAME, '-', &quot;Show standard cipher names&quot;},
+#endif
+#ifndef OPENSSL_NO_SSL3
+    {&quot;ssl3&quot;, OPT_SSL3, '-', &quot;SSL3 mode&quot;},
+#endif
+    {&quot;tls1&quot;, OPT_TLS1, '-', &quot;TLS1 mode&quot;},
+    {NULL}
 };
 
-int MAIN(int, char **);
-
-int MAIN(int argc, char **argv)
+int ciphers_main(int argc, char **argv)
 {
-    int ret = 1, i;
-    int verbose = 0, Verbose = 0;
-    int use_supported = 0;
+    SSL_CTX *ctx = NULL;
+    SSL *ssl = NULL;
+    STACK_OF(SSL_CIPHER) *sk = NULL;
+    const SSL_METHOD *meth = SSLv23_server_method();
+    int ret = 1, i, verbose = 0, Verbose = 0, use_supported = 0;
 #ifndef OPENSSL_NO_SSL_TRACE
     int stdname = 0;
 #endif
-    const char **pp;
     const char *p;
-    int badops = 0;
-    SSL_CTX *ctx = NULL;
-    SSL *ssl = NULL;
-    char *ciphers = NULL;
-    const SSL_METHOD *meth = NULL;
-    STACK_OF(SSL_CIPHER) *sk = NULL;
+    char *ciphers = NULL, *prog;
     char buf[512];
-    BIO *STDout = NULL;
-
-    meth = SSLv23_server_method();
-
-    apps_startup();
-
-    if (bio_err == NULL)
-        bio_err = BIO_new_fp(stderr, BIO_NOCLOSE);
-    STDout = BIO_new_fp(stdout, BIO_NOCLOSE);
-#ifdef OPENSSL_SYS_VMS
-    {
-        BIO *tmpbio = BIO_new(BIO_f_linebuffer());
-        STDout = BIO_push(tmpbio, STDout);
-    }
-#endif
-    if (!load_config(bio_err, NULL))
-        goto end;
-
-    argc--;
-    argv++;
-    while (argc &gt;= 1) {
-        if (strcmp(*argv, &quot;-v&quot;) == 0)
+    OPTION_CHOICE o;
+
+    prog = opt_init(argc, argv, ciphers_options);
+    while ((o = opt_next()) != OPT_EOF) {
+        switch (o) {
+        case OPT_EOF:
+        case OPT_ERR:
+ opthelp:
+            BIO_printf(bio_err, &quot;%s: Use -help for summary.\n&quot;, prog);
+            goto end;
+        case OPT_HELP:
+            opt_help(ciphers_options);
+            ret = 0;
+            goto end;
+        case OPT_V:
             verbose = 1;
-        else if (strcmp(*argv, &quot;-V&quot;) == 0)
+            break;
+        case OPT_UPPER_V:
             verbose = Verbose = 1;
-        else if (strcmp(*argv, &quot;-s&quot;) == 0)
+            break;
+        case OPT_S:
             use_supported = 1;
+            break;
 #ifndef OPENSSL_NO_SSL_TRACE
-        else if (strcmp(*argv, &quot;-stdname&quot;) == 0)
+        case OPT_STDNAME:
             stdname = verbose = 1;
+            break;
 #endif
 #ifndef OPENSSL_NO_SSL3
-        else if (strcmp(*argv, &quot;-ssl3&quot;) == 0)
+        case OPT_SSL3:
             meth = SSLv3_client_method();
+            break;
 #endif
-        else if (strcmp(*argv, &quot;-tls1&quot;) == 0)
+        case OPT_TLS1:
             meth = TLSv1_client_method();
-        else if ((strncmp(*argv, &quot;-h&quot;, 2) == 0) || (strcmp(*argv, &quot;-?&quot;) == 0)) {
-            badops = 1;
             break;
-        } else {
-            ciphers = *argv;
         }
-        argc--;
-        argv++;
     }
+    argv = opt_rest();
+    argc = opt_num_rest();
 
-    if (badops) {
-        for (pp = ciphers_usage; (*pp != NULL); pp++)
-            BIO_printf(bio_err, &quot;%s&quot;, *pp);
-        goto end;
-    }
-
-    OpenSSL_add_ssl_algorithms();
+    if (argc == 1)
+        ciphers = *argv;
+    else if (argc != 0)
+        goto opthelp;
 
     ctx = SSL_CTX_new(meth);
     if (ctx == NULL)
@@ -174,11 +173,11 @@ int MAIN(int argc, char **argv)
             if (p == NULL)
                 break;
             if (i != 0)
-                BIO_printf(STDout, &quot;:&quot;);
-            BIO_printf(STDout, &quot;%s&quot;, p);
+                BIO_printf(bio_out, &quot;:&quot;);
+            BIO_printf(bio_out, &quot;%s&quot;, p);
         }
-        BIO_printf(STDout, &quot;\n&quot;);
-    } else {                    /* verbose */
+        BIO_printf(bio_out, &quot;\n&quot;);
+    } else {
 
         for (i = 0; i &lt; sk_SSL_CIPHER_num(sk); i++) {
             SSL_CIPHER *c;
@@ -192,40 +191,32 @@ int MAIN(int argc, char **argv)
                 int id2 = (int)((id &gt;&gt; 8) &amp; 0xffL);
                 int id3 = (int)(id &amp; 0xffL);
 
-                if ((id &amp; 0xff000000L) == 0x03000000L) {
-                    /* SSL3 cipher */
-                    BIO_printf(STDout, &quot;          0x%02X,0x%02X - &quot;, id2,
-                               id3);
-                } else {
-                    /* whatever */
-                    BIO_printf(STDout, &quot;0x%02X,0x%02X,0x%02X,0x%02X - &quot;, id0,
-                               id1, id2, id3);
-                }
+                if ((id &amp; 0xff000000L) == 0x03000000L)
+                    BIO_printf(bio_out, &quot;          0x%02X,0x%02X - &quot;, id2, id3); /* SSL3
+                                                                                  * cipher */
+                else
+                    BIO_printf(bio_out, &quot;0x%02X,0x%02X,0x%02X,0x%02X - &quot;, id0, id1, id2, id3); /* whatever */
             }
 #ifndef OPENSSL_NO_SSL_TRACE
             if (stdname) {
                 const char *nm = SSL_CIPHER_standard_name(c);
                 if (nm == NULL)
                     nm = &quot;UNKNOWN&quot;;
-                BIO_printf(STDout, &quot;%s - &quot;, nm);
+                BIO_printf(bio_out, &quot;%s - &quot;, nm);
             }
 #endif
-            BIO_puts(STDout, SSL_CIPHER_description(c, buf, sizeof buf));
+            BIO_puts(bio_out, SSL_CIPHER_description(c, buf, sizeof buf));
         }
     }
 
     ret = 0;
-    if (0) {
+    goto end;
  err:
-        SSL_load_error_strings();
-        ERR_print_errors(bio_err);
-    }
+    ERR_print_errors(bio_err);
  end:
     if (use_supported &amp;&amp; sk)
         sk_SSL_CIPHER_free(sk);
     SSL_CTX_free(ctx);
     SSL_free(ssl);
-    BIO_free_all(STDout);
-    apps_shutdown();
-    OPENSSL_EXIT(ret);
+    return (ret);
 }
diff --git a/apps/cms.c b/apps/cms.c
index 73f9037..397071c 100644
--- a/apps/cms.c
+++ b/apps/cms.c
@@ -1,4 +1,3 @@
-/* apps/cms.c */
 /*
  * Written by Dr Stephen N Henson (<A HREF="../../../mailman/listinfo/openssl-commits.html">steve at openssl.org</A>) for the OpenSSL
  * project.
@@ -67,8 +66,6 @@
 # include &lt;openssl/x509v3.h&gt;
 # include &lt;openssl/cms.h&gt;
 
-# undef PROG
-# define PROG cms_main
 static int save_certs(char *signerfile, STACK_OF(X509) *signers);
 static int cms_cb(int ok, X509_STORE_CTX *ctx);
 static void receipt_request_print(BIO *out, CMS_ContentInfo *cms);
@@ -108,347 +105,456 @@ struct cms_key_param_st {
     cms_key_param *next;
 };
 
-int MAIN(int, char **);
+typedef enum OPTION_choice {
+    OPT_ERR = -1, OPT_EOF = 0, OPT_HELP,
+    OPT_INFORM, OPT_OUTFORM, OPT_IN, OPT_OUT, OPT_ENCRYPT,
+    OPT_DECRYPT, OPT_SIGN, OPT_SIGN_RECEIPT, OPT_RESIGN,
+    OPT_VERIFY, OPT_VERIFY_RETCODE, OPT_VERIFY_RECEIPT,
+    OPT_CMSOUT, OPT_DATA_OUT, OPT_DATA_CREATE, OPT_DIGEST_VERIFY,
+    OPT_DIGEST_CREATE, OPT_COMPRESS, OPT_UNCOMPRESS,
+    OPT_ED_DECRYPT, OPT_ED_ENCRYPT, OPT_DEBUG_DECRYPT, OPT_TEXT,
+    OPT_ASCIICRLF, OPT_NOINTERN, OPT_NOVERIFY, OPT_NOCERTS,
+    OPT_NOATTR, OPT_NODETACH, OPT_NOSMIMECAP, OPT_BINARY, OPT_KEYID,
+    OPT_NOSIGS, OPT_NO_CONTENT_VERIFY, OPT_NO_ATTR_VERIFY, OPT_INDEF,
+    OPT_NOINDEF, OPT_NOOLDMIME, OPT_CRLFEOL, OPT_NOOUT, OPT_RR_PRINT,
+    OPT_RR_ALL, OPT_RR_FIRST, OPT_RCTFORM, OPT_CERTFILE, OPT_CAFILE,
+    OPT_CAPATH, OPT_CONTENT, OPT_PRINT, OPT_SECRETKEY,
+    OPT_SECRETKEYID, OPT_PWRI_PASSWORD, OPT_ECONTENT_TYPE, OPT_RAND,
+    OPT_PASSIN, OPT_TO, OPT_FROM, OPT_SUBJECT, OPT_SIGNER, OPT_RECIP,
+    OPT_CERTSOUT, OPT_MD, OPT_INKEY, OPT_KEYFORM, OPT_KEYOPT, OPT_RR_FROM,
+    OPT_RR_TO, OPT_AES128_WRAP, OPT_AES192_WRAP, OPT_AES256_WRAP,
+    OPT_3DES_WRAP, OPT_ENGINE,
+    OPT_V_ENUM,
+    OPT_CIPHER
+} OPTION_CHOICE;
+
+OPTIONS cms_options[] = {
+    {OPT_HELP_STR, 1, '-', &quot;Usage: %s [options] cert.pem...\n&quot;},
+    {OPT_HELP_STR, 1, '-',
+        &quot;  cert.pem... recipient certs for encryption\n&quot;},
+    {OPT_HELP_STR, 1, '-', &quot;Valid options are:\n&quot;},
+    {&quot;help&quot;, OPT_HELP, '-', &quot;Display this summary&quot;},
+    {&quot;inform&quot;, OPT_INFORM, 'F', &quot;Input format SMIME (default), PEM or DER&quot;},
+    {&quot;outform&quot;, OPT_OUTFORM, 'F',
+     &quot;Output format SMIME (default), PEM or DER&quot;},
+    {&quot;in&quot;, OPT_IN, '&lt;', &quot;Input file&quot;},
+    {&quot;out&quot;, OPT_OUT, '&gt;', &quot;Output file&quot;},
+    {&quot;encrypt&quot;, OPT_ENCRYPT, '-', &quot;Encrypt message&quot;},
+    {&quot;decrypt&quot;, OPT_DECRYPT, '-', &quot;Decrypt encrypted message&quot;},
+    {&quot;sign&quot;, OPT_SIGN, '-', &quot;Sign message&quot;},
+    {&quot;sign_receipt&quot;, OPT_SIGN_RECEIPT, '-'},
+    {&quot;resign&quot;, OPT_RESIGN, '-'},
+    {&quot;verify&quot;, OPT_VERIFY, '-', &quot;Verify signed message&quot;},
+    {&quot;verify_retcode&quot;, OPT_VERIFY_RETCODE, '-'},
+    {&quot;verify_receipt&quot;, OPT_VERIFY_RECEIPT, '&lt;'},
+    {&quot;cmsout&quot;, OPT_CMSOUT, '-', &quot;Output CMS structure&quot;},
+    {&quot;data_out&quot;, OPT_DATA_OUT, '-'},
+    {&quot;data_create&quot;, OPT_DATA_CREATE, '-'},
+    {&quot;digest_verify&quot;, OPT_DIGEST_VERIFY, '-'},
+    {&quot;digest_create&quot;, OPT_DIGEST_CREATE, '-'},
+    {&quot;compress&quot;, OPT_COMPRESS, '-'},
+    {&quot;uncompress&quot;, OPT_UNCOMPRESS, '-'},
+    {&quot;EncryptedData_decrypt&quot;, OPT_ED_DECRYPT, '-'},
+    {&quot;EncryptedData_encrypt&quot;, OPT_ED_ENCRYPT, '-'},
+    {&quot;debug_decrypt&quot;, OPT_DEBUG_DECRYPT, '-'},
+    {&quot;text&quot;, OPT_TEXT, '-', &quot;Include or delete text MIME headers&quot;},
+    {&quot;asciicrlf&quot;, OPT_ASCIICRLF, '-'},
+    {&quot;nointern&quot;, OPT_NOINTERN, '-',
+     &quot;Don't search certificates in message for signer&quot;},
+    {&quot;noverify&quot;, OPT_NOVERIFY, '-', &quot;Don't verify signers certificate&quot;},
+    {&quot;nocerts&quot;, OPT_NOCERTS, '-',
+     &quot;Don't include signers certificate when signing&quot;},
+    {&quot;noattr&quot;, OPT_NOATTR, '-', &quot;Don't include any signed attributes&quot;},
+    {&quot;nodetach&quot;, OPT_NODETACH, '-', &quot;Use opaque signing&quot;},
+    {&quot;nosmimecap&quot;, OPT_NOSMIMECAP, '-'},
+    {&quot;binary&quot;, OPT_BINARY, '-', &quot;Don't translate message to text&quot;},
+    {&quot;keyid&quot;, OPT_KEYID, '-', &quot;Use subject key identifier&quot;},
+    {&quot;nosigs&quot;, OPT_NOSIGS, '-', &quot;Don't verify message signature&quot;},
+    {&quot;no_content_verify&quot;, OPT_NO_CONTENT_VERIFY, '-'},
+    {&quot;no_attr_verify&quot;, OPT_NO_ATTR_VERIFY, '-'},
+    {&quot;stream&quot;, OPT_INDEF, '-'},
+    {&quot;indef&quot;, OPT_INDEF, '-'},
+    {&quot;noindef&quot;, OPT_NOINDEF, '-'},
+    {&quot;nooldmime&quot;, OPT_NOOLDMIME, '-'},
+    {&quot;crlfeol&quot;, OPT_CRLFEOL, '-'},
+    {&quot;noout&quot;, OPT_NOOUT, '-'},
+    {&quot;receipt_request_print&quot;, OPT_RR_PRINT, '-'},
+    {&quot;receipt_request_all&quot;, OPT_RR_ALL, '-'},
+    {&quot;receipt_request_first&quot;, OPT_RR_FIRST, '-'},
+    {&quot;rctform&quot;, OPT_RCTFORM, 'F'},
+    {&quot;certfile&quot;, OPT_CERTFILE, '&lt;', &quot;Other certificates file&quot;},
+    {&quot;CAfile&quot;, OPT_CAFILE, '&lt;', &quot;Trusted certificates file&quot;},
+    {&quot;CApath&quot;, OPT_CAPATH, '/', &quot;trusted certificates directory&quot;},
+    {&quot;content&quot;, OPT_CONTENT, '&lt;',
+     &quot;Supply or override content for detached signature&quot;},
+    {&quot;print&quot;, OPT_PRINT, '-'},
+    {&quot;secretkey&quot;, OPT_SECRETKEY, 's'},
+    {&quot;secretkeyid&quot;, OPT_SECRETKEYID, 's'},
+    {&quot;pwri_password&quot;, OPT_PWRI_PASSWORD, 's'},
+    {&quot;econtent_type&quot;, OPT_ECONTENT_TYPE, 's'},
+    {&quot;rand&quot;, OPT_RAND, 's',
+     &quot;Load the file(s) into the random number generator&quot;},
+    {&quot;passin&quot;, OPT_PASSIN, 's', &quot;Input file pass phrase source&quot;},
+    {&quot;to&quot;, OPT_TO, 's', &quot;To address&quot;},
+    {&quot;from&quot;, OPT_FROM, 's', &quot;From address&quot;},
+    {&quot;subject&quot;, OPT_SUBJECT, 's', &quot;Subject&quot;},
+    {&quot;signer&quot;, OPT_SIGNER, 's', &quot;Signer certificate file&quot;},
+    {&quot;recip&quot;, OPT_RECIP, '&lt;', &quot;Recipient cert file for decryption&quot;},
+    {&quot;certsout&quot;, OPT_CERTSOUT, '&gt;', &quot;Certificate output file&quot;},
+    {&quot;md&quot;, OPT_MD, 's'},
+    {&quot;inkey&quot;, OPT_INKEY, '&lt;',
+     &quot;Input private key (if not signer or recipient)&quot;},
+    {&quot;keyform&quot;, OPT_KEYFORM, 'f', &quot;Input private key format (PEM or ENGINE)&quot;},
+    {&quot;keyopt&quot;, OPT_KEYOPT, 's', &quot;Set public key parameters as n:v pairs&quot;},
+    {&quot;receipt_request_from&quot;, OPT_RR_FROM, 's'},
+    {&quot;receipt_request_to&quot;, OPT_RR_TO, 's'},
+# ifndef OPENSSL_NO_AES
+    {&quot;aes128-wrap&quot;, OPT_AES128_WRAP, '-', &quot;Use AES128 to wrap key&quot;},
+    {&quot;aes192-wrap&quot;, OPT_AES192_WRAP, '-', &quot;Use AES192 to wrap key&quot;},
+    {&quot;aes256-wrap&quot;, OPT_AES256_WRAP, '-', &quot;Use AES256 to wrap key&quot;},
+# endif
+# ifndef OPENSSL_NO_DES
+    {&quot;des3-wrap&quot;, OPT_3DES_WRAP, '-', &quot;Use 3DES-EDE to wrap key&quot;},
+# endif
+# ifndef OPENSSL_NO_ENGINE
+    {&quot;engine&quot;, OPT_ENGINE, 's', &quot;Use engine e, possibly a hardware device&quot;},
+# endif
+    {&quot;&quot;, OPT_CIPHER, '-', &quot;Any supported cipher&quot;},
+    OPT_V_OPTIONS,
+    {NULL},
+};
 
-int MAIN(int argc, char **argv)
+int cms_main(int argc, char **argv)
 {
-    ENGINE *e = NULL;
-    int operation = 0;
-    int ret = 0;
-    char **args;
-    const char *inmode = &quot;r&quot;, *outmode = &quot;w&quot;;
-    char *infile = NULL, *outfile = NULL, *rctfile = NULL;
-    char *signerfile = NULL, *recipfile = NULL;
-    STACK_OF(OPENSSL_STRING) *sksigners = NULL, *skkeys = NULL;
-    char *certfile = NULL, *keyfile = NULL, *contfile = NULL;
-    char *certsoutfile = NULL;
-    const EVP_CIPHER *cipher = NULL, *wrap_cipher = NULL;
-    CMS_ContentInfo *cms = NULL, *rcms = NULL;
-    X509_STORE *store = NULL;
-    X509 *cert = NULL, *recip = NULL, *signer = NULL;
-    EVP_PKEY *key = NULL;
-    STACK_OF(X509) *encerts = NULL, *other = NULL;
+    ASN1_OBJECT *econtent_type = NULL;
     BIO *in = NULL, *out = NULL, *indata = NULL, *rctin = NULL;
-    int badarg = 0;
-    int flags = CMS_DETACHED, noout = 0, print = 0;
-    int verify_retcode = 0;
-    int rr_print = 0, rr_allorfirst = -1;
-    STACK_OF(OPENSSL_STRING) *rr_to = NULL, *rr_from = NULL;
+    CMS_ContentInfo *cms = NULL, *rcms = NULL;
     CMS_ReceiptRequest *rr = NULL;
-    char *to = NULL, *from = NULL, *subject = NULL;
-    char *CAfile = NULL, *CApath = NULL;
-    char *passargin = NULL, *passin = NULL;
-    char *inrand = NULL;
-    int need_rand = 0;
+    ENGINE *e = NULL;
+    EVP_PKEY *key = NULL;
+    const EVP_CIPHER *cipher = NULL, *wrap_cipher = NULL;
     const EVP_MD *sign_md = NULL;
+    STACK_OF(OPENSSL_STRING) *rr_to = NULL, *rr_from = NULL;
+    STACK_OF(OPENSSL_STRING) *sksigners = NULL, *skkeys = NULL;
+    STACK_OF(X509) *encerts = NULL, *other = NULL;
+    X509 *cert = NULL, *recip = NULL, *signer = NULL;
+    X509_STORE *store = NULL;
+    X509_VERIFY_PARAM *vpm = NULL;
+    char *certfile = NULL, *keyfile = NULL, *contfile = NULL;
+    char *CAfile = NULL, *CApath = NULL, *certsoutfile = NULL, *engine = NULL;
+    char *infile = NULL, *outfile = NULL, *rctfile = NULL, *inrand = NULL;
+    char *passinarg = NULL, *passin = NULL, *signerfile = NULL, *recipfile =
+        NULL;
+    char *to = NULL, *from = NULL, *subject = NULL, *prog;
+    cms_key_param *key_first = NULL, *key_param = NULL;
+    const char *inmode = &quot;r&quot;, *outmode = &quot;w&quot;;
+    int flags = CMS_DETACHED, noout = 0, print = 0, keyidx = -1, vpmtouched =
+        0;
     int informat = FORMAT_SMIME, outformat = FORMAT_SMIME;
-    int rctformat = FORMAT_SMIME, keyform = FORMAT_PEM;
-# ifndef OPENSSL_NO_ENGINE
-    char *engine = NULL;
-# endif
-    unsigned char *secret_key = NULL, *secret_keyid = NULL;
-    unsigned char *pwri_pass = NULL, *pwri_tmp = NULL;
+    int need_rand = 0, operation = 0, ret = 1, rr_print = 0, rr_allorfirst =
+        -1;
+    int verify_retcode = 0, rctformat = FORMAT_SMIME, keyform = FORMAT_PEM;
     size_t secret_keylen = 0, secret_keyidlen = 0;
+    unsigned char *pwri_pass = NULL, *pwri_tmp = NULL;
+    unsigned char *secret_key = NULL, *secret_keyid = NULL;
+    long ltmp;
+    OPTION_CHOICE o;
 
-    cms_key_param *key_first = NULL, *key_param = NULL;
-
-    ASN1_OBJECT *econtent_type = NULL;
-
-    X509_VERIFY_PARAM *vpm = NULL;
-
-    args = argv + 1;
-    ret = 1;
-
-    apps_startup();
-
-    if (bio_err == NULL) {
-        if ((bio_err = BIO_new(BIO_s_file())) != NULL)
-            BIO_set_fp(bio_err, stderr, BIO_NOCLOSE | BIO_FP_TEXT);
-    }
-
-    if (!load_config(bio_err, NULL))
-        goto end;
+    if ((vpm = X509_VERIFY_PARAM_new()) == NULL)
+        return 1;
 
-    while (!badarg &amp;&amp; *args &amp;&amp; *args[0] == '-') {
-        if (!strcmp(*args, &quot;-encrypt&quot;))
+    prog = opt_init(argc, argv, cms_options);
+    while ((o = opt_next()) != OPT_EOF) {
+        switch (o) {
+        case OPT_EOF:
+        case OPT_ERR:
+ opthelp:
+            BIO_printf(bio_err, &quot;%s: Use -help for summary.\n&quot;, prog);
+            goto end;
+        case OPT_HELP:
+            opt_help(cms_options);
+            ret = 0;
+            goto end;
+        case OPT_INFORM:
+            if (!opt_format(opt_arg(), OPT_FMT_PEMDER, &amp;informat))
+                goto opthelp;
+            break;
+        case OPT_OUTFORM:
+            if (!opt_format(opt_arg(), OPT_FMT_PEMDER, &amp;outformat))
+                goto opthelp;
+            break;
+        case OPT_OUT:
+            outfile = opt_arg();
+            break;
+        case OPT_ENCRYPT:
             operation = SMIME_ENCRYPT;
-        else if (!strcmp(*args, &quot;-decrypt&quot;))
+            break;
+        case OPT_DECRYPT:
             operation = SMIME_DECRYPT;
-        else if (!strcmp(*args, &quot;-sign&quot;))
+            break;
+        case OPT_SIGN:
             operation = SMIME_SIGN;
-        else if (!strcmp(*args, &quot;-sign_receipt&quot;))
+            break;
+        case OPT_SIGN_RECEIPT:
             operation = SMIME_SIGN_RECEIPT;
-        else if (!strcmp(*args, &quot;-resign&quot;))
+            break;
+        case OPT_RESIGN:
             operation = SMIME_RESIGN;
-        else if (!strcmp(*args, &quot;-verify&quot;))
+            break;
+        case OPT_VERIFY:
             operation = SMIME_VERIFY;
-        else if (!strcmp(*args, &quot;-verify_retcode&quot;))
+            break;
+        case OPT_VERIFY_RETCODE:
             verify_retcode = 1;
-        else if (!strcmp(*args, &quot;-verify_receipt&quot;)) {
+            break;
+        case OPT_VERIFY_RECEIPT:
             operation = SMIME_VERIFY_RECEIPT;
-            if (!args[1])
-                goto argerr;
-            args++;
-            rctfile = *args;
-        } else if (!strcmp(*args, &quot;-cmsout&quot;))
+            rctfile = opt_arg();
+            break;
+        case OPT_CMSOUT:
             operation = SMIME_CMSOUT;
-        else if (!strcmp(*args, &quot;-data_out&quot;))
+            break;
+        case OPT_DATA_OUT:
             operation = SMIME_DATAOUT;
-        else if (!strcmp(*args, &quot;-data_create&quot;))
+            break;
+        case OPT_DATA_CREATE:
             operation = SMIME_DATA_CREATE;
-        else if (!strcmp(*args, &quot;-digest_verify&quot;))
+            break;
+        case OPT_DIGEST_VERIFY:
             operation = SMIME_DIGEST_VERIFY;
-        else if (!strcmp(*args, &quot;-digest_create&quot;))
+            break;
+        case OPT_DIGEST_CREATE:
             operation = SMIME_DIGEST_CREATE;
-        else if (!strcmp(*args, &quot;-compress&quot;))
+            break;
+        case OPT_COMPRESS:
             operation = SMIME_COMPRESS;
-        else if (!strcmp(*args, &quot;-uncompress&quot;))
+            break;
+        case OPT_UNCOMPRESS:
             operation = SMIME_UNCOMPRESS;
-        else if (!strcmp(*args, &quot;-EncryptedData_decrypt&quot;))
+            break;
+        case OPT_ED_DECRYPT:
             operation = SMIME_ENCRYPTED_DECRYPT;
-        else if (!strcmp(*args, &quot;-EncryptedData_encrypt&quot;))
+            break;
+        case OPT_ED_ENCRYPT:
             operation = SMIME_ENCRYPTED_ENCRYPT;
-# ifndef OPENSSL_NO_DES
-        else if (!strcmp(*args, &quot;-des3&quot;))
-            cipher = EVP_des_ede3_cbc();
-        else if (!strcmp(*args, &quot;-des&quot;))
-            cipher = EVP_des_cbc();
-        else if (!strcmp(*args, &quot;-des3-wrap&quot;))
-            wrap_cipher = EVP_des_ede3_wrap();
-# endif
-# ifndef OPENSSL_NO_SEED
-        else if (!strcmp(*args, &quot;-seed&quot;))
-            cipher = EVP_seed_cbc();
-# endif
-# ifndef OPENSSL_NO_RC2
-        else if (!strcmp(*args, &quot;-rc2-40&quot;))
-            cipher = EVP_rc2_40_cbc();
-        else if (!strcmp(*args, &quot;-rc2-128&quot;))
-            cipher = EVP_rc2_cbc();
-        else if (!strcmp(*args, &quot;-rc2-64&quot;))
-            cipher = EVP_rc2_64_cbc();
-# endif
-# ifndef OPENSSL_NO_AES
-        else if (!strcmp(*args, &quot;-aes128&quot;))
-            cipher = EVP_aes_128_cbc();
-        else if (!strcmp(*args, &quot;-aes192&quot;))
-            cipher = EVP_aes_192_cbc();
-        else if (!strcmp(*args, &quot;-aes256&quot;))
-            cipher = EVP_aes_256_cbc();
-        else if (!strcmp(*args, &quot;-aes128-wrap&quot;))
-            wrap_cipher = EVP_aes_128_wrap();
-        else if (!strcmp(*args, &quot;-aes192-wrap&quot;))
-            wrap_cipher = EVP_aes_192_wrap();
-        else if (!strcmp(*args, &quot;-aes256-wrap&quot;))
-            wrap_cipher = EVP_aes_256_wrap();
-# endif
-# ifndef OPENSSL_NO_CAMELLIA
-        else if (!strcmp(*args, &quot;-camellia128&quot;))
-            cipher = EVP_camellia_128_cbc();
-        else if (!strcmp(*args, &quot;-camellia192&quot;))
-            cipher = EVP_camellia_192_cbc();
-        else if (!strcmp(*args, &quot;-camellia256&quot;))
-            cipher = EVP_camellia_256_cbc();
-# endif
-        else if (!strcmp(*args, &quot;-debug_decrypt&quot;))
+            break;
+        case OPT_DEBUG_DECRYPT:
             flags |= CMS_DEBUG_DECRYPT;
-        else if (!strcmp(*args, &quot;-text&quot;))
+            break;
+        case OPT_TEXT:
             flags |= CMS_TEXT;
-        else if (!strcmp(*args, &quot;-asciicrlf&quot;))
+            break;
+        case OPT_ASCIICRLF:
             flags |= CMS_ASCIICRLF;
-        else if (!strcmp(*args, &quot;-nointern&quot;))
+            break;
+        case OPT_NOINTERN:
             flags |= CMS_NOINTERN;
-        else if (!strcmp(*args, &quot;-noverify&quot;)
-                 || !strcmp(*args, &quot;-no_signer_cert_verify&quot;))
+            break;
+        case OPT_NOVERIFY:
             flags |= CMS_NO_SIGNER_CERT_VERIFY;
-        else if (!strcmp(*args, &quot;-nocerts&quot;))
+            break;
+        case OPT_NOCERTS:
             flags |= CMS_NOCERTS;
-        else if (!strcmp(*args, &quot;-noattr&quot;))
+            break;
+        case OPT_NOATTR:
             flags |= CMS_NOATTR;
-        else if (!strcmp(*args, &quot;-nodetach&quot;))
+            break;
+        case OPT_NODETACH:
             flags &amp;= ~CMS_DETACHED;
-        else if (!strcmp(*args, &quot;-nosmimecap&quot;))
+            break;
+        case OPT_NOSMIMECAP:
             flags |= CMS_NOSMIMECAP;
-        else if (!strcmp(*args, &quot;-binary&quot;))
+            break;
+        case OPT_BINARY:
             flags |= CMS_BINARY;
-        else if (!strcmp(*args, &quot;-keyid&quot;))
+            break;
+        case OPT_KEYID:
             flags |= CMS_USE_KEYID;
-        else if (!strcmp(*args, &quot;-nosigs&quot;))
+            break;
+        case OPT_NOSIGS:
             flags |= CMS_NOSIGS;
-        else if (!strcmp(*args, &quot;-no_content_verify&quot;))
+            break;
+        case OPT_NO_CONTENT_VERIFY:
             flags |= CMS_NO_CONTENT_VERIFY;
-        else if (!strcmp(*args, &quot;-no_attr_verify&quot;))
+            break;
+        case OPT_NO_ATTR_VERIFY:
             flags |= CMS_NO_ATTR_VERIFY;
-        else if (!strcmp(*args, &quot;-stream&quot;))
+            break;
+        case OPT_INDEF:
             flags |= CMS_STREAM;
-        else if (!strcmp(*args, &quot;-indef&quot;))
-            flags |= CMS_STREAM;
-        else if (!strcmp(*args, &quot;-noindef&quot;))
+            break;
+        case OPT_NOINDEF:
             flags &amp;= ~CMS_STREAM;
-        else if (!strcmp(*args, &quot;-nooldmime&quot;))
+            break;
+        case OPT_NOOLDMIME:
             flags |= CMS_NOOLDMIMETYPE;
-        else if (!strcmp(*args, &quot;-crlfeol&quot;))
+            break;
+        case OPT_CRLFEOL:
             flags |= CMS_CRLFEOL;
-        else if (!strcmp(*args, &quot;-noout&quot;))
+            break;
+        case OPT_NOOUT:
             noout = 1;
-        else if (!strcmp(*args, &quot;-receipt_request_print&quot;))
+            break;
+        case OPT_RR_PRINT:
             rr_print = 1;
-        else if (!strcmp(*args, &quot;-receipt_request_all&quot;))
+            break;
+        case OPT_RR_ALL:
             rr_allorfirst = 0;
-        else if (!strcmp(*args, &quot;-receipt_request_first&quot;))
+            break;
+        case OPT_RR_FIRST:
             rr_allorfirst = 1;
-        else if (!strcmp(*args, &quot;-receipt_request_from&quot;)) {
-            if (!args[1])
-                goto argerr;
-            args++;
-            if (!rr_from)
-                rr_from = sk_OPENSSL_STRING_new_null();
-            sk_OPENSSL_STRING_push(rr_from, *args);
-        } else if (!strcmp(*args, &quot;-receipt_request_to&quot;)) {
-            if (!args[1])
-                goto argerr;
-            args++;
-            if (!rr_to)
-                rr_to = sk_OPENSSL_STRING_new_null();
-            sk_OPENSSL_STRING_push(rr_to, *args);
-        } else if (!strcmp(*args, &quot;-print&quot;)) {
-            noout = 1;
-            print = 1;
-        } else if (!strcmp(*args, &quot;-secretkey&quot;)) {
-            long ltmp;
-            if (!args[1])
-                goto argerr;
-            args++;
-            secret_key = string_to_hex(*args, &amp;ltmp);
-            if (!secret_key) {
-                BIO_printf(bio_err, &quot;Invalid key %s\n&quot;, *args);
-                goto argerr;
+            break;
+        case OPT_RCTFORM:
+            if (rctformat == FORMAT_SMIME)
+                rcms = SMIME_read_CMS(rctin, NULL);
+            else if (rctformat == FORMAT_PEM)
+                rcms = PEM_read_bio_CMS(rctin, NULL, NULL, NULL);
+            else if (rctformat == FORMAT_ASN1)
+                if (!opt_format(opt_arg(),
+                                OPT_FMT_PEMDER | OPT_FMT_SMIME, &amp;rctformat))
+                    goto opthelp;
+            break;
+        case OPT_CERTFILE:
+            certfile = opt_arg();
+            break;
+        case OPT_CAFILE:
+            CAfile = opt_arg();
+            break;
+        case OPT_CAPATH:
+            CApath = opt_arg();
+            break;
+        case OPT_IN:
+            infile = opt_arg();
+            break;
+        case OPT_CONTENT:
+            contfile = opt_arg();
+            break;
+        case OPT_RR_FROM:
+            if (rr_from == NULL
+                &amp;&amp; (rr_from = sk_OPENSSL_STRING_new_null()) == NULL)
+                goto end;
+            sk_OPENSSL_STRING_push(rr_from, opt_arg());
+            break;
+        case OPT_RR_TO:
+            if (rr_to == NULL
+                &amp;&amp; (rr_to = sk_OPENSSL_STRING_new_null()) == NULL)
+                goto end;
+            sk_OPENSSL_STRING_push(rr_to, opt_arg());
+            break;
+        case OPT_PRINT:
+            noout = print = 1;
+            break;
+        case OPT_SECRETKEY:
+            secret_key = string_to_hex(opt_arg(), &amp;ltmp);
+            if (secret_key == NULL) {
+                BIO_printf(bio_err, &quot;Invalid key %s\n&quot;, opt_arg());
+                goto end;
             }
             secret_keylen = (size_t)ltmp;
-        } else if (!strcmp(*args, &quot;-secretkeyid&quot;)) {
-            long ltmp;
-            if (!args[1])
-                goto argerr;
-            args++;
-            secret_keyid = string_to_hex(*args, &amp;ltmp);
-            if (!secret_keyid) {
-                BIO_printf(bio_err, &quot;Invalid id %s\n&quot;, *args);
-                goto argerr;
+            break;
+        case OPT_SECRETKEYID:
+            secret_keyid = string_to_hex(opt_arg(), &amp;ltmp);
+            if (secret_keyid == NULL) {
+                BIO_printf(bio_err, &quot;Invalid id %s\n&quot;, opt_arg());
+                goto opthelp;
             }
             secret_keyidlen = (size_t)ltmp;
-        } else if (!strcmp(*args, &quot;-pwri_password&quot;)) {
-            if (!args[1])
-                goto argerr;
-            args++;
-            pwri_pass = (unsigned char *)*args;
-        } else if (!strcmp(*args, &quot;-econtent_type&quot;)) {
-            if (!args[1])
-                goto argerr;
-            args++;
-            econtent_type = OBJ_txt2obj(*args, 0);
-            if (!econtent_type) {
-                BIO_printf(bio_err, &quot;Invalid OID %s\n&quot;, *args);
-                goto argerr;
+            break;
+        case OPT_PWRI_PASSWORD:
+            pwri_pass = (unsigned char *)opt_arg();
+            break;
+        case OPT_ECONTENT_TYPE:
+            econtent_type = OBJ_txt2obj(opt_arg(), 0);
+            if (econtent_type == NULL) {
+                BIO_printf(bio_err, &quot;Invalid OID %s\n&quot;, opt_arg());
+                goto opthelp;
             }
-        } else if (!strcmp(*args, &quot;-rand&quot;)) {
-            if (!args[1])
-                goto argerr;
-            args++;
-            inrand = *args;
+            break;
+        case OPT_RAND:
+            inrand = opt_arg();
             need_rand = 1;
-        }
-# ifndef OPENSSL_NO_ENGINE
-        else if (!strcmp(*args, &quot;-engine&quot;)) {
-            if (!args[1])
-                goto argerr;
-            engine = *++args;
-        }
-# endif
-        else if (!strcmp(*args, &quot;-passin&quot;)) {
-            if (!args[1])
-                goto argerr;
-            passargin = *++args;
-        } else if (!strcmp(*args, &quot;-to&quot;)) {
-            if (!args[1])
-                goto argerr;
-            to = *++args;
-        } else if (!strcmp(*args, &quot;-from&quot;)) {
-            if (!args[1])
-                goto argerr;
-            from = *++args;
-        } else if (!strcmp(*args, &quot;-subject&quot;)) {
-            if (!args[1])
-                goto argerr;
-            subject = *++args;
-        } else if (!strcmp(*args, &quot;-signer&quot;)) {
-            if (!args[1])
-                goto argerr;
+            break;
+        case OPT_ENGINE:
+            engine = opt_arg();
+            break;
+        case OPT_PASSIN:
+            passinarg = opt_arg();
+            break;
+        case OPT_TO:
+            to = opt_arg();
+            break;
+        case OPT_FROM:
+            from = opt_arg();
+            break;
+        case OPT_SUBJECT:
+            subject = opt_arg();
+            break;
+        case OPT_CERTSOUT:
+            certsoutfile = opt_arg();
+            break;
+        case OPT_MD:
+            if (!opt_md(opt_arg(), &amp;sign_md))
+                goto end;
+            break;
+        case OPT_SIGNER:
             /* If previous -signer argument add signer to list */
-
             if (signerfile) {
-                if (!sksigners)
-                    sksigners = sk_OPENSSL_STRING_new_null();
+                if (sksigners == NULL
+                    &amp;&amp; (sksigners = sk_OPENSSL_STRING_new_null()) == NULL)
+                    goto end;
                 sk_OPENSSL_STRING_push(sksigners, signerfile);
-                if (!keyfile)
+                if (keyfile == NULL)
                     keyfile = signerfile;
-                if (!skkeys)
-                    skkeys = sk_OPENSSL_STRING_new_null();
+                if (skkeys == NULL
+                    &amp;&amp; (skkeys = sk_OPENSSL_STRING_new_null()) == NULL)
+                    goto end;
                 sk_OPENSSL_STRING_push(skkeys, keyfile);
                 keyfile = NULL;
             }
-            signerfile = *++args;
-        } else if (!strcmp(*args, &quot;-recip&quot;)) {
-            if (!args[1])
-                goto argerr;
-            if (operation == SMIME_ENCRYPT) {
-                if (!encerts)
-                    encerts = sk_X509_new_null();
-                cert = load_cert(bio_err, *++args, FORMAT_PEM,
-                                 NULL, e, &quot;recipient certificate file&quot;);
-                if (!cert)
-                    goto end;
-                sk_X509_push(encerts, cert);
-                cert = NULL;
-            } else
-                recipfile = *++args;
-        } else if (!strcmp(*args, &quot;-certsout&quot;)) {
-            if (!args[1])
-                goto argerr;
-            certsoutfile = *++args;
-        } else if (!strcmp(*args, &quot;-md&quot;)) {
-            if (!args[1])
-                goto argerr;
-            sign_md = EVP_get_digestbyname(*++args);
-            if (sign_md == NULL) {
-                BIO_printf(bio_err, &quot;Unknown digest %s\n&quot;, *args);
-                goto argerr;
-            }
-        } else if (!strcmp(*args, &quot;-inkey&quot;)) {
-            if (!args[1])
-                goto argerr;
+            signerfile = opt_arg();
+            break;
+        case OPT_INKEY:
             /* If previous -inkey arument add signer to list */
             if (keyfile) {
-                if (!signerfile) {
+                if (signerfile == NULL) {
                     BIO_puts(bio_err, &quot;Illegal -inkey without -signer\n&quot;);
-                    goto argerr;
+                    goto end;
                 }
-                if (!sksigners)
-                    sksigners = sk_OPENSSL_STRING_new_null();
+                if (sksigners == NULL
+                    &amp;&amp; (sksigners = sk_OPENSSL_STRING_new_null()) == NULL)
+                    goto end;
                 sk_OPENSSL_STRING_push(sksigners, signerfile);
                 signerfile = NULL;
-                if (!skkeys)
-                    skkeys = sk_OPENSSL_STRING_new_null();
+                if (skkeys == NULL
+                    &amp;&amp; (skkeys = sk_OPENSSL_STRING_new_null()) == NULL)
+                    goto end;
                 sk_OPENSSL_STRING_push(skkeys, keyfile);
             }
-            keyfile = *++args;
-        } else if (!strcmp(*args, &quot;-keyform&quot;)) {
-            if (!args[1])
-                goto argerr;
-            keyform = str2fmt(*++args);
-        } else if (!strcmp(*args, &quot;-keyopt&quot;)) {
-            int keyidx = -1;
-            if (!args[1])
-                goto argerr;
+            keyfile = opt_arg();
+            break;
+        case OPT_KEYFORM:
+            if (!opt_format(opt_arg(), OPT_FMT_ANY, &amp;keyform))
+                goto opthelp;
+            break;
+        case OPT_RECIP:
+            if (operation == SMIME_ENCRYPT) {
+                if (encerts == NULL &amp;&amp; (encerts = sk_X509_new_null()) == NULL)
+                    goto end;
+                cert = load_cert(opt_arg(), FORMAT_PEM, NULL, e,
+                                 &quot;recipient certificate file&quot;);
+                if (cert == NULL)
+                    goto end;
+                sk_X509_push(encerts, cert);
+                cert = NULL;
+            } else
+                recipfile = opt_arg();
+            break;
+        case OPT_CIPHER:
+            if (!opt_cipher(opt_unknown(), &amp;cipher))
+                goto end;
+            break;
+        case OPT_KEYOPT:
+            keyidx = -1;
             if (operation == SMIME_ENCRYPT) {
                 if (encerts)
                     keyidx += sk_X509_num(encerts);
@@ -460,17 +566,18 @@ int MAIN(int argc, char **argv)
             }
             if (keyidx &lt; 0) {
                 BIO_printf(bio_err, &quot;No key specified\n&quot;);
-                goto argerr;
+                goto opthelp;
             }
             if (key_param == NULL || key_param-&gt;idx != keyidx) {
                 cms_key_param *nparam;
                 nparam = OPENSSL_malloc(sizeof(cms_key_param));
                 if (!nparam) {
                     BIO_printf(bio_err, &quot;Out of memory\n&quot;);
-                    goto argerr;
+                    goto end;
                 }
                 nparam-&gt;idx = keyidx;
-                nparam-&gt;param = sk_OPENSSL_STRING_new_null();
+                if ((nparam-&gt;param = sk_OPENSSL_STRING_new_null()) == NULL)
+                    goto end;
                 nparam-&gt;next = NULL;
                 if (key_first == NULL)
                     key_first = nparam;
@@ -478,83 +585,68 @@ int MAIN(int argc, char **argv)
                     key_param-&gt;next = nparam;
                 key_param = nparam;
             }
-            sk_OPENSSL_STRING_push(key_param-&gt;param, *++args);
-        } else if (!strcmp(*args, &quot;-rctform&quot;)) {
-            if (!args[1])
-                goto argerr;
-            rctformat = str2fmt(*++args);
-        } else if (!strcmp(*args, &quot;-certfile&quot;)) {
-            if (!args[1])
-                goto argerr;
-            certfile = *++args;
-        } else if (!strcmp(*args, &quot;-CAfile&quot;)) {
-            if (!args[1])
-                goto argerr;
-            CAfile = *++args;
-        } else if (!strcmp(*args, &quot;-CApath&quot;)) {
-            if (!args[1])
-                goto argerr;
-            CApath = *++args;
-        } else if (!strcmp(*args, &quot;-in&quot;)) {
-            if (!args[1])
-                goto argerr;
-            infile = *++args;
-        } else if (!strcmp(*args, &quot;-inform&quot;)) {
-            if (!args[1])
-                goto argerr;
-            informat = str2fmt(*++args);
-        } else if (!strcmp(*args, &quot;-outform&quot;)) {
-            if (!args[1])
-                goto argerr;
-            outformat = str2fmt(*++args);
-        } else if (!strcmp(*args, &quot;-out&quot;)) {
-            if (!args[1])
-                goto argerr;
-            outfile = *++args;
-        } else if (!strcmp(*args, &quot;-content&quot;)) {
-            if (!args[1])
-                goto argerr;
-            contfile = *++args;
-        } else if (args_verify(&amp;args, NULL, &amp;badarg, bio_err, &amp;vpm))
-            continue;
-        else if ((cipher = EVP_get_cipherbyname(*args + 1)) == NULL)
-            badarg = 1;
-        args++;
+            sk_OPENSSL_STRING_push(key_param-&gt;param, opt_arg());
+            break;
+        case OPT_V_CASES:
+            if (!opt_verify(o, vpm))
+                goto end;
+            vpmtouched++;
+            break;
+# ifndef OPENSSL_NO_DES
+        case OPT_3DES_WRAP:
+            wrap_cipher = EVP_des_ede3_wrap();
+            break;
+# endif
+# ifndef OPENSSL_NO_AES
+        case OPT_AES128_WRAP:
+            wrap_cipher = EVP_aes_128_wrap();
+            break;
+        case OPT_AES192_WRAP:
+            wrap_cipher = EVP_aes_192_wrap();
+            break;
+        case OPT_AES256_WRAP:
+            wrap_cipher = EVP_aes_256_wrap();
+            break;
+# endif
+        }
     }
+    argc = opt_num_rest();
+    argv = opt_rest();
 
     if (((rr_allorfirst != -1) || rr_from) &amp;&amp; !rr_to) {
         BIO_puts(bio_err, &quot;No Signed Receipts Recipients\n&quot;);
-        goto argerr;
+        goto opthelp;
     }
 
     if (!(operation &amp; SMIME_SIGNERS) &amp;&amp; (rr_to || rr_from)) {
         BIO_puts(bio_err, &quot;Signed receipts only allowed with -sign\n&quot;);
-        goto argerr;
+        goto opthelp;
     }
     if (!(operation &amp; SMIME_SIGNERS) &amp;&amp; (skkeys || sksigners)) {
         BIO_puts(bio_err, &quot;Multiple signers or keys not allowed\n&quot;);
-        goto argerr;
+        goto opthelp;
     }
 
     if (operation &amp; SMIME_SIGNERS) {
         if (keyfile &amp;&amp; !signerfile) {
             BIO_puts(bio_err, &quot;Illegal -inkey without -signer\n&quot;);
-            goto argerr;
+            goto opthelp;
         }
         /* Check to see if any final signer needs to be appended */
         if (signerfile) {
-            if (!sksigners)
-                sksigners = sk_OPENSSL_STRING_new_null();
+            if (!sksigners
+                &amp;&amp; (sksigners = sk_OPENSSL_STRING_new_null()) == NULL)
+                goto end;
             sk_OPENSSL_STRING_push(sksigners, signerfile);
-            if (!skkeys)
-                skkeys = sk_OPENSSL_STRING_new_null();
+            if (!skkeys &amp;&amp; (skkeys = sk_OPENSSL_STRING_new_null()) == NULL)
+                goto end;
             if (!keyfile)
                 keyfile = signerfile;
             sk_OPENSSL_STRING_push(skkeys, keyfile);
         }
         if (!sksigners) {
             BIO_printf(bio_err, &quot;No signer certificate specified\n&quot;);
-            badarg = 1;
+            goto opthelp;
         }
         signerfile = NULL;
         keyfile = NULL;
@@ -565,121 +657,28 @@ int MAIN(int argc, char **argv)
         if (!recipfile &amp;&amp; !keyfile &amp;&amp; !secret_key &amp;&amp; !pwri_pass) {
             BIO_printf(bio_err,
                        &quot;No recipient certificate or key specified\n&quot;);
-            badarg = 1;
+            goto opthelp;
         }
     } else if (operation == SMIME_ENCRYPT) {
-        if (!*args &amp;&amp; !secret_key &amp;&amp; !pwri_pass &amp;&amp; !encerts) {
+        if (*argv == NULL &amp;&amp; !secret_key &amp;&amp; !pwri_pass &amp;&amp; !encerts) {
             BIO_printf(bio_err, &quot;No recipient(s) certificate(s) specified\n&quot;);
-            badarg = 1;
+            goto opthelp;
         }
         need_rand = 1;
     } else if (!operation)
-        badarg = 1;
-
-    if (badarg) {
- argerr:
-        BIO_printf(bio_err, &quot;Usage cms [options] cert.pem ...\n&quot;);
-        BIO_printf(bio_err, &quot;where options are\n&quot;);
-        BIO_printf(bio_err, &quot;-encrypt       encrypt message\n&quot;);
-        BIO_printf(bio_err, &quot;-decrypt       decrypt encrypted message\n&quot;);
-        BIO_printf(bio_err, &quot;-sign          sign message\n&quot;);
-        BIO_printf(bio_err, &quot;-verify        verify signed message\n&quot;);
-        BIO_printf(bio_err, &quot;-cmsout        output CMS structure\n&quot;);
-# ifndef OPENSSL_NO_DES
-        BIO_printf(bio_err, &quot;-des3          encrypt with triple DES\n&quot;);
-        BIO_printf(bio_err, &quot;-des           encrypt with DES\n&quot;);
-# endif
-# ifndef OPENSSL_NO_SEED
-        BIO_printf(bio_err, &quot;-seed          encrypt with SEED\n&quot;);
-# endif
-# ifndef OPENSSL_NO_RC2
-        BIO_printf(bio_err, &quot;-rc2-40        encrypt with RC2-40 (default)\n&quot;);
-        BIO_printf(bio_err, &quot;-rc2-64        encrypt with RC2-64\n&quot;);
-        BIO_printf(bio_err, &quot;-rc2-128       encrypt with RC2-128\n&quot;);
-# endif
-# ifndef OPENSSL_NO_AES
-        BIO_printf(bio_err, &quot;-aes128, -aes192, -aes256\n&quot;);
-        BIO_printf(bio_err,
-                   &quot;               encrypt PEM output with cbc aes\n&quot;);
-# endif
-# ifndef OPENSSL_NO_CAMELLIA
-        BIO_printf(bio_err, &quot;-camellia128, -camellia192, -camellia256\n&quot;);
-        BIO_printf(bio_err,
-                   &quot;               encrypt PEM output with cbc camellia\n&quot;);
-# endif
-        BIO_printf(bio_err,
-                   &quot;-nointern      don't search certificates in message for signer\n&quot;);
-        BIO_printf(bio_err,
-                   &quot;-nosigs        don't verify message signature\n&quot;);
-        BIO_printf(bio_err,
-                   &quot;-noverify      don't verify signers certificate\n&quot;);
-        BIO_printf(bio_err,
-                   &quot;-nocerts       don't include signers certificate when signing\n&quot;);
-        BIO_printf(bio_err, &quot;-nodetach      use opaque signing\n&quot;);
-        BIO_printf(bio_err,
-                   &quot;-noattr        don't include any signed attributes\n&quot;);
-        BIO_printf(bio_err,
-                   &quot;-binary        don't translate message to text\n&quot;);
-        BIO_printf(bio_err, &quot;-certfile file other certificates file\n&quot;);
-        BIO_printf(bio_err, &quot;-certsout file certificate output file\n&quot;);
-        BIO_printf(bio_err, &quot;-signer file   signer certificate file\n&quot;);
-        BIO_printf(bio_err,
-                   &quot;-recip  file   recipient certificate file for decryption\n&quot;);
-        BIO_printf(bio_err, &quot;-keyid         use subject key identifier\n&quot;);
-        BIO_printf(bio_err, &quot;-in file       input file\n&quot;);
-        BIO_printf(bio_err,
-                   &quot;-inform arg    input format SMIME (default), PEM or DER\n&quot;);
-        BIO_printf(bio_err,
-                   &quot;-inkey file    input private key (if not signer or recipient)\n&quot;);
-        BIO_printf(bio_err,
-                   &quot;-keyform arg   input private key format (PEM or ENGINE)\n&quot;);
-        BIO_printf(bio_err, &quot;-keyopt nm:v   set public key parameters\n&quot;);
-        BIO_printf(bio_err, &quot;-out file      output file\n&quot;);
-        BIO_printf(bio_err,
-                   &quot;-outform arg   output format SMIME (default), PEM or DER\n&quot;);
-        BIO_printf(bio_err,
-                   &quot;-content file  supply or override content for detached signature\n&quot;);
-        BIO_printf(bio_err, &quot;-to addr       to address\n&quot;);
-        BIO_printf(bio_err, &quot;-from ad       from address\n&quot;);
-        BIO_printf(bio_err, &quot;-subject s     subject\n&quot;);
-        BIO_printf(bio_err,
-                   &quot;-text          include or delete text MIME headers\n&quot;);
-        BIO_printf(bio_err,
-                   &quot;-CApath dir    trusted certificates directory\n&quot;);
-        BIO_printf(bio_err, &quot;-CAfile file   trusted certificates file\n&quot;);
-        BIO_printf(bio_err,
-                   &quot;-trusted_first use locally trusted certificates first when building trust chain\n&quot;);
-        BIO_printf(bio_err,
-                   &quot;-no_alt_chains only ever use the first certificate chain found\n&quot;);
-        BIO_printf(bio_err,
-                   &quot;-crl_check     check revocation status of signer's certificate using CRLs\n&quot;);
-        BIO_printf(bio_err,
-                   &quot;-crl_check_all check revocation status of signer's certificate chain using CRLs\n&quot;);
-# ifndef OPENSSL_NO_ENGINE
-        BIO_printf(bio_err,
-                   &quot;-engine e      use engine e, possibly a hardware device.\n&quot;);
-# endif
-        BIO_printf(bio_err, &quot;-passin arg    input file pass phrase source\n&quot;);
-        BIO_printf(bio_err, &quot;-rand file%cfile%c...\n&quot;, LIST_SEPARATOR_CHAR,
-                   LIST_SEPARATOR_CHAR);
-        BIO_printf(bio_err,
-                   &quot;               load the file (or the files in the directory) into\n&quot;);
-        BIO_printf(bio_err, &quot;               the random number generator\n&quot;);
-        BIO_printf(bio_err,
-                   &quot;cert.pem       recipient certificate(s) for encryption\n&quot;);
-        goto end;
-    }
+        goto opthelp;
+
 # ifndef OPENSSL_NO_ENGINE
-    e = setup_engine(bio_err, engine, 0);
+    e = setup_engine(engine, 0);
 # endif
 
-    if (!app_passwd(bio_err, passargin, NULL, &amp;passin, NULL)) {
+    if (!app_passwd(passinarg, NULL, &amp;passin, NULL)) {
         BIO_printf(bio_err, &quot;Error getting password\n&quot;);
         goto end;
     }
 
     if (need_rand) {
-        app_RAND_load_file(NULL, bio_err, (inrand != NULL));
+        app_RAND_load_file(NULL, (inrand != NULL));
         if (inrand != NULL)
             BIO_printf(bio_err, &quot;%ld semi-random bytes loaded\n&quot;,
                        app_RAND_load_files(inrand));
@@ -721,20 +720,21 @@ int MAIN(int argc, char **argv)
             goto end;
         }
 
-        if (*args &amp;&amp; !encerts)
-            encerts = sk_X509_new_null();
-        while (*args) {
-            if (!(cert = load_cert(bio_err, *args, FORMAT_PEM,
+        if (*argv &amp;&amp; !encerts)
+            if ((encerts = sk_X509_new_null()) == NULL)
+                goto end;
+        while (*argv) {
+            if (!(cert = load_cert(*argv, FORMAT_PEM,
                                    NULL, e, &quot;recipient certificate file&quot;)))
                 goto end;
             sk_X509_push(encerts, cert);
             cert = NULL;
-            args++;
+            argv++;
         }
     }
 
     if (certfile) {
-        if (!(other = load_certs(bio_err, certfile, FORMAT_PEM, NULL,
+        if (!(other = load_certs(certfile, FORMAT_PEM, NULL,
                                  e, &quot;certificate file&quot;))) {
             ERR_print_errors(bio_err);
             goto end;
@@ -742,7 +742,7 @@ int MAIN(int argc, char **argv)
     }
 
     if (recipfile &amp;&amp; (operation == SMIME_DECRYPT)) {
-        if (!(recip = load_cert(bio_err, recipfile, FORMAT_PEM, NULL,
+        if (!(recip = load_cert(recipfile, FORMAT_PEM, NULL,
                                 e, &quot;recipient certificate file&quot;))) {
             ERR_print_errors(bio_err);
             goto end;
@@ -750,7 +750,7 @@ int MAIN(int argc, char **argv)
     }
 
     if (operation == SMIME_SIGN_RECEIPT) {
-        if (!(signer = load_cert(bio_err, signerfile, FORMAT_PEM, NULL,
+        if (!(signer = load_cert(signerfile, FORMAT_PEM, NULL,
                                  e, &quot;receipt signer certificate file&quot;))) {
             ERR_print_errors(bio_err);
             goto end;
@@ -767,19 +767,14 @@ int MAIN(int argc, char **argv)
         keyfile = NULL;
 
     if (keyfile) {
-        key = load_key(bio_err, keyfile, keyform, 0, passin, e,
-                       &quot;signing key file&quot;);
+        key = load_key(keyfile, keyform, 0, passin, e, &quot;signing key file&quot;);
         if (!key)
             goto end;
     }
 
-    if (infile) {
-        if (!(in = BIO_new_file(infile, inmode))) {
-            BIO_printf(bio_err, &quot;Can't open input file %s\n&quot;, infile);
-            goto end;
-        }
-    } else
-        in = BIO_new_fp(stdin, BIO_NOCLOSE);
+    in = bio_open_default(infile, inmode);
+    if (in == NULL)
+        goto end;
 
     if (operation &amp; SMIME_IP) {
         if (informat == FORMAT_SMIME)
@@ -841,26 +836,15 @@ int MAIN(int argc, char **argv)
         }
     }
 
-    if (outfile) {
-        if (!(out = BIO_new_file(outfile, outmode))) {
-            BIO_printf(bio_err, &quot;Can't open output file %s\n&quot;, outfile);
-            goto end;
-        }
-    } else {
-        out = BIO_new_fp(stdout, BIO_NOCLOSE);
-# ifdef OPENSSL_SYS_VMS
-        {
-            BIO *tmpbio = BIO_new(BIO_f_linebuffer());
-            out = BIO_push(tmpbio, out);
-        }
-# endif
-    }
+    out = bio_open_default(outfile, outmode);
+    if (out == NULL)
+        goto end;
 
     if ((operation == SMIME_VERIFY) || (operation == SMIME_VERIFY_RECEIPT)) {
-        if (!(store = setup_verify(bio_err, CAfile, CApath)))
+        if (!(store = setup_verify(CAfile, CApath)))
             goto end;
         X509_STORE_set_verify_cb(store, cms_cb);
-        if (vpm)
+        if (vpmtouched)
             X509_STORE_set1_param(store, vpm);
     }
 
@@ -983,12 +967,11 @@ int MAIN(int argc, char **argv)
             signerfile = sk_OPENSSL_STRING_value(sksigners, i);
             keyfile = sk_OPENSSL_STRING_value(skkeys, i);
 
-            signer = load_cert(bio_err, signerfile, FORMAT_PEM, NULL,
+            signer = load_cert(signerfile, FORMAT_PEM, NULL,
                                e, &quot;signer certificate&quot;);
             if (!signer)
                 goto end;
-            key = load_key(bio_err, keyfile, keyform, 0, passin, e,
-                           &quot;signing key file&quot;);
+            key = load_key(keyfile, keyform, 0, passin, e, &quot;signing key file&quot;);
             if (!key)
                 goto end;
             for (kparam = key_first; kparam; kparam = kparam-&gt;next) {
@@ -1137,11 +1120,10 @@ int MAIN(int argc, char **argv)
     if (ret)
         ERR_print_errors(bio_err);
     if (need_rand)
-        app_RAND_write_file(NULL, bio_err);
+        app_RAND_write_file(NULL);
     sk_X509_pop_free(encerts, X509_free);
     sk_X509_pop_free(other, X509_free);
-    if (vpm)
-        X509_VERIFY_PARAM_free(vpm);
+    X509_VERIFY_PARAM_free(vpm);
     if (sksigners)
         sk_OPENSSL_STRING_free(sksigners);
     if (skkeys)
@@ -1211,7 +1193,8 @@ static int cms_cb(int ok, X509_STORE_CTX *ctx)
         &amp;&amp; ((error != X509_V_OK) || (ok != 2)))
         return ok;
 
-    policies_print(NULL, ctx);
+    /* Should be bio_err? */
+    policies_print(bio_out, ctx);
 
     return ok;
 
diff --git a/apps/crl.c b/apps/crl.c
index 6819faa..b8c592c 100644
--- a/apps/crl.c
+++ b/apps/crl.c
@@ -1,4 +1,3 @@
-/* apps/crl.c */
 /* Copyright (C) 1995-1998 Eric Young (<A HREF="../../../mailman/listinfo/openssl-commits.html">eay at cryptsoft.com</A>)
  * All rights reserved.
  *
@@ -66,199 +65,168 @@
 #include &lt;openssl/x509v3.h&gt;
 #include &lt;openssl/pem.h&gt;
 
-#undef PROG
-#define PROG    crl_main
+typedef enum OPTION_choice {
+    OPT_ERR = -1, OPT_EOF = 0, OPT_HELP,
+    OPT_INFORM, OPT_IN, OPT_OUTFORM, OPT_OUT, OPT_KEYFORM, OPT_KEY,
+    OPT_ISSUER, OPT_LASTUPDATE, OPT_NEXTUPDATE, OPT_FINGERPRINT,
+    OPT_CRLNUMBER, OPT_BADSIG, OPT_GENDELTA, OPT_CAPATH, OPT_CAFILE,
+    OPT_VERIFY, OPT_TEXT, OPT_HASH, OPT_HASH_OLD, OPT_NOOUT,
+    OPT_NAMEOPT, OPT_MD
+} OPTION_CHOICE;
 
-#undef POSTFIX
-#define POSTFIX &quot;.rvk&quot;
-
-static const char *crl_usage[] = {
-    &quot;usage: crl args\n&quot;,
-    &quot;\n&quot;,
-    &quot; -inform arg     - input format - default PEM (DER or PEM)\n&quot;,
-    &quot; -outform arg    - output format - default PEM\n&quot;,
-    &quot; -text           - print out a text format version\n&quot;,
-    &quot; -in arg         - input file - default stdin\n&quot;,
-    &quot; -out arg        - output file - default stdout\n&quot;,
-    &quot; -hash           - print hash value\n&quot;,
+OPTIONS crl_options[] = {
+    {&quot;help&quot;, OPT_HELP, '-', &quot;Display this summary&quot;},
+    {&quot;inform&quot;, OPT_INFORM, 'F', &quot;Input format; default PEM&quot;},
+    {&quot;in&quot;, OPT_IN, '&lt;', &quot;Input file - default stdin&quot;},
+    {&quot;outform&quot;, OPT_OUTFORM, 'F', &quot;Output format - default PEM&quot;},
+    {&quot;out&quot;, OPT_OUT, '&gt;', &quot;output file - default stdout&quot;},
+    {&quot;keyform&quot;, OPT_KEYFORM, 'F'},
+    {&quot;key&quot;, OPT_KEY, '&lt;'},
+    {&quot;issuer&quot;, OPT_ISSUER, '-', &quot;Print issuer DN&quot;},
+    {&quot;lastupdate&quot;, OPT_LASTUPDATE, '-', &quot;Set lastUpdate field&quot;},
+    {&quot;nextupdate&quot;, OPT_NEXTUPDATE, '-', &quot;Set nextUpdate field&quot;},
+    {&quot;noout&quot;, OPT_NOOUT, '-', &quot;No CRL output&quot;},
+    {&quot;fingerprint&quot;, OPT_FINGERPRINT, '-', &quot;Print the crl fingerprint&quot;},
+    {&quot;crlnumber&quot;, OPT_CRLNUMBER, '-', &quot;Print CRL number&quot;},
+    {&quot;badsig&quot;, OPT_BADSIG, '-'},
+    {&quot;gendelta&quot;, OPT_GENDELTA, '&lt;'},
+    {&quot;CApath&quot;, OPT_CAPATH, '/', &quot;Verify CRL using certificates in dir&quot;},
+    {&quot;CAfile&quot;, OPT_CAFILE, '&lt;', &quot;Verify CRL using certificates in file name&quot;},
+    {&quot;verify&quot;, OPT_VERIFY, '-'},
+    {&quot;text&quot;, OPT_TEXT, '-', &quot;Print out a text format version&quot;},
+    {&quot;hash&quot;, OPT_HASH, '-', &quot;Print hash value&quot;},
 #ifndef OPENSSL_NO_MD5
-    &quot; -hash_old       - print old-style (MD5) hash value\n&quot;,
+    {&quot;hash_old&quot;, OPT_HASH_OLD, '-', &quot;Print old-style (MD5) hash value&quot;},
 #endif
-    &quot; -fingerprint    - print the crl fingerprint\n&quot;,
-    &quot; -issuer         - print issuer DN\n&quot;,
-    &quot; -lastupdate     - lastUpdate field\n&quot;,
-    &quot; -nextupdate     - nextUpdate field\n&quot;,
-    &quot; -crlnumber      - print CRL number\n&quot;,
-    &quot; -noout          - no CRL output\n&quot;,
-    &quot; -CAfile  name   - verify CRL using certificates in file \&quot;name\&quot;\n&quot;,
-    &quot; -CApath  dir    - verify CRL using certificates in \&quot;dir\&quot;\n&quot;,
-    &quot; -nameopt arg    - various certificate name options\n&quot;,
-    NULL
+    {&quot;nameopt&quot;, OPT_NAMEOPT, 's', &quot;Various certificate name options&quot;},
+    {&quot;&quot;, OPT_MD, '-', &quot;Any supported digest&quot;},
+    {NULL}
 };
 
-static BIO *bio_out = NULL;
-
-int MAIN(int, char **);
-
-int MAIN(int argc, char **argv)
+int crl_main(int argc, char **argv)
 {
-    unsigned long nmflag = 0;
     X509_CRL *x = NULL;
-    char *CAfile = NULL, *CApath = NULL;
-    int ret = 1, i, num, badops = 0, badsig = 0;
     BIO *out = NULL;
-    int informat, outformat, keyformat;
-    char *infile = NULL, *outfile = NULL, *crldiff = NULL, *keyfile = NULL;
-    int hash = 0, issuer = 0, lastupdate = 0, nextupdate = 0, noout =
-        0, text = 0;
-#ifndef OPENSSL_NO_MD5
-    int hash_old = 0;
-#endif
-    int fingerprint = 0, crlnumber = 0;
-    const char **pp;
     X509_STORE *store = NULL;
     X509_STORE_CTX ctx;
     X509_LOOKUP *lookup = NULL;
     X509_OBJECT xobj;
     EVP_PKEY *pkey;
-    int do_ver = 0;
-    const EVP_MD *md_alg, *digest = EVP_sha1();
-
-    apps_startup();
-
-    if (bio_err == NULL)
-        if ((bio_err = BIO_new(BIO_s_file())) != NULL)
-            BIO_set_fp(bio_err, stderr, BIO_NOCLOSE | BIO_FP_TEXT);
-
-    if (!load_config(bio_err, NULL))
-        goto end;
-
-    if (bio_out == NULL)
-        if ((bio_out = BIO_new(BIO_s_file())) != NULL) {
-            BIO_set_fp(bio_out, stdout, BIO_NOCLOSE);
-#ifdef OPENSSL_SYS_VMS
-            {
-                BIO *tmpbio = BIO_new(BIO_f_linebuffer());
-                bio_out = BIO_push(tmpbio, bio_out);
-            }
+    const EVP_MD *digest = EVP_sha1();
+    unsigned long nmflag = 0;
+    char *infile = NULL, *outfile = NULL, *crldiff = NULL, *keyfile = NULL;
+    char *CAfile = NULL, *CApath = NULL, *prog;
+    OPTION_CHOICE o;
+    int hash = 0, issuer = 0, lastupdate = 0, nextupdate = 0, noout =
+        0, text = 0;
+    int informat = FORMAT_PEM, outformat = FORMAT_PEM, keyformat = FORMAT_PEM;
+    int ret = 1, num = 0, badsig = 0, fingerprint = 0, crlnumber =
+        0, i, do_ver = 0;
+#ifndef OPENSSL_NO_MD5
+    int hash_old = 0;
 #endif
-        }
-
-    informat = FORMAT_PEM;
-    outformat = FORMAT_PEM;
-    keyformat = FORMAT_PEM;
 
-    argc--;
-    argv++;
-    num = 0;
-    while (argc &gt;= 1) {
-        if (strcmp(*argv, &quot;-inform&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            informat = str2fmt(*(++argv));
-        } else if (strcmp(*argv, &quot;-outform&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            outformat = str2fmt(*(++argv));
-        } else if (strcmp(*argv, &quot;-in&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            infile = *(++argv);
-        } else if (strcmp(*argv, &quot;-gendelta&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            crldiff = *(++argv);
-        } else if (strcmp(*argv, &quot;-key&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            keyfile = *(++argv);
-        } else if (strcmp(*argv, &quot;-keyform&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            keyformat = str2fmt(*(++argv));
-        } else if (strcmp(*argv, &quot;-out&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            outfile = *(++argv);
-        } else if (strcmp(*argv, &quot;-CApath&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            CApath = *(++argv);
-            do_ver = 1;
-        } else if (strcmp(*argv, &quot;-CAfile&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            CAfile = *(++argv);
+    prog = opt_init(argc, argv, crl_options);
+    while ((o = opt_next()) != OPT_EOF) {
+        switch (o) {
+        case OPT_EOF:
+        case OPT_ERR:
+ opthelp:
+            BIO_printf(bio_err, &quot;%s: Use -help for summary.\n&quot;, prog);
+            goto end;
+        case OPT_HELP:
+            opt_help(crl_options);
+            ret = 0;
+            goto end;
+        case OPT_INFORM:
+            if (!opt_format(opt_arg(), OPT_FMT_PEMDER, &amp;informat))
+                goto opthelp;
+            break;
+        case OPT_IN:
+            infile = opt_arg();
+            break;
+        case OPT_OUTFORM:
+            if (!opt_format(opt_arg(), OPT_FMT_PEMDER, &amp;outformat))
+                goto opthelp;
+            break;
+        case OPT_OUT:
+            outfile = opt_arg();
+            break;
+        case OPT_KEYFORM:
+            if (!opt_format(opt_arg(), OPT_FMT_PEMDER, &amp;keyformat))
+                goto opthelp;
+            break;
+        case OPT_KEY:
+            keyfile = opt_arg();
+            break;
+        case OPT_GENDELTA:
+            crldiff = opt_arg();
+            break;
+        case OPT_CAPATH:
+            CApath = opt_arg();
             do_ver = 1;
-        } else if (strcmp(*argv, &quot;-verify&quot;) == 0)
+            break;
+        case OPT_CAFILE:
+            CAfile = opt_arg();
             do_ver = 1;
-        else if (strcmp(*argv, &quot;-text&quot;) == 0)
-            text = 1;
-        else if (strcmp(*argv, &quot;-hash&quot;) == 0)
-            hash = ++num;
+            break;
 #ifndef OPENSSL_NO_MD5
-        else if (strcmp(*argv, &quot;-hash_old&quot;) == 0)
+        case OPT_HASH_OLD:
             hash_old = ++num;
+            break;
 #endif
-        else if (strcmp(*argv, &quot;-nameopt&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            if (!set_name_ex(&amp;nmflag, *(++argv)))
-                goto bad;
-        } else if (strcmp(*argv, &quot;-issuer&quot;) == 0)
+        case OPT_VERIFY:
+            do_ver = 1;
+            break;
+        case OPT_TEXT:
+            text = 1;
+            break;
+        case OPT_HASH:
+            hash = ++num;
+            break;
+        case OPT_ISSUER:
             issuer = ++num;
-        else if (strcmp(*argv, &quot;-lastupdate&quot;) == 0)
+            break;
+        case OPT_LASTUPDATE:
             lastupdate = ++num;
-        else if (strcmp(*argv, &quot;-nextupdate&quot;) == 0)
+            break;
+        case OPT_NEXTUPDATE:
             nextupdate = ++num;
-        else if (strcmp(*argv, &quot;-noout&quot;) == 0)
+            break;
+        case OPT_NOOUT:
             noout = ++num;
-        else if (strcmp(*argv, &quot;-fingerprint&quot;) == 0)
+            break;
+        case OPT_FINGERPRINT:
             fingerprint = ++num;
-        else if (strcmp(*argv, &quot;-crlnumber&quot;) == 0)
+            break;
+        case OPT_CRLNUMBER:
             crlnumber = ++num;
-        else if (strcmp(*argv, &quot;-badsig&quot;) == 0)
+            break;
+        case OPT_BADSIG:
             badsig = 1;
-        else if ((md_alg = EVP_get_digestbyname(*argv + 1))) {
-            /* ok */
-            digest = md_alg;
-        } else {
-            BIO_printf(bio_err, &quot;unknown option %s\n&quot;, *argv);
-            badops = 1;
             break;
+        case OPT_NAMEOPT:
+            if (!set_name_ex(&amp;nmflag, opt_arg()))
+                goto opthelp;
+            break;
+        case OPT_MD:
+            if (!opt_md(opt_unknown(), &amp;digest))
+                goto opthelp;
         }
-        argc--;
-        argv++;
-    }
-
-    if (badops) {
- bad:
-        for (pp = crl_usage; (*pp != NULL); pp++)
-            BIO_printf(bio_err, &quot;%s&quot;, *pp);
-        goto end;
     }
+    argc = opt_num_rest();
+    argv = opt_rest();
 
-    ERR_load_crypto_strings();
     x = load_crl(infile, informat);
-    if (x == NULL) {
+    if (x == NULL)
         goto end;
-    }
 
     if (do_ver) {
-        store = X509_STORE_new();
-        lookup = X509_STORE_add_lookup(store, X509_LOOKUP_file());
-        if (lookup == NULL)
+        if (!(store = setup_verify(CAfile, CApath)))
             goto end;
-        if (!X509_LOOKUP_load_file(lookup, CAfile, X509_FILETYPE_PEM))
-            X509_LOOKUP_load_file(lookup, NULL, X509_FILETYPE_DEFAULT);
-
-        lookup = X509_STORE_add_lookup(store, X509_LOOKUP_hash_dir());
+        lookup = X509_STORE_add_lookup(store, X509_LOOKUP_file());
         if (lookup == NULL)
             goto end;
-        if (!X509_LOOKUP_add_dir(lookup, CApath, X509_FILETYPE_PEM))
-            X509_LOOKUP_add_dir(lookup, NULL, X509_FILETYPE_DEFAULT);
-        ERR_clear_error();
-
         if (!X509_STORE_CTX_init(&amp;ctx, store, NULL, NULL)) {
             BIO_printf(bio_err, &quot;Error initialising X509 store\n&quot;);
             goto end;
@@ -295,8 +263,7 @@ int MAIN(int argc, char **argv)
         newcrl = load_crl(crldiff, informat);
         if (!newcrl)
             goto end;
-        pkey = load_key(bio_err, keyfile, keyformat, 0, NULL, NULL,
-                        &quot;CRL signing key&quot;);
+        pkey = load_key(keyfile, keyformat, 0, NULL, NULL, &quot;CRL signing key&quot;);
         if (!pkey) {
             X509_CRL_free(newcrl);
             goto end;
@@ -371,27 +338,9 @@ int MAIN(int argc, char **argv)
             }
         }
     }
-
-    out = BIO_new(BIO_s_file());
-    if (out == NULL) {
-        ERR_print_errors(bio_err);
+    out = bio_open_default(outfile, &quot;w&quot;);
+    if (out == NULL)
         goto end;
-    }
-
-    if (outfile == NULL) {
-        BIO_set_fp(out, stdout, BIO_NOCLOSE);
-#ifdef OPENSSL_SYS_VMS
-        {
-            BIO *tmpbio = BIO_new(BIO_f_linebuffer());
-            out = BIO_push(tmpbio, out);
-        }
-#endif
-    } else {
-        if (BIO_write_filename(out, outfile) &lt;= 0) {
-            perror(outfile);
-            goto end;
-        }
-    }
 
     if (text)
         X509_CRL_print(out, x);
@@ -406,28 +355,22 @@ int MAIN(int argc, char **argv)
 
     if (outformat == FORMAT_ASN1)
         i = (int)i2d_X509_CRL_bio(out, x);
-    else if (outformat == FORMAT_PEM)
+    else
         i = PEM_write_bio_X509_CRL(out, x);
-    else {
-        BIO_printf(bio_err, &quot;bad output format specified for outfile\n&quot;);
-        goto end;
-    }
     if (!i) {
         BIO_printf(bio_err, &quot;unable to write CRL\n&quot;);
         goto end;
     }
     ret = 0;
+
  end:
     if (ret != 0)
         ERR_print_errors(bio_err);
     BIO_free_all(out);
-    BIO_free_all(bio_out);
-    bio_out = NULL;
     X509_CRL_free(x);
     if (store) {
         X509_STORE_CTX_cleanup(&amp;ctx);
         X509_STORE_free(store);
     }
-    apps_shutdown();
-    OPENSSL_EXIT(ret);
+    return (ret);
 }
diff --git a/apps/crl2p7.c b/apps/crl2p7.c
index 86b3a94..d75b667 100644
--- a/apps/crl2p7.c
+++ b/apps/crl2p7.c
@@ -1,4 +1,3 @@
-/* apps/crl2p7.c */
 /* Copyright (C) 1995-1998 Eric Young (<A HREF="../../../mailman/listinfo/openssl-commits.html">eay at cryptsoft.com</A>)
  * All rights reserved.
  *
@@ -74,129 +73,89 @@
 #include &lt;openssl/objects.h&gt;
 
 static int add_certs_from_file(STACK_OF(X509) *stack, char *certfile);
-#undef PROG
-#define PROG    crl2pkcs7_main
 
-/*-
- * -inform arg  - input format - default PEM (DER or PEM)
- * -outform arg - output format - default PEM
- * -in arg      - input file - default stdin
- * -out arg     - output file - default stdout
- */
+typedef enum OPTION_choice {
+    OPT_ERR = -1, OPT_EOF = 0, OPT_HELP,
+    OPT_INFORM, OPT_OUTFORM, OPT_IN, OPT_OUT, OPT_NOCRL, OPT_CERTFILE
+} OPTION_CHOICE;
 
-int MAIN(int, char **);
+OPTIONS crl2pkcs7_options[] = {
+    {&quot;help&quot;, OPT_HELP, '-', &quot;Display this summary&quot;},
+    {&quot;inform&quot;, OPT_INFORM, 'F', &quot;Input format - DER or PEM&quot;},
+    {&quot;outform&quot;, OPT_OUTFORM, 'F', &quot;Output format - DER or PEM&quot;},
+    {&quot;in&quot;, OPT_IN, '&lt;', &quot;Input file&quot;},
+    {&quot;out&quot;, OPT_OUT, '&gt;', &quot;Output file&quot;},
+    {&quot;nocrl&quot;, OPT_NOCRL, '-', &quot;No crl to load, just certs from '-certfile'&quot;},
+    {&quot;certfile&quot;, OPT_CERTFILE, '&lt;',
+     &quot;File of chain of certs to a trusted CA; can be repeated&quot;},
+    {NULL}
+};
 
-int MAIN(int argc, char **argv)
+int crl2pkcs7_main(int argc, char **argv)
 {
-    int i, badops = 0;
     BIO *in = NULL, *out = NULL;
-    int informat, outformat;
-    char *infile, *outfile, *prog, *certfile;
     PKCS7 *p7 = NULL;
     PKCS7_SIGNED *p7s = NULL;
-    X509_CRL *crl = NULL;
     STACK_OF(OPENSSL_STRING) *certflst = NULL;
-    STACK_OF(X509_CRL) *crl_stack = NULL;
     STACK_OF(X509) *cert_stack = NULL;
-    int ret = 1, nocrl = 0;
-
-    apps_startup();
-
-    if (bio_err == NULL)
-        if ((bio_err = BIO_new(BIO_s_file())) != NULL)
-            BIO_set_fp(bio_err, stderr, BIO_NOCLOSE | BIO_FP_TEXT);
-
-    infile = NULL;
-    outfile = NULL;
-    informat = FORMAT_PEM;
-    outformat = FORMAT_PEM;
+    STACK_OF(X509_CRL) *crl_stack = NULL;
+    X509_CRL *crl = NULL;
+    char *infile = NULL, *outfile = NULL, *prog, *certfile;
+    int i = 0, informat = FORMAT_PEM, outformat = FORMAT_PEM, ret = 1, nocrl =
+        0;
+    OPTION_CHOICE o;
 
-    prog = argv[0];
-    argc--;
-    argv++;
-    while (argc &gt;= 1) {
-        if (strcmp(*argv, &quot;-inform&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            informat = str2fmt(*(++argv));
-        } else if (strcmp(*argv, &quot;-outform&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            outformat = str2fmt(*(++argv));
-        } else if (strcmp(*argv, &quot;-in&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            infile = *(++argv);
-        } else if (strcmp(*argv, &quot;-nocrl&quot;) == 0) {
+    prog = opt_init(argc, argv, crl2pkcs7_options);
+    while ((o = opt_next()) != OPT_EOF) {
+        switch (o) {
+        case OPT_EOF:
+        case OPT_ERR:
+ opthelp:
+            BIO_printf(bio_err, &quot;%s: Use -help for summary.\n&quot;, prog);
+            goto end;
+        case OPT_HELP:
+            opt_help(crl2pkcs7_options);
+            ret = 0;
+            goto end;
+        case OPT_INFORM:
+            if (!opt_format(opt_arg(), OPT_FMT_PEMDER, &amp;informat))
+                goto opthelp;
+            break;
+        case OPT_OUTFORM:
+            if (!opt_format(opt_arg(), OPT_FMT_PEMDER, &amp;outformat))
+                goto opthelp;
+            break;
+        case OPT_IN:
+            infile = opt_arg();
+            break;
+        case OPT_OUT:
+            outfile = opt_arg();
+            break;
+        case OPT_NOCRL:
             nocrl = 1;
-        } else if (strcmp(*argv, &quot;-out&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            outfile = *(++argv);
-        } else if (strcmp(*argv, &quot;-certfile&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            if (!certflst)
-                certflst = sk_OPENSSL_STRING_new_null();
-            if (!certflst)
+            break;
+        case OPT_CERTFILE:
+            if (!certflst &amp;&amp; !(certflst = sk_OPENSSL_STRING_new_null()))
                 goto end;
             if (!sk_OPENSSL_STRING_push(certflst, *(++argv))) {
                 sk_OPENSSL_STRING_free(certflst);
                 goto end;
             }
-        } else {
-            BIO_printf(bio_err, &quot;unknown option %s\n&quot;, *argv);
-            badops = 1;
             break;
         }
-        argc--;
-        argv++;
-    }
-
-    if (badops) {
- bad:
-        BIO_printf(bio_err, &quot;%s [options] &lt;infile &gt;outfile\n&quot;, prog);
-        BIO_printf(bio_err, &quot;where options are\n&quot;);
-        BIO_printf(bio_err, &quot; -inform arg    input format - DER or PEM\n&quot;);
-        BIO_printf(bio_err, &quot; -outform arg   output format - DER or PEM\n&quot;);
-        BIO_printf(bio_err, &quot; -in arg        input file\n&quot;);
-        BIO_printf(bio_err, &quot; -out arg       output file\n&quot;);
-        BIO_printf(bio_err,
-                   &quot; -certfile arg  certificates file of chain to a trusted CA\n&quot;);
-        BIO_printf(bio_err, &quot;                (can be used more than once)\n&quot;);
-        BIO_printf(bio_err,
-                   &quot; -nocrl         no crl to load, just certs from '-certfile'\n&quot;);
-        ret = 1;
-        goto end;
-    }
-
-    ERR_load_crypto_strings();
-
-    in = BIO_new(BIO_s_file());
-    out = BIO_new(BIO_s_file());
-    if ((in == NULL) || (out == NULL)) {
-        ERR_print_errors(bio_err);
-        goto end;
     }
+    argc = opt_num_rest();
+    argv = opt_rest();
 
     if (!nocrl) {
-        if (infile == NULL)
-            BIO_set_fp(in, stdin, BIO_NOCLOSE);
-        else {
-            if (BIO_read_filename(in, infile) &lt;= 0) {
-                perror(infile);
-                goto end;
-            }
-        }
+        in = bio_open_default(infile, RB(informat));
+        if (in == NULL)
+            goto end;
 
         if (informat == FORMAT_ASN1)
             crl = d2i_X509_CRL_bio(in, NULL);
         else if (informat == FORMAT_PEM)
             crl = PEM_read_bio_X509_CRL(in, NULL, NULL, NULL);
-        else {
-            BIO_printf(bio_err, &quot;bad input format specified for input crl\n&quot;);
-            goto end;
-        }
         if (crl == NULL) {
             BIO_printf(bio_err, &quot;unable to load CRL\n&quot;);
             ERR_print_errors(bio_err);
@@ -238,29 +197,14 @@ int MAIN(int argc, char **argv)
 
     sk_OPENSSL_STRING_free(certflst);
 
-    if (outfile == NULL) {
-        BIO_set_fp(out, stdout, BIO_NOCLOSE);
-#ifdef OPENSSL_SYS_VMS
-        {
-            BIO *tmpbio = BIO_new(BIO_f_linebuffer());
-            out = BIO_push(tmpbio, out);
-        }
-#endif
-    } else {
-        if (BIO_write_filename(out, outfile) &lt;= 0) {
-            perror(outfile);
-            goto end;
-        }
-    }
+    out = bio_open_default(outfile, WB(outformat));
+    if (out == NULL)
+        goto end;
 
     if (outformat == FORMAT_ASN1)
         i = i2d_PKCS7_bio(out, p7);
     else if (outformat == FORMAT_PEM)
         i = PEM_write_bio_PKCS7(out, p7);
-    else {
-        BIO_printf(bio_err, &quot;bad output format specified for outfile\n&quot;);
-        goto end;
-    }
     if (!i) {
         BIO_printf(bio_err, &quot;unable to write pkcs7 object\n&quot;);
         ERR_print_errors(bio_err);
@@ -274,8 +218,7 @@ int MAIN(int argc, char **argv)
     if (crl != NULL)
         X509_CRL_free(crl);
 
-    apps_shutdown();
-    OPENSSL_EXIT(ret);
+    return (ret);
 }
 
 /*-
@@ -296,8 +239,8 @@ static int add_certs_from_file(STACK_OF(X509) *stack, char *certfile)
     STACK_OF(X509_INFO) *sk = NULL;
     X509_INFO *xi;
 
-    in = BIO_new(BIO_s_file());
-    if ((in == NULL) || (BIO_read_filename(in, certfile) &lt;= 0)) {
+    in = BIO_new_file(certfile, &quot;r&quot;);
+    if (in == NULL) {
         BIO_printf(bio_err, &quot;error opening the file, %s\n&quot;, certfile);
         goto end;
     }
diff --git a/apps/dgst.c b/apps/dgst.c
index 7006000..21b8c7f 100644
--- a/apps/dgst.c
+++ b/apps/dgst.c
@@ -1,4 +1,3 @@
-/* apps/dgst.c */
 /* Copyright (C) 1995-1998 Eric Young (<A HREF="../../../mailman/listinfo/openssl-commits.html">eay at cryptsoft.com</A>)
  * All rights reserved.
  *
@@ -71,221 +70,186 @@
 #undef BUFSIZE
 #define BUFSIZE 1024*8
 
-#undef PROG
-#define PROG    dgst_main
-
 int do_fp(BIO *out, unsigned char *buf, BIO *bp, int sep, int binout,
           EVP_PKEY *key, unsigned char *sigin, int siglen,
           const char *sig_name, const char *md_name,
           const char *file, BIO *bmd);
 
-static void list_md_fn(const EVP_MD *m,
-                       const char *from, const char *to, void *arg)
-{
-    const char *mname;
-    /* Skip aliases */
-    if (!m)
-        return;
-    mname = OBJ_nid2ln(EVP_MD_type(m));
-    /* Skip shortnames */
-    if (strcmp(from, mname))
-        return;
-    /* Skip clones */
-    if (EVP_MD_flags(m) &amp; EVP_MD_FLAG_PKEY_DIGEST)
-        return;
-    if (strchr(mname, ' '))
-        mname = EVP_MD_name(m);
-    BIO_printf(arg, &quot;-%-14s to use the %s message digest algorithm\n&quot;,
-               mname, mname);
-}
-
-int MAIN(int, char **);
-
-int MAIN(int argc, char **argv)
+typedef enum OPTION_choice {
+    OPT_ERR = -1, OPT_EOF = 0, OPT_HELP,
+    OPT_C, OPT_R, OPT_RAND, OPT_OUT, OPT_SIGN, OPT_PASSIN, OPT_VERIFY,
+    OPT_PRVERIFY, OPT_SIGNATURE, OPT_KEYFORM, OPT_ENGINE, OPT_ENGINE_IMPL,
+    OPT_HEX, OPT_BINARY, OPT_DEBUG, OPT_FIPS_FINGERPRINT,
+    OPT_NON_FIPS_ALLOW, OPT_HMAC, OPT_MAC, OPT_SIGOPT, OPT_MACOPT,
+    OPT_DIGEST
+} OPTION_CHOICE;
+
+OPTIONS dgst_options[] = {
+    {OPT_HELP_STR, 1, '-', &quot;Usage: %s [options] [file...]\n&quot;},
+    {OPT_HELP_STR, 1, '-',
+        &quot;  file... files to digest (default is stdin)\n&quot;},
+    {&quot;help&quot;, OPT_HELP, '-', &quot;Display this summary&quot;},
+    {&quot;c&quot;, OPT_C, '-', &quot;Print the digest with separating colons&quot;},
+    {&quot;r&quot;, OPT_R, '-', &quot;Print the digest in coreutils format&quot;},
+    {&quot;rand&quot;, OPT_RAND, 's'},
+    {&quot;out&quot;, OPT_OUT, '&gt;', &quot;Output to filename rather than stdout&quot;},
+    {&quot;passin&quot;, OPT_PASSIN, 's'},
+    {&quot;sign&quot;, OPT_SIGN, '&lt;', &quot;Sign digest using private key in file&quot;},
+    {&quot;verify&quot;, OPT_VERIFY, '&lt;',
+     &quot;Verify a signature using public key in file&quot;},
+    {&quot;prverify&quot;, OPT_PRVERIFY, '&lt;',
+     &quot;Verify a signature using private key in file&quot;},
+    {&quot;signature&quot;, OPT_SIGNATURE, '&lt;', &quot;File with signature to verify&quot;},
+    {&quot;keyform&quot;, OPT_KEYFORM, 'f', &quot;Key file format (PEM or ENGINE)&quot;},
+#ifndef OPENSSL_NO_ENGINE
+    {&quot;engine&quot;, OPT_ENGINE, 's', &quot;Use engine e, possibly a hardware device&quot;},
+#endif
+    {&quot;engine_impl&quot;, OPT_ENGINE_IMPL, '-'},
+    {&quot;hex&quot;, OPT_HEX, '-', &quot;Print as hex dump&quot;},
+    {&quot;binary&quot;, OPT_BINARY, '-', &quot;Print in binary form&quot;},
+    {&quot;d&quot;, OPT_DEBUG, '-', &quot;Print debug info&quot;},
+    {&quot;debug&quot;, OPT_DEBUG, '-'},
+    {&quot;fips-fingerprint&quot;, OPT_FIPS_FINGERPRINT, '-'},
+    {&quot;non-fips-allow&quot;, OPT_NON_FIPS_ALLOW, '-'},
+    {&quot;hmac&quot;, OPT_HMAC, 's', &quot;Create hashed MAC with key&quot;},
+    {&quot;mac&quot;, OPT_MAC, 's', &quot;Create MAC (not neccessarily HMAC)&quot;},
+    {&quot;sigop&quot;, OPT_SIGOPT, 's', &quot;Signature parameter in n:v form&quot;},
+    {&quot;macop&quot;, OPT_MACOPT, 's', &quot;MAC algorithm parameters in n:v form or key&quot;},
+    {&quot;&quot;, OPT_DIGEST, '-', &quot;Any supported digest&quot;},
+    {NULL}
+};
+
+int dgst_main(int argc, char **argv)
 {
+    BIO *in = NULL, *inp, *bmd = NULL, *out = NULL;
     ENGINE *e = NULL, *impl = NULL;
-    unsigned char *buf = NULL;
-    int i, err = 1;
+    EVP_PKEY *sigkey = NULL;
+    STACK_OF(OPENSSL_STRING) *sigopts = NULL, *macopts = NULL;
+    char *hmac_key = NULL;
+    char *mac_name = NULL;
+    char *passinarg = NULL, *passin = NULL;
     const EVP_MD *md = NULL, *m;
-    BIO *in = NULL, *inp;
-    BIO *bmd = NULL;
-    BIO *out = NULL;
-#define PROG_NAME_SIZE  39
-    char pname[PROG_NAME_SIZE + 1];
-    int separator = 0;
-    int debug = 0;
-    int keyform = FORMAT_PEM;
-    const char *outfile = NULL, *keyfile = NULL;
+    const char *outfile = NULL, *keyfile = NULL, *prog = NULL;
     const char *sigfile = NULL, *randfile = NULL;
-    int out_bin = -1, want_pub = 0, do_verify = 0;
-    EVP_PKEY *sigkey = NULL;
-    unsigned char *sigbuf = NULL;
-    int siglen = 0;
-    char *passargin = NULL, *passin = NULL;
+    OPTION_CHOICE o;
+    int separator = 0, debug = 0, keyform = FORMAT_PEM, siglen = 0;
+    int i, ret = 1, out_bin = -1, want_pub = 0, do_verify =
+        0, non_fips_allow = 0;
+    unsigned char *buf = NULL, *sigbuf = NULL;
 #ifndef OPENSSL_NO_ENGINE
     char *engine = NULL;
     int engine_impl = 0;
 #endif
-    char *hmac_key = NULL;
-    char *mac_name = NULL;
-    int non_fips_allow = 0;
-    STACK_OF(OPENSSL_STRING) *sigopts = NULL, *macopts = NULL;
-
-    apps_startup();
 
+    prog = opt_progname(argv[0]);
     if ((buf = (unsigned char *)OPENSSL_malloc(BUFSIZE)) == NULL) {
-        BIO_printf(bio_err, &quot;out of memory\n&quot;);
+        BIO_printf(bio_err, &quot;%s: out of memory\n&quot;, prog);
         goto end;
     }
-    if (bio_err == NULL)
-        if ((bio_err = BIO_new(BIO_s_file())) != NULL)
-            BIO_set_fp(bio_err, stderr, BIO_NOCLOSE | BIO_FP_TEXT);
-
-    if (!load_config(bio_err, NULL))
-        goto end;
-
-    /* first check the program name */
-    program_name(argv[0], pname, sizeof pname);
-
-    md = EVP_get_digestbyname(pname);
-
-    argc--;
-    argv++;
-    while (argc &gt; 0) {
-        if ((*argv)[0] != '-')
-            break;
-        if (strcmp(*argv, &quot;-c&quot;) == 0)
+    md = EVP_get_digestbyname(prog);
+
+    prog = opt_init(argc, argv, dgst_options);
+    while ((o = opt_next()) != OPT_EOF) {
+        switch (o) {
+        case OPT_EOF:
+        case OPT_ERR:
+ opthelp:
+            BIO_printf(bio_err, &quot;%s: Use -help for summary.\n&quot;, prog);
+            goto end;
+        case OPT_HELP:
+            opt_help(dgst_options);
+            ret = 0;
+            goto end;
+        case OPT_C:
             separator = 1;
-        else if (strcmp(*argv, &quot;-r&quot;) == 0)
+            break;
+        case OPT_R:
             separator = 2;
-        else if (strcmp(*argv, &quot;-rand&quot;) == 0) {
-            if (--argc &lt; 1)
-                break;
-            randfile = *(++argv);
-        } else if (strcmp(*argv, &quot;-out&quot;) == 0) {
-            if (--argc &lt; 1)
-                break;
-            outfile = *(++argv);
-        } else if (strcmp(*argv, &quot;-sign&quot;) == 0) {
-            if (--argc &lt; 1)
-                break;
-            keyfile = *(++argv);
-        } else if (!strcmp(*argv, &quot;-passin&quot;)) {
-            if (--argc &lt; 1)
-                break;
-            passargin = *++argv;
-        } else if (strcmp(*argv, &quot;-verify&quot;) == 0) {
-            if (--argc &lt; 1)
-                break;
-            keyfile = *(++argv);
-            want_pub = 1;
-            do_verify = 1;
-        } else if (strcmp(*argv, &quot;-prverify&quot;) == 0) {
-            if (--argc &lt; 1)
-                break;
-            keyfile = *(++argv);
+            break;
+        case OPT_RAND:
+            randfile = opt_arg();
+            break;
+        case OPT_OUT:
+            outfile = opt_arg();
+            break;
+        case OPT_SIGN:
+            keyfile = opt_arg();
+            break;
+        case OPT_PASSIN:
+            passinarg = opt_arg();
+            break;
+        case OPT_VERIFY:
+            keyfile = opt_arg();
+            want_pub = do_verify = 1;
+            break;
+        case OPT_PRVERIFY:
+            keyfile = opt_arg();
             do_verify = 1;
-        } else if (strcmp(*argv, &quot;-signature&quot;) == 0) {
-            if (--argc &lt; 1)
-                break;
-            sigfile = *(++argv);
-        } else if (strcmp(*argv, &quot;-keyform&quot;) == 0) {
-            if (--argc &lt; 1)
-                break;
-            keyform = str2fmt(*(++argv));
-        }
+            break;
+        case OPT_SIGNATURE:
+            sigfile = opt_arg();
+            break;
+        case OPT_KEYFORM:
+            if (!opt_format(opt_arg(), OPT_FMT_ANY, &amp;keyform))
+                goto opthelp;
+            break;
 #ifndef OPENSSL_NO_ENGINE
-        else if (strcmp(*argv, &quot;-engine&quot;) == 0) {
-            if (--argc &lt; 1)
-                break;
-            engine = *(++argv);
-            e = setup_engine(bio_err, engine, 0);
-        } else if (strcmp(*argv, &quot;-engine_impl&quot;) == 0)
+        case OPT_ENGINE:
+            engine = opt_arg();
+            e = setup_engine(engine, 0);
+            break;
+        case OPT_ENGINE_IMPL:
             engine_impl = 1;
+            break;
 #endif
-        else if (strcmp(*argv, &quot;-hex&quot;) == 0)
+        case OPT_HEX:
             out_bin = 0;
-        else if (strcmp(*argv, &quot;-binary&quot;) == 0)
+            break;
+        case OPT_BINARY:
             out_bin = 1;
-        else if (strcmp(*argv, &quot;-d&quot;) == 0)
+            break;
+        case OPT_DEBUG:
             debug = 1;
-        else if (!strcmp(*argv, &quot;-fips-fingerprint&quot;))
+            break;
+        case OPT_FIPS_FINGERPRINT:
             hmac_key = &quot;etaonrishdlcupfm&quot;;
-        else if (strcmp(*argv, &quot;-non-fips-allow&quot;) == 0)
+            break;
+        case OPT_NON_FIPS_ALLOW:
             non_fips_allow = 1;
-        else if (!strcmp(*argv, &quot;-hmac&quot;)) {
-            if (--argc &lt; 1)
-                break;
-            hmac_key = *++argv;
-        } else if (!strcmp(*argv, &quot;-mac&quot;)) {
-            if (--argc &lt; 1)
-                break;
-            mac_name = *++argv;
-        } else if (strcmp(*argv, &quot;-sigopt&quot;) == 0) {
-            if (--argc &lt; 1)
-                break;
+            break;
+        case OPT_HMAC:
+            hmac_key = opt_arg();
+            break;
+        case OPT_MAC:
+            mac_name = opt_arg();
+            break;
+        case OPT_SIGOPT:
             if (!sigopts)
                 sigopts = sk_OPENSSL_STRING_new_null();
-            if (!sigopts || !sk_OPENSSL_STRING_push(sigopts, *(++argv)))
-                break;
-        } else if (strcmp(*argv, &quot;-macopt&quot;) == 0) {
-            if (--argc &lt; 1)
-                break;
+            if (!sigopts || !sk_OPENSSL_STRING_push(sigopts, opt_arg()))
+                goto opthelp;
+            break;
+        case OPT_MACOPT:
             if (!macopts)
                 macopts = sk_OPENSSL_STRING_new_null();
-            if (!macopts || !sk_OPENSSL_STRING_push(macopts, *(++argv)))
-                break;
-        } else if ((m = EVP_get_digestbyname(&amp;((*argv)[1]))) != NULL)
+            if (!macopts || !sk_OPENSSL_STRING_push(macopts, opt_arg()))
+                goto opthelp;
+            break;
+        case OPT_DIGEST:
+            if (!opt_md(opt_unknown(), &amp;m))
+                goto opthelp;
             md = m;
-        else
             break;
-        argc--;
-        argv++;
+        }
     }
+    argc = opt_num_rest();
+    argv = opt_rest();
 
     if (do_verify &amp;&amp; !sigfile) {
         BIO_printf(bio_err,
                    &quot;No signature to verify: use the -signature option\n&quot;);
         goto end;
     }
-
-    if ((argc &gt; 0) &amp;&amp; (argv[0][0] == '-')) { /* bad option */
-        BIO_printf(bio_err, &quot;unknown option '%s'\n&quot;, *argv);
-        BIO_printf(bio_err, &quot;options are\n&quot;);
-        BIO_printf(bio_err,
-                   &quot;-c              to output the digest with separating colons\n&quot;);
-        BIO_printf(bio_err,
-                   &quot;-r              to output the digest in coreutils format\n&quot;);
-        BIO_printf(bio_err, &quot;-d              to output debug info\n&quot;);
-        BIO_printf(bio_err, &quot;-hex            output as hex dump\n&quot;);
-        BIO_printf(bio_err, &quot;-binary         output in binary form\n&quot;);
-        BIO_printf(bio_err, &quot;-hmac arg       set the HMAC key to arg\n&quot;);
-        BIO_printf(bio_err, &quot;-non-fips-allow allow use of non FIPS digest\n&quot;);
-        BIO_printf(bio_err,
-                   &quot;-sign   file    sign digest using private key in file\n&quot;);
-        BIO_printf(bio_err,
-                   &quot;-verify file    verify a signature using public key in file\n&quot;);
-        BIO_printf(bio_err,
-                   &quot;-prverify file  verify a signature using private key in file\n&quot;);
-        BIO_printf(bio_err,
-                   &quot;-keyform arg    key file format (PEM or ENGINE)\n&quot;);
-        BIO_printf(bio_err,
-                   &quot;-out filename   output to filename rather than stdout\n&quot;);
-        BIO_printf(bio_err, &quot;-signature file signature to verify\n&quot;);
-        BIO_printf(bio_err, &quot;-sigopt nm:v    signature parameter\n&quot;);
-        BIO_printf(bio_err, &quot;-hmac key       create hashed MAC with key\n&quot;);
-        BIO_printf(bio_err,
-                   &quot;-mac algorithm  create MAC (not neccessarily HMAC)\n&quot;);
-        BIO_printf(bio_err,
-                   &quot;-macopt nm:v    MAC algorithm parameters or key\n&quot;);
-#ifndef OPENSSL_NO_ENGINE
-        BIO_printf(bio_err,
-                   &quot;-engine e       use engine e, possibly a hardware device.\n&quot;);
-#endif
-
-        EVP_MD_do_all_sorted(list_md_fn, bio_err);
-        goto end;
-    }
 #ifndef OPENSSL_NO_ENGINE
     if (engine_impl)
         impl = e;
@@ -304,7 +268,7 @@ int MAIN(int argc, char **argv)
         BIO_set_callback_arg(in, (char *)bio_err);
     }
 
-    if (!app_passwd(bio_err, passargin, NULL, &amp;passin, NULL)) {
+    if (!app_passwd(passinarg, NULL, &amp;passin, NULL)) {
         BIO_printf(bio_err, &quot;Error getting password\n&quot;);
         goto end;
     }
@@ -317,29 +281,12 @@ int MAIN(int argc, char **argv)
     }
 
     if (randfile)
-        app_RAND_load_file(randfile, bio_err, 0);
+        app_RAND_load_file(randfile, 0);
 
-    if (outfile) {
-        if (out_bin)
-            out = BIO_new_file(outfile, &quot;wb&quot;);
-        else
-            out = BIO_new_file(outfile, &quot;w&quot;);
-    } else {
-        out = BIO_new_fp(stdout, BIO_NOCLOSE);
-#ifdef OPENSSL_SYS_VMS
-        {
-            BIO *tmpbio = BIO_new(BIO_f_linebuffer());
-            out = BIO_push(tmpbio, out);
-        }
-#endif
-    }
-
-    if (!out) {
-        BIO_printf(bio_err, &quot;Error opening output file %s\n&quot;,
-                   outfile ? outfile : &quot;(stdout)&quot;);
-        ERR_print_errors(bio_err);
+    out = bio_open_default(outfile, out_bin ? &quot;wb&quot; : &quot;w&quot;);
+    if (out == NULL)
         goto end;
-    }
+
     if ((! !mac_name + ! !keyfile + ! !hmac_key) &gt; 1) {
         BIO_printf(bio_err, &quot;MAC and Signing key cannot both be specified\n&quot;);
         goto end;
@@ -347,11 +294,9 @@ int MAIN(int argc, char **argv)
 
     if (keyfile) {
         if (want_pub)
-            sigkey = load_pubkey(bio_err, keyfile, keyform, 0, NULL,
-                                 e, &quot;key file&quot;);
+            sigkey = load_pubkey(keyfile, keyform, 0, NULL, e, &quot;key file&quot;);
         else
-            sigkey = load_key(bio_err, keyfile, keyform, 0, passin,
-                              e, &quot;key file&quot;);
+            sigkey = load_key(keyfile, keyform, 0, passin, e, &quot;key file&quot;);
         if (!sigkey) {
             /*
              * load_[pub]key() has already printed an appropriate message
@@ -363,7 +308,7 @@ int MAIN(int argc, char **argv)
     if (mac_name) {
         EVP_PKEY_CTX *mac_ctx = NULL;
         int r = 0;
-        if (!init_gen_str(bio_err, &amp;mac_ctx, mac_name, impl, 0))
+        if (!init_gen_str(&amp;mac_ctx, mac_name, impl, 0))
             goto mac_end;
         if (macopts) {
             char *macopt;
@@ -443,25 +388,23 @@ int MAIN(int argc, char **argv)
         if (md == NULL)
             md = EVP_md5();
         if (!EVP_DigestInit_ex(mctx, md, impl)) {
-            BIO_printf(bio_err, &quot;Error setting digest %s\n&quot;, pname);
+            BIO_printf(bio_err, &quot;Error setting digest\n&quot;);
             ERR_print_errors(bio_err);
             goto end;
         }
     }
 
     if (sigfile &amp;&amp; sigkey) {
-        BIO *sigbio;
-        sigbio = BIO_new_file(sigfile, &quot;rb&quot;);
-        siglen = EVP_PKEY_size(sigkey);
-        sigbuf = OPENSSL_malloc(siglen);
+        BIO *sigbio = BIO_new_file(sigfile, &quot;rb&quot;);
         if (!sigbio) {
             BIO_printf(bio_err, &quot;Error opening signature file %s\n&quot;, sigfile);
             ERR_print_errors(bio_err);
             goto end;
         }
+        siglen = EVP_PKEY_size(sigkey);
+        sigbuf = OPENSSL_malloc(siglen);
         if (!sigbuf) {
             BIO_printf(bio_err, &quot;Out of memory\n&quot;);
-            ERR_print_errors(bio_err);
             goto end;
         }
         siglen = BIO_read(sigbio, sigbuf, siglen);
@@ -482,7 +425,7 @@ int MAIN(int argc, char **argv)
 
     if (argc == 0) {
         BIO_set_fp(in, stdin, BIO_NOCLOSE);
-        err = do_fp(out, buf, inp, separator, out_bin, sigkey, sigbuf,
+        ret = do_fp(out, buf, inp, separator, out_bin, sigkey, sigbuf,
                     siglen, NULL, NULL, &quot;stdin&quot;, bmd);
     } else {
         const char *md_name = NULL, *sig_name = NULL;
@@ -497,18 +440,18 @@ int MAIN(int argc, char **argv)
             if (md)
                 md_name = EVP_MD_name(md);
         }
-        err = 0;
+        ret = 0;
         for (i = 0; i &lt; argc; i++) {
             int r;
             if (BIO_read_filename(in, argv[i]) &lt;= 0) {
                 perror(argv[i]);
-                err++;
+                ret++;
                 continue;
             } else
                 r = do_fp(out, buf, inp, separator, out_bin, sigkey, sigbuf,
                           siglen, sig_name, md_name, argv[i], bmd);
             if (r)
-                err = r;
+                ret = r;
             (void)BIO_reset(bmd);
         }
     }
@@ -529,8 +472,7 @@ int MAIN(int argc, char **argv)
     if (sigbuf)
         OPENSSL_free(sigbuf);
     BIO_free(bmd);
-    apps_shutdown();
-    OPENSSL_EXIT(err);
+    return (ret);
 }
 
 int do_fp(BIO *out, unsigned char *buf, BIO *bp, int sep, int binout,
diff --git a/apps/dh.c b/apps/dh.c
deleted file mode 100644
index 1b653f5..0000000
--- a/apps/dh.c
+++ /dev/null
@@ -1,325 +0,0 @@
-/* apps/dh.c */
-/* obsoleted by dhparam.c */
-/* Copyright (C) 1995-1998 Eric Young (<A HREF="../../../mailman/listinfo/openssl-commits.html">eay at cryptsoft.com</A>)
- * All rights reserved.
- *
- * This package is an SSL implementation written
- * by Eric Young (<A HREF="../../../mailman/listinfo/openssl-commits.html">eay at cryptsoft.com</A>).
- * The implementation was written so as to conform with Netscapes SSL.
- *
- * This library is free for commercial and non-commercial use as long as
- * the following conditions are aheared to.  The following conditions
- * apply to all code found in this distribution, be it the RC4, RSA,
- * lhash, DES, etc., code; not just the SSL code.  The SSL documentation
- * included with this distribution is covered by the same copyright terms
- * except that the holder is Tim Hudson (<A HREF="../../../mailman/listinfo/openssl-commits.html">tjh at cryptsoft.com</A>).
- *
- * Copyright remains Eric Young's, and as such any Copyright notices in
- * the code are not to be removed.
- * If this package is used in a product, Eric Young should be given attribution
- * as the author of the parts of the library used.
- * This can be in the form of a textual message at program startup or
- * in documentation (online or textual) provided with the package.
- *
- * Redistribution and use in source and binary forms, with or without
- * modification, are permitted provided that the following conditions
- * are met:
- * 1. Redistributions of source code must retain the copyright
- *    notice, this list of conditions and the following disclaimer.
- * 2. Redistributions in binary form must reproduce the above copyright
- *    notice, this list of conditions and the following disclaimer in the
- *    documentation and/or other materials provided with the distribution.
- * 3. All advertising materials mentioning features or use of this software
- *    must display the following acknowledgement:
- *    &quot;This product includes cryptographic software written by
- *     Eric Young (<A HREF="../../../mailman/listinfo/openssl-commits.html">eay at cryptsoft.com</A>)&quot;
- *    The word 'cryptographic' can be left out if the rouines from the library
- *    being used are not cryptographic related :-).
- * 4. If you include any Windows specific code (or a derivative thereof) from
- *    the apps directory (application code) you must include an acknowledgement:
- *    &quot;This product includes software written by Tim Hudson (<A HREF="../../../mailman/listinfo/openssl-commits.html">tjh at cryptsoft.com</A>)&quot;
- *
- * THIS SOFTWARE IS PROVIDED BY ERIC YOUNG ``AS IS'' AND
- * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
- * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE
- * ARE DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE
- * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL
- * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS
- * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)
- * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT
- * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY
- * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
- * SUCH DAMAGE.
- *
- * The licence and distribution terms for any publically available version or
- * derivative of this code cannot be changed.  i.e. this code cannot simply be
- * copied and put under another distribution licence
- * [including the GNU Public Licence.]
- */
-
-#include &lt;openssl/opensslconf.h&gt; /* for OPENSSL_NO_DH */
-#ifndef OPENSSL_NO_DH
-# include &lt;stdio.h&gt;
-# include &lt;stdlib.h&gt;
-# include &lt;time.h&gt;
-# include &lt;string.h&gt;
-# include &quot;apps.h&quot;
-# include &lt;openssl/bio.h&gt;
-# include &lt;openssl/err.h&gt;
-# include &lt;openssl/bn.h&gt;
-# include &lt;openssl/dh.h&gt;
-# include &lt;openssl/x509.h&gt;
-# include &lt;openssl/pem.h&gt;
-
-# undef PROG
-# define PROG    dh_main
-
-/*-
- * -inform arg  - input format - default PEM (DER or PEM)
- * -outform arg - output format - default PEM
- * -in arg      - input file - default stdin
- * -out arg     - output file - default stdout
- * -check       - check the parameters are ok
- * -noout
- * -text
- * -C
- */
-
-int MAIN(int, char **);
-
-int MAIN(int argc, char **argv)
-{
-    DH *dh = NULL;
-    int i, badops = 0, text = 0;
-    BIO *in = NULL, *out = NULL;
-    int informat, outformat, check = 0, noout = 0, C = 0, ret = 1;
-    char *infile, *outfile, *prog;
-# ifndef OPENSSL_NO_ENGINE
-    char *engine;
-# endif
-
-    apps_startup();
-
-    if (bio_err == NULL)
-        if ((bio_err = BIO_new(BIO_s_file())) != NULL)
-            BIO_set_fp(bio_err, stderr, BIO_NOCLOSE | BIO_FP_TEXT);
-
-    if (!load_config(bio_err, NULL))
-        goto end;
-
-# ifndef OPENSSL_NO_ENGINE
-    engine = NULL;
-# endif
-    infile = NULL;
-    outfile = NULL;
-    informat = FORMAT_PEM;
-    outformat = FORMAT_PEM;
-
-    prog = argv[0];
-    argc--;
-    argv++;
-    while (argc &gt;= 1) {
-        if (strcmp(*argv, &quot;-inform&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            informat = str2fmt(*(++argv));
-        } else if (strcmp(*argv, &quot;-outform&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            outformat = str2fmt(*(++argv));
-        } else if (strcmp(*argv, &quot;-in&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            infile = *(++argv);
-        } else if (strcmp(*argv, &quot;-out&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            outfile = *(++argv);
-        }
-# ifndef OPENSSL_NO_ENGINE
-        else if (strcmp(*argv, &quot;-engine&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            engine = *(++argv);
-        }
-# endif
-        else if (strcmp(*argv, &quot;-check&quot;) == 0)
-            check = 1;
-        else if (strcmp(*argv, &quot;-text&quot;) == 0)
-            text = 1;
-        else if (strcmp(*argv, &quot;-C&quot;) == 0)
-            C = 1;
-        else if (strcmp(*argv, &quot;-noout&quot;) == 0)
-            noout = 1;
-        else {
-            BIO_printf(bio_err, &quot;unknown option %s\n&quot;, *argv);
-            badops = 1;
-            break;
-        }
-        argc--;
-        argv++;
-    }
-
-    if (badops) {
- bad:
-        BIO_printf(bio_err, &quot;%s [options] &lt;infile &gt;outfile\n&quot;, prog);
-        BIO_printf(bio_err, &quot;where options are\n&quot;);
-        BIO_printf(bio_err, &quot; -inform arg   input format - one of DER PEM\n&quot;);
-        BIO_printf(bio_err,
-                   &quot; -outform arg  output format - one of DER PEM\n&quot;);
-        BIO_printf(bio_err, &quot; -in arg       input file\n&quot;);
-        BIO_printf(bio_err, &quot; -out arg      output file\n&quot;);
-        BIO_printf(bio_err, &quot; -check        check the DH parameters\n&quot;);
-        BIO_printf(bio_err,
-                   &quot; -text         print a text form of the DH parameters\n&quot;);
-        BIO_printf(bio_err, &quot; -C            Output C code\n&quot;);
-        BIO_printf(bio_err, &quot; -noout        no output\n&quot;);
-# ifndef OPENSSL_NO_ENGINE
-        BIO_printf(bio_err,
-                   &quot; -engine e     use engine e, possibly a hardware device.\n&quot;);
-# endif
-        goto end;
-    }
-
-    ERR_load_crypto_strings();
-
-# ifndef OPENSSL_NO_ENGINE
-    setup_engine(bio_err, engine, 0);
-# endif
-
-    in = BIO_new(BIO_s_file());
-    out = BIO_new(BIO_s_file());
-    if ((in == NULL) || (out == NULL)) {
-        ERR_print_errors(bio_err);
-        goto end;
-    }
-
-    if (infile == NULL)
-        BIO_set_fp(in, stdin, BIO_NOCLOSE);
-    else {
-        if (BIO_read_filename(in, infile) &lt;= 0) {
-            perror(infile);
-            goto end;
-        }
-    }
-    if (outfile == NULL) {
-        BIO_set_fp(out, stdout, BIO_NOCLOSE);
-# ifdef OPENSSL_SYS_VMS
-        {
-            BIO *tmpbio = BIO_new(BIO_f_linebuffer());
-            out = BIO_push(tmpbio, out);
-        }
-# endif
-    } else {
-        if (BIO_write_filename(out, outfile) &lt;= 0) {
-            perror(outfile);
-            goto end;
-        }
-    }
-
-    if (informat == FORMAT_ASN1)
-        dh = d2i_DHparams_bio(in, NULL);
-    else if (informat == FORMAT_PEM)
-        dh = PEM_read_bio_DHparams(in, NULL, NULL, NULL);
-    else {
-        BIO_printf(bio_err, &quot;bad input format specified\n&quot;);
-        goto end;
-    }
-    if (dh == NULL) {
-        BIO_printf(bio_err, &quot;unable to load DH parameters\n&quot;);
-        ERR_print_errors(bio_err);
-        goto end;
-    }
-
-    if (text) {
-        DHparams_print(out, dh);
-    }
-
-    if (check) {
-        if (!DH_check(dh, &amp;i)) {
-            ERR_print_errors(bio_err);
-            goto end;
-        }
-        if (i &amp; DH_CHECK_P_NOT_PRIME)
-            printf(&quot;p value is not prime\n&quot;);
-        if (i &amp; DH_CHECK_P_NOT_SAFE_PRIME)
-            printf(&quot;p value is not a safe prime\n&quot;);
-        if (i &amp; DH_UNABLE_TO_CHECK_GENERATOR)
-            printf(&quot;unable to check the generator value\n&quot;);
-        if (i &amp; DH_NOT_SUITABLE_GENERATOR)
-            printf(&quot;the g value is not a generator\n&quot;);
-        if (i == 0)
-            printf(&quot;DH parameters appear to be ok.\n&quot;);
-    }
-    if (C) {
-        unsigned char *data;
-        int len, l, bits;
-
-        len = BN_num_bytes(dh-&gt;p);
-        bits = BN_num_bits(dh-&gt;p);
-        data = (unsigned char *)OPENSSL_malloc(len);
-        if (data == NULL) {
-            perror(&quot;OPENSSL_malloc&quot;);
-            goto end;
-        }
-        l = BN_bn2bin(dh-&gt;p, data);
-        printf(&quot;static unsigned char dh%d_p[]={&quot;, bits);
-        for (i = 0; i &lt; l; i++) {
-            if ((i % 12) == 0)
-                printf(&quot;\n\t&quot;);
-            printf(&quot;0x%02X,&quot;, data[i]);
-        }
-        printf(&quot;\n\t};\n&quot;);
-
-        l = BN_bn2bin(dh-&gt;g, data);
-        printf(&quot;static unsigned char dh%d_g[]={&quot;, bits);
-        for (i = 0; i &lt; l; i++) {
-            if ((i % 12) == 0)
-                printf(&quot;\n\t&quot;);
-            printf(&quot;0x%02X,&quot;, data[i]);
-        }
-        printf(&quot;\n\t};\n\n&quot;);
-
-        printf(&quot;DH *get_dh%d()\n\t{\n&quot;, bits);
-        printf(&quot;\tDH *dh;\n\n&quot;);
-        printf(&quot;\tif ((dh=DH_new()) == NULL) return(NULL);\n&quot;);
-        printf(&quot;\tdh-&gt;p=BN_bin2bn(dh%d_p,sizeof(dh%d_p),NULL);\n&quot;,
-               bits, bits);
-        printf(&quot;\tdh-&gt;g=BN_bin2bn(dh%d_g,sizeof(dh%d_g),NULL);\n&quot;,
-               bits, bits);
-        printf(&quot;\tif ((dh-&gt;p == NULL) || (dh-&gt;g == NULL))\n&quot;);
-        printf(&quot;\t\treturn(NULL);\n&quot;);
-        printf(&quot;\treturn(dh);\n\t}\n&quot;);
-        OPENSSL_free(data);
-    }
-
-    if (!noout) {
-        if (outformat == FORMAT_ASN1)
-            i = i2d_DHparams_bio(out, dh);
-        else if (outformat == FORMAT_PEM)
-            i = PEM_write_bio_DHparams(out, dh);
-        else {
-            BIO_printf(bio_err, &quot;bad output format specified for outfile\n&quot;);
-            goto end;
-        }
-        if (!i) {
-            BIO_printf(bio_err, &quot;unable to write DH parameters\n&quot;);
-            ERR_print_errors(bio_err);
-            goto end;
-        }
-    }
-    ret = 0;
- end:
-    BIO_free(in);
-    BIO_free_all(out);
-    DH_free(dh);
-    apps_shutdown();
-    OPENSSL_EXIT(ret);
-}
-#else                           /* !OPENSSL_NO_DH */
-
-# if PEDANTIC
-static void *dummy = &dummy;
-# endif
-
-#endif
diff --git a/apps/dhparam.c b/apps/dhparam.c
index fc5962a..e842ca5 100644
--- a/apps/dhparam.c
+++ b/apps/dhparam.c
@@ -1,4 +1,3 @@
-/* apps/dhparam.c */
 /* Copyright (C) 1995-1998 Eric Young (<A HREF="../../../mailman/listinfo/openssl-commits.html">eay at cryptsoft.com</A>)
  * All rights reserved.
  *
@@ -127,170 +126,131 @@
 #  include &lt;openssl/dsa.h&gt;
 # endif
 
-# undef PROG
-# define PROG    dhparam_main
-
 # define DEFBITS 2048
 
-/*-
- * -inform arg  - input format - default PEM (DER or PEM)
- * -outform arg - output format - default PEM
- * -in arg      - input file - default stdin
- * -out arg     - output file - default stdout
- * -dsaparam  - read or generate DSA parameters, convert to DH
- * -check       - check the parameters are ok
- * -noout
- * -text
- * -C
- */
-
 static int dh_cb(int p, int n, BN_GENCB *cb);
 
-int MAIN(int, char **);
-
-int MAIN(int argc, char **argv)
-{
-    DH *dh = NULL;
-    int i, badops = 0, text = 0;
-# ifndef OPENSSL_NO_DSA
-    int dsaparam = 0;
-# endif
-    BIO *in = NULL, *out = NULL;
-    int informat, outformat, check = 0, noout = 0, C = 0, ret = 1;
-    char *infile, *outfile, *prog;
-    char *inrand = NULL;
+typedef enum OPTION_choice {
+    OPT_ERR = -1, OPT_EOF = 0, OPT_HELP,
+    OPT_INFORM, OPT_OUTFORM, OPT_IN, OPT_OUT,
+    OPT_ENGINE, OPT_CHECK, OPT_TEXT, OPT_NOOUT,
+    OPT_RAND, OPT_DSAPARAM, OPT_C, OPT_2, OPT_5
+} OPTION_CHOICE;
+
+OPTIONS dhparam_options[] = {
+    {OPT_HELP_STR, 1, '-', &quot;Usage: %s [flags] [numbits]\n&quot;},
+    {OPT_HELP_STR, 1, '-', &quot;Valid options are:\n&quot;},
+    {&quot;help&quot;, OPT_HELP, '-', &quot;Display this summary&quot;},
+    {&quot;in&quot;, OPT_IN, '&lt;', &quot;Input file&quot;},
+    {&quot;inform&quot;, OPT_INFORM, 'F', &quot;Input format, DER or PEM&quot;},
+    {&quot;outform&quot;, OPT_OUTFORM, 'F', &quot;Output format, DER or PEM&quot;},
+    {&quot;out&quot;, OPT_OUT, '&gt;', &quot;Output file&quot;},
+    {&quot;check&quot;, OPT_CHECK, '-', &quot;Check the DH parameters&quot;},
+    {&quot;text&quot;, OPT_TEXT, '-', &quot;Print a text form of the DH parameters&quot;},
+    {&quot;noout&quot;, OPT_NOOUT, '-'},
+    {&quot;rand&quot;, OPT_RAND, 's',
+     &quot;Load the file(s) into the random number generator&quot;},
+    {&quot;C&quot;, OPT_C, '-', &quot;Print C code&quot;},
+    {&quot;2&quot;, OPT_2, '-', &quot;Generate parameters using 2 as the generator value&quot;},
+    {&quot;5&quot;, OPT_5, '-', &quot;Generate parameters using 5 as the generator value&quot;},
 # ifndef OPENSSL_NO_ENGINE
-    char *engine = NULL;
+    {&quot;engine&quot;, OPT_ENGINE, 's', &quot;Use engine e, possibly a hardware device&quot;},
 # endif
-    int num = 0, g = 0;
-
-    apps_startup();
-
-    if (bio_err == NULL)
-        if ((bio_err = BIO_new(BIO_s_file())) != NULL)
-            BIO_set_fp(bio_err, stderr, BIO_NOCLOSE | BIO_FP_TEXT);
-
-    if (!load_config(bio_err, NULL))
-        goto end;
-
-    infile = NULL;
-    outfile = NULL;
-    informat = FORMAT_PEM;
-    outformat = FORMAT_PEM;
-
-    prog = argv[0];
-    argc--;
-    argv++;
-    while (argc &gt;= 1) {
-        if (strcmp(*argv, &quot;-inform&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            informat = str2fmt(*(++argv));
-        } else if (strcmp(*argv, &quot;-outform&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            outformat = str2fmt(*(++argv));
-        } else if (strcmp(*argv, &quot;-in&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            infile = *(++argv);
-        } else if (strcmp(*argv, &quot;-out&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            outfile = *(++argv);
-        }
-# ifndef OPENSSL_NO_ENGINE
-        else if (strcmp(*argv, &quot;-engine&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            engine = *(++argv);
-        }
+# ifndef OPENSSL_NO_DSA
+    {&quot;dsaparam&quot;, OPT_DSAPARAM, '-',
+     &quot;Read or generate DSA parameters, convert to DH&quot;},
 # endif
-        else if (strcmp(*argv, &quot;-check&quot;) == 0)
+    {NULL}
+};
+
+int dhparam_main(int argc, char **argv)
+{
+    BIO *in = NULL, *out = NULL;
+    DH *dh = NULL;
+    char *engine = NULL, *infile = NULL, *outfile = NULL, *prog, *inrand =
+        NULL;
+    int dsaparam = 0, i, text = 0, C = 0, ret = 1, num = 0, g = 0;
+    int informat = FORMAT_PEM, outformat = FORMAT_PEM, check = 0, noout = 0;
+    OPTION_CHOICE o;
+
+    prog = opt_init(argc, argv, dhparam_options);
+    while ((o = opt_next()) != OPT_EOF) {
+        switch (o) {
+        case OPT_EOF:
+        case OPT_ERR:
+ opthelp:
+            BIO_printf(bio_err, &quot;%s: Use -help for summary.\n&quot;, prog);
+            goto end;
+        case OPT_HELP:
+            opt_help(dhparam_options);
+            ret = 0;
+            goto end;
+        case OPT_INFORM:
+            if (!opt_format(opt_arg(), OPT_FMT_PEMDER, &amp;informat))
+                goto opthelp;
+            break;
+        case OPT_OUTFORM:
+            if (!opt_format(opt_arg(), OPT_FMT_PEMDER, &amp;outformat))
+                goto opthelp;
+            break;
+        case OPT_IN:
+            infile = opt_arg();
+            break;
+        case OPT_OUT:
+            outfile = opt_arg();
+            break;
+        case OPT_ENGINE:
+            engine = opt_arg();
+            break;
+        case OPT_CHECK:
             check = 1;
-        else if (strcmp(*argv, &quot;-text&quot;) == 0)
+            break;
+        case OPT_TEXT:
             text = 1;
-# ifndef OPENSSL_NO_DSA
-        else if (strcmp(*argv, &quot;-dsaparam&quot;) == 0)
+            break;
+        case OPT_DSAPARAM:
             dsaparam = 1;
-# endif
-        else if (strcmp(*argv, &quot;-C&quot;) == 0)
+            break;
+        case OPT_C:
             C = 1;
-        else if (strcmp(*argv, &quot;-noout&quot;) == 0)
-            noout = 1;
-        else if (strcmp(*argv, &quot;-2&quot;) == 0)
+            break;
+        case OPT_2:
             g = 2;
-        else if (strcmp(*argv, &quot;-5&quot;) == 0)
+            break;
+        case OPT_5:
             g = 5;
-        else if (strcmp(*argv, &quot;-rand&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            inrand = *(++argv);
-        } else if (((sscanf(*argv, &quot;%d&quot;, &amp;num) == 0) || (num &lt;= 0)))
-            goto bad;
-        argv++;
-        argc--;
+            break;
+        case OPT_NOOUT:
+            noout = 1;
+            break;
+        case OPT_RAND:
+            inrand = opt_arg();
+            break;
+        }
     }
+    argc = opt_num_rest();
+    argv = opt_rest();
 
-    if (badops) {
- bad:
-        BIO_printf(bio_err, &quot;%s [options] [numbits]\n&quot;, prog);
-        BIO_printf(bio_err, &quot;where options are\n&quot;);
-        BIO_printf(bio_err, &quot; -inform arg   input format - one of DER PEM\n&quot;);
-        BIO_printf(bio_err,
-                   &quot; -outform arg  output format - one of DER PEM\n&quot;);
-        BIO_printf(bio_err, &quot; -in arg       input file\n&quot;);
-        BIO_printf(bio_err, &quot; -out arg      output file\n&quot;);
-# ifndef OPENSSL_NO_DSA
-        BIO_printf(bio_err,
-                   &quot; -dsaparam     read or generate DSA parameters, convert to DH\n&quot;);
-# endif
-        BIO_printf(bio_err, &quot; -check        check the DH parameters\n&quot;);
-        BIO_printf(bio_err,
-                   &quot; -text         print a text form of the DH parameters\n&quot;);
-        BIO_printf(bio_err, &quot; -C            Output C code\n&quot;);
-        BIO_printf(bio_err,
-                   &quot; -2            generate parameters using  2 as the generator value\n&quot;);
-        BIO_printf(bio_err,
-                   &quot; -5            generate parameters using  5 as the generator value\n&quot;);
-        BIO_printf(bio_err,
-                   &quot; numbits       number of bits in to generate (default 2048)\n&quot;);
-# ifndef OPENSSL_NO_ENGINE
-        BIO_printf(bio_err,
-                   &quot; -engine e     use engine e, possibly a hardware device.\n&quot;);
-# endif
-        BIO_printf(bio_err, &quot; -rand file%cfile%c...\n&quot;, LIST_SEPARATOR_CHAR,
-                   LIST_SEPARATOR_CHAR);
-        BIO_printf(bio_err,
-                   &quot;               - load the file (or the files in the directory) into\n&quot;);
-        BIO_printf(bio_err, &quot;               the random number generator\n&quot;);
-        BIO_printf(bio_err, &quot; -noout        no output\n&quot;);
+    if (argv[0] &amp;&amp; (!opt_int(argv[0], &amp;num) || num &lt;= 0))
         goto end;
-    }
-
-    ERR_load_crypto_strings();
 
 # ifndef OPENSSL_NO_ENGINE
-    setup_engine(bio_err, engine, 0);
+    setup_engine(engine, 0);
 # endif
 
     if (g &amp;&amp; !num)
         num = DEFBITS;
 
 # ifndef OPENSSL_NO_DSA
-    if (dsaparam) {
-        if (g) {
-            BIO_printf(bio_err,
-                       &quot;generator may not be chosen for DSA parameters\n&quot;);
-            goto end;
-        }
-    } else
-# endif
-    {
-        /* DH parameters */
-        if (num &amp;&amp; !g)
-            g = 2;
+    if (dsaparam &amp;&amp; g) {
+        BIO_printf(bio_err,
+                   &quot;generator may not be chosen for DSA parameters\n&quot;);
+        goto end;
     }
+# endif
+    /* DH parameters */
+    if (num &amp;&amp; !g)
+        g = 2;
 
     if (num) {
 
@@ -302,7 +262,7 @@ int MAIN(int argc, char **argv)
         }
 
         BN_GENCB_set(cb, dh_cb, bio_err);
-        if (!app_RAND_load_file(NULL, bio_err, 1) &amp;&amp; inrand == NULL) {
+        if (!app_RAND_load_file(NULL, 1) &amp;&amp; inrand == NULL) {
             BIO_printf(bio_err,
                        &quot;warning, not much extra random data, consider using the -rand option\n&quot;);
         }
@@ -348,27 +308,13 @@ int MAIN(int argc, char **argv)
         }
 
         BN_GENCB_free(cb);
-        app_RAND_write_file(NULL, bio_err);
+        app_RAND_write_file(NULL);
     } else {
 
-        in = BIO_new(BIO_s_file());
-        if (in == NULL) {
-            ERR_print_errors(bio_err);
+        in = bio_open_default(infile, RB(informat));
+        if (in == NULL)
             goto end;
-        }
-        if (infile == NULL)
-            BIO_set_fp(in, stdin, BIO_NOCLOSE);
-        else {
-            if (BIO_read_filename(in, infile) &lt;= 0) {
-                perror(infile);
-                goto end;
-            }
-        }
 
-        if (informat != FORMAT_ASN1 &amp;&amp; informat != FORMAT_PEM) {
-            BIO_printf(bio_err, &quot;bad input format specified\n&quot;);
-            goto end;
-        }
 # ifndef OPENSSL_NO_DSA
         if (dsaparam) {
             DSA *dsa;
@@ -408,25 +354,9 @@ int MAIN(int argc, char **argv)
         /* dh != NULL */
     }
 
-    out = BIO_new(BIO_s_file());
-    if (out == NULL) {
-        ERR_print_errors(bio_err);
+    out = bio_open_default(outfile, &quot;w&quot;);
+    if (out == NULL)
         goto end;
-    }
-    if (outfile == NULL) {
-        BIO_set_fp(out, stdout, BIO_NOCLOSE);
-# ifdef OPENSSL_SYS_VMS
-        {
-            BIO *tmpbio = BIO_new(BIO_f_linebuffer());
-            out = BIO_push(tmpbio, out);
-        }
-# endif
-    } else {
-        if (BIO_write_filename(out, outfile) &lt;= 0) {
-            perror(outfile);
-            goto end;
-        }
-    }
 
     if (text) {
         DHparams_print(out, dh);
@@ -450,7 +380,7 @@ int MAIN(int argc, char **argv)
     }
     if (C) {
         unsigned char *data;
-        int len, l, bits;
+        int len, bits;
 
         len = BN_num_bytes(dh-&gt;p);
         bits = BN_num_bits(dh-&gt;p);
@@ -459,54 +389,39 @@ int MAIN(int argc, char **argv)
             perror(&quot;OPENSSL_malloc&quot;);
             goto end;
         }
-        printf(&quot;#ifndef HEADER_DH_H\n&quot;
-               &quot;#include &lt;openssl/dh.h&gt;\n&quot; &quot;#endif\n&quot;);
-        printf(&quot;DH *get_dh%d()\n\t{\n&quot;, bits);
-
-        l = BN_bn2bin(dh-&gt;p, data);
-        printf(&quot;\tstatic unsigned char dh%d_p[]={&quot;, bits);
-        for (i = 0; i &lt; l; i++) {
-            if ((i % 12) == 0)
-                printf(&quot;\n\t\t&quot;);
-            printf(&quot;0x%02X,&quot;, data[i]);
-        }
-        printf(&quot;\n\t\t};\n&quot;);
-
-        l = BN_bn2bin(dh-&gt;g, data);
-        printf(&quot;\tstatic unsigned char dh%d_g[]={&quot;, bits);
-        for (i = 0; i &lt; l; i++) {
-            if ((i % 12) == 0)
-                printf(&quot;\n\t\t&quot;);
-            printf(&quot;0x%02X,&quot;, data[i]);
-        }
-        printf(&quot;\n\t\t};\n&quot;);
-
-        printf(&quot;\tDH *dh;\n\n&quot;);
-        printf(&quot;\tif ((dh=DH_new()) == NULL) return(NULL);\n&quot;);
-        printf(&quot;\tdh-&gt;p=BN_bin2bn(dh%d_p,sizeof(dh%d_p),NULL);\n&quot;,
+        BIO_printf(out, &quot;#ifndef HEADER_DH_H\n&quot;
+                        &quot;# include &lt;openssl/dh.h&gt;\n&quot;
+                        &quot;#endif\n&quot;
+                        &quot;\n&quot;);
+        BIO_printf(out, &quot;DH *get_dh%d()\n{\n&quot;, bits);
+        print_bignum_var(out, dh-&gt;p, &quot;dhp&quot;, bits, data);
+        print_bignum_var(out, dh-&gt;g, &quot;dhg&quot;, bits, data);
+        BIO_printf(out, &quot;    DH *dh = DN_new();\n&quot;
+                        &quot;\n&quot;
+                        &quot;    if (dh == NULL)\n&quot;
+                        &quot;        return NULL;\n&quot;);
+        BIO_printf(out, &quot;    dh-&gt;p = BN_bin2bn(dhp_%d, sizeof (dhp_%d), NULL);\n&quot;,
                bits, bits);
-        printf(&quot;\tdh-&gt;g=BN_bin2bn(dh%d_g,sizeof(dh%d_g),NULL);\n&quot;,
+        BIO_printf(out, &quot;    dh-&gt;g = BN_bin2bn(dhg_%d, sizeof (dhg_%d), NULL);\n&quot;,
                bits, bits);
-        printf(&quot;\tif ((dh-&gt;p == NULL) || (dh-&gt;g == NULL))\n&quot;);
-        printf(&quot;\t\t{ DH_free(dh); return(NULL); }\n&quot;);
+        BIO_printf(out, &quot;    if (!dh-&gt;p || !dh-&gt;g) {\n&quot;
+                        &quot;        DH_free(dh);\n&quot;
+                        &quot;        return NULL;\n&quot;
+                        &quot;    }\n&quot;);
         if (dh-&gt;length)
-            printf(&quot;\tdh-&gt;length = %ld;\n&quot;, dh-&gt;length);
-        printf(&quot;\treturn(dh);\n\t}\n&quot;);
+            BIO_printf(out,
+                        &quot;    dh-&gt;length = %ld;\n&quot;, dh-&gt;length);
+        BIO_printf(out, &quot;    return dh;\n}\n&quot;);
         OPENSSL_free(data);
     }
 
     if (!noout) {
         if (outformat == FORMAT_ASN1)
             i = i2d_DHparams_bio(out, dh);
-        else if (outformat == FORMAT_PEM) {
-            if (dh-&gt;q)
-                i = PEM_write_bio_DHxparams(out, dh);
-            else
-                i = PEM_write_bio_DHparams(out, dh);
-        } else {
-            BIO_printf(bio_err, &quot;bad output format specified for outfile\n&quot;);
-            goto end;
-        }
+        else if (dh-&gt;q)
+            i = PEM_write_bio_DHxparams(out, dh);
+        else
+            i = PEM_write_bio_DHparams(out, dh);
         if (!i) {
             BIO_printf(bio_err, &quot;unable to write DH parameters\n&quot;);
             ERR_print_errors(bio_err);
@@ -518,11 +433,9 @@ int MAIN(int argc, char **argv)
     BIO_free(in);
     BIO_free_all(out);
     DH_free(dh);
-    apps_shutdown();
-    OPENSSL_EXIT(ret);
+    return (ret);
 }
 
-/* dh_cb is identical to dsa_cb in apps/dsaparam.c */
 static int dh_cb(int p, int n, BN_GENCB *cb)
 {
     char c = '*';
diff --git a/apps/dsa.c b/apps/dsa.c
index 1ea0d73..9d7c97f 100644
--- a/apps/dsa.c
+++ b/apps/dsa.c
@@ -1,4 +1,3 @@
-/* apps/dsa.c */
 /* Copyright (C) 1995-1998 Eric Young (<A HREF="../../../mailman/listinfo/openssl-commits.html">eay at cryptsoft.com</A>)
  * All rights reserved.
  *
@@ -71,214 +70,145 @@
 # include &lt;openssl/pem.h&gt;
 # include &lt;openssl/bn.h&gt;
 
-# undef PROG
-# define PROG    dsa_main
+typedef enum OPTION_choice {
+    OPT_ERR = -1, OPT_EOF = 0, OPT_HELP,
+    OPT_INFORM, OPT_OUTFORM, OPT_IN, OPT_OUT,
+    OPT_ENGINE, OPT_PVK_STRONG, OPT_PVK_WEAK,
+    OPT_PVK_NONE, OPT_NOOUT, OPT_TEXT, OPT_MODULUS, OPT_PUBIN,
+    OPT_PUBOUT, OPT_CIPHER, OPT_PASSIN, OPT_PASSOUT
+} OPTION_CHOICE;
 
-/*-
- * -inform arg  - input format - default PEM (one of DER, NET or PEM)
- * -outform arg - output format - default PEM
- * -in arg      - input file - default stdin
- * -out arg     - output file - default stdout
- * -des         - encrypt output if PEM format with DES in cbc mode
- * -des3        - encrypt output if PEM format
- * -idea        - encrypt output if PEM format
- * -aes128      - encrypt output if PEM format
- * -aes192      - encrypt output if PEM format
- * -aes256      - encrypt output if PEM format
- * -camellia128 - encrypt output if PEM format
- * -camellia192 - encrypt output if PEM format
- * -camellia256 - encrypt output if PEM format
- * -seed        - encrypt output if PEM format
- * -text        - print a text version
- * -modulus     - print the DSA public key
- */
-
-int MAIN(int, char **);
+OPTIONS dsa_options[] = {
+    {&quot;help&quot;, OPT_HELP, '-', &quot;Display this summary&quot;},
+    {&quot;inform&quot;, OPT_INFORM, 'F', &quot;Input format, DER PEM PVK&quot;},
+    {&quot;outform&quot;, OPT_OUTFORM, 'F', &quot;Output format, DER PEM PVK&quot;},
+# ifndef OPENSSL_NO_ENGINE
+    {&quot;engine&quot;, OPT_ENGINE, 's', &quot;Use engine e, possibly a hardware device&quot;},
+# endif
+    {&quot;in&quot;, OPT_IN, '&lt;', &quot;Input file&quot;},
+    {&quot;out&quot;, OPT_OUT, '&gt;', &quot;Output file&quot;},
+    {&quot;pvk-strong&quot;, OPT_PVK_STRONG, '-'},
+    {&quot;pvk-weak&quot;, OPT_PVK_WEAK, '-'},
+    {&quot;pvk-none&quot;, OPT_PVK_NONE, '-'},
+    {&quot;noout&quot;, OPT_NOOUT, '-', &quot;Don't print key out&quot;},
+    {&quot;text&quot;, OPT_TEXT, '-', &quot;Print the key in text&quot;},
+    {&quot;modulus&quot;, OPT_MODULUS, '-', &quot;Print the DSA public value&quot;},
+    {&quot;pubin&quot;, OPT_PUBIN, '-'},
+    {&quot;pubout&quot;, OPT_PUBOUT, '-'},
+    {&quot;passin&quot;, OPT_PASSIN, 's', &quot;Input file pass phrase source&quot;},
+    {&quot;passout&quot;, OPT_PASSOUT, 's', &quot;Output file pass phrase source&quot;},
+    {&quot;&quot;, OPT_CIPHER, '-', &quot;Any supported cipher&quot;},
+    {NULL}
+};
 
-int MAIN(int argc, char **argv)
+int dsa_main(int argc, char **argv)
 {
-    ENGINE *e = NULL;
-    int ret = 1;
+    BIO *out = NULL;
     DSA *dsa = NULL;
-    int i, badops = 0;
+    ENGINE *e = NULL;
     const EVP_CIPHER *enc = NULL;
-    BIO *in = NULL, *out = NULL;
-    int informat, outformat, text = 0, noout = 0;
-    int pubin = 0, pubout = 0;
-    char *infile, *outfile, *prog;
-# ifndef OPENSSL_NO_ENGINE
-    char *engine;
-# endif
-    char *passargin = NULL, *passargout = NULL;
-    char *passin = NULL, *passout = NULL;
-    int modulus = 0;
+    char *engine = NULL, *infile = NULL, *outfile = NULL, *prog;
+    char *passin = NULL, *passout = NULL, *passinarg = NULL, *passoutarg =
+        NULL;
+    OPTION_CHOICE o;
+    int informat = FORMAT_PEM, outformat = FORMAT_PEM, text = 0, noout = 0;
+    int i, modulus = 0, pubin = 0, pubout = 0, pvk_encr = 2, ret = 1;
 
-#ifndef OPENSSL_NO_RC4
-    int pvk_encr = 2;
+    prog = opt_init(argc, argv, dsa_options);
+    while ((o = opt_next()) != OPT_EOF) {
+        switch (o) {
+        case OPT_EOF:
+        case OPT_ERR:
+#ifdef OPENSSL_NO_RC4
+        case OPT_PVK_STRONG:
+        case OPT_PVK_WEAK:
+        case OPT_PVK_NONE:
 #endif
-
-    apps_startup();
-
-    if (bio_err == NULL)
-        if ((bio_err = BIO_new(BIO_s_file())) != NULL)
-            BIO_set_fp(bio_err, stderr, BIO_NOCLOSE | BIO_FP_TEXT);
-
-    if (!load_config(bio_err, NULL))
-        goto end;
-
-# ifndef OPENSSL_NO_ENGINE
-    engine = NULL;
-# endif
-    infile = NULL;
-    outfile = NULL;
-    informat = FORMAT_PEM;
-    outformat = FORMAT_PEM;
-
-    prog = argv[0];
-    argc--;
-    argv++;
-    while (argc &gt;= 1) {
-        if (strcmp(*argv, &quot;-inform&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            informat = str2fmt(*(++argv));
-        } else if (strcmp(*argv, &quot;-outform&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            outformat = str2fmt(*(++argv));
-        } else if (strcmp(*argv, &quot;-in&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            infile = *(++argv);
-        } else if (strcmp(*argv, &quot;-out&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            outfile = *(++argv);
-        } else if (strcmp(*argv, &quot;-passin&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            passargin = *(++argv);
-        } else if (strcmp(*argv, &quot;-passout&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            passargout = *(++argv);
-        }
-# ifndef OPENSSL_NO_ENGINE
-        else if (strcmp(*argv, &quot;-engine&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            engine = *(++argv);
-        }
-# endif
+ opthelp:
+            ret = 0;
+            BIO_printf(bio_err, &quot;%s: Use -help for summary.\n&quot;, prog);
+            goto end;
+        case OPT_HELP:
+            opt_help(dsa_options);
+            ret = 0;
+            goto end;
+        case OPT_INFORM:
+            if (!opt_format
+                (opt_arg(), OPT_FMT_PEMDER | OPT_FMT_PVK, &amp;informat))
+                goto opthelp;
+            break;
+        case OPT_IN:
+            infile = opt_arg();
+            break;
+        case OPT_OUTFORM:
+            if (!opt_format
+                (opt_arg(), OPT_FMT_PEMDER | OPT_FMT_PVK, &amp;outformat))
+                goto opthelp;
+            break;
+        case OPT_OUT:
+            outfile = opt_arg();
+            break;
+        case OPT_ENGINE:
+            engine = opt_arg();
+            break;
+        case OPT_PASSIN:
+            passinarg = opt_arg();
+            break;
+        case OPT_PASSOUT:
+            passoutarg = opt_arg();
+            break;
 #ifndef OPENSSL_NO_RC4
-        else if (strcmp(*argv, &quot;-pvk-strong&quot;) == 0)
+        case OPT_PVK_STRONG:
             pvk_encr = 2;
-        else if (strcmp(*argv, &quot;-pvk-weak&quot;) == 0)
+            break;
+        case OPT_PVK_WEAK:
             pvk_encr = 1;
-        else if (strcmp(*argv, &quot;-pvk-none&quot;) == 0)
+            break;
+        case OPT_PVK_NONE:
             pvk_encr = 0;
+            break;
 #endif
-        else if (strcmp(*argv, &quot;-noout&quot;) == 0)
+        case OPT_NOOUT:
             noout = 1;
-        else if (strcmp(*argv, &quot;-text&quot;) == 0)
+            break;
+        case OPT_TEXT:
             text = 1;
-        else if (strcmp(*argv, &quot;-modulus&quot;) == 0)
+            break;
+        case OPT_MODULUS:
             modulus = 1;
-        else if (strcmp(*argv, &quot;-pubin&quot;) == 0)
+            break;
+        case OPT_PUBIN:
             pubin = 1;
-        else if (strcmp(*argv, &quot;-pubout&quot;) == 0)
+            break;
+        case OPT_PUBOUT:
             pubout = 1;
-        else if ((enc = EVP_get_cipherbyname(&amp;(argv[0][1]))) == NULL) {
-            BIO_printf(bio_err, &quot;unknown option %s\n&quot;, *argv);
-            badops = 1;
+            break;
+        case OPT_CIPHER:
+            if (!opt_cipher(opt_unknown(), &amp;enc))
+                goto end;
             break;
         }
-        argc--;
-        argv++;
-    }
-
-    if (badops) {
- bad:
-        BIO_printf(bio_err, &quot;%s [options] &lt;infile &gt;outfile\n&quot;, prog);
-        BIO_printf(bio_err, &quot;where options are\n&quot;);
-        BIO_printf(bio_err, &quot; -inform arg     input format - DER or PEM\n&quot;);
-        BIO_printf(bio_err, &quot; -outform arg    output format - DER or PEM\n&quot;);
-        BIO_printf(bio_err, &quot; -in arg         input file\n&quot;);
-        BIO_printf(bio_err,
-                   &quot; -passin arg     input file pass phrase source\n&quot;);
-        BIO_printf(bio_err, &quot; -out arg        output file\n&quot;);
-        BIO_printf(bio_err,
-                   &quot; -passout arg    output file pass phrase source\n&quot;);
-# ifndef OPENSSL_NO_ENGINE
-        BIO_printf(bio_err,
-                   &quot; -engine e       use engine e, possibly a hardware device.\n&quot;);
-# endif
-        BIO_printf(bio_err,
-                   &quot; -des            encrypt PEM output with cbc des\n&quot;);
-        BIO_printf(bio_err,
-                   &quot; -des3           encrypt PEM output with ede cbc des using 168 bit key\n&quot;);
-# ifndef OPENSSL_NO_IDEA
-        BIO_printf(bio_err,
-                   &quot; -idea           encrypt PEM output with cbc idea\n&quot;);
-# endif
-# ifndef OPENSSL_NO_AES
-        BIO_printf(bio_err, &quot; -aes128, -aes192, -aes256\n&quot;);
-        BIO_printf(bio_err,
-                   &quot;                 encrypt PEM output with cbc aes\n&quot;);
-# endif
-# ifndef OPENSSL_NO_CAMELLIA
-        BIO_printf(bio_err, &quot; -camellia128, -camellia192, -camellia256\n&quot;);
-        BIO_printf(bio_err,
-                   &quot;                 encrypt PEM output with cbc camellia\n&quot;);
-# endif
-# ifndef OPENSSL_NO_SEED
-        BIO_printf(bio_err,
-                   &quot; -seed           encrypt PEM output with cbc seed\n&quot;);
-# endif
-        BIO_printf(bio_err, &quot; -text           print the key in text\n&quot;);
-        BIO_printf(bio_err, &quot; -noout          don't print key out\n&quot;);
-        BIO_printf(bio_err, &quot; -modulus        print the DSA public value\n&quot;);
-        goto end;
     }
-
-    ERR_load_crypto_strings();
+    argc = opt_num_rest();
+    argv = opt_rest();
 
 # ifndef OPENSSL_NO_ENGINE
-    e = setup_engine(bio_err, engine, 0);
+    e = setup_engine(engine, 0);
 # endif
 
-    if (!app_passwd(bio_err, passargin, passargout, &amp;passin, &amp;passout)) {
+    if (!app_passwd(passinarg, passoutarg, &amp;passin, &amp;passout)) {
         BIO_printf(bio_err, &quot;Error getting passwords\n&quot;);
         goto end;
     }
 
-    in = BIO_new(BIO_s_file());
-    out = BIO_new(BIO_s_file());
-    if ((in == NULL) || (out == NULL)) {
-        ERR_print_errors(bio_err);
-        goto end;
-    }
-
-    if (infile == NULL)
-        BIO_set_fp(in, stdin, BIO_NOCLOSE);
-    else {
-        if (BIO_read_filename(in, infile) &lt;= 0) {
-            perror(infile);
-            goto end;
-        }
-    }
-
     BIO_printf(bio_err, &quot;read DSA key\n&quot;);
-
     {
         EVP_PKEY *pkey;
 
         if (pubin)
-            pkey = load_pubkey(bio_err, infile, informat, 1,
-                               passin, e, &quot;Public Key&quot;);
+            pkey = load_pubkey(infile, informat, 1, passin, e, &quot;Public Key&quot;);
         else
-            pkey = load_key(bio_err, infile, informat, 1,
-                            passin, e, &quot;Private Key&quot;);
+            pkey = load_key(infile, informat, 1, passin, e, &quot;Private Key&quot;);
 
         if (pkey) {
             dsa = EVP_PKEY_get1_DSA(pkey);
@@ -291,20 +221,9 @@ int MAIN(int argc, char **argv)
         goto end;
     }
 
-    if (outfile == NULL) {
-        BIO_set_fp(out, stdout, BIO_NOCLOSE);
-# ifdef OPENSSL_SYS_VMS
-        {
-            BIO *tmpbio = BIO_new(BIO_f_linebuffer());
-            out = BIO_push(tmpbio, out);
-        }
-# endif
-    } else {
-        if (BIO_write_filename(out, outfile) &lt;= 0) {
-            perror(outfile);
-            goto end;
-        }
-    }
+    out = bio_open_default(outfile, &quot;w&quot;);
+    if (out == NULL)
+        goto end;
 
     if (text)
         if (!DSA_print(out, dsa, 0)) {
@@ -314,13 +233,15 @@ int MAIN(int argc, char **argv)
         }
 
     if (modulus) {
-        fprintf(stdout, &quot;Public Key=&quot;);
+        BIO_printf(out, &quot;Public Key=&quot;);
         BN_print(out, dsa-&gt;pub_key);
-        fprintf(stdout, &quot;\n&quot;);
+        BIO_printf(out, &quot;\n&quot;);
     }
 
-    if (noout)
+    if (noout) {
+        ret = 0;
         goto end;
+    }
     BIO_printf(bio_err, &quot;writing DSA key\n&quot;);
     if (outformat == FORMAT_ASN1) {
         if (pubin || pubout)
@@ -353,18 +274,17 @@ int MAIN(int argc, char **argv)
     if (i &lt;= 0) {
         BIO_printf(bio_err, &quot;unable to write private key\n&quot;);
         ERR_print_errors(bio_err);
-    } else
-        ret = 0;
+        goto end;
+    }
+    ret = 0;
  end:
-    BIO_free(in);
     BIO_free_all(out);
     DSA_free(dsa);
     if (passin)
         OPENSSL_free(passin);
     if (passout)
         OPENSSL_free(passout);
-    apps_shutdown();
-    OPENSSL_EXIT(ret);
+    return (ret);
 }
 #else                           /* !OPENSSL_NO_DSA */
 
diff --git a/apps/dsaparam.c b/apps/dsaparam.c
index f63ecb2..b314409 100644
--- a/apps/dsaparam.c
+++ b/apps/dsaparam.c
@@ -1,4 +1,3 @@
-/* apps/dsaparam.c */
 /* Copyright (C) 1995-1998 Eric Young (<A HREF="../../../mailman/listinfo/openssl-commits.html">eay at cryptsoft.com</A>)
  * All rights reserved.
  *
@@ -72,24 +71,6 @@
 # include &lt;openssl/x509.h&gt;
 # include &lt;openssl/pem.h&gt;
 
-# undef PROG
-# define PROG    dsaparam_main
-
-/*-
- * -inform arg  - input format - default PEM (DER or PEM)
- * -outform arg - output format - default PEM
- * -in arg      - input file - default stdin
- * -out arg     - output file - default stdout
- * -noout
- * -text
- * -C
- * -noout
- * -genkey
- *  #ifdef GENCB_TEST
- * -timebomb n  - interrupt keygen after &lt;n&gt; seconds
- *  #endif
- */
-
 # ifdef GENCB_TEST
 
 static int stop_keygen_flag = 0;
@@ -103,169 +84,129 @@ static void timebomb_sigalarm(int foo)
 
 static int dsa_cb(int p, int n, BN_GENCB *cb);
 
-int MAIN(int, char **);
+typedef enum OPTION_choice {
+    OPT_ERR = -1, OPT_EOF = 0, OPT_HELP,
+    OPT_INFORM, OPT_OUTFORM, OPT_IN, OPT_OUT, OPT_TEXT, OPT_C,
+    OPT_NOOUT, OPT_GENKEY, OPT_RAND, OPT_NON_FIPS_ALLOW, OPT_ENGINE,
+    OPT_TIMEBOMB
+} OPTION_CHOICE;
+
+OPTIONS dsaparam_options[] = {
+    {&quot;help&quot;, OPT_HELP, '-', &quot;Display this summary&quot;},
+    {&quot;inform&quot;, OPT_INFORM, 'F', &quot;Input format - DER or PEM&quot;},
+    {&quot;in&quot;, OPT_IN, '&lt;', &quot;Input file&quot;},
+    {&quot;outform&quot;, OPT_OUTFORM, 'F', &quot;Output format - DER or PEM&quot;},
+    {&quot;out&quot;, OPT_OUT, '&gt;', &quot;Output file&quot;},
+    {&quot;text&quot;, OPT_TEXT, '-', &quot;Print as text&quot;},
+    {&quot;C&quot;, OPT_C, '-', &quot;Output C code&quot;},
+    {&quot;noout&quot;, OPT_NOOUT, '-', &quot;No output&quot;},
+    {&quot;genkey&quot;, OPT_GENKEY, '-', &quot;Generate a DSA key&quot;},
+    {&quot;rand&quot;, OPT_RAND, 's', &quot;Files to use for random number input&quot;},
+    {&quot;non-fips-allow&quot;, OPT_NON_FIPS_ALLOW, '-'},
+# ifndef OPENSSL_NO_ENGINE
+    {&quot;engine&quot;, OPT_ENGINE, 's', &quot;Use engine e, possibly a hardware device&quot;},
+# endif
+# ifdef GENCB_TEST
+    {&quot;timebomb&quot;, OPT_TIMEBOMB, 'p', &quot;Interrupt keygen after 'pnum' seconds&quot;},
+# endif
+    {NULL}
+};
 
-int MAIN(int argc, char **argv)
+int dsaparam_main(int argc, char **argv)
 {
     DSA *dsa = NULL;
-    int i, badops = 0, text = 0;
     BIO *in = NULL, *out = NULL;
-    int informat, outformat, noout = 0, C = 0, ret = 1;
-    char *infile, *outfile, *prog, *inrand = NULL;
-    int numbits = -1, num, genkey = 0;
-    int need_rand = 0;
-    int non_fips_allow = 0;
     BN_GENCB *cb = NULL;
-# ifndef OPENSSL_NO_ENGINE
-    char *engine = NULL;
-# endif
+    int numbits = -1, num, genkey = 0, need_rand = 0, non_fips_allow = 0;
+    int informat = FORMAT_PEM, outformat = FORMAT_PEM, noout = 0, C = 0, ret =
+        1;
+    int i, text = 0;
 # ifdef GENCB_TEST
     int timebomb = 0;
 # endif
-
-    apps_startup();
-
-    if (bio_err == NULL)
-        if ((bio_err = BIO_new(BIO_s_file())) != NULL)
-            BIO_set_fp(bio_err, stderr, BIO_NOCLOSE | BIO_FP_TEXT);
-
-    if (!load_config(bio_err, NULL))
-        goto end;
-
-    infile = NULL;
-    outfile = NULL;
-    informat = FORMAT_PEM;
-    outformat = FORMAT_PEM;
-
-    prog = argv[0];
-    argc--;
-    argv++;
-    while (argc &gt;= 1) {
-        if (strcmp(*argv, &quot;-inform&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            informat = str2fmt(*(++argv));
-        } else if (strcmp(*argv, &quot;-outform&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            outformat = str2fmt(*(++argv));
-        } else if (strcmp(*argv, &quot;-in&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            infile = *(++argv);
-        } else if (strcmp(*argv, &quot;-out&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            outfile = *(++argv);
-        }
-# ifndef OPENSSL_NO_ENGINE
-        else if (strcmp(*argv, &quot;-engine&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            engine = *(++argv);
-        }
-# endif
+    char *infile = NULL, *outfile = NULL, *prog, *inrand = NULL, *engine =
+        NULL;
+    OPTION_CHOICE o;
+
+    prog = opt_init(argc, argv, dsaparam_options);
+    while ((o = opt_next()) != OPT_EOF) {
+        switch (o) {
+        case OPT_EOF:
+        case OPT_ERR:
+ opthelp:
+            BIO_printf(bio_err, &quot;%s: Use -help for summary.\n&quot;, prog);
+            goto end;
+        case OPT_HELP:
+            opt_help(dsaparam_options);
+            ret = 0;
+            goto end;
+        case OPT_INFORM:
+            if (!opt_format(opt_arg(), OPT_FMT_PEMDER, &amp;informat))
+                goto opthelp;
+            break;
+        case OPT_IN:
+            infile = opt_arg();
+            break;
+        case OPT_OUTFORM:
+            if (!opt_format(opt_arg(), OPT_FMT_PEMDER, &amp;outformat))
+                goto opthelp;
+            break;
+        case OPT_OUT:
+            outfile = opt_arg();
+            break;
+        case OPT_ENGINE:
+            engine = opt_arg();
+            break;
+        case OPT_TIMEBOMB:
 # ifdef GENCB_TEST
-        else if (strcmp(*argv, &quot;-timebomb&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            timebomb = atoi(*(++argv));
-        }
+            timebomb = atoi(opt_arg());
+            break;
 # endif
-        else if (strcmp(*argv, &quot;-text&quot;) == 0)
+        case OPT_TEXT:
             text = 1;
-        else if (strcmp(*argv, &quot;-C&quot;) == 0)
+            break;
+        case OPT_C:
             C = 1;
-        else if (strcmp(*argv, &quot;-genkey&quot;) == 0) {
-            genkey = 1;
-            need_rand = 1;
-        } else if (strcmp(*argv, &quot;-rand&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            inrand = *(++argv);
+            break;
+        case OPT_GENKEY:
+            genkey = need_rand = 1;
+            break;
+        case OPT_RAND:
+            inrand = opt_arg();
             need_rand = 1;
-        } else if (strcmp(*argv, &quot;-noout&quot;) == 0)
+            break;
+        case OPT_NOOUT:
             noout = 1;
-        else if (strcmp(*argv, &quot;-non-fips-allow&quot;) == 0)
+            break;
+        case OPT_NON_FIPS_ALLOW:
             non_fips_allow = 1;
-        else if (sscanf(*argv, &quot;%d&quot;, &amp;num) == 1) {
-            /* generate a key */
-            numbits = num;
-            need_rand = 1;
-        } else {
-            BIO_printf(bio_err, &quot;unknown option %s\n&quot;, *argv);
-            badops = 1;
             break;
         }
-        argc--;
-        argv++;
     }
+    argc = opt_num_rest();
+    argv = opt_rest();
 
-    if (badops) {
- bad:
-        BIO_printf(bio_err, &quot;%s [options] [bits] &lt;infile &gt;outfile\n&quot;, prog);
-        BIO_printf(bio_err, &quot;where options are\n&quot;);
-        BIO_printf(bio_err, &quot; -inform arg   input format - DER or PEM\n&quot;);
-        BIO_printf(bio_err, &quot; -outform arg  output format - DER or PEM\n&quot;);
-        BIO_printf(bio_err, &quot; -in arg       input file\n&quot;);
-        BIO_printf(bio_err, &quot; -out arg      output file\n&quot;);
-        BIO_printf(bio_err, &quot; -text         print as text\n&quot;);
-        BIO_printf(bio_err, &quot; -C            Output C code\n&quot;);
-        BIO_printf(bio_err, &quot; -noout        no output\n&quot;);
-        BIO_printf(bio_err, &quot; -genkey       generate a DSA key\n&quot;);
-        BIO_printf(bio_err,
-                   &quot; -rand         files to use for random number input\n&quot;);
-# ifndef OPENSSL_NO_ENGINE
-        BIO_printf(bio_err,
-                   &quot; -engine e     use engine e, possibly a hardware device.\n&quot;);
-# endif
-# ifdef GENCB_TEST
-        BIO_printf(bio_err,
-                   &quot; -timebomb n   interrupt keygen after &lt;n&gt; seconds\n&quot;);
-# endif
-        BIO_printf(bio_err,
-                   &quot; number        number of bits to use for generating private key\n&quot;);
-        goto end;
+    if (argc == 1) {
+        if (!opt_int(argv[0], &amp;num))
+            goto end;
+        /* generate a key */
+        numbits = num;
+        need_rand = 1;
     }
 
-    ERR_load_crypto_strings();
-
-    in = BIO_new(BIO_s_file());
-    out = BIO_new(BIO_s_file());
-    if ((in == NULL) || (out == NULL)) {
-        ERR_print_errors(bio_err);
+    in = bio_open_default(infile, &quot;r&quot;);
+    if (in == NULL)
+        goto end;
+    out = bio_open_default(outfile, &quot;w&quot;);
+    if (out == NULL)
         goto end;
-    }
-
-    if (infile == NULL)
-        BIO_set_fp(in, stdin, BIO_NOCLOSE);
-    else {
-        if (BIO_read_filename(in, infile) &lt;= 0) {
-            perror(infile);
-            goto end;
-        }
-    }
-    if (outfile == NULL) {
-        BIO_set_fp(out, stdout, BIO_NOCLOSE);
-# ifdef OPENSSL_SYS_VMS
-        {
-            BIO *tmpbio = BIO_new(BIO_f_linebuffer());
-            out = BIO_push(tmpbio, out);
-        }
-# endif
-    } else {
-        if (BIO_write_filename(out, outfile) &lt;= 0) {
-            perror(outfile);
-            goto end;
-        }
-    }
 
 # ifndef OPENSSL_NO_ENGINE
-    setup_engine(bio_err, engine, 0);
+    setup_engine(engine, 0);
 # endif
 
     if (need_rand) {
-        app_RAND_load_file(NULL, bio_err, (inrand != NULL));
+        app_RAND_load_file(NULL, (inrand != NULL));
         if (inrand != NULL)
             BIO_printf(bio_err, &quot;%ld semi-random bytes loaded\n&quot;,
                        app_RAND_load_files(inrand));
@@ -319,12 +260,8 @@ int MAIN(int argc, char **argv)
         }
     } else if (informat == FORMAT_ASN1)
         dsa = d2i_DSAparams_bio(in, NULL);
-    else if (informat == FORMAT_PEM)
+    else
         dsa = PEM_read_bio_DSAparams(in, NULL, NULL, NULL);
-    else {
-        BIO_printf(bio_err, &quot;bad input format specified\n&quot;);
-        goto end;
-    }
     if (dsa == NULL) {
         BIO_printf(bio_err, &quot;unable to load DSA parameters\n&quot;);
         ERR_print_errors(bio_err);
@@ -337,7 +274,7 @@ int MAIN(int argc, char **argv)
 
     if (C) {
         unsigned char *data;
-        int l, len, bits_p;
+        int len, bits_p;
 
         len = BN_num_bytes(dsa-&gt;p);
         bits_p = BN_num_bits(dsa-&gt;p);
@@ -346,57 +283,33 @@ int MAIN(int argc, char **argv)
             perror(&quot;OPENSSL_malloc&quot;);
             goto end;
         }
-        l = BN_bn2bin(dsa-&gt;p, data);
-        printf(&quot;static unsigned char dsa%d_p[]={&quot;, bits_p);
-        for (i = 0; i &lt; l; i++) {
-            if ((i % 12) == 0)
-                printf(&quot;\n\t&quot;);
-            printf(&quot;0x%02X,&quot;, data[i]);
-        }
-        printf(&quot;\n\t};\n&quot;);
-
-        l = BN_bn2bin(dsa-&gt;q, data);
-        printf(&quot;static unsigned char dsa%d_q[]={&quot;, bits_p);
-        for (i = 0; i &lt; l; i++) {
-            if ((i % 12) == 0)
-                printf(&quot;\n\t&quot;);
-            printf(&quot;0x%02X,&quot;, data[i]);
-        }
-        printf(&quot;\n\t};\n&quot;);
-
-        l = BN_bn2bin(dsa-&gt;g, data);
-        printf(&quot;static unsigned char dsa%d_g[]={&quot;, bits_p);
-        for (i = 0; i &lt; l; i++) {
-            if ((i % 12) == 0)
-                printf(&quot;\n\t&quot;);
-            printf(&quot;0x%02X,&quot;, data[i]);
-        }
-        printf(&quot;\n\t};\n\n&quot;);
 
-        printf(&quot;DSA *get_dsa%d()\n\t{\n&quot;, bits_p);
-        printf(&quot;\tDSA *dsa;\n\n&quot;);
-        printf(&quot;\tif ((dsa=DSA_new()) == NULL) return(NULL);\n&quot;);
-        printf(&quot;\tdsa-&gt;p=BN_bin2bn(dsa%d_p,sizeof(dsa%d_p),NULL);\n&quot;,
+        BIO_printf(bio_out, &quot;DSA *get_dsa%d()\n{\n&quot;, bits_p);
+        print_bignum_var(bio_out, dsa-&gt;p, &quot;dsap&quot;, len, data);
+        print_bignum_var(bio_out, dsa-&gt;q, &quot;dsaq&quot;, len, data);
+        print_bignum_var(bio_out, dsa-&gt;g, &quot;dsag&quot;, len, data);
+        BIO_printf(bio_out, &quot;    DSA *dsa = DSA_new();\n&quot;
+                            &quot;\n&quot;);
+        BIO_printf(bio_out, &quot;    if (dsa == NULL)\n&quot;
+                            &quot;        return NULL;\n&quot;);
+        BIO_printf(bio_out, &quot;    dsa-&gt;p = BN_bin2bn(dsap_%d, sizeof (dsap_%d), NULL);\n&quot;,
                bits_p, bits_p);
-        printf(&quot;\tdsa-&gt;q=BN_bin2bn(dsa%d_q,sizeof(dsa%d_q),NULL);\n&quot;,
+        BIO_printf(bio_out, &quot;    dsa-&gt;q = BN_bin2bn(dsaq_%d, sizeof (dsaq_%d), NULL);\n&quot;,
                bits_p, bits_p);
-        printf(&quot;\tdsa-&gt;g=BN_bin2bn(dsa%d_g,sizeof(dsa%d_g),NULL);\n&quot;,
+        BIO_printf(bio_out, &quot;    dsa-&gt;g = BN_bin2bn(dsag_%d, sizeof (dsag_%d), NULL);\n&quot;,
                bits_p, bits_p);
-        printf
-            (&quot;\tif ((dsa-&gt;p == NULL) || (dsa-&gt;q == NULL) || (dsa-&gt;g == NULL))\n&quot;);
-        printf(&quot;\t\t{ DSA_free(dsa); return(NULL); }\n&quot;);
-        printf(&quot;\treturn(dsa);\n\t}\n&quot;);
+        BIO_printf(bio_out, &quot;    if (!dsa-&gt;p || !dsa-&gt;q || !dsa-&gt;g) {\n&quot;
+                            &quot;        DSA_free(dsa);\n&quot;
+                            &quot;        return NULL;\n&quot;
+                            &quot;    }\n&quot;
+                            &quot;    return(dsa);\n}\n&quot;);
     }
 
     if (!noout) {
         if (outformat == FORMAT_ASN1)
             i = i2d_DSAparams_bio(out, dsa);
-        else if (outformat == FORMAT_PEM)
+        else
             i = PEM_write_bio_DSAparams(out, dsa);
-        else {
-            BIO_printf(bio_err, &quot;bad output format specified for outfile\n&quot;);
-            goto end;
-        }
         if (!i) {
             BIO_printf(bio_err, &quot;unable to write DSA parameters\n&quot;);
             ERR_print_errors(bio_err);
@@ -418,18 +331,13 @@ int MAIN(int argc, char **argv)
         }
         if (outformat == FORMAT_ASN1)
             i = i2d_DSAPrivateKey_bio(out, dsakey);
-        else if (outformat == FORMAT_PEM)
+        else
             i = PEM_write_bio_DSAPrivateKey(out, dsakey, NULL, NULL, 0, NULL,
                                             NULL);
-        else {
-            BIO_printf(bio_err, &quot;bad output format specified for outfile\n&quot;);
-            DSA_free(dsakey);
-            goto end;
-        }
         DSA_free(dsakey);
     }
     if (need_rand)
-        app_RAND_write_file(NULL, bio_err);
+        app_RAND_write_file(NULL);
     ret = 0;
  end:
     if (cb != NULL)
@@ -437,8 +345,7 @@ int MAIN(int argc, char **argv)
     BIO_free(in);
     BIO_free_all(out);
     DSA_free(dsa);
-    apps_shutdown();
-    OPENSSL_EXIT(ret);
+    return (ret);
 }
 
 static int dsa_cb(int p, int n, BN_GENCB *cb)
diff --git a/apps/ec.c b/apps/ec.c
index aca2854..d6bce6d 100644
--- a/apps/ec.c
+++ b/apps/ec.c
@@ -1,4 +1,3 @@
-/* apps/ec.c */
 /*
  * Written by Nils Larsch for the OpenSSL project.
  */
@@ -67,198 +66,146 @@
 # include &lt;openssl/evp.h&gt;
 # include &lt;openssl/pem.h&gt;
 
-# undef PROG
-# define PROG    ec_main
+static OPT_PAIR conv_forms[] = {
+    {&quot;compressed&quot;, POINT_CONVERSION_COMPRESSED},
+    {&quot;uncompressed&quot;, POINT_CONVERSION_UNCOMPRESSED},
+    {&quot;hybrid&quot;, POINT_CONVERSION_HYBRID},
+    {NULL}
+};
 
-/*-
- * -inform arg    - input format - default PEM (one of DER, NET or PEM)
- * -outform arg   - output format - default PEM
- * -in arg        - input file - default stdin
- * -out arg       - output file - default stdout
- * -des           - encrypt output if PEM format with DES in cbc mode
- * -text          - print a text version
- * -param_out     - print the elliptic curve parameters
- * -conv_form arg - specifies the point encoding form
- * -param_enc arg - specifies the parameter encoding
- */
+static OPT_PAIR param_enc[] = {
+    {&quot;named_curve&quot;, OPENSSL_EC_NAMED_CURVE},
+    {&quot;explicit&quot;, 0},
+    {NULL}
+};
+
+typedef enum OPTION_choice {
+    OPT_ERR = -1, OPT_EOF = 0, OPT_HELP,
+    OPT_INFORM, OPT_OUTFORM, OPT_ENGINE, OPT_IN, OPT_OUT,
+    OPT_NOOUT, OPT_TEXT, OPT_PARAM_OUT, OPT_PUBIN, OPT_PUBOUT,
+    OPT_PASSIN, OPT_PASSOUT, OPT_PARAM_ENC, OPT_CONV_FORM, OPT_CIPHER
+} OPTION_CHOICE;
 
-int MAIN(int, char **);
+OPTIONS ec_options[] = {
+    {&quot;help&quot;, OPT_HELP, '-', &quot;Display this summary&quot;},
+    {&quot;in&quot;, OPT_IN, '&lt;', &quot;Input file&quot;},
+    {&quot;inform&quot;, OPT_INFORM, 'F', &quot;Input format - DER or PEM&quot;},
+    {&quot;out&quot;, OPT_OUT, '&gt;', &quot;Output file&quot;},
+    {&quot;outform&quot;, OPT_OUTFORM, 'F', &quot;Output format - DER or PEM&quot;},
+# ifndef OPENSSL_NO_ENGINE
+    {&quot;engine&quot;, OPT_ENGINE, 's', &quot;Use engine, possibly a hardware device&quot;},
+# endif
+    {&quot;noout&quot;, OPT_NOOUT, '-', &quot;Don't print key out&quot;},
+    {&quot;text&quot;, OPT_TEXT, '-', &quot;Print the key&quot;},
+    {&quot;param_out&quot;, OPT_PARAM_OUT, '-', &quot;Print the elliptic curve parameters&quot;},
+    {&quot;pubin&quot;, OPT_PUBIN, '-'},
+    {&quot;pubout&quot;, OPT_PUBOUT, '-'},
+    {&quot;passin&quot;, OPT_PASSIN, 's', &quot;Input file pass phrase source&quot;},
+    {&quot;passout&quot;, OPT_PASSOUT, 's', &quot;Output file pass phrase source&quot;},
+    {&quot;param_enc&quot;, OPT_PARAM_ENC, 's',
+     &quot;Specifies the way the ec parameters are encoded&quot;},
+    {&quot;conv_form&quot;, OPT_CONV_FORM, 's', &quot;Specifies the point conversion form &quot;},
+    {&quot;&quot;, OPT_CIPHER, '-', &quot;Any supported cipher&quot;},
+    {NULL}
+};
 
-int MAIN(int argc, char **argv)
+int ec_main(int argc, char **argv)
 {
-    int ret = 1;
+    BIO *in = NULL, *out = NULL;
     EC_KEY *eckey = NULL;
     const EC_GROUP *group;
-    int i, badops = 0;
     const EVP_CIPHER *enc = NULL;
-    BIO *in = NULL, *out = NULL;
-    int informat, outformat, text = 0, noout = 0;
-    int pubin = 0, pubout = 0, param_out = 0;
-    char *infile, *outfile, *prog, *engine;
-    char *passargin = NULL, *passargout = NULL;
-    char *passin = NULL, *passout = NULL;
     point_conversion_form_t form = POINT_CONVERSION_UNCOMPRESSED;
-    int new_form = 0;
-    int asn1_flag = OPENSSL_EC_NAMED_CURVE;
-    int new_asn1_flag = 0;
-
-    apps_startup();
+    char *infile = NULL, *outfile = NULL, *prog, *engine = NULL;
+    char *passin = NULL, *passout = NULL, *passinarg = NULL, *passoutarg =
+        NULL;
+    OPTION_CHOICE o;
+    int asn1_flag = OPENSSL_EC_NAMED_CURVE, new_form = 0, new_asn1_flag = 0;
+    int informat = FORMAT_PEM, outformat = FORMAT_PEM, text = 0, noout = 0;
+    int pubin = 0, pubout = 0, param_out = 0, i, ret = 1;
 
-    if (bio_err == NULL)
-        if ((bio_err = BIO_new(BIO_s_file())) != NULL)
-            BIO_set_fp(bio_err, stderr, BIO_NOCLOSE | BIO_FP_TEXT);
-
-    if (!load_config(bio_err, NULL))
-        goto end;
-
-    engine = NULL;
-    infile = NULL;
-    outfile = NULL;
-    informat = FORMAT_PEM;
-    outformat = FORMAT_PEM;
-
-    prog = argv[0];
-    argc--;
-    argv++;
-    while (argc &gt;= 1) {
-        if (strcmp(*argv, &quot;-inform&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            informat = str2fmt(*(++argv));
-        } else if (strcmp(*argv, &quot;-outform&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            outformat = str2fmt(*(++argv));
-        } else if (strcmp(*argv, &quot;-in&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            infile = *(++argv);
-        } else if (strcmp(*argv, &quot;-out&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            outfile = *(++argv);
-        } else if (strcmp(*argv, &quot;-passin&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            passargin = *(++argv);
-        } else if (strcmp(*argv, &quot;-passout&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            passargout = *(++argv);
-        } else if (strcmp(*argv, &quot;-engine&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            engine = *(++argv);
-        } else if (strcmp(*argv, &quot;-noout&quot;) == 0)
+    prog = opt_init(argc, argv, ec_options);
+    while ((o = opt_next()) != OPT_EOF) {
+        switch (o) {
+        case OPT_EOF:
+        case OPT_ERR:
+ opthelp:
+            BIO_printf(bio_err, &quot;%s: Use -help for summary.\n&quot;, prog);
+            goto end;
+        case OPT_HELP:
+            opt_help(ec_options);
+            ret = 0;
+            goto end;
+        case OPT_INFORM:
+            if (!opt_format(opt_arg(), OPT_FMT_PEMDER, &amp;informat))
+                goto opthelp;
+            break;
+        case OPT_IN:
+            infile = opt_arg();
+            break;
+        case OPT_OUTFORM:
+            if (!opt_format(opt_arg(), OPT_FMT_PEMDER, &amp;outformat))
+                goto opthelp;
+            break;
+        case OPT_OUT:
+            outfile = opt_arg();
+            break;
+        case OPT_NOOUT:
             noout = 1;
-        else if (strcmp(*argv, &quot;-text&quot;) == 0)
+            break;
+        case OPT_TEXT:
             text = 1;
-        else if (strcmp(*argv, &quot;-conv_form&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            ++argv;
-            new_form = 1;
-            if (strcmp(*argv, &quot;compressed&quot;) == 0)
-                form = POINT_CONVERSION_COMPRESSED;
-            else if (strcmp(*argv, &quot;uncompressed&quot;) == 0)
-                form = POINT_CONVERSION_UNCOMPRESSED;
-            else if (strcmp(*argv, &quot;hybrid&quot;) == 0)
-                form = POINT_CONVERSION_HYBRID;
-            else
-                goto bad;
-        } else if (strcmp(*argv, &quot;-param_enc&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            ++argv;
-            new_asn1_flag = 1;
-            if (strcmp(*argv, &quot;named_curve&quot;) == 0)
-                asn1_flag = OPENSSL_EC_NAMED_CURVE;
-            else if (strcmp(*argv, &quot;explicit&quot;) == 0)
-                asn1_flag = 0;
-            else
-                goto bad;
-        } else if (strcmp(*argv, &quot;-param_out&quot;) == 0)
+            break;
+        case OPT_PARAM_OUT:
             param_out = 1;
-        else if (strcmp(*argv, &quot;-pubin&quot;) == 0)
+            break;
+        case OPT_PUBIN:
             pubin = 1;
-        else if (strcmp(*argv, &quot;-pubout&quot;) == 0)
+            break;
+        case OPT_PUBOUT:
             pubout = 1;
-        else if ((enc = EVP_get_cipherbyname(&amp;(argv[0][1]))) == NULL) {
-            BIO_printf(bio_err, &quot;unknown option %s\n&quot;, *argv);
-            badops = 1;
+            break;
+        case OPT_PASSIN:
+            passinarg = opt_arg();
+            break;
+        case OPT_PASSOUT:
+            passoutarg = opt_arg();
+            break;
+        case OPT_ENGINE:
+            engine = opt_arg();
+            break;
+        case OPT_CIPHER:
+            if (!opt_cipher(opt_unknown(), &amp;enc))
+                goto opthelp;
+        case OPT_CONV_FORM:
+            if (!opt_pair(opt_arg(), conv_forms, &amp;i))
+                goto opthelp;
+            new_form = 1;
+            form = i;
+            break;
+        case OPT_PARAM_ENC:
+            if (!opt_pair(opt_arg(), param_enc, &amp;i))
+                goto opthelp;
+            new_asn1_flag = 1;
+            asn1_flag = i;
             break;
         }
-        argc--;
-        argv++;
     }
-
-    if (badops) {
- bad:
-        BIO_printf(bio_err, &quot;%s [options] &lt;infile &gt;outfile\n&quot;, prog);
-        BIO_printf(bio_err, &quot;where options are\n&quot;);
-        BIO_printf(bio_err, &quot; -inform arg     input format - &quot;
-                   &quot;DER or PEM\n&quot;);
-        BIO_printf(bio_err, &quot; -outform arg    output format - &quot;
-                   &quot;DER or PEM\n&quot;);
-        BIO_printf(bio_err, &quot; -in arg         input file\n&quot;);
-        BIO_printf(bio_err, &quot; -passin arg     input file pass &quot;
-                   &quot;phrase source\n&quot;);
-        BIO_printf(bio_err, &quot; -out arg        output file\n&quot;);
-        BIO_printf(bio_err, &quot; -passout arg    output file pass &quot;
-                   &quot;phrase source\n&quot;);
-        BIO_printf(bio_err, &quot; -engine e       use engine e, &quot;
-                   &quot;possibly a hardware device.\n&quot;);
-        BIO_printf(bio_err, &quot; -des            encrypt PEM output, &quot;
-                   &quot;instead of 'des' every other \n&quot;
-                   &quot;                 cipher &quot;
-                   &quot;supported by OpenSSL can be used\n&quot;);
-        BIO_printf(bio_err, &quot; -text           print the key\n&quot;);
-        BIO_printf(bio_err, &quot; -noout          don't print key out\n&quot;);
-        BIO_printf(bio_err, &quot; -param_out      print the elliptic &quot;
-                   &quot;curve parameters\n&quot;);
-        BIO_printf(bio_err, &quot; -conv_form arg  specifies the &quot;
-                   &quot;point conversion form \n&quot;);
-        BIO_printf(bio_err, &quot;                 possible values:&quot;
-                   &quot; compressed\n&quot;);
-        BIO_printf(bio_err, &quot;                                 &quot;
-                   &quot; uncompressed (default)\n&quot;);
-        BIO_printf(bio_err, &quot;                                  &quot; &quot; hybrid\n&quot;);
-        BIO_printf(bio_err, &quot; -param_enc arg  specifies the way&quot;
-                   &quot; the ec parameters are encoded\n&quot;);
-        BIO_printf(bio_err, &quot;                 in the asn1 der &quot; &quot;encoding\n&quot;);
-        BIO_printf(bio_err, &quot;                 possible values:&quot;
-                   &quot; named_curve (default)\n&quot;);
-        BIO_printf(bio_err, &quot;                                  &quot;
-                   &quot;explicit\n&quot;);
-        goto end;
-    }
-
-    ERR_load_crypto_strings();
+    argc = opt_num_rest();
+    argv = opt_rest();
 
 # ifndef OPENSSL_NO_ENGINE
-    setup_engine(bio_err, engine, 0);
+    setup_engine(engine, 0);
 # endif
 
-    if (!app_passwd(bio_err, passargin, passargout, &amp;passin, &amp;passout)) {
+    if (!app_passwd(passinarg, passoutarg, &amp;passin, &amp;passout)) {
         BIO_printf(bio_err, &quot;Error getting passwords\n&quot;);
         goto end;
     }
 
-    in = BIO_new(BIO_s_file());
-    out = BIO_new(BIO_s_file());
-    if ((in == NULL) || (out == NULL)) {
-        ERR_print_errors(bio_err);
+    in = bio_open_default(infile, RB(informat));
+    if (in == NULL)
         goto end;
-    }
-
-    if (infile == NULL)
-        BIO_set_fp(in, stdin, BIO_NOCLOSE);
-    else {
-        if (BIO_read_filename(in, infile) &lt;= 0) {
-            perror(infile);
-            goto end;
-        }
-    }
 
     BIO_printf(bio_err, &quot;read EC key\n&quot;);
     if (informat == FORMAT_ASN1) {
@@ -266,14 +213,11 @@ int MAIN(int argc, char **argv)
             eckey = d2i_EC_PUBKEY_bio(in, NULL);
         else
             eckey = d2i_ECPrivateKey_bio(in, NULL);
-    } else if (informat == FORMAT_PEM) {
+    } else {
         if (pubin)
             eckey = PEM_read_bio_EC_PUBKEY(in, NULL, NULL, NULL);
         else
             eckey = PEM_read_bio_ECPrivateKey(in, NULL, NULL, passin);
-    } else {
-        BIO_printf(bio_err, &quot;bad input format specified for key\n&quot;);
-        goto end;
     }
     if (eckey == NULL) {
         BIO_printf(bio_err, &quot;unable to load Key\n&quot;);
@@ -281,20 +225,9 @@ int MAIN(int argc, char **argv)
         goto end;
     }
 
-    if (outfile == NULL) {
-        BIO_set_fp(out, stdout, BIO_NOCLOSE);
-# ifdef OPENSSL_SYS_VMS
-        {
-            BIO *tmpbio = BIO_new(BIO_f_linebuffer());
-            out = BIO_push(tmpbio, out);
-        }
-# endif
-    } else {
-        if (BIO_write_filename(out, outfile) &lt;= 0) {
-            perror(outfile);
-            goto end;
-        }
-    }
+    out = bio_open_default(outfile, WB(outformat));
+    if (out == NULL)
+        goto end;
 
     group = EC_KEY_get0_group(eckey);
 
@@ -324,7 +257,7 @@ int MAIN(int argc, char **argv)
             i = i2d_EC_PUBKEY_bio(out, eckey);
         else
             i = i2d_ECPrivateKey_bio(out, eckey);
-    } else if (outformat == FORMAT_PEM) {
+    } else {
         if (param_out)
             i = PEM_write_bio_ECPKParameters(out, group);
         else if (pubin || pubout)
@@ -332,9 +265,6 @@ int MAIN(int argc, char **argv)
         else
             i = PEM_write_bio_ECPrivateKey(out, eckey, enc,
                                            NULL, 0, NULL, passout);
-    } else {
-        BIO_printf(bio_err, &quot;bad output format specified for &quot; &quot;outfile\n&quot;);
-        goto end;
     }
 
     if (!i) {
@@ -350,8 +280,7 @@ int MAIN(int argc, char **argv)
         OPENSSL_free(passin);
     if (passout)
         OPENSSL_free(passout);
-    apps_shutdown();
-    OPENSSL_EXIT(ret);
+    return (ret);
 }
 #else                           /* !OPENSSL_NO_EC */
 
diff --git a/apps/ecparam.c b/apps/ecparam.c
index c6a1751..167ef39 100644
--- a/apps/ecparam.c
+++ b/apps/ecparam.c
@@ -1,4 +1,3 @@
-/* apps/ecparam.c */
 /*
  * Written by Nils Larsch for the OpenSSL project.
  */
@@ -84,235 +83,152 @@
 # include &lt;openssl/x509.h&gt;
 # include &lt;openssl/pem.h&gt;
 
-# undef PROG
-# define PROG    ecparam_main
-
-/*-
- * -inform arg      - input format - default PEM (DER or PEM)
- * -outform arg     - output format - default PEM
- * -in  arg         - input file  - default stdin
- * -out arg         - output file - default stdout
- * -noout           - do not print the ec parameter
- * -text            - print the ec parameters in text form
- * -check           - validate the ec parameters
- * -C               - print a 'C' function creating the parameters
- * -name arg        - use the ec parameters with 'short name' name
- * -list_curves     - prints a list of all currently available curve 'short names'
- * -conv_form arg   - specifies the point conversion form
- *                  - possible values: compressed
- *                                     uncompressed (default)
- *                                     hybrid
- * -param_enc arg   - specifies the way the ec parameters are encoded
- *                    in the asn1 der encoding
- *                    possible values: named_curve (default)
- *                                     explicit
- * -no_seed         - if 'explicit' parameters are chosen do not use the seed
- * -genkey          - generate ec key
- * -rand file       - files to use for random number input
- * -engine e        - use engine e, possibly a hardware device
- */
-
-static int ecparam_print_var(BIO *, BIGNUM *, const char *, int,
-                             unsigned char *);
-
-int MAIN(int, char **);
-
-int MAIN(int argc, char **argv)
+typedef enum OPTION_choice {
+    OPT_ERR = -1, OPT_EOF = 0, OPT_HELP,
+    OPT_INFORM, OPT_OUTFORM, OPT_IN, OPT_OUT, OPT_TEXT, OPT_C,
+    OPT_CHECK, OPT_LIST_CURVES, OPT_NO_SEED, OPT_NOOUT, OPT_NAME,
+    OPT_CONV_FORM, OPT_PARAM_ENC, OPT_GENKEY, OPT_RAND, OPT_ENGINE
+} OPTION_CHOICE;
+
+OPTIONS ecparam_options[] = {
+    {&quot;help&quot;, OPT_HELP, '-', &quot;Display this summary&quot;},
+    {&quot;inform&quot;, OPT_INFORM, 'F', &quot;Input format - default PEM (DER or PEM)&quot;},
+    {&quot;outform&quot;, OPT_OUTFORM, 'F', &quot;Output format - default PEM&quot;},
+    {&quot;in&quot;, OPT_IN, '&lt;', &quot;Input file  - default stdin&quot;},
+    {&quot;out&quot;, OPT_OUT, '&gt;', &quot;Output file - default stdout&quot;},
+    {&quot;text&quot;, OPT_TEXT, '-', &quot;Print the ec parameters in text form&quot;},
+    {&quot;C&quot;, OPT_C, '-', &quot;Print a 'C' function creating the parameters&quot;},
+    {&quot;check&quot;, OPT_CHECK, '-', &quot;Validate the ec parameters&quot;},
+    {&quot;list_curves&quot;, OPT_LIST_CURVES, '-',
+     &quot;Prints a list of all curve 'short names'&quot;},
+    {&quot;no_seed&quot;, OPT_NO_SEED, '-',
+     &quot;If 'explicit' parameters are chosen do not use the seed&quot;},
+    {&quot;noout&quot;, OPT_NOOUT, '-', &quot;Do not print the ec parameter&quot;},
+    {&quot;name&quot;, OPT_NAME, 's',
+     &quot;Use the ec parameters with specified 'short name'&quot;},
+    {&quot;conv_form&quot;, OPT_CONV_FORM, 's', &quot;Specifies the point conversion form &quot;},
+    {&quot;param_enc&quot;, OPT_PARAM_ENC, 's',
+     &quot;Specifies the way the ec parameters are encoded&quot;},
+    {&quot;genkey&quot;, OPT_GENKEY, '-', &quot;Generate ec key&quot;},
+    {&quot;rand&quot;, OPT_RAND, 's', &quot;Files to use for random number input&quot;},
+# ifndef OPENSSL_NO_ENGINE
+    {&quot;engine&quot;, OPT_ENGINE, 's', &quot;Use engine, possibly a hardware device&quot;},
+# endif
+    {NULL}
+};
+
+OPT_PAIR forms[] = {
+    {&quot;compressed&quot;, POINT_CONVERSION_COMPRESSED},
+    {&quot;uncompressed&quot;, POINT_CONVERSION_UNCOMPRESSED},
+    {&quot;hybrid&quot;, POINT_CONVERSION_HYBRID},
+    {NULL}
+};
+
+OPT_PAIR encodings[] = {
+    {&quot;named_curve&quot;, OPENSSL_EC_NAMED_CURVE},
+    {&quot;explicit&quot;, 0},
+    {NULL}
+};
+
+int ecparam_main(int argc, char **argv)
 {
+    BIGNUM *ec_gen = NULL, *ec_order = NULL, *ec_cofactor = NULL;
+    BIGNUM *ec_p = NULL, *ec_a = NULL, *ec_b = NULL;
+    BIO *in = NULL, *out = NULL;
     EC_GROUP *group = NULL;
     point_conversion_form_t form = POINT_CONVERSION_UNCOMPRESSED;
-    int new_form = 0;
-    int asn1_flag = OPENSSL_EC_NAMED_CURVE;
-    int new_asn1_flag = 0;
     char *curve_name = NULL, *inrand = NULL;
-    int list_curves = 0, no_seed = 0, check = 0,
-        badops = 0, text = 0, i, need_rand = 0, genkey = 0;
-    char *infile = NULL, *outfile = NULL, *prog;
-    BIO *in = NULL, *out = NULL;
-    int informat, outformat, noout = 0, C = 0, ret = 1;
-    char *engine = NULL;
-
-    BIGNUM *ec_p = NULL, *ec_a = NULL, *ec_b = NULL,
-        *ec_gen = NULL, *ec_order = NULL, *ec_cofactor = NULL;
+    char *engine = NULL, *infile = NULL, *outfile = NULL, *prog;
     unsigned char *buffer = NULL;
-
-    apps_startup();
-
-    if (bio_err == NULL)
-        if ((bio_err = BIO_new(BIO_s_file())) != NULL)
-            BIO_set_fp(bio_err, stderr, BIO_NOCLOSE | BIO_FP_TEXT);
-
-    if (!load_config(bio_err, NULL))
-        goto end;
-
-    informat = FORMAT_PEM;
-    outformat = FORMAT_PEM;
-
-    prog = argv[0];
-    argc--;
-    argv++;
-    while (argc &gt;= 1) {
-        if (strcmp(*argv, &quot;-inform&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            informat = str2fmt(*(++argv));
-        } else if (strcmp(*argv, &quot;-outform&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            outformat = str2fmt(*(++argv));
-        } else if (strcmp(*argv, &quot;-in&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            infile = *(++argv);
-        } else if (strcmp(*argv, &quot;-out&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            outfile = *(++argv);
-        } else if (strcmp(*argv, &quot;-text&quot;) == 0)
+    OPTION_CHOICE o;
+    int asn1_flag = OPENSSL_EC_NAMED_CURVE, new_asn1_flag = 0;
+    int informat = FORMAT_PEM, outformat = FORMAT_PEM, noout = 0, C = 0, ret =
+        1;
+    int list_curves = 0, no_seed = 0, check = 0, new_form = 0;
+    int text = 0, i, need_rand = 0, genkey = 0;
+
+    prog = opt_init(argc, argv, ecparam_options);
+    while ((o = opt_next()) != OPT_EOF) {
+        switch (o) {
+        case OPT_EOF:
+        case OPT_ERR:
+ opthelp:
+            BIO_printf(bio_err, &quot;%s: Use -help for summary.\n&quot;, prog);
+            goto end;
+        case OPT_HELP:
+            opt_help(ecparam_options);
+            ret = 0;
+            goto end;
+        case OPT_INFORM:
+            if (!opt_format(opt_arg(), OPT_FMT_PEMDER, &amp;informat))
+                goto opthelp;
+            break;
+        case OPT_IN:
+            infile = opt_arg();
+            break;
+        case OPT_OUTFORM:
+            if (!opt_format(opt_arg(), OPT_FMT_PEMDER, &amp;outformat))
+                goto opthelp;
+            break;
+        case OPT_OUT:
+            outfile = opt_arg();
+            break;
+        case OPT_TEXT:
             text = 1;
-        else if (strcmp(*argv, &quot;-C&quot;) == 0)
+            break;
+        case OPT_C:
             C = 1;
-        else if (strcmp(*argv, &quot;-check&quot;) == 0)
+            break;
+        case OPT_CHECK:
             check = 1;
-        else if (strcmp(*argv, &quot;-name&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            curve_name = *(++argv);
-        } else if (strcmp(*argv, &quot;-list_curves&quot;) == 0)
+            break;
+        case OPT_LIST_CURVES:
             list_curves = 1;
-        else if (strcmp(*argv, &quot;-conv_form&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            ++argv;
-            new_form = 1;
-            if (strcmp(*argv, &quot;compressed&quot;) == 0)
-                form = POINT_CONVERSION_COMPRESSED;
-            else if (strcmp(*argv, &quot;uncompressed&quot;) == 0)
-                form = POINT_CONVERSION_UNCOMPRESSED;
-            else if (strcmp(*argv, &quot;hybrid&quot;) == 0)
-                form = POINT_CONVERSION_HYBRID;
-            else
-                goto bad;
-        } else if (strcmp(*argv, &quot;-param_enc&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            ++argv;
-            new_asn1_flag = 1;
-            if (strcmp(*argv, &quot;named_curve&quot;) == 0)
-                asn1_flag = OPENSSL_EC_NAMED_CURVE;
-            else if (strcmp(*argv, &quot;explicit&quot;) == 0)
-                asn1_flag = 0;
-            else
-                goto bad;
-        } else if (strcmp(*argv, &quot;-no_seed&quot;) == 0)
+            break;
+        case OPT_NO_SEED:
             no_seed = 1;
-        else if (strcmp(*argv, &quot;-noout&quot;) == 0)
+            break;
+        case OPT_NOOUT:
             noout = 1;
-        else if (strcmp(*argv, &quot;-genkey&quot;) == 0) {
-            genkey = 1;
-            need_rand = 1;
-        } else if (strcmp(*argv, &quot;-rand&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            inrand = *(++argv);
+            break;
+        case OPT_NAME:
+            curve_name = opt_arg();
+            break;
+        case OPT_CONV_FORM:
+            if (!opt_pair(opt_arg(), forms, &amp;new_form))
+                goto opthelp;
+            form = new_form;
+            new_form = 1;
+            break;
+        case OPT_PARAM_ENC:
+            if (!opt_pair(opt_arg(), encodings, &amp;asn1_flag))
+                goto opthelp;
+            new_asn1_flag = 1;
+            break;
+        case OPT_GENKEY:
+            genkey = need_rand = 1;
+            break;
+        case OPT_RAND:
+            inrand = opt_arg();
             need_rand = 1;
-        } else if (strcmp(*argv, &quot;-engine&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            engine = *(++argv);
-        } else {
-            BIO_printf(bio_err, &quot;unknown option %s\n&quot;, *argv);
-            badops = 1;
+            break;
+        case OPT_ENGINE:
+            engine = opt_arg();
             break;
         }
-        argc--;
-        argv++;
     }
+    argc = opt_num_rest();
+    argv = opt_rest();
 
-    if (badops) {
- bad:
-        BIO_printf(bio_err, &quot;%s [options] &lt;infile &gt;outfile\n&quot;, prog);
-        BIO_printf(bio_err, &quot;where options are\n&quot;);
-        BIO_printf(bio_err, &quot; -inform arg       input format - &quot;
-                   &quot;default PEM (DER or PEM)\n&quot;);
-        BIO_printf(bio_err, &quot; -outform arg      output format - &quot;
-                   &quot;default PEM\n&quot;);
-        BIO_printf(bio_err, &quot; -in  arg          input file  - &quot;
-                   &quot;default stdin\n&quot;);
-        BIO_printf(bio_err, &quot; -out arg          output file - &quot;
-                   &quot;default stdout\n&quot;);
-        BIO_printf(bio_err, &quot; -noout            do not print the &quot;
-                   &quot;ec parameter\n&quot;);
-        BIO_printf(bio_err, &quot; -text             print the ec &quot;
-                   &quot;parameters in text form\n&quot;);
-        BIO_printf(bio_err, &quot; -check            validate the ec &quot;
-                   &quot;parameters\n&quot;);
-        BIO_printf(bio_err, &quot; -C                print a 'C' &quot;
-                   &quot;function creating the parameters\n&quot;);
-        BIO_printf(bio_err, &quot; -name arg         use the &quot;
-                   &quot;ec parameters with 'short name' name\n&quot;);
-        BIO_printf(bio_err, &quot; -list_curves      prints a list of &quot;
-                   &quot;all currently available curve 'short names'\n&quot;);
-        BIO_printf(bio_err, &quot; -conv_form arg    specifies the &quot;
-                   &quot;point conversion form \n&quot;);
-        BIO_printf(bio_err, &quot;                   possible values:&quot;
-                   &quot; compressed\n&quot;);
-        BIO_printf(bio_err, &quot;                                   &quot;
-                   &quot; uncompressed (default)\n&quot;);
-        BIO_printf(bio_err, &quot;                                   &quot;
-                   &quot; hybrid\n&quot;);
-        BIO_printf(bio_err, &quot; -param_enc arg    specifies the way&quot;
-                   &quot; the ec parameters are encoded\n&quot;);
-        BIO_printf(bio_err, &quot;                   in the asn1 der &quot;
-                   &quot;encoding\n&quot;);
-        BIO_printf(bio_err, &quot;                   possible values:&quot;
-                   &quot; named_curve (default)\n&quot;);
-        BIO_printf(bio_err, &quot;                                   &quot;
-                   &quot; explicit\n&quot;);
-        BIO_printf(bio_err, &quot; -no_seed          if 'explicit'&quot;
-                   &quot; parameters are chosen do not&quot; &quot; use the seed\n&quot;);
-        BIO_printf(bio_err, &quot; -genkey           generate ec&quot; &quot; key\n&quot;);
-        BIO_printf(bio_err, &quot; -rand file        files to use for&quot;
-                   &quot; random number input\n&quot;);
-        BIO_printf(bio_err, &quot; -engine e         use engine e, &quot;
-                   &quot;possibly a hardware device\n&quot;);
+    in = bio_open_default(infile, RB(informat));
+    if (in == NULL)
         goto end;
-    }
-
-    ERR_load_crypto_strings();
-
-    in = BIO_new(BIO_s_file());
-    out = BIO_new(BIO_s_file());
-    if ((in == NULL) || (out == NULL)) {
-        ERR_print_errors(bio_err);
+    out = bio_open_default(outfile, WB(outformat));
+    if (out == NULL)
         goto end;
-    }
-
-    if (infile == NULL)
-        BIO_set_fp(in, stdin, BIO_NOCLOSE);
-    else {
-        if (BIO_read_filename(in, infile) &lt;= 0) {
-            perror(infile);
-            goto end;
-        }
-    }
-    if (outfile == NULL) {
-        BIO_set_fp(out, stdout, BIO_NOCLOSE);
-# ifdef OPENSSL_SYS_VMS
-        {
-            BIO *tmpbio = BIO_new(BIO_f_linebuffer());
-            out = BIO_push(tmpbio, out);
-        }
-# endif
-    } else {
-        if (BIO_write_filename(out, outfile) &lt;= 0) {
-            perror(outfile);
-            goto end;
-        }
-    }
 
 # ifndef OPENSSL_NO_ENGINE
-    setup_engine(bio_err, engine, 0);
+    setup_engine(engine, 0);
 # endif
 
     if (list_curves) {
@@ -385,15 +301,10 @@ int MAIN(int argc, char **argv)
         }
         EC_GROUP_set_asn1_flag(group, asn1_flag);
         EC_GROUP_set_point_conversion_form(group, form);
-    } else if (informat == FORMAT_ASN1) {
+    } else if (informat == FORMAT_ASN1)
         group = d2i_ECPKParameters_bio(in, NULL);
-    } else if (informat == FORMAT_PEM) {
+    else
         group = PEM_read_bio_ECPKParameters(in, NULL, NULL, NULL);
-    } else {
-        BIO_printf(bio_err, &quot;bad input format specified\n&quot;);
-        goto end;
-    }
-
     if (group == NULL) {
         BIO_printf(bio_err, &quot;unable to load elliptic curve parameters\n&quot;);
         ERR_print_errors(bio_err);
@@ -433,24 +344,25 @@ int MAIN(int argc, char **argv)
         int is_prime, len = 0;
         const EC_METHOD *meth = EC_GROUP_method_of(group);
 
-        if ((ec_p = BN_new()) == NULL || (ec_a = BN_new()) == NULL ||
-            (ec_b = BN_new()) == NULL || (ec_gen = BN_new()) == NULL ||
-            (ec_order = BN_new()) == NULL ||
-            (ec_cofactor = BN_new()) == NULL) {
+        if ((ec_p = BN_new()) == NULL
+                || (ec_a = BN_new()) == NULL
+                || (ec_b = BN_new()) == NULL
+                || (ec_gen = BN_new()) == NULL
+                || (ec_order = BN_new()) == NULL
+                || (ec_cofactor = BN_new()) == NULL) {
             perror(&quot;OPENSSL_malloc&quot;);
             goto end;
         }
 
         is_prime = (EC_METHOD_get_field_type(meth) == NID_X9_62_prime_field);
-
-        if (is_prime) {
-            if (!EC_GROUP_get_curve_GFp(group, ec_p, ec_a, ec_b, NULL))
-                goto end;
-        } else {
-            /* TODO */
+        if (!is_prime) {
+            BIO_printf(bio_err, &quot;Can only handle X9.62 prime fields\n&quot;);
             goto end;
         }
 
+        if (!EC_GROUP_get_curve_GFp(group, ec_p, ec_a, ec_b, NULL))
+            goto end;
+
         if ((point = EC_GROUP_get0_generator(group)) == NULL)
             goto end;
         if (!EC_POINT_point2bn(group, point,
@@ -487,77 +399,62 @@ int MAIN(int argc, char **argv)
             goto end;
         }
 
-        ecparam_print_var(out, ec_p, &quot;ec_p&quot;, len, buffer);
-        ecparam_print_var(out, ec_a, &quot;ec_a&quot;, len, buffer);
-        ecparam_print_var(out, ec_b, &quot;ec_b&quot;, len, buffer);
-        ecparam_print_var(out, ec_gen, &quot;ec_gen&quot;, len, buffer);
-        ecparam_print_var(out, ec_order, &quot;ec_order&quot;, len, buffer);
-        ecparam_print_var(out, ec_cofactor, &quot;ec_cofactor&quot;, len, buffer);
-
-        BIO_printf(out, &quot;\n\n&quot;);
-
-        BIO_printf(out, &quot;EC_GROUP *get_ec_group_%d(void)\n\t{\n&quot;, len);
-        BIO_printf(out, &quot;\tint ok=0;\n&quot;);
-        BIO_printf(out, &quot;\tEC_GROUP *group = NULL;\n&quot;);
-        BIO_printf(out, &quot;\tEC_POINT *point = NULL;\n&quot;);
-        BIO_printf(out, &quot;\tBIGNUM   *tmp_1 = NULL, *tmp_2 = NULL, &quot;
-                   &quot;*tmp_3 = NULL;\n\n&quot;);
-        BIO_printf(out, &quot;\tif ((tmp_1 = BN_bin2bn(ec_p_%d, &quot;
-                   &quot;sizeof(ec_p_%d), NULL)) == NULL)\n\t\t&quot;
-                   &quot;goto err;\n&quot;, len, len);
-        BIO_printf(out, &quot;\tif ((tmp_2 = BN_bin2bn(ec_a_%d, &quot;
-                   &quot;sizeof(ec_a_%d), NULL)) == NULL)\n\t\t&quot;
-                   &quot;goto err;\n&quot;, len, len);
-        BIO_printf(out, &quot;\tif ((tmp_3 = BN_bin2bn(ec_b_%d, &quot;
-                   &quot;sizeof(ec_b_%d), NULL)) == NULL)\n\t\t&quot;
-                   &quot;goto err;\n&quot;, len, len);
-        if (is_prime) {
-            BIO_printf(out, &quot;\tif ((group = EC_GROUP_new_curve_&quot;
-                       &quot;GFp(tmp_1, tmp_2, tmp_3, NULL)) == NULL)&quot;
-                       &quot;\n\t\tgoto err;\n\n&quot;);
-        } else {
-            /* TODO */
-            goto end;
-        }
-        BIO_printf(out, &quot;\t/* build generator */\n&quot;);
-        BIO_printf(out, &quot;\tif ((tmp_1 = BN_bin2bn(ec_gen_%d, &quot;
-                   &quot;sizeof(ec_gen_%d), tmp_1)) == NULL)&quot;
-                   &quot;\n\t\tgoto err;\n&quot;, len, len);
-        BIO_printf(out, &quot;\tpoint = EC_POINT_bn2point(group, tmp_1, &quot;
-                   &quot;NULL, NULL);\n&quot;);
-        BIO_printf(out, &quot;\tif (point == NULL)\n\t\tgoto err;\n&quot;);
-        BIO_printf(out, &quot;\tif ((tmp_2 = BN_bin2bn(ec_order_%d, &quot;
-                   &quot;sizeof(ec_order_%d), tmp_2)) == NULL)&quot;
-                   &quot;\n\t\tgoto err;\n&quot;, len, len);
-        BIO_printf(out, &quot;\tif ((tmp_3 = BN_bin2bn(ec_cofactor_%d, &quot;
-                   &quot;sizeof(ec_cofactor_%d), tmp_3)) == NULL)&quot;
-                   &quot;\n\t\tgoto err;\n&quot;, len, len);
-        BIO_printf(out, &quot;\tif (!EC_GROUP_set_generator(group, point,&quot;
-                   &quot; tmp_2, tmp_3))\n\t\tgoto err;\n&quot;);
-        BIO_printf(out, &quot;\n\tok=1;\n&quot;);
-        BIO_printf(out, &quot;err:\n&quot;);
-        BIO_printf(out, &quot;\tif (tmp_1)\n\t\tBN_free(tmp_1);\n&quot;);
-        BIO_printf(out, &quot;\tif (tmp_2)\n\t\tBN_free(tmp_2);\n&quot;);
-        BIO_printf(out, &quot;\tif (tmp_3)\n\t\tBN_free(tmp_3);\n&quot;);
-        BIO_printf(out, &quot;\tif (point)\n\t\tEC_POINT_free(point);\n&quot;);
-        BIO_printf(out, &quot;\tif (!ok)\n&quot;);
-        BIO_printf(out, &quot;\t\t{\n&quot;);
-        BIO_printf(out, &quot;\t\tEC_GROUP_free(group);\n&quot;);
-        BIO_printf(out, &quot;\t\tgroup = NULL;\n&quot;);
-        BIO_printf(out, &quot;\t\t}\n&quot;);
-        BIO_printf(out, &quot;\treturn(group);\n\t}\n&quot;);
+        BIO_printf(out, &quot;EC_GROUP *get_ec_group_%d(void)\n{\n&quot;, len);
+        print_bignum_var(out, ec_p, &quot;ec_p&quot;, len, buffer);
+        print_bignum_var(out, ec_a, &quot;ec_a&quot;, len, buffer);
+        print_bignum_var(out, ec_b, &quot;ec_b&quot;, len, buffer);
+        print_bignum_var(out, ec_gen, &quot;ec_gen&quot;, len, buffer);
+        print_bignum_var(out, ec_order, &quot;ec_order&quot;, len, buffer);
+        print_bignum_var(out, ec_cofactor, &quot;ec_cofactor&quot;, len, buffer);
+        BIO_printf(out, &quot;    int ok = 0;\n&quot;
+                        &quot;    EC_GROUP *group = NULL;\n&quot;
+                        &quot;    EC_POINT *point = NULL;\n&quot;
+                        &quot;    BIGNUM *tmp_1 = NULL;\n&quot;
+                        &quot;    BIGNUM *tmp_2 = NULL;\n&quot;
+                        &quot;    BIGNUM *tmp_3 = NULL;\n&quot;
+                        &quot;\n&quot;);
+
+        BIO_printf(out, &quot;    if ((tmp_1 = BN_bin2bn(ec_p_%d, sizeof (ec_p_%d), NULL)) == NULL)\n&quot;
+                        &quot;        goto err;\n&quot;, len, len);
+        BIO_printf(out, &quot;    if ((tmp_2 = BN_bin2bn(ec_a_%d, sizeof (ec_a_%d), NULL)) == NULL)\n&quot;
+                        &quot;        goto err;\n&quot;, len, len);
+        BIO_printf(out, &quot;    if ((tmp_3 = BN_bin2bn(ec_b_%d, sizeof (ec_b_%d), NULL)) == NULL)\n&quot;
+                        &quot;        goto err;\n&quot;, len, len);
+        BIO_printf(out, &quot;    if ((group = EC_GROUP_new_curve_GFp(tmp_1, tmp_2, tmp_3, NULL)) == NULL)\n&quot;
+                        &quot;        goto err;\n&quot;
+                        &quot;\n&quot;);
+        BIO_printf(out, &quot;    /* build generator */\n&quot;);
+        BIO_printf(out, &quot;    if ((tmp_1 = BN_bin2bn(ec_gen_%d, sizeof (ec_gen_%d), tmp_1)) == NULL)\n&quot;
+                        &quot;        goto err;\n&quot;, len, len);
+        BIO_printf(out, &quot;    point = EC_POINT_bn2point(group, tmp_1, NULL, NULL);\n&quot;);
+        BIO_printf(out, &quot;    if (point == NULL)\n&quot;
+                        &quot;        goto err;\n&quot;);
+        BIO_printf(out, &quot;    if ((tmp_2 = BN_bin2bn(ec_order_%d, sizeof (ec_order_%d), tmp_2)) == NULL)\n&quot;
+                        &quot;        goto err;\n&quot;, len, len);
+        BIO_printf(out, &quot;    if ((tmp_3 = BN_bin2bn(ec_cofactor_%d, sizeof (ec_cofactor_%d), tmp_3)) == NULL)\n&quot;
+                        &quot;        goto err;\n&quot;, len, len);
+        BIO_printf(out, &quot;    if (!EC_GROUP_set_generator(group, point, tmp_2, tmp_3))\n&quot;
+                        &quot;        goto err;\n&quot;
+                        &quot;ok = 1;&quot;
+                        &quot;\n&quot;);
+        BIO_printf(out, &quot;err:\n&quot;
+                        &quot;    BN_free(tmp_1);\n&quot;
+                        &quot;    BN_free(tmp_2);\n&quot;
+                        &quot;    BN_free(tmp_3);\n&quot;
+                        &quot;    EC_POINT_free(point);\n&quot;
+                        &quot;    if (!ok) {\n&quot;
+                        &quot;        EC_GROUP_free(group);\n&quot;
+                        &quot;        return NULL;\n&quot;
+                        &quot;    }\n&quot;
+                        &quot;    return (group);\n&quot;
+                        &quot;}\n&quot;);
     }
 
     if (!noout) {
         if (outformat == FORMAT_ASN1)
             i = i2d_ECPKParameters_bio(out, group);
-        else if (outformat == FORMAT_PEM)
+        else
             i = PEM_write_bio_ECPKParameters(out, group);
-        else {
-            BIO_printf(bio_err, &quot;bad output format specified for&quot;
-                       &quot; outfile\n&quot;);
-            goto end;
-        }
         if (!i) {
             BIO_printf(bio_err, &quot;unable to write elliptic &quot;
                        &quot;curve parameters\n&quot;);
@@ -567,7 +464,7 @@ int MAIN(int argc, char **argv)
     }
 
     if (need_rand) {
-        app_RAND_load_file(NULL, bio_err, (inrand != NULL));
+        app_RAND_load_file(NULL, (inrand != NULL));
         if (inrand != NULL)
             BIO_printf(bio_err, &quot;%ld semi-random bytes loaded\n&quot;,
                        app_RAND_load_files(inrand));
@@ -590,20 +487,14 @@ int MAIN(int argc, char **argv)
         }
         if (outformat == FORMAT_ASN1)
             i = i2d_ECPrivateKey_bio(out, eckey);
-        else if (outformat == FORMAT_PEM)
+        else
             i = PEM_write_bio_ECPrivateKey(out, eckey, NULL,
                                            NULL, 0, NULL, NULL);
-        else {
-            BIO_printf(bio_err, &quot;bad output format specified &quot;
-                       &quot;for outfile\n&quot;);
-            EC_KEY_free(eckey);
-            goto end;
-        }
         EC_KEY_free(eckey);
     }
 
     if (need_rand)
-        app_RAND_write_file(NULL, bio_err);
+        app_RAND_write_file(NULL);
 
     ret = 0;
  end:
@@ -624,32 +515,9 @@ int MAIN(int argc, char **argv)
     BIO_free(in);
     BIO_free_all(out);
     EC_GROUP_free(group);
-    apps_shutdown();
-    OPENSSL_EXIT(ret);
+    return (ret);
 }
 
-static int ecparam_print_var(BIO *out, BIGNUM *in, const char *var,
-                             int len, unsigned char *buffer)
-{
-    BIO_printf(out, &quot;static unsigned char %s_%d[] = {&quot;, var, len);
-    if (BN_is_zero(in))
-        BIO_printf(out, &quot;\n\t0x00&quot;);
-    else {
-        int i, l;
-
-        l = BN_bn2bin(in, buffer);
-        for (i = 0; i &lt; l - 1; i++) {
-            if ((i % 12) == 0)
-                BIO_printf(out, &quot;\n\t&quot;);
-            BIO_printf(out, &quot;0x%02X,&quot;, buffer[i]);
-        }
-        if ((i % 12) == 0)
-            BIO_printf(out, &quot;\n\t&quot;);
-        BIO_printf(out, &quot;0x%02X&quot;, buffer[i]);
-    }
-    BIO_printf(out, &quot;\n\t};\n\n&quot;);
-    return 1;
-}
 #else                           /* !OPENSSL_NO_EC */
 
 # if PEDANTIC
diff --git a/apps/enc.c b/apps/enc.c
index b95a6a2..06b056b 100644
--- a/apps/enc.c
+++ b/apps/enc.c
@@ -1,4 +1,3 @@
-/* apps/enc.c */
 /* Copyright (C) 1995-1998 Eric Young (<A HREF="../../../mailman/listinfo/openssl-commits.html">eay at cryptsoft.com</A>)
  * All rights reserved.
  *
@@ -72,307 +71,251 @@
 #endif
 #include &lt;ctype.h&gt;
 
-int set_hex(char *in, unsigned char *out, int size);
 #undef SIZE
 #undef BSIZE
-#undef PROG
-
 #define SIZE    (512)
 #define BSIZE   (8*1024)
-#define PROG    enc_main
-
-static void show_ciphers(const OBJ_NAME *name, void *bio_)
-{
-    BIO *bio = bio_;
-    static int n;
-
-    if (!islower((unsigned char)*name-&gt;name))
-        return;
-
-    BIO_printf(bio, &quot;-%-25s&quot;, name-&gt;name);
-    if (++n == 3) {
-        BIO_printf(bio, &quot;\n&quot;);
-        n = 0;
-    } else
-        BIO_printf(bio, &quot; &quot;);
-}
 
-int MAIN(int, char **);
-
-int MAIN(int argc, char **argv)
+static int set_hex(char *in, unsigned char *out, int size);
+static void show_ciphers(const OBJ_NAME *name, void *bio_);
+
+typedef enum OPTION_choice {
+    OPT_ERR = -1, OPT_EOF = 0, OPT_HELP,
+    OPT_E, OPT_IN, OPT_OUT, OPT_PASS, OPT_ENGINE, OPT_D, OPT_P, OPT_V,
+    OPT_NOPAD, OPT_SALT, OPT_NOSALT, OPT_DEBUG, OPT_UPPER_P, OPT_UPPER_A,
+    OPT_A, OPT_Z, OPT_BUFSIZE, OPT_K, OPT_KFILE, OPT_UPPER_K, OPT_NONE,
+    OPT_UPPER_S, OPT_IV, OPT_MD, OPT_NON_FIPS_ALLOW, OPT_CIPHER
+} OPTION_CHOICE;
+
+OPTIONS enc_options[] = {
+    {&quot;help&quot;, OPT_HELP, '-', &quot;Display this summary&quot;},
+    {&quot;in&quot;, OPT_IN, '&lt;', &quot;Input file&quot;},
+    {&quot;out&quot;, OPT_OUT, '&gt;', &quot;Output file&quot;},
+    {&quot;pass&quot;, OPT_PASS, 's', &quot;Passphrase source&quot;},
+#ifndef OPENSSL_NO_ENGINE
+    {&quot;engine&quot;, OPT_ENGINE, 's', &quot;Use engine, possibly a hardware device&quot;},
+#endif
+    {&quot;e&quot;, OPT_E, '-', &quot;Encrypt&quot;},
+    {&quot;d&quot;, OPT_D, '-', &quot;Decrypt&quot;},
+    {&quot;p&quot;, OPT_P, '-', &quot;Print the iv/key&quot;},
+    {&quot;P&quot;, OPT_UPPER_P, '-', &quot;Print the iv/key and exit&quot;},
+    {&quot;v&quot;, OPT_V, '-'},
+    {&quot;nopad&quot;, OPT_NOPAD, '-', &quot;Disable standard block padding&quot;},
+    {&quot;salt&quot;, OPT_SALT, '-'},
+    {&quot;nosalt&quot;, OPT_NOSALT, '-'},
+    {&quot;debug&quot;, OPT_DEBUG, '-'},
+    {&quot;A&quot;, OPT_UPPER_A, '-'},
+    {&quot;a&quot;, OPT_A, '-', &quot;base64 encode/decode, depending on encryption flag&quot;},
+    {&quot;base64&quot;, OPT_A, '-', &quot;Base64 output as a single line&quot;},
+#ifdef ZLIB
+    {&quot;z&quot;, OPT_Z, '-', &quot;Use zlib as the 'encryption'&quot;},
+#endif
+    {&quot;bufsize&quot;, OPT_BUFSIZE, 's', &quot;Buffer size&quot;},
+    {&quot;k&quot;, OPT_K, 's', &quot;Passphrase&quot;},
+    {&quot;kfile&quot;, OPT_KFILE, '&lt;', &quot;Fead passphrase from file&quot;},
+    {&quot;K&quot;, OPT_UPPER_K, '-', &quot;Same as -iv&quot;},
+    {&quot;S&quot;, OPT_UPPER_S, 's', &quot;Salt, in hex&quot;},
+    {&quot;iv&quot;, OPT_IV, 's', &quot;IV in hex&quot;},
+    {&quot;md&quot;, OPT_MD, 's', &quot;Use specified digest to create key from passphrase&quot;},
+    {&quot;non-fips-allow&quot;, OPT_NON_FIPS_ALLOW, '-'},
+    {&quot;none&quot;, OPT_NONE, '-', &quot;Don't encrypt&quot;},
+    {&quot;&quot;, OPT_CIPHER, '-', &quot;Any supported cipher&quot;},
+    {NULL}
+};
+
+int enc_main(int argc, char **argv)
 {
+    static char buf[128];
     static const char magic[] = &quot;Salted__&quot;;
+    BIO *in = NULL, *out = NULL, *b64 = NULL, *benc = NULL, *rbio =
+        NULL, *wbio = NULL;
+    EVP_CIPHER_CTX *ctx = NULL;
+    const EVP_CIPHER *cipher = NULL, *c;
+    const EVP_MD *dgst = NULL;
+    char *engine = NULL, *hkey = NULL, *hiv = NULL, *hsalt = NULL, *p;
+    char *infile = NULL, *outfile = NULL, *prog;
+    char *str = NULL, *passarg = NULL, *pass = NULL, *strbuf = NULL;
     char mbuf[sizeof magic - 1];
-    char *strbuf = NULL;
-    unsigned char *buff = NULL, *bufsize = NULL;
-    int bsize = BSIZE, verbose = 0;
-    int ret = 1, inl;
-    int nopad = 0;
+    OPTION_CHOICE o;
+    int bsize = BSIZE, verbose = 0, debug = 0, olb64 = 0, nosalt = 0;
+    int enc = 1, printkey = 0, i, k, base64 = 0;
+    int ret = 1, inl, nopad = 0, non_fips_allow = 0;
     unsigned char key[EVP_MAX_KEY_LENGTH], iv[EVP_MAX_IV_LENGTH];
-    unsigned char salt[PKCS5_SALT_LEN];
-    char *str = NULL, *passarg = NULL, *pass = NULL;
-    char *hkey = NULL, *hiv = NULL, *hsalt = NULL;
-    char *md = NULL;
-    int enc = 1, printkey = 0, i, base64 = 0;
+    unsigned char *buff = NULL, salt[PKCS5_SALT_LEN];
+    unsigned long n;
 #ifdef ZLIB
     int do_zlib = 0;
     BIO *bzl = NULL;
 #endif
-    int debug = 0, olb64 = 0, nosalt = 0;
-    const EVP_CIPHER *cipher = NULL, *c;
-    EVP_CIPHER_CTX *ctx = NULL;
-    char *inf = NULL, *outf = NULL;
-    BIO *in = NULL, *out = NULL, *b64 = NULL, *benc = NULL, *rbio =
-        NULL, *wbio = NULL;
-#define PROG_NAME_SIZE  39
-    char pname[PROG_NAME_SIZE + 1];
-#ifndef OPENSSL_NO_ENGINE
-    char *engine = NULL;
-#endif
-    const EVP_MD *dgst = NULL;
-    int non_fips_allow = 0;
-
-    apps_startup();
-
-    if (bio_err == NULL)
-        if ((bio_err = BIO_new(BIO_s_file())) != NULL)
-            BIO_set_fp(bio_err, stderr, BIO_NOCLOSE | BIO_FP_TEXT);
-
-    if (!load_config(bio_err, NULL))
-        goto end;
 
     /* first check the program name */
-    program_name(argv[0], pname, sizeof pname);
-    if (strcmp(pname, &quot;base64&quot;) == 0)
+    prog = opt_progname(argv[0]);
+    if (strcmp(prog, &quot;base64&quot;) == 0)
         base64 = 1;
 #ifdef ZLIB
-    if (strcmp(pname, &quot;zlib&quot;) == 0)
+    else if (strcmp(prog, &quot;zlib&quot;) == 0)
         do_zlib = 1;
 #endif
-
-    cipher = EVP_get_cipherbyname(pname);
-#ifdef ZLIB
-    if (!do_zlib &amp;&amp; !base64 &amp;&amp; (cipher == NULL)
-        &amp;&amp; (strcmp(pname, &quot;enc&quot;) != 0))
-#else
-    if (!base64 &amp;&amp; (cipher == NULL) &amp;&amp; (strcmp(pname, &quot;enc&quot;) != 0))
-#endif
-    {
-        BIO_printf(bio_err, &quot;%s is an unknown cipher\n&quot;, pname);
-        goto bad;
+    else {
+        cipher = EVP_get_cipherbyname(prog);
+        if (cipher == NULL &amp;&amp; strcmp(prog, &quot;enc&quot;) != 0) {
+            BIO_printf(bio_err, &quot;%s is not a known cipher\n&quot;, prog);
+            goto end;
+        }
     }
 
-    argc--;
-    argv++;
-    while (argc &gt;= 1) {
-        if (strcmp(*argv, &quot;-e&quot;) == 0)
+    prog = opt_init(argc, argv, enc_options);
+    while ((o = opt_next()) != OPT_EOF) {
+        switch (o) {
+        case OPT_EOF:
+        case OPT_ERR:
+ opthelp:
+            BIO_printf(bio_err, &quot;%s: Use -help for summary.\n&quot;, prog);
+            goto end;
+        case OPT_HELP:
+            opt_help(enc_options);
+            ret = 0;
+            BIO_printf(bio_err, &quot;Cipher Types\n&quot;);
+            OBJ_NAME_do_all_sorted(OBJ_NAME_TYPE_CIPHER_METH,
+                                   show_ciphers, bio_err);
+            BIO_printf(bio_err, &quot;\n&quot;);
+            goto end;
+        case OPT_E:
             enc = 1;
-        else if (strcmp(*argv, &quot;-in&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            inf = *(++argv);
-        } else if (strcmp(*argv, &quot;-out&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            outf = *(++argv);
-        } else if (strcmp(*argv, &quot;-pass&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            passarg = *(++argv);
-        }
-#ifndef OPENSSL_NO_ENGINE
-        else if (strcmp(*argv, &quot;-engine&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            engine = *(++argv);
-        }
-#endif
-        else if (strcmp(*argv, &quot;-d&quot;) == 0)
+            break;
+        case OPT_IN:
+            infile = opt_arg();
+            break;
+        case OPT_OUT:
+            outfile = opt_arg();
+            break;
+        case OPT_PASS:
+            passarg = opt_arg();
+            break;
+        case OPT_ENGINE:
+            engine = opt_arg();
+            break;
+        case OPT_D:
             enc = 0;
-        else if (strcmp(*argv, &quot;-p&quot;) == 0)
+            break;
+        case OPT_P:
             printkey = 1;
-        else if (strcmp(*argv, &quot;-v&quot;) == 0)
+            break;
+        case OPT_V:
             verbose = 1;
-        else if (strcmp(*argv, &quot;-nopad&quot;) == 0)
+            break;
+        case OPT_NOPAD:
             nopad = 1;
-        else if (strcmp(*argv, &quot;-salt&quot;) == 0)
+            break;
+        case OPT_SALT:
             nosalt = 0;
-        else if (strcmp(*argv, &quot;-nosalt&quot;) == 0)
+            break;
+        case OPT_NOSALT:
             nosalt = 1;
-        else if (strcmp(*argv, &quot;-debug&quot;) == 0)
+            break;
+        case OPT_DEBUG:
             debug = 1;
-        else if (strcmp(*argv, &quot;-P&quot;) == 0)
+            break;
+        case OPT_UPPER_P:
             printkey = 2;
-        else if (strcmp(*argv, &quot;-A&quot;) == 0)
+            break;
+        case OPT_UPPER_A:
             olb64 = 1;
-        else if (strcmp(*argv, &quot;-a&quot;) == 0)
-            base64 = 1;
-        else if (strcmp(*argv, &quot;-base64&quot;) == 0)
+            break;
+        case OPT_A:
             base64 = 1;
+            break;
+        case OPT_Z:
 #ifdef ZLIB
-        else if (strcmp(*argv, &quot;-z&quot;) == 0)
             do_zlib = 1;
 #endif
-        else if (strcmp(*argv, &quot;-bufsize&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            bufsize = (unsigned char *)*(++argv);
-        } else if (strcmp(*argv, &quot;-k&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            str = *(++argv);
-        } else if (strcmp(*argv, &quot;-kfile&quot;) == 0) {
-            static char buf[128];
-            FILE *infile;
-            char *file;
-
-            if (--argc &lt; 1)
-                goto bad;
-            file = *(++argv);
-            infile = fopen(file, &quot;r&quot;);
-            if (infile == NULL) {
-                BIO_printf(bio_err, &quot;unable to read key from '%s'\n&quot;, file);
-                goto bad;
-            }
-            buf[0] = '\0';
-            if (!fgets(buf, sizeof buf, infile)) {
-                BIO_printf(bio_err, &quot;unable to read key from '%s'\n&quot;, file);
-                goto bad;
+            break;
+        case OPT_BUFSIZE:
+            p = opt_arg();
+            i = (int)strlen(p) - 1;
+            k = i &gt;= 1 &amp;&amp; p[i] == 'k';
+            if (k)
+                p[i] = '\0';
+            if (!opt_ulong(opt_arg(), &amp;n))
+                goto opthelp;
+            if (k)
+                n *= 1024;
+            bsize = (int)n;
+            break;
+        case OPT_K:
+            str = opt_arg();
+            break;
+        case OPT_KFILE:
+            in = bio_open_default(opt_arg(), &quot;r&quot;);
+            if (in == NULL)
+                goto opthelp;
+            i = BIO_gets(in, buf, sizeof buf);
+            BIO_free(in);
+            in = NULL;
+            if (i &lt;= 0) {
+                BIO_printf(bio_err,
+                           &quot;%s Can't read key from %s\n&quot;, prog, opt_arg());
+                goto opthelp;
             }
-            fclose(infile);
-            i = strlen(buf);
-            if ((i &gt; 0) &amp;&amp; ((buf[i - 1] == '\n') || (buf[i - 1] == '\r')))
-                buf[--i] = '\0';
-            if ((i &gt; 0) &amp;&amp; ((buf[i - 1] == '\n') || (buf[i - 1] == '\r')))
-                buf[--i] = '\0';
-            if (i &lt; 1) {
-                BIO_printf(bio_err, &quot;zero length password\n&quot;);
-                goto bad;
+            while (--i &gt; 0 &amp;&amp; (buf[i] == '\r' || buf[i] == '\n'))
+                buf[i] = '\0';
+            if (i &lt;= 0) {
+                BIO_printf(bio_err, &quot;%s: zero length password\n&quot;, prog);
+                goto opthelp;
             }
             str = buf;
-        } else if (strcmp(*argv, &quot;-K&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            hkey = *(++argv);
-        } else if (strcmp(*argv, &quot;-S&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            hsalt = *(++argv);
-        } else if (strcmp(*argv, &quot;-iv&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            hiv = *(++argv);
-        } else if (strcmp(*argv, &quot;-md&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            md = *(++argv);
-        } else if (strcmp(*argv, &quot;-non-fips-allow&quot;) == 0)
+            break;
+        case OPT_UPPER_K:
+            hkey = opt_arg();
+            break;
+        case OPT_UPPER_S:
+            hsalt = opt_arg();
+            break;
+        case OPT_IV:
+            hiv = opt_arg();
+            break;
+        case OPT_MD:
+            if (!opt_md(opt_arg(), &amp;dgst))
+                goto opthelp;
+            break;
+        case OPT_NON_FIPS_ALLOW:
             non_fips_allow = 1;
-        else if ((argv[0][0] == '-') &amp;&amp;
-                 ((c = EVP_get_cipherbyname(&amp;(argv[0][1]))) != NULL)) {
+            break;
+        case OPT_CIPHER:
+            if (!opt_cipher(opt_unknown(), &amp;c))
+                goto opthelp;
             cipher = c;
-        } else if (strcmp(*argv, &quot;-none&quot;) == 0)
+            break;
+        case OPT_NONE:
             cipher = NULL;
-        else {
-            BIO_printf(bio_err, &quot;unknown option '%s'\n&quot;, *argv);
- bad:
-            BIO_printf(bio_err, &quot;options are\n&quot;);
-            BIO_printf(bio_err, &quot;%-14s input file\n&quot;, &quot;-in &lt;file&gt;&quot;);
-            BIO_printf(bio_err, &quot;%-14s output file\n&quot;, &quot;-out &lt;file&gt;&quot;);
-            BIO_printf(bio_err, &quot;%-14s pass phrase source\n&quot;, &quot;-pass &lt;arg&gt;&quot;);
-            BIO_printf(bio_err, &quot;%-14s encrypt\n&quot;, &quot;-e&quot;);
-            BIO_printf(bio_err, &quot;%-14s decrypt\n&quot;, &quot;-d&quot;);
-            BIO_printf(bio_err,
-                       &quot;%-14s base64 encode/decode, depending on encryption flag\n&quot;,
-                       &quot;-a/-base64&quot;);
-            BIO_printf(bio_err, &quot;%-14s passphrase is the next argument\n&quot;,
-                       &quot;-k&quot;);
-            BIO_printf(bio_err,
-                       &quot;%-14s passphrase is the first line of the file argument\n&quot;,
-                       &quot;-kfile&quot;);
-            BIO_printf(bio_err,
-                       &quot;%-14s the next argument is the md to use to create a key\n&quot;,
-                       &quot;-md&quot;);
-            BIO_printf(bio_err,
-                       &quot;%-14s   from a passphrase.  One of md2, md5, sha or sha1\n&quot;,
-                       &quot;&quot;);
-            BIO_printf(bio_err, &quot;%-14s salt in hex is the next argument\n&quot;,
-                       &quot;-S&quot;);
-            BIO_printf(bio_err, &quot;%-14s key/iv in hex is the next argument\n&quot;,
-                       &quot;-K/-iv&quot;);
-            BIO_printf(bio_err, &quot;%-14s print the iv/key (then exit if -P)\n&quot;,
-                       &quot;-[pP]&quot;);
-            BIO_printf(bio_err, &quot;%-14s buffer size\n&quot;, &quot;-bufsize &lt;n&gt;&quot;);
-            BIO_printf(bio_err, &quot;%-14s disable standard block padding\n&quot;,
-                       &quot;-nopad&quot;);
-#ifndef OPENSSL_NO_ENGINE
-            BIO_printf(bio_err,
-                       &quot;%-14s use engine e, possibly a hardware device.\n&quot;,
-                       &quot;-engine e&quot;);
-#endif
-
-            BIO_printf(bio_err, &quot;Cipher Types\n&quot;);
-            OBJ_NAME_do_all_sorted(OBJ_NAME_TYPE_CIPHER_METH,
-                                   show_ciphers, bio_err);
-            BIO_printf(bio_err, &quot;\n&quot;);
-
-            goto end;
+            break;
         }
-        argc--;
-        argv++;
     }
+    argc = opt_num_rest();
+    argv = opt_rest();
 
 #ifndef OPENSSL_NO_ENGINE
-    setup_engine(bio_err, engine, 0);
+    setup_engine(engine, 0);
 #endif
 
     if (cipher &amp;&amp; EVP_CIPHER_flags(cipher) &amp; EVP_CIPH_FLAG_AEAD_CIPHER) {
-        BIO_printf(bio_err,
-                   &quot;AEAD ciphers not supported by the enc utility\n&quot;);
+        BIO_printf(bio_err, &quot;%s: AEAD ciphers not supported\n&quot;, prog);
         goto end;
     }
 
     if (cipher &amp;&amp; (EVP_CIPHER_mode(cipher) == EVP_CIPH_XTS_MODE)) {
-        BIO_printf(bio_err,
-                   &quot;Ciphers in XTS mode are not supported by the enc utility\n&quot;);
+        BIO_printf(bio_err, &quot;%s XTS ciphers not supported\n&quot;, prog);
         goto end;
     }
 
-    if (md &amp;&amp; (dgst = EVP_get_digestbyname(md)) == NULL) {
-        BIO_printf(bio_err, &quot;%s is an unsupported message digest type\n&quot;, md);
-        goto end;
-    }
-
-    if (dgst == NULL) {
+    if (dgst == NULL)
         dgst = EVP_md5();
-    }
-
-    if (bufsize != NULL) {
-        unsigned long n;
-
-        for (n = 0; *bufsize; bufsize++) {
-            i = *bufsize;
-            if ((i &lt;= '9') &amp;&amp; (i &gt;= '0'))
-                n = n * 10 + i - '0';
-            else if (i == 'k') {
-                n *= 1024;
-                bufsize++;
-                break;
-            }
-        }
-        if (*bufsize != '\0') {
-            BIO_printf(bio_err, &quot;invalid 'bufsize' specified.\n&quot;);
-            goto end;
-        }
 
-        /* It must be large enough for a base64 encoded line */
-        if (base64 &amp;&amp; n &lt; 80)
-            n = 80;
-
-        bsize = (int)n;
-        if (verbose)
-            BIO_printf(bio_err, &quot;bufsize=%d\n&quot;, bsize);
-    }
+    /* It must be large enough for a base64 encoded line */
+    if (base64 &amp;&amp; bsize &lt; 80)
+        bsize = 80;
+    if (verbose)
+        BIO_printf(bio_err, &quot;bufsize=%d\n&quot;, bsize);
 
     strbuf = OPENSSL_malloc(SIZE);
     buff = (unsigned char *)OPENSSL_malloc(EVP_ENCODE_LENGTH(bsize));
@@ -382,12 +325,6 @@ int MAIN(int argc, char **argv)
         goto end;
     }
 
-    in = BIO_new(BIO_s_file());
-    out = BIO_new(BIO_s_file());
-    if ((in == NULL) || (out == NULL)) {
-        ERR_print_errors(bio_err);
-        goto end;
-    }
     if (debug) {
         BIO_set_callback(in, BIO_debug_callback);
         BIO_set_callback(out, BIO_debug_callback);
@@ -395,19 +332,16 @@ int MAIN(int argc, char **argv)
         BIO_set_callback_arg(out, (char *)bio_err);
     }
 
-    if (inf == NULL) {
-        if (bufsize != NULL)
-            setbuf(stdin, NULL);
-        BIO_set_fp(in, stdin, BIO_NOCLOSE);
-    } else {
-        if (BIO_read_filename(in, inf) &lt;= 0) {
-            perror(inf);
-            goto end;
-        }
-    }
+    if (infile == NULL) {
+        unbuffer(stdin);
+        in = dup_bio_in();
+    } else
+        in = bio_open_default(infile, &quot;r&quot;);
+    if (in == NULL)
+        goto end;
 
     if (!str &amp;&amp; passarg) {
-        if (!app_passwd(bio_err, passarg, NULL, &amp;pass, NULL)) {
+        if (!app_passwd(passarg, NULL, &amp;pass, NULL)) {
             BIO_printf(bio_err, &quot;Error getting password\n&quot;);
             goto end;
         }
@@ -416,13 +350,13 @@ int MAIN(int argc, char **argv)
 
     if ((str == NULL) &amp;&amp; (cipher != NULL) &amp;&amp; (hkey == NULL)) {
         for (;;) {
-            char buf[200];
+            char prompt[200];
 
-            BIO_snprintf(buf, sizeof buf, &quot;enter %s %s password:&quot;,
+            BIO_snprintf(prompt, sizeof prompt, &quot;enter %s %s password:&quot;,
                          OBJ_nid2ln(EVP_CIPHER_nid(cipher)),
                          (enc) ? &quot;encryption&quot; : &quot;decryption&quot;);
             strbuf[0] = '\0';
-            i = EVP_read_pw_string((char *)strbuf, SIZE, buf, enc);
+            i = EVP_read_pw_string((char *)strbuf, SIZE, prompt, enc);
             if (i == 0) {
                 if (strbuf[0] == '\0') {
                     ret = 1;
@@ -438,28 +372,14 @@ int MAIN(int argc, char **argv)
         }
     }
 
-    if (outf == NULL) {
-        BIO_set_fp(out, stdout, BIO_NOCLOSE);
-        if (bufsize != NULL)
-            setbuf(stdin, NULL); /* don't do buffered reads */
-#ifdef OPENSSL_SYS_VMS
-        {
-            BIO *tmpbio = BIO_new(BIO_f_linebuffer());
-            out = BIO_push(tmpbio, out);
-        }
-#endif
-    } else {
-        if (BIO_write_filename(out, outf) &lt;= 0) {
-            perror(outf);
-            goto end;
-        }
-    }
+    out = bio_open_default(outfile, &quot;w&quot;);
+    if (out == NULL)
+        goto end;
 
     rbio = in;
     wbio = out;
 
 #ifdef ZLIB
-
     if (do_zlib) {
         if ((bzl = BIO_new(BIO_f_zlib())) == NULL)
             goto end;
@@ -666,11 +586,26 @@ int MAIN(int argc, char **argv)
 #endif
     if (pass)
         OPENSSL_free(pass);
-    apps_shutdown();
-    OPENSSL_EXIT(ret);
+    return (ret);
+}
+
+static void show_ciphers(const OBJ_NAME *name, void *bio_)
+{
+    BIO *bio = bio_;
+    static int n;
+
+    if (!islower((unsigned char)*name-&gt;name))
+        return;
+
+    BIO_printf(bio, &quot;-%-25s&quot;, name-&gt;name);
+    if (++n == 3) {
+        BIO_printf(bio, &quot;\n&quot;);
+        n = 0;
+    } else
+        BIO_printf(bio, &quot; &quot;);
 }
 
-int set_hex(char *in, unsigned char *out, int size)
+static int set_hex(char *in, unsigned char *out, int size)
 {
     int i, n;
     unsigned char j;
diff --git a/apps/engine.c b/apps/engine.c
index 5386465..7dcc1b0 100644
--- a/apps/engine.c
+++ b/apps/engine.c
@@ -1,4 +1,3 @@
-/* apps/engine.c -*- mode: C; c-file-style: &quot;eay&quot; -*- */
 /*
  * Written by Richard Levitte &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">richard at levitte.org</A>&gt; for the OpenSSL project
  * 2000.
@@ -66,27 +65,26 @@
 # include &lt;openssl/engine.h&gt;
 # include &lt;openssl/ssl.h&gt;
 
-# undef PROG
-# define PROG    engine_main
-
-static const char *engine_usage[] = {
-    &quot;usage: engine opts [engine ...]\n&quot;,
-    &quot; -v[v[v[v]]] - verbose mode, for each engine, list its 'control commands'\n&quot;,
-    &quot;               -vv will additionally display each command's description\n&quot;,
-    &quot;               -vvv will also add the input flags for each command\n&quot;,
-    &quot;               -vvvv will also show internal input flags\n&quot;,
-    &quot; -c          - for each engine, also list the capabilities\n&quot;,
-    &quot; -t[t]       - for each engine, check that they are really available\n&quot;,
-    &quot;               -tt will display error trace for unavailable engines\n&quot;,
-    &quot; -pre &lt;cmd&gt;  - runs command 'cmd' against the ENGINE before any attempts\n&quot;,
-    &quot;               to load it (if -t is used)\n&quot;,
-    &quot; -post &lt;cmd&gt; - runs command 'cmd' against the ENGINE after loading it\n&quot;,
-    &quot;               (only used if -t is also provided)\n&quot;,
-    &quot; NB: -pre and -post will be applied to all ENGINEs supplied on the command\n&quot;,
-    &quot; line, or all supported ENGINEs if none are specified.\n&quot;,
-    &quot; Eg. '-pre \&quot;SO_PATH:/lib/libdriver.so\&quot;' calls command \&quot;SO_PATH\&quot; with\n&quot;,
-    &quot; argument \&quot;/lib/libdriver.so\&quot;.\n&quot;,
-    NULL
+typedef enum OPTION_choice {
+    OPT_ERR = -1, OPT_EOF = 0, OPT_HELP,
+    OPT_C, OPT_T, OPT_TT, OPT_PRE, OPT_POST,
+    OPT_V = 100, OPT_VV, OPT_VVV, OPT_VVVV
+} OPTION_CHOICE;
+
+OPTIONS engine_options[] = {
+    {&quot;help&quot;, OPT_HELP, '-', &quot;Display this summary&quot;},
+    {&quot;vvvv&quot;, OPT_VVVV, '-', &quot;Also show internal input flags&quot;},
+    {&quot;vvv&quot;, OPT_VVV, '-', &quot;Also add the input flags for each command&quot;},
+    {&quot;vv&quot;, OPT_VV, '-', &quot;Also display each command's description&quot;},
+    {&quot;v&quot;, OPT_V, '-', &quot;For each engine, list its 'control commands'&quot;},
+    {&quot;c&quot;, OPT_C, '-', &quot;List the capabilities of each engine&quot;},
+    {&quot;t&quot;, OPT_T, '-', &quot;Check that each engine is available&quot;},
+    {&quot;tt&quot;, OPT_TT, '-', &quot;Display error trace for unavailable engines&quot;},
+    {&quot;pre&quot;, OPT_PRE, 's', &quot;Run command against the ENGINE before loading it&quot;},
+    {&quot;post&quot;, OPT_POST, 's', &quot;Run command against the ENGINE after loading it&quot;},
+    {OPT_MORE_STR, OPT_EOF, 1,
+     &quot;Commands are like \&quot;SO_PATH:/lib/libdriver.so\&quot;&quot;},
+    {NULL}
 };
 
 static void identity(char *ptr)
@@ -124,13 +122,13 @@ static int append_buf(char **buf, const char *s, int *size, int step)
     return 1;
 }
 
-static int util_flags(BIO *bio_out, unsigned int flags, const char *indent)
+static int util_flags(BIO *out, unsigned int flags, const char *indent)
 {
     int started = 0, err = 0;
     /* Indent before displaying input flags */
-    BIO_printf(bio_out, &quot;%s%s(input flags): &quot;, indent, indent);
+    BIO_printf(out, &quot;%s%s(input flags): &quot;, indent, indent);
     if (flags == 0) {
-        BIO_printf(bio_out, &quot;&lt;no flags&gt;\n&quot;);
+        BIO_printf(out, &quot;&lt;no flags&gt;\n&quot;);
         return 1;
     }
     /*
@@ -138,11 +136,11 @@ static int util_flags(BIO *bio_out, unsigned int flags, const char *indent)
      * having it part of all the other flags, even if it really is.
      */
     if (flags &amp; ENGINE_CMD_FLAG_INTERNAL) {
-        BIO_printf(bio_out, &quot;[Internal] &quot;);
+        BIO_printf(out, &quot;[Internal] &quot;);
     }
 
     if (flags &amp; ENGINE_CMD_FLAG_NUMERIC) {
-        BIO_printf(bio_out, &quot;NUMERIC&quot;);
+        BIO_printf(out, &quot;NUMERIC&quot;);
         started = 1;
     }
     /*
@@ -153,18 +151,18 @@ static int util_flags(BIO *bio_out, unsigned int flags, const char *indent)
      */
     if (flags &amp; ENGINE_CMD_FLAG_STRING) {
         if (started) {
-            BIO_printf(bio_out, &quot;|&quot;);
+            BIO_printf(out, &quot;|&quot;);
             err = 1;
         }
-        BIO_printf(bio_out, &quot;STRING&quot;);
+        BIO_printf(out, &quot;STRING&quot;);
         started = 1;
     }
     if (flags &amp; ENGINE_CMD_FLAG_NO_INPUT) {
         if (started) {
-            BIO_printf(bio_out, &quot;|&quot;);
+            BIO_printf(out, &quot;|&quot;);
             err = 1;
         }
-        BIO_printf(bio_out, &quot;NO_INPUT&quot;);
+        BIO_printf(out, &quot;NO_INPUT&quot;);
         started = 1;
     }
     /* Check for unknown flags */
@@ -173,17 +171,16 @@ static int util_flags(BIO *bio_out, unsigned int flags, const char *indent)
         ~ENGINE_CMD_FLAG_NO_INPUT &amp; ~ENGINE_CMD_FLAG_INTERNAL;
     if (flags) {
         if (started)
-            BIO_printf(bio_out, &quot;|&quot;);
-        BIO_printf(bio_out, &quot;&lt;0x%04X&gt;&quot;, flags);
+            BIO_printf(out, &quot;|&quot;);
+        BIO_printf(out, &quot;&lt;0x%04X&gt;&quot;, flags);
     }
     if (err)
-        BIO_printf(bio_out, &quot;  &lt;illegal flags!&gt;&quot;);
-    BIO_printf(bio_out, &quot;\n&quot;);
+        BIO_printf(out, &quot;  &lt;illegal flags!&gt;&quot;);
+    BIO_printf(out, &quot;\n&quot;);
     return 1;
 }
 
-static int util_verbose(ENGINE *e, int verbose, BIO *bio_out,
-                        const char *indent)
+static int util_verbose(ENGINE *e, int verbose, BIO *out, const char *indent)
 {
     static const int line_wrap = 78;
     int num;
@@ -200,9 +197,9 @@ static int util_verbose(ENGINE *e, int verbose, BIO *bio_out,
     }
 
     cmds = sk_OPENSSL_STRING_new_null();
-
     if (!cmds)
         goto err;
+
     do {
         int len;
         /* Get the command input flags */
@@ -233,26 +230,26 @@ static int util_verbose(ENGINE *e, int verbose, BIO *bio_out,
             /* Now decide on the output */
             if (xpos == 0)
                 /* Do an indent */
-                xpos = BIO_puts(bio_out, indent);
+                xpos = BIO_puts(out, indent);
             else
                 /* Otherwise prepend a &quot;, &quot; */
-                xpos += BIO_printf(bio_out, &quot;, &quot;);
+                xpos += BIO_printf(out, &quot;, &quot;);
             if (verbose == 1) {
                 /*
                  * We're just listing names, comma-delimited
                  */
                 if ((xpos &gt; (int)strlen(indent)) &amp;&amp;
                     (xpos + (int)strlen(name) &gt; line_wrap)) {
-                    BIO_printf(bio_out, &quot;\n&quot;);
-                    xpos = BIO_puts(bio_out, indent);
+                    BIO_printf(out, &quot;\n&quot;);
+                    xpos = BIO_puts(out, indent);
                 }
-                xpos += BIO_printf(bio_out, &quot;%s&quot;, name);
+                xpos += BIO_printf(out, &quot;%s&quot;, name);
             } else {
                 /* We're listing names plus descriptions */
-                BIO_printf(bio_out, &quot;%s: %s\n&quot;, name,
+                BIO_printf(out, &quot;%s: %s\n&quot;, name,
                            (desc == NULL) ? &quot;&lt;no description&gt;&quot; : desc);
                 /* ... and sometimes input flags */
-                if ((verbose &gt;= 3) &amp;&amp; !util_flags(bio_out, flags, indent))
+                if ((verbose &gt;= 3) &amp;&amp; !util_flags(out, flags, indent))
                     goto err;
                 xpos = 0;
             }
@@ -267,7 +264,7 @@ static int util_verbose(ENGINE *e, int verbose, BIO *bio_out,
         num = ENGINE_ctrl(e, ENGINE_CTRL_GET_NEXT_CMD_TYPE, num, NULL, NULL);
     } while (num &gt; 0);
     if (xpos &gt; 0)
-        BIO_printf(bio_out, &quot;\n&quot;);
+        BIO_printf(out, &quot;\n&quot;);
     ret = 1;
  err:
     if (cmds)
@@ -280,12 +277,12 @@ static int util_verbose(ENGINE *e, int verbose, BIO *bio_out,
 }
 
 static void util_do_cmds(ENGINE *e, STACK_OF(OPENSSL_STRING) *cmds,
-                         BIO *bio_out, const char *indent)
+                         BIO *out, const char *indent)
 {
     int loop, res, num = sk_OPENSSL_STRING_num(cmds);
 
     if (num &lt; 0) {
-        BIO_printf(bio_out, &quot;[Error]: internal stack error\n&quot;);
+        BIO_printf(out, &quot;[Error]: internal stack error\n&quot;);
         return;
     }
     for (loop = 0; loop &lt; num; loop++) {
@@ -299,7 +296,7 @@ static void util_do_cmds(ENGINE *e, STACK_OF(OPENSSL_STRING) *cmds,
                 res = 0;
         } else {
             if ((int)(arg - cmd) &gt; 254) {
-                BIO_printf(bio_out, &quot;[Error]: command name too long\n&quot;);
+                BIO_printf(out, &quot;[Error]: command name too long\n&quot;);
                 return;
             }
             memcpy(buf, cmd, (int)(arg - cmd));
@@ -310,90 +307,70 @@ static void util_do_cmds(ENGINE *e, STACK_OF(OPENSSL_STRING) *cmds,
                 res = 0;
         }
         if (res)
-            BIO_printf(bio_out, &quot;[Success]: %s\n&quot;, cmd);
+            BIO_printf(out, &quot;[Success]: %s\n&quot;, cmd);
         else {
-            BIO_printf(bio_out, &quot;[Failure]: %s\n&quot;, cmd);
-            ERR_print_errors(bio_out);
+            BIO_printf(out, &quot;[Failure]: %s\n&quot;, cmd);
+            ERR_print_errors(out);
         }
     }
 }
 
-int MAIN(int, char **);
-
-int MAIN(int argc, char **argv)
+int engine_main(int argc, char **argv)
 {
     int ret = 1, i;
-    const char **pp;
     int verbose = 0, list_cap = 0, test_avail = 0, test_avail_noise = 0;
     ENGINE *e;
     STACK_OF(OPENSSL_STRING) *engines = sk_OPENSSL_STRING_new_null();
     STACK_OF(OPENSSL_STRING) *pre_cmds = sk_OPENSSL_STRING_new_null();
     STACK_OF(OPENSSL_STRING) *post_cmds = sk_OPENSSL_STRING_new_null();
-    int badops = 1;
-    BIO *bio_out = NULL;
+    BIO *out;
     const char *indent = &quot;     &quot;;
+    OPTION_CHOICE o;
+    char *prog;
 
-    apps_startup();
-    SSL_load_error_strings();
-
-    if (bio_err == NULL)
-        bio_err = BIO_new_fp(stderr, BIO_NOCLOSE);
-
-    if (!load_config(bio_err, NULL))
+    out = dup_bio_out();
+    prog = opt_init(argc, argv, engine_options);
+    if (!engines || !pre_cmds || !post_cmds)
         goto end;
-    bio_out = BIO_new_fp(stdout, BIO_NOCLOSE);
-# ifdef OPENSSL_SYS_VMS
-    {
-        BIO *tmpbio = BIO_new(BIO_f_linebuffer());
-        bio_out = BIO_push(tmpbio, bio_out);
-    }
-# endif
-
-    argc--;
-    argv++;
-    while (argc &gt;= 1) {
-        if (strncmp(*argv, &quot;-v&quot;, 2) == 0) {
-            if (strspn(*argv + 1, &quot;v&quot;) &lt; strlen(*argv + 1))
-                goto skip_arg_loop;
-            if ((verbose = strlen(*argv + 1)) &gt; 4)
-                goto skip_arg_loop;
-        } else if (strcmp(*argv, &quot;-c&quot;) == 0)
+    while ((o = opt_next()) != OPT_EOF) {
+        switch (o) {
+        case OPT_EOF:
+        case OPT_ERR:
+            BIO_printf(bio_err, &quot;%s: Use -help for summary.\n&quot;, prog);
+            goto end;
+        case OPT_HELP:
+            opt_help(engine_options);
+            ret = 0;
+            goto end;
+        case OPT_VVVV:
+        case OPT_VVV:
+        case OPT_VV:
+        case OPT_V:
+            /* Convert to an integer from one to four. */
+            i = (int)(o - OPT_V) + 1;
+            if (verbose &lt; i)
+                verbose = i;
+            break;
+        case OPT_C:
             list_cap = 1;
-        else if (strncmp(*argv, &quot;-t&quot;, 2) == 0) {
-            test_avail = 1;
-            if (strspn(*argv + 1, &quot;t&quot;) &lt; strlen(*argv + 1))
-                goto skip_arg_loop;
-            if ((test_avail_noise = strlen(*argv + 1) - 1) &gt; 1)
-                goto skip_arg_loop;
-        } else if (strcmp(*argv, &quot;-pre&quot;) == 0) {
-            argc--;
-            argv++;
-            if (argc == 0)
-                goto skip_arg_loop;
-            sk_OPENSSL_STRING_push(pre_cmds, *argv);
-        } else if (strcmp(*argv, &quot;-post&quot;) == 0) {
-            argc--;
-            argv++;
-            if (argc == 0)
-                goto skip_arg_loop;
-            sk_OPENSSL_STRING_push(post_cmds, *argv);
-        } else if ((strncmp(*argv, &quot;-h&quot;, 2) == 0) ||
-                   (strcmp(*argv, &quot;-?&quot;) == 0))
-            goto skip_arg_loop;
-        else
-            sk_OPENSSL_STRING_push(engines, *argv);
-        argc--;
-        argv++;
-    }
-    /* Looks like everything went OK */
-    badops = 0;
- skip_arg_loop:
-
-    if (badops) {
-        for (pp = engine_usage; (*pp != NULL); pp++)
-            BIO_printf(bio_err, &quot;%s&quot;, *pp);
-        goto end;
+            break;
+        case OPT_TT:
+            test_avail_noise++;
+        case OPT_T:
+            test_avail++;
+            break;
+        case OPT_PRE:
+            sk_OPENSSL_STRING_push(pre_cmds, opt_arg());
+            break;
+        case OPT_POST:
+            sk_OPENSSL_STRING_push(post_cmds, opt_arg());
+            break;
+        }
     }
+    argc = opt_num_rest();
+    argv = opt_rest();
+    for ( ; *argv; argv++)
+        sk_OPENSSL_STRING_push(engines, *argv);
 
     if (sk_OPENSSL_STRING_num(engines) == 0) {
         for (e = ENGINE_get_first(); e != NULL; e = ENGINE_get_next(e)) {
@@ -408,10 +385,10 @@ int MAIN(int argc, char **argv)
             /*
              * Do &quot;id&quot; first, then &quot;name&quot;. Easier to auto-parse.
              */
-            BIO_printf(bio_out, &quot;(%s) %s\n&quot;, id, name);
-            util_do_cmds(e, pre_cmds, bio_out, indent);
+            BIO_printf(out, &quot;(%s) %s\n&quot;, id, name);
+            util_do_cmds(e, pre_cmds, out, indent);
             if (strcmp(ENGINE_get_id(e), id) != 0) {
-                BIO_printf(bio_out, &quot;Loaded: (%s) %s\n&quot;,
+                BIO_printf(out, &quot;Loaded: (%s) %s\n&quot;,
                            ENGINE_get_id(e), ENGINE_get_name(e));
             }
             if (list_cap) {
@@ -466,24 +443,24 @@ int MAIN(int argc, char **argv)
                         goto end;
  skip_pmeths:
                 if (cap_buf &amp;&amp; (*cap_buf != '\0'))
-                    BIO_printf(bio_out, &quot; [%s]\n&quot;, cap_buf);
+                    BIO_printf(out, &quot; [%s]\n&quot;, cap_buf);
 
                 OPENSSL_free(cap_buf);
             }
             if (test_avail) {
-                BIO_printf(bio_out, &quot;%s&quot;, indent);
+                BIO_printf(out, &quot;%s&quot;, indent);
                 if (ENGINE_init(e)) {
-                    BIO_printf(bio_out, &quot;[ available ]\n&quot;);
-                    util_do_cmds(e, post_cmds, bio_out, indent);
+                    BIO_printf(out, &quot;[ available ]\n&quot;);
+                    util_do_cmds(e, post_cmds, out, indent);
                     ENGINE_finish(e);
                 } else {
-                    BIO_printf(bio_out, &quot;[ unavailable ]\n&quot;);
+                    BIO_printf(out, &quot;[ unavailable ]\n&quot;);
                     if (test_avail_noise)
                         ERR_print_errors_fp(stdout);
                     ERR_clear_error();
                 }
             }
-            if ((verbose &gt; 0) &amp;&amp; !util_verbose(e, verbose, bio_out, indent))
+            if ((verbose &gt; 0) &amp;&amp; !util_verbose(e, verbose, out, indent))
                 goto end;
             ENGINE_free(e);
         } else
@@ -497,9 +474,8 @@ int MAIN(int argc, char **argv)
     sk_OPENSSL_STRING_pop_free(engines, identity);
     sk_OPENSSL_STRING_pop_free(pre_cmds, identity);
     sk_OPENSSL_STRING_pop_free(post_cmds, identity);
-    BIO_free_all(bio_out);
-    apps_shutdown();
-    OPENSSL_EXIT(ret);
+    BIO_free_all(out);
+    return (ret);
 }
 #else
 
diff --git a/apps/errstr.c b/apps/errstr.c
index 668c5f3..960815d 100644
--- a/apps/errstr.c
+++ b/apps/errstr.c
@@ -1,4 +1,3 @@
-/* apps/errstr.c */
 /* Copyright (C) 1995-1998 Eric Young (<A HREF="../../../mailman/listinfo/openssl-commits.html">eay at cryptsoft.com</A>)
  * All rights reserved.
  *
@@ -65,56 +64,60 @@
 #include &lt;openssl/err.h&gt;
 #include &lt;openssl/ssl.h&gt;
 
-#undef PROG
-#define PROG    errstr_main
+typedef enum OPTION_choice {
+    OPT_ERR = -1, OPT_EOF = 0, OPT_HELP,
+    OPT_STATS
+} OPTION_CHOICE;
 
-int MAIN(int, char **);
+OPTIONS errstr_options[] = {
+    {OPT_HELP_STR, 1, '-', &quot;Usage: %s [options] errnum...\n&quot;},
+    {OPT_HELP_STR, 1, '-', &quot;  errnum  Error number\n&quot;},
+    {&quot;help&quot;, OPT_HELP, '-', &quot;Display this summary&quot;},
+    {&quot;stats&quot;, OPT_STATS, '-',
+     &quot;Print internal hashtable statistics (long!)&quot;},
+    {NULL}
+};
 
-int MAIN(int argc, char **argv)
+int errstr_main(int argc, char **argv)
 {
-    int i, ret = 0;
-    char buf[256];
+    OPTION_CHOICE o;
+    char buf[256], *prog;
+    int ret = 1;
     unsigned long l;
 
-    apps_startup();
-
-    if (bio_err == NULL)
-        if ((bio_err = BIO_new(BIO_s_file())) != NULL)
-            BIO_set_fp(bio_err, stderr, BIO_NOCLOSE | BIO_FP_TEXT);
-
-    SSL_load_error_strings();
-
-    if ((argc &gt; 1) &amp;&amp; (strcmp(argv[1], &quot;-stats&quot;) == 0)) {
-        BIO *out = NULL;
-
-        out = BIO_new(BIO_s_file());
-        if ((out != NULL) &amp;&amp; BIO_set_fp(out, stdout, BIO_NOCLOSE)) {
-#ifdef OPENSSL_SYS_VMS
-            {
-                BIO *tmpbio = BIO_new(BIO_f_linebuffer());
-                out = BIO_push(tmpbio, out);
-            }
-#endif
-            lh_ERR_STRING_DATA_node_stats_bio(ERR_get_string_table(), out);
-            lh_ERR_STRING_DATA_stats_bio(ERR_get_string_table(), out);
+    prog = opt_init(argc, argv, errstr_options);
+    while ((o = opt_next()) != OPT_EOF) {
+        switch (o) {
+        case OPT_EOF:
+        case OPT_ERR:
+            BIO_printf(bio_err, &quot;%s: Use -help for summary.\n&quot;, prog);
+            goto end;
+        case OPT_HELP:
+            opt_help(errstr_options);
+            ret = 0;
+            goto end;
+        case OPT_STATS:
+            lh_ERR_STRING_DATA_node_stats_bio(ERR_get_string_table(),
+                                              bio_out);
+            lh_ERR_STRING_DATA_stats_bio(ERR_get_string_table(), bio_out);
             lh_ERR_STRING_DATA_node_usage_stats_bio(ERR_get_string_table(),
-                                                    out);
+                                                    bio_out);
+            ret = 0;
+            goto end;
         }
-        BIO_free_all(out);
-        argc--;
-        argv++;
     }
+    argc = opt_num_rest();
+    argv = opt_rest();
 
-    for (i = 1; i &lt; argc; i++) {
-        if (sscanf(argv[i], &quot;%lx&quot;, &amp;l)) {
-            ERR_error_string_n(l, buf, sizeof buf);
-            printf(&quot;%s\n&quot;, buf);
-        } else {
-            printf(&quot;%s: bad error code\n&quot;, argv[i]);
-            printf(&quot;usage: errstr [-stats] &lt;errno&gt; ...\n&quot;);
+    ret = 0;
+    for (argv = opt_rest(); *argv; argv++) {
+        if (!opt_ulong(*argv, &amp;l))
             ret++;
+        else {
+            ERR_error_string_n(l, buf, sizeof buf);
+            BIO_printf(bio_out, &quot;%s\n&quot;, buf);
         }
     }
-    apps_shutdown();
-    OPENSSL_EXIT(ret);
+ end:
+    return (ret);
 }
diff --git a/apps/gendh.c b/apps/gendh.c
deleted file mode 100644
index 904bcf3..0000000
--- a/apps/gendh.c
+++ /dev/null
@@ -1,243 +0,0 @@
-/* apps/gendh.c */
-/* obsoleted by dhparam.c */
-/* Copyright (C) 1995-1998 Eric Young (<A HREF="../../../mailman/listinfo/openssl-commits.html">eay at cryptsoft.com</A>)
- * All rights reserved.
- *
- * This package is an SSL implementation written
- * by Eric Young (<A HREF="../../../mailman/listinfo/openssl-commits.html">eay at cryptsoft.com</A>).
- * The implementation was written so as to conform with Netscapes SSL.
- *
- * This library is free for commercial and non-commercial use as long as
- * the following conditions are aheared to.  The following conditions
- * apply to all code found in this distribution, be it the RC4, RSA,
- * lhash, DES, etc., code; not just the SSL code.  The SSL documentation
- * included with this distribution is covered by the same copyright terms
- * except that the holder is Tim Hudson (<A HREF="../../../mailman/listinfo/openssl-commits.html">tjh at cryptsoft.com</A>).
- *
- * Copyright remains Eric Young's, and as such any Copyright notices in
- * the code are not to be removed.
- * If this package is used in a product, Eric Young should be given attribution
- * as the author of the parts of the library used.
- * This can be in the form of a textual message at program startup or
- * in documentation (online or textual) provided with the package.
- *
- * Redistribution and use in source and binary forms, with or without
- * modification, are permitted provided that the following conditions
- * are met:
- * 1. Redistributions of source code must retain the copyright
- *    notice, this list of conditions and the following disclaimer.
- * 2. Redistributions in binary form must reproduce the above copyright
- *    notice, this list of conditions and the following disclaimer in the
- *    documentation and/or other materials provided with the distribution.
- * 3. All advertising materials mentioning features or use of this software
- *    must display the following acknowledgement:
- *    &quot;This product includes cryptographic software written by
- *     Eric Young (<A HREF="../../../mailman/listinfo/openssl-commits.html">eay at cryptsoft.com</A>)&quot;
- *    The word 'cryptographic' can be left out if the rouines from the library
- *    being used are not cryptographic related :-).
- * 4. If you include any Windows specific code (or a derivative thereof) from
- *    the apps directory (application code) you must include an acknowledgement:
- *    &quot;This product includes software written by Tim Hudson (<A HREF="../../../mailman/listinfo/openssl-commits.html">tjh at cryptsoft.com</A>)&quot;
- *
- * THIS SOFTWARE IS PROVIDED BY ERIC YOUNG ``AS IS'' AND
- * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
- * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE
- * ARE DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE
- * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL
- * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS
- * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)
- * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT
- * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY
- * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
- * SUCH DAMAGE.
- *
- * The licence and distribution terms for any publically available version or
- * derivative of this code cannot be changed.  i.e. this code cannot simply be
- * copied and put under another distribution licence
- * [including the GNU Public Licence.]
- */
-
-#include &lt;openssl/opensslconf.h&gt;
-
-#ifndef OPENSSL_NO_DH
-# include &lt;stdio.h&gt;
-# include &lt;string.h&gt;
-# include &lt;sys/types.h&gt;
-# include &lt;sys/stat.h&gt;
-# include &quot;apps.h&quot;
-# include &lt;openssl/bio.h&gt;
-# include &lt;openssl/rand.h&gt;
-# include &lt;openssl/err.h&gt;
-# include &lt;openssl/bn.h&gt;
-# include &lt;openssl/dh.h&gt;
-# include &lt;openssl/x509.h&gt;
-# include &lt;openssl/pem.h&gt;
-
-# define DEFBITS 2048
-# undef PROG
-# define PROG gendh_main
-
-static int dh_cb(int p, int n, BN_GENCB *cb);
-
-int MAIN(int, char **);
-
-int MAIN(int argc, char **argv)
-{
-    BN_GENCB *cb = NULL;
-    DH *dh = NULL;
-    int ret = 1, num = DEFBITS;
-    int g = 2;
-    char *outfile = NULL;
-    char *inrand = NULL;
-# ifndef OPENSSL_NO_ENGINE
-    char *engine = NULL;
-# endif
-    BIO *out = NULL;
-
-    apps_startup();
-
-    if (bio_err == NULL)
-        if ((bio_err = BIO_new(BIO_s_file())) != NULL)
-            BIO_set_fp(bio_err, stderr, BIO_NOCLOSE | BIO_FP_TEXT);
-
-    cb = BN_GENCB_new();
-    if (!cb)
-        goto end;
-
-    BN_GENCB_set(cb, dh_cb, bio_err);
-
-    if (!load_config(bio_err, NULL))
-        goto end;
-
-    argv++;
-    argc--;
-    for (;;) {
-        if (argc &lt;= 0)
-            break;
-        if (strcmp(*argv, &quot;-out&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            outfile = *(++argv);
-        } else if (strcmp(*argv, &quot;-2&quot;) == 0)
-            g = 2;
-/*-     else if (strcmp(*argv,&quot;-3&quot;) == 0)
-                g=3; */
-        else if (strcmp(*argv, &quot;-5&quot;) == 0)
-            g = 5;
-# ifndef OPENSSL_NO_ENGINE
-        else if (strcmp(*argv, &quot;-engine&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            engine = *(++argv);
-        }
-# endif
-        else if (strcmp(*argv, &quot;-rand&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            inrand = *(++argv);
-        } else
-            break;
-        argv++;
-        argc--;
-    }
-    if ((argc &gt;= 1) &amp;&amp; ((sscanf(*argv, &quot;%d&quot;, &amp;num) == 0) || (num &lt; 0))) {
- bad:
-        BIO_printf(bio_err, &quot;usage: gendh [args] [numbits]\n&quot;);
-        BIO_printf(bio_err, &quot; -out file - output the key to 'file\n&quot;);
-        BIO_printf(bio_err, &quot; -2        - use 2 as the generator value\n&quot;);
-        /*
-         * BIO_printf(bio_err,&quot; -3 - use 3 as the generator value\n&quot;);
-         */
-        BIO_printf(bio_err, &quot; -5        - use 5 as the generator value\n&quot;);
-# ifndef OPENSSL_NO_ENGINE
-        BIO_printf(bio_err,
-                   &quot; -engine e - use engine e, possibly a hardware device.\n&quot;);
-# endif
-        BIO_printf(bio_err, &quot; -rand file%cfile%c...\n&quot;, LIST_SEPARATOR_CHAR,
-                   LIST_SEPARATOR_CHAR);
-        BIO_printf(bio_err,
-                   &quot;           - load the file (or the files in the directory) into\n&quot;);
-        BIO_printf(bio_err, &quot;             the random number generator\n&quot;);
-        goto end;
-    }
-# ifndef OPENSSL_NO_ENGINE
-    setup_engine(bio_err, engine, 0);
-# endif
-
-    out = BIO_new(BIO_s_file());
-    if (out == NULL) {
-        ERR_print_errors(bio_err);
-        goto end;
-    }
-
-    if (outfile == NULL) {
-        BIO_set_fp(out, stdout, BIO_NOCLOSE);
-# ifdef OPENSSL_SYS_VMS
-        {
-            BIO *tmpbio = BIO_new(BIO_f_linebuffer());
-            out = BIO_push(tmpbio, out);
-        }
-# endif
-    } else {
-        if (BIO_write_filename(out, outfile) &lt;= 0) {
-            perror(outfile);
-            goto end;
-        }
-    }
-
-    if (!app_RAND_load_file(NULL, bio_err, 1) &amp;&amp; inrand == NULL) {
-        BIO_printf(bio_err,
-                   &quot;warning, not much extra random data, consider using the -rand option\n&quot;);
-    }
-    if (inrand != NULL)
-        BIO_printf(bio_err, &quot;%ld semi-random bytes loaded\n&quot;,
-                   app_RAND_load_files(inrand));
-
-    BIO_printf(bio_err,
-               &quot;Generating DH parameters, %d bit long safe prime, generator %d\n&quot;,
-               num, g);
-    BIO_printf(bio_err, &quot;This is going to take a long time\n&quot;);
-
-    if (((dh = DH_new()) == NULL)
-        || !DH_generate_parameters_ex(dh, num, g, cb))
-        goto end;
-
-    app_RAND_write_file(NULL, bio_err);
-
-    if (!PEM_write_bio_DHparams(out, dh))
-        goto end;
-    ret = 0;
- end:
-    if (ret != 0)
-        ERR_print_errors(bio_err);
-    BIO_free_all(out);
-    DH_free(dh);
-    if (cb != NULL)
-        BN_GENCB_free(cb);
-    apps_shutdown();
-    OPENSSL_EXIT(ret);
-}
-
-static int dh_cb(int p, int n, BN_GENCB *cb)
-{
-    char c = '*';
-
-    if (p == 0)
-        c = '.';
-    if (p == 1)
-        c = '+';
-    if (p == 2)
-        c = '*';
-    if (p == 3)
-        c = '\n';
-    BIO_write(BN_GENCB_get_arg(cb), &amp;c, 1);
-    (void)BIO_flush(BN_GENCB_get_arg(cb));
-    return 1;
-}
-#else                           /* !OPENSSL_NO_DH */
-
-# if PEDANTIC
-static void *dummy = &dummy;
-# endif
-
-#endif
diff --git a/apps/gendsa.c b/apps/gendsa.c
index 8288eb9..1eaaa45 100644
--- a/apps/gendsa.c
+++ b/apps/gendsa.c
@@ -1,4 +1,3 @@
-/* apps/gendsa.c */
 /* Copyright (C) 1995-1998 Eric Young (<A HREF="../../../mailman/listinfo/openssl-commits.html">eay at cryptsoft.com</A>)
  * All rights reserved.
  *
@@ -71,155 +70,86 @@
 # include &lt;openssl/pem.h&gt;
 
 # define DEFBITS 512
-# undef PROG
-# define PROG gendsa_main
 
-int MAIN(int, char **);
+typedef enum OPTION_choice {
+    OPT_ERR = -1, OPT_EOF = 0, OPT_HELP,
+    OPT_OUT, OPT_PASSOUT, OPT_ENGINE, OPT_RAND, OPT_CIPHER
+} OPTION_CHOICE;
+
+OPTIONS gendsa_options[] = {
+    {OPT_HELP_STR, 1, '-', &quot;Usage: %s [args] dsaparam-file\n&quot;},
+    {OPT_HELP_STR, 1, '-', &quot;Valid options are:\n&quot;},
+    {&quot;help&quot;, OPT_HELP, '-', &quot;Display this summary&quot;},
+    {&quot;out&quot;, OPT_OUT, '&gt;', &quot;Output the key to the specified file&quot;},
+    {&quot;passout&quot;, OPT_PASSOUT, 's'},
+    {&quot;rand&quot;, OPT_RAND, 's',
+     &quot;Load the file(s) into the random number generator&quot;},
+# ifndef OPENSSL_NO_ENGINE
+    {&quot;engine&quot;, OPT_ENGINE, 's', &quot;Use engine, possibly a hardware device&quot;},
+# endif
+    {&quot;&quot;, OPT_CIPHER, '-', &quot;Encrypt the output with any supported cipher&quot;},
+    {NULL}
+};
 
-int MAIN(int argc, char **argv)
+int gendsa_main(int argc, char **argv)
 {
-    DSA *dsa = NULL;
-    int ret = 1;
-    char *outfile = NULL;
-    char *inrand = NULL, *dsaparams = NULL;
-    char *passargout = NULL, *passout = NULL;
     BIO *out = NULL, *in = NULL;
+    DSA *dsa = NULL;
     const EVP_CIPHER *enc = NULL;
-# ifndef OPENSSL_NO_ENGINE
-    char *engine = NULL;
-# endif
-
-    apps_startup();
-
-    if (bio_err == NULL)
-        if ((bio_err = BIO_new(BIO_s_file())) != NULL)
-            BIO_set_fp(bio_err, stderr, BIO_NOCLOSE | BIO_FP_TEXT);
-
-    if (!load_config(bio_err, NULL))
-        goto end;
+    char *engine = NULL, *inrand = NULL, *dsaparams = NULL;
+    char *outfile = NULL, *passoutarg = NULL, *passout = NULL, *prog;
+    OPTION_CHOICE o;
+    int ret = 1;
 
-    argv++;
-    argc--;
-    for (;;) {
-        if (argc &lt;= 0)
+    prog = opt_init(argc, argv, gendsa_options);
+    while ((o = opt_next()) != OPT_EOF) {
+        switch (o) {
+        case OPT_EOF:
+        case OPT_ERR:
+ opthelp:
+            BIO_printf(bio_err, &quot;%s: Use -help for summary.\n&quot;, prog);
+            goto end;
+        case OPT_HELP:
+            ret = 0;
+            opt_help(gendsa_options);
+            goto end;
+        case OPT_OUT:
+            outfile = opt_arg();
+            break;
+        case OPT_PASSOUT:
+            passoutarg = opt_arg();
+            break;
+        case OPT_ENGINE:
+            engine = opt_arg();
+            break;
+        case OPT_RAND:
+            inrand = opt_arg();
+            break;
+        case OPT_CIPHER:
+            if (!opt_cipher(opt_unknown(), &amp;enc))
+                goto end;
             break;
-        if (strcmp(*argv, &quot;-out&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            outfile = *(++argv);
-        } else if (strcmp(*argv, &quot;-passout&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            passargout = *(++argv);
-        }
-# ifndef OPENSSL_NO_ENGINE
-        else if (strcmp(*argv, &quot;-engine&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            engine = *(++argv);
         }
-# endif
-        else if (strcmp(*argv, &quot;-rand&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            inrand = *(++argv);
-        } else if (strcmp(*argv, &quot;-&quot;) == 0)
-            goto bad;
-# ifndef OPENSSL_NO_DES
-        else if (strcmp(*argv, &quot;-des&quot;) == 0)
-            enc = EVP_des_cbc();
-        else if (strcmp(*argv, &quot;-des3&quot;) == 0)
-            enc = EVP_des_ede3_cbc();
-# endif
-# ifndef OPENSSL_NO_IDEA
-        else if (strcmp(*argv, &quot;-idea&quot;) == 0)
-            enc = EVP_idea_cbc();
-# endif
-# ifndef OPENSSL_NO_SEED
-        else if (strcmp(*argv, &quot;-seed&quot;) == 0)
-            enc = EVP_seed_cbc();
-# endif
-# ifndef OPENSSL_NO_AES
-        else if (strcmp(*argv, &quot;-aes128&quot;) == 0)
-            enc = EVP_aes_128_cbc();
-        else if (strcmp(*argv, &quot;-aes192&quot;) == 0)
-            enc = EVP_aes_192_cbc();
-        else if (strcmp(*argv, &quot;-aes256&quot;) == 0)
-            enc = EVP_aes_256_cbc();
-# endif
-# ifndef OPENSSL_NO_CAMELLIA
-        else if (strcmp(*argv, &quot;-camellia128&quot;) == 0)
-            enc = EVP_camellia_128_cbc();
-        else if (strcmp(*argv, &quot;-camellia192&quot;) == 0)
-            enc = EVP_camellia_192_cbc();
-        else if (strcmp(*argv, &quot;-camellia256&quot;) == 0)
-            enc = EVP_camellia_256_cbc();
-# endif
-        else if (**argv != '-' &amp;&amp; dsaparams == NULL) {
-            dsaparams = *argv;
-        } else
-            goto bad;
-        argv++;
-        argc--;
     }
+    argc = opt_num_rest();
+    argv = opt_rest();
+
+    if (argc != 1)
+        goto opthelp;
+    dsaparams = *argv;
 
-    if (dsaparams == NULL) {
- bad:
-        BIO_printf(bio_err, &quot;usage: gendsa [args] dsaparam-file\n&quot;);
-        BIO_printf(bio_err, &quot; -out file - output the key to 'file'\n&quot;);
-# ifndef OPENSSL_NO_DES
-        BIO_printf(bio_err,
-                   &quot; -des      - encrypt the generated key with DES in cbc mode\n&quot;);
-        BIO_printf(bio_err,
-                   &quot; -des3     - encrypt the generated key with DES in ede cbc mode (168 bit key)\n&quot;);
-# endif
-# ifndef OPENSSL_NO_IDEA
-        BIO_printf(bio_err,
-                   &quot; -idea     - encrypt the generated key with IDEA in cbc mode\n&quot;);
-# endif
-# ifndef OPENSSL_NO_SEED
-        BIO_printf(bio_err, &quot; -seed\n&quot;);
-        BIO_printf(bio_err,
-                   &quot;                 encrypt PEM output with cbc seed\n&quot;);
-# endif
-# ifndef OPENSSL_NO_AES
-        BIO_printf(bio_err, &quot; -aes128, -aes192, -aes256\n&quot;);
-        BIO_printf(bio_err,
-                   &quot;                 encrypt PEM output with cbc aes\n&quot;);
-# endif
-# ifndef OPENSSL_NO_CAMELLIA
-        BIO_printf(bio_err, &quot; -camellia128, -camellia192, -camellia256\n&quot;);
-        BIO_printf(bio_err,
-                   &quot;                 encrypt PEM output with cbc camellia\n&quot;);
-# endif
-# ifndef OPENSSL_NO_ENGINE
-        BIO_printf(bio_err,
-                   &quot; -engine e - use engine e, possibly a hardware device.\n&quot;);
-# endif
-        BIO_printf(bio_err, &quot; -rand file%cfile%c...\n&quot;, LIST_SEPARATOR_CHAR,
-                   LIST_SEPARATOR_CHAR);
-        BIO_printf(bio_err,
-                   &quot;           - load the file (or the files in the directory) into\n&quot;);
-        BIO_printf(bio_err, &quot;             the random number generator\n&quot;);
-        BIO_printf(bio_err, &quot; dsaparam-file\n&quot;);
-        BIO_printf(bio_err,
-                   &quot;           - a DSA parameter file as generated by the dsaparam command\n&quot;);
-        goto end;
-    }
 # ifndef OPENSSL_NO_ENGINE
-    setup_engine(bio_err, engine, 0);
+    setup_engine(engine, 0);
 # endif
 
-    if (!app_passwd(bio_err, NULL, passargout, NULL, &amp;passout)) {
+    if (!app_passwd(NULL, passoutarg, NULL, &amp;passout)) {
         BIO_printf(bio_err, &quot;Error getting password\n&quot;);
         goto end;
     }
 
-    in = BIO_new(BIO_s_file());
-    if (!(BIO_read_filename(in, dsaparams))) {
-        perror(dsaparams);
-        goto end;
-    }
+    in = bio_open_default(dsaparams, &quot;r&quot;);
+    if (in == NULL)
+        goto end2;
 
     if ((dsa = PEM_read_bio_DSAparams(in, NULL, NULL, NULL)) == NULL) {
         BIO_printf(bio_err, &quot;unable to load DSA parameter file\n&quot;);
@@ -228,26 +158,11 @@ int MAIN(int argc, char **argv)
     BIO_free(in);
     in = NULL;
 
-    out = BIO_new(BIO_s_file());
+    out = bio_open_default(outfile, &quot;w&quot;);
     if (out == NULL)
-        goto end;
-
-    if (outfile == NULL) {
-        BIO_set_fp(out, stdout, BIO_NOCLOSE);
-# ifdef OPENSSL_SYS_VMS
-        {
-            BIO *tmpbio = BIO_new(BIO_f_linebuffer());
-            out = BIO_push(tmpbio, out);
-        }
-# endif
-    } else {
-        if (BIO_write_filename(out, outfile) &lt;= 0) {
-            perror(outfile);
-            goto end;
-        }
-    }
+        goto end2;
 
-    if (!app_RAND_load_file(NULL, bio_err, 1) &amp;&amp; inrand == NULL) {
+    if (!app_RAND_load_file(NULL, 1) &amp;&amp; inrand == NULL) {
         BIO_printf(bio_err,
                    &quot;warning, not much extra random data, consider using the -rand option\n&quot;);
     }
@@ -259,7 +174,7 @@ int MAIN(int argc, char **argv)
     if (!DSA_generate_key(dsa))
         goto end;
 
-    app_RAND_write_file(NULL, bio_err);
+    app_RAND_write_file(NULL);
 
     if (!PEM_write_bio_DSAPrivateKey(out, dsa, enc, NULL, 0, NULL, passout))
         goto end;
@@ -267,13 +182,13 @@ int MAIN(int argc, char **argv)
  end:
     if (ret != 0)
         ERR_print_errors(bio_err);
+ end2:
     BIO_free(in);
     BIO_free_all(out);
     DSA_free(dsa);
     if (passout)
         OPENSSL_free(passout);
-    apps_shutdown();
-    OPENSSL_EXIT(ret);
+    return (ret);
 }
 #else                           /* !OPENSSL_NO_DSA */
 
diff --git a/apps/genpkey.c b/apps/genpkey.c
index bd81d51..5130b40 100644
--- a/apps/genpkey.c
+++ b/apps/genpkey.c
@@ -1,4 +1,3 @@
-/* apps/genpkey.c */
 /*
  * Written by Dr Stephen N Henson (<A HREF="../../../mailman/listinfo/openssl-commits.html">steve at openssl.org</A>) for the OpenSSL project
  * 2006
@@ -66,159 +65,125 @@
 # include &lt;openssl/engine.h&gt;
 #endif
 
-static int init_keygen_file(BIO *err, EVP_PKEY_CTX **pctx,
-                            const char *file, ENGINE *e);
+static int init_keygen_file(EVP_PKEY_CTX **pctx, const char *file, ENGINE *e);
 static int genpkey_cb(EVP_PKEY_CTX *ctx);
 
-#define PROG genpkey_main
-
-int MAIN(int, char **);
+typedef enum OPTION_choice {
+    OPT_ERR = -1, OPT_EOF = 0, OPT_HELP,
+    OPT_ENGINE, OPT_OUTFORM, OPT_OUT, OPT_PASS, OPT_PARAMFILE,
+    OPT_ALGORITHM, OPT_PKEYOPT, OPT_GENPARAM, OPT_TEXT, OPT_CIPHER
+} OPTION_CHOICE;
+
+OPTIONS genpkey_options[] = {
+    {&quot;help&quot;, OPT_HELP, '-', &quot;Display this summary&quot;},
+    {&quot;out&quot;, OPT_OUT, '&gt;', &quot;Output file&quot;},
+    {&quot;outform&quot;, OPT_OUTFORM, 'F', &quot;output format (DER or PEM)&quot;},
+    {&quot;pass&quot;, OPT_PASS, 's', &quot;Output file pass phrase source&quot;},
+    {&quot;paramfile&quot;, OPT_PARAMFILE, '&lt;', &quot;Parameters file&quot;},
+    {&quot;algorithm&quot;, OPT_ALGORITHM, 's', &quot;The public key algorithm&quot;},
+    {&quot;pkeyopt&quot;, OPT_PKEYOPT, 's',
+     &quot;Set the public key algorithm option as opt:value&quot;},
+    {&quot;genparam&quot;, OPT_GENPARAM, '-', &quot;Generate parameters, not key&quot;},
+    {&quot;text&quot;, OPT_TEXT, '-', &quot;Print the in text&quot;},
+    {&quot;&quot;, OPT_CIPHER, '-', &quot;Cipher to use to encrypt the key&quot;},
+#ifndef OPENSSL_NO_ENGINE
+    {&quot;engine&quot;, OPT_ENGINE, 's', &quot;Use engine, possibly a hardware device&quot;},
+#endif
+    {OPT_HELP_STR, 1, 1,
+     &quot;Order of options may be important!  See the documentation.\n&quot;},
+    {NULL}
+};
 
-int MAIN(int argc, char **argv)
+int genpkey_main(int argc, char **argv)
 {
-    ENGINE *e = NULL;
-    char **args, *outfile = NULL;
-    char *passarg = NULL;
     BIO *in = NULL, *out = NULL;
-    const EVP_CIPHER *cipher = NULL;
-    int outformat;
-    int text = 0;
+    ENGINE *e = NULL;
     EVP_PKEY *pkey = NULL;
     EVP_PKEY_CTX *ctx = NULL;
-    char *pass = NULL;
-    int badarg = 0;
-    int ret = 1, rv;
-
-    int do_param = 0;
-
-    if (bio_err == NULL)
-        bio_err = BIO_new_fp(stderr, BIO_NOCLOSE);
-
-    if (!load_config(bio_err, NULL))
-        goto end;
-
-    outformat = FORMAT_PEM;
-
-    ERR_load_crypto_strings();
-    OpenSSL_add_all_algorithms();
-    args = argv + 1;
-    while (!badarg &amp;&amp; *args &amp;&amp; *args[0] == '-') {
-        if (!strcmp(*args, &quot;-outform&quot;)) {
-            if (args[1]) {
-                args++;
-                outformat = str2fmt(*args);
-            } else
-                badarg = 1;
-        } else if (!strcmp(*args, &quot;-pass&quot;)) {
-            if (!args[1])
-                goto bad;
-            passarg = *(++args);
-        }
+    char *outfile = NULL, *passarg = NULL, *pass = NULL, *prog;
+    const EVP_CIPHER *cipher = NULL;
+    OPTION_CHOICE o;
+    int outformat = FORMAT_PEM, text = 0, ret = 1, rv, do_param = 0;
+
+    prog = opt_init(argc, argv, genpkey_options);
+    while ((o = opt_next()) != OPT_EOF) {
+        switch (o) {
+        case OPT_EOF:
+        case OPT_ERR:
+ opthelp:
+            BIO_printf(bio_err, &quot;%s: Use -help for summary.\n&quot;, prog);
+            goto end;
+        case OPT_HELP:
+            ret = 0;
+            opt_help(genpkey_options);
+            goto end;
+        case OPT_OUTFORM:
+            if (!opt_format(opt_arg(), OPT_FMT_PEMDER, &amp;outformat))
+                goto opthelp;
+            break;
+        case OPT_OUT:
+            outfile = opt_arg();
+            break;
+
+        case OPT_PASS:
+            passarg = opt_arg();
+            break;
 #ifndef OPENSSL_NO_ENGINE
-        else if (strcmp(*args, &quot;-engine&quot;) == 0) {
-            if (!args[1])
-                goto bad;
-            e = setup_engine(bio_err, *(++args), 0);
-        }
+        case OPT_ENGINE:
+            e = setup_engine(opt_arg(), 0);
+            break;
 #endif
-        else if (!strcmp(*args, &quot;-paramfile&quot;)) {
-            if (!args[1])
-                goto bad;
-            args++;
+        case OPT_PARAMFILE:
             if (do_param == 1)
-                goto bad;
-            if (!init_keygen_file(bio_err, &amp;ctx, *args, e))
+                goto opthelp;
+            if (!init_keygen_file(&amp;ctx, opt_arg(), e))
                 goto end;
-        } else if (!strcmp(*args, &quot;-out&quot;)) {
-            if (args[1]) {
-                args++;
-                outfile = *args;
-            } else
-                badarg = 1;
-        } else if (strcmp(*args, &quot;-algorithm&quot;) == 0) {
-            if (!args[1])
-                goto bad;
-            if (!init_gen_str(bio_err, &amp;ctx, *(++args), e, do_param))
+            break;
+        case OPT_ALGORITHM:
+            if (!init_gen_str(&amp;ctx, opt_arg(), e, do_param))
                 goto end;
-        } else if (strcmp(*args, &quot;-pkeyopt&quot;) == 0) {
-            if (!args[1])
-                goto bad;
-            if (!ctx) {
-                BIO_puts(bio_err, &quot;No keytype specified\n&quot;);
-                goto bad;
-            } else if (pkey_ctrl_string(ctx, *(++args)) &lt;= 0) {
-                BIO_puts(bio_err, &quot;parameter setting error\n&quot;);
+            break;
+        case OPT_PKEYOPT:
+            if (ctx == NULL) {
+                BIO_printf(bio_err, &quot;%s: No keytype specified.\n&quot;, prog);
+                goto opthelp;
+            }
+            if (pkey_ctrl_string(ctx, opt_arg()) &lt;= 0) {
+                BIO_printf(bio_err,
+                           &quot;%s: Error setting %s parameter:\n&quot;,
+                           prog, opt_arg());
                 ERR_print_errors(bio_err);
                 goto end;
             }
-        } else if (strcmp(*args, &quot;-genparam&quot;) == 0) {
-            if (ctx)
-                goto bad;
+            break;
+        case OPT_GENPARAM:
+            if (ctx != NULL)
+                goto opthelp;
             do_param = 1;
-        } else if (strcmp(*args, &quot;-text&quot;) == 0)
+            break;
+        case OPT_TEXT:
             text = 1;
-        else {
-            cipher = EVP_get_cipherbyname(*args + 1);
-            if (!cipher) {
-                BIO_printf(bio_err, &quot;Unknown cipher %s\n&quot;, *args + 1);
-                badarg = 1;
-            }
-            if (do_param == 1)
-                badarg = 1;
+            break;
+        case OPT_CIPHER:
+            if (!opt_cipher(opt_unknown(), &amp;cipher)
+                || do_param == 1)
+                goto opthelp;
         }
-        args++;
     }
+    argc = opt_num_rest();
+    argv = opt_rest();
 
-    if (!ctx)
-        badarg = 1;
-
-    if (badarg) {
- bad:
-        BIO_printf(bio_err, &quot;Usage: genpkey [options]\n&quot;);
-        BIO_printf(bio_err, &quot;where options may be\n&quot;);
-        BIO_printf(bio_err, &quot;-out file          output file\n&quot;);
-        BIO_printf(bio_err,
-                   &quot;-outform X         output format (DER or PEM)\n&quot;);
-        BIO_printf(bio_err,
-                   &quot;-pass arg          output file pass phrase source\n&quot;);
-        BIO_printf(bio_err,
-                   &quot;-&lt;cipher&gt;          use cipher &lt;cipher&gt; to encrypt the key\n&quot;);
-#ifndef OPENSSL_NO_ENGINE
-        BIO_printf(bio_err,
-                   &quot;-engine e          use engine e, possibly a hardware device.\n&quot;);
-#endif
-        BIO_printf(bio_err, &quot;-paramfile file    parameters file\n&quot;);
-        BIO_printf(bio_err, &quot;-algorithm alg     the public key algorithm\n&quot;);
-        BIO_printf(bio_err,
-                   &quot;-pkeyopt opt:value set the public key algorithm option &lt;opt&gt;\n&quot;
-                   &quot;                   to value &lt;value&gt;\n&quot;);
-        BIO_printf(bio_err,
-                   &quot;-genparam          generate parameters, not key\n&quot;);
-        BIO_printf(bio_err, &quot;-text              print the in text\n&quot;);
-        BIO_printf(bio_err,
-                   &quot;NB: options order may be important!  See the manual page.\n&quot;);
-        goto end;
-    }
+    if (ctx == NULL)
+        goto opthelp;
 
-    if (!app_passwd(bio_err, passarg, NULL, &amp;pass, NULL)) {
+    if (!app_passwd(passarg, NULL, &amp;pass, NULL)) {
         BIO_puts(bio_err, &quot;Error getting password\n&quot;);
         goto end;
     }
 
-    if (outfile) {
-        if (!(out = BIO_new_file(outfile, &quot;wb&quot;))) {
-            BIO_printf(bio_err, &quot;Can't open output file %s\n&quot;, outfile);
-            goto end;
-        }
-    } else {
-        out = BIO_new_fp(stdout, BIO_NOCLOSE);
-#ifdef OPENSSL_SYS_VMS
-        {
-            BIO *tmpbio = BIO_new(BIO_f_linebuffer());
-            out = BIO_push(tmpbio, out);
-        }
-#endif
-    }
+    out = bio_open_default(outfile, &quot;wb&quot;);
+    if (out == NULL)
+        goto end;
 
     EVP_PKEY_CTX_set_cb(ctx, genpkey_cb);
     EVP_PKEY_CTX_set_app_data(ctx, bio_err);
@@ -278,20 +243,19 @@ int MAIN(int argc, char **argv)
     return ret;
 }
 
-static int init_keygen_file(BIO *err, EVP_PKEY_CTX **pctx,
-                            const char *file, ENGINE *e)
+static int init_keygen_file(EVP_PKEY_CTX **pctx, const char *file, ENGINE *e)
 {
     BIO *pbio;
     EVP_PKEY *pkey = NULL;
     EVP_PKEY_CTX *ctx = NULL;
     if (*pctx) {
-        BIO_puts(err, &quot;Parameters already set!\n&quot;);
+        BIO_puts(bio_err, &quot;Parameters already set!\n&quot;);
         return 0;
     }
 
     pbio = BIO_new_file(file, &quot;r&quot;);
     if (!pbio) {
-        BIO_printf(err, &quot;Can't open parameter file %s\n&quot;, file);
+        BIO_printf(bio_err, &quot;Can't open parameter file %s\n&quot;, file);
         return 0;
     }
 
@@ -313,15 +277,15 @@ static int init_keygen_file(BIO *err, EVP_PKEY_CTX **pctx,
     return 1;
 
  err:
-    BIO_puts(err, &quot;Error initializing context\n&quot;);
-    ERR_print_errors(err);
+    BIO_puts(bio_err, &quot;Error initializing context\n&quot;);
+    ERR_print_errors(bio_err);
     EVP_PKEY_CTX_free(ctx);
     EVP_PKEY_free(pkey);
     return 0;
 
 }
 
-int init_gen_str(BIO *err, EVP_PKEY_CTX **pctx,
+int init_gen_str(EVP_PKEY_CTX **pctx,
                  const char *algname, ENGINE *e, int do_param)
 {
     EVP_PKEY_CTX *ctx = NULL;
@@ -330,7 +294,7 @@ int init_gen_str(BIO *err, EVP_PKEY_CTX **pctx,
     int pkey_id;
 
     if (*pctx) {
-        BIO_puts(err, &quot;Algorithm already set!\n&quot;);
+        BIO_puts(bio_err, &quot;Algorithm already set!\n&quot;);
         return 0;
     }
 
@@ -369,8 +333,8 @@ int init_gen_str(BIO *err, EVP_PKEY_CTX **pctx,
     return 1;
 
  err:
-    BIO_printf(err, &quot;Error initializing %s context\n&quot;, algname);
-    ERR_print_errors(err);
+    BIO_printf(bio_err, &quot;Error initializing %s context\n&quot;, algname);
+    ERR_print_errors(bio_err);
     EVP_PKEY_CTX_free(ctx);
     return 0;
 
diff --git a/apps/genrsa.c b/apps/genrsa.c
index cf60219..b7275ae 100644
--- a/apps/genrsa.c
+++ b/apps/genrsa.c
@@ -1,4 +1,3 @@
-/* apps/genrsa.c */
 /* Copyright (C) 1995-1998 Eric Young (<A HREF="../../../mailman/listinfo/openssl-commits.html">eay at cryptsoft.com</A>)
  * All rights reserved.
  *
@@ -74,192 +73,108 @@
 # include &lt;openssl/rand.h&gt;
 
 # define DEFBITS 2048
-# undef PROG
-# define PROG genrsa_main
 
 static int genrsa_cb(int p, int n, BN_GENCB *cb);
 
-int MAIN(int, char **);
+typedef enum OPTION_choice {
+    OPT_ERR = -1, OPT_EOF = 0, OPT_HELP,
+    OPT_3, OPT_F4, OPT_NON_FIPS_ALLOW, OPT_ENGINE,
+    OPT_OUT, OPT_RAND, OPT_PASSOUT, OPT_CIPHER
+} OPTION_CHOICE;
 
-int MAIN(int argc, char **argv)
-{
-    BN_GENCB *cb = NULL;
+OPTIONS genrsa_options[] = {
+    {&quot;help&quot;, OPT_HELP, '-', &quot;Display this summary&quot;},
+    {&quot;3&quot;, OPT_3, '-', &quot;Use 3 for the E value&quot;},
+    {&quot;F4&quot;, OPT_F4, '-', &quot;Use F4 (0x10001) for the E value&quot;},
+    {&quot;f4&quot;, OPT_F4, '-', &quot;Use F4 (0x10001) for the E value&quot;},
+    {&quot;non-fips-allow&quot;, OPT_NON_FIPS_ALLOW, '-'},
+    {&quot;out&quot;, OPT_OUT, 's', &quot;Output the key to specified file&quot;},
+    {&quot;rand&quot;, OPT_RAND, 's',
+     &quot;Load the file(s) into the random number generator&quot;},
+    {&quot;passout&quot;, OPT_PASSOUT, 's', &quot;Output file pass phrase source&quot;},
+    {&quot;&quot;, OPT_CIPHER, '-', &quot;Encrypt the output with any supported cipher&quot;},
 # ifndef OPENSSL_NO_ENGINE
-    ENGINE *e = NULL;
+    {&quot;engine&quot;, OPT_ENGINE, 's', &quot;Use engine, possibly a hardware device&quot;},
 # endif
-    int ret = 1;
-    int non_fips_allow = 0;
-    int num = DEFBITS;
+    {NULL}
+};
+
+int genrsa_main(int argc, char **argv)
+{
+    BN_GENCB *cb = BN_GENCB_new();
+    ENGINE *e = NULL;
+    BIGNUM *bn = BN_new();
+    BIO *out = NULL;
+    RSA *rsa = NULL;
     const EVP_CIPHER *enc = NULL;
+    int ret = 1, non_fips_allow = 0, num = DEFBITS;
     unsigned long f4 = RSA_F4;
-    char *outfile = NULL;
-    char *passargout = NULL, *passout = NULL;
+    char *outfile = NULL, *passoutarg = NULL, *passout = NULL;
+    char *engine = NULL, *inrand = NULL, *prog;
     char *hexe, *dece;
-# ifndef OPENSSL_NO_ENGINE
-    char *engine = NULL;
-# endif
-    char *inrand = NULL;
-    BIO *out = NULL;
-    BIGNUM *bn = BN_new();
-    RSA *rsa = NULL;
-    if (!bn)
-        goto err;
-
-    cb = BN_GENCB_new();
-    if (!cb)
-        goto err;
+    OPTION_CHOICE o;
 
-    apps_startup();
+    if (!bn || !cb)
+        goto end;
 
     BN_GENCB_set(cb, genrsa_cb, bio_err);
 
-    if (bio_err == NULL)
-        if ((bio_err = BIO_new(BIO_s_file())) != NULL)
-            BIO_set_fp(bio_err, stderr, BIO_NOCLOSE | BIO_FP_TEXT);
-
-    if (!load_config(bio_err, NULL))
-        goto err;
-    if ((out = BIO_new(BIO_s_file())) == NULL) {
-        BIO_printf(bio_err, &quot;unable to create BIO for output\n&quot;);
-        goto err;
-    }
-
-    argv++;
-    argc--;
-    for (;;) {
-        if (argc &lt;= 0)
-            break;
-        if (strcmp(*argv, &quot;-out&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            outfile = *(++argv);
-        } else if (strcmp(*argv, &quot;-3&quot;) == 0)
+    prog = opt_init(argc, argv, genrsa_options);
+    while ((o = opt_next()) != OPT_EOF) {
+        switch (o) {
+        case OPT_EOF:
+        case OPT_ERR:
+            BIO_printf(bio_err, &quot;%s: Use -help for summary.\n&quot;, prog);
+            goto end;
+        case OPT_HELP:
+            ret = 0;
+            opt_help(genrsa_options);
+            goto end;
+        case OPT_3:
             f4 = 3;
-        else if (strcmp(*argv, &quot;-F4&quot;) == 0 || strcmp(*argv, &quot;-f4&quot;) == 0)
+            break;
+        case OPT_F4:
             f4 = RSA_F4;
-# ifndef OPENSSL_NO_ENGINE
-        else if (strcmp(*argv, &quot;-engine&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            engine = *(++argv);
-        }
-# endif
-        else if (strcmp(*argv, &quot;-rand&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            inrand = *(++argv);
-        }
-# ifndef OPENSSL_NO_DES
-        else if (strcmp(*argv, &quot;-des&quot;) == 0)
-            enc = EVP_des_cbc();
-        else if (strcmp(*argv, &quot;-des3&quot;) == 0)
-            enc = EVP_des_ede3_cbc();
-# endif
-# ifndef OPENSSL_NO_IDEA
-        else if (strcmp(*argv, &quot;-idea&quot;) == 0)
-            enc = EVP_idea_cbc();
-# endif
-# ifndef OPENSSL_NO_SEED
-        else if (strcmp(*argv, &quot;-seed&quot;) == 0)
-            enc = EVP_seed_cbc();
-# endif
-# ifndef OPENSSL_NO_AES
-        else if (strcmp(*argv, &quot;-aes128&quot;) == 0)
-            enc = EVP_aes_128_cbc();
-        else if (strcmp(*argv, &quot;-aes192&quot;) == 0)
-            enc = EVP_aes_192_cbc();
-        else if (strcmp(*argv, &quot;-aes256&quot;) == 0)
-            enc = EVP_aes_256_cbc();
-# endif
-# ifndef OPENSSL_NO_CAMELLIA
-        else if (strcmp(*argv, &quot;-camellia128&quot;) == 0)
-            enc = EVP_camellia_128_cbc();
-        else if (strcmp(*argv, &quot;-camellia192&quot;) == 0)
-            enc = EVP_camellia_192_cbc();
-        else if (strcmp(*argv, &quot;-camellia256&quot;) == 0)
-            enc = EVP_camellia_256_cbc();
-# endif
-        else if (strcmp(*argv, &quot;-passout&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            passargout = *(++argv);
-        } else if (strcmp(*argv, &quot;-non-fips-allow&quot;) == 0)
+            break;
+        case OPT_NON_FIPS_ALLOW:
             non_fips_allow = 1;
-        else
             break;
-        argv++;
-        argc--;
-    }
-    if ((argc &gt;= 1) &amp;&amp; ((sscanf(*argv, &quot;%d&quot;, &amp;num) == 0) || (num &lt; 0))) {
- bad:
-        BIO_printf(bio_err, &quot;usage: genrsa [args] [numbits]\n&quot;);
-        BIO_printf(bio_err,
-                   &quot; -des            encrypt the generated key with DES in cbc mode\n&quot;);
-        BIO_printf(bio_err,
-                   &quot; -des3           encrypt the generated key with DES in ede cbc mode (168 bit key)\n&quot;);
-# ifndef OPENSSL_NO_IDEA
-        BIO_printf(bio_err,
-                   &quot; -idea           encrypt the generated key with IDEA in cbc mode\n&quot;);
-# endif
-# ifndef OPENSSL_NO_SEED
-        BIO_printf(bio_err, &quot; -seed\n&quot;);
-        BIO_printf(bio_err,
-                   &quot;                 encrypt PEM output with cbc seed\n&quot;);
-# endif
-# ifndef OPENSSL_NO_AES
-        BIO_printf(bio_err, &quot; -aes128, -aes192, -aes256\n&quot;);
-        BIO_printf(bio_err,
-                   &quot;                 encrypt PEM output with cbc aes\n&quot;);
-# endif
-# ifndef OPENSSL_NO_CAMELLIA
-        BIO_printf(bio_err, &quot; -camellia128, -camellia192, -camellia256\n&quot;);
-        BIO_printf(bio_err,
-                   &quot;                 encrypt PEM output with cbc camellia\n&quot;);
-# endif
-        BIO_printf(bio_err, &quot; -out file       output the key to 'file\n&quot;);
-        BIO_printf(bio_err,
-                   &quot; -passout arg    output file pass phrase source\n&quot;);
-        BIO_printf(bio_err,
-                   &quot; -f4             use F4 (0x10001) for the E value\n&quot;);
-        BIO_printf(bio_err, &quot; -3              use 3 for the E value\n&quot;);
-# ifndef OPENSSL_NO_ENGINE
-        BIO_printf(bio_err,
-                   &quot; -engine e       use engine e, possibly a hardware device.\n&quot;);
-# endif
-        BIO_printf(bio_err, &quot; -rand file%cfile%c...\n&quot;, LIST_SEPARATOR_CHAR,
-                   LIST_SEPARATOR_CHAR);
-        BIO_printf(bio_err,
-                   &quot;                 load the file (or the files in the directory) into\n&quot;);
-        BIO_printf(bio_err, &quot;                 the random number generator\n&quot;);
-        goto err;
+        case OPT_OUT:
+            outfile = opt_arg();
+        case OPT_ENGINE:
+            engine = opt_arg();
+            break;
+        case OPT_RAND:
+            inrand = opt_arg();
+            break;
+        case OPT_PASSOUT:
+            passoutarg = opt_arg();
+            break;
+        case OPT_CIPHER:
+            if (!opt_cipher(opt_unknown(), &amp;enc))
+                goto end;
+            break;
+        }
     }
+    argc = opt_num_rest();
+    argv = opt_rest();
 
-    ERR_load_crypto_strings();
+    if (argv[0] &amp;&amp; (!opt_int(argv[0], &amp;num) || num &lt;= 0))
+        goto end;
 
-    if (!app_passwd(bio_err, NULL, passargout, NULL, &amp;passout)) {
+    if (!app_passwd(NULL, passoutarg, NULL, &amp;passout)) {
         BIO_printf(bio_err, &quot;Error getting password\n&quot;);
-        goto err;
+        goto end;
     }
 # ifndef OPENSSL_NO_ENGINE
-    e = setup_engine(bio_err, engine, 0);
+    e = setup_engine(engine, 0);
 # endif
 
-    if (outfile == NULL) {
-        BIO_set_fp(out, stdout, BIO_NOCLOSE);
-# ifdef OPENSSL_SYS_VMS
-        {
-            BIO *tmpbio = BIO_new(BIO_f_linebuffer());
-            out = BIO_push(tmpbio, out);
-        }
-# endif
-    } else {
-        if (BIO_write_filename(out, outfile) &lt;= 0) {
-            perror(outfile);
-            goto err;
-        }
-    }
+    out = bio_open_default(outfile, &quot;w&quot;);
+    if (out == NULL)
+        goto end;
 
-    if (!app_RAND_load_file(NULL, bio_err, 1) &amp;&amp; inrand == NULL
+    if (!app_RAND_load_file(NULL, 1) &amp;&amp; inrand == NULL
         &amp;&amp; !RAND_status()) {
         BIO_printf(bio_err,
                    &quot;warning, not much extra random data, consider using the -rand option\n&quot;);
@@ -276,15 +191,15 @@ int MAIN(int argc, char **argv)
     rsa = RSA_new_method(e);
 # endif
     if (!rsa)
-        goto err;
+        goto end;
 
     if (non_fips_allow)
         rsa-&gt;flags |= RSA_FLAG_NON_FIPS_ALLOW;
 
     if (!BN_set_word(bn, f4) || !RSA_generate_key_ex(rsa, num, bn, cb))
-        goto err;
+        goto end;
 
-    app_RAND_write_file(NULL, bio_err);
+    app_RAND_write_file(NULL);
 
     hexe = BN_bn2hex(rsa-&gt;e);
     dece = BN_bn2dec(rsa-&gt;e);
@@ -302,11 +217,11 @@ int MAIN(int argc, char **argv)
         if (!PEM_write_bio_RSAPrivateKey(out, rsa, enc, NULL, 0,
                                          (pem_password_cb *)password_callback,
                                          &amp;cb_data))
-            goto err;
+            goto end;
     }
 
     ret = 0;
- err:
+ end:
     if (bn)
         BN_free(bn);
     if (cb)
@@ -317,8 +232,7 @@ int MAIN(int argc, char **argv)
         OPENSSL_free(passout);
     if (ret != 0)
         ERR_print_errors(bio_err);
-    apps_shutdown();
-    OPENSSL_EXIT(ret);
+    return (ret);
 }
 
 static int genrsa_cb(int p, int n, BN_GENCB *cb)
diff --git a/apps/makeapps.com b/apps/makeapps.com
index efc213c..2724cc6 100644
--- a/apps/makeapps.com
+++ b/apps/makeapps.com
@@ -178,7 +178,7 @@ $! NOTE: Some might think this list ugly.  However, it's made this way to
 $! reflect the E_OBJ variable in Makefile as closely as possible, thereby
 $! making it fairly easy to verify that the lists are the same.
 $!
-$ LIB_OPENSSL = &quot;VERIFY,ASN1PARS,REQ,DGST,DH,DHPARAM,ENC,PASSWD,GENDH,ERRSTR,&quot;+-
+$ LIB_OPENSSL = &quot;VERIFY,ASN1PARS,REQ,DGST,DHPARAM,ENC,PASSWD,ERRSTR,&quot;+-
 	     	&quot;CA,PKCS7,CRL2P7,CRL,&quot;+-
 	      	&quot;RSA,RSAUTL,DSA,DSAPARAM,EC,ECPARAM,&quot;+-
 	      	&quot;X509,GENRSA,GENDSA,GENPKEY,S_SERVER,S_CLIENT,SPEED,&quot;+-
diff --git a/apps/nseq.c b/apps/nseq.c
index c306738..3fa496c 100644
--- a/apps/nseq.c
+++ b/apps/nseq.c
@@ -1,4 +1,3 @@
-/* nseq.c */
 /*
  * Written by Dr Stephen N Henson (<A HREF="../../../mailman/listinfo/openssl-commits.html">steve at openssl.org</A>) for the OpenSSL project
  * 1999.
@@ -63,84 +62,71 @@
 #include &lt;openssl/pem.h&gt;
 #include &lt;openssl/err.h&gt;
 
-#undef PROG
-#define PROG nseq_main
+typedef enum OPTION_choice {
+    OPT_ERR = -1, OPT_EOF = 0, OPT_HELP,
+    OPT_TOSEQ, OPT_IN, OPT_OUT
+} OPTION_CHOICE;
 
-int MAIN(int, char **);
+OPTIONS nseq_options[] = {
+    {&quot;help&quot;, OPT_HELP, '-', &quot;Display this summary&quot;},
+    {&quot;toseq&quot;, OPT_TOSEQ, '-', &quot;Output NS Sequence file&quot;},
+    {&quot;in&quot;, OPT_IN, '&lt;', &quot;Input file&quot;},
+    {&quot;out&quot;, OPT_OUT, '&gt;', &quot;Output file&quot;},
+    {NULL}
+};
 
-int MAIN(int argc, char **argv)
+int nseq_main(int argc, char **argv)
 {
-    char **args, *infile = NULL, *outfile = NULL;
     BIO *in = NULL, *out = NULL;
-    int toseq = 0;
     X509 *x509 = NULL;
     NETSCAPE_CERT_SEQUENCE *seq = NULL;
-    int i, ret = 1;
-    int badarg = 0;
-    if (bio_err == NULL)
-        bio_err = BIO_new_fp(stderr, BIO_NOCLOSE);
-    ERR_load_crypto_strings();
-    args = argv + 1;
-    while (!badarg &amp;&amp; *args &amp;&amp; *args[0] == '-') {
-        if (!strcmp(*args, &quot;-toseq&quot;))
-            toseq = 1;
-        else if (!strcmp(*args, &quot;-in&quot;)) {
-            if (args[1]) {
-                args++;
-                infile = *args;
-            } else
-                badarg = 1;
-        } else if (!strcmp(*args, &quot;-out&quot;)) {
-            if (args[1]) {
-                args++;
-                outfile = *args;
-            } else
-                badarg = 1;
-        } else
-            badarg = 1;
-        args++;
-    }
-
-    if (badarg) {
-        BIO_printf(bio_err, &quot;Netscape certificate sequence utility\n&quot;);
-        BIO_printf(bio_err, &quot;Usage nseq [options]\n&quot;);
-        BIO_printf(bio_err, &quot;where options are\n&quot;);
-        BIO_printf(bio_err, &quot;-in file  input file\n&quot;);
-        BIO_printf(bio_err, &quot;-out file output file\n&quot;);
-        BIO_printf(bio_err, &quot;-toseq    output NS Sequence file\n&quot;);
-        OPENSSL_EXIT(1);
-    }
+    OPTION_CHOICE o;
+    int toseq = 0, ret = 1, i;
+    char *infile = NULL, *outfile = NULL, *prog;
 
-    if (infile) {
-        if (!(in = BIO_new_file(infile, &quot;r&quot;))) {
-            BIO_printf(bio_err, &quot;Can't open input file %s\n&quot;, infile);
+    prog = opt_init(argc, argv, nseq_options);
+    while ((o = opt_next()) != OPT_EOF) {
+        switch (o) {
+        case OPT_EOF:
+        case OPT_ERR:
+            BIO_printf(bio_err, &quot;%s: Use -help for summary.\n&quot;, prog);
             goto end;
-        }
-    } else
-        in = BIO_new_fp(stdin, BIO_NOCLOSE);
-
-    if (outfile) {
-        if (!(out = BIO_new_file(outfile, &quot;w&quot;))) {
-            BIO_printf(bio_err, &quot;Can't open output file %s\n&quot;, outfile);
+        case OPT_HELP:
+            ret = 0;
+            opt_help(nseq_options);
             goto end;
+        case OPT_TOSEQ:
+            toseq = 1;
+            break;
+        case OPT_IN:
+            infile = opt_arg();
+            break;
+        case OPT_OUT:
+            outfile = opt_arg();
+            break;
         }
-    } else {
-        out = BIO_new_fp(stdout, BIO_NOCLOSE);
-#ifdef OPENSSL_SYS_VMS
-        {
-            BIO *tmpbio = BIO_new(BIO_f_linebuffer());
-            out = BIO_push(tmpbio, out);
-        }
-#endif
     }
+    argc = opt_num_rest();
+    argv = opt_rest();
+
+    in = bio_open_default(infile, &quot;r&quot;);
+    if (in == NULL)
+        goto end;
+    out = bio_open_default(outfile, &quot;w&quot;);
+    if (out == NULL)
+        goto end;
+
     if (toseq) {
         seq = NETSCAPE_CERT_SEQUENCE_new();
         seq-&gt;certs = sk_X509_new_null();
+        if (!seq-&gt;certs)
+            goto end;
         while ((x509 = PEM_read_bio_X509(in, NULL, NULL, NULL)))
             sk_X509_push(seq-&gt;certs, x509);
 
         if (!sk_X509_num(seq-&gt;certs)) {
-            BIO_printf(bio_err, &quot;Error reading certs file %s\n&quot;, infile);
+            BIO_printf(bio_err, &quot;%s: Error reading certs file %s\n&quot;,
+                       prog, infile);
             ERR_print_errors(bio_err);
             goto end;
         }
@@ -149,8 +135,10 @@ int MAIN(int argc, char **argv)
         goto end;
     }
 
-    if (!(seq = PEM_read_bio_NETSCAPE_CERT_SEQUENCE(in, NULL, NULL, NULL))) {
-        BIO_printf(bio_err, &quot;Error reading sequence file %s\n&quot;, infile);
+    seq = PEM_read_bio_NETSCAPE_CERT_SEQUENCE(in, NULL, NULL, NULL);
+    if (seq == NULL) {
+        BIO_printf(bio_err, &quot;%s: Error reading sequence file %s\n&quot;,
+                   prog, infile);
         ERR_print_errors(bio_err);
         goto end;
     }
@@ -166,5 +154,5 @@ int MAIN(int argc, char **argv)
     BIO_free_all(out);
     NETSCAPE_CERT_SEQUENCE_free(seq);
 
-    OPENSSL_EXIT(ret);
+    return (ret);
 }
diff --git a/apps/ocsp.c b/apps/ocsp.c
index 96f4c67..840e506 100644
--- a/apps/ocsp.c
+++ b/apps/ocsp.c
@@ -1,4 +1,3 @@
-/* ocsp.c */
 /*
  * Written by Dr Stephen N Henson (<A HREF="../../../mailman/listinfo/openssl-commits.html">steve at openssl.org</A>) for the OpenSSL project
  * 2000.
@@ -95,7 +94,7 @@
 # endif
 
 /* Maximum leeway in validity period: default 5 minutes */
-# define MAX_VALIDITY_PERIOD     (5 * 60)
+# define MAX_VALIDITY_PERIOD    (5 * 60)
 
 static int add_ocsp_cert(OCSP_REQUEST **req, X509 *cert,
                          const EVP_MD *cert_id_md, X509 *issuer,
@@ -103,12 +102,11 @@ static int add_ocsp_cert(OCSP_REQUEST **req, X509 *cert,
 static int add_ocsp_serial(OCSP_REQUEST **req, char *serial,
                            const EVP_MD *cert_id_md, X509 *issuer,
                            STACK_OF(OCSP_CERTID) *ids);
-static int print_ocsp_summary(BIO *out, OCSP_BASICRESP *bs, OCSP_REQUEST *req,
+static void print_ocsp_summary(BIO *out, OCSP_BASICRESP *bs, OCSP_REQUEST *req,
                               STACK_OF(OPENSSL_STRING) *names,
                               STACK_OF(OCSP_CERTID) *ids, long nsec,
                               long maxage);
-
-static int make_ocsp_response(OCSP_RESPONSE **resp, OCSP_REQUEST *req,
+static void make_ocsp_response(OCSP_RESPONSE **resp, OCSP_REQUEST *req,
                               CA_DB *db, X509 *ca, X509 *rcert,
                               EVP_PKEY *rkey, const EVP_MD *md,
                               STACK_OF(X509) *rother, unsigned long flags,
@@ -119,498 +117,372 @@ static BIO *init_responder(const char *port);
 static int do_responder(OCSP_REQUEST **preq, BIO **pcbio, BIO *acbio,
                         const char *port);
 static int send_ocsp_response(BIO *cbio, OCSP_RESPONSE *resp);
-static OCSP_RESPONSE *query_responder(BIO *err, BIO *cbio, const char *path,
+static OCSP_RESPONSE *query_responder(BIO *cbio, const char *path,
                                       const STACK_OF(CONF_VALUE) *headers,
                                       OCSP_REQUEST *req, int req_timeout);
 
-# undef PROG
-# define PROG ocsp_main
-
-int MAIN(int, char **);
-
-int MAIN(int argc, char **argv)
+typedef enum OPTION_choice {
+    OPT_ERR = -1, OPT_EOF = 0, OPT_HELP,
+    OPT_OUTFILE, OPT_TIMEOUT, OPT_URL, OPT_HOST, OPT_PORT,
+    OPT_IGNORE_ERR, OPT_NOVERIFY, OPT_NONCE, OPT_NO_NONCE,
+    OPT_RESP_NO_CERTS, OPT_RESP_KEY_ID, OPT_NO_CERTS,
+    OPT_NO_SIGNATURE_VERIFY, OPT_NO_CERT_VERIFY, OPT_NO_CHAIN,
+    OPT_NO_CERT_CHECKS, OPT_NO_EXPLICIT, OPT_TRUST_OTHER,
+    OPT_NO_INTERN, OPT_BADSIG, OPT_TEXT, OPT_REQ_TEXT, OPT_RESP_TEXT,
+    OPT_REQIN, OPT_RESPIN, OPT_SIGNER, OPT_VAFILE, OPT_SIGN_OTHER,
+    OPT_VERIFY_OTHER, OPT_CAFILE, OPT_CAPATH,
+    OPT_VALIDITY_PERIOD, OPT_STATUS_AGE, OPT_SIGNKEY, OPT_REQOUT,
+    OPT_RESPOUT, OPT_PATH, OPT_CERT, OPT_SERIAL,
+    OPT_INDEX, OPT_CA, OPT_NMIN, OPT_REQUEST, OPT_NDAYS, OPT_RSIGNER,
+    OPT_RKEY, OPT_ROTHER, OPT_RMD, OPT_HEADER,
+    OPT_V_ENUM,
+    OPT_MD
+} OPTION_CHOICE;
+
+OPTIONS ocsp_options[] = {
+    {&quot;help&quot;, OPT_HELP, '-', &quot;Display this summary&quot;},
+    {&quot;out&quot;, OPT_OUTFILE, '&gt;', &quot;Output filename&quot;},
+    {&quot;timeout&quot;, OPT_TIMEOUT, 'p'},
+    {&quot;url&quot;, OPT_URL, 's', &quot;Responder URL&quot;},
+    {&quot;host&quot;, OPT_HOST, 's', &quot;host:prot top to connect to&quot;},
+    {&quot;port&quot;, OPT_PORT, 'p', &quot;Port to run responder on&quot;},
+    {&quot;ignore_err&quot;, OPT_IGNORE_ERR, '-'},
+    {&quot;noverify&quot;, OPT_NOVERIFY, '-', &quot;Don't verify response at all&quot;},
+    {&quot;nonce&quot;, OPT_NONCE, '-', &quot;Add OCSP nonce to request&quot;},
+    {&quot;no_nonce&quot;, OPT_NO_NONCE, '-', &quot;Don't add OCSP nonce to request&quot;},
+    {&quot;resp_no_certs&quot;, OPT_RESP_NO_CERTS, '-',
+     &quot;Don't include any certificates in response&quot;},
+    {&quot;resp_key_id&quot;, OPT_RESP_KEY_ID, '-',
+     &quot;Identify reponse by signing certificate key ID&quot;},
+    {&quot;no_certs&quot;, OPT_NO_CERTS, '-',
+     &quot;Don't include any certificates in signed request&quot;},
+    {&quot;no_signature_verify&quot;, OPT_NO_SIGNATURE_VERIFY, '-',
+     &quot;Don't check signature on response&quot;},
+    {&quot;no_cert_verify&quot;, OPT_NO_CERT_VERIFY, '-',
+     &quot;Don't check signing certificate&quot;},
+    {&quot;no_chain&quot;, OPT_NO_CHAIN, '-', &quot;Don't chain verify response&quot;},
+    {&quot;no_cert_checks&quot;, OPT_NO_CERT_CHECKS, '-',
+     &quot;Don't do additional checks on signing certificate&quot;},
+    {&quot;no_explicit&quot;, OPT_NO_EXPLICIT, '-'},
+    {&quot;trust_other&quot;, OPT_TRUST_OTHER, '-',
+     &quot;Don't verify additional certificates&quot;},
+    {&quot;no_intern&quot;, OPT_NO_INTERN, '-',
+     &quot;Don't search certificates contained in response for signer&quot;},
+    {&quot;badsig&quot;, OPT_BADSIG, '-'},
+    {&quot;text&quot;, OPT_TEXT, '-', &quot;Print text form of request and response&quot;},
+    {&quot;req_text&quot;, OPT_REQ_TEXT, '-', &quot;Print text form of request&quot;},
+    {&quot;resp_text&quot;, OPT_RESP_TEXT, '-', &quot;Print text form of response&quot;},
+    {&quot;reqin&quot;, OPT_REQIN, 's', &quot;File with the DER-encoded request&quot;},
+    {&quot;respin&quot;, OPT_RESPIN, 's', &quot;File with the DER-encoded response&quot;},
+    {&quot;signer&quot;, OPT_SIGNER, '&lt;', &quot;Certificate to sign OCSP request with&quot;},
+    {&quot;VAfile&quot;, OPT_VAFILE, '&lt;', &quot;Validator certificates file&quot;},
+    {&quot;sign_other&quot;, OPT_SIGN_OTHER, '&lt;',
+     &quot;Additional certificates to include in signed request&quot;},
+    {&quot;verify_other&quot;, OPT_VERIFY_OTHER, '&lt;',
+     &quot;Additional certificates to search for signer&quot;},
+    {&quot;CAfile&quot;, OPT_CAFILE, '&lt;', &quot;Trusted certificates file&quot;},
+    {&quot;CApath&quot;, OPT_CAPATH, '&lt;', &quot;Trusted certificates directory&quot;},
+    {&quot;validity_period&quot;, OPT_VALIDITY_PERIOD, 'u',
+     &quot;Maximum validity discrepancy in seconds&quot;},
+    {&quot;status_age&quot;, OPT_STATUS_AGE, 'p', &quot;Maximum status age in seconds&quot;},
+    {&quot;signkey&quot;, OPT_SIGNKEY, 's', &quot;Private key to sign OCSP request with&quot;},
+    {&quot;reqout&quot;, OPT_REQOUT, 's', &quot;Output file for the DER-encoded request&quot;},
+    {&quot;respout&quot;, OPT_RESPOUT, 's', &quot;Output file for the DER-encoded response&quot;},
+    {&quot;path&quot;, OPT_PATH, 's', &quot;Path to use in OCSP request&quot;},
+    {&quot;cert&quot;, OPT_CERT, '&lt;', &quot;Certificate to check&quot;},
+    {&quot;serial&quot;, OPT_SERIAL, 's', &quot;Nerial number to check&quot;},
+    {&quot;index&quot;, OPT_INDEX, '&lt;', &quot;Certificate status index file&quot;},
+    {&quot;CA&quot;, OPT_CA, '&lt;', &quot;CA certificate&quot;},
+    {&quot;nmin&quot;, OPT_NMIN, 'p', &quot;Number of minutes before next update&quot;},
+    {&quot;nrequest&quot;, OPT_REQUEST, 'p',
+     &quot;Number of requests to accept (default unlimited)&quot;},
+    {&quot;ndays&quot;, OPT_NDAYS, 'p', &quot;Number of days before next update&quot;},
+    {&quot;rsigner&quot;, OPT_RSIGNER, '&lt;',
+     &quot;Sesponder certificate to sign responses with&quot;},
+    {&quot;rkey&quot;, OPT_RKEY, '&lt;', &quot;Responder key to sign responses with&quot;},
+    {&quot;rother&quot;, OPT_ROTHER, '&lt;', &quot;Other certificates to include in response&quot;},
+    {&quot;rmd&quot;, OPT_RMD, 's'},
+    {&quot;header&quot;, OPT_HEADER, 's', &quot;key=value header to add&quot;},
+    {&quot;&quot;, OPT_MD, '-', &quot;Any supported digest&quot;},
+    OPT_V_OPTIONS,
+    {NULL}
+};
+
+int ocsp_main(int argc, char **argv)
 {
-    ENGINE *e = NULL;
-    char **args;
-    char *host = NULL, *port = NULL, *path = &quot;/&quot;;
-    char *thost = NULL, *tport = NULL, *tpath = NULL;
-    char *reqin = NULL, *respin = NULL;
-    char *reqout = NULL, *respout = NULL;
-    char *signfile = NULL, *keyfile = NULL;
-    char *rsignfile = NULL, *rkeyfile = NULL;
-    char *outfile = NULL;
-    int add_nonce = 1, noverify = 0, use_ssl = -1;
-    STACK_OF(CONF_VALUE) *headers = NULL;
+    BIO *acbio = NULL, *cbio = NULL, *derbio = NULL, *out = NULL;
+    const EVP_MD *cert_id_md = NULL, *rsign_md = NULL;
+    CA_DB *rdb = NULL;
+    EVP_PKEY *key = NULL, *rkey = NULL;
+    OCSP_BASICRESP *bs = NULL;
     OCSP_REQUEST *req = NULL;
     OCSP_RESPONSE *resp = NULL;
-    OCSP_BASICRESP *bs = NULL;
-    X509 *issuer = NULL, *cert = NULL;
+    STACK_OF(CONF_VALUE) *headers = NULL;
+    STACK_OF(OCSP_CERTID) *ids = NULL;
+    STACK_OF(OPENSSL_STRING) *reqnames = NULL;
+    STACK_OF(X509) *sign_other = NULL, *verify_other = NULL, *rother = NULL;
+    X509 *issuer = NULL, *cert = NULL, *rca_cert = NULL;
     X509 *signer = NULL, *rsigner = NULL;
-    EVP_PKEY *key = NULL, *rkey = NULL;
-    BIO *acbio = NULL, *cbio = NULL;
-    BIO *derbio = NULL;
-    BIO *out = NULL;
-    int req_timeout = -1;
-    int req_text = 0, resp_text = 0;
-    long nsec = MAX_VALIDITY_PERIOD, maxage = -1;
-    char *CAfile = NULL, *CApath = NULL;
     X509_STORE *store = NULL;
     X509_VERIFY_PARAM *vpm = NULL;
-    STACK_OF(X509) *sign_other = NULL, *verify_other = NULL, *rother = NULL;
+    char *CAfile = NULL, *CApath = NULL, *header, *value;
+    char *host = NULL, *port = NULL, *path = &quot;/&quot;, *outfile = NULL;
+    char *rca_filename = NULL, *reqin = NULL, *respin = NULL;
+    char *reqout = NULL, *respout = NULL, *ridx_filename = NULL;
+    char *rsignfile = NULL, *rkeyfile = NULL;
     char *sign_certfile = NULL, *verify_certfile = NULL, *rcertfile = NULL;
+    char *signfile = NULL, *keyfile = NULL;
+    char *thost = NULL, *tport = NULL, *tpath = NULL;
+    int accept_count = -1, add_nonce = 1, noverify = 0, use_ssl = -1;
+    int vpmtouched = 0, badsig = 0, i, ignore_err = 0, nmin = 0, ndays = -1;
+    int req_text = 0, resp_text = 0, req_timeout = -1, ret = 1;
+    long nsec = MAX_VALIDITY_PERIOD, maxage = -1;
     unsigned long sign_flags = 0, verify_flags = 0, rflags = 0;
-    int ret = 1;
-    int accept_count = -1;
-    int badarg = 0;
-    int badsig = 0;
-    int i;
-    int ignore_err = 0;
-    STACK_OF(OPENSSL_STRING) *reqnames = NULL;
-    STACK_OF(OCSP_CERTID) *ids = NULL;
-
-    X509 *rca_cert = NULL;
-    char *ridx_filename = NULL;
-    char *rca_filename = NULL;
-    CA_DB *rdb = NULL;
-    int nmin = 0, ndays = -1;
-    const EVP_MD *cert_id_md = NULL, *rsign_md = NULL;
+    OPTION_CHOICE o;
+    char *prog;
 
-    if (bio_err == NULL)
-        bio_err = BIO_new_fp(stderr, BIO_NOCLOSE);
-
-    if (!load_config(bio_err, NULL))
-        goto end;
-    SSL_load_error_strings();
-    OpenSSL_add_ssl_algorithms();
-    args = argv + 1;
     reqnames = sk_OPENSSL_STRING_new_null();
+    if (!reqnames)
+        goto end;
     ids = sk_OCSP_CERTID_new_null();
-    while (!badarg &amp;&amp; *args &amp;&amp; *args[0] == '-') {
-        if (!strcmp(*args, &quot;-out&quot;)) {
-            if (args[1]) {
-                args++;
-                outfile = *args;
-            } else
-                badarg = 1;
-        } else if (!strcmp(*args, &quot;-timeout&quot;)) {
-            if (args[1]) {
-                args++;
-                req_timeout = atol(*args);
-                if (req_timeout &lt; 0) {
-                    BIO_printf(bio_err, &quot;Illegal timeout value %s\n&quot;, *args);
-                    badarg = 1;
-                }
-            } else
-                badarg = 1;
-        } else if (!strcmp(*args, &quot;-url&quot;)) {
+    if (!ids)
+        goto end;
+    if ((vpm = X509_VERIFY_PARAM_new()) == NULL)
+        return 1;
+
+    prog = opt_init(argc, argv, ocsp_options);
+    while ((o = opt_next()) != OPT_EOF) {
+        switch (o) {
+        case OPT_EOF:
+        case OPT_ERR:
+ opthelp:
+            BIO_printf(bio_err, &quot;%s: Use -help for summary.\n&quot;, prog);
+            goto end;
+        case OPT_HELP:
+            ret = 0;
+            opt_help(ocsp_options);
+            goto end;
+        case OPT_OUTFILE:
+            outfile = opt_arg();
+            break;
+        case OPT_TIMEOUT:
+            req_timeout = atoi(opt_arg());
+            break;
+        case OPT_URL:
             if (thost)
                 OPENSSL_free(thost);
             if (tport)
                 OPENSSL_free(tport);
             if (tpath)
                 OPENSSL_free(tpath);
-            if (args[1]) {
-                args++;
-                if (!OCSP_parse_url(*args, &amp;host, &amp;port, &amp;path, &amp;use_ssl)) {
-                    BIO_printf(bio_err, &quot;Error parsing URL\n&quot;);
-                    badarg = 1;
-                }
-                thost = host;
-                tport = port;
-                tpath = path;
-            } else
-                badarg = 1;
-        } else if (!strcmp(*args, &quot;-host&quot;)) {
-            if (args[1]) {
-                args++;
-                host = *args;
-            } else
-                badarg = 1;
-        } else if (!strcmp(*args, &quot;-port&quot;)) {
-            if (args[1]) {
-                args++;
-                port = *args;
-            } else
-                badarg = 1;
-        } else if (!strcmp(*args, &quot;-header&quot;)) {
-            if (args[1] &amp;&amp; args[2]) {
-                if (!X509V3_add_value(args[1], args[2], &amp;headers))
-                    goto end;
-                args += 2;
-            } else
-                badarg = 1;
-        } else if (!strcmp(*args, &quot;-ignore_err&quot;))
+            if (!OCSP_parse_url(opt_arg(), &amp;host, &amp;port, &amp;path, &amp;use_ssl)) {
+                BIO_printf(bio_err, &quot;%s Error parsing URL\n&quot;, prog);
+                goto end;
+            }
+            thost = host;
+            tport = port;
+            tpath = path;
+            break;
+        case OPT_HOST:
+            host = opt_arg();
+            break;
+        case OPT_PORT:
+            port = opt_arg();
+            break;
+        case OPT_IGNORE_ERR:
             ignore_err = 1;
-        else if (!strcmp(*args, &quot;-noverify&quot;))
+            break;
+        case OPT_NOVERIFY:
             noverify = 1;
-        else if (!strcmp(*args, &quot;-nonce&quot;))
+            break;
+        case OPT_NONCE:
             add_nonce = 2;
-        else if (!strcmp(*args, &quot;-no_nonce&quot;))
+            break;
+        case OPT_NO_NONCE:
             add_nonce = 0;
-        else if (!strcmp(*args, &quot;-resp_no_certs&quot;))
+            break;
+        case OPT_RESP_NO_CERTS:
             rflags |= OCSP_NOCERTS;
-        else if (!strcmp(*args, &quot;-resp_key_id&quot;))
+            break;
+        case OPT_RESP_KEY_ID:
             rflags |= OCSP_RESPID_KEY;
-        else if (!strcmp(*args, &quot;-no_certs&quot;))
+            break;
+        case OPT_NO_CERTS:
             sign_flags |= OCSP_NOCERTS;
-        else if (!strcmp(*args, &quot;-no_signature_verify&quot;))
+            break;
+        case OPT_NO_SIGNATURE_VERIFY:
             verify_flags |= OCSP_NOSIGS;
-        else if (!strcmp(*args, &quot;-no_cert_verify&quot;))
+            break;
+        case OPT_NO_CERT_VERIFY:
             verify_flags |= OCSP_NOVERIFY;
-        else if (!strcmp(*args, &quot;-no_chain&quot;))
+            break;
+        case OPT_NO_CHAIN:
             verify_flags |= OCSP_NOCHAIN;
-        else if (!strcmp(*args, &quot;-no_cert_checks&quot;))
+            break;
+        case OPT_NO_CERT_CHECKS:
             verify_flags |= OCSP_NOCHECKS;
-        else if (!strcmp(*args, &quot;-no_explicit&quot;))
+            break;
+        case OPT_NO_EXPLICIT:
             verify_flags |= OCSP_NOEXPLICIT;
-        else if (!strcmp(*args, &quot;-trust_other&quot;))
+            break;
+        case OPT_TRUST_OTHER:
             verify_flags |= OCSP_TRUSTOTHER;
-        else if (!strcmp(*args, &quot;-no_intern&quot;))
+            break;
+        case OPT_NO_INTERN:
             verify_flags |= OCSP_NOINTERN;
-        else if (!strcmp(*args, &quot;-badsig&quot;))
+            break;
+        case OPT_BADSIG:
             badsig = 1;
-        else if (!strcmp(*args, &quot;-text&quot;)) {
-            req_text = 1;
-            resp_text = 1;
-        } else if (!strcmp(*args, &quot;-req_text&quot;))
+            break;
+        case OPT_TEXT:
+            req_text = resp_text = 1;
+            break;
+        case OPT_REQ_TEXT:
             req_text = 1;
-        else if (!strcmp(*args, &quot;-resp_text&quot;))
+            break;
+        case OPT_RESP_TEXT:
             resp_text = 1;
-        else if (!strcmp(*args, &quot;-reqin&quot;)) {
-            if (args[1]) {
-                args++;
-                reqin = *args;
-            } else
-                badarg = 1;
-        } else if (!strcmp(*args, &quot;-respin&quot;)) {
-            if (args[1]) {
-                args++;
-                respin = *args;
-            } else
-                badarg = 1;
-        } else if (!strcmp(*args, &quot;-signer&quot;)) {
-            if (args[1]) {
-                args++;
-                signfile = *args;
-            } else
-                badarg = 1;
-        } else if (!strcmp(*args, &quot;-VAfile&quot;)) {
-            if (args[1]) {
-                args++;
-                verify_certfile = *args;
-                verify_flags |= OCSP_TRUSTOTHER;
-            } else
-                badarg = 1;
-        } else if (!strcmp(*args, &quot;-sign_other&quot;)) {
-            if (args[1]) {
-                args++;
-                sign_certfile = *args;
-            } else
-                badarg = 1;
-        } else if (!strcmp(*args, &quot;-verify_other&quot;)) {
-            if (args[1]) {
-                args++;
-                verify_certfile = *args;
-            } else
-                badarg = 1;
-        } else if (!strcmp(*args, &quot;-CAfile&quot;)) {
-            if (args[1]) {
-                args++;
-                CAfile = *args;
-            } else
-                badarg = 1;
-        } else if (!strcmp(*args, &quot;-CApath&quot;)) {
-            if (args[1]) {
-                args++;
-                CApath = *args;
-            } else
-                badarg = 1;
-        } else if (args_verify(&amp;args, NULL, &amp;badarg, bio_err, &amp;vpm)) {
-            if (badarg)
+            break;
+        case OPT_REQIN:
+            reqin = opt_arg();
+            break;
+        case OPT_RESPIN:
+            respin = opt_arg();
+            break;
+        case OPT_SIGNER:
+            signfile = opt_arg();
+            break;
+        case OPT_VAFILE:
+            verify_certfile = opt_arg();
+            verify_flags |= OCSP_TRUSTOTHER;
+            break;
+        case OPT_SIGN_OTHER:
+            sign_certfile = opt_arg();
+            break;
+        case OPT_VERIFY_OTHER:
+            verify_certfile = opt_arg();
+            break;
+        case OPT_CAFILE:
+            CAfile = opt_arg();
+            break;
+        case OPT_CAPATH:
+            CApath = opt_arg();
+            break;
+        case OPT_V_CASES:
+            if (!opt_verify(o, vpm))
                 goto end;
-            continue;
-        } else if (!strcmp(*args, &quot;-validity_period&quot;)) {
-            if (args[1]) {
-                args++;
-                nsec = atol(*args);
-                if (nsec &lt; 0) {
-                    BIO_printf(bio_err,
-                               &quot;Illegal validity period %s\n&quot;, *args);
-                    badarg = 1;
-                }
-            } else
-                badarg = 1;
-        } else if (!strcmp(*args, &quot;-status_age&quot;)) {
-            if (args[1]) {
-                args++;
-                maxage = atol(*args);
-                if (maxage &lt; 0) {
-                    BIO_printf(bio_err, &quot;Illegal validity age %s\n&quot;, *args);
-                    badarg = 1;
-                }
-            } else
-                badarg = 1;
-        } else if (!strcmp(*args, &quot;-signkey&quot;)) {
-            if (args[1]) {
-                args++;
-                keyfile = *args;
-            } else
-                badarg = 1;
-        } else if (!strcmp(*args, &quot;-reqout&quot;)) {
-            if (args[1]) {
-                args++;
-                reqout = *args;
-            } else
-                badarg = 1;
-        } else if (!strcmp(*args, &quot;-respout&quot;)) {
-            if (args[1]) {
-                args++;
-                respout = *args;
-            } else
-                badarg = 1;
-        } else if (!strcmp(*args, &quot;-path&quot;)) {
-            if (args[1]) {
-                args++;
-                path = *args;
-            } else
-                badarg = 1;
-        } else if (!strcmp(*args, &quot;-issuer&quot;)) {
-            if (args[1]) {
-                args++;
-                X509_free(issuer);
-                issuer = load_cert(bio_err, *args, FORMAT_PEM,
-                                   NULL, e, &quot;issuer certificate&quot;);
-                if (!issuer)
-                    goto end;
-            } else
-                badarg = 1;
-        } else if (!strcmp(*args, &quot;-cert&quot;)) {
-            if (args[1]) {
-                args++;
-                X509_free(cert);
-                cert = load_cert(bio_err, *args, FORMAT_PEM,
-                                 NULL, e, &quot;certificate&quot;);
-                if (!cert)
-                    goto end;
-                if (!cert_id_md)
-                    cert_id_md = EVP_sha1();
-                if (!add_ocsp_cert(&amp;req, cert, cert_id_md, issuer, ids))
-                    goto end;
-                if (!sk_OPENSSL_STRING_push(reqnames, *args))
-                    goto end;
-            } else
-                badarg = 1;
-        } else if (!strcmp(*args, &quot;-serial&quot;)) {
-            if (args[1]) {
-                args++;
-                if (!cert_id_md)
-                    cert_id_md = EVP_sha1();
-                if (!add_ocsp_serial(&amp;req, *args, cert_id_md, issuer, ids))
-                    goto end;
-                if (!sk_OPENSSL_STRING_push(reqnames, *args))
-                    goto end;
-            } else
-                badarg = 1;
-        } else if (!strcmp(*args, &quot;-index&quot;)) {
-            if (args[1]) {
-                args++;
-                ridx_filename = *args;
-            } else
-                badarg = 1;
-        } else if (!strcmp(*args, &quot;-CA&quot;)) {
-            if (args[1]) {
-                args++;
-                rca_filename = *args;
-            } else
-                badarg = 1;
-        } else if (!strcmp(*args, &quot;-nmin&quot;)) {
-            if (args[1]) {
-                args++;
-                nmin = atol(*args);
-                if (nmin &lt; 0) {
-                    BIO_printf(bio_err, &quot;Illegal update period %s\n&quot;, *args);
-                    badarg = 1;
-                }
-            }
+            vpmtouched++;
+            break;
+        case OPT_VALIDITY_PERIOD:
+            opt_long(opt_arg(), &amp;nsec);
+            break;
+        case OPT_STATUS_AGE:
+            opt_long(opt_arg(), &amp;maxage);
+            break;
+        case OPT_SIGNKEY:
+            keyfile = opt_arg();
+            break;
+        case OPT_REQOUT:
+            reqout = opt_arg();
+            break;
+        case OPT_RESPOUT:
+            respout = opt_arg();
+            break;
+        case OPT_PATH:
+            path = opt_arg();
+            break;
+        case OPT_CERT:
+            X509_free(cert);
+            cert = load_cert(opt_arg(), FORMAT_PEM,
+                             NULL, NULL, &quot;certificate&quot;);
+            if (cert == NULL)
+                goto end;
+            if (cert_id_md == NULL)
+                cert_id_md = EVP_sha1();
+            if (!add_ocsp_cert(&amp;req, cert, cert_id_md, issuer, ids))
+                goto end;
+            if (!sk_OPENSSL_STRING_push(reqnames, opt_arg()))
+                goto end;
+            break;
+        case OPT_SERIAL:
+            if (cert_id_md == NULL)
+                cert_id_md = EVP_sha1();
+            if (!add_ocsp_serial(&amp;req, opt_arg(), cert_id_md, issuer, ids))
+                goto end;
+            if (!sk_OPENSSL_STRING_push(reqnames, opt_arg()))
+                goto end;
+            break;
+        case OPT_INDEX:
+            ridx_filename = opt_arg();
+            break;
+        case OPT_CA:
+            rca_filename = opt_arg();
+            break;
+        case OPT_NMIN:
+            opt_int(opt_arg(), &amp;nmin);
             if (ndays == -1)
                 ndays = 0;
-            else
-                badarg = 1;
-        } else if (!strcmp(*args, &quot;-nrequest&quot;)) {
-            if (args[1]) {
-                args++;
-                accept_count = atol(*args);
-                if (accept_count &lt; 0) {
-                    BIO_printf(bio_err, &quot;Illegal accept count %s\n&quot;, *args);
-                    badarg = 1;
-                }
-            } else
-                badarg = 1;
-        } else if (!strcmp(*args, &quot;-ndays&quot;)) {
-            if (args[1]) {
-                args++;
-                ndays = atol(*args);
-                if (ndays &lt; 0) {
-                    BIO_printf(bio_err, &quot;Illegal update period %s\n&quot;, *args);
-                    badarg = 1;
-                }
-            } else
-                badarg = 1;
-        } else if (!strcmp(*args, &quot;-rsigner&quot;)) {
-            if (args[1]) {
-                args++;
-                rsignfile = *args;
-            } else
-                badarg = 1;
-        } else if (!strcmp(*args, &quot;-rkey&quot;)) {
-            if (args[1]) {
-                args++;
-                rkeyfile = *args;
-            } else
-                badarg = 1;
-        } else if (!strcmp(*args, &quot;-rother&quot;)) {
-            if (args[1]) {
-                args++;
-                rcertfile = *args;
-            } else
-                badarg = 1;
-        } else if (!strcmp(*args, &quot;-rmd&quot;)) {
-            if (args[1]) {
-                args++;
-                rsign_md = EVP_get_digestbyname(*args);
-                if (!rsign_md)
-                    badarg = 1;
-            } else
-                badarg = 1;
-        } else if ((cert_id_md = EVP_get_digestbyname((*args) + 1)) == NULL) {
-            badarg = 1;
+            break;
+        case OPT_REQUEST:
+            opt_int(opt_arg(), &amp;accept_count);
+            break;
+        case OPT_NDAYS:
+            ndays = atoi(opt_arg());
+            break;
+        case OPT_RSIGNER:
+            rsignfile = opt_arg();
+            break;
+        case OPT_RKEY:
+            rkeyfile = opt_arg();
+            break;
+        case OPT_ROTHER:
+            rcertfile = opt_arg();
+            break;
+        case OPT_RMD:
+            if (!opt_md(opt_arg(), &amp;rsign_md))
+                goto end;
+            break;
+        case OPT_HEADER:
+            header = opt_arg();
+            value = strchr(header, '=');
+            if (value == NULL) {
+                BIO_printf(bio_err, &quot;Missing = in header key=value\n&quot;);
+                goto opthelp;
+            }
+            *value++ = '\0';
+            if (!X509V3_add_value(header, value, &amp;headers))
+                goto end;
+            break;
+        case OPT_MD:
+            if (cert_id_md != NULL) {
+                BIO_printf(bio_err,
+                           &quot;%s: Digest must be before -cert or -serial\n&quot;,
+                           prog);
+                goto opthelp;
+            }
+            if (!opt_md(opt_unknown(), &amp;cert_id_md))
+                goto opthelp;
+            break;
         }
-        args++;
     }
+    argc = opt_num_rest();
+    argv = opt_rest();
 
     /* Have we anything to do? */
     if (!req &amp;&amp; !reqin &amp;&amp; !respin &amp;&amp; !(port &amp;&amp; ridx_filename))
-        badarg = 1;
-
-    if (badarg) {
-        BIO_printf(bio_err, &quot;OCSP utility\n&quot;);
-        BIO_printf(bio_err, &quot;Usage ocsp [options]\n&quot;);
-        BIO_printf(bio_err, &quot;where options are\n&quot;);
-        BIO_printf(bio_err, &quot;-out file            output filename\n&quot;);
-        BIO_printf(bio_err, &quot;-issuer file         issuer certificate\n&quot;);
-        BIO_printf(bio_err, &quot;-cert file           certificate to check\n&quot;);
-        BIO_printf(bio_err, &quot;-serial n            serial number to check\n&quot;);
-        BIO_printf(bio_err,
-                   &quot;-signer file         certificate to sign OCSP request with\n&quot;);
-        BIO_printf(bio_err,
-                   &quot;-signkey file        private key to sign OCSP request with\n&quot;);
-        BIO_printf(bio_err,
-                   &quot;-sign_other file     additional certificates to include in signed request\n&quot;);
-        BIO_printf(bio_err,
-                   &quot;-no_certs            don't include any certificates in signed request\n&quot;);
-        BIO_printf(bio_err,
-                   &quot;-req_text            print text form of request\n&quot;);
-        BIO_printf(bio_err,
-                   &quot;-resp_text           print text form of response\n&quot;);
-        BIO_printf(bio_err,
-                   &quot;-text                print text form of request and response\n&quot;);
-        BIO_printf(bio_err,
-                   &quot;-reqout file         write DER encoded OCSP request to \&quot;file\&quot;\n&quot;);
-        BIO_printf(bio_err,
-                   &quot;-respout file        write DER encoded OCSP reponse to \&quot;file\&quot;\n&quot;);
-        BIO_printf(bio_err,
-                   &quot;-reqin file          read DER encoded OCSP request from \&quot;file\&quot;\n&quot;);
-        BIO_printf(bio_err,
-                   &quot;-respin file         read DER encoded OCSP reponse from \&quot;file\&quot;\n&quot;);
-        BIO_printf(bio_err,
-                   &quot;-nonce               add OCSP nonce to request\n&quot;);
-        BIO_printf(bio_err,
-                   &quot;-no_nonce            don't add OCSP nonce to request\n&quot;);
-        BIO_printf(bio_err, &quot;-url URL             OCSP responder URL\n&quot;);
-        BIO_printf(bio_err,
-                   &quot;-host host:n         send OCSP request to host on port n\n&quot;);
-        BIO_printf(bio_err,
-                   &quot;-path                path to use in OCSP request\n&quot;);
-        BIO_printf(bio_err,
-                   &quot;-CApath dir          trusted certificates directory\n&quot;);
-        BIO_printf(bio_err,
-                   &quot;-CAfile file         trusted certificates file\n&quot;);
-        BIO_printf(bio_err,
-                   &quot;-trusted_first       use locally trusted CA's first when building trust chain\n&quot;);
-        BIO_printf(bio_err,
-                   &quot;-no_alt_chains       only ever use the first certificate chain found\n&quot;);
-        BIO_printf(bio_err,
-                   &quot;-VAfile file         validator certificates file\n&quot;);
-        BIO_printf(bio_err,
-                   &quot;-validity_period n   maximum validity discrepancy in seconds\n&quot;);
-        BIO_printf(bio_err,
-                   &quot;-status_age n        maximum status age in seconds\n&quot;);
-        BIO_printf(bio_err,
-                   &quot;-noverify            don't verify response at all\n&quot;);
-        BIO_printf(bio_err,
-                   &quot;-verify_other file   additional certificates to search for signer\n&quot;);
-        BIO_printf(bio_err,
-                   &quot;-trust_other         don't verify additional certificates\n&quot;);
-        BIO_printf(bio_err,
-                   &quot;-no_intern           don't search certificates contained in response for signer\n&quot;);
-        BIO_printf(bio_err,
-                   &quot;-no_signature_verify don't check signature on response\n&quot;);
-        BIO_printf(bio_err,
-                   &quot;-no_cert_verify      don't check signing certificate\n&quot;);
-        BIO_printf(bio_err,
-                   &quot;-no_chain            don't chain verify response\n&quot;);
-        BIO_printf(bio_err,
-                   &quot;-no_cert_checks      don't do additional checks on signing certificate\n&quot;);
-        BIO_printf(bio_err,
-                   &quot;-port num            port to run responder on\n&quot;);
-        BIO_printf(bio_err,
-                   &quot;-index file          certificate status index file\n&quot;);
-        BIO_printf(bio_err, &quot;-CA file             CA certificate\n&quot;);
-        BIO_printf(bio_err,
-                   &quot;-rsigner file        responder certificate to sign responses with\n&quot;);
-        BIO_printf(bio_err,
-                   &quot;-rkey file           responder key to sign responses with\n&quot;);
-        BIO_printf(bio_err,
-                   &quot;-rother file         other certificates to include in response\n&quot;);
-        BIO_printf(bio_err,
-                   &quot;-resp_no_certs       don't include any certificates in response\n&quot;);
-        BIO_printf(bio_err,
-                   &quot;-nmin n              number of minutes before next update\n&quot;);
-        BIO_printf(bio_err,
-                   &quot;-ndays n             number of days before next update\n&quot;);
-        BIO_printf(bio_err,
-                   &quot;-resp_key_id         identify reponse by signing certificate key ID\n&quot;);
-        BIO_printf(bio_err,
-                   &quot;-nrequest n          number of requests to accept (default unlimited)\n&quot;);
-        BIO_printf(bio_err,
-                   &quot;-&lt;dgst alg&gt;          use specified digest in the request\n&quot;);
-        BIO_printf(bio_err,
-                   &quot;-timeout n           timeout connection to OCSP responder after n seconds\n&quot;);
-        goto end;
-    }
+        goto opthelp;
 
-    if (outfile)
-        out = BIO_new_file(outfile, &quot;w&quot;);
-    else
-        out = BIO_new_fp(stdout, BIO_NOCLOSE);
-
-    if (!out) {
-        BIO_printf(bio_err, &quot;Error opening output file\n&quot;);
+    out = bio_open_default(outfile, &quot;w&quot;);
+    if (out == NULL)
         goto end;
-    }
 
     if (!req &amp;&amp; (add_nonce != 2))
         add_nonce = 0;
 
     if (!req &amp;&amp; reqin) {
-        if (!strcmp(reqin, &quot;-&quot;))
-            derbio = BIO_new_fp(stdin, BIO_NOCLOSE);
-        else
-            derbio = BIO_new_file(reqin, &quot;rb&quot;);
-        if (!derbio) {
-            BIO_printf(bio_err, &quot;Error Opening OCSP request file\n&quot;);
+        derbio = bio_open_default(reqin, &quot;rb&quot;);
+        if (derbio == NULL)
             goto end;
-        }
         req = d2i_OCSP_REQUEST_bio(derbio, NULL);
         BIO_free(derbio);
         if (!req) {
@@ -628,21 +500,21 @@ int MAIN(int argc, char **argv)
     if (rsignfile &amp;&amp; !rdb) {
         if (!rkeyfile)
             rkeyfile = rsignfile;
-        rsigner = load_cert(bio_err, rsignfile, FORMAT_PEM,
-                            NULL, e, &quot;responder certificate&quot;);
+        rsigner = load_cert(rsignfile, FORMAT_PEM,
+                            NULL, NULL, &quot;responder certificate&quot;);
         if (!rsigner) {
             BIO_printf(bio_err, &quot;Error loading responder certificate\n&quot;);
             goto end;
         }
-        rca_cert = load_cert(bio_err, rca_filename, FORMAT_PEM,
-                             NULL, e, &quot;CA certificate&quot;);
+        rca_cert = load_cert(rca_filename, FORMAT_PEM,
+                             NULL, NULL, &quot;CA certificate&quot;);
         if (rcertfile) {
-            rother = load_certs(bio_err, rcertfile, FORMAT_PEM,
-                                NULL, e, &quot;responder other certificates&quot;);
+            rother = load_certs(rcertfile, FORMAT_PEM,
+                                NULL, NULL, &quot;responder other certificates&quot;);
             if (!rother)
                 goto end;
         }
-        rkey = load_key(bio_err, rkeyfile, FORMAT_PEM, 0, NULL, NULL,
+        rkey = load_key(rkeyfile, FORMAT_PEM, 0, NULL, NULL,
                         &quot;responder private key&quot;);
         if (!rkey)
             goto end;
@@ -675,19 +547,19 @@ int MAIN(int argc, char **argv)
     if (signfile) {
         if (!keyfile)
             keyfile = signfile;
-        signer = load_cert(bio_err, signfile, FORMAT_PEM,
-                           NULL, e, &quot;signer certificate&quot;);
+        signer = load_cert(signfile, FORMAT_PEM,
+                           NULL, NULL, &quot;signer certificate&quot;);
         if (!signer) {
             BIO_printf(bio_err, &quot;Error loading signer certificate\n&quot;);
             goto end;
         }
         if (sign_certfile) {
-            sign_other = load_certs(bio_err, sign_certfile, FORMAT_PEM,
-                                    NULL, e, &quot;signer certificates&quot;);
+            sign_other = load_certs(sign_certfile, FORMAT_PEM,
+                                    NULL, NULL, &quot;signer certificates&quot;);
             if (!sign_other)
                 goto end;
         }
-        key = load_key(bio_err, keyfile, FORMAT_PEM, 0, NULL, NULL,
+        key = load_key(keyfile, FORMAT_PEM, 0, NULL, NULL,
                        &quot;signer private key&quot;);
         if (!key)
             goto end;
@@ -703,14 +575,9 @@ int MAIN(int argc, char **argv)
         OCSP_REQUEST_print(out, req, 0);
 
     if (reqout) {
-        if (!strcmp(reqout, &quot;-&quot;))
-            derbio = BIO_new_fp(stdout, BIO_NOCLOSE);
-        else
-            derbio = BIO_new_file(reqout, &quot;wb&quot;);
-        if (!derbio) {
-            BIO_printf(bio_err, &quot;Error opening file %s\n&quot;, reqout);
+        derbio = bio_open_default(reqout, &quot;wb&quot;);
+        if (derbio == NULL)
             goto end;
-        }
         i2d_OCSP_REQUEST_bio(derbio, req);
         BIO_free(derbio);
     }
@@ -730,13 +597,13 @@ int MAIN(int argc, char **argv)
     }
 
     if (rdb) {
-        i = make_ocsp_response(&amp;resp, req, rdb, rca_cert, rsigner, rkey,
+        make_ocsp_response(&amp;resp, req, rdb, rca_cert, rsigner, rkey,
                                rsign_md, rother, rflags, nmin, ndays, badsig);
         if (cbio)
             send_ocsp_response(cbio, resp);
     } else if (host) {
 # ifndef OPENSSL_NO_SOCK
-        resp = process_responder(bio_err, req, host, path,
+        resp = process_responder(req, host, path,
                                  port, use_ssl, headers, req_timeout);
         if (!resp)
             goto end;
@@ -746,21 +613,15 @@ int MAIN(int argc, char **argv)
         goto end;
 # endif
     } else if (respin) {
-        if (!strcmp(respin, &quot;-&quot;))
-            derbio = BIO_new_fp(stdin, BIO_NOCLOSE);
-        else
-            derbio = BIO_new_file(respin, &quot;rb&quot;);
-        if (!derbio) {
-            BIO_printf(bio_err, &quot;Error Opening OCSP response file\n&quot;);
+        derbio = bio_open_default(respin, &quot;rb&quot;);
+        if (derbio == NULL)
             goto end;
-        }
         resp = d2i_OCSP_RESPONSE_bio(derbio, NULL);
         BIO_free(derbio);
         if (!resp) {
             BIO_printf(bio_err, &quot;Error reading OCSP response\n&quot;);
             goto end;
         }
-
     } else {
         ret = 0;
         goto end;
@@ -769,20 +630,14 @@ int MAIN(int argc, char **argv)
  done_resp:
 
     if (respout) {
-        if (!strcmp(respout, &quot;-&quot;))
-            derbio = BIO_new_fp(stdout, BIO_NOCLOSE);
-        else
-            derbio = BIO_new_file(respout, &quot;wb&quot;);
-        if (!derbio) {
-            BIO_printf(bio_err, &quot;Error opening file %s\n&quot;, respout);
+        derbio = bio_open_default(respout, &quot;wb&quot;);
+        if (derbio == NULL)
             goto end;
-        }
         i2d_OCSP_RESPONSE_bio(derbio, resp);
         BIO_free(derbio);
     }
 
     i = OCSP_response_status(resp);
-
     if (i != OCSP_RESPONSE_STATUS_SUCCESSFUL) {
         BIO_printf(out, &quot;Responder Error: %s (%d)\n&quot;,
                    OCSP_response_status_str(i), i);
@@ -797,40 +652,38 @@ int MAIN(int argc, char **argv)
 
     /* If running as responder don't verify our own response */
     if (cbio) {
-        if (accept_count &gt; 0)
-            accept_count--;
-        /* Redo if more connections needed */
-        if (accept_count) {
-            BIO_free_all(cbio);
-            cbio = NULL;
-            OCSP_REQUEST_free(req);
-            req = NULL;
-            OCSP_RESPONSE_free(resp);
-            resp = NULL;
-            goto redo_accept;
+        if (--accept_count &lt;= 0) {
+            ret = 0;
+            goto end;
         }
-        ret = 0;
-        goto end;
-    } else if (ridx_filename) {
+        BIO_free_all(cbio);
+        cbio = NULL;
+        OCSP_REQUEST_free(req);
+        req = NULL;
+        OCSP_RESPONSE_free(resp);
+        resp = NULL;
+        goto redo_accept;
+    }
+    if (ridx_filename) {
         ret = 0;
         goto end;
     }
 
-    if (!store)
-        store = setup_verify(bio_err, CAfile, CApath);
-    if (!store)
-        goto end;
-    if (vpm)
+    if (!store) {
+        store = setup_verify(CAfile, CApath);
+        if (!store)
+            goto end;
+    }
+    if (vpmtouched)
         X509_STORE_set1_param(store, vpm);
     if (verify_certfile) {
-        verify_other = load_certs(bio_err, verify_certfile, FORMAT_PEM,
-                                  NULL, e, &quot;validator certificate&quot;);
+        verify_other = load_certs(verify_certfile, FORMAT_PEM,
+                                  NULL, NULL, &quot;validator certificate&quot;);
         if (!verify_other)
             goto end;
     }
 
     bs = OCSP_response_get1_basic(resp);
-
     if (!bs) {
         BIO_printf(bio_err, &quot;Error parsing response\n&quot;);
         goto end;
@@ -859,8 +712,7 @@ int MAIN(int argc, char **argv)
 
     }
 
-    if (!print_ocsp_summary(out, bs, req, reqnames, ids, nsec, maxage))
-        ret = 1;
+    print_ocsp_summary(out, bs, req, reqnames, ids, nsec, maxage);
 
  end:
     ERR_print_errors(bio_err);
@@ -870,7 +722,6 @@ int MAIN(int argc, char **argv)
         X509_VERIFY_PARAM_free(vpm);
     EVP_PKEY_free(key);
     EVP_PKEY_free(rkey);
-    X509_free(issuer);
     X509_free(cert);
     X509_free(rsigner);
     X509_free(rca_cert);
@@ -894,7 +745,7 @@ int MAIN(int argc, char **argv)
     if (tpath)
         OPENSSL_free(tpath);
 
-    OPENSSL_EXIT(ret);
+    return (ret);
 }
 
 static int add_ocsp_cert(OCSP_REQUEST **req, X509 *cert,
@@ -958,22 +809,19 @@ static int add_ocsp_serial(OCSP_REQUEST **req, char *serial,
     return 0;
 }
 
-static int print_ocsp_summary(BIO *out, OCSP_BASICRESP *bs, OCSP_REQUEST *req,
+static void print_ocsp_summary(BIO *out, OCSP_BASICRESP *bs, OCSP_REQUEST *req,
                               STACK_OF(OPENSSL_STRING) *names,
                               STACK_OF(OCSP_CERTID) *ids, long nsec,
                               long maxage)
 {
     OCSP_CERTID *id;
     char *name;
-    int i;
-
-    int status, reason;
-
+    int i, status, reason;
     ASN1_GENERALIZEDTIME *rev, *thisupd, *nextupd;
 
     if (!bs || !req || !sk_OPENSSL_STRING_num(names)
         || !sk_OCSP_CERTID_num(ids))
-        return 1;
+        return;
 
     for (i = 0; i &lt; sk_OCSP_CERTID_num(ids); i++) {
         id = sk_OCSP_CERTID_value(ids, i);
@@ -1016,11 +864,9 @@ static int print_ocsp_summary(BIO *out, OCSP_BASICRESP *bs, OCSP_REQUEST *req,
         ASN1_GENERALIZEDTIME_print(out, rev);
         BIO_puts(out, &quot;\n&quot;);
     }
-
-    return 1;
 }
 
-static int make_ocsp_response(OCSP_RESPONSE **resp, OCSP_REQUEST *req,
+static void make_ocsp_response(OCSP_RESPONSE **resp, OCSP_REQUEST *req,
                               CA_DB *db, X509 *ca, X509 *rcert,
                               EVP_PKEY *rkey, const EVP_MD *rmd,
                               STACK_OF(X509) *rother, unsigned long flags,
@@ -1029,7 +875,7 @@ static int make_ocsp_response(OCSP_RESPONSE **resp, OCSP_REQUEST *req,
     ASN1_TIME *thisupd = NULL, *nextupd = NULL;
     OCSP_CERTID *cid, *ca_id = NULL;
     OCSP_BASICRESP *bs = NULL;
-    int i, id_count, ret = 1;
+    int i, id_count;
 
     id_count = OCSP_request_onereq_count(req);
 
@@ -1112,8 +958,7 @@ static int make_ocsp_response(OCSP_RESPONSE **resp, OCSP_REQUEST *req,
 
     if (badsig) {
         ASN1_OCTET_STRING *sig = OCSP_resp_get0_signature(bs);
-        unsigned char *sigptr;
-        sigptr = ASN1_STRING_data(sig);
+        unsigned char *sigptr = ASN1_STRING_data(sig);
         sigptr[ASN1_STRING_length(sig) - 1] ^= 0x1;
     }
 
@@ -1124,8 +969,6 @@ static int make_ocsp_response(OCSP_RESPONSE **resp, OCSP_REQUEST *req,
     ASN1_TIME_free(nextupd);
     OCSP_CERTID_free(ca_id);
     OCSP_BASICRESP_free(bs);
-    return ret;
-
 }
 
 static char **lookup_serial(CA_DB *db, ASN1_INTEGER *ser)
@@ -1154,6 +997,7 @@ static char **lookup_serial(CA_DB *db, ASN1_INTEGER *ser)
 static BIO *init_responder(const char *port)
 {
     BIO *acbio = NULL, *bufbio = NULL;
+
     bufbio = BIO_new(BIO_f_buffer());
     if (!bufbio)
         goto err;
@@ -1185,9 +1029,9 @@ static BIO *init_responder(const char *port)
 static int do_responder(OCSP_REQUEST **preq, BIO **pcbio, BIO *acbio,
                         const char *port)
 {
-    int have_post = 0, len;
+    int len;
     OCSP_REQUEST *req = NULL;
-    char inbuf[1024];
+    char inbuf[2048];
     BIO *cbio = NULL;
 
     if (BIO_do_accept(acbio) &lt;= 0) {
@@ -1199,25 +1043,24 @@ static int do_responder(OCSP_REQUEST **preq, BIO **pcbio, BIO *acbio,
     cbio = BIO_pop(acbio);
     *pcbio = cbio;
 
+    /* Read the request line. */
+    len = BIO_gets(cbio, inbuf, sizeof inbuf);
+    if (len &lt;= 0)
+        return 1;
+    if (strncmp(inbuf, &quot;POST&quot;, 4) != 0) {
+        BIO_printf(bio_err, &quot;Invalid request\n&quot;);
+        return 1;
+    }
     for (;;) {
         len = BIO_gets(cbio, inbuf, sizeof inbuf);
         if (len &lt;= 0)
             return 1;
-        /* Look for &quot;POST&quot; signalling start of query */
-        if (!have_post) {
-            if (strncmp(inbuf, &quot;POST&quot;, 4)) {
-                BIO_printf(bio_err, &quot;Invalid request\n&quot;);
-                return 1;
-            }
-            have_post = 1;
-        }
         /* Look for end of headers */
         if ((inbuf[0] == '\r') || (inbuf[0] == '\n'))
             break;
     }
 
     /* Try to read OCSP request */
-
     req = d2i_OCSP_REQUEST_bio(cbio, NULL);
 
     if (!req) {
@@ -1244,7 +1087,7 @@ static int send_ocsp_response(BIO *cbio, OCSP_RESPONSE *resp)
     return 1;
 }
 
-static OCSP_RESPONSE *query_responder(BIO *err, BIO *cbio, const char *path,
+static OCSP_RESPONSE *query_responder(BIO *cbio, const char *path,
                                       const STACK_OF(CONF_VALUE) *headers,
                                       OCSP_REQUEST *req, int req_timeout)
 {
@@ -1262,12 +1105,12 @@ static OCSP_RESPONSE *query_responder(BIO *err, BIO *cbio, const char *path,
     rv = BIO_do_connect(cbio);
 
     if ((rv &lt;= 0) &amp;&amp; ((req_timeout == -1) || !BIO_should_retry(cbio))) {
-        BIO_puts(err, &quot;Error connecting BIO\n&quot;);
+        BIO_puts(bio_err, &quot;Error connecting BIO\n&quot;);
         return NULL;
     }
 
     if (BIO_get_fd(cbio, &amp;fd) &lt;= 0) {
-        BIO_puts(err, &quot;Can't get connection fd\n&quot;);
+        BIO_puts(bio_err, &quot;Can't get connection fd\n&quot;);
         goto err;
     }
 
@@ -1278,7 +1121,7 @@ static OCSP_RESPONSE *query_responder(BIO *err, BIO *cbio, const char *path,
         tv.tv_sec = req_timeout;
         rv = select(fd + 1, NULL, (void *)&amp;confds, NULL, &amp;tv);
         if (rv == 0) {
-            BIO_puts(err, &quot;Timeout on connect\n&quot;);
+            BIO_puts(bio_err, &quot;Timeout on connect\n&quot;);
             return NULL;
         }
     }
@@ -1311,15 +1154,15 @@ static OCSP_RESPONSE *query_responder(BIO *err, BIO *cbio, const char *path,
         else if (BIO_should_write(cbio))
             rv = select(fd + 1, NULL, (void *)&amp;confds, NULL, &amp;tv);
         else {
-            BIO_puts(err, &quot;Unexpected retry condition\n&quot;);
+            BIO_puts(bio_err, &quot;Unexpected retry condition\n&quot;);
             goto err;
         }
         if (rv == 0) {
-            BIO_puts(err, &quot;Timeout on request\n&quot;);
+            BIO_puts(bio_err, &quot;Timeout on request\n&quot;);
             break;
         }
         if (rv == -1) {
-            BIO_puts(err, &quot;Select error\n&quot;);
+            BIO_puts(bio_err, &quot;Select error\n&quot;);
             break;
         }
 
@@ -1331,7 +1174,7 @@ static OCSP_RESPONSE *query_responder(BIO *err, BIO *cbio, const char *path,
     return rsp;
 }
 
-OCSP_RESPONSE *process_responder(BIO *err, OCSP_REQUEST *req,
+OCSP_RESPONSE *process_responder(OCSP_REQUEST *req,
                                  const char *host, const char *path,
                                  const char *port, int use_ssl,
                                  const STACK_OF(CONF_VALUE) *headers,
@@ -1342,7 +1185,7 @@ OCSP_RESPONSE *process_responder(BIO *err, OCSP_REQUEST *req,
     OCSP_RESPONSE *resp = NULL;
     cbio = BIO_new_connect(host);
     if (!cbio) {
-        BIO_printf(err, &quot;Error creating connect BIO\n&quot;);
+        BIO_printf(bio_err, &quot;Error creating connect BIO\n&quot;);
         goto end;
     }
     if (port)
@@ -1351,14 +1194,14 @@ OCSP_RESPONSE *process_responder(BIO *err, OCSP_REQUEST *req,
         BIO *sbio;
         ctx = SSL_CTX_new(SSLv23_client_method());
         if (ctx == NULL) {
-            BIO_printf(err, &quot;Error creating SSL context.\n&quot;);
+            BIO_printf(bio_err, &quot;Error creating SSL context.\n&quot;);
             goto end;
         }
         SSL_CTX_set_mode(ctx, SSL_MODE_AUTO_RETRY);
         sbio = BIO_new_ssl(ctx, 1);
         cbio = BIO_push(sbio, cbio);
     }
-    resp = query_responder(err, cbio, path, headers, req, req_timeout);
+    resp = query_responder(cbio, path, headers, req, req_timeout);
     if (!resp)
         BIO_printf(bio_err, &quot;Error querying OCSP responder\n&quot;);
  end:
diff --git a/apps/openssl.c b/apps/openssl.c
index e93aed7..de73fac 100644
--- a/apps/openssl.c
+++ b/apps/openssl.c
@@ -1,4 +1,3 @@
-/* apps/openssl.c */
 /* Copyright (C) 1995-1998 Eric Young (<A HREF="../../../mailman/listinfo/openssl-commits.html">eay at cryptsoft.com</A>)
  * All rights reserved.
  *
@@ -112,9 +111,6 @@
 #include &lt;stdio.h&gt;
 #include &lt;string.h&gt;
 #include &lt;stdlib.h&gt;
-#define OPENSSL_C               /* tells apps.h to use complete
-                                 * apps_startup() */
-#include &quot;apps.h&quot;
 #include &lt;openssl/bio.h&gt;
 #include &lt;openssl/crypto.h&gt;
 #include &lt;openssl/rand.h&gt;
@@ -126,14 +122,35 @@
 #ifndef OPENSSL_NO_ENGINE
 # include &lt;openssl/engine.h&gt;
 #endif
-#define USE_SOCKETS             /* needed for the _O_BINARY defs in the MS
-                                 * world */
-#include &quot;progs.h&quot;
+/* needed for the _O_BINARY defs in the MS world */
+#define USE_SOCKETS
 #include &quot;s_apps.h&quot;
 #include &lt;openssl/err.h&gt;
 #ifdef OPENSSL_FIPS
 # include &lt;openssl/fips.h&gt;
 #endif
+#define INCLUDE_FUNCTION_TABLE
+#include &quot;apps.h&quot;
+
+#if 1
+# define LIST_STANDARD_COMMANDS &quot;list-standard-commands&quot;
+# define LIST_MESSAGE_DIGEST_COMMANDS &quot;list-message-digest-commands&quot;
+# define LIST_MESSAGE_DIGEST_ALGORITHMS &quot;list-message-digest-algorithms&quot;
+# define LIST_CIPHER_COMMANDS &quot;list-cipher-commands&quot;
+# define LIST_CIPHER_ALGORITHMS &quot;list-cipher-algorithms&quot;
+# define LIST_PUBLIC_KEY_ALGORITHMS &quot;list-public-key-algorithms&quot;
+#endif
+
+#ifdef OPENSSL_NO_CAMELLIA
+# define FORMAT &quot;%-15s&quot;
+# define COLUMNS 5
+#else
+# define FORMAT &quot;%-18s&quot;
+# define COLUMNS 4
+#endif
+
+/* Special sentinel to exit the program. */
+#define EXIT_THE_PROGRAM (-1)
 
 /*
  * The LHASH callbacks (&quot;hash&quot; &amp; &quot;cmp&quot;) have been replaced by functions with
@@ -141,28 +158,103 @@
  * required type of &quot;FUNCTION*&quot;). This removes the necessity for
  * macro-generated wrapper functions.
  */
-
+DECLARE_LHASH_OF(FUNCTION);
 static LHASH_OF(FUNCTION) *prog_init(void);
 static int do_cmd(LHASH_OF(FUNCTION) *prog, int argc, char *argv[]);
-static void list_pkey(BIO *out);
-static void list_cipher(BIO *out);
-static void list_md(BIO *out);
+static int list_pkey(void);
+static int list_cipher(void);
+static int list_md(void);
+static int list_type(FUNC_TYPE list_type);
 char *default_config_file = NULL;
 
-/* Make sure there is only one when MONOLITH is defined */
-#ifdef MONOLITH
 CONF *config = NULL;
+BIO *bio_in = NULL;
+BIO *bio_out = NULL;
 BIO *bio_err = NULL;
+
+static void apps_startup()
+{
+#ifdef SIGPIPE
+    signal(SIGPIPE, SIG_IGN);
+#endif
+    CRYPTO_malloc_init();
+    ERR_load_crypto_strings();
+    ERR_load_SSL_strings();
+    OpenSSL_add_all_algorithms();
+    OpenSSL_add_ssl_algorithms();
+    setup_ui_method();
+    /*SSL_library_init();*/
+#ifndef OPENSSL_NO_ENGINE
+    ENGINE_load_builtin_engines();
+#endif
+}
+
+static void apps_shutdown()
+{
+#ifndef OPENSSL_NO_ENGINE
+    ENGINE_cleanup();
+#endif
+    destroy_ui_method();
+    CONF_modules_unload(1);
+#ifndef OPENSSL_NO_COMP
+    COMP_zlib_cleanup();
+#endif
+    OBJ_cleanup();
+    EVP_cleanup();
+    CRYPTO_cleanup_all_ex_data();
+    ERR_remove_thread_state(NULL);
+    RAND_cleanup();
+    ERR_free_strings();
+}
+
+static char *make_config_name()
+{
+    const char *t = X509_get_default_cert_area();
+    size_t len;
+    char *p;
+
+    len = strlen(t) + strlen(OPENSSL_CONF) + 2;
+    p = OPENSSL_malloc(len);
+    if (p == NULL)
+        return NULL;
+    BUF_strlcpy(p, t, len);
+#ifndef OPENSSL_SYS_VMS
+    BUF_strlcat(p, &quot;/&quot;, len);
 #endif
+    BUF_strlcat(p, OPENSSL_CONF, len);
+
+    return p;
+}
+
+static int load_config(CONF *cnf)
+{
+    static int load_config_called = 0;
+
+    if (load_config_called)
+        return 1;
+    load_config_called = 1;
+    if (!cnf)
+        cnf = config;
+    if (!cnf)
+        return 1;
+
+    OPENSSL_load_builtin_modules();
+
+    if (CONF_modules_load(cnf, NULL, 0) &lt;= 0) {
+        BIO_printf(bio_err, &quot;Error configuring OpenSSL\n&quot;);
+        ERR_print_errors(bio_err);
+        return 0;
+    }
+    return 1;
+}
 
 static void lock_dbg_cb(int mode, int type, const char *file, int line)
 {
-    static int modes[CRYPTO_NUM_LOCKS]; /* = {0, 0, ... } */
+    static int modes[CRYPTO_NUM_LOCKS];
     const char *errstr = NULL;
-    int rw;
+    int rw = mode &amp; (CRYPTO_READ | CRYPTO_WRITE);
 
-    rw = mode &amp; (CRYPTO_READ | CRYPTO_WRITE);
-    if (!((rw == CRYPTO_READ) || (rw == CRYPTO_WRITE))) {
+    if (rw != CRYPTO_READ &amp;&amp; rw != CRYPTO_WRITE) {
         errstr = &quot;invalid mode&quot;;
         goto err;
     }
@@ -175,12 +267,9 @@ static void lock_dbg_cb(int mode, int type, const char *file, int line)
     if (mode &amp; CRYPTO_LOCK) {
         if (modes[type]) {
             errstr = &quot;already locked&quot;;
-            /*
-             * must not happen in a single-threaded program (would deadlock)
-             */
+            /* must not happen in a single-threaded program --&gt; deadlock! */
             goto err;
         }
-
         modes[type] = rw;
     } else if (mode &amp; CRYPTO_UNLOCK) {
         if (!modes[type]) {
@@ -209,98 +298,83 @@ static void lock_dbg_cb(int mode, int type, const char *file, int line)
     }
 }
 
-#if defined( OPENSSL_SYS_VMS) &amp;&amp; (__INITIAL_POINTER_SIZE == 64)
-# define ARGV _Argv
-#else
-# define ARGV Argv
+BIO *dup_bio_in(void)
+{
+    return BIO_new_fp(stdin, BIO_NOCLOSE | BIO_FP_TEXT);
+}
+
+BIO *dup_bio_out(void)
+{
+    BIO *b = BIO_new_fp(stdout, BIO_NOCLOSE | BIO_FP_TEXT);
+#ifdef OPENSSL_SYS_VMS
+    b = BIO_push(BIO_new(BIO_f_linebuffer()), b);
 #endif
+    return b;
+}
 
-int main(int Argc, char *ARGV[])
+void unbuffer(FILE *fp)
+{
+    setbuf(fp, NULL);
+}
+
+BIO *bio_open_default(const char *filename, const char *mode)
+{
+    BIO *ret;
+
+    if (filename == NULL || strcmp(filename, &quot;-&quot;) == 0) {
+        ret = *mode == 'r' ? dup_bio_in() : dup_bio_out();
+        if (ret != NULL)
+            return ret;
+        BIO_printf(bio_err,
+                   &quot;Can't open %s, %s\n&quot;,
+                   *mode == 'r' ? &quot;stdin&quot; : &quot;stdout&quot;, strerror(errno));
+    } else {
+        ret = BIO_new_file(filename, mode);
+        if (ret != NULL)
+            return ret;
+        BIO_printf(bio_err,
+                   &quot;Can't open %s for %s, %s\n&quot;,
+                   filename,
+                   *mode == 'r' ? &quot;reading&quot; : &quot;writing&quot;, strerror(errno));
+    }
+    ERR_print_errors(bio_err);
+    return NULL;
+}
+
+#if defined( OPENSSL_SYS_VMS)
+extern char **copy_argv(int *argc, char **argv);
+#endif
+
+int main(int argc, char *argv[])
 {
-    ARGS arg;
-#define PROG_NAME_SIZE  39
-    char pname[PROG_NAME_SIZE + 1];
     FUNCTION f, *fp;
-    const char *prompt;
-    char buf[1024];
-    char *to_free = NULL;
-    int n, i, ret = 0;
-    int argc;
-    char **argv, *p;
     LHASH_OF(FUNCTION) *prog = NULL;
+    char **copied_argv = NULL;
+    char *p, *pname, *to_free = NULL;
+    char buf[1024];
+    const char *prompt;
+    ARGS arg;
+    int first, n, i, ret = 0;
     long errline;
 
-#if defined( OPENSSL_SYS_VMS) &amp;&amp; (__INITIAL_POINTER_SIZE == 64)
-    /*-
-     * 2011-03-22 SMS.
-     * If we have 32-bit pointers everywhere, then we're safe, and
-     * we bypass this mess, as on non-VMS systems.  (See ARGV,
-     * above.)
-     * Problem 1: Compaq/HP C before V7.3 always used 32-bit
-     * pointers for argv[].
-     * Fix 1: For a 32-bit argv[], when we're using 64-bit pointers
-     * everywhere else, we always allocate and use a 64-bit
-     * duplicate of argv[].
-     * Problem 2: Compaq/HP C V7.3 (Alpha, IA64) before ECO1 failed
-     * to NULL-terminate a 64-bit argv[].  (As this was written, the
-     * compiler ECO was available only on IA64.)
-     * Fix 2: Unless advised not to (VMS_TRUST_ARGV), we test a
-     * 64-bit argv[argc] for NULL, and, if necessary, use a
-     * (properly) NULL-terminated (64-bit) duplicate of argv[].
-     * The same code is used in either case to duplicate argv[].
-     * Some of these decisions could be handled in preprocessing,
-     * but the code tends to get even uglier, and the penalty for
-     * deciding at compile- or run-time is tiny.
-     */
-    char **Argv = NULL;
-    int free_Argv = 0;
-
-    if ((sizeof(_Argv) &lt; 8)     /* 32-bit argv[]. */
-# if !defined( VMS_TRUST_ARGV)
-        || (_Argv[Argc] != NULL) /* Untrusted argv[argc] not NULL. */
-# endif
-        ) {
-        int i;
-        Argv = OPENSSL_malloc((Argc + 1) * sizeof(char *));
-        if (Argv == NULL) {
-            ret = -1;
-            goto end;
-        }
-        for (i = 0; i &lt; Argc; i++)
-            Argv[i] = _Argv[i];
-        Argv[Argc] = NULL;      /* Certain NULL termination. */
-        free_Argv = 1;
+    arg.argv = NULL;
+    arg.size = 0;
+
+#if defined( OPENSSL_SYS_VMS)
+    copied_argv = argv = copy_argv(&amp;argc, argv);
+#endif
+
+    p = getenv(&quot;OPENSSL_DEBUG_MEMORY&quot;);
+    if (p == NULL)
+        /* if not set, use compiled-in default */
+        ;
+    else if (strcmp(p, &quot;off&quot;) != 0) {
+        CRYPTO_malloc_debug_init();
+        CRYPTO_set_mem_debug_options(V_CRYPTO_MDEBUG_ALL);
     } else {
-        /*
-         * Use the known-good 32-bit argv[] (which needs the type cast to
-         * satisfy the compiler), or the trusted or tested-good 64-bit argv[]
-         * as-is.
-         */
-        Argv = (char **)_Argv;
-    }
-#endif                          /* defined( OPENSSL_SYS_VMS) &amp;&amp;
-                                 * (__INITIAL_POINTER_SIZE == 64) */
-
-    arg.data = NULL;
-    arg.count = 0;
-
-    if (bio_err == NULL)
-        if ((bio_err = BIO_new(BIO_s_file())) != NULL)
-            BIO_set_fp(bio_err, stderr, BIO_NOCLOSE | BIO_FP_TEXT);
-
-    if (getenv(&quot;OPENSSL_DEBUG_MEMORY&quot;) != NULL) { /* if not defined, use
-                                                   * compiled-in library
-                                                   * defaults */
-        if (!(0 == strcmp(getenv(&quot;OPENSSL_DEBUG_MEMORY&quot;), &quot;off&quot;))) {
-            CRYPTO_malloc_debug_init();
-            CRYPTO_set_mem_debug_options(V_CRYPTO_MDEBUG_ALL);
-        } else {
-            /* OPENSSL_DEBUG_MEMORY=off */
-            CRYPTO_set_mem_debug_functions(0, 0, 0, 0, 0);
-        }
+        CRYPTO_set_mem_debug_functions(0, 0, 0, 0, 0);
     }
     CRYPTO_mem_ctrl(CRYPTO_MEM_CHECK_ON);
-
     CRYPTO_set_locking_callback(lock_dbg_cb);
 
     if (getenv(&quot;OPENSSL_FIPS&quot;)) {
@@ -318,21 +392,40 @@ int main(int Argc, char *ARGV[])
 
     apps_startup();
 
-    /* Lets load up our environment a little */
-    p = getenv(&quot;OPENSSL_CONF&quot;);
-    if (p == NULL)
-        p = getenv(&quot;SSLEAY_CONF&quot;);
-    if (p == NULL)
-        p = to_free = make_config_name();
-
-    default_config_file = p;
+    /*
+     * If first argument is a colon, skip it.  Because in &quot;interactive&quot;
+     * mode our prompt is a colon and we can cut/paste whole lines
+     * by doing this hack.
+     */
+    if (argv[1] &amp;&amp; strcmp(argv[1], &quot;:&quot;) == 0) {
+        argv[1] = argv[0];
+        argc--;
+        argv++;
+    }
+    prog = prog_init();
+    pname = opt_progname(argv[0]);
 
+    /* Lets load up our environment a little */
+    bio_in = dup_bio_in();
+    bio_out = dup_bio_out();
+    bio_err = BIO_new_fp(stderr, BIO_NOCLOSE | BIO_FP_TEXT);
+
+    /* Determine and load the config file. */
+    default_config_file = getenv(&quot;OPENSSL_CONF&quot;);
+    if (default_config_file == NULL)
+        default_config_file = getenv(&quot;SSLEAY_CONF&quot;);
+    if (default_config_file == NULL)
+        default_config_file = to_free = make_config_name();
+    if (!load_config(NULL))
+        goto end;
     config = NCONF_new(NULL);
-    i = NCONF_load(config, p, &amp;errline);
+    i = NCONF_load(config, default_config_file, &amp;errline);
     if (i == 0) {
         if (ERR_GET_REASON(ERR_peek_last_error())
             == CONF_R_NO_SUCH_FILE) {
-            BIO_printf(bio_err, &quot;WARNING: can't open config file: %s\n&quot;, p);
+            BIO_printf(bio_err,
+                       &quot;%s: WARNING: can't open config file: %s\n&quot;,
+                       pname, default_config_file);
             ERR_clear_error();
             NCONF_free(config);
             config = NULL;
@@ -343,45 +436,31 @@ int main(int Argc, char *ARGV[])
         }
     }
 
-    prog = prog_init();
-
     /* first check the program name */
-    program_name(Argv[0], pname, sizeof pname);
-
     f.name = pname;
     fp = lh_FUNCTION_retrieve(prog, &amp;f);
     if (fp != NULL) {
-        Argv[0] = pname;
-        ret = fp-&gt;func(Argc, Argv);
+        argv[0] = pname;
+        ret = fp-&gt;func(argc, argv);
         goto end;
     }
 
-    /*
-     * ok, now check that there are not arguments, if there are, run with
-     * them, shifting the ssleay off the front
-     */
-    if (Argc != 1) {
-        Argc--;
-        Argv++;
-        ret = do_cmd(prog, Argc, Argv);
+    /* If there is stuff on the command line, run with that. */
+    if (argc != 1) {
+        argc--;
+        argv++;
+        ret = do_cmd(prog, argc, argv);
         if (ret &lt; 0)
             ret = 0;
         goto end;
     }
 
-    /* ok, lets enter the old 'OpenSSL&gt;' mode */
-
+    /* ok, lets enter interactive mode */
     for (;;) {
         ret = 0;
-        p = buf;
-        n = sizeof buf;
-        i = 0;
-        for (;;) {
+        for (p = buf, n = sizeof buf, i = 0, first = 1;; first = 0) {
+            prompt = first ? &quot;OpenSSL&gt; &quot; : &quot;&gt; &quot;;
             p[0] = '\0';
-            if (i++)
-                prompt = &quot;&gt;&quot;;
-            else
-                prompt = &quot;OpenSSL&gt; &quot;;
             fputs(prompt, stdout);
             fflush(stdout);
             if (!fgets(p, n, stdin))
@@ -397,21 +476,25 @@ int main(int Argc, char *ARGV[])
             p += i;
             n -= i;
         }
-        if (!chopup_args(&amp;arg, buf, &amp;argc, &amp;argv))
+        if (!chopup_args(&amp;arg, buf)) {
+            BIO_printf(bio_err, &quot;Can't parse (no memory?)\n&quot;);
             break;
+        }
 
-        ret = do_cmd(prog, argc, argv);
-        if (ret &lt; 0) {
+        ret = do_cmd(prog, arg.argc, arg.argv);
+        if (ret == EXIT_THE_PROGRAM) {
             ret = 0;
             goto end;
         }
         if (ret != 0)
-            BIO_printf(bio_err, &quot;error in %s\n&quot;, argv[0]);
+            BIO_printf(bio_err, &quot;error in %s\n&quot;, arg.argv[0]);
+        (void)BIO_flush(bio_out);
         (void)BIO_flush(bio_err);
     }
-    BIO_printf(bio_err, &quot;bad exit\n&quot;);
     ret = 1;
  end:
+    if (copied_argv)
+        OPENSSL_free(copied_argv);
     if (to_free)
         OPENSSL_free(to_free);
     if (config != NULL) {
@@ -420,179 +503,222 @@ int main(int Argc, char *ARGV[])
     }
     if (prog != NULL)
         lh_FUNCTION_free(prog);
-    if (arg.data != NULL)
-        OPENSSL_free(arg.data);
+    if (arg.argv != NULL)
+        OPENSSL_free(arg.argv);
 
-#if defined( OPENSSL_SYS_VMS) &amp;&amp; (__INITIAL_POINTER_SIZE == 64)
-    /* Free any duplicate Argv[] storage. */
-    if (free_Argv) {
-        OPENSSL_free(Argv);
-    }
-#endif
+    BIO_free(bio_in);
+    BIO_free_all(bio_out);
     apps_shutdown();
-    CRYPTO_mem_leaks(bio_err);
+    /*CRYPTO_mem_leaks(bio_err);
+     */
     BIO_free(bio_err);
-    bio_err = NULL;
+    return (ret);
+}
+
+OPTIONS exit_options[] = {
+    {NULL}
+};
+
+/* Unified enum for help and list commands. */
+typedef enum HELPLIST_CHOICE {
+    OPT_ERR = -1, OPT_EOF = 0, OPT_HELP,
+    OPT_COMMANDS, OPT_DIGEST_COMMANDS,
+    OPT_DIGEST_ALGORITHMS, OPT_CIPHER_COMMANDS, OPT_CIPHER_ALGORITHMS,
+    OPT_PK_ALGORITHMS
+} HELPLIST_CHOICE;
+
+OPTIONS list_options[] = {
+    {&quot;help&quot;, OPT_HELP, '-', &quot;Display this summary&quot;},
+    {&quot;commands&quot;, OPT_COMMANDS, '-', &quot;List of standard commands&quot;},
+    {&quot;digest-commands&quot;, OPT_DIGEST_COMMANDS, '-',
+     &quot;List of message digest commands&quot;},
+    {&quot;digest-algorithms&quot;, OPT_DIGEST_ALGORITHMS, '-',
+     &quot;List of message digest algorithms&quot;},
+    {&quot;cipher-commands&quot;, OPT_CIPHER_COMMANDS, '-', &quot;List of cipher commands&quot;},
+    {&quot;cipher-algorithms&quot;, OPT_CIPHER_ALGORITHMS, '-',
+     &quot;List of cipher algorithms&quot;},
+    {&quot;public-key-algorithms&quot;, OPT_PK_ALGORITHMS, '-',
+     &quot;List of public key algorithms&quot;},
+    {NULL}
+};
+
+int list_main(int argc, char **argv)
+{
+    char *prog;
+    HELPLIST_CHOICE o;
+
+    prog = opt_init(argc, argv, list_options);
+    while ((o = opt_next()) != OPT_EOF) {
+        switch (o) {
+        case OPT_EOF:
+        case OPT_ERR:
+            BIO_printf(bio_err, &quot;%s: Use -help for summary.\n&quot;, prog);
+            return 1;
+        case OPT_HELP:
+            opt_help(list_options);
+            break;
+        case OPT_COMMANDS:
+            return list_type(FT_general);
+        case OPT_DIGEST_COMMANDS:
+            return list_type(FT_md);
+        case OPT_DIGEST_ALGORITHMS:
+            return list_md();
+        case OPT_CIPHER_COMMANDS:
+            return list_type(FT_cipher);
+        case OPT_CIPHER_ALGORITHMS:
+            return list_cipher();
+        case OPT_PK_ALGORITHMS:
+            return list_pkey();
+        }
+    }
+
+    return 0;
+}
+
+OPTIONS help_options[] = {
+    {&quot;help&quot;, OPT_HELP, '-', &quot;Display this summary&quot;},
+    {NULL}
+};
+
+int help_main(int argc, char **argv)
+{
+    FUNCTION *fp;
+    int i, nl;
+    FUNC_TYPE tp;
+    char *prog;
+    HELPLIST_CHOICE o;
+
+    prog = opt_init(argc, argv, help_options);
+    while ((o = opt_next()) != OPT_EOF) {
+        switch (o) {
+        default:
+            BIO_printf(bio_err, &quot;%s: Use -help for summary.\n&quot;, prog);
+            return 1;
+        case OPT_HELP:
+            opt_help(help_options);
+            return 0;
+        }
+    }
+    argc = opt_num_rest();
+    argv = opt_rest();
+
+    if (argc != 0) {
+        BIO_printf(bio_err, &quot;Usage: %s\n&quot;, prog);
+        return 1;
+    }
+
+    BIO_printf(bio_err, &quot;\nStandard commands&quot;);
+    i = 0;
+    tp = FT_none;
+    for (fp = functions; fp-&gt;name != NULL; fp++) {
+        nl = 0;
+        if (((i++) % COLUMNS) == 0) {
+            BIO_printf(bio_err, &quot;\n&quot;);
+            nl = 1;
+        }
+        if (fp-&gt;type != tp) {
+            tp = fp-&gt;type;
+            if (!nl)
+                BIO_printf(bio_err, &quot;\n&quot;);
+            if (tp == FT_md) {
+                i = 1;
+                BIO_printf(bio_err,
+                           &quot;\nMessage Digest commands (see the `dgst' command for more details)\n&quot;);
+            } else if (tp == FT_cipher) {
+                i = 1;
+                BIO_printf(bio_err,
+                           &quot;\nCipher commands (see the `enc' command for more details)\n&quot;);
+            }
+        }
+        BIO_printf(bio_err, FORMAT, fp-&gt;name);
+    }
+    BIO_printf(bio_err, &quot;\n\n&quot;);
+    return 0;
+}
 
-    OPENSSL_EXIT(ret);
+int exit_main(int argc, char **argv)
+{
+    return EXIT_THE_PROGRAM;
 }
 
-#define LIST_STANDARD_COMMANDS &quot;list-standard-commands&quot;
-#define LIST_MESSAGE_DIGEST_COMMANDS &quot;list-message-digest-commands&quot;
-#define LIST_MESSAGE_DIGEST_ALGORITHMS &quot;list-message-digest-algorithms&quot;
-#define LIST_CIPHER_COMMANDS &quot;list-cipher-commands&quot;
-#define LIST_CIPHER_ALGORITHMS &quot;list-cipher-algorithms&quot;
-#define LIST_PUBLIC_KEY_ALGORITHMS &quot;list-public-key-algorithms&quot;
+static int list_type(FUNC_TYPE flist_type)
+{
+    FUNCTION *fp;
+    int i = 0;
+
+    for (fp = functions; fp-&gt;name != NULL; fp++)
+        if (fp-&gt;type == flist_type) {
+            if ((i++ % COLUMNS) == 0)
+                BIO_printf(bio_out, &quot;\n&quot;);
+            BIO_printf(bio_out, FORMAT, fp-&gt;name);
+        }
+    BIO_printf(bio_out, &quot;\n&quot;);
+    return 0;
+}
 
 static int do_cmd(LHASH_OF(FUNCTION) *prog, int argc, char *argv[])
 {
     FUNCTION f, *fp;
-    int i, ret = 1, tp, nl;
 
-    if ((argc &lt;= 0) || (argv[0] == NULL)) {
-        ret = 0;
-        goto end;
-    }
+    if (argc &lt;= 0 || argv[0] == NULL)
+        return (0);
     f.name = argv[0];
     fp = lh_FUNCTION_retrieve(prog, &amp;f);
     if (fp == NULL) {
         if (EVP_get_digestbyname(argv[0])) {
-            f.type = FUNC_TYPE_MD;
+            f.type = FT_md;
             f.func = dgst_main;
             fp = &f;
         } else if (EVP_get_cipherbyname(argv[0])) {
-            f.type = FUNC_TYPE_CIPHER;
+            f.type = FT_cipher;
             f.func = enc_main;
             fp = &f;
         }
     }
     if (fp != NULL) {
-        ret = fp-&gt;func(argc, argv);
-    } else if ((strncmp(argv[0], &quot;no-&quot;, 3)) == 0) {
-        BIO *bio_stdout = BIO_new_fp(stdout, BIO_NOCLOSE);
-#ifdef OPENSSL_SYS_VMS
-        {
-            BIO *tmpbio = BIO_new(BIO_f_linebuffer());
-            bio_stdout = BIO_push(tmpbio, bio_stdout);
-        }
-#endif
+        return (fp-&gt;func(argc, argv));
+    }
+    if ((strncmp(argv[0], &quot;no-&quot;, 3)) == 0) {
+        /*
+         * User is asking if foo is unsupported, by trying to &quot;run&quot; the
+         * no-foo command.  Strange.
+         */
         f.name = argv[0] + 3;
-        ret = (lh_FUNCTION_retrieve(prog, &amp;f) != NULL);
-        if (!ret)
-            BIO_printf(bio_stdout, &quot;%s\n&quot;, argv[0]);
-        else
-            BIO_printf(bio_stdout, &quot;%s\n&quot;, argv[0] + 3);
-        BIO_free_all(bio_stdout);
-        goto end;
-    } else if ((strcmp(argv[0], &quot;quit&quot;) == 0) ||
-               (strcmp(argv[0], &quot;q&quot;) == 0) ||
-               (strcmp(argv[0], &quot;exit&quot;) == 0) ||
-               (strcmp(argv[0], &quot;bye&quot;) == 0)) {
-        ret = -1;
-        goto end;
-    } else if ((strcmp(argv[0], LIST_STANDARD_COMMANDS) == 0) ||
-               (strcmp(argv[0], LIST_MESSAGE_DIGEST_COMMANDS) == 0) ||
-               (strcmp(argv[0], LIST_MESSAGE_DIGEST_ALGORITHMS) == 0) ||
-               (strcmp(argv[0], LIST_CIPHER_COMMANDS) == 0) ||
-               (strcmp(argv[0], LIST_CIPHER_ALGORITHMS) == 0) ||
-               (strcmp(argv[0], LIST_PUBLIC_KEY_ALGORITHMS) == 0)) {
-        int list_type;
-        BIO *bio_stdout;
-
-        if (strcmp(argv[0], LIST_STANDARD_COMMANDS) == 0)
-            list_type = FUNC_TYPE_GENERAL;
-        else if (strcmp(argv[0], LIST_MESSAGE_DIGEST_COMMANDS) == 0)
-            list_type = FUNC_TYPE_MD;
-        else if (strcmp(argv[0], LIST_MESSAGE_DIGEST_ALGORITHMS) == 0)
-            list_type = FUNC_TYPE_MD_ALG;
-        else if (strcmp(argv[0], LIST_PUBLIC_KEY_ALGORITHMS) == 0)
-            list_type = FUNC_TYPE_PKEY;
-        else if (strcmp(argv[0], LIST_CIPHER_ALGORITHMS) == 0)
-            list_type = FUNC_TYPE_CIPHER_ALG;
-        else                    /* strcmp(argv[0],LIST_CIPHER_COMMANDS) == 0 */
-            list_type = FUNC_TYPE_CIPHER;
-        bio_stdout = BIO_new_fp(stdout, BIO_NOCLOSE);
-#ifdef OPENSSL_SYS_VMS
-        {
-            BIO *tmpbio = BIO_new(BIO_f_linebuffer());
-            bio_stdout = BIO_push(tmpbio, bio_stdout);
+        if (lh_FUNCTION_retrieve(prog, &amp;f) == NULL) {
+            BIO_printf(bio_out, &quot;%s\n&quot;, argv[0]);
+            return (0);
         }
-#endif
-
-        if (!load_config(bio_err, NULL))
-            goto end;
-
-        if (list_type == FUNC_TYPE_PKEY)
-            list_pkey(bio_stdout);
-        if (list_type == FUNC_TYPE_MD_ALG)
-            list_md(bio_stdout);
-        if (list_type == FUNC_TYPE_CIPHER_ALG)
-            list_cipher(bio_stdout);
-        else {
-            for (fp = functions; fp-&gt;name != NULL; fp++)
-                if (fp-&gt;type == list_type)
-                    BIO_printf(bio_stdout, &quot;%s\n&quot;, fp-&gt;name);
-        }
-        BIO_free_all(bio_stdout);
-        ret = 0;
-        goto end;
-    } else {
-        BIO_printf(bio_err, &quot;openssl:Error: '%s' is an invalid command.\n&quot;,
-                   argv[0]);
-        BIO_printf(bio_err, &quot;\nStandard commands&quot;);
-        i = 0;
-        tp = 0;
-        for (fp = functions; fp-&gt;name != NULL; fp++) {
-            nl = 0;
-#ifdef OPENSSL_NO_CAMELLIA
-            if (((i++) % 5) == 0)
-#else
-            if (((i++) % 4) == 0)
-#endif
-            {
-                BIO_printf(bio_err, &quot;\n&quot;);
-                nl = 1;
-            }
-            if (fp-&gt;type != tp) {
-                tp = fp-&gt;type;
-                if (!nl)
-                    BIO_printf(bio_err, &quot;\n&quot;);
-                if (tp == FUNC_TYPE_MD) {
-                    i = 1;
-                    BIO_printf(bio_err,
-                               &quot;\nMessage Digest commands (see the `dgst' command for more details)\n&quot;);
-                } else if (tp == FUNC_TYPE_CIPHER) {
-                    i = 1;
-                    BIO_printf(bio_err,
-                               &quot;\nCipher commands (see the `enc' command for more details)\n&quot;);
-                }
-            }
-#ifdef OPENSSL_NO_CAMELLIA
-            BIO_printf(bio_err, &quot;%-15s&quot;, fp-&gt;name);
-#else
-            BIO_printf(bio_err, &quot;%-18s&quot;, fp-&gt;name);
-#endif
-        }
-        BIO_printf(bio_err, &quot;\n\n&quot;);
-        ret = 0;
+        BIO_printf(bio_out, &quot;%s\n&quot;, argv[0] + 3);
+        return 1;
     }
- end:
-    return (ret);
-}
-
-static int SortFnByName(const void *_f1, const void *_f2)
-{
-    const FUNCTION *f1 = _f1;
-    const FUNCTION *f2 = _f2;
+    if (strcmp(argv[0], &quot;quit&quot;) == 0 || strcmp(argv[0], &quot;q&quot;) == 0 ||
+        strcmp(argv[0], &quot;exit&quot;) == 0 || strcmp(argv[0], &quot;bye&quot;) == 0)
+        /* Special value to mean &quot;exit the program. */
+        return EXIT_THE_PROGRAM;
+#ifdef LIST_STANDARD_COMMANDS
+    if (strcmp(argv[0], LIST_STANDARD_COMMANDS) == 0)
+        return list_type(FT_general);
+    if (strcmp(argv[0], LIST_MESSAGE_DIGEST_ALGORITHMS) == 0)
+        return list_md();
+    if (strcmp(argv[0], LIST_PUBLIC_KEY_ALGORITHMS) == 0)
+        return list_pkey();
+    if (strcmp(argv[0], LIST_CIPHER_ALGORITHMS) == 0)
+        return list_cipher();
+    if (strcmp(argv[0], LIST_CIPHER_COMMANDS) == 0)
+        return list_type(FT_cipher);
+    if (strcmp(argv[0], LIST_MESSAGE_DIGEST_COMMANDS) == 0)
+        return list_type(FT_md);
+#endif
 
-    if (f1-&gt;type != f2-&gt;type)
-        return f1-&gt;type - f2-&gt;type;
-    return strcmp(f1-&gt;name, f2-&gt;name);
+    BIO_printf(bio_err, &quot;Invalid command '%s'; type \&quot;help\&quot; for a list.\n&quot;,
+               argv[0]);
+    return (1);
 }
 
-static void list_pkey(BIO *out)
+static int list_pkey(void)
 {
     int i;
+
     for (i = 0; i &lt; EVP_PKEY_asn1_get_count(); i++) {
         const EVP_PKEY_ASN1_METHOD *ameth;
         int pkey_id, pkey_base_id, pkey_flags;
@@ -601,21 +727,22 @@ static void list_pkey(BIO *out)
         EVP_PKEY_asn1_get0_info(&amp;pkey_id, &amp;pkey_base_id, &amp;pkey_flags,
                                 &amp;pinfo, &amp;pem_str, ameth);
         if (pkey_flags &amp; ASN1_PKEY_ALIAS) {
-            BIO_printf(out, &quot;Name: %s\n&quot;, OBJ_nid2ln(pkey_id));
-            BIO_printf(out, &quot;\tType: Alias to %s\n&quot;,
+            BIO_printf(bio_out, &quot;Name: %s\n&quot;, OBJ_nid2ln(pkey_id));
+            BIO_printf(bio_out, &quot;\tAlias for: %s\n&quot;,
                        OBJ_nid2ln(pkey_base_id));
         } else {
-            BIO_printf(out, &quot;Name: %s\n&quot;, pinfo);
-            BIO_printf(out, &quot;\tType: %s Algorithm\n&quot;,
+            BIO_printf(bio_out, &quot;Name: %s\n&quot;, pinfo);
+            BIO_printf(bio_out, &quot;\tType: %s Algorithm\n&quot;,
                        pkey_flags &amp; ASN1_PKEY_DYNAMIC ?
                        &quot;External&quot; : &quot;Builtin&quot;);
-            BIO_printf(out, &quot;\tOID: %s\n&quot;, OBJ_nid2ln(pkey_id));
+            BIO_printf(bio_out, &quot;\tOID: %s\n&quot;, OBJ_nid2ln(pkey_id));
             if (pem_str == NULL)
                 pem_str = &quot;(none)&quot;;
-            BIO_printf(out, &quot;\tPEM string: %s\n&quot;, pem_str);
+            BIO_printf(bio_out, &quot;\tPEM string: %s\n&quot;, pem_str);
         }
 
     }
+    return 0;
 }
 
 static void list_cipher_fn(const EVP_CIPHER *c,
@@ -632,9 +759,10 @@ static void list_cipher_fn(const EVP_CIPHER *c,
     }
 }
 
-static void list_cipher(BIO *out)
+static int list_cipher(void)
 {
-    EVP_CIPHER_do_all_sorted(list_cipher_fn, out);
+    EVP_CIPHER_do_all_sorted(list_cipher_fn, bio_out);
+    return 0;
 }
 
 static void list_md_fn(const EVP_MD *m,
@@ -647,13 +775,14 @@ static void list_md_fn(const EVP_MD *m,
             from = &quot;&lt;undefined&gt;&quot;;
         if (!to)
             to = &quot;&lt;undefined&gt;&quot;;
-        BIO_printf(arg, &quot;%s =&gt; %s\n&quot;, from, to);
+        BIO_printf((BIO *)arg, &quot;%s =&gt; %s\n&quot;, from, to);
     }
 }
 
-static void list_md(BIO *out)
+static int list_md(void)
 {
-    EVP_MD_do_all_sorted(list_md_fn, out);
+    EVP_MD_do_all_sorted(list_md_fn, bio_out);
+    return 0;
 }
 
 static int function_cmp(const FUNCTION * a, const FUNCTION * b)
@@ -670,13 +799,23 @@ static unsigned long function_hash(const FUNCTION * a)
 
 static IMPLEMENT_LHASH_HASH_FN(function, FUNCTION)
 
+static int SortFnByName(const void *_f1, const void *_f2)
+{
+    const FUNCTION *f1 = _f1;
+    const FUNCTION *f2 = _f2;
+
+    if (f1-&gt;type != f2-&gt;type)
+        return f1-&gt;type - f2-&gt;type;
+    return strcmp(f1-&gt;name, f2-&gt;name);
+}
+
 static LHASH_OF(FUNCTION) *prog_init(void)
 {
     LHASH_OF(FUNCTION) *ret;
     FUNCTION *f;
     size_t i;
 
-    /* Purely so it looks nice when the user hits ? */
+    /* Sort alphabetically within category. For nicer help displays. */
     for (i = 0, f = functions; f-&gt;name != NULL; ++f, ++i) ;
     qsort(functions, i, sizeof *functions, SortFnByName);
 
diff --git a/apps/opt.c b/apps/opt.c
new file mode 100644
index 0000000..3706739
--- /dev/null
+++ b/apps/opt.c
@@ -0,0 +1,915 @@
+/* ====================================================================
+ * Copyright (c) 2015 The OpenSSL Project.  All rights reserved.
+ *
+ * Redistribution and use in source and binary forms, with or without
+ * modification, are permitted provided that the following conditions
+ * are met:
+ *
+ * 1. Redistributions of source code must retain the above copyright
+ *    notice, this list of conditions and the following disclaimer.
+ *
+ * 2. Redistributions in binary form must reproduce the above copyright
+ *    notice, this list of conditions and the following disclaimer in
+ *    the documentation and/or other materials provided with the
+ *    distribution.
+ *
+ * 3. All advertising materials mentioning features or use of this
+ *    software must display the following acknowledgment:
+ *    &quot;This product includes software developed by the OpenSSL Project
+ *    for use in the OpenSSL Toolkit. (<A HREF="http://www.OpenSSL.org/">http://www.OpenSSL.org/</A>)&quot;
+ *
+ * 4. The names &quot;OpenSSL Toolkit&quot; and &quot;OpenSSL Project&quot; must not be used to
+ *    endorse or promote products derived from this software without
+ *    prior written permission. For written permission, please contact
+ *    <A HREF="../../../mailman/listinfo/openssl-commits.html">licensing at OpenSSL.org.</A>
+ *
+ * 5. Products derived from this software may not be called &quot;OpenSSL&quot;
+ *    nor may &quot;OpenSSL&quot; appear in their names without prior written
+ *    permission of the OpenSSL Project.
+ *
+ * 6. Redistributions of any form whatsoever must retain the following
+ *    acknowledgment:
+ *    &quot;This product includes software developed by the OpenSSL Project
+ *    for use in the OpenSSL Toolkit (<A HREF="http://www.OpenSSL.org/">http://www.OpenSSL.org/</A>)&quot;
+ *
+ * THIS SOFTWARE IS PROVIDED BY THE OpenSSL PROJECT ``AS IS'' AND ANY
+ * EXPRESSED OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
+ * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR
+ * PURPOSE ARE DISCLAIMED.  IN NO EVENT SHALL THE OpenSSL PROJECT OR
+ * ITS CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
+ * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT
+ * NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;
+ * LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)
+ * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT,
+ * STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)
+ * ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED
+ * OF THE POSSIBILITY OF SUCH DAMAGE.
+ * ====================================================================
+ */
+
+/* #define COMPILE_STANDALONE_TEST_DRIVER  */
+#include &quot;apps.h&quot;
+#include &lt;assert.h&gt;
+#include &lt;string.h&gt;
+#if !defined(OPENSSL_SYS_MSDOS)
+# include OPENSSL_UNISTD
+#endif
+#include &lt;unistd.h&gt;
+#include &lt;stdlib.h&gt;
+#include &lt;errno.h&gt;
+#include &lt;ctype.h&gt;
+#include &lt;openssl/bio.h&gt;
+
+#define MAX_OPT_HELP_WIDTH 30
+const char OPT_HELP_STR[] = &quot;--&quot;;
+const char OPT_MORE_STR[] = &quot;---&quot;;
+
+/* Our state */
+static char **argv;
+static int argc;
+static int opt_index;
+static char *arg;
+static char *flag;
+static char *dunno;
+static const OPTIONS *unknown;
+static const OPTIONS *opts;
+static char prog[40];
+
+/*
+ * Return the simple name of the program; removing various platform gunk.
+ */
+#if defined(OPENSSL_SYS_WIN32) || defined(OPENSSL_SYS_NETWARE)
+char *opt_progname(const char *argv0)
+{
+    int i;
+    int n;
+    const char *p;
+    char *q;
+
+    /* find the last '/', '\' or ':' */
+    for (p = argv0 + strlen(argv0); --p &gt; argv0;)
+        if (*p == '/' || *p == '\\' || *p == ':') {
+            p++;
+            break;
+        }
+
+    /* Strip off trailing nonsense. */
+    n = strlen(p);
+    if (n &gt; 4 &amp;&amp;
+        (strcmp(&amp;p[n - 4], &quot;.exe&quot;) == 0 || strcmp(&amp;p[n - 4], &quot;.EXE&quot;) == 0)
+        n -= 4;
+#if defined(OPENSSL_SYS_NETWARE)
+    if (n &gt; 4 &amp;&amp;
+        (strcmp(&amp;p[n - 4], &quot;.nlm&quot;) == 0 || strcmp(&amp;p[n - 4], &quot;.NLM&quot;) == 0)
+        n -= 4;
+#endif
+
+    /* Copy over the name, in lowercase. */
+    if (n &gt; sizeof prog - 1)
+        n = sizeof prog - 1;
+    for (q = prog, i = 0; i &lt; n; i++, p++)
+        q++ = isupper(*p) ? tolower(*p) : *p;
+    *q = '\0';
+    return prog;
+}
+
+#elif defined(OPENSSL_SYS_VMS)
+
+char *opt_progname(const char *argv0)
+{
+    const char *p, *q;
+
+    /* Find last special charcter sys:[foo.bar]openssl */
+    for (p = argv0 + strlen(argv0); --p &gt; argv0;)
+        if (*p == ':' || *p == ']' || *p == '&gt;') {
+            p++;
+            break;
+        }
+
+    q = strrchr(p, '.');
+    strncpy(prog, p, sizeof prog - 1);
+    prog[sizeof prog - 1] = '\0';
+    if (q == NULL || q - p &gt;= sizeof prog)
+        prog[q - p] = '\0';
+    return prog;
+}
+
+#else
+
+char *opt_progname(const char *argv0)
+{
+    const char *p;
+
+    /* Could use strchr, but this is like the ones above. */
+    for (p = argv0 + strlen(argv0); --p &gt; argv0;)
+        if (*p == '/') {
+            p++;
+            break;
+        }
+    strncpy(prog, p, sizeof prog - 1);
+    prog[sizeof prog - 1] = '\0';
+    return prog;
+}
+#endif
+
+char *opt_getprog(void)
+{
+    return prog;
+}
+
+/* Set up the arg parsing. */
+char *opt_init(int ac, char **av, const OPTIONS *o)
+{
+    /* Store state. */
+    argc = ac;
+    argv = av;
+    opt_index = 1;
+    opts = o;
+    opt_progname(av[0]);
+    unknown = NULL;
+
+    for (; o-&gt;name; ++o) {
+        const OPTIONS *next;
+#ifndef NDEBUG
+        int i;
+#endif
+
+        if (o-&gt;name == OPT_HELP_STR || o-&gt;name == OPT_MORE_STR)
+            continue;
+#ifndef NDEBUG
+        i = o-&gt;valtype;
+
+        /* Make sure options are legit. */
+        assert(o-&gt;name[0] != '-');
+        assert(o-&gt;retval &gt; 0);
+        assert(i == 0 || i == '-'
+               || i == 'n' || i == 'p' || i == 'u'
+               || i == 's' || i == '&lt;' || i == '&gt;' || i == '/'
+               || i == 'f' || i == 'F');
+
+        /* Make sure there are no duplicates. */
+        for (next = o; (++next)-&gt;name;) {
+            /*
+             * do allow aliases: assert(o-&gt;retval != next-&gt;retval);
+             */
+            assert(strcmp(o-&gt;name, next-&gt;name) != 0);
+        }
+#endif
+        if (o-&gt;name[0] == '\0') {
+            assert(unknown == NULL);
+            unknown = o;
+            assert(unknown-&gt;valtype == 0 || unknown-&gt;valtype == '-');
+        }
+    }
+    return prog;
+}
+
+static OPT_PAIR formats[] = {
+    {&quot;PEM/DER&quot;, OPT_FMT_PEMDER},
+    {&quot;pkcs12&quot;, OPT_FMT_PKCS12},
+    {&quot;smime&quot;, OPT_FMT_SMIME},
+    {&quot;engine&quot;, OPT_FMT_ENGINE},
+    {&quot;msblob&quot;, OPT_FMT_MSBLOB},
+    {&quot;netscape&quot;, OPT_FMT_NETSCAPE},
+    {&quot;nss&quot;, OPT_FMT_NSS},
+    {&quot;text&quot;, OPT_FMT_TEXT},
+    {&quot;http&quot;, OPT_FMT_HTTP},
+    {&quot;pvk&quot;, OPT_FMT_PVK},
+    {NULL}
+};
+
+/* Print an error message about a failed format parse. */
+int opt_format_error(const char *s, unsigned long flags)
+{
+    OPT_PAIR *ap;
+
+    if (flags == OPT_FMT_PEMDER)
+        BIO_printf(bio_err, &quot;%s: Bad format \&quot;%s\&quot;; must be pem or der\n&quot;,
+                   prog, s);
+    else {
+        BIO_printf(bio_err, &quot;%s: Bad format \&quot;%s\&quot;; must be one of:\n&quot;,
+                   prog, s);
+        for (ap = formats; ap-&gt;name; ap++)
+            if (flags &amp; ap-&gt;retval)
+                BIO_printf(bio_err, &quot;   %s\n&quot;, ap-&gt;name);
+    }
+    return 0;
+}
+
+/* Parse a format string, put it into *result; return 0 on failure, else 1. */
+int opt_format(const char *s, unsigned long flags, int *result)
+{
+    switch (*s) {
+    default:
+        return 0;
+    case 'D':
+    case 'd':
+        if ((flags &amp; OPT_FMT_PEMDER) == 0)
+            return opt_format_error(s, flags);
+        *result = FORMAT_ASN1;
+        break;
+    case 'T':
+    case 't':
+        if ((flags &amp; OPT_FMT_TEXT) == 0)
+            return opt_format_error(s, flags);
+        *result = FORMAT_TEXT;
+        break;
+    case 'N':
+    case 'n':
+        if (strcmp(s, &quot;NSS&quot;) == 0 || strcmp(s, &quot;nss&quot;) == 0) {
+            if ((flags &amp; OPT_FMT_NSS) == 0)
+                return opt_format_error(s, flags);
+            *result = FORMAT_NSS;
+        } else {
+            if ((flags &amp; OPT_FMT_NETSCAPE) == 0)
+                return opt_format_error(s, flags);
+            *result = FORMAT_NETSCAPE;
+        }
+        break;
+    case 'S':
+    case 's':
+        if ((flags &amp; OPT_FMT_SMIME) == 0)
+            return opt_format_error(s, flags);
+        *result = FORMAT_SMIME;
+        break;
+    case 'M':
+    case 'm':
+        if ((flags &amp; OPT_FMT_MSBLOB) == 0)
+            return opt_format_error(s, flags);
+        *result = FORMAT_MSBLOB;
+        break;
+    case 'E':
+    case 'e':
+        if ((flags &amp; OPT_FMT_ENGINE) == 0)
+            return opt_format_error(s, flags);
+        *result = FORMAT_ENGINE;
+        break;
+    case 'H':
+    case 'h':
+        if ((flags &amp; OPT_FMT_HTTP) == 0)
+            return opt_format_error(s, flags);
+        *result = FORMAT_HTTP;
+        break;
+    case '1':
+        if ((flags &amp; OPT_FMT_PKCS12) == 0)
+            return opt_format_error(s, flags);
+        *result = FORMAT_PKCS12;
+        break;
+    case 'P':
+    case 'p':
+        if (s[1] == '\0' || strcmp(s, &quot;PEM&quot;) == 0 || strcmp(s, &quot;pem&quot;) == 0) {
+            if ((flags &amp; OPT_FMT_PEMDER) == 0)
+                return opt_format_error(s, flags);
+            *result = FORMAT_PEM;
+        } else if (strcmp(s, &quot;PVK&quot;) == 0 || strcmp(s, &quot;pvk&quot;) == 0) {
+            if ((flags &amp; OPT_FMT_PVK) == 0)
+                return opt_format_error(s, flags);
+            *result = FORMAT_PVK;
+        } else if (strcmp(s, &quot;P12&quot;) == 0 || strcmp(s, &quot;p12&quot;) == 0
+                   || strcmp(s, &quot;PKCS12&quot;) == 0 || strcmp(s, &quot;pkcs12&quot;) == 0) {
+            if ((flags &amp; OPT_FMT_PKCS12) == 0)
+                return opt_format_error(s, flags);
+            *result = FORMAT_PKCS12;
+        } else
+            return 0;
+        break;
+    }
+    return 1;
+}
+
+/* Parse a cipher name, put it in *EVP_CIPHER; return 0 on failure, else 1. */
+int opt_cipher(const char *name, const EVP_CIPHER **cipherp)
+{
+    *cipherp = EVP_get_cipherbyname(name);
+    if (*cipherp)
+        return 1;
+    BIO_printf(bio_err, &quot;%s: Unknown cipher %s\n&quot;, prog, name);
+    return 0;
+}
+
+/*
+ * Parse message digest name, put it in *EVP_MD; return 0 on failure, else 1.
+ */
+int opt_md(const char *name, const EVP_MD **mdp)
+{
+    *mdp = EVP_get_digestbyname(name);
+    if (*mdp)
+        return 1;
+    BIO_printf(bio_err, &quot;%s: Unknown digest %s\n&quot;, prog, name);
+    return 0;
+}
+
+/* Look through a list of name/value pairs. */
+int opt_pair(const char *name, const OPT_PAIR* pairs, int *result)
+{
+    const OPT_PAIR *pp;
+
+    for (pp = pairs; pp-&gt;name; pp++)
+        if (strcmp(pp-&gt;name, name) == 0) {
+            *result = pp-&gt;retval;
+            return 1;
+        }
+    BIO_printf(bio_err, &quot;%s: Value must be one of:\n&quot;, prog);
+    for (pp = pairs; pp-&gt;name; pp++)
+        BIO_printf(bio_err, &quot;\t%s\n&quot;, pp-&gt;name);
+    return 0;
+}
+
+/* See if cp looks like a hex number, in case user left off the 0x */
+static int scanforhex(const char *cp)
+{
+    if (*cp == '0' &amp;&amp; (cp[1] == 'x' || cp[1] == 'X'))
+        return 16;
+    for (; *cp; cp++)
+        /* Look for a hex digit that isn't a regular digit. */
+        if (isxdigit(*cp) &amp;&amp; !isdigit(*cp))
+            return 16;
+    return 0;
+}
+
+/* Parse an int, put it into *result; return 0 on failure, else 1. */
+int opt_int(const char *value, int *result)
+{
+    const char *fmt = &quot;%d&quot;;
+    int base = scanforhex(value);
+
+    if (base == 16)
+        fmt = &quot;%x&quot;;
+    else if (*value == '0')
+        fmt = &quot;%o&quot;;
+    if (sscanf(value, fmt, result) != 1) {
+        BIO_printf(bio_err, &quot;%s: Can't parse \&quot;%s\&quot; as a number\n&quot;,
+                   prog, value);
+        return 0;
+    }
+    return 1;
+}
+
+/* Parse a long, put it into *result; return 0 on failure, else 1. */
+int opt_long(const char *value, long *result)
+{
+    char *endptr;
+    int base = scanforhex(value);
+
+    *result = strtol(value, &amp;endptr, base);
+    if (*endptr) {
+        BIO_printf(bio_err,
+                   &quot;%s: Bad char %c in number %s\n&quot;, prog, *endptr, value);
+        return 0;
+    }
+    return 1;
+}
+
+/*
+ * Parse an unsigned long, put it into *result; return 0 on failure, else 1.
+ */
+int opt_ulong(const char *value, unsigned long *result)
+{
+    char *endptr;
+    int base = scanforhex(value);
+
+    *result = strtoul(value, &amp;endptr, base);
+    if (*endptr) {
+        BIO_printf(bio_err,
+                   &quot;%s: Bad char %c in number %s\n&quot;, prog, *endptr, value);
+        return 0;
+    }
+    return 1;
+}
+
+/*
+ * We pass opt as an int but cast it to &quot;enum range&quot; so that all the
+ * items in the OPT_V_ENUM enumeration are caught; this makes -Wswitch
+ * in gcc do the right thing.
+ */
+enum range { OPT_V_ENUM };
+
+int opt_verify(int opt, X509_VERIFY_PARAM *vpm)
+{
+    unsigned long ul;
+    int i;
+    ASN1_OBJECT *otmp;
+    X509_PURPOSE *xptmp;
+    const X509_VERIFY_PARAM *vtmp;
+
+    assert(vpm != NULL);
+    assert(opt &gt; OPT_V__FIRST);
+    assert(opt &lt; OPT_V__LAST);
+
+    switch ((enum range)opt) {
+    case OPT_V__FIRST:
+    case OPT_V__LAST:
+        return 0;
+    case OPT_V_POLICY:
+        otmp = OBJ_txt2obj(opt_arg(), 0);
+        if (otmp == NULL) {
+            BIO_printf(bio_err, &quot;%s: Invalid Policy %s\n&quot;, prog, opt_arg());
+            return 0;
+        }
+        X509_VERIFY_PARAM_add0_policy(vpm, otmp);
+        break;
+    case OPT_V_PURPOSE:
+        i = X509_PURPOSE_get_by_sname(opt_arg());
+        if (i &lt; 0) {
+            BIO_printf(bio_err, &quot;%s: Invalid purpose %s\n&quot;, prog, opt_arg());
+            return 0;
+        }
+        xptmp = X509_PURPOSE_get0(i);
+        i = X509_PURPOSE_get_id(xptmp);
+        X509_VERIFY_PARAM_set_purpose(vpm, i);
+        break;
+    case OPT_V_VERIFY_NAME:
+        vtmp = X509_VERIFY_PARAM_lookup(opt_arg());
+        if (vtmp == NULL) {
+            BIO_printf(bio_err, &quot;%s: Invalid verify name %s\n&quot;,
+                       prog, opt_arg());
+            return 0;
+        }
+        X509_VERIFY_PARAM_set1(vpm, vtmp);
+        break;
+    case OPT_V_VERIFY_DEPTH:
+        i = atoi(opt_arg());
+        if (i &gt;= 0)
+            X509_VERIFY_PARAM_set_depth(vpm, i);
+        break;
+    case OPT_V_ATTIME:
+        opt_ulong(opt_arg(), &amp;ul);
+        if (ul)
+            X509_VERIFY_PARAM_set_time(vpm, (time_t)ul);
+        break;
+    case OPT_V_VERIFY_HOSTNAME:
+        if (!X509_VERIFY_PARAM_set1_host(vpm, opt_arg(), 0))
+            return 0;
+        break;
+    case OPT_V_VERIFY_EMAIL:
+        if (!X509_VERIFY_PARAM_set1_email(vpm, opt_arg(), 0))
+            return 0;
+        break;
+    case OPT_V_VERIFY_IP:
+        if (!X509_VERIFY_PARAM_set1_ip_asc(vpm, opt_arg()))
+            return 0;
+        break;
+    case OPT_V_IGNORE_CRITICAL:
+        X509_VERIFY_PARAM_set_flags(vpm, X509_V_FLAG_IGNORE_CRITICAL);
+        break;
+    case OPT_V_ISSUER_CHECKS:
+        X509_VERIFY_PARAM_set_flags(vpm, X509_V_FLAG_CB_ISSUER_CHECK);
+        break;
+    case OPT_V_CRL_CHECK:
+        X509_VERIFY_PARAM_set_flags(vpm, X509_V_FLAG_CRL_CHECK);
+        break;
+    case OPT_V_CRL_CHECK_ALL:
+        X509_VERIFY_PARAM_set_flags(vpm,
+                                    X509_V_FLAG_CRL_CHECK |
+                                    X509_V_FLAG_CRL_CHECK_ALL);
+        break;
+    case OPT_V_POLICY_CHECK:
+        X509_VERIFY_PARAM_set_flags(vpm, X509_V_FLAG_POLICY_CHECK);
+        break;
+    case OPT_V_EXPLICIT_POLICY:
+        X509_VERIFY_PARAM_set_flags(vpm, X509_V_FLAG_EXPLICIT_POLICY);
+        break;
+    case OPT_V_INHIBIT_ANY:
+        X509_VERIFY_PARAM_set_flags(vpm, X509_V_FLAG_INHIBIT_ANY);
+        break;
+    case OPT_V_INHIBIT_MAP:
+        X509_VERIFY_PARAM_set_flags(vpm, X509_V_FLAG_INHIBIT_MAP);
+        break;
+    case OPT_V_X509_STRICT:
+        X509_VERIFY_PARAM_set_flags(vpm, X509_V_FLAG_X509_STRICT);
+        break;
+    case OPT_V_EXTENDED_CRL:
+        X509_VERIFY_PARAM_set_flags(vpm, X509_V_FLAG_EXTENDED_CRL_SUPPORT);
+        break;
+    case OPT_V_USE_DELTAS:
+        X509_VERIFY_PARAM_set_flags(vpm, X509_V_FLAG_USE_DELTAS);
+        break;
+    case OPT_V_POLICY_PRINT:
+        X509_VERIFY_PARAM_set_flags(vpm, X509_V_FLAG_NOTIFY_POLICY);
+        break;
+    case OPT_V_CHECK_SS_SIG:
+        X509_VERIFY_PARAM_set_flags(vpm, X509_V_FLAG_CHECK_SS_SIGNATURE);
+        break;
+    case OPT_V_TRUSTED_FIRST:
+        X509_VERIFY_PARAM_set_flags(vpm, X509_V_FLAG_TRUSTED_FIRST);
+        break;
+    case OPT_V_SUITEB_128_ONLY:
+        X509_VERIFY_PARAM_set_flags(vpm, X509_V_FLAG_SUITEB_128_LOS_ONLY);
+        break;
+    case OPT_V_SUITEB_128:
+        X509_VERIFY_PARAM_set_flags(vpm, X509_V_FLAG_SUITEB_128_LOS);
+        break;
+    case OPT_V_SUITEB_192:
+        X509_VERIFY_PARAM_set_flags(vpm, X509_V_FLAG_SUITEB_192_LOS);
+        break;
+    case OPT_V_PARTIAL_CHAIN:
+        X509_VERIFY_PARAM_set_flags(vpm, X509_V_FLAG_PARTIAL_CHAIN);
+        break;
+    case OPT_V_NO_ALT_CHAINS:
+        X509_VERIFY_PARAM_set_flags(vpm, X509_V_FLAG_NO_ALT_CHAINS);
+    }
+    return 1;
+
+}
+
+/*
+ * Parse the next flag (and value if specified), return 0 if done, -1 on
+ * error, otherwise the flag's retval.
+ */
+int opt_next(void)
+{
+    char *p;
+    char *endptr;
+    const OPTIONS *o;
+    int dummy;
+    int base;
+    long val;
+
+    /* Look at current arg; at end of the list? */
+    arg = NULL;
+    p = argv[opt_index];
+    if (p == NULL)
+        return 0;
+
+    /* If word doesn't start with a -, we're done. */
+    if (*p != '-')
+        return 0;
+
+    /* Hit &quot;--&quot; ? We're done. */
+    opt_index++;
+    if (strcmp(p, &quot;--&quot;) == 0)
+        return 0;
+
+    /* Allow -nnn and --nnn */
+    if (*++p == '-')
+        p++;
+    flag = p - 1;
+
+    /* If we have --flag=foo, snip it off */
+    if ((arg = strchr(p, '=')) != NULL)
+        *arg++ = '\0';
+    for (o = opts; o-&gt;name; ++o) {
+        /* If not this option, move on to the next one. */
+        if (strcmp(p, o-&gt;name) != 0)
+            continue;
+
+        /* If it doesn't take a value, make sure none was given. */
+        if (o-&gt;valtype == 0 || o-&gt;valtype == '-') {
+            if (arg) {
+                BIO_printf(bio_err,
+                           &quot;%s: Option -%s does not take a value\n&quot;, prog, p);
+                return -1;
+            }
+            return o-&gt;retval;
+        }
+
+        /* Want a value; get the next param if =foo not used. */
+        if (arg == NULL) {
+            if (argv[opt_index] == NULL) {
+                BIO_printf(bio_err,
+                           &quot;%s: Option -%s needs a value\n&quot;, prog, o-&gt;name);
+                return -1;
+            }
+            arg = argv[opt_index++];
+        }
+
+        /* Syntax-check value. */
+        /*
+         * Do some basic syntax-checking on the value.  These tests aren't
+         * perfect (ignore range overflow) but they catch common failures.
+         */
+        switch (o-&gt;valtype) {
+        default:
+        case 's':
+            /* Just a string. */
+            break;
+        case '/':
+            if (app_isdir(arg) &gt;= 0)
+                break;
+            BIO_printf(bio_err, &quot;%s: Not a directory: %s\n&quot;, prog, arg);
+            return -1;
+        case '&lt;':
+            /* Input file. */
+            if (strcmp(arg, &quot;-&quot;) == 0 || app_access(arg, R_OK) &gt;= 0)
+                break;
+            BIO_printf(bio_err,
+                       &quot;%s: Cannot open input file %s, %s\n&quot;,
+                       prog, arg, strerror(errno));
+            return -1;
+        case '&gt;':
+            /* Output file. */
+            if (strcmp(arg, &quot;-&quot;) == 0 || app_access(arg, W_OK) &gt;= 0 || errno == ENOENT)
+                break;
+            BIO_printf(bio_err,
+                       &quot;%s: Cannot open output file %s, %s\n&quot;,
+                       prog, arg, strerror(errno));
+            return -1;
+        case 'p':
+        case 'n':
+            base = scanforhex(arg);
+            val = strtol(arg, &amp;endptr, base);
+            if (*endptr == '\0') {
+                if (o-&gt;valtype == 'p' &amp;&amp; val &lt;= 0) {
+                    BIO_printf(bio_err,
+                               &quot;%s: Non-positive number \&quot;%s\&quot; for -%s\n&quot;,
+                               prog, arg, o-&gt;name);
+                    return -1;
+                }
+                break;
+            }
+            BIO_printf(bio_err,
+                       &quot;%s: Invalid number \&quot;%s\&quot; for -%s\n&quot;,
+                       prog, arg, o-&gt;name);
+            return -1;
+        case 'u':
+            base = scanforhex(arg);
+            strtoul(arg, &amp;endptr, base);
+            if (*endptr == '\0')
+                break;
+            BIO_printf(bio_err,
+                       &quot;%s: Invalid number \&quot;%s\&quot; for -%s\n&quot;,
+                       prog, arg, o-&gt;name);
+            return -1;
+        case 'f':
+        case 'F':
+            if (opt_format(arg,
+                           o-&gt;valtype == 'F' ? OPT_FMT_PEMDER
+                           : OPT_FMT_ANY, &amp;dummy))
+                break;
+            BIO_printf(bio_err,
+                       &quot;%s: Invalid format \&quot;%s\&quot; for -%s\n&quot;,
+                       prog, arg, o-&gt;name);
+            return -1;
+        }
+
+        /* Return the flag value. */
+        return o-&gt;retval;
+    }
+    if (unknown != NULL) {
+        dunno = p;
+        return unknown-&gt;retval;
+    }
+    BIO_printf(bio_err, &quot;%s: Option unknown option -%s\n&quot;, prog, p);
+    return -1;
+}
+
+/* Return the most recent flag parameter. */
+char *opt_arg(void)
+{
+    return arg;
+}
+
+/* Return the most recent flag. */
+char *opt_flag(void)
+{
+    return flag;
+}
+
+/* Return the unknown option. */
+char *opt_unknown(void)
+{
+    return dunno;
+}
+
+/* Return the rest of the arguments after parsing flags. */
+char **opt_rest(void)
+{
+    return &amp;argv[opt_index];
+}
+
+/* How many items in remaining args? */
+int opt_num_rest(void)
+{
+    int i = 0;
+    char **pp;
+
+    for (pp = opt_rest(); *pp; pp++, i++)
+        continue;
+    return i;
+}
+
+/* Return a string describing the parameter type. */
+static const char *valtype2param(const OPTIONS *o)
+{
+    switch (o-&gt;valtype) {
+    case '-':
+        return &quot;&quot;;
+    case 's':
+        return &quot;val&quot;;
+    case '/':
+        return &quot;dir&quot;;
+    case '&lt;':
+        return &quot;infile&quot;;
+    case '&gt;':
+        return &quot;outfile&quot;;
+    case 'p':
+        return &quot;pnum&quot;;
+    case 'n':
+        return &quot;num&quot;;
+    case 'u':
+        return &quot;unum&quot;;
+    case 'F':
+        return &quot;der/pem&quot;;
+    case 'f':
+        return &quot;format&quot;;
+    }
+    return &quot;parm&quot;;
+}
+
+void opt_help(const OPTIONS *list)
+{
+    const OPTIONS *o;
+    int i;
+    int standard_prolog;
+    int width = 5;
+    char start[80 + 1];
+    char *p;
+    const char *help;
+
+    /* Starts with its own help message? */
+    standard_prolog = list[0].name != OPT_HELP_STR;
+
+    /* Find the widest help. */
+    for (o = list; o-&gt;name; o++) {
+        if (o-&gt;name == OPT_MORE_STR)
+            continue;
+        i = 2 + (int)strlen(o-&gt;name);
+        if (o-&gt;valtype != '-')
+            i += 1 + strlen(valtype2param(o));
+        if (i &lt; MAX_OPT_HELP_WIDTH &amp;&amp; i &gt; width)
+            width = i;
+        assert(i &lt; (int)sizeof start);
+    }
+
+    if (standard_prolog)
+        BIO_printf(bio_err, &quot;Usage: %s [options]\nValid options are:\n&quot;,
+                   prog);
+
+    /* Now let's print. */
+    for (o = list; o-&gt;name; o++) {
+        help = o-&gt;helpstr ? o-&gt;helpstr : &quot;(No additional info)&quot;;
+        if (o-&gt;name == OPT_HELP_STR) {
+            BIO_printf(bio_err, help, prog);
+            continue;
+        }
+
+        /* Pad out prefix */
+        memset(start, ' ', sizeof start - 1);
+        start[sizeof start - 1] = '\0';
+
+        if (o-&gt;name == OPT_MORE_STR) {
+            /* Continuation of previous line; padd and print. */
+            start[width] = '\0';
+            BIO_printf(bio_err, &quot;%s  %s\n&quot;, start, help);
+            continue;
+        }
+
+        /* Build up the &quot;-flag [param]&quot; part. */
+        p = start;
+        *p++ = ' ';
+        *p++ = '-';
+        if (o-&gt;name[0])
+            p += strlen(strcpy(p, o-&gt;name));
+        else
+            *p++ = '*';
+        if (o-&gt;valtype != '-') {
+            *p++ = ' ';
+            p += strlen(strcpy(p, valtype2param(o)));
+        }
+        *p = ' ';
+        if ((int)(p - start) &gt;= MAX_OPT_HELP_WIDTH) {
+            *p = '\0';
+            BIO_printf(bio_err, &quot;%s\n&quot;, start);
+            memset(start, ' ', sizeof start);
+        }
+        start[width] = '\0';
+        BIO_printf(bio_err, &quot;%s  %s\n&quot;, start, help);
+    }
+}
+
+#ifdef COMPILE_STANDALONE_TEST_DRIVER
+# include &lt;sys/stat.h&gt;
+
+typedef enum OPTION_choice {
+    OPT_ERR = -1, OPT_EOF = 0, OPT_HELP,
+    OPT_IN, OPT_INFORM, OPT_OUT, OPT_COUNT, OPT_U, OPT_FLAG,
+    OPT_STR, OPT_NOTUSED
+} OPTION_CHOICE;
+
+static OPTIONS options[] = {
+    {OPT_HELP_STR, 1, '-', &quot;Usage: %s flags\n&quot;},
+    {OPT_HELP_STR, 1, '-', &quot;Valid options are:\n&quot;},
+    {&quot;help&quot;, OPT_HELP, '-', &quot;Display this summary&quot;},
+    {&quot;in&quot;, OPT_IN, '&lt;', &quot;input file&quot;},
+    {OPT_MORE_STR, 1, '-', &quot;more detail about input&quot;},
+    {&quot;inform&quot;, OPT_INFORM, 'f', &quot;input file format; defaults to pem&quot;},
+    {&quot;out&quot;, OPT_OUT, '&gt;', &quot;output file&quot;},
+    {&quot;count&quot;, OPT_COUNT, 'p', &quot;a counter greater than zero&quot;},
+    {&quot;u&quot;, OPT_U, 'u', &quot;an unsigned number&quot;},
+    {&quot;flag&quot;, OPT_FLAG, 0, &quot;just some flag&quot;},
+    {&quot;str&quot;, OPT_STR, 's', &quot;the magic word&quot;},
+    {&quot;areallyverylongoption&quot;, OPT_HELP, '-', &quot;long way for help&quot;},
+    {NULL}
+};
+
+BIO *bio_err;
+
+int app_isdir(const char *name)
+{
+    struct stat sb;
+
+    return name != NULL &amp;&amp; stat(name, &amp;sb) &gt;= 0 &amp;&amp; S_ISDIR(sb.st_mode);
+}
+
+int main(int ac, char **av)
+{
+    OPTION_CHOICE o;
+    char **rest;
+    char *prog;
+
+    bio_err = BIO_new_fp(stderr, BIO_NOCLOSE | BIO_FP_TEXT);
+
+    prog = opt_init(ac, av, options);
+    while ((o = opt_next()) != OPT_EOF) {
+        switch (c) {
+        case OPT_NOTUSED:
+        case OPT_EOF:
+        case OPT_ERR:
+            printf(&quot;%s: Usage error; try -help.\n&quot;, prog);
+            return 1;
+        case OPT_HELP:
+            opt_help(options);
+            return 0;
+        case OPT_IN:
+            printf(&quot;in %s\n&quot;, opt_arg());
+            break;
+        case OPT_INFORM:
+            printf(&quot;inform %s\n&quot;, opt_arg());
+            break;
+        case OPT_OUT:
+            printf(&quot;out %s\n&quot;, opt_arg());
+            break;
+        case OPT_COUNT:
+            printf(&quot;count %s\n&quot;, opt_arg());
+            break;
+        case OPT_U:
+            printf(&quot;u %s\n&quot;, opt_arg());
+            break;
+        case OPT_FLAG:
+            printf(&quot;flag\n&quot;);
+            break;
+        case OPT_STR:
+            printf(&quot;str %s\n&quot;, opt_arg());
+            break;
+        }
+    }
+    argc = opt_num_rest();
+    argv = opt_rest();
+
+    printf(&quot;args = %d\n&quot;, argc);
+    if (argc)
+        while (*argv)
+            printf(&quot;  %s\n&quot;, *argv++);
+    return 0;
+}
+#endif
diff --git a/apps/passwd.c b/apps/passwd.c
index 2814b32..3c6fd52 100644
--- a/apps/passwd.c
+++ b/apps/passwd.c
@@ -1,4 +1,51 @@
-/* apps/passwd.c */
+/* ====================================================================
+ * Copyright (c) 2000-2015 The OpenSSL Project.  All rights reserved.
+ *
+ * Redistribution and use in source and binary forms, with or without
+ * modification, are permitted provided that the following conditions
+ * are met:
+ *
+ * 1. Redistributions of source code must retain the above copyright
+ *    notice, this list of conditions and the following disclaimer.
+ *
+ * 2. Redistributions in binary form must reproduce the above copyright
+ *    notice, this list of conditions and the following disclaimer in
+ *    the documentation and/or other materials provided with the
+ *    distribution.
+ *
+ * 3. All advertising materials mentioning features or use of this
+ *    software must display the following acknowledgment:
+ *    &quot;This product includes software developed by the OpenSSL Project
+ *    for use in the OpenSSL Toolkit. (<A HREF="http://www.OpenSSL.org/">http://www.OpenSSL.org/</A>)&quot;
+ *
+ * 4. The names &quot;OpenSSL Toolkit&quot; and &quot;OpenSSL Project&quot; must not be used to
+ *    endorse or promote products derived from this software without
+ *    prior written permission. For written permission, please contact
+ *    <A HREF="../../../mailman/listinfo/openssl-commits.html">licensing at OpenSSL.org.</A>
+ *
+ * 5. Products derived from this software may not be called &quot;OpenSSL&quot;
+ *    nor may &quot;OpenSSL&quot; appear in their names without prior written
+ *    permission of the OpenSSL Project.
+ *
+ * 6. Redistributions of any form whatsoever must retain the following
+ *    acknowledgment:
+ *    &quot;This product includes software developed by the OpenSSL Project
+ *    for use in the OpenSSL Toolkit (<A HREF="http://www.OpenSSL.org/">http://www.OpenSSL.org/</A>)&quot;
+ *
+ * THIS SOFTWARE IS PROVIDED BY THE OpenSSL PROJECT ``AS IS'' AND ANY
+ * EXPRESSED OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
+ * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR
+ * PURPOSE ARE DISCLAIMED.  IN NO EVENT SHALL THE OpenSSL PROJECT OR
+ * ITS CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
+ * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT
+ * NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;
+ * LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)
+ * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT,
+ * STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)
+ * ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED
+ * OF THE POSSIBILITY OF SUCH DAMAGE.
+ * ====================================================================
+ */
 
 #if defined OPENSSL_NO_MD5 || defined CHARSET_EBCDIC
 # define NO_MD5CRYPT_1
@@ -22,9 +69,6 @@
 #  include &lt;openssl/md5.h&gt;
 # endif
 
-# undef PROG
-# define PROG passwd_main
-
 static unsigned const char cov_2char[64] = {
     /* from crypto/des/fcrypt.c */
     0x2E, 0x2F, 0x30, 0x31, 0x32, 0x33, 0x34, 0x35,
@@ -42,156 +86,130 @@ static int do_passwd(int passed_salt, char **salt_p, char **salt_malloc_p,
                      int reverse, size_t pw_maxlen, int usecrypt, int use1,
                      int useapr1);
 
-/*-
- * -crypt        - standard Unix password algorithm (default)
- * -1            - MD5-based password algorithm
- * -apr1         - MD5-based password algorithm, Apache variant
- * -salt string  - salt
- * -in file      - read passwords from file
- * -stdin        - read passwords from stdin
- * -noverify     - never verify when reading password from terminal
- * -quiet        - no warnings
- * -table        - format output as table
- * -reverse      - switch table columns
- */
-
-int MAIN(int, char **);
+typedef enum OPTION_choice {
+    OPT_ERR = -1, OPT_EOF = 0, OPT_HELP,
+    OPT_IN,
+    OPT_NOVERIFY, OPT_QUIET, OPT_TABLE, OPT_REVERSE, OPT_APR1,
+    OPT_1, OPT_CRYPT, OPT_SALT, OPT_STDIN
+} OPTION_CHOICE;
+
+OPTIONS passwd_options[] = {
+    {&quot;help&quot;, OPT_HELP, '-', &quot;Display this summary&quot;},
+    {&quot;in&quot;, OPT_IN, '&lt;', &quot;Pead passwords from file&quot;},
+    {&quot;noverify&quot;, OPT_NOVERIFY, '-',
+     &quot;Never verify when reading password from terminal&quot;},
+    {&quot;quiet&quot;, OPT_QUIET, '-', &quot;No warnings&quot;},
+    {&quot;table&quot;, OPT_TABLE, '-', &quot;Format output as table&quot;},
+    {&quot;reverse&quot;, OPT_REVERSE, '-', &quot;Switch table columns&quot;},
+# ifndef NO_MD5CRYPT_1
+    {&quot;apr1&quot;, OPT_APR1, '-', &quot;MD5-based password algorithm, Apache variant&quot;},
+    {&quot;1&quot;, OPT_1, '-', &quot;MD5-based password algorithm&quot;},
+# endif
+# ifndef OPENSSL_NO_DES
+    {&quot;crypt&quot;, OPT_CRYPT, '-', &quot;Standard Unix password algorithm (default)&quot;},
+# endif
+    {&quot;salt&quot;, OPT_SALT, 's', &quot;Use provided salt&quot;},
+    {&quot;stdin&quot;, OPT_STDIN, '-', &quot;Read passwords from stdin&quot;},
+    {NULL}
+};
 
-int MAIN(int argc, char **argv)
+int passwd_main(int argc, char **argv)
 {
-    int ret = 1;
-    char *infile = NULL;
-    int in_stdin = 0;
-    int in_noverify = 0;
-    char *salt = NULL, *passwd = NULL, **passwds = NULL;
-    char *salt_malloc = NULL, *passwd_malloc = NULL;
-    size_t passwd_malloc_size = 0;
-    int pw_source_defined = 0;
-    BIO *in = NULL, *out = NULL;
-    int i, badopt, opt_done;
+    BIO *in = NULL;
+    char *infile = NULL, *salt = NULL, *passwd = NULL, **passwds = NULL;
+    char *salt_malloc = NULL, *passwd_malloc = NULL, *prog;
+    OPTION_CHOICE o;
+    int in_stdin = 0, in_noverify = 0, pw_source_defined = 0;
     int passed_salt = 0, quiet = 0, table = 0, reverse = 0;
-    int usecrypt = 0, use1 = 0, useapr1 = 0;
-    size_t pw_maxlen = 0;
-
-    apps_startup();
-
-    if (bio_err == NULL)
-        if ((bio_err = BIO_new(BIO_s_file())) != NULL)
-            BIO_set_fp(bio_err, stderr, BIO_NOCLOSE | BIO_FP_TEXT);
-
-    if (!load_config(bio_err, NULL))
-        goto err;
-    out = BIO_new(BIO_s_file());
-    if (out == NULL)
-        goto err;
-    BIO_set_fp(out, stdout, BIO_NOCLOSE | BIO_FP_TEXT);
-# ifdef OPENSSL_SYS_VMS
-    {
-        BIO *tmpbio = BIO_new(BIO_f_linebuffer());
-        out = BIO_push(tmpbio, out);
-    }
-# endif
-
-    badopt = 0, opt_done = 0;
-    i = 0;
-    while (!badopt &amp;&amp; !opt_done &amp;&amp; argv[++i] != NULL) {
-        if (strcmp(argv[i], &quot;-crypt&quot;) == 0)
-            usecrypt = 1;
-        else if (strcmp(argv[i], &quot;-1&quot;) == 0)
-            use1 = 1;
-        else if (strcmp(argv[i], &quot;-apr1&quot;) == 0)
-            useapr1 = 1;
-        else if (strcmp(argv[i], &quot;-salt&quot;) == 0) {
-            if ((argv[i + 1] != NULL) &amp;&amp; (salt == NULL)) {
-                passed_salt = 1;
-                salt = argv[++i];
-            } else
-                badopt = 1;
-        } else if (strcmp(argv[i], &quot;-in&quot;) == 0) {
-            if ((argv[i + 1] != NULL) &amp;&amp; !pw_source_defined) {
-                pw_source_defined = 1;
-                infile = argv[++i];
-            } else
-                badopt = 1;
-        } else if (strcmp(argv[i], &quot;-stdin&quot;) == 0) {
-            if (!pw_source_defined) {
-                pw_source_defined = 1;
-                in_stdin = 1;
-            } else
-                badopt = 1;
-        } else if (strcmp(argv[i], &quot;-noverify&quot;) == 0)
+    int ret = 1, usecrypt = 0, use1 = 0, useapr1 = 0;
+    size_t passwd_malloc_size = 0, pw_maxlen = 256;
+
+    prog = opt_init(argc, argv, passwd_options);
+    while ((o = opt_next()) != OPT_EOF) {
+        switch (o) {
+        case OPT_EOF:
+        case OPT_ERR:
+ opthelp:
+            BIO_printf(bio_err, &quot;%s: Use -help for summary.\n&quot;, prog);
+            goto end;
+        case OPT_HELP:
+            opt_help(passwd_options);
+            ret = 0;
+            goto end;
+        case OPT_IN:
+            if (pw_source_defined)
+                goto opthelp;
+            infile = opt_arg();
+            pw_source_defined = 1;
+            break;
+        case OPT_NOVERIFY:
             in_noverify = 1;
-        else if (strcmp(argv[i], &quot;-quiet&quot;) == 0)
+            break;
+        case OPT_QUIET:
             quiet = 1;
-        else if (strcmp(argv[i], &quot;-table&quot;) == 0)
+            break;
+        case OPT_TABLE:
             table = 1;
-        else if (strcmp(argv[i], &quot;-reverse&quot;) == 0)
+            break;
+        case OPT_REVERSE:
             reverse = 1;
-        else if (argv[i][0] == '-')
-            badopt = 1;
-        else if (!pw_source_defined)
-            /* non-option arguments, use as passwords */
-        {
-            pw_source_defined = 1;
-            passwds = &amp;argv[i];
-            opt_done = 1;
-        } else
-            badopt = 1;
+            break;
+        case OPT_1:
+            use1 = 1;
+            break;
+        case OPT_APR1:
+            useapr1 = 1;
+            break;
+        case OPT_CRYPT:
+            usecrypt = 1;
+            break;
+        case OPT_SALT:
+            passed_salt = 1;
+            salt = opt_arg();
+            break;
+        case OPT_STDIN:
+            if (pw_source_defined)
+                goto opthelp;
+            in_stdin = 1;
+            break;
+        }
+    }
+    argc = opt_num_rest();
+    argv = opt_rest();
+
+    if (*argv) {
+        if (pw_source_defined)
+            goto opthelp;
+        pw_source_defined = 1;
+        passwds = argv;
     }
 
-    if (!usecrypt &amp;&amp; !use1 &amp;&amp; !useapr1) /* use default */
+    if (!usecrypt &amp;&amp; !use1 &amp;&amp; !useapr1) {
+        /* use default */
         usecrypt = 1;
-    if (usecrypt + use1 + useapr1 &gt; 1) /* conflict */
-        badopt = 1;
+    }
+    if (usecrypt + use1 + useapr1 &gt; 1) {
+        /* conflict */
+        goto opthelp;
+    }
 
-    /* reject unsupported algorithms */
 # ifdef OPENSSL_NO_DES
     if (usecrypt)
-        badopt = 1;
+        goto opthelp;
 # endif
 # ifdef NO_MD5CRYPT_1
     if (use1 || useapr1)
-        badopt = 1;
+        goto opthelp;
 # endif
 
-    if (badopt) {
-        BIO_printf(bio_err, &quot;Usage: passwd [options] [passwords]\n&quot;);
-        BIO_printf(bio_err, &quot;where options are\n&quot;);
-# ifndef OPENSSL_NO_DES
-        BIO_printf(bio_err,
-                   &quot;-crypt             standard Unix password algorithm (default)\n&quot;);
-# endif
-# ifndef NO_MD5CRYPT_1
-        BIO_printf(bio_err,
-                   &quot;-1                 MD5-based password algorithm\n&quot;);
-        BIO_printf(bio_err,
-                   &quot;-apr1              MD5-based password algorithm, Apache variant\n&quot;);
-# endif
-        BIO_printf(bio_err, &quot;-salt string       use provided salt\n&quot;);
-        BIO_printf(bio_err, &quot;-in file           read passwords from file\n&quot;);
-        BIO_printf(bio_err, &quot;-stdin             read passwords from stdin\n&quot;);
-        BIO_printf(bio_err,
-                   &quot;-noverify          never verify when reading password from terminal\n&quot;);
-        BIO_printf(bio_err, &quot;-quiet             no warnings\n&quot;);
-        BIO_printf(bio_err, &quot;-table             format output as table\n&quot;);
-        BIO_printf(bio_err, &quot;-reverse           switch table columns\n&quot;);
-
-        goto err;
+    if (infile &amp;&amp; in_stdin) {
+        BIO_printf(bio_err, &quot;%s: Can't combine -in and -stdin\n&quot;, prog);
+        goto end;
     }
 
-    if ((infile != NULL) || in_stdin) {
-        in = BIO_new(BIO_s_file());
-        if (in == NULL)
-            goto err;
-        if (infile != NULL) {
-            assert(in_stdin == 0);
-            if (BIO_read_filename(in, infile) &lt;= 0)
-                goto err;
-        } else {
-            assert(in_stdin);
-            BIO_set_fp(in, stdin, BIO_NOCLOSE);
-        }
-    }
+    in = bio_open_default(infile, &quot;r&quot;);
+    if (in == NULL)
+        goto end;
 
     if (usecrypt)
         pw_maxlen = 8;
@@ -208,7 +226,7 @@ int MAIN(int argc, char **argv)
          */
         passwd = passwd_malloc = OPENSSL_malloc(passwd_malloc_size);
         if (passwd_malloc == NULL)
-            goto err;
+            goto end;
     }
 
     if ((in == NULL) &amp;&amp; (passwds == NULL)) {
@@ -220,7 +238,7 @@ int MAIN(int argc, char **argv)
             if (EVP_read_pw_string
                 (passwd_malloc, passwd_malloc_size, &quot;Password: &quot;,
                  !(passed_salt || in_noverify)) != 0)
-                goto err;
+                goto end;
         passwds[0] = passwd_malloc;
     }
 
@@ -230,10 +248,10 @@ int MAIN(int argc, char **argv)
 
         do {                    /* loop over list of passwords */
             passwd = *passwds++;
-            if (!do_passwd(passed_salt, &amp;salt, &amp;salt_malloc, passwd, out,
+            if (!do_passwd(passed_salt, &amp;salt, &amp;salt_malloc, passwd, bio_out,
                            quiet, table, reverse, pw_maxlen, usecrypt, use1,
                            useapr1))
-                goto err;
+                goto end;
         }
         while (*passwds != NULL);
     } else
@@ -256,10 +274,10 @@ int MAIN(int argc, char **argv)
                     while ((r &gt; 0) &amp;&amp; (!strchr(trash, '\n')));
                 }
 
-                if (!do_passwd(passed_salt, &amp;salt, &amp;salt_malloc, passwd, out,
-                               quiet, table, reverse, pw_maxlen, usecrypt,
-                               use1, useapr1))
-                    goto err;
+                if (!do_passwd
+                    (passed_salt, &amp;salt, &amp;salt_malloc, passwd, bio_out, quiet,
+                     table, reverse, pw_maxlen, usecrypt, use1, useapr1))
+                    goto end;
             }
             done = (r &lt;= 0);
         }
@@ -267,16 +285,14 @@ int MAIN(int argc, char **argv)
     }
     ret = 0;
 
- err:
+ end:
     ERR_print_errors(bio_err);
     if (salt_malloc)
         OPENSSL_free(salt_malloc);
     if (passwd_malloc)
         OPENSSL_free(passwd_malloc);
     BIO_free(in);
-    BIO_free_all(out);
-    apps_shutdown();
-    OPENSSL_EXIT(ret);
+    return (ret);
 }
 
 # ifndef NO_MD5CRYPT_1
@@ -412,10 +428,10 @@ static int do_passwd(int passed_salt, char **salt_p, char **salt_malloc_p,
             if (*salt_malloc_p == NULL) {
                 *salt_p = *salt_malloc_p = OPENSSL_malloc(3);
                 if (*salt_malloc_p == NULL)
-                    goto err;
+                    goto end;
             }
             if (RAND_bytes((unsigned char *)*salt_p, 2) &lt;= 0)
-                goto err;
+                goto end;
             (*salt_p)[0] = cov_2char[(*salt_p)[0] &amp; 0x3f]; /* 6 bits */
             (*salt_p)[1] = cov_2char[(*salt_p)[1] &amp; 0x3f]; /* 6 bits */
             (*salt_p)[2] = 0;
@@ -433,10 +449,10 @@ static int do_passwd(int passed_salt, char **salt_p, char **salt_malloc_p,
             if (*salt_malloc_p == NULL) {
                 *salt_p = *salt_malloc_p = OPENSSL_malloc(9);
                 if (*salt_malloc_p == NULL)
-                    goto err;
+                    goto end;
             }
             if (RAND_bytes((unsigned char *)*salt_p, 8) &lt;= 0)
-                goto err;
+                goto end;
 
             for (i = 0; i &lt; 8; i++)
                 (*salt_p)[i] = cov_2char[(*salt_p)[i] &amp; 0x3f]; /* 6 bits */
@@ -477,16 +493,16 @@ static int do_passwd(int passed_salt, char **salt_p, char **salt_malloc_p,
         BIO_printf(out, &quot;%s\t%s\n&quot;, hash, passwd);
     else
         BIO_printf(out, &quot;%s\n&quot;, hash);
-    return 1;
-
- err:
     return 0;
+
+ end:
+    return 1;
 }
 #else
 
-int MAIN(int argc, char **argv)
+int passwd_main(int argc, char **argv)
 {
     fputs(&quot;Program not available.\n&quot;, stderr)
-        OPENSSL_EXIT(1);
+        return (1);
 }
 #endif
diff --git a/apps/pkcs12.c b/apps/pkcs12.c
index 43892e5..a031c1b 100644
--- a/apps/pkcs12.c
+++ b/apps/pkcs12.c
@@ -1,4 +1,3 @@
-/* pkcs12.c */
 /*
  * Written by Dr Stephen N Henson (<A HREF="../../../mailman/listinfo/openssl-commits.html">steve at openssl.org</A>) for the OpenSSL
  * project.
@@ -69,10 +68,6 @@
 # include &lt;openssl/pem.h&gt;
 # include &lt;openssl/pkcs12.h&gt;
 
-# define PROG pkcs12_main
-
-const EVP_CIPHER *enc;
-
 # define NOKEYS          0x1
 # define NOCERTS         0x2
 # define INFO            0x4
@@ -81,335 +76,257 @@ const EVP_CIPHER *enc;
 
 int get_cert_chain(X509 *cert, X509_STORE *store, STACK_OF(X509) **chain);
 int dump_certs_keys_p12(BIO *out, PKCS12 *p12, char *pass, int passlen,
-                        int options, char *pempass);
+                        int options, char *pempass, const EVP_CIPHER *enc);
 int dump_certs_pkeys_bags(BIO *out, STACK_OF(PKCS12_SAFEBAG) *bags,
-                          char *pass, int passlen, int options,
-                          char *pempass);
+                          char *pass, int passlen, int options, char *pempass,
+                          const EVP_CIPHER *enc);
 int dump_certs_pkeys_bag(BIO *out, PKCS12_SAFEBAG *bags, char *pass,
-                         int passlen, int options, char *pempass);
+                         int passlen, int options, char *pempass,
+                         const EVP_CIPHER *enc);
 int print_attribs(BIO *out, STACK_OF(X509_ATTRIBUTE) *attrlst,
                   const char *name);
 void hex_prin(BIO *out, unsigned char *buf, int len);
 int alg_print(BIO *x, X509_ALGOR *alg);
 int cert_load(BIO *in, STACK_OF(X509) *sk);
-static int set_pbe(BIO *err, int *ppbe, const char *str);
-
-int MAIN(int, char **);
+static int set_pbe(int *ppbe, const char *str);
+
+typedef enum OPTION_choice {
+    OPT_ERR = -1, OPT_EOF = 0, OPT_HELP,
+    OPT_CIPHER, OPT_NOKEYS, OPT_KEYEX, OPT_KEYSIG, OPT_NOCERTS, OPT_CLCERTS,
+    OPT_CACERTS, OPT_NOOUT, OPT_INFO, OPT_CHAIN, OPT_TWOPASS, OPT_NOMACVER,
+    OPT_DESCERT, OPT_EXPORT, OPT_NOITER, OPT_MACITER, OPT_NOMACITER,
+    OPT_NOMAC, OPT_LMK, OPT_NODES, OPT_MACALG, OPT_CERTPBE, OPT_KEYPBE,
+    OPT_RAND, OPT_INKEY, OPT_CERTFILE, OPT_NAME, OPT_CSP, OPT_CANAME,
+    OPT_IN, OPT_OUT, OPT_PASSIN, OPT_PASSOUT, OPT_PASSWORD, OPT_CAPATH,
+    OPT_CAFILE, OPT_ENGINE
+} OPTION_CHOICE;
+
+OPTIONS pkcs12_options[] = {
+    {&quot;help&quot;, OPT_HELP, '-', &quot;Display this summary&quot;},
+    {&quot;nokeys&quot;, OPT_NOKEYS, '-', &quot;Don't output private keys&quot;},
+    {&quot;keyex&quot;, OPT_KEYEX, '-', &quot;Set MS key exchange type&quot;},
+    {&quot;keysig&quot;, OPT_KEYSIG, '-', &quot;Set MS key signature type&quot;},
+    {&quot;nocerts&quot;, OPT_NOCERTS, '-', &quot;Don't output certificates&quot;},
+    {&quot;clcerts&quot;, OPT_CLCERTS, '-', &quot;Only output client certificates&quot;},
+    {&quot;cacerts&quot;, OPT_CACERTS, '-', &quot;Only output CA certificates&quot;},
+    {&quot;noout&quot;, OPT_NOOUT, '-', &quot;Don't output anything, just verify&quot;},
+    {&quot;info&quot;, OPT_INFO, '-', &quot;Print info about PKCS#12 structure&quot;},
+    {&quot;chain&quot;, OPT_CHAIN, '-', &quot;Add certificate chain&quot;},
+    {&quot;twopass&quot;, OPT_TWOPASS, '-', &quot;Separate MAC, encryption passwords&quot;},
+    {&quot;nomacver&quot;, OPT_NOMACVER, '-', &quot;Don't verify MAC&quot;},
+# ifndef OPENSSL_NO_RC2
+    {&quot;descert&quot;, OPT_DESCERT, '-',
+     &quot;Encrypt output with 3DES (default RC2-40)&quot;},
+    {&quot;certpbe&quot;, OPT_CERTPBE, 's',
+     &quot;Certificate PBE algorithm (default RC2-40)&quot;},
+# else
+    {&quot;descert&quot;, OPT_DESCERT, '-', &quot;Encrypt output with 3DES (the default)&quot;},
+    {&quot;certpbe&quot;, OPT_CERTPBE, 's', &quot;Certificate PBE algorithm (default 3DES)&quot;},
+# endif
+    {&quot;export&quot;, OPT_EXPORT, '-', &quot;Output PKCS12 file&quot;},
+    {&quot;noiter&quot;, OPT_NOITER, '-', &quot;Don't use encryption iteration&quot;},
+    {&quot;maciter&quot;, OPT_MACITER, '-', &quot;Use MAC iteration&quot;},
+    {&quot;nomaciter&quot;, OPT_NOMACITER, '-', &quot;Don't use MAC iteration&quot;},
+    {&quot;nomac&quot;, OPT_NOMAC, '-', &quot;Don't generate MAC&quot;},
+    {&quot;LMK&quot;, OPT_LMK, '-',
+     &quot;Add local machine keyset attribute to private key&quot;},
+    {&quot;nodes&quot;, OPT_NODES, '-', &quot;Don't encrypt private keys&quot;},
+    {&quot;macalg&quot;, OPT_MACALG, 's',
+     &quot;Digest algorithm used in MAC (default SHA1)&quot;},
+    {&quot;keypbe&quot;, OPT_KEYPBE, 's', &quot;Private key PBE algorithm (default 3DES)&quot;},
+    {&quot;rand&quot;, OPT_RAND, 's',
+     &quot;Load the file(s) into the random number generator&quot;},
+    {&quot;inkey&quot;, OPT_INKEY, '&lt;', &quot;Private key if not infile&quot;},
+    {&quot;certfile&quot;, OPT_CERTFILE, '&lt;', &quot;Load certs from file&quot;},
+    {&quot;name&quot;, OPT_NAME, 's', &quot;Use name as friendly name&quot;},
+    {&quot;CSP&quot;, OPT_CSP, 's', &quot;Microsoft CSP name&quot;},
+    {&quot;caname&quot;, OPT_CANAME, 's',
+     &quot;Use name as CA friendly name (can be repeated)&quot;},
+    {&quot;in&quot;, OPT_IN, '&lt;', &quot;Input filename&quot;},
+    {&quot;out&quot;, OPT_OUT, '&gt;', &quot;Output filename&quot;},
+    {&quot;passin&quot;, OPT_PASSIN, 's', &quot;Input file pass phrase source&quot;},
+    {&quot;passout&quot;, OPT_PASSOUT, 's', &quot;Output file pass phrase source&quot;},
+    {&quot;password&quot;, OPT_PASSWORD, 's', &quot;Set import/export password source&quot;},
+    {&quot;CApath&quot;, OPT_CAPATH, '/', &quot;PEM-format directory of CA's&quot;},
+    {&quot;CAfile&quot;, OPT_CAFILE, '&lt;', &quot;PEM-format file of CA's&quot;},
+# ifndef OPENSSL_NO_ENGINE
+    {&quot;engine&quot;, OPT_ENGINE, 's', &quot;Use engine, possibly a hardware device&quot;},
+# endif
+    {&quot;&quot;, OPT_CIPHER, '-', &quot;Any supported cipher&quot;},
+    {NULL}
+};
 
-int MAIN(int argc, char **argv)
+int pkcs12_main(int argc, char **argv)
 {
-    ENGINE *e = NULL;
-    char *infile = NULL, *outfile = NULL, *keyname = NULL;
-    char *certfile = NULL;
-    BIO *in = NULL, *out = NULL;
-    char **args;
-    char *name = NULL;
-    char *csp_name = NULL;
-    int add_lmk = 0;
-    PKCS12 *p12 = NULL;
+    char *infile = NULL, *outfile = NULL, *keyname = NULL, *certfile = NULL;
+    char *name = NULL, *csp_name = NULL;
     char pass[50], macpass[50];
-    int export_cert = 0;
-    int options = 0;
-    int chain = 0;
-    int badarg = 0;
-    int iter = PKCS12_DEFAULT_ITER;
-    int maciter = PKCS12_DEFAULT_ITER;
-    int twopass = 0;
-    int keytype = 0;
+    int export_cert = 0, options = 0, chain = 0, twopass = 0, keytype = 0;
+    int iter = PKCS12_DEFAULT_ITER, maciter = PKCS12_DEFAULT_ITER;
+# ifndef OPENSSL_NO_RC2
     int cert_pbe = NID_pbe_WithSHA1And40BitRC2_CBC;
+# else
+    int cert_pbe = NID_pbe_WithSHA1And3_Key_TripleDES_CBC;
+# endif
     int key_pbe = NID_pbe_WithSHA1And3_Key_TripleDES_CBC;
-    int ret = 1;
-    int macver = 1;
-    int noprompt = 0;
+    int ret = 1, macver = 1, noprompt = 0, add_lmk = 0;
+    char *passinarg = NULL, *passoutarg = NULL, *passarg = NULL;
+    char *passin = NULL, *passout = NULL, *inrand = NULL, *macalg = NULL;
+    char *cpass = NULL, *mpass = NULL, *CApath = NULL, *CAfile = NULL;
+    char *engine = NULL, *prog;
+    ENGINE *e = NULL;
+    BIO *in = NULL, *out = NULL;
+    PKCS12 *p12 = NULL;
     STACK_OF(OPENSSL_STRING) *canames = NULL;
-    char *cpass = NULL, *mpass = NULL;
-    char *passargin = NULL, *passargout = NULL, *passarg = NULL;
-    char *passin = NULL, *passout = NULL;
-    char *inrand = NULL;
-    char *macalg = NULL;
-    char *CApath = NULL, *CAfile = NULL;
-# ifndef OPENSSL_NO_ENGINE
-    char *engine = NULL;
-# endif
-
-    apps_startup();
-
-    enc = EVP_des_ede3_cbc();
-    if (bio_err == NULL)
-        bio_err = BIO_new_fp(stderr, BIO_NOCLOSE);
-
-    if (!load_config(bio_err, NULL))
-        goto end;
-
-    args = argv + 1;
-
-    while (*args) {
-        if (*args[0] == '-') {
-            if (!strcmp(*args, &quot;-nokeys&quot;))
-                options |= NOKEYS;
-            else if (!strcmp(*args, &quot;-keyex&quot;))
-                keytype = KEY_EX;
-            else if (!strcmp(*args, &quot;-keysig&quot;))
-                keytype = KEY_SIG;
-            else if (!strcmp(*args, &quot;-nocerts&quot;))
-                options |= NOCERTS;
-            else if (!strcmp(*args, &quot;-clcerts&quot;))
-                options |= CLCERTS;
-            else if (!strcmp(*args, &quot;-cacerts&quot;))
-                options |= CACERTS;
-            else if (!strcmp(*args, &quot;-noout&quot;))
-                options |= (NOKEYS | NOCERTS);
-            else if (!strcmp(*args, &quot;-info&quot;))
-                options |= INFO;
-            else if (!strcmp(*args, &quot;-chain&quot;))
-                chain = 1;
-            else if (!strcmp(*args, &quot;-twopass&quot;))
-                twopass = 1;
-            else if (!strcmp(*args, &quot;-nomacver&quot;))
-                macver = 0;
-            else if (!strcmp(*args, &quot;-descert&quot;))
-                cert_pbe = NID_pbe_WithSHA1And3_Key_TripleDES_CBC;
-            else if (!strcmp(*args, &quot;-export&quot;))
-                export_cert = 1;
-            else if (!strcmp(*args, &quot;-des&quot;))
-                enc = EVP_des_cbc();
-            else if (!strcmp(*args, &quot;-des3&quot;))
-                enc = EVP_des_ede3_cbc();
-# ifndef OPENSSL_NO_IDEA
-            else if (!strcmp(*args, &quot;-idea&quot;))
-                enc = EVP_idea_cbc();
-# endif
-# ifndef OPENSSL_NO_SEED
-            else if (!strcmp(*args, &quot;-seed&quot;))
-                enc = EVP_seed_cbc();
-# endif
-# ifndef OPENSSL_NO_AES
-            else if (!strcmp(*args, &quot;-aes128&quot;))
-                enc = EVP_aes_128_cbc();
-            else if (!strcmp(*args, &quot;-aes192&quot;))
-                enc = EVP_aes_192_cbc();
-            else if (!strcmp(*args, &quot;-aes256&quot;))
-                enc = EVP_aes_256_cbc();
-# endif
-# ifndef OPENSSL_NO_CAMELLIA
-            else if (!strcmp(*args, &quot;-camellia128&quot;))
-                enc = EVP_camellia_128_cbc();
-            else if (!strcmp(*args, &quot;-camellia192&quot;))
-                enc = EVP_camellia_192_cbc();
-            else if (!strcmp(*args, &quot;-camellia256&quot;))
-                enc = EVP_camellia_256_cbc();
-# endif
-            else if (!strcmp(*args, &quot;-noiter&quot;))
-                iter = 1;
-            else if (!strcmp(*args, &quot;-maciter&quot;))
-                maciter = PKCS12_DEFAULT_ITER;
-            else if (!strcmp(*args, &quot;-nomaciter&quot;))
-                maciter = 1;
-            else if (!strcmp(*args, &quot;-nomac&quot;))
-                maciter = -1;
-            else if (!strcmp(*args, &quot;-macalg&quot;))
-                if (args[1]) {
-                    args++;
-                    macalg = *args;
-                } else
-                    badarg = 1;
-            else if (!strcmp(*args, &quot;-nodes&quot;))
-                enc = NULL;
-            else if (!strcmp(*args, &quot;-certpbe&quot;)) {
-                if (!set_pbe(bio_err, &amp;cert_pbe, *++args))
-                    badarg = 1;
-            } else if (!strcmp(*args, &quot;-keypbe&quot;)) {
-                if (!set_pbe(bio_err, &amp;key_pbe, *++args))
-                    badarg = 1;
-            } else if (!strcmp(*args, &quot;-rand&quot;)) {
-                if (args[1]) {
-                    args++;
-                    inrand = *args;
-                } else
-                    badarg = 1;
-            } else if (!strcmp(*args, &quot;-inkey&quot;)) {
-                if (args[1]) {
-                    args++;
-                    keyname = *args;
-                } else
-                    badarg = 1;
-            } else if (!strcmp(*args, &quot;-certfile&quot;)) {
-                if (args[1]) {
-                    args++;
-                    certfile = *args;
-                } else
-                    badarg = 1;
-            } else if (!strcmp(*args, &quot;-name&quot;)) {
-                if (args[1]) {
-                    args++;
-                    name = *args;
-                } else
-                    badarg = 1;
-            } else if (!strcmp(*args, &quot;-LMK&quot;))
-                add_lmk = 1;
-            else if (!strcmp(*args, &quot;-CSP&quot;)) {
-                if (args[1]) {
-                    args++;
-                    csp_name = *args;
-                } else
-                    badarg = 1;
-            } else if (!strcmp(*args, &quot;-caname&quot;)) {
-                if (args[1]) {
-                    args++;
-                    if (!canames)
-                        canames = sk_OPENSSL_STRING_new_null();
-                    sk_OPENSSL_STRING_push(canames, *args);
-                } else
-                    badarg = 1;
-            } else if (!strcmp(*args, &quot;-in&quot;)) {
-                if (args[1]) {
-                    args++;
-                    infile = *args;
-                } else
-                    badarg = 1;
-            } else if (!strcmp(*args, &quot;-out&quot;)) {
-                if (args[1]) {
-                    args++;
-                    outfile = *args;
-                } else
-                    badarg = 1;
-            } else if (!strcmp(*args, &quot;-passin&quot;)) {
-                if (args[1]) {
-                    args++;
-                    passargin = *args;
-                } else
-                    badarg = 1;
-            } else if (!strcmp(*args, &quot;-passout&quot;)) {
-                if (args[1]) {
-                    args++;
-                    passargout = *args;
-                } else
-                    badarg = 1;
-            } else if (!strcmp(*args, &quot;-password&quot;)) {
-                if (args[1]) {
-                    args++;
-                    passarg = *args;
-                    noprompt = 1;
-                } else
-                    badarg = 1;
-            } else if (!strcmp(*args, &quot;-CApath&quot;)) {
-                if (args[1]) {
-                    args++;
-                    CApath = *args;
-                } else
-                    badarg = 1;
-            } else if (!strcmp(*args, &quot;-CAfile&quot;)) {
-                if (args[1]) {
-                    args++;
-                    CAfile = *args;
-                } else
-                    badarg = 1;
-# ifndef OPENSSL_NO_ENGINE
-            } else if (!strcmp(*args, &quot;-engine&quot;)) {
-                if (args[1]) {
-                    args++;
-                    engine = *args;
-                } else
-                    badarg = 1;
-# endif
-            } else
-                badarg = 1;
-
-        } else
-            badarg = 1;
-        args++;
+    const EVP_CIPHER *enc = EVP_des_ede3_cbc();
+    OPTION_CHOICE o;
+
+    prog = opt_init(argc, argv, pkcs12_options);
+    while ((o = opt_next()) != OPT_EOF) {
+        switch (o) {
+        case OPT_EOF:
+        case OPT_ERR:
+ opthelp:
+            BIO_printf(bio_err, &quot;%s: Use -help for summary.\n&quot;, prog);
+            goto end;
+        case OPT_HELP:
+            opt_help(pkcs12_options);
+            ret = 0;
+            goto end;
+        case OPT_NOKEYS:
+            options |= NOKEYS;
+            break;
+        case OPT_KEYEX:
+            keytype = KEY_EX;
+            break;
+        case OPT_KEYSIG:
+            keytype = KEY_SIG;
+            break;
+        case OPT_NOCERTS:
+            options |= NOCERTS;
+            break;
+        case OPT_CLCERTS:
+            options |= CLCERTS;
+            break;
+        case OPT_CACERTS:
+            options |= CACERTS;
+            break;
+        case OPT_NOOUT:
+            options |= (NOKEYS | NOCERTS);
+            break;
+        case OPT_INFO:
+            options |= INFO;
+            break;
+        case OPT_CHAIN:
+            chain = 1;
+            break;
+        case OPT_TWOPASS:
+            twopass = 1;
+            break;
+        case OPT_NOMACVER:
+            macver = 0;
+            break;
+        case OPT_DESCERT:
+            cert_pbe = NID_pbe_WithSHA1And3_Key_TripleDES_CBC;
+            break;
+        case OPT_EXPORT:
+            export_cert = 1;
+            break;
+        case OPT_CIPHER:
+            if (!opt_cipher(opt_unknown(), &amp;enc))
+                goto opthelp;
+            break;
+        case OPT_NOITER:
+            iter = 1;
+            break;
+        case OPT_MACITER:
+            maciter = PKCS12_DEFAULT_ITER;
+            break;
+        case OPT_NOMACITER:
+            maciter = 1;
+            break;
+        case OPT_NOMAC:
+            maciter = -1;
+            break;
+        case OPT_MACALG:
+            macalg = opt_arg();
+            break;
+        case OPT_NODES:
+            enc = NULL;
+            break;
+        case OPT_CERTPBE:
+            if (!set_pbe(&amp;cert_pbe, opt_arg()))
+                goto opthelp;
+            break;
+        case OPT_KEYPBE:
+            if (!set_pbe(&amp;key_pbe, opt_arg()))
+                goto opthelp;
+            break;
+        case OPT_RAND:
+            inrand = opt_arg();
+            break;
+        case OPT_INKEY:
+            keyname = opt_arg();
+            break;
+        case OPT_CERTFILE:
+            certfile = opt_arg();
+            break;
+        case OPT_NAME:
+            name = opt_arg();
+            break;
+        case OPT_LMK:
+            add_lmk = 1;
+            break;
+        case OPT_CSP:
+            csp_name = opt_arg();
+            break;
+        case OPT_CANAME:
+            if (canames == NULL
+                &amp;&amp; (canames = sk_OPENSSL_STRING_new_null()) == NULL)
+                goto end;
+            sk_OPENSSL_STRING_push(canames, opt_arg());
+            break;
+        case OPT_IN:
+            infile = opt_arg();
+            break;
+        case OPT_OUT:
+            outfile = opt_arg();
+            break;
+        case OPT_PASSIN:
+            passinarg = opt_arg();
+            break;
+        case OPT_PASSOUT:
+            passoutarg = opt_arg();
+            break;
+        case OPT_PASSWORD:
+            passarg = opt_arg();
+            break;
+        case OPT_CAPATH:
+            CApath = opt_arg();
+            break;
+        case OPT_CAFILE:
+            CAfile = opt_arg();
+            break;
+        case OPT_ENGINE:
+            engine = opt_arg();
+            break;
+        }
     }
+    argc = opt_num_rest();
+    argv = opt_rest();
 
-    if (badarg) {
-        BIO_printf(bio_err, &quot;Usage: pkcs12 [options]\n&quot;);
-        BIO_printf(bio_err, &quot;where options are\n&quot;);
-        BIO_printf(bio_err, &quot;-export       output PKCS12 file\n&quot;);
-        BIO_printf(bio_err, &quot;-chain        add certificate chain\n&quot;);
-        BIO_printf(bio_err, &quot;-inkey file   private key if not infile\n&quot;);
-        BIO_printf(bio_err, &quot;-certfile f   add all certs in f\n&quot;);
-        BIO_printf(bio_err, &quot;-CApath arg   - PEM format directory of CA's\n&quot;);
-        BIO_printf(bio_err, &quot;-CAfile arg   - PEM format file of CA's\n&quot;);
-        BIO_printf(bio_err, &quot;-name \&quot;name\&quot;  use name as friendly name\n&quot;);
-        BIO_printf(bio_err,
-                   &quot;-caname \&quot;nm\&quot;  use nm as CA friendly name (can be used more than once).\n&quot;);
-        BIO_printf(bio_err, &quot;-in  infile   input filename\n&quot;);
-        BIO_printf(bio_err, &quot;-out outfile  output filename\n&quot;);
-        BIO_printf(bio_err,
-                   &quot;-noout        don't output anything, just verify.\n&quot;);
-        BIO_printf(bio_err, &quot;-nomacver     don't verify MAC.\n&quot;);
-        BIO_printf(bio_err, &quot;-nocerts      don't output certificates.\n&quot;);
-        BIO_printf(bio_err,
-                   &quot;-clcerts      only output client certificates.\n&quot;);
-        BIO_printf(bio_err, &quot;-cacerts      only output CA certificates.\n&quot;);
-        BIO_printf(bio_err, &quot;-nokeys       don't output private keys.\n&quot;);
-        BIO_printf(bio_err,
-                   &quot;-info         give info about PKCS#12 structure.\n&quot;);
-        BIO_printf(bio_err, &quot;-des          encrypt private keys with DES\n&quot;);
-        BIO_printf(bio_err,
-                   &quot;-des3         encrypt private keys with triple DES (default)\n&quot;);
-# ifndef OPENSSL_NO_IDEA
-        BIO_printf(bio_err, &quot;-idea         encrypt private keys with idea\n&quot;);
-# endif
-# ifndef OPENSSL_NO_SEED
-        BIO_printf(bio_err, &quot;-seed         encrypt private keys with seed\n&quot;);
-# endif
-# ifndef OPENSSL_NO_AES
-        BIO_printf(bio_err, &quot;-aes128, -aes192, -aes256\n&quot;);
-        BIO_printf(bio_err,
-                   &quot;              encrypt PEM output with cbc aes\n&quot;);
-# endif
-# ifndef OPENSSL_NO_CAMELLIA
-        BIO_printf(bio_err, &quot;-camellia128, -camellia192, -camellia256\n&quot;);
-        BIO_printf(bio_err,
-                   &quot;              encrypt PEM output with cbc camellia\n&quot;);
-# endif
-        BIO_printf(bio_err, &quot;-nodes        don't encrypt private keys\n&quot;);
-        BIO_printf(bio_err, &quot;-noiter       don't use encryption iteration\n&quot;);
-        BIO_printf(bio_err, &quot;-nomaciter    don't use MAC iteration\n&quot;);
-        BIO_printf(bio_err, &quot;-maciter      use MAC iteration\n&quot;);
-        BIO_printf(bio_err, &quot;-nomac        don't generate MAC\n&quot;);
-        BIO_printf(bio_err,
-                   &quot;-twopass      separate MAC, encryption passwords\n&quot;);
-        BIO_printf(bio_err,
-                   &quot;-descert      encrypt PKCS#12 certificates with triple DES (default RC2-40)\n&quot;);
-        BIO_printf(bio_err,
-                   &quot;-certpbe alg  specify certificate PBE algorithm (default RC2-40)\n&quot;);
-        BIO_printf(bio_err,
-                   &quot;-keypbe alg   specify private key PBE algorithm (default 3DES)\n&quot;);
-        BIO_printf(bio_err,
-                   &quot;-macalg alg   digest algorithm used in MAC (default SHA1)\n&quot;);
-        BIO_printf(bio_err, &quot;-keyex        set MS key exchange type\n&quot;);
-        BIO_printf(bio_err, &quot;-keysig       set MS key signature type\n&quot;);
-        BIO_printf(bio_err,
-                   &quot;-password p   set import/export password source\n&quot;);
-        BIO_printf(bio_err, &quot;-passin p     input file pass phrase source\n&quot;);
-        BIO_printf(bio_err, &quot;-passout p    output file pass phrase source\n&quot;);
 # ifndef OPENSSL_NO_ENGINE
-        BIO_printf(bio_err,
-                   &quot;-engine e     use engine e, possibly a hardware device.\n&quot;);
-# endif
-        BIO_printf(bio_err, &quot;-rand file%cfile%c...\n&quot;, LIST_SEPARATOR_CHAR,
-                   LIST_SEPARATOR_CHAR);
-        BIO_printf(bio_err,
-                   &quot;              load the file (or the files in the directory) into\n&quot;);
-        BIO_printf(bio_err, &quot;              the random number generator\n&quot;);
-        BIO_printf(bio_err, &quot;-CSP name     Microsoft CSP name\n&quot;);
-        BIO_printf(bio_err,
-                   &quot;-LMK          Add local machine keyset attribute to private key\n&quot;);
-        goto end;
-    }
-# ifndef OPENSSL_NO_ENGINE
-    e = setup_engine(bio_err, engine, 0);
+    e = setup_engine(engine, 0);
 # endif
 
     if (passarg) {
         if (export_cert)
-            passargout = passarg;
+            passoutarg = passarg;
         else
-            passargin = passarg;
+            passinarg = passarg;
     }
 
-    if (!app_passwd(bio_err, passargin, passargout, &amp;passin, &amp;passout)) {
+    if (!app_passwd(passinarg, passoutarg, &amp;passin, &amp;passout)) {
         BIO_printf(bio_err, &quot;Error getting passwords\n&quot;);
         goto end;
     }
@@ -430,60 +347,26 @@ int MAIN(int argc, char **argv)
     }
 
     if (export_cert || inrand) {
-        app_RAND_load_file(NULL, bio_err, (inrand != NULL));
+        app_RAND_load_file(NULL, (inrand != NULL));
         if (inrand != NULL)
             BIO_printf(bio_err, &quot;%ld semi-random bytes loaded\n&quot;,
                        app_RAND_load_files(inrand));
     }
-    ERR_load_crypto_strings();
-
-# ifdef CRYPTO_MDEBUG
-    CRYPTO_push_info(&quot;read files&quot;);
-# endif
 
-    if (!infile)
-        in = BIO_new_fp(stdin, BIO_NOCLOSE);
-    else
-        in = BIO_new_file(infile, &quot;rb&quot;);
-    if (!in) {
-        BIO_printf(bio_err, &quot;Error opening input file %s\n&quot;,
-                   infile ? infile : &quot;&lt;stdin&gt;&quot;);
-        perror(infile);
+    in = bio_open_default(infile, &quot;rb&quot;);
+    if (in == NULL)
         goto end;
-    }
-# ifdef CRYPTO_MDEBUG
-    CRYPTO_pop_info();
-    CRYPTO_push_info(&quot;write files&quot;);
-# endif
 
-    if (!outfile) {
-        out = BIO_new_fp(stdout, BIO_NOCLOSE);
-# ifdef OPENSSL_SYS_VMS
-        {
-            BIO *tmpbio = BIO_new(BIO_f_linebuffer());
-            out = BIO_push(tmpbio, out);
-        }
-# endif
-    } else
-        out = BIO_new_file(outfile, &quot;wb&quot;);
-    if (!out) {
-        BIO_printf(bio_err, &quot;Error opening output file %s\n&quot;,
-                   outfile ? outfile : &quot;&lt;stdout&gt;&quot;);
-        perror(outfile);
+    out = bio_open_default(outfile, &quot;wb&quot;);
+    if (out == NULL)
         goto end;
-    }
+
     if (twopass) {
-# ifdef CRYPTO_MDEBUG
-        CRYPTO_push_info(&quot;read MAC password&quot;);
-# endif
         if (EVP_read_pw_string
             (macpass, sizeof macpass, &quot;Enter MAC Password:&quot;, export_cert)) {
             BIO_printf(bio_err, &quot;Can't read Password\n&quot;);
             goto end;
         }
-# ifdef CRYPTO_MDEBUG
-        CRYPTO_pop_info();
-# endif
     }
 
     if (export_cert) {
@@ -502,24 +385,16 @@ int MAIN(int argc, char **argv)
         if (options &amp; NOCERTS)
             chain = 0;
 
-# ifdef CRYPTO_MDEBUG
-        CRYPTO_push_info(&quot;process -export_cert&quot;);
-        CRYPTO_push_info(&quot;reading private key&quot;);
-# endif
         if (!(options &amp; NOKEYS)) {
-            key = load_key(bio_err, keyname ? keyname : infile,
+            key = load_key(keyname ? keyname : infile,
                            FORMAT_PEM, 1, passin, e, &quot;private key&quot;);
             if (!key)
                 goto export_end;
         }
-# ifdef CRYPTO_MDEBUG
-        CRYPTO_pop_info();
-        CRYPTO_push_info(&quot;reading certs from input&quot;);
-# endif
 
         /* Load in all certs in input file */
         if (!(options &amp; NOCERTS)) {
-            certs = load_certs(bio_err, infile, FORMAT_PEM, NULL, e,
+            certs = load_certs(infile, FORMAT_PEM, NULL, e,
                                &quot;certificates&quot;);
             if (!certs)
                 goto export_end;
@@ -546,43 +421,25 @@ int MAIN(int argc, char **argv)
             }
 
         }
-# ifdef CRYPTO_MDEBUG
-        CRYPTO_pop_info();
-        CRYPTO_push_info(&quot;reading certs from input 2&quot;);
-# endif
 
         /* Add any more certificates asked for */
         if (certfile) {
             STACK_OF(X509) *morecerts = NULL;
-            if (!(morecerts = load_certs(bio_err, certfile, FORMAT_PEM,
-                                         NULL, e,
+            if (!(morecerts = load_certs(certfile, FORMAT_PEM, NULL, e,
                                          &quot;certificates from certfile&quot;)))
                 goto export_end;
             while (sk_X509_num(morecerts) &gt; 0)
                 sk_X509_push(certs, sk_X509_shift(morecerts));
             sk_X509_free(morecerts);
         }
-# ifdef CRYPTO_MDEBUG
-        CRYPTO_pop_info();
-        CRYPTO_push_info(&quot;reading certs from certfile&quot;);
-# endif
-
-# ifdef CRYPTO_MDEBUG
-        CRYPTO_pop_info();
-        CRYPTO_push_info(&quot;building chain&quot;);
-# endif
 
         /* If chaining get chain from user cert */
         if (chain) {
             int vret;
             STACK_OF(X509) *chain2;
-            X509_STORE *store = X509_STORE_new();
-            if (!store) {
-                BIO_printf(bio_err, &quot;Memory allocation error\n&quot;);
+            X509_STORE *store;
+            if (!(store = setup_verify(CAfile, CApath)))
                 goto export_end;
-            }
-            if (!X509_STORE_load_locations(store, CAfile, CApath))
-                X509_STORE_set_default_paths(store);
 
             vret = get_cert_chain(ucert, store, &amp;chain2);
             X509_STORE_free(store);
@@ -619,11 +476,6 @@ int MAIN(int argc, char **argv)
         if (add_lmk &amp;&amp; key)
             EVP_PKEY_add1_attr_by_NID(key, NID_LocalKeySet, 0, NULL, -1);
 
-# ifdef CRYPTO_MDEBUG
-        CRYPTO_pop_info();
-        CRYPTO_push_info(&quot;reading password&quot;);
-# endif
-
         if (!noprompt &amp;&amp;
             EVP_read_pw_string(pass, sizeof pass, &quot;Enter Export Password:&quot;,
                                1)) {
@@ -633,11 +485,6 @@ int MAIN(int argc, char **argv)
         if (!twopass)
             BUF_strlcpy(macpass, pass, sizeof macpass);
 
-# ifdef CRYPTO_MDEBUG
-        CRYPTO_pop_info();
-        CRYPTO_push_info(&quot;creating PKCS#12 structure&quot;);
-# endif
-
         p12 = PKCS12_create(cpass, name, key, ucert, certs,
                             key_pbe, cert_pbe, iter, -1, keytype);
 
@@ -647,30 +494,18 @@ int MAIN(int argc, char **argv)
         }
 
         if (macalg) {
-            macmd = EVP_get_digestbyname(macalg);
-            if (!macmd) {
-                BIO_printf(bio_err, &quot;Unknown digest algorithm %s\n&quot;, macalg);
-            }
+            if (!opt_md(macalg, &amp;macmd))
+                goto opthelp;
         }
 
         if (maciter != -1)
             PKCS12_set_mac(p12, mpass, -1, NULL, 0, maciter, macmd);
 
-# ifdef CRYPTO_MDEBUG
-        CRYPTO_pop_info();
-        CRYPTO_push_info(&quot;writing pkcs12&quot;);
-# endif
-
         i2d_PKCS12_bio(out, p12);
 
         ret = 0;
 
  export_end:
-# ifdef CRYPTO_MDEBUG
-        CRYPTO_pop_info();
-        CRYPTO_pop_info();
-        CRYPTO_push_info(&quot;process -export_cert: freeing&quot;);
-# endif
 
         EVP_PKEY_free(key);
         if (certs)
@@ -678,9 +513,6 @@ int MAIN(int argc, char **argv)
         if (ucert)
             X509_free(ucert);
 
-# ifdef CRYPTO_MDEBUG
-        CRYPTO_pop_info();
-# endif
         goto end;
 
     }
@@ -689,18 +521,13 @@ int MAIN(int argc, char **argv)
         ERR_print_errors(bio_err);
         goto end;
     }
-# ifdef CRYPTO_MDEBUG
-    CRYPTO_push_info(&quot;read import password&quot;);
-# endif
+
     if (!noprompt
         &amp;&amp; EVP_read_pw_string(pass, sizeof pass, &quot;Enter Import Password:&quot;,
                               0)) {
         BIO_printf(bio_err, &quot;Can't read Password\n&quot;);
         goto end;
     }
-# ifdef CRYPTO_MDEBUG
-    CRYPTO_pop_info();
-# endif
 
     if (!twopass)
         BUF_strlcpy(macpass, pass, sizeof macpass);
@@ -709,9 +536,6 @@ int MAIN(int argc, char **argv)
         BIO_printf(bio_err, &quot;MAC Iteration %ld\n&quot;,
                    p12-&gt;mac-&gt;iter ? ASN1_INTEGER_get(p12-&gt;mac-&gt;iter) : 1);
     if (macver) {
-# ifdef CRYPTO_MDEBUG
-        CRYPTO_push_info(&quot;verify MAC&quot;);
-# endif
         /* If we enter empty password try no password first */
         if (!mpass[0] &amp;&amp; PKCS12_verify_mac(p12, NULL, 0)) {
             /* If mac and crypto pass the same set it to NULL too */
@@ -722,30 +546,18 @@ int MAIN(int argc, char **argv)
             ERR_print_errors(bio_err);
             goto end;
         }
-        BIO_printf(bio_err, &quot;MAC verified OK\n&quot;);
-# ifdef CRYPTO_MDEBUG
-        CRYPTO_pop_info();
-# endif
     }
-# ifdef CRYPTO_MDEBUG
-    CRYPTO_push_info(&quot;output keys and certificates&quot;);
-# endif
-    if (!dump_certs_keys_p12(out, p12, cpass, -1, options, passout)) {
+
+    if (!dump_certs_keys_p12(out, p12, cpass, -1, options, passout, enc)) {
         BIO_printf(bio_err, &quot;Error outputting keys and certificates\n&quot;);
         ERR_print_errors(bio_err);
         goto end;
     }
-# ifdef CRYPTO_MDEBUG
-    CRYPTO_pop_info();
-# endif
     ret = 0;
  end:
     PKCS12_free(p12);
     if (export_cert || inrand)
-        app_RAND_write_file(NULL, bio_err);
-# ifdef CRYPTO_MDEBUG
-    CRYPTO_remove_all_info();
-# endif
+        app_RAND_write_file(NULL);
     BIO_free(in);
     BIO_free_all(out);
     if (canames)
@@ -754,12 +566,12 @@ int MAIN(int argc, char **argv)
         OPENSSL_free(passin);
     if (passout)
         OPENSSL_free(passout);
-    apps_shutdown();
-    OPENSSL_EXIT(ret);
+    return (ret);
 }
 
 int dump_certs_keys_p12(BIO *out, PKCS12 *p12, char *pass,
-                        int passlen, int options, char *pempass)
+                        int passlen, int options, char *pempass,
+                        const EVP_CIPHER *enc)
 {
     STACK_OF(PKCS7) *asafes = NULL;
     STACK_OF(PKCS12_SAFEBAG) *bags;
@@ -787,7 +599,7 @@ int dump_certs_keys_p12(BIO *out, PKCS12 *p12, char *pass,
         if (!bags)
             goto err;
         if (!dump_certs_pkeys_bags(out, bags, pass, passlen,
-                                   options, pempass)) {
+                                   options, pempass, enc)) {
             sk_PKCS12_SAFEBAG_pop_free(bags, PKCS12_SAFEBAG_free);
             goto err;
         }
@@ -802,20 +614,22 @@ int dump_certs_keys_p12(BIO *out, PKCS12 *p12, char *pass,
 }
 
 int dump_certs_pkeys_bags(BIO *out, STACK_OF(PKCS12_SAFEBAG) *bags,
-                          char *pass, int passlen, int options, char *pempass)
+                          char *pass, int passlen, int options, char *pempass,
+                          const EVP_CIPHER *enc)
 {
     int i;
     for (i = 0; i &lt; sk_PKCS12_SAFEBAG_num(bags); i++) {
         if (!dump_certs_pkeys_bag(out,
                                   sk_PKCS12_SAFEBAG_value(bags, i),
-                                  pass, passlen, options, pempass))
+                                  pass, passlen, options, pempass, enc))
             return 0;
     }
     return 1;
 }
 
 int dump_certs_pkeys_bag(BIO *out, PKCS12_SAFEBAG *bag, char *pass,
-                         int passlen, int options, char *pempass)
+                         int passlen, int options, char *pempass,
+                         const EVP_CIPHER *enc)
 {
     EVP_PKEY *pkey;
     PKCS8_PRIV_KEY_INFO *p8;
@@ -881,7 +695,7 @@ int dump_certs_pkeys_bag(BIO *out, PKCS12_SAFEBAG *bag, char *pass,
             BIO_printf(bio_err, &quot;Safe Contents bag\n&quot;);
         print_attribs(out, bag-&gt;attrib, &quot;Bag Attributes&quot;);
         return dump_certs_pkeys_bags(out, bag-&gt;value.safes, pass,
-                                     passlen, options, pempass);
+                                     passlen, options, pempass, enc);
 
     default:
         BIO_printf(bio_err, &quot;Warning unsupported bag type: &quot;);
@@ -949,22 +763,10 @@ int cert_load(BIO *in, STACK_OF(X509) *sk)
     int ret;
     X509 *cert;
     ret = 0;
-# ifdef CRYPTO_MDEBUG
-    CRYPTO_push_info(&quot;cert_load(): reading one cert&quot;);
-# endif
     while ((cert = PEM_read_bio_X509(in, NULL, NULL, NULL))) {
-# ifdef CRYPTO_MDEBUG
-        CRYPTO_pop_info();
-# endif
         ret = 1;
         sk_X509_push(sk, cert);
-# ifdef CRYPTO_MDEBUG
-        CRYPTO_push_info(&quot;cert_load(): reading one cert&quot;);
-# endif
     }
-# ifdef CRYPTO_MDEBUG
-    CRYPTO_pop_info();
-# endif
     if (ret)
         ERR_clear_error();
     return ret;
@@ -1039,7 +841,7 @@ void hex_prin(BIO *out, unsigned char *buf, int len)
         BIO_printf(out, &quot;%02X &quot;, buf[i]);
 }
 
-static int set_pbe(BIO *err, int *ppbe, const char *str)
+static int set_pbe(int *ppbe, const char *str)
 {
     if (!str)
         return 0;
diff --git a/apps/pkcs7.c b/apps/pkcs7.c
index 4fcb089..ca05273 100644
--- a/apps/pkcs7.c
+++ b/apps/pkcs7.c
@@ -1,4 +1,3 @@
-/* apps/pkcs7.c */
 /* Copyright (C) 1995-1998 Eric Young (<A HREF="../../../mailman/listinfo/openssl-commits.html">eay at cryptsoft.com</A>)
  * All rights reserved.
  *
@@ -55,6 +54,54 @@
  * copied and put under another distribution licence
  * [including the GNU Public Licence.]
  */
+/* ====================================================================
+ * Copyright (c) 1999-2015 The OpenSSL Project.  All rights reserved.
+ *
+ * Redistribution and use in source and binary forms, with or without
+ * modification, are permitted provided that the following conditions
+ * are met:
+ *
+ * 1. Redistributions of source code must retain the above copyright
+ *    notice, this list of conditions and the following disclaimer.
+ *
+ * 2. Redistributions in binary form must reproduce the above copyright
+ *    notice, this list of conditions and the following disclaimer in
+ *    the documentation and/or other materials provided with the
+ *    distribution.
+ *
+ * 3. All advertising materials mentioning features or use of this
+ *    software must display the following acknowledgment:
+ *    &quot;This product includes software developed by the OpenSSL Project
+ *    for use in the OpenSSL Toolkit. (<A HREF="http://www.OpenSSL.org/">http://www.OpenSSL.org/</A>)&quot;
+ *
+ * 4. The names &quot;OpenSSL Toolkit&quot; and &quot;OpenSSL Project&quot; must not be used to
+ *    endorse or promote products derived from this software without
+ *    prior written permission. For written permission, please contact
+ *    <A HREF="../../../mailman/listinfo/openssl-commits.html">licensing at OpenSSL.org.</A>
+ *
+ * 5. Products derived from this software may not be called &quot;OpenSSL&quot;
+ *    nor may &quot;OpenSSL&quot; appear in their names without prior written
+ *    permission of the OpenSSL Project.
+ *
+ * 6. Redistributions of any form whatsoever must retain the following
+ *    acknowledgment:
+ *    &quot;This product includes software developed by the OpenSSL Project
+ *    for use in the OpenSSL Toolkit (<A HREF="http://www.OpenSSL.org/">http://www.OpenSSL.org/</A>)&quot;
+ *
+ * THIS SOFTWARE IS PROVIDED BY THE OpenSSL PROJECT ``AS IS'' AND ANY
+ * EXPRESSED OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
+ * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR
+ * PURPOSE ARE DISCLAIMED.  IN NO EVENT SHALL THE OpenSSL PROJECT OR
+ * ITS CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
+ * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT
+ * NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;
+ * LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)
+ * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT,
+ * STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)
+ * ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED
+ * OF THE POSSIBILITY OF SUCH DAMAGE.
+ * ====================================================================
+ */
 
 #include &lt;stdio.h&gt;
 #include &lt;stdlib.h&gt;
@@ -68,162 +115,105 @@
 #include &lt;openssl/pkcs7.h&gt;
 #include &lt;openssl/pem.h&gt;
 
-#undef PROG
-#define PROG    pkcs7_main
-
-/*-
- * -inform arg  - input format - default PEM (DER or PEM)
- * -outform arg - output format - default PEM
- * -in arg      - input file - default stdin
- * -out arg     - output file - default stdout
- * -print_certs
- */
+typedef enum OPTION_choice {
+    OPT_ERR = -1, OPT_EOF = 0, OPT_HELP,
+    OPT_INFORM, OPT_OUTFORM, OPT_IN, OPT_OUT, OPT_NOOUT,
+    OPT_TEXT, OPT_PRINT, OPT_PRINT_CERTS, OPT_ENGINE
+} OPTION_CHOICE;
 
-int MAIN(int, char **);
+OPTIONS pkcs7_options[] = {
+    {&quot;help&quot;, OPT_HELP, '-', &quot;Display this summary&quot;},
+    {&quot;inform&quot;, OPT_INFORM, 'F', &quot;Input format - DER or PEM&quot;},
+    {&quot;in&quot;, OPT_IN, '&lt;', &quot;Input file&quot;},
+    {&quot;outform&quot;, OPT_OUTFORM, 'F', &quot;Output format - DER or PEM&quot;},
+    {&quot;out&quot;, OPT_OUT, '&gt;', &quot;Output file&quot;},
+    {&quot;noout&quot;, OPT_NOOUT, '-', &quot;Don't output encoded data&quot;},
+    {&quot;text&quot;, OPT_TEXT, '-', &quot;Print full details of certificates&quot;},
+    {&quot;print&quot;, OPT_PRINT, '-'},
+    {&quot;print_certs&quot;, OPT_PRINT_CERTS, '-',
+     &quot;Print_certs  print any certs or crl in the input&quot;},
+#ifndef OPENSSL_NO_ENGINE
+    {&quot;engine&quot;, OPT_ENGINE, 's', &quot;Use engine, possibly a hardware device&quot;},
+#endif
+    {NULL}
+};
 
-int MAIN(int argc, char **argv)
+int pkcs7_main(int argc, char **argv)
 {
     PKCS7 *p7 = NULL;
-    int i, badops = 0;
     BIO *in = NULL, *out = NULL;
-    int informat, outformat;
-    char *infile, *outfile, *prog;
-    int print_certs = 0, text = 0, noout = 0, p7_print = 0;
-    int ret = 1;
-#ifndef OPENSSL_NO_ENGINE
-    char *engine = NULL;
-#endif
-
-    apps_startup();
-
-    if (bio_err == NULL)
-        if ((bio_err = BIO_new(BIO_s_file())) != NULL)
-            BIO_set_fp(bio_err, stderr, BIO_NOCLOSE | BIO_FP_TEXT);
-
-    if (!load_config(bio_err, NULL))
-        goto end;
+    int informat = FORMAT_PEM, outformat = FORMAT_PEM;
+    char *engine = NULL, *infile = NULL, *outfile = NULL, *prog;
+    int i, print_certs = 0, text = 0, noout = 0, p7_print = 0, ret = 1;
+    OPTION_CHOICE o;
 
-    infile = NULL;
-    outfile = NULL;
-    informat = FORMAT_PEM;
-    outformat = FORMAT_PEM;
-
-    prog = argv[0];
-    argc--;
-    argv++;
-    while (argc &gt;= 1) {
-        if (strcmp(*argv, &quot;-inform&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            informat = str2fmt(*(++argv));
-        } else if (strcmp(*argv, &quot;-outform&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            outformat = str2fmt(*(++argv));
-        } else if (strcmp(*argv, &quot;-in&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            infile = *(++argv);
-        } else if (strcmp(*argv, &quot;-out&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            outfile = *(++argv);
-        } else if (strcmp(*argv, &quot;-noout&quot;) == 0)
+    prog = opt_init(argc, argv, pkcs7_options);
+    while ((o = opt_next()) != OPT_EOF) {
+        switch (o) {
+        case OPT_EOF:
+        case OPT_ERR:
+ opthelp:
+            BIO_printf(bio_err, &quot;%s: Use -help for summary.\n&quot;, prog);
+            goto end;
+        case OPT_HELP:
+            opt_help(pkcs7_options);
+            ret = 0;
+            goto end;
+        case OPT_INFORM:
+            if (!opt_format(opt_arg(), OPT_FMT_PEMDER, &amp;informat))
+                goto opthelp;
+            break;
+        case OPT_OUTFORM:
+            if (!opt_format(opt_arg(), OPT_FMT_PEMDER, &amp;outformat))
+                goto opthelp;
+            break;
+        case OPT_IN:
+            infile = opt_arg();
+            break;
+        case OPT_OUT:
+            outfile = opt_arg();
+            break;
+        case OPT_NOOUT:
             noout = 1;
-        else if (strcmp(*argv, &quot;-text&quot;) == 0)
+            break;
+        case OPT_TEXT:
             text = 1;
-        else if (strcmp(*argv, &quot;-print&quot;) == 0)
+            break;
+        case OPT_PRINT:
             p7_print = 1;
-        else if (strcmp(*argv, &quot;-print_certs&quot;) == 0)
+            break;
+        case OPT_PRINT_CERTS:
             print_certs = 1;
-#ifndef OPENSSL_NO_ENGINE
-        else if (strcmp(*argv, &quot;-engine&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            engine = *(++argv);
-        }
-#endif
-        else {
-            BIO_printf(bio_err, &quot;unknown option %s\n&quot;, *argv);
-            badops = 1;
+            break;
+        case OPT_ENGINE:
+            engine = opt_arg();
             break;
         }
-        argc--;
-        argv++;
     }
+    argc = opt_num_rest();
+    argv = opt_rest();
 
-    if (badops) {
- bad:
-        BIO_printf(bio_err, &quot;%s [options] &lt;infile &gt;outfile\n&quot;, prog);
-        BIO_printf(bio_err, &quot;where options are\n&quot;);
-        BIO_printf(bio_err, &quot; -inform arg   input format - DER or PEM\n&quot;);
-        BIO_printf(bio_err, &quot; -outform arg  output format - DER or PEM\n&quot;);
-        BIO_printf(bio_err, &quot; -in arg       input file\n&quot;);
-        BIO_printf(bio_err, &quot; -out arg      output file\n&quot;);
-        BIO_printf(bio_err,
-                   &quot; -print_certs  print any certs or crl in the input\n&quot;);
-        BIO_printf(bio_err,
-                   &quot; -text         print full details of certificates\n&quot;);
-        BIO_printf(bio_err, &quot; -noout        don't output encoded data\n&quot;);
 #ifndef OPENSSL_NO_ENGINE
-        BIO_printf(bio_err,
-                   &quot; -engine e     use engine e, possibly a hardware device.\n&quot;);
+    setup_engine(engine, 0);
 #endif
-        ret = 1;
-        goto end;
-    }
-
-    ERR_load_crypto_strings();
 
-#ifndef OPENSSL_NO_ENGINE
-    setup_engine(bio_err, engine, 0);
-#endif
-
-    in = BIO_new(BIO_s_file());
-    out = BIO_new(BIO_s_file());
-    if ((in == NULL) || (out == NULL)) {
-        ERR_print_errors(bio_err);
+    in = bio_open_default(infile, RB(informat));
+    if (in == NULL)
         goto end;
-    }
-
-    if (infile == NULL)
-        BIO_set_fp(in, stdin, BIO_NOCLOSE);
-    else {
-        if (BIO_read_filename(in, infile) &lt;= 0) {
-            BIO_printf(bio_err, &quot;unable to load input file\n&quot;);
-            ERR_print_errors(bio_err);
-            goto end;
-        }
-    }
 
     if (informat == FORMAT_ASN1)
         p7 = d2i_PKCS7_bio(in, NULL);
-    else if (informat == FORMAT_PEM)
+    else
         p7 = PEM_read_bio_PKCS7(in, NULL, NULL, NULL);
-    else {
-        BIO_printf(bio_err, &quot;bad input format specified for pkcs7 object\n&quot;);
-        goto end;
-    }
     if (p7 == NULL) {
         BIO_printf(bio_err, &quot;unable to load PKCS7 object\n&quot;);
         ERR_print_errors(bio_err);
         goto end;
     }
 
-    if (outfile == NULL) {
-        BIO_set_fp(out, stdout, BIO_NOCLOSE);
-#ifdef OPENSSL_SYS_VMS
-        {
-            BIO *tmpbio = BIO_new(BIO_f_linebuffer());
-            out = BIO_push(tmpbio, out);
-        }
-#endif
-    } else {
-        if (BIO_write_filename(out, outfile) &lt;= 0) {
-            perror(outfile);
-            goto end;
-        }
-    }
+    out = bio_open_default(outfile, WB(outformat));
+    if (out == NULL)
+        goto end;
 
     if (p7_print)
         PKCS7_print_ctx(out, p7, 0, NULL);
@@ -282,12 +272,8 @@ int MAIN(int argc, char **argv)
     if (!noout) {
         if (outformat == FORMAT_ASN1)
             i = i2d_PKCS7_bio(out, p7);
-        else if (outformat == FORMAT_PEM)
+        else
             i = PEM_write_bio_PKCS7(out, p7);
-        else {
-            BIO_printf(bio_err, &quot;bad output format specified for outfile\n&quot;);
-            goto end;
-        }
 
         if (!i) {
             BIO_printf(bio_err, &quot;unable to write pkcs7 object\n&quot;);
@@ -300,6 +286,5 @@ int MAIN(int argc, char **argv)
     PKCS7_free(p7);
     BIO_free(in);
     BIO_free_all(out);
-    apps_shutdown();
-    OPENSSL_EXIT(ret);
+    return (ret);
 }
diff --git a/apps/pkcs8.c b/apps/pkcs8.c
index a56b9f4..7b361cf 100644
--- a/apps/pkcs8.c
+++ b/apps/pkcs8.c
@@ -1,4 +1,3 @@
-/* pkcs8.c */
 /*
  * Written by Dr Stephen N Henson (<A HREF="../../../mailman/listinfo/openssl-commits.html">steve at openssl.org</A>) for the OpenSSL project
  * 1999-2004.
@@ -65,180 +64,142 @@
 #include &lt;openssl/evp.h&gt;
 #include &lt;openssl/pkcs12.h&gt;
 
-#define PROG pkcs8_main
+typedef enum OPTION_choice {
+    OPT_ERR = -1, OPT_EOF = 0, OPT_HELP,
+    OPT_INFORM, OPT_OUTFORM, OPT_ENGINE, OPT_IN, OPT_OUT,
+    OPT_TOPK8, OPT_NOITER, OPT_NOCRYPT, OPT_NOOCT, OPT_NSDB, OPT_EMBED,
+    OPT_V2, OPT_V1, OPT_V2PRF, OPT_ITER, OPT_PASSIN, OPT_PASSOUT
+} OPTION_CHOICE;
 
-int MAIN(int, char **);
+OPTIONS pkcs8_options[] = {
+    {&quot;help&quot;, OPT_HELP, '-', &quot;Display this summary&quot;},
+    {&quot;inform&quot;, OPT_INFORM, 'F', &quot;Input format (DER or PEM)&quot;},
+    {&quot;outform&quot;, OPT_OUTFORM, 'F', &quot;Output format (DER or PEM)&quot;},
+    {&quot;in&quot;, OPT_IN, '&lt;', &quot;Input file&quot;},
+    {&quot;out&quot;, OPT_OUT, '&gt;', &quot;Output file&quot;},
+    {&quot;topk8&quot;, OPT_TOPK8, '-', &quot;Output PKCS8 file&quot;},
+    {&quot;noiter&quot;, OPT_NOITER, '-', &quot;Use 1 as iteration count&quot;},
+    {&quot;nocrypt&quot;, OPT_NOCRYPT, '-', &quot;Use or expect unencrypted private key&quot;},
+    {&quot;nooct&quot;, OPT_NOOCT, '-', &quot;Use (nonstandard) no octet format&quot;},
+    {&quot;nsdb&quot;, OPT_NSDB, '-', &quot;Use (nonstandard) DSA Netscape DB format&quot;},
+    {&quot;embed&quot;, OPT_EMBED, '-',
+     &quot;Use (nonstandard) embedded DSA parameters format&quot;},
+    {&quot;v2&quot;, OPT_V2, 's', &quot;Use PKCS#5 v2.0 and cipher&quot;},
+    {&quot;v1&quot;, OPT_V1, 's', &quot;Use PKCS#5 v1.5 and cipher&quot;},
+    {&quot;v2prf&quot;, OPT_V2PRF, 's'},
+    {&quot;iter&quot;, OPT_ITER, 'p', &quot;Specify the iteration count&quot;},
+    {&quot;passin&quot;, OPT_PASSIN, 's', &quot;Input file pass phrase source&quot;},
+    {&quot;passout&quot;, OPT_PASSOUT, 's', &quot;Output file pass phrase source&quot;},
+#ifndef OPENSSL_NO_ENGINE
+    {&quot;engine&quot;, OPT_ENGINE, 's', &quot;Use engine, possibly a hardware device&quot;},
+#endif
+    {NULL}
+};
 
-int MAIN(int argc, char **argv)
+int pkcs8_main(int argc, char **argv)
 {
-    ENGINE *e = NULL;
-    char **args, *infile = NULL, *outfile = NULL;
-    char *passargin = NULL, *passargout = NULL;
     BIO *in = NULL, *out = NULL;
-    int topk8 = 0;
-    int pbe_nid = -1;
-    const EVP_CIPHER *cipher = NULL;
-    int iter = PKCS12_DEFAULT_ITER;
-    int informat, outformat;
-    int p8_broken = PKCS8_OK;
-    int nocrypt = 0;
-    X509_SIG *p8 = NULL;
-    PKCS8_PRIV_KEY_INFO *p8inf = NULL;
+    ENGINE *e = NULL;
     EVP_PKEY *pkey = NULL;
+    PKCS8_PRIV_KEY_INFO *p8inf = NULL;
+    X509_SIG *p8 = NULL;
+    const EVP_CIPHER *cipher = NULL;
+    char *engine = NULL, *infile = NULL, *outfile = NULL;
+    char *passinarg = NULL, *passoutarg = NULL, *prog;
     char pass[50], *passin = NULL, *passout = NULL, *p8pass = NULL;
-    int badarg = 0;
-    int ret = 1;
-#ifndef OPENSSL_NO_ENGINE
-    char *engine = NULL;
-#endif
-
-    if (bio_err == NULL)
-        bio_err = BIO_new_fp(stderr, BIO_NOCLOSE);
-
-    if (!load_config(bio_err, NULL))
-        goto end;
-
-    informat = FORMAT_PEM;
-    outformat = FORMAT_PEM;
+    OPTION_CHOICE o;
+    int nocrypt = 0, ret = 1, iter = PKCS12_DEFAULT_ITER, p8_broken =
+        PKCS8_OK;
+    int informat = FORMAT_PEM, outformat = FORMAT_PEM, topk8 = 0, pbe_nid =
+        -1;
 
-    ERR_load_crypto_strings();
-    OpenSSL_add_all_algorithms();
-    args = argv + 1;
-    while (!badarg &amp;&amp; *args &amp;&amp; *args[0] == '-') {
-        if (!strcmp(*args, &quot;-v2&quot;)) {
-            if (args[1]) {
-                args++;
-                cipher = EVP_get_cipherbyname(*args);
-                if (!cipher) {
-                    BIO_printf(bio_err, &quot;Unknown cipher %s\n&quot;, *args);
-                    badarg = 1;
-                }
-            } else
-                badarg = 1;
-        } else if (!strcmp(*args, &quot;-v1&quot;)) {
-            if (args[1]) {
-                args++;
-                pbe_nid = OBJ_txt2nid(*args);
-                if (pbe_nid == NID_undef) {
-                    BIO_printf(bio_err, &quot;Unknown PBE algorithm %s\n&quot;, *args);
-                    badarg = 1;
-                }
-            } else
-                badarg = 1;
-        } else if (!strcmp(*args, &quot;-v2prf&quot;)) {
-            if (args[1]) {
-                args++;
-                pbe_nid = OBJ_txt2nid(*args);
-                if (!EVP_PBE_find(EVP_PBE_TYPE_PRF, pbe_nid, NULL, NULL, 0)) {
-                    BIO_printf(bio_err, &quot;Unknown PRF algorithm %s\n&quot;, *args);
-                    badarg = 1;
-                }
-            } else
-                badarg = 1;
-        } else if (!strcmp(*args, &quot;-inform&quot;)) {
-            if (args[1]) {
-                args++;
-                informat = str2fmt(*args);
-            } else
-                badarg = 1;
-        } else if (!strcmp(*args, &quot;-outform&quot;)) {
-            if (args[1]) {
-                args++;
-                outformat = str2fmt(*args);
-            } else
-                badarg = 1;
-        } else if (!strcmp(*args, &quot;-topk8&quot;))
+    prog = opt_init(argc, argv, pkcs8_options);
+    while ((o = opt_next()) != OPT_EOF) {
+        switch (o) {
+        case OPT_EOF:
+        case OPT_ERR:
+ opthelp:
+            BIO_printf(bio_err, &quot;%s: Use -help for summary.\n&quot;, prog);
+            goto end;
+        case OPT_HELP:
+            opt_help(pkcs8_options);
+            ret = 0;
+            goto end;
+        case OPT_INFORM:
+            if (!opt_format(opt_arg(), OPT_FMT_PEMDER, &amp;informat))
+                goto opthelp;
+            break;
+        case OPT_IN:
+            infile = opt_arg();
+            break;
+        case OPT_OUTFORM:
+            if (!opt_format(opt_arg(), OPT_FMT_PEMDER, &amp;outformat))
+                goto opthelp;
+            break;
+        case OPT_OUT:
+            outfile = opt_arg();
+            break;
+        case OPT_TOPK8:
             topk8 = 1;
-        else if (!strcmp(*args, &quot;-noiter&quot;))
+            break;
+        case OPT_NOITER:
             iter = 1;
-        else if (!strcmp(*args, &quot;-iter&quot;)) {
-            if (args[1]) {
-                iter = atoi(*(++args));
-                if (iter &lt;= 0)
-                    badarg = 1;
-            } else
-                badarg = 1;
-        } else if (!strcmp(*args, &quot;-nocrypt&quot;))
+            break;
+        case OPT_NOCRYPT:
             nocrypt = 1;
-        else if (!strcmp(*args, &quot;-nooct&quot;))
+            break;
+        case OPT_NOOCT:
             p8_broken = PKCS8_NO_OCTET;
-        else if (!strcmp(*args, &quot;-nsdb&quot;))
+            break;
+        case OPT_NSDB:
             p8_broken = PKCS8_NS_DB;
-        else if (!strcmp(*args, &quot;-embed&quot;))
+            break;
+        case OPT_EMBED:
             p8_broken = PKCS8_EMBEDDED_PARAM;
-        else if (!strcmp(*args, &quot;-passin&quot;)) {
-            if (args[1])
-                passargin = *(++args);
-            else
-                badarg = 1;
-        } else if (!strcmp(*args, &quot;-passout&quot;)) {
-            if (args[1])
-                passargout = *(++args);
-            else
-                badarg = 1;
-        }
-#ifndef OPENSSL_NO_ENGINE
-        else if (strcmp(*args, &quot;-engine&quot;) == 0) {
-            if (args[1])
-                engine = *(++args);
-            else
-                badarg = 1;
+            break;
+        case OPT_V2:
+            if (!opt_cipher(opt_arg(), &amp;cipher))
+                goto opthelp;
+            break;
+        case OPT_V1:
+            pbe_nid = OBJ_txt2nid(opt_arg());
+            if (pbe_nid == NID_undef) {
+                BIO_printf(bio_err,
+                           &quot;%s: Unknown PBE algorithm %s\n&quot;, prog, opt_arg());
+                goto opthelp;
+            }
+            break;
+        case OPT_V2PRF:
+            pbe_nid = OBJ_txt2nid(opt_arg());
+            if (!EVP_PBE_find(EVP_PBE_TYPE_PRF, pbe_nid, NULL, NULL, 0)) {
+                BIO_printf(bio_err,
+                           &quot;%s: Unknown PRF algorithm %s\n&quot;, prog, opt_arg());
+                goto opthelp;
+            }
+            break;
+        case OPT_ITER:
+            if (!opt_int(opt_arg(), &amp;iter))
+                goto opthelp;
+            break;
+        case OPT_PASSIN:
+            passinarg = opt_arg();
+            break;
+        case OPT_PASSOUT:
+            passoutarg = opt_arg();
+            break;
+        case OPT_ENGINE:
+            engine = opt_arg();
+            break;
         }
-#endif
-        else if (!strcmp(*args, &quot;-in&quot;)) {
-            if (args[1]) {
-                args++;
-                infile = *args;
-            } else
-                badarg = 1;
-        } else if (!strcmp(*args, &quot;-out&quot;)) {
-            if (args[1]) {
-                args++;
-                outfile = *args;
-            } else
-                badarg = 1;
-        } else
-            badarg = 1;
-        args++;
     }
+    argc = opt_num_rest();
+    argv = opt_rest();
 
-    if (badarg) {
-        BIO_printf(bio_err, &quot;Usage pkcs8 [options]\n&quot;);
-        BIO_printf(bio_err, &quot;where options are\n&quot;);
-        BIO_printf(bio_err, &quot;-in file        input file\n&quot;);
-        BIO_printf(bio_err, &quot;-inform X       input format (DER or PEM)\n&quot;);
-        BIO_printf(bio_err,
-                   &quot;-passin arg     input file pass phrase source\n&quot;);
-        BIO_printf(bio_err, &quot;-outform X      output format (DER or PEM)\n&quot;);
-        BIO_printf(bio_err, &quot;-out file       output file\n&quot;);
-        BIO_printf(bio_err,
-                   &quot;-passout arg    output file pass phrase source\n&quot;);
-        BIO_printf(bio_err, &quot;-topk8          output PKCS8 file\n&quot;);
-        BIO_printf(bio_err,
-                   &quot;-nooct          use (nonstandard) no octet format\n&quot;);
-        BIO_printf(bio_err,
-                   &quot;-embed          use (nonstandard) embedded DSA parameters format\n&quot;);
-        BIO_printf(bio_err,
-                   &quot;-nsdb           use (nonstandard) DSA Netscape DB format\n&quot;);
-        BIO_printf(bio_err, &quot;-iter count     use count as iteration count\n&quot;);
-        BIO_printf(bio_err, &quot;-noiter         use 1 as iteration count\n&quot;);
-        BIO_printf(bio_err,
-                   &quot;-nocrypt        use or expect unencrypted private key\n&quot;);
-        BIO_printf(bio_err,
-                   &quot;-v2 alg         use PKCS#5 v2.0 and cipher \&quot;alg\&quot;\n&quot;);
-        BIO_printf(bio_err,
-                   &quot;-v1 obj         use PKCS#5 v1.5 and cipher \&quot;alg\&quot;\n&quot;);
 #ifndef OPENSSL_NO_ENGINE
-        BIO_printf(bio_err,
-                   &quot; -engine e       use engine e, possibly a hardware device.\n&quot;);
-#endif
-        goto end;
-    }
-#ifndef OPENSSL_NO_ENGINE
-    e = setup_engine(bio_err, engine, 0);
+    e = setup_engine(engine, 0);
 #endif
 
-    if (!app_passwd(bio_err, passargin, passargout, &amp;passin, &amp;passout)) {
+    if (!app_passwd(passinarg, passoutarg, &amp;passin, &amp;passout)) {
         BIO_printf(bio_err, &quot;Error getting passwords\n&quot;);
         goto end;
     }
@@ -246,30 +207,14 @@ int MAIN(int argc, char **argv)
     if ((pbe_nid == -1) &amp;&amp; !cipher)
         pbe_nid = NID_pbeWithMD5AndDES_CBC;
 
-    if (infile) {
-        if (!(in = BIO_new_file(infile, &quot;rb&quot;))) {
-            BIO_printf(bio_err, &quot;Can't open input file %s\n&quot;, infile);
-            goto end;
-        }
-    } else
-        in = BIO_new_fp(stdin, BIO_NOCLOSE);
-
-    if (outfile) {
-        if (!(out = BIO_new_file(outfile, &quot;wb&quot;))) {
-            BIO_printf(bio_err, &quot;Can't open output file %s\n&quot;, outfile);
-            goto end;
-        }
-    } else {
-        out = BIO_new_fp(stdout, BIO_NOCLOSE);
-#ifdef OPENSSL_SYS_VMS
-        {
-            BIO *tmpbio = BIO_new(BIO_f_linebuffer());
-            out = BIO_push(tmpbio, out);
-        }
-#endif
-    }
+    in = bio_open_default(infile, &quot;rb&quot;);
+    if (in == NULL)
+        goto end;
+    out = bio_open_default(outfile, &quot;wb&quot;);
+    if (out == NULL)
+        goto end;
     if (topk8) {
-        pkey = load_key(bio_err, infile, informat, 1, passin, e, &quot;key&quot;);
+        pkey = load_key(infile, informat, 1, passin, e, &quot;key&quot;);
         if (!pkey)
             goto end;
         if (!(p8inf = EVP_PKEY2PKCS8_broken(pkey, p8_broken))) {
@@ -295,7 +240,7 @@ int MAIN(int argc, char **argv)
                     (pass, sizeof pass, &quot;Enter Encryption Password:&quot;, 1))
                     goto end;
             }
-            app_RAND_load_file(NULL, bio_err, 0);
+            app_RAND_load_file(NULL, 0);
             if (!(p8 = PKCS8_encrypt(pbe_nid, cipher,
                                      p8pass, strlen(p8pass),
                                      NULL, 0, iter, p8inf))) {
@@ -303,7 +248,7 @@ int MAIN(int argc, char **argv)
                 ERR_print_errors(bio_err);
                 goto end;
             }
-            app_RAND_write_file(NULL, bio_err);
+            app_RAND_write_file(NULL);
             if (outformat == FORMAT_PEM)
                 PEM_write_bio_PKCS8(out, p8);
             else if (outformat == FORMAT_ASN1)
diff --git a/apps/pkey.c b/apps/pkey.c
index e848049..3597be0 100644
--- a/apps/pkey.c
+++ b/apps/pkey.c
@@ -1,4 +1,3 @@
-/* apps/pkey.c */
 /*
  * Written by Dr Stephen N Henson (<A HREF="../../../mailman/listinfo/openssl-commits.html">steve at openssl.org</A>) for the OpenSSL project
  * 2006
@@ -63,150 +62,121 @@
 #include &lt;openssl/err.h&gt;
 #include &lt;openssl/evp.h&gt;
 
-#define PROG pkey_main
-
-int MAIN(int, char **);
+typedef enum OPTION_choice {
+    OPT_ERR = -1, OPT_EOF = 0, OPT_HELP,
+    OPT_INFORM, OPT_OUTFORM, OPT_PASSIN, OPT_PASSOUT, OPT_ENGINE,
+    OPT_IN, OPT_OUT, OPT_PUBIN, OPT_PUBOUT, OPT_TEXT_PUB,
+    OPT_TEXT, OPT_NOOUT, OPT_MD
+} OPTION_CHOICE;
+
+OPTIONS pkey_options[] = {
+    {&quot;help&quot;, OPT_HELP, '-', &quot;Display this summary&quot;},
+    {&quot;inform&quot;, OPT_INFORM, 'F', &quot;Input format (DER or PEM)&quot;},
+    {&quot;outform&quot;, OPT_OUTFORM, 'F', &quot;Output format (DER or PEM)&quot;},
+    {&quot;passin&quot;, OPT_PASSIN, 's', &quot;Input file pass phrase source&quot;},
+    {&quot;passout&quot;, OPT_PASSOUT, 's', &quot;Output file pass phrase source&quot;},
+    {&quot;in&quot;, OPT_IN, '&lt;', &quot;Input file&quot;},
+    {&quot;out&quot;, OPT_OUT, '&gt;', &quot;Output file&quot;},
+    {&quot;pubin&quot;, OPT_PUBIN, '-',
+     &quot;Read public key from input (default is private key)&quot;},
+    {&quot;pubout&quot;, OPT_PUBOUT, '-', &quot;Output public key, not private&quot;},
+    {&quot;text_pub&quot;, OPT_TEXT_PUB, '-', &quot;Only output public key components&quot;},
+    {&quot;text&quot;, OPT_TEXT, '-', &quot;Output in plaintext as well&quot;},
+    {&quot;noout&quot;, OPT_NOOUT, '-', &quot;Don't output the key&quot;},
+    {&quot;&quot;, OPT_MD, '-', &quot;Any supported cipher&quot;},
+#ifndef OPENSSL_NO_ENGINE
+    {&quot;engine&quot;, OPT_ENGINE, 's', &quot;Use engine, possibly a hardware device&quot;},
+#endif
+    {NULL}
+};
 
-int MAIN(int argc, char **argv)
+int pkey_main(int argc, char **argv)
 {
-    ENGINE *e = NULL;
-    char **args, *infile = NULL, *outfile = NULL;
-    char *passargin = NULL, *passargout = NULL;
     BIO *in = NULL, *out = NULL;
-    const EVP_CIPHER *cipher = NULL;
-    int informat, outformat;
-    int pubin = 0, pubout = 0, pubtext = 0, text = 0, noout = 0;
+    ENGINE *e = NULL;
     EVP_PKEY *pkey = NULL;
-    char *passin = NULL, *passout = NULL;
-    int badarg = 0;
-#ifndef OPENSSL_NO_ENGINE
-    char *engine = NULL;
-#endif
-    int ret = 1;
-
-    if (bio_err == NULL)
-        bio_err = BIO_new_fp(stderr, BIO_NOCLOSE);
-
-    if (!load_config(bio_err, NULL))
-        goto end;
-
-    informat = FORMAT_PEM;
-    outformat = FORMAT_PEM;
-
-    ERR_load_crypto_strings();
-    OpenSSL_add_all_algorithms();
-    args = argv + 1;
-    while (!badarg &amp;&amp; *args &amp;&amp; *args[0] == '-') {
-        if (!strcmp(*args, &quot;-inform&quot;)) {
-            if (args[1]) {
-                args++;
-                informat = str2fmt(*args);
-            } else
-                badarg = 1;
-        } else if (!strcmp(*args, &quot;-outform&quot;)) {
-            if (args[1]) {
-                args++;
-                outformat = str2fmt(*args);
-            } else
-                badarg = 1;
-        } else if (!strcmp(*args, &quot;-passin&quot;)) {
-            if (!args[1])
-                goto bad;
-            passargin = *(++args);
-        } else if (!strcmp(*args, &quot;-passout&quot;)) {
-            if (!args[1])
-                goto bad;
-            passargout = *(++args);
-        }
-#ifndef OPENSSL_NO_ENGINE
-        else if (strcmp(*args, &quot;-engine&quot;) == 0) {
-            if (!args[1])
-                goto bad;
-            engine = *(++args);
-        }
-#endif
-        else if (!strcmp(*args, &quot;-in&quot;)) {
-            if (args[1]) {
-                args++;
-                infile = *args;
-            } else
-                badarg = 1;
-        } else if (!strcmp(*args, &quot;-out&quot;)) {
-            if (args[1]) {
-                args++;
-                outfile = *args;
-            } else
-                badarg = 1;
-        } else if (strcmp(*args, &quot;-pubin&quot;) == 0) {
-            pubin = 1;
-            pubout = 1;
-            pubtext = 1;
-        } else if (strcmp(*args, &quot;-pubout&quot;) == 0)
+    const EVP_CIPHER *cipher = NULL;
+    char *infile = NULL, *outfile = NULL, *passin = NULL, *passout = NULL;
+    char *passinarg = NULL, *passoutarg = NULL, *prog, *engine = NULL;
+    OPTION_CHOICE o;
+    int informat = FORMAT_PEM, outformat = FORMAT_PEM;
+    int pubin = 0, pubout = 0, pubtext = 0, text = 0, noout = 0, ret = 1;
+
+    prog = opt_init(argc, argv, pkey_options);
+    while ((o = opt_next()) != OPT_EOF) {
+        switch (o) {
+        case OPT_EOF:
+        case OPT_ERR:
+ opthelp:
+            BIO_printf(bio_err, &quot;%s: Use -help for summary.\n&quot;, prog);
+            goto end;
+        case OPT_HELP:
+            opt_help(pkey_options);
+            ret = 0;
+            goto end;
+        case OPT_INFORM:
+            if (!opt_format(opt_arg(), OPT_FMT_PEMDER, &amp;informat))
+                goto opthelp;
+            break;
+        case OPT_OUTFORM:
+            if (!opt_format(opt_arg(), OPT_FMT_PEMDER, &amp;outformat))
+                goto opthelp;
+            break;
+        case OPT_PASSIN:
+            passinarg = opt_arg();
+            break;
+        case OPT_PASSOUT:
+            passoutarg = opt_arg();
+            break;
+        case OPT_ENGINE:
+            engine = opt_arg();
+            break;
+        case OPT_IN:
+            infile = opt_arg();
+            break;
+        case OPT_OUT:
+            outfile = opt_arg();
+            break;
+        case OPT_PUBIN:
+            pubin = pubout = pubtext = 1;
+            break;
+        case OPT_PUBOUT:
             pubout = 1;
-        else if (strcmp(*args, &quot;-text_pub&quot;) == 0) {
-            pubtext = 1;
-            text = 1;
-        } else if (strcmp(*args, &quot;-text&quot;) == 0)
+            break;
+        case OPT_TEXT_PUB:
+            pubtext = text = 1;
+            break;
+        case OPT_TEXT:
             text = 1;
-        else if (strcmp(*args, &quot;-noout&quot;) == 0)
+            break;
+        case OPT_NOOUT:
             noout = 1;
-        else {
-            cipher = EVP_get_cipherbyname(*args + 1);
-            if (!cipher) {
-                BIO_printf(bio_err, &quot;Unknown cipher %s\n&quot;, *args + 1);
-                badarg = 1;
-            }
+            break;
+        case OPT_MD:
+            if (!opt_cipher(opt_unknown(), &amp;cipher))
+                goto opthelp;
         }
-        args++;
     }
+    argc = opt_num_rest();
+    argv = opt_rest();
 
-    if (badarg) {
- bad:
-        BIO_printf(bio_err, &quot;Usage pkey [options]\n&quot;);
-        BIO_printf(bio_err, &quot;where options are\n&quot;);
-        BIO_printf(bio_err, &quot;-in file        input file\n&quot;);
-        BIO_printf(bio_err, &quot;-inform X       input format (DER or PEM)\n&quot;);
-        BIO_printf(bio_err,
-                   &quot;-passin arg     input file pass phrase source\n&quot;);
-        BIO_printf(bio_err, &quot;-outform X      output format (DER or PEM)\n&quot;);
-        BIO_printf(bio_err, &quot;-out file       output file\n&quot;);
-        BIO_printf(bio_err,
-                   &quot;-passout arg    output file pass phrase source\n&quot;);
 #ifndef OPENSSL_NO_ENGINE
-        BIO_printf(bio_err,
-                   &quot;-engine e       use engine e, possibly a hardware device.\n&quot;);
-#endif
-        return 1;
-    }
-#ifndef OPENSSL_NO_ENGINE
-    e = setup_engine(bio_err, engine, 0);
+    e = setup_engine(engine, 0);
 #endif
 
-    if (!app_passwd(bio_err, passargin, passargout, &amp;passin, &amp;passout)) {
+    if (!app_passwd(passinarg, passoutarg, &amp;passin, &amp;passout)) {
         BIO_printf(bio_err, &quot;Error getting passwords\n&quot;);
         goto end;
     }
 
-    if (outfile) {
-        if (!(out = BIO_new_file(outfile, &quot;wb&quot;))) {
-            BIO_printf(bio_err, &quot;Can't open output file %s\n&quot;, outfile);
-            goto end;
-        }
-    } else {
-        out = BIO_new_fp(stdout, BIO_NOCLOSE);
-#ifdef OPENSSL_SYS_VMS
-        {
-            BIO *tmpbio = BIO_new(BIO_f_linebuffer());
-            out = BIO_push(tmpbio, out);
-        }
-#endif
-    }
+    out = bio_open_default(outfile, &quot;wb&quot;);
+    if (out == NULL)
+        goto end;
 
     if (pubin)
-        pkey = load_pubkey(bio_err, infile, informat, 1,
-                           passin, e, &quot;Public Key&quot;);
+        pkey = load_pubkey(infile, informat, 1, passin, e, &quot;Public Key&quot;);
     else
-        pkey = load_key(bio_err, infile, informat, 1, passin, e, &quot;key&quot;);
+        pkey = load_key(infile, informat, 1, passin, e, &quot;key&quot;);
     if (!pkey)
         goto end;
 
diff --git a/apps/pkeyparam.c b/apps/pkeyparam.c
index a148a66..5a5caf5 100644
--- a/apps/pkeyparam.c
+++ b/apps/pkeyparam.c
@@ -1,4 +1,3 @@
-/* apps/pkeyparam.c */
 /*
  * Written by Dr Stephen N Henson (<A HREF="../../../mailman/listinfo/openssl-commits.html">steve at openssl.org</A>) for the OpenSSL project
  * 2006
@@ -63,104 +62,72 @@
 #include &lt;openssl/err.h&gt;
 #include &lt;openssl/evp.h&gt;
 
-#define PROG pkeyparam_main
-
-int MAIN(int, char **);
+typedef enum OPTION_choice {
+    OPT_ERR = -1, OPT_EOF = 0, OPT_HELP,
+    OPT_IN, OPT_OUT, OPT_TEXT, OPT_NOOUT, OPT_ENGINE
+} OPTION_CHOICE;
+
+OPTIONS pkeyparam_options[] = {
+    {&quot;help&quot;, OPT_HELP, '-', &quot;Display this summary&quot;},
+    {&quot;in&quot;, OPT_IN, '&lt;', &quot;Input file&quot;},
+    {&quot;out&quot;, OPT_OUT, '&gt;', &quot;Output file&quot;},
+    {&quot;text&quot;, OPT_TEXT, '-', &quot;Print parameters as text&quot;},
+    {&quot;noout&quot;, OPT_NOOUT, '-', &quot;Don't output encoded parameters&quot;},
+#ifndef OPENSSL_NO_ENGINE
+    {&quot;engine&quot;, OPT_ENGINE, 's', &quot;Use engine, possibly a hardware device&quot;},
+#endif
+    {NULL}
+};
 
-int MAIN(int argc, char **argv)
+int pkeyparam_main(int argc, char **argv)
 {
-    char **args, *infile = NULL, *outfile = NULL;
     BIO *in = NULL, *out = NULL;
-    int text = 0, noout = 0;
     EVP_PKEY *pkey = NULL;
-    int badarg = 0;
-#ifndef OPENSSL_NO_ENGINE
-    char *engine = NULL;
-#endif
-    int ret = 1;
-
-    if (bio_err == NULL)
-        bio_err = BIO_new_fp(stderr, BIO_NOCLOSE);
-
-    if (!load_config(bio_err, NULL))
-        goto end;
-
-    ERR_load_crypto_strings();
-    OpenSSL_add_all_algorithms();
-    args = argv + 1;
-    while (!badarg &amp;&amp; *args &amp;&amp; *args[0] == '-') {
-        if (!strcmp(*args, &quot;-in&quot;)) {
-            if (args[1]) {
-                args++;
-                infile = *args;
-            } else
-                badarg = 1;
-        } else if (!strcmp(*args, &quot;-out&quot;)) {
-            if (args[1]) {
-                args++;
-                outfile = *args;
-            } else
-                badarg = 1;
-        }
-#ifndef OPENSSL_NO_ENGINE
-        else if (strcmp(*args, &quot;-engine&quot;) == 0) {
-            if (!args[1])
-                goto bad;
-            engine = *(++args);
-        }
-#endif
-
-        else if (strcmp(*args, &quot;-text&quot;) == 0)
+    int text = 0, noout = 0, ret = 1;
+    OPTION_CHOICE o;
+    char *infile = NULL, *outfile = NULL, *prog, *engine = NULL;
+
+    prog = opt_init(argc, argv, pkeyparam_options);
+    while ((o = opt_next()) != OPT_EOF) {
+        switch (o) {
+        case OPT_EOF:
+        case OPT_ERR:
+            BIO_printf(bio_err, &quot;%s: Use -help for summary.\n&quot;, prog);
+            goto end;
+        case OPT_HELP:
+            opt_help(pkeyparam_options);
+            ret = 0;
+            goto end;
+        case OPT_IN:
+            infile = opt_arg();
+            break;
+        case OPT_OUT:
+            outfile = opt_arg();
+            break;
+        case OPT_ENGINE:
+            engine = opt_arg();
+            break;
+        case OPT_TEXT:
             text = 1;
-        else if (strcmp(*args, &quot;-noout&quot;) == 0)
+            break;
+        case OPT_NOOUT:
             noout = 1;
-        args++;
+            break;
+        }
     }
+    argc = opt_num_rest();
+    argv = opt_rest();
 
-    if (badarg) {
 #ifndef OPENSSL_NO_ENGINE
- bad:
+    setup_engine(engine, 0);
 #endif
-        BIO_printf(bio_err, &quot;Usage pkeyparam [options]\n&quot;);
-        BIO_printf(bio_err, &quot;where options are\n&quot;);
-        BIO_printf(bio_err, &quot;-in file        input file\n&quot;);
-        BIO_printf(bio_err, &quot;-out file       output file\n&quot;);
-        BIO_printf(bio_err, &quot;-text           print parameters as text\n&quot;);
-        BIO_printf(bio_err,
-                   &quot;-noout          don't output encoded parameters\n&quot;);
-#ifndef OPENSSL_NO_ENGINE
-        BIO_printf(bio_err,
-                   &quot;-engine e       use engine e, possibly a hardware device.\n&quot;);
-#endif
-        return 1;
-    }
-#ifndef OPENSSL_NO_ENGINE
-    setup_engine(bio_err, engine, 0);
-#endif
-
-    if (infile) {
-        if (!(in = BIO_new_file(infile, &quot;r&quot;))) {
-            BIO_printf(bio_err, &quot;Can't open input file %s\n&quot;, infile);
-            goto end;
-        }
-    } else
-        in = BIO_new_fp(stdin, BIO_NOCLOSE);
-
-    if (outfile) {
-        if (!(out = BIO_new_file(outfile, &quot;w&quot;))) {
-            BIO_printf(bio_err, &quot;Can't open output file %s\n&quot;, outfile);
-            goto end;
-        }
-    } else {
-        out = BIO_new_fp(stdout, BIO_NOCLOSE);
-#ifdef OPENSSL_SYS_VMS
-        {
-            BIO *tmpbio = BIO_new(BIO_f_linebuffer());
-            out = BIO_push(tmpbio, out);
-        }
-#endif
-    }
 
+    in = bio_open_default(infile, &quot;r&quot;);
+    if (in == NULL)
+        goto end;
+    out = bio_open_default(outfile, &quot;w&quot;);
+    if (out == NULL)
+        goto end;
     pkey = PEM_read_bio_Parameters(in, NULL);
     if (!pkey) {
         BIO_printf(bio_err, &quot;Error reading parameters\n&quot;);
diff --git a/apps/pkeyutl.c b/apps/pkeyutl.c
index 1028686..942ba05 100644
--- a/apps/pkeyutl.c
+++ b/apps/pkeyutl.c
@@ -66,200 +66,194 @@
 #define KEY_PUBKEY      2
 #define KEY_CERT        3
 
-static void usage(void);
-
-#undef PROG
-
-#define PROG pkeyutl_main
-
 static EVP_PKEY_CTX *init_ctx(int *pkeysize,
                               char *keyfile, int keyform, int key_type,
-                              char *passargin, int pkey_op, ENGINE *e);
+                              char *passinarg, int pkey_op, ENGINE *e);
 
-static int setup_peer(BIO *err, EVP_PKEY_CTX *ctx, int peerform,
-                      const char *file);
+static int setup_peer(EVP_PKEY_CTX *ctx, int peerform, const char *file);
 
 static int do_keyop(EVP_PKEY_CTX *ctx, int pkey_op,
                     unsigned char *out, size_t *poutlen,
                     unsigned char *in, size_t inlen);
 
-int MAIN(int argc, char **);
+typedef enum OPTION_choice {
+    OPT_ERR = -1, OPT_EOF = 0, OPT_HELP,
+    OPT_ENGINE, OPT_IN, OPT_OUT,
+    OPT_PUBIN, OPT_CERTIN, OPT_ASN1PARSE, OPT_HEXDUMP, OPT_SIGN,
+    OPT_VERIFY, OPT_VERIFYRECOVER, OPT_REV, OPT_ENCRYPT, OPT_DECRYPT,
+    OPT_DERIVE, OPT_SIGFILE, OPT_INKEY, OPT_PEERKEY, OPT_PASSIN,
+    OPT_PEERFORM, OPT_KEYFORM, OPT_PKEYOPT
+} OPTION_CHOICE;
+
+OPTIONS pkeyutl_options[] = {
+    {&quot;help&quot;, OPT_HELP, '-', &quot;Display this summary&quot;},
+    {&quot;in&quot;, OPT_IN, '&lt;', &quot;Input file&quot;},
+    {&quot;out&quot;, OPT_OUT, '&gt;', &quot;Output file&quot;},
+    {&quot;pubin&quot;, OPT_PUBIN, '-', &quot;Input is a public key&quot;},
+    {&quot;certin&quot;, OPT_CERTIN, '-', &quot;Input is a cert with a public key&quot;},
+    {&quot;asn1parse&quot;, OPT_ASN1PARSE, '-'},
+    {&quot;hexdump&quot;, OPT_HEXDUMP, '-', &quot;Hex dump output&quot;},
+    {&quot;sign&quot;, OPT_SIGN, '-', &quot;Sign with private key&quot;},
+    {&quot;verify&quot;, OPT_VERIFY, '-', &quot;Verify with public key&quot;},
+    {&quot;verifyrecover&quot;, OPT_VERIFYRECOVER, '-',
+     &quot;Verify with public key, recover original data&quot;},
+    {&quot;rev&quot;, OPT_REV, '-'},
+    {&quot;encrypt&quot;, OPT_ENCRYPT, '-', &quot;Encrypt with public key&quot;},
+    {&quot;decrypt&quot;, OPT_DECRYPT, '-', &quot;Decrypt with private key&quot;},
+    {&quot;derive&quot;, OPT_DERIVE, '-', &quot;Derive shared secret&quot;},
+    {&quot;sigfile&quot;, OPT_SIGFILE, '&lt;', &quot;Signature file (verify operation only)&quot;},
+    {&quot;inkey&quot;, OPT_INKEY, 's', &quot;Input key&quot;},
+    {&quot;peerkey&quot;, OPT_PEERKEY, 's'},
+    {&quot;passin&quot;, OPT_PASSIN, 's', &quot;Pass phrase source&quot;},
+    {&quot;peerform&quot;, OPT_PEERFORM, 'F'},
+    {&quot;keyform&quot;, OPT_KEYFORM, 'F', &quot;Private key format - default PEM&quot;},
+    {&quot;pkeyopt&quot;, OPT_PKEYOPT, 's', &quot;Public key options as opt:value&quot;},
+#ifndef OPENSSL_NO_ENGINE
+    {&quot;engine&quot;, OPT_ENGINE, 's', &quot;Use engine, possibly a hardware device&quot;},
+#endif
+    {NULL}
+};
 
-int MAIN(int argc, char **argv)
+int pkeyutl_main(int argc, char **argv)
 {
     BIO *in = NULL, *out = NULL;
-    char *infile = NULL, *outfile = NULL, *sigfile = NULL;
     ENGINE *e = NULL;
-    int pkey_op = EVP_PKEY_OP_SIGN, key_type = KEY_PRIVKEY;
-    int keyform = FORMAT_PEM, peerform = FORMAT_PEM;
-    char badarg = 0, rev = 0;
-    char hexdump = 0, asn1parse = 0;
     EVP_PKEY_CTX *ctx = NULL;
-    char *passargin = NULL;
-    int keysize = -1;
-
+    char *infile = NULL, *outfile = NULL, *sigfile = NULL, *passinarg = NULL;
+    char hexdump = 0, asn1parse = 0, rev = 0, *prog;
     unsigned char *buf_in = NULL, *buf_out = NULL, *sig = NULL;
-    size_t buf_outlen;
-    int buf_inlen = 0, siglen = -1;
-
+    OPTION_CHOICE o;
+    int buf_inlen = 0, siglen = -1, keyform = FORMAT_PEM, peerform =
+        FORMAT_PEM;
+    int keysize = -1, pkey_op = EVP_PKEY_OP_SIGN, key_type = KEY_PRIVKEY;
     int ret = 1, rv = -1;
+    size_t buf_outlen;
 
-    argc--;
-    argv++;
-
-    if (!bio_err)
-        bio_err = BIO_new_fp(stderr, BIO_NOCLOSE);
-
-    if (!load_config(bio_err, NULL))
-        goto end;
-    ERR_load_crypto_strings();
-    OpenSSL_add_all_algorithms();
-
-    while (argc &gt;= 1) {
-        if (!strcmp(*argv, &quot;-in&quot;)) {
-            if (--argc &lt; 1)
-                badarg = 1;
-            else
-                infile = *(++argv);
-        } else if (!strcmp(*argv, &quot;-out&quot;)) {
-            if (--argc &lt; 1)
-                badarg = 1;
-            else
-                outfile = *(++argv);
-        } else if (!strcmp(*argv, &quot;-sigfile&quot;)) {
-            if (--argc &lt; 1)
-                badarg = 1;
-            else
-                sigfile = *(++argv);
-        } else if (!strcmp(*argv, &quot;-inkey&quot;)) {
-            if (--argc &lt; 1)
-                badarg = 1;
-            else {
-                ctx = init_ctx(&amp;keysize,
-                               *(++argv), keyform, key_type,
-                               passargin, pkey_op, e);
-                if (!ctx) {
-                    BIO_puts(bio_err, &quot;Error initializing context\n&quot;);
-                    ERR_print_errors(bio_err);
-                    badarg = 1;
-                }
+    prog = opt_init(argc, argv, pkeyutl_options);
+    while ((o = opt_next()) != OPT_EOF) {
+        switch (o) {
+        case OPT_EOF:
+        case OPT_ERR:
+ opthelp:
+            BIO_printf(bio_err, &quot;%s: Use -help for summary.\n&quot;, prog);
+            goto end;
+        case OPT_HELP:
+            opt_help(pkeyutl_options);
+            ret = 0;
+            goto end;
+        case OPT_IN:
+            infile = opt_arg();
+            break;
+        case OPT_OUT:
+            outfile = opt_arg();
+            break;
+        case OPT_SIGFILE:
+            sigfile = opt_arg();
+            break;
+        case OPT_INKEY:
+            ctx = init_ctx(&amp;keysize, opt_arg(), keyform, key_type,
+                           passinarg, pkey_op, e);
+            if (ctx == NULL) {
+                BIO_puts(bio_err, &quot;%s: Error initializing context\n&quot;);
+                ERR_print_errors(bio_err);
+                goto opthelp;
             }
-        } else if (!strcmp(*argv, &quot;-peerkey&quot;)) {
-            if (--argc &lt; 1)
-                badarg = 1;
-            else if (!setup_peer(bio_err, ctx, peerform, *(++argv)))
-                badarg = 1;
-        } else if (!strcmp(*argv, &quot;-passin&quot;)) {
-            if (--argc &lt; 1)
-                badarg = 1;
-            else
-                passargin = *(++argv);
-        } else if (strcmp(*argv, &quot;-peerform&quot;) == 0) {
-            if (--argc &lt; 1)
-                badarg = 1;
-            else
-                peerform = str2fmt(*(++argv));
-        } else if (strcmp(*argv, &quot;-keyform&quot;) == 0) {
-            if (--argc &lt; 1)
-                badarg = 1;
-            else
-                keyform = str2fmt(*(++argv));
-        }
+            break;
+        case OPT_PEERKEY:
+            if (!setup_peer(ctx, peerform, opt_arg()))
+                goto opthelp;
+            break;
+        case OPT_PASSIN:
+            passinarg = opt_arg();
+            break;
+        case OPT_PEERFORM:
+            if (!opt_format(opt_arg(), OPT_FMT_PEMDER, &amp;peerform))
+                goto opthelp;
+            break;
+        case OPT_KEYFORM:
+            if (!opt_format(opt_arg(), OPT_FMT_PEMDER, &amp;keyform))
+                goto opthelp;
+            break;
 #ifndef OPENSSL_NO_ENGINE
-        else if (!strcmp(*argv, &quot;-engine&quot;)) {
-            if (--argc &lt; 1)
-                badarg = 1;
-            else
-                e = setup_engine(bio_err, *(++argv), 0);
-        }
+        case OPT_ENGINE:
+            e = setup_engine(opt_arg(), 0);
+            break;
 #endif
-        else if (!strcmp(*argv, &quot;-pubin&quot;))
+        case OPT_PUBIN:
             key_type = KEY_PUBKEY;
-        else if (!strcmp(*argv, &quot;-certin&quot;))
+            break;
+        case OPT_CERTIN:
             key_type = KEY_CERT;
-        else if (!strcmp(*argv, &quot;-asn1parse&quot;))
+            break;
+        case OPT_ASN1PARSE:
             asn1parse = 1;
-        else if (!strcmp(*argv, &quot;-hexdump&quot;))
+            break;
+        case OPT_HEXDUMP:
             hexdump = 1;
-        else if (!strcmp(*argv, &quot;-sign&quot;))
+            break;
+        case OPT_SIGN:
             pkey_op = EVP_PKEY_OP_SIGN;
-        else if (!strcmp(*argv, &quot;-verify&quot;))
+            break;
+        case OPT_VERIFY:
             pkey_op = EVP_PKEY_OP_VERIFY;
-        else if (!strcmp(*argv, &quot;-verifyrecover&quot;))
+            break;
+        case OPT_VERIFYRECOVER:
             pkey_op = EVP_PKEY_OP_VERIFYRECOVER;
-        else if (!strcmp(*argv, &quot;-rev&quot;))
+            break;
+        case OPT_REV:
             rev = 1;
-        else if (!strcmp(*argv, &quot;-encrypt&quot;))
+        case OPT_ENCRYPT:
             pkey_op = EVP_PKEY_OP_ENCRYPT;
-        else if (!strcmp(*argv, &quot;-decrypt&quot;))
+            break;
+        case OPT_DECRYPT:
             pkey_op = EVP_PKEY_OP_DECRYPT;
-        else if (!strcmp(*argv, &quot;-derive&quot;))
+            break;
+        case OPT_DERIVE:
             pkey_op = EVP_PKEY_OP_DERIVE;
-        else if (strcmp(*argv, &quot;-pkeyopt&quot;) == 0) {
-            if (--argc &lt; 1)
-                badarg = 1;
-            else if (!ctx) {
-                BIO_puts(bio_err, &quot;-pkeyopt command before -inkey\n&quot;);
-                badarg = 1;
-            } else if (pkey_ctrl_string(ctx, *(++argv)) &lt;= 0) {
-                BIO_puts(bio_err, &quot;parameter setting error\n&quot;);
+            break;
+        case OPT_PKEYOPT:
+            if (ctx == NULL) {
+                BIO_printf(bio_err,
+                           &quot;%s: Must have -inkey before -pkeyopt\n&quot;, prog);
+                goto opthelp;
+            }
+            if (pkey_ctrl_string(ctx, opt_arg()) &lt;= 0) {
+                BIO_printf(bio_err, &quot;%s: Can't set parameter:\n&quot;, prog);
                 ERR_print_errors(bio_err);
                 goto end;
             }
-        } else
-            badarg = 1;
-        if (badarg) {
-            usage();
-            goto end;
+            break;
         }
-        argc--;
-        argv++;
     }
+    argc = opt_num_rest();
+    argv = opt_rest();
 
-    if (!ctx) {
-        usage();
-        goto end;
-    }
+    if (ctx == NULL)
+        goto opthelp;
 
     if (sigfile &amp;&amp; (pkey_op != EVP_PKEY_OP_VERIFY)) {
-        BIO_puts(bio_err, &quot;Signature file specified for non verify\n&quot;);
+        BIO_printf(bio_err,
+                   &quot;%s: Signature file specified for non verify\n&quot;, prog);
         goto end;
     }
 
     if (!sigfile &amp;&amp; (pkey_op == EVP_PKEY_OP_VERIFY)) {
-        BIO_puts(bio_err, &quot;No signature file specified for verify\n&quot;);
+        BIO_printf(bio_err,
+                   &quot;%s: No signature file specified for verify\n&quot;, prog);
         goto end;
     }
 
 /* FIXME: seed PRNG only if needed */
-    app_RAND_load_file(NULL, bio_err, 0);
+    app_RAND_load_file(NULL, 0);
 
     if (pkey_op != EVP_PKEY_OP_DERIVE) {
-        if (infile) {
-            if (!(in = BIO_new_file(infile, &quot;rb&quot;))) {
-                BIO_puts(bio_err, &quot;Error Opening Input File\n&quot;);
-                ERR_print_errors(bio_err);
-                goto end;
-            }
-        } else
-            in = BIO_new_fp(stdin, BIO_NOCLOSE);
-    }
-
-    if (outfile) {
-        if (!(out = BIO_new_file(outfile, &quot;wb&quot;))) {
-            BIO_printf(bio_err, &quot;Error Creating Output File\n&quot;);
-            ERR_print_errors(bio_err);
+        in = bio_open_default(infile, &quot;rb&quot;);
+        if (in == NULL)
             goto end;
-        }
-    } else {
-        out = BIO_new_fp(stdout, BIO_NOCLOSE);
-#ifdef OPENSSL_SYS_VMS
-        {
-            BIO *tmpbio = BIO_new(BIO_f_linebuffer());
-            out = BIO_push(tmpbio, out);
-        }
-#endif
     }
+    out = bio_open_default(outfile, &quot;wb&quot;);
+    if (out == NULL)
+        goto end;
 
     if (sigfile) {
         BIO *sigbio = BIO_new_file(sigfile, &quot;rb&quot;);
@@ -297,32 +291,30 @@ int MAIN(int argc, char **argv)
     if (pkey_op == EVP_PKEY_OP_VERIFY) {
         rv = EVP_PKEY_verify(ctx, sig, (size_t)siglen,
                              buf_in, (size_t)buf_inlen);
-        if (rv == 0)
-            BIO_puts(out, &quot;Signature Verification Failure\n&quot;);
-        else if (rv == 1)
+        if (rv == 1) {
             BIO_puts(out, &quot;Signature Verified Successfully\n&quot;);
-        if (rv &gt;= 0)
-            goto end;
-    } else {
-        rv = do_keyop(ctx, pkey_op, NULL, (size_t *)&amp;buf_outlen,
-                      buf_in, (size_t)buf_inlen);
-        if (rv &gt; 0) {
-            buf_out = OPENSSL_malloc(buf_outlen);
-            if (!buf_out)
-                rv = -1;
-            else
-                rv = do_keyop(ctx, pkey_op,
-                              buf_out, (size_t *)&amp;buf_outlen,
-                              buf_in, (size_t)buf_inlen);
-        }
+            ret = 0;
+        } else
+            BIO_puts(out, &quot;Signature Verification Failure\n&quot;);
+        goto end;
+    }
+    rv = do_keyop(ctx, pkey_op, NULL, (size_t *)&amp;buf_outlen,
+                  buf_in, (size_t)buf_inlen);
+    if (rv &gt; 0) {
+        buf_out = OPENSSL_malloc(buf_outlen);
+        if (!buf_out)
+            rv = -1;
+        else
+            rv = do_keyop(ctx, pkey_op,
+                          buf_out, (size_t *)&amp;buf_outlen,
+                          buf_in, (size_t)buf_inlen);
     }
-
     if (rv &lt;= 0) {
-        BIO_printf(bio_err, &quot;Public Key operation error\n&quot;);
         ERR_print_errors(bio_err);
         goto end;
     }
     ret = 0;
+
     if (asn1parse) {
         if (!ASN1_parse_dump(out, buf_out, buf_outlen, 1, -1))
             ERR_print_errors(bio_err);
@@ -344,38 +336,9 @@ int MAIN(int argc, char **argv)
     return ret;
 }
 
-static void usage()
-{
-    BIO_printf(bio_err, &quot;Usage: pkeyutl [options]\n&quot;);
-    BIO_printf(bio_err, &quot;-in file        input file\n&quot;);
-    BIO_printf(bio_err, &quot;-out file       output file\n&quot;);
-    BIO_printf(bio_err,
-               &quot;-sigfile file signature file (verify operation only)\n&quot;);
-    BIO_printf(bio_err, &quot;-inkey file     input key\n&quot;);
-    BIO_printf(bio_err, &quot;-keyform arg    private key format - default PEM\n&quot;);
-    BIO_printf(bio_err, &quot;-pubin          input is a public key\n&quot;);
-    BIO_printf(bio_err,
-               &quot;-certin         input is a certificate carrying a public key\n&quot;);
-    BIO_printf(bio_err, &quot;-pkeyopt X:Y    public key options\n&quot;);
-    BIO_printf(bio_err, &quot;-sign           sign with private key\n&quot;);
-    BIO_printf(bio_err, &quot;-verify         verify with public key\n&quot;);
-    BIO_printf(bio_err,
-               &quot;-verifyrecover  verify with public key, recover original data\n&quot;);
-    BIO_printf(bio_err, &quot;-encrypt        encrypt with public key\n&quot;);
-    BIO_printf(bio_err, &quot;-decrypt        decrypt with private key\n&quot;);
-    BIO_printf(bio_err, &quot;-derive         derive shared secret\n&quot;);
-    BIO_printf(bio_err, &quot;-hexdump        hex dump output\n&quot;);
-#ifndef OPENSSL_NO_ENGINE
-    BIO_printf(bio_err,
-               &quot;-engine e       use engine e, possibly a hardware device.\n&quot;);
-#endif
-    BIO_printf(bio_err, &quot;-passin arg     pass phrase source\n&quot;);
-
-}
-
 static EVP_PKEY_CTX *init_ctx(int *pkeysize,
                               char *keyfile, int keyform, int key_type,
-                              char *passargin, int pkey_op, ENGINE *e)
+                              char *passinarg, int pkey_op, ENGINE *e)
 {
     EVP_PKEY *pkey = NULL;
     EVP_PKEY_CTX *ctx = NULL;
@@ -388,23 +351,21 @@ static EVP_PKEY_CTX *init_ctx(int *pkeysize,
         BIO_printf(bio_err, &quot;A private key is needed for this operation\n&quot;);
         goto end;
     }
-    if (!app_passwd(bio_err, passargin, NULL, &amp;passin, NULL)) {
+    if (!app_passwd(passinarg, NULL, &amp;passin, NULL)) {
         BIO_printf(bio_err, &quot;Error getting password\n&quot;);
         goto end;
     }
     switch (key_type) {
     case KEY_PRIVKEY:
-        pkey = load_key(bio_err, keyfile, keyform, 0,
-                        passin, e, &quot;Private Key&quot;);
+        pkey = load_key(keyfile, keyform, 0, passin, e, &quot;Private Key&quot;);
         break;
 
     case KEY_PUBKEY:
-        pkey = load_pubkey(bio_err, keyfile, keyform, 0,
-                           NULL, e, &quot;Public Key&quot;);
+        pkey = load_pubkey(keyfile, keyform, 0, NULL, e, &quot;Public Key&quot;);
         break;
 
     case KEY_CERT:
-        x = load_cert(bio_err, keyfile, keyform, NULL, e, &quot;Certificate&quot;);
+        x = load_cert(keyfile, keyform, NULL, e, &quot;Certificate&quot;);
         if (x) {
             pkey = X509_get_pubkey(x);
             X509_free(x);
@@ -465,21 +426,20 @@ static EVP_PKEY_CTX *init_ctx(int *pkeysize,
 
 }
 
-static int setup_peer(BIO *err, EVP_PKEY_CTX *ctx, int peerform,
-                      const char *file)
+static int setup_peer(EVP_PKEY_CTX *ctx, int peerform, const char *file)
 {
     EVP_PKEY *peer = NULL;
     int ret;
     if (!ctx) {
-        BIO_puts(err, &quot;-peerkey command before -inkey\n&quot;);
+        BIO_puts(bio_err, &quot;-peerkey command before -inkey\n&quot;);
         return 0;
     }
 
-    peer = load_pubkey(bio_err, file, peerform, 0, NULL, NULL, &quot;Peer Key&quot;);
+    peer = load_pubkey(file, peerform, 0, NULL, NULL, &quot;Peer Key&quot;);
 
     if (!peer) {
         BIO_printf(bio_err, &quot;Error reading peer key %s\n&quot;, file);
-        ERR_print_errors(err);
+        ERR_print_errors(bio_err);
         return 0;
     }
 
@@ -487,7 +447,7 @@ static int setup_peer(BIO *err, EVP_PKEY_CTX *ctx, int peerform,
 
     EVP_PKEY_free(peer);
     if (ret &lt;= 0)
-        ERR_print_errors(err);
+        ERR_print_errors(bio_err);
     return ret;
 }
 
diff --git a/apps/prime.c b/apps/prime.c
index 1fb1c8d..04a83ab 100644
--- a/apps/prime.c
+++ b/apps/prime.c
@@ -52,67 +52,66 @@
 #include &quot;apps.h&quot;
 #include &lt;openssl/bn.h&gt;
 
-#undef PROG
-#define PROG prime_main
-
-int MAIN(int, char **);
-
-int MAIN(int argc, char **argv)
+typedef enum OPTION_choice {
+    OPT_ERR = -1, OPT_EOF = 0, OPT_HELP,
+    OPT_HEX, OPT_GENERATE, OPT_BITS, OPT_SAFE, OPT_CHECKS
+} OPTION_CHOICE;
+
+OPTIONS prime_options[] = {
+    {OPT_HELP_STR, 1, '-', &quot;Usage: %s [options] [number...]\n&quot;},
+    {OPT_HELP_STR, 1, '-',
+        &quot;  number Number to check for primarility\n&quot;},
+    {&quot;help&quot;, OPT_HELP, '-', &quot;Display this summary&quot;},
+    {&quot;hex&quot;, OPT_HEX, '-', &quot;Hex output&quot;},
+    {&quot;generate&quot;, OPT_GENERATE, '-', &quot;Generate a prime&quot;},
+    {&quot;bits&quot;, OPT_BITS, 'p', &quot;Size of number in bits&quot;},
+    {&quot;safe&quot;, OPT_SAFE, '-',
+     &quot;When used with -generate, generate a safe prime&quot;},
+    {&quot;checks&quot;, OPT_CHECKS, 'p', &quot;Number of checks&quot;},
+    {NULL}
+};
+
+int prime_main(int argc, char **argv)
 {
-    int hex = 0;
-    int checks = 20;
-    int generate = 0;
-    int bits = 0;
-    int safe = 0;
     BIGNUM *bn = NULL;
-    BIO *bio_out;
-
-    apps_startup();
-
-    if (bio_err == NULL)
-        if ((bio_err = BIO_new(BIO_s_file())) != NULL)
-            BIO_set_fp(bio_err, stderr, BIO_NOCLOSE | BIO_FP_TEXT);
-
-    --argc;
-    ++argv;
-    while (argc &gt;= 1 &amp;&amp; **argv == '-') {
-        if (!strcmp(*argv, &quot;-hex&quot;))
+    int hex = 0, checks = 20, generate = 0, bits = 0, safe = 0, ret = 1;
+    char *prog;
+    OPTION_CHOICE o;
+
+    prog = opt_init(argc, argv, prime_options);
+    while ((o = opt_next()) != OPT_EOF) {
+        switch (o) {
+        case OPT_EOF:
+        case OPT_ERR:
+            BIO_printf(bio_err, &quot;%s: Use -help for summary.\n&quot;, prog);
+            goto end;
+        case OPT_HELP:
+            opt_help(prime_options);
+            ret = 0;
+            goto end;
+        case OPT_HEX:
             hex = 1;
-        else if (!strcmp(*argv, &quot;-generate&quot;))
+            break;
+        case OPT_GENERATE:
             generate = 1;
-        else if (!strcmp(*argv, &quot;-bits&quot;))
-            if (--argc &lt; 1)
-                goto bad;
-            else
-                bits = atoi(*++argv);
-        else if (!strcmp(*argv, &quot;-safe&quot;))
+            break;
+        case OPT_BITS:
+            bits = atoi(opt_arg());
+            break;
+        case OPT_SAFE:
             safe = 1;
-        else if (!strcmp(*argv, &quot;-checks&quot;))
-            if (--argc &lt; 1)
-                goto bad;
-            else
-                checks = atoi(*++argv);
-        else {
-            BIO_printf(bio_err, &quot;Unknown option '%s'\n&quot;, *argv);
-            goto bad;
+            break;
+        case OPT_CHECKS:
+            checks = atoi(opt_arg());
+            break;
         }
-        --argc;
-        ++argv;
     }
+    argc = opt_num_rest();
+    argv = opt_rest();
 
-    if (argv[0] == NULL &amp;&amp; !generate) {
-        BIO_printf(bio_err, &quot;No prime specified\n&quot;);
-        goto bad;
-    }
-
-    if ((bio_out = BIO_new(BIO_s_file())) != NULL) {
-        BIO_set_fp(bio_out, stdout, BIO_NOCLOSE);
-#ifdef OPENSSL_SYS_VMS
-        {
-            BIO *tmpbio = BIO_new(BIO_f_linebuffer());
-            bio_out = BIO_push(tmpbio, bio_out);
-        }
-#endif
+    if (argc == 0 &amp;&amp; !generate) {
+        BIO_printf(bio_err, &quot;%s: No prime specified\n&quot;, prog);
+        goto end;
     }
 
     if (generate) {
@@ -120,7 +119,7 @@ int MAIN(int argc, char **argv)
 
         if (!bits) {
             BIO_printf(bio_err, &quot;Specifiy the number of bits.\n&quot;);
-            return 1;
+            goto end;
         }
         bn = BN_new();
         BN_generate_prime_ex(bn, bits, safe, NULL, NULL, NULL);
@@ -128,24 +127,22 @@ int MAIN(int argc, char **argv)
         BIO_printf(bio_out, &quot;%s\n&quot;, s);
         OPENSSL_free(s);
     } else {
-        if (hex)
-            BN_hex2bn(&amp;bn, argv[0]);
-        else
-            BN_dec2bn(&amp;bn, argv[0]);
+        for ( ; *argv; argv++) {
+            if (hex)
+                BN_hex2bn(&amp;bn, argv[0]);
+            else
+                BN_dec2bn(&amp;bn, argv[0]);
 
-        BN_print(bio_out, bn);
-        BIO_printf(bio_out, &quot; is %sprime\n&quot;,
-                   BN_is_prime_ex(bn, checks, NULL, NULL) ? &quot;&quot; : &quot;not &quot;);
+            BN_print(bio_out, bn);
+            BIO_printf(bio_out, &quot; (%s) %s prime\n&quot;,
+                       argv[0],
+                       BN_is_prime_ex(bn, checks, NULL, NULL)
+                           ? &quot;is&quot; : &quot;is not&quot;);
+        }
     }
 
     BN_free(bn);
-    BIO_free_all(bio_out);
-
-    return 0;
 
- bad:
-    BIO_printf(bio_err, &quot;options are\n&quot;);
-    BIO_printf(bio_err, &quot;%-14s hex\n&quot;, &quot;-hex&quot;);
-    BIO_printf(bio_err, &quot;%-14s number of checks\n&quot;, &quot;-checks &lt;n&gt;&quot;);
-    return 1;
+ end:
+    return ret;
 }
diff --git a/apps/progs.h b/apps/progs.h
index 9a8a192..33bdef7 100644
--- a/apps/progs.h
+++ b/apps/progs.h
@@ -1,364 +1,415 @@
-/* apps/progs.h */
-/* automatically generated by progs.pl for openssl.c */
+/*
+ * Automatically generated by progs.pl for openssl.c
+ * Copyright (c) 2008 The OpenSSL Project.  All rights reserved.
+ * See the openssl.c for copyright details.
+ */
+
+typedef enum FUNC_TYPE {
+    FT_none, FT_general, FT_md, FT_cipher, FT_pkey,
+    FT_md_alg, FT_cipher_alg
+} FUNC_TYPE;
+
+typedef struct function_st {
+    FUNC_TYPE type;
+    const char *name;
+    int (*func)(int argc,char *argv[]);
+    const OPTIONS *help;
+} FUNCTION;
 
-extern int verify_main(int argc, char *argv[]);
 extern int asn1parse_main(int argc, char *argv[]);
-extern int req_main(int argc, char *argv[]);
-extern int dgst_main(int argc, char *argv[]);
-extern int dh_main(int argc, char *argv[]);
-extern int dhparam_main(int argc, char *argv[]);
-extern int enc_main(int argc, char *argv[]);
-extern int passwd_main(int argc, char *argv[]);
-extern int gendh_main(int argc, char *argv[]);
-extern int errstr_main(int argc, char *argv[]);
 extern int ca_main(int argc, char *argv[]);
+extern int ciphers_main(int argc, char *argv[]);
+extern int cms_main(int argc, char *argv[]);
 extern int crl_main(int argc, char *argv[]);
-extern int rsa_main(int argc, char *argv[]);
-extern int rsautl_main(int argc, char *argv[]);
+extern int crl2pkcs7_main(int argc, char *argv[]);
+extern int dgst_main(int argc, char *argv[]);
+extern int dhparam_main(int argc, char *argv[]);
 extern int dsa_main(int argc, char *argv[]);
 extern int dsaparam_main(int argc, char *argv[]);
 extern int ec_main(int argc, char *argv[]);
 extern int ecparam_main(int argc, char *argv[]);
-extern int x509_main(int argc, char *argv[]);
-extern int genrsa_main(int argc, char *argv[]);
+extern int enc_main(int argc, char *argv[]);
+extern int engine_main(int argc, char *argv[]);
+extern int errstr_main(int argc, char *argv[]);
 extern int gendsa_main(int argc, char *argv[]);
 extern int genpkey_main(int argc, char *argv[]);
-extern int s_server_main(int argc, char *argv[]);
-extern int s_client_main(int argc, char *argv[]);
-extern int speed_main(int argc, char *argv[]);
-extern int s_time_main(int argc, char *argv[]);
-extern int version_main(int argc, char *argv[]);
-extern int pkcs7_main(int argc, char *argv[]);
-extern int cms_main(int argc, char *argv[]);
-extern int crl2pkcs7_main(int argc, char *argv[]);
-extern int sess_id_main(int argc, char *argv[]);
-extern int ciphers_main(int argc, char *argv[]);
+extern int genrsa_main(int argc, char *argv[]);
 extern int nseq_main(int argc, char *argv[]);
+extern int ocsp_main(int argc, char *argv[]);
+extern int passwd_main(int argc, char *argv[]);
 extern int pkcs12_main(int argc, char *argv[]);
+extern int pkcs7_main(int argc, char *argv[]);
 extern int pkcs8_main(int argc, char *argv[]);
 extern int pkey_main(int argc, char *argv[]);
 extern int pkeyparam_main(int argc, char *argv[]);
 extern int pkeyutl_main(int argc, char *argv[]);
-extern int spkac_main(int argc, char *argv[]);
-extern int smime_main(int argc, char *argv[]);
-extern int rand_main(int argc, char *argv[]);
-extern int engine_main(int argc, char *argv[]);
-extern int ocsp_main(int argc, char *argv[]);
 extern int prime_main(int argc, char *argv[]);
-extern int ts_main(int argc, char *argv[]);
+extern int rand_main(int argc, char *argv[]);
+extern int req_main(int argc, char *argv[]);
+extern int rsa_main(int argc, char *argv[]);
+extern int rsautl_main(int argc, char *argv[]);
+extern int s_client_main(int argc, char *argv[]);
+extern int s_server_main(int argc, char *argv[]);
+extern int s_time_main(int argc, char *argv[]);
+extern int sess_id_main(int argc, char *argv[]);
+extern int smime_main(int argc, char *argv[]);
+extern int speed_main(int argc, char *argv[]);
+extern int spkac_main(int argc, char *argv[]);
 extern int srp_main(int argc, char *argv[]);
+extern int ts_main(int argc, char *argv[]);
+extern int verify_main(int argc, char *argv[]);
+extern int version_main(int argc, char *argv[]);
+extern int x509_main(int argc, char *argv[]);
+extern int list_main(int argc, char *argv[]);
+extern int help_main(int argc, char *argv[]);
+extern int exit_main(int argc, char *argv[]);
 
-#define FUNC_TYPE_GENERAL       1
-#define FUNC_TYPE_MD            2
-#define FUNC_TYPE_CIPHER        3
-#define FUNC_TYPE_PKEY          4
-#define FUNC_TYPE_MD_ALG        5
-#define FUNC_TYPE_CIPHER_ALG    6
-
-typedef struct {
-    int type;
-    const char *name;
-    int (*func) (int argc, char *argv[]);
-} FUNCTION;
-DECLARE_LHASH_OF(FUNCTION);
-
+#ifdef INCLUDE_FUNCTION_TABLE
+extern OPTIONS asn1parse_options[];
+extern OPTIONS ca_options[];
+extern OPTIONS ciphers_options[];
+extern OPTIONS cms_options[];
+extern OPTIONS crl_options[];
+extern OPTIONS crl2pkcs7_options[];
+extern OPTIONS dgst_options[];
+extern OPTIONS dhparam_options[];
+extern OPTIONS dsa_options[];
+extern OPTIONS dsaparam_options[];
+extern OPTIONS ec_options[];
+extern OPTIONS ecparam_options[];
+extern OPTIONS enc_options[];
+extern OPTIONS engine_options[];
+extern OPTIONS errstr_options[];
+extern OPTIONS gendsa_options[];
+extern OPTIONS genpkey_options[];
+extern OPTIONS genrsa_options[];
+extern OPTIONS nseq_options[];
+extern OPTIONS ocsp_options[];
+extern OPTIONS passwd_options[];
+extern OPTIONS pkcs12_options[];
+extern OPTIONS pkcs7_options[];
+extern OPTIONS pkcs8_options[];
+extern OPTIONS pkey_options[];
+extern OPTIONS pkeyparam_options[];
+extern OPTIONS pkeyutl_options[];
+extern OPTIONS prime_options[];
+extern OPTIONS rand_options[];
+extern OPTIONS req_options[];
+extern OPTIONS rsa_options[];
+extern OPTIONS rsautl_options[];
+extern OPTIONS s_client_options[];
+extern OPTIONS s_server_options[];
+extern OPTIONS s_time_options[];
+extern OPTIONS sess_id_options[];
+extern OPTIONS smime_options[];
+extern OPTIONS speed_options[];
+extern OPTIONS spkac_options[];
+extern OPTIONS srp_options[];
+extern OPTIONS ts_options[];
+extern OPTIONS verify_options[];
+extern OPTIONS version_options[];
+extern OPTIONS x509_options[];
+extern OPTIONS list_options[];
+extern OPTIONS help_options[];
+extern OPTIONS exit_options[];
 FUNCTION functions[] = {
-    {FUNC_TYPE_GENERAL, &quot;verify&quot;, verify_main},
-    {FUNC_TYPE_GENERAL, &quot;asn1parse&quot;, asn1parse_main},
-    {FUNC_TYPE_GENERAL, &quot;req&quot;, req_main},
-    {FUNC_TYPE_GENERAL, &quot;dgst&quot;, dgst_main},
-#ifndef OPENSSL_NO_DH
-    {FUNC_TYPE_GENERAL, &quot;dh&quot;, dh_main},
+    { FT_general, &quot;asn1parse&quot;, asn1parse_main, asn1parse_options },
+    { FT_general, &quot;ca&quot;, ca_main, ca_options },
+#if !defined(OPENSSL_NO_SOCK)
+    { FT_general, &quot;ciphers&quot;, ciphers_main, ciphers_options },
 #endif
-#ifndef OPENSSL_NO_DH
-    {FUNC_TYPE_GENERAL, &quot;dhparam&quot;, dhparam_main},
+#ifndef OPENSSL_NO_CMS
+    { FT_general, &quot;cms&quot;, cms_main, cms_options },
 #endif
-    {FUNC_TYPE_GENERAL, &quot;enc&quot;, enc_main},
-    {FUNC_TYPE_GENERAL, &quot;passwd&quot;, passwd_main},
+    { FT_general, &quot;crl&quot;, crl_main, crl_options },
+    { FT_general, &quot;crl2pkcs7&quot;, crl2pkcs7_main, crl2pkcs7_options },
+    { FT_general, &quot;dgst&quot;, dgst_main, dgst_options },
 #ifndef OPENSSL_NO_DH
-    {FUNC_TYPE_GENERAL, &quot;gendh&quot;, gendh_main},
-#endif
-    {FUNC_TYPE_GENERAL, &quot;errstr&quot;, errstr_main},
-    {FUNC_TYPE_GENERAL, &quot;ca&quot;, ca_main},
-    {FUNC_TYPE_GENERAL, &quot;crl&quot;, crl_main},
-#ifndef OPENSSL_NO_RSA
-    {FUNC_TYPE_GENERAL, &quot;rsa&quot;, rsa_main},
-#endif
-#ifndef OPENSSL_NO_RSA
-    {FUNC_TYPE_GENERAL, &quot;rsautl&quot;, rsautl_main},
+    { FT_general, &quot;dhparam&quot;, dhparam_main, dhparam_options },
 #endif
 #ifndef OPENSSL_NO_DSA
-    {FUNC_TYPE_GENERAL, &quot;dsa&quot;, dsa_main},
+    { FT_general, &quot;dsa&quot;, dsa_main, dsa_options },
 #endif
 #ifndef OPENSSL_NO_DSA
-    {FUNC_TYPE_GENERAL, &quot;dsaparam&quot;, dsaparam_main},
+    { FT_general, &quot;dsaparam&quot;, dsaparam_main, dsaparam_options },
 #endif
 #ifndef OPENSSL_NO_EC
-    {FUNC_TYPE_GENERAL, &quot;ec&quot;, ec_main},
+    { FT_general, &quot;ec&quot;, ec_main, ec_options },
 #endif
 #ifndef OPENSSL_NO_EC
-    {FUNC_TYPE_GENERAL, &quot;ecparam&quot;, ecparam_main},
+    { FT_general, &quot;ecparam&quot;, ecparam_main, ecparam_options },
 #endif
-    {FUNC_TYPE_GENERAL, &quot;x509&quot;, x509_main},
-#ifndef OPENSSL_NO_RSA
-    {FUNC_TYPE_GENERAL, &quot;genrsa&quot;, genrsa_main},
+    { FT_general, &quot;enc&quot;, enc_main, enc_options },
+#ifndef OPENSSL_NO_ENGINE
+    { FT_general, &quot;engine&quot;, engine_main, engine_options },
 #endif
+    { FT_general, &quot;errstr&quot;, errstr_main, errstr_options },
 #ifndef OPENSSL_NO_DSA
-    {FUNC_TYPE_GENERAL, &quot;gendsa&quot;, gendsa_main},
+    { FT_general, &quot;gendsa&quot;, gendsa_main, gendsa_options },
 #endif
-    {FUNC_TYPE_GENERAL, &quot;genpkey&quot;, genpkey_main},
-#if !defined(OPENSSL_NO_SOCK)
-    {FUNC_TYPE_GENERAL, &quot;s_server&quot;, s_server_main},
+    { FT_general, &quot;genpkey&quot;, genpkey_main, genpkey_options },
+#ifndef OPENSSL_NO_RSA
+    { FT_general, &quot;genrsa&quot;, genrsa_main, genrsa_options },
 #endif
-#if !defined(OPENSSL_NO_SOCK)
-    {FUNC_TYPE_GENERAL, &quot;s_client&quot;, s_client_main},
+    { FT_general, &quot;nseq&quot;, nseq_main, nseq_options },
+#ifndef OPENSSL_NO_OCSP
+    { FT_general, &quot;ocsp&quot;, ocsp_main, ocsp_options },
 #endif
-    {FUNC_TYPE_GENERAL, &quot;speed&quot;, speed_main},
-#if !defined(OPENSSL_NO_SOCK)
-    {FUNC_TYPE_GENERAL, &quot;s_time&quot;, s_time_main},
+    { FT_general, &quot;passwd&quot;, passwd_main, passwd_options },
+#if !defined(OPENSSL_NO_DES)
+    { FT_general, &quot;pkcs12&quot;, pkcs12_main, pkcs12_options },
+#endif
+    { FT_general, &quot;pkcs7&quot;, pkcs7_main, pkcs7_options },
+    { FT_general, &quot;pkcs8&quot;, pkcs8_main, pkcs8_options },
+    { FT_general, &quot;pkey&quot;, pkey_main, pkey_options },
+    { FT_general, &quot;pkeyparam&quot;, pkeyparam_main, pkeyparam_options },
+    { FT_general, &quot;pkeyutl&quot;, pkeyutl_main, pkeyutl_options },
+    { FT_general, &quot;prime&quot;, prime_main, prime_options },
+    { FT_general, &quot;rand&quot;, rand_main, rand_options },
+    { FT_general, &quot;req&quot;, req_main, req_options },
+#ifndef OPENSSL_NO_RSA
+    { FT_general, &quot;rsa&quot;, rsa_main, rsa_options },
 #endif
-    {FUNC_TYPE_GENERAL, &quot;version&quot;, version_main},
-    {FUNC_TYPE_GENERAL, &quot;pkcs7&quot;, pkcs7_main},
-#ifndef OPENSSL_NO_CMS
-    {FUNC_TYPE_GENERAL, &quot;cms&quot;, cms_main},
+#ifndef OPENSSL_NO_RSA
+    { FT_general, &quot;rsautl&quot;, rsautl_main, rsautl_options },
 #endif
-    {FUNC_TYPE_GENERAL, &quot;crl2pkcs7&quot;, crl2pkcs7_main},
-    {FUNC_TYPE_GENERAL, &quot;sess_id&quot;, sess_id_main},
 #if !defined(OPENSSL_NO_SOCK)
-    {FUNC_TYPE_GENERAL, &quot;ciphers&quot;, ciphers_main},
+    { FT_general, &quot;s_client&quot;, s_client_main, s_client_options },
 #endif
-    {FUNC_TYPE_GENERAL, &quot;nseq&quot;, nseq_main},
-#if !defined(OPENSSL_NO_DES)
-    {FUNC_TYPE_GENERAL, &quot;pkcs12&quot;, pkcs12_main},
-#endif
-    {FUNC_TYPE_GENERAL, &quot;pkcs8&quot;, pkcs8_main},
-    {FUNC_TYPE_GENERAL, &quot;pkey&quot;, pkey_main},
-    {FUNC_TYPE_GENERAL, &quot;pkeyparam&quot;, pkeyparam_main},
-    {FUNC_TYPE_GENERAL, &quot;pkeyutl&quot;, pkeyutl_main},
-    {FUNC_TYPE_GENERAL, &quot;spkac&quot;, spkac_main},
-    {FUNC_TYPE_GENERAL, &quot;smime&quot;, smime_main},
-    {FUNC_TYPE_GENERAL, &quot;rand&quot;, rand_main},
-#ifndef OPENSSL_NO_ENGINE
-    {FUNC_TYPE_GENERAL, &quot;engine&quot;, engine_main},
+#if !defined(OPENSSL_NO_SOCK)
+    { FT_general, &quot;s_server&quot;, s_server_main, s_server_options },
 #endif
-#ifndef OPENSSL_NO_OCSP
-    {FUNC_TYPE_GENERAL, &quot;ocsp&quot;, ocsp_main},
+#if !defined(OPENSSL_NO_SOCK)
+    { FT_general, &quot;s_time&quot;, s_time_main, s_time_options },
 #endif
-    {FUNC_TYPE_GENERAL, &quot;prime&quot;, prime_main},
-    {FUNC_TYPE_GENERAL, &quot;ts&quot;, ts_main},
+    { FT_general, &quot;sess_id&quot;, sess_id_main, sess_id_options },
+    { FT_general, &quot;smime&quot;, smime_main, smime_options },
+    { FT_general, &quot;speed&quot;, speed_main, speed_options },
+    { FT_general, &quot;spkac&quot;, spkac_main, spkac_options },
 #ifndef OPENSSL_NO_SRP
-    {FUNC_TYPE_GENERAL, &quot;srp&quot;, srp_main},
-#endif
+    { FT_general, &quot;srp&quot;, srp_main, srp_options },
+#endif
+    { FT_general, &quot;ts&quot;, ts_main, ts_options },
+    { FT_general, &quot;verify&quot;, verify_main, verify_options },
+    { FT_general, &quot;version&quot;, version_main, version_options },
+    { FT_general, &quot;x509&quot;, x509_main, x509_options },
+    { FT_general, &quot;list&quot;, list_main, list_options },
+    { FT_general, &quot;help&quot;, help_main, help_options },
+    { FT_general, &quot;exit&quot;, exit_main, exit_options },
 #ifndef OPENSSL_NO_MD2
-    {FUNC_TYPE_MD, &quot;md2&quot;, dgst_main},
+    { FT_md, &quot;md2&quot;, dgst_main},
 #endif
 #ifndef OPENSSL_NO_MD4
-    {FUNC_TYPE_MD, &quot;md4&quot;, dgst_main},
+    { FT_md, &quot;md4&quot;, dgst_main},
 #endif
 #ifndef OPENSSL_NO_MD5
-    {FUNC_TYPE_MD, &quot;md5&quot;, dgst_main},
+    { FT_md, &quot;md5&quot;, dgst_main},
 #endif
-    {FUNC_TYPE_MD, &quot;sha&quot;, dgst_main},
-    {FUNC_TYPE_MD, &quot;sha1&quot;, dgst_main},
+#ifndef OPENSSL_NO_MD_GHOST94
+    { FT_md, &quot;md_ghost94&quot;, dgst_main},
+#endif
+    { FT_md, &quot;sha&quot;, dgst_main},
+    { FT_md, &quot;sha1&quot;, dgst_main},
+    { FT_md, &quot;sha224&quot;, dgst_main},
+    { FT_md, &quot;sha256&quot;, dgst_main},
+    { FT_md, &quot;sha384&quot;, dgst_main},
+    { FT_md, &quot;sha512&quot;, dgst_main},
 #ifndef OPENSSL_NO_MDC2
-    {FUNC_TYPE_MD, &quot;mdc2&quot;, dgst_main},
+    { FT_md, &quot;mdc2&quot;, dgst_main},
 #endif
 #ifndef OPENSSL_NO_RMD160
-    {FUNC_TYPE_MD, &quot;rmd160&quot;, dgst_main},
+    { FT_md, &quot;rmd160&quot;, dgst_main},
 #endif
-    {FUNC_TYPE_MD, &quot;sha224&quot;, dgst_main},
-    {FUNC_TYPE_MD, &quot;sha256&quot;, dgst_main},
-    {FUNC_TYPE_MD, &quot;sha384&quot;, dgst_main},
-    {FUNC_TYPE_MD, &quot;sha512&quot;, dgst_main},
 #ifndef OPENSSL_NO_AES
-    {FUNC_TYPE_CIPHER, &quot;aes-128-cbc&quot;, enc_main},
+    { FT_cipher, &quot;aes-128-cbc&quot;, enc_main, enc_options },
 #endif
 #ifndef OPENSSL_NO_AES
-    {FUNC_TYPE_CIPHER, &quot;aes-128-ecb&quot;, enc_main},
+    { FT_cipher, &quot;aes-128-ecb&quot;, enc_main, enc_options },
 #endif
 #ifndef OPENSSL_NO_AES
-    {FUNC_TYPE_CIPHER, &quot;aes-192-cbc&quot;, enc_main},
+    { FT_cipher, &quot;aes-192-cbc&quot;, enc_main, enc_options },
 #endif
 #ifndef OPENSSL_NO_AES
-    {FUNC_TYPE_CIPHER, &quot;aes-192-ecb&quot;, enc_main},
+    { FT_cipher, &quot;aes-192-ecb&quot;, enc_main, enc_options },
 #endif
 #ifndef OPENSSL_NO_AES
-    {FUNC_TYPE_CIPHER, &quot;aes-256-cbc&quot;, enc_main},
+    { FT_cipher, &quot;aes-256-cbc&quot;, enc_main, enc_options },
 #endif
 #ifndef OPENSSL_NO_AES
-    {FUNC_TYPE_CIPHER, &quot;aes-256-ecb&quot;, enc_main},
+    { FT_cipher, &quot;aes-256-ecb&quot;, enc_main, enc_options },
 #endif
 #ifndef OPENSSL_NO_CAMELLIA
-    {FUNC_TYPE_CIPHER, &quot;camellia-128-cbc&quot;, enc_main},
+    { FT_cipher, &quot;camellia-128-cbc&quot;, enc_main, enc_options },
 #endif
 #ifndef OPENSSL_NO_CAMELLIA
-    {FUNC_TYPE_CIPHER, &quot;camellia-128-ecb&quot;, enc_main},
+    { FT_cipher, &quot;camellia-128-ecb&quot;, enc_main, enc_options },
 #endif
 #ifndef OPENSSL_NO_CAMELLIA
-    {FUNC_TYPE_CIPHER, &quot;camellia-192-cbc&quot;, enc_main},
+    { FT_cipher, &quot;camellia-192-cbc&quot;, enc_main, enc_options },
 #endif
 #ifndef OPENSSL_NO_CAMELLIA
-    {FUNC_TYPE_CIPHER, &quot;camellia-192-ecb&quot;, enc_main},
+    { FT_cipher, &quot;camellia-192-ecb&quot;, enc_main, enc_options },
 #endif
 #ifndef OPENSSL_NO_CAMELLIA
-    {FUNC_TYPE_CIPHER, &quot;camellia-256-cbc&quot;, enc_main},
+    { FT_cipher, &quot;camellia-256-cbc&quot;, enc_main, enc_options },
 #endif
 #ifndef OPENSSL_NO_CAMELLIA
-    {FUNC_TYPE_CIPHER, &quot;camellia-256-ecb&quot;, enc_main},
+    { FT_cipher, &quot;camellia-256-ecb&quot;, enc_main, enc_options },
 #endif
-    {FUNC_TYPE_CIPHER, &quot;base64&quot;, enc_main},
+    { FT_cipher, &quot;base64&quot;, enc_main, enc_options },
 #ifdef ZLIB
-    {FUNC_TYPE_CIPHER, &quot;zlib&quot;, enc_main},
+    { FT_cipher, &quot;zlib&quot;, enc_main, enc_options },
 #endif
 #ifndef OPENSSL_NO_DES
-    {FUNC_TYPE_CIPHER, &quot;des&quot;, enc_main},
+    { FT_cipher, &quot;des&quot;, enc_main, enc_options },
 #endif
 #ifndef OPENSSL_NO_DES
-    {FUNC_TYPE_CIPHER, &quot;des3&quot;, enc_main},
+    { FT_cipher, &quot;des3&quot;, enc_main, enc_options },
 #endif
 #ifndef OPENSSL_NO_DES
-    {FUNC_TYPE_CIPHER, &quot;desx&quot;, enc_main},
+    { FT_cipher, &quot;desx&quot;, enc_main, enc_options },
 #endif
 #ifndef OPENSSL_NO_IDEA
-    {FUNC_TYPE_CIPHER, &quot;idea&quot;, enc_main},
+    { FT_cipher, &quot;idea&quot;, enc_main, enc_options },
 #endif
 #ifndef OPENSSL_NO_SEED
-    {FUNC_TYPE_CIPHER, &quot;seed&quot;, enc_main},
+    { FT_cipher, &quot;seed&quot;, enc_main, enc_options },
 #endif
 #ifndef OPENSSL_NO_RC4
-    {FUNC_TYPE_CIPHER, &quot;rc4&quot;, enc_main},
+    { FT_cipher, &quot;rc4&quot;, enc_main, enc_options },
 #endif
 #ifndef OPENSSL_NO_RC4
-    {FUNC_TYPE_CIPHER, &quot;rc4-40&quot;, enc_main},
+    { FT_cipher, &quot;rc4-40&quot;, enc_main, enc_options },
 #endif
 #ifndef OPENSSL_NO_RC2
-    {FUNC_TYPE_CIPHER, &quot;rc2&quot;, enc_main},
+    { FT_cipher, &quot;rc2&quot;, enc_main, enc_options },
 #endif
 #ifndef OPENSSL_NO_BF
-    {FUNC_TYPE_CIPHER, &quot;bf&quot;, enc_main},
+    { FT_cipher, &quot;bf&quot;, enc_main, enc_options },
 #endif
 #ifndef OPENSSL_NO_CAST
-    {FUNC_TYPE_CIPHER, &quot;cast&quot;, enc_main},
+    { FT_cipher, &quot;cast&quot;, enc_main, enc_options },
 #endif
 #ifndef OPENSSL_NO_RC5
-    {FUNC_TYPE_CIPHER, &quot;rc5&quot;, enc_main},
+    { FT_cipher, &quot;rc5&quot;, enc_main, enc_options },
 #endif
 #ifndef OPENSSL_NO_DES
-    {FUNC_TYPE_CIPHER, &quot;des-ecb&quot;, enc_main},
+    { FT_cipher, &quot;des-ecb&quot;, enc_main, enc_options },
 #endif
 #ifndef OPENSSL_NO_DES
-    {FUNC_TYPE_CIPHER, &quot;des-ede&quot;, enc_main},
+    { FT_cipher, &quot;des-ede&quot;, enc_main, enc_options },
 #endif
 #ifndef OPENSSL_NO_DES
-    {FUNC_TYPE_CIPHER, &quot;des-ede3&quot;, enc_main},
+    { FT_cipher, &quot;des-ede3&quot;, enc_main, enc_options },
 #endif
 #ifndef OPENSSL_NO_DES
-    {FUNC_TYPE_CIPHER, &quot;des-cbc&quot;, enc_main},
+    { FT_cipher, &quot;des-cbc&quot;, enc_main, enc_options },
 #endif
 #ifndef OPENSSL_NO_DES
-    {FUNC_TYPE_CIPHER, &quot;des-ede-cbc&quot;, enc_main},
+    { FT_cipher, &quot;des-ede-cbc&quot;, enc_main, enc_options },
 #endif
 #ifndef OPENSSL_NO_DES
-    {FUNC_TYPE_CIPHER, &quot;des-ede3-cbc&quot;, enc_main},
+    { FT_cipher, &quot;des-ede3-cbc&quot;, enc_main, enc_options },
 #endif
 #ifndef OPENSSL_NO_DES
-    {FUNC_TYPE_CIPHER, &quot;des-cfb&quot;, enc_main},
+    { FT_cipher, &quot;des-cfb&quot;, enc_main, enc_options },
 #endif
 #ifndef OPENSSL_NO_DES
-    {FUNC_TYPE_CIPHER, &quot;des-ede-cfb&quot;, enc_main},
+    { FT_cipher, &quot;des-ede-cfb&quot;, enc_main, enc_options },
 #endif
 #ifndef OPENSSL_NO_DES
-    {FUNC_TYPE_CIPHER, &quot;des-ede3-cfb&quot;, enc_main},
+    { FT_cipher, &quot;des-ede3-cfb&quot;, enc_main, enc_options },
 #endif
 #ifndef OPENSSL_NO_DES
-    {FUNC_TYPE_CIPHER, &quot;des-ofb&quot;, enc_main},
+    { FT_cipher, &quot;des-ofb&quot;, enc_main, enc_options },
 #endif
 #ifndef OPENSSL_NO_DES
-    {FUNC_TYPE_CIPHER, &quot;des-ede-ofb&quot;, enc_main},
+    { FT_cipher, &quot;des-ede-ofb&quot;, enc_main, enc_options },
 #endif
 #ifndef OPENSSL_NO_DES
-    {FUNC_TYPE_CIPHER, &quot;des-ede3-ofb&quot;, enc_main},
+    { FT_cipher, &quot;des-ede3-ofb&quot;, enc_main, enc_options },
 #endif
 #ifndef OPENSSL_NO_IDEA
-    {FUNC_TYPE_CIPHER, &quot;idea-cbc&quot;, enc_main},
+    { FT_cipher, &quot;idea-cbc&quot;, enc_main, enc_options },
 #endif
 #ifndef OPENSSL_NO_IDEA
-    {FUNC_TYPE_CIPHER, &quot;idea-ecb&quot;, enc_main},
+    { FT_cipher, &quot;idea-ecb&quot;, enc_main, enc_options },
 #endif
 #ifndef OPENSSL_NO_IDEA
-    {FUNC_TYPE_CIPHER, &quot;idea-cfb&quot;, enc_main},
+    { FT_cipher, &quot;idea-cfb&quot;, enc_main, enc_options },
 #endif
 #ifndef OPENSSL_NO_IDEA
-    {FUNC_TYPE_CIPHER, &quot;idea-ofb&quot;, enc_main},
+    { FT_cipher, &quot;idea-ofb&quot;, enc_main, enc_options },
 #endif
 #ifndef OPENSSL_NO_SEED
-    {FUNC_TYPE_CIPHER, &quot;seed-cbc&quot;, enc_main},
+    { FT_cipher, &quot;seed-cbc&quot;, enc_main, enc_options },
 #endif
 #ifndef OPENSSL_NO_SEED
-    {FUNC_TYPE_CIPHER, &quot;seed-ecb&quot;, enc_main},
+    { FT_cipher, &quot;seed-ecb&quot;, enc_main, enc_options },
 #endif
 #ifndef OPENSSL_NO_SEED
-    {FUNC_TYPE_CIPHER, &quot;seed-cfb&quot;, enc_main},
+    { FT_cipher, &quot;seed-cfb&quot;, enc_main, enc_options },
 #endif
 #ifndef OPENSSL_NO_SEED
-    {FUNC_TYPE_CIPHER, &quot;seed-ofb&quot;, enc_main},
+    { FT_cipher, &quot;seed-ofb&quot;, enc_main, enc_options },
 #endif
 #ifndef OPENSSL_NO_RC2
-    {FUNC_TYPE_CIPHER, &quot;rc2-cbc&quot;, enc_main},
+    { FT_cipher, &quot;rc2-cbc&quot;, enc_main, enc_options },
 #endif
 #ifndef OPENSSL_NO_RC2
-    {FUNC_TYPE_CIPHER, &quot;rc2-ecb&quot;, enc_main},
+    { FT_cipher, &quot;rc2-ecb&quot;, enc_main, enc_options },
 #endif
 #ifndef OPENSSL_NO_RC2
-    {FUNC_TYPE_CIPHER, &quot;rc2-cfb&quot;, enc_main},
+    { FT_cipher, &quot;rc2-cfb&quot;, enc_main, enc_options },
 #endif
 #ifndef OPENSSL_NO_RC2
-    {FUNC_TYPE_CIPHER, &quot;rc2-ofb&quot;, enc_main},
+    { FT_cipher, &quot;rc2-ofb&quot;, enc_main, enc_options },
 #endif
 #ifndef OPENSSL_NO_RC2
-    {FUNC_TYPE_CIPHER, &quot;rc2-64-cbc&quot;, enc_main},
+    { FT_cipher, &quot;rc2-64-cbc&quot;, enc_main, enc_options },
 #endif
 #ifndef OPENSSL_NO_RC2
-    {FUNC_TYPE_CIPHER, &quot;rc2-40-cbc&quot;, enc_main},
+    { FT_cipher, &quot;rc2-40-cbc&quot;, enc_main, enc_options },
 #endif
 #ifndef OPENSSL_NO_BF
-    {FUNC_TYPE_CIPHER, &quot;bf-cbc&quot;, enc_main},
+    { FT_cipher, &quot;bf-cbc&quot;, enc_main, enc_options },
 #endif
 #ifndef OPENSSL_NO_BF
-    {FUNC_TYPE_CIPHER, &quot;bf-ecb&quot;, enc_main},
+    { FT_cipher, &quot;bf-ecb&quot;, enc_main, enc_options },
 #endif
 #ifndef OPENSSL_NO_BF
-    {FUNC_TYPE_CIPHER, &quot;bf-cfb&quot;, enc_main},
+    { FT_cipher, &quot;bf-cfb&quot;, enc_main, enc_options },
 #endif
 #ifndef OPENSSL_NO_BF
-    {FUNC_TYPE_CIPHER, &quot;bf-ofb&quot;, enc_main},
+    { FT_cipher, &quot;bf-ofb&quot;, enc_main, enc_options },
 #endif
 #ifndef OPENSSL_NO_CAST
-    {FUNC_TYPE_CIPHER, &quot;cast5-cbc&quot;, enc_main},
+    { FT_cipher, &quot;cast5-cbc&quot;, enc_main, enc_options },
 #endif
 #ifndef OPENSSL_NO_CAST
-    {FUNC_TYPE_CIPHER, &quot;cast5-ecb&quot;, enc_main},
+    { FT_cipher, &quot;cast5-ecb&quot;, enc_main, enc_options },
 #endif
 #ifndef OPENSSL_NO_CAST
-    {FUNC_TYPE_CIPHER, &quot;cast5-cfb&quot;, enc_main},
+    { FT_cipher, &quot;cast5-cfb&quot;, enc_main, enc_options },
 #endif
 #ifndef OPENSSL_NO_CAST
-    {FUNC_TYPE_CIPHER, &quot;cast5-ofb&quot;, enc_main},
+    { FT_cipher, &quot;cast5-ofb&quot;, enc_main, enc_options },
 #endif
 #ifndef OPENSSL_NO_CAST
-    {FUNC_TYPE_CIPHER, &quot;cast-cbc&quot;, enc_main},
+    { FT_cipher, &quot;cast-cbc&quot;, enc_main, enc_options },
 #endif
 #ifndef OPENSSL_NO_RC5
-    {FUNC_TYPE_CIPHER, &quot;rc5-cbc&quot;, enc_main},
+    { FT_cipher, &quot;rc5-cbc&quot;, enc_main, enc_options },
 #endif
 #ifndef OPENSSL_NO_RC5
-    {FUNC_TYPE_CIPHER, &quot;rc5-ecb&quot;, enc_main},
+    { FT_cipher, &quot;rc5-ecb&quot;, enc_main, enc_options },
 #endif
 #ifndef OPENSSL_NO_RC5
-    {FUNC_TYPE_CIPHER, &quot;rc5-cfb&quot;, enc_main},
+    { FT_cipher, &quot;rc5-cfb&quot;, enc_main, enc_options },
 #endif
 #ifndef OPENSSL_NO_RC5
-    {FUNC_TYPE_CIPHER, &quot;rc5-ofb&quot;, enc_main},
+    { FT_cipher, &quot;rc5-ofb&quot;, enc_main, enc_options },
 #endif
-    {0, NULL, NULL}
+    { 0, NULL, NULL}
 };
+#endif
diff --git a/apps/progs.pl b/apps/progs.pl
index 09dd00b..38e091e 100644
--- a/apps/progs.pl
+++ b/apps/progs.pl
@@ -1,67 +1,80 @@
 #!/usr/local/bin/perl
-
-print &quot;/* apps/progs.h */\n&quot;;
-print &quot;/* automatically generated by progs.pl for openssl.c */\n\n&quot;;
-
-grep(s/^asn1pars$/asn1parse/<A HREF="../../../mailman/listinfo/openssl-commits.html">, at ARGV</A>);
-
-foreach (@ARGV)
-	{ printf &quot;extern int %s_main(int argc, char *argv[]);\n&quot;,$_; }
+# Generate progs.h file from list of &quot;programs&quot; passed on the command line.
 
 print &lt;&lt;'EOF';
+/*
+ * Automatically generated by progs.pl for openssl.c
+ * Copyright (c) 2008 The OpenSSL Project.  All rights reserved.
+ * See the openssl.c for copyright details.
+ */
 
-#define FUNC_TYPE_GENERAL       1
-#define FUNC_TYPE_MD            2
-#define FUNC_TYPE_CIPHER        3
-#define FUNC_TYPE_PKEY          4
-#define FUNC_TYPE_MD_ALG        5
-#define FUNC_TYPE_CIPHER_ALG    6
+typedef enum FUNC_TYPE {
+    FT_none, FT_general, FT_md, FT_cipher, FT_pkey,
+    FT_md_alg, FT_cipher_alg
+} FUNC_TYPE;
 
-typedef struct {
-    int type;
+typedef struct function_st {
+    FUNC_TYPE type;
     const char *name;
-    int (*func) (int argc, char *argv[]);
+    int (*func)(int argc,char *argv[]);
+    const OPTIONS *help;
 } FUNCTION;
-DECLARE_LHASH_OF(FUNCTION);
 
-FUNCTION functions[] = {
 EOF
 
-foreach (@ARGV)
-	{
-	push(@files,$_);
-	$str=&quot;    {FUNC_TYPE_GENERAL, \&quot;$_\&quot;, ${_}_main},\n&quot;;
-	if (($_ =~ /^s_/) || ($_ =~ /^ciphers$/))
-		{ print &quot;#if !defined(OPENSSL_NO_SOCK)\n${str}#endif\n&quot;; } 
-	elsif ( ($_ =~ /^engine$/))
-		{ print &quot;#ifndef OPENSSL_NO_ENGINE\n${str}#endif\n&quot;; }
-	elsif ( ($_ =~ /^rsa$/) || ($_ =~ /^genrsa$/) || ($_ =~ /^rsautl$/)) 
-		{ print &quot;#ifndef OPENSSL_NO_RSA\n${str}#endif\n&quot;;  }
-	elsif ( ($_ =~ /^dsa$/) || ($_ =~ /^gendsa$/) || ($_ =~ /^dsaparam$/))
-		{ print &quot;#ifndef OPENSSL_NO_DSA\n${str}#endif\n&quot;; }
-	elsif ( ($_ =~ /^ec$/) || ($_ =~ /^ecparam$/))
-		{ print &quot;#ifndef OPENSSL_NO_EC\n${str}#endif\n&quot;;}
-	elsif ( ($_ =~ /^dh$/) || ($_ =~ /^gendh$/) || ($_ =~ /^dhparam$/))
-		{ print &quot;#ifndef OPENSSL_NO_DH\n${str}#endif\n&quot;; }
-	elsif ( ($_ =~ /^pkcs12$/))
-		{ print &quot;#if !defined(OPENSSL_NO_DES)\n${str}#endif\n&quot;; }
-	elsif ( ($_ =~ /^cms$/))
-		{ print &quot;#ifndef OPENSSL_NO_CMS\n${str}#endif\n&quot;; }
-	elsif ( ($_ =~ /^ocsp$/))
-		{ print &quot;#ifndef OPENSSL_NO_OCSP\n${str}#endif\n&quot;; }
-	elsif ( ($_ =~ /^srp$/))
-		{ print &quot;#ifndef OPENSSL_NO_SRP\n${str}#endif\n&quot;; }
-	else
-		{ print $str; }
+grep(s/\.o//, @ARGV);
+grep(s/^asn1pars$/asn1parse/, @ARGV);
+grep(s/^crl2p7$/crl2pkcs7/, @ARGV);
+push @ARGV, 'list';
+push @ARGV, 'help';
+push @ARGV, 'exit';
+
+foreach (@ARGV) {
+	printf &quot;extern int %s_main(int argc, char *argv[]);\n&quot;, $_;
+}
+
+printf &quot;\n#ifdef INCLUDE_FUNCTION_TABLE\n&quot;;
+foreach (@ARGV) {
+	printf &quot;extern OPTIONS %s_options[];\n&quot;, $_;
+}
+printf &quot;FUNCTION functions[] = {\n&quot;;
+foreach (@ARGV) {
+	$str=&quot;    { FT_general, \&quot;$_\&quot;, ${_}_main, ${_}_options },\n&quot;;
+	if (/^s_/ || /^ciphers$/) {
+		print &quot;#if !defined(OPENSSL_NO_SOCK)\n${str}#endif\n&quot;;
+	} elsif (/^engine$/) {
+		print &quot;#ifndef OPENSSL_NO_ENGINE\n${str}#endif\n&quot;;
+	} elsif (/^rsa$/ || /^genrsa$/ || /^rsautl$/) {
+		print &quot;#ifndef OPENSSL_NO_RSA\n${str}#endif\n&quot;;
+	} elsif (/^dsa$/ || /^gendsa$/ || /^dsaparam$/) {
+		print &quot;#ifndef OPENSSL_NO_DSA\n${str}#endif\n&quot;;
+	} elsif (/^ec$/ || /^ecparam$/) {
+		print &quot;#ifndef OPENSSL_NO_EC\n${str}#endif\n&quot;;
+	} elsif (/^dh$/ || /^gendh$/ || /^dhparam$/) {
+		print &quot;#ifndef OPENSSL_NO_DH\n${str}#endif\n&quot;;
+	} elsif (/^pkcs12$/) {
+		print &quot;#if !defined(OPENSSL_NO_DES)\n${str}#endif\n&quot;;
+	} elsif (/^cms$/) {
+		print &quot;#ifndef OPENSSL_NO_CMS\n${str}#endif\n&quot;;
+	} elsif (/^ocsp$/) {
+		print &quot;#ifndef OPENSSL_NO_OCSP\n${str}#endif\n&quot;;
+	} elsif (/^srp$/) {
+		print &quot;#ifndef OPENSSL_NO_SRP\n${str}#endif\n&quot;;
+	} else {
+		print $str;
 	}
+}
 
-foreach (&quot;md2&quot;,&quot;md4&quot;,&quot;md5&quot;,&quot;sha&quot;,&quot;sha1&quot;,&quot;mdc2&quot;,&quot;rmd160&quot;,&quot;sha224&quot;,&quot;sha256&quot;,&quot;sha384&quot;,&quot;sha512&quot;)
-	{
-	push(@files,$_);
+foreach (
+	&quot;md2&quot;, &quot;md4&quot;, &quot;md5&quot;,
+	&quot;md_ghost94&quot;,
+	&quot;sha&quot;, &quot;sha1&quot;, &quot;sha224&quot;, &quot;sha256&quot;, &quot;sha384&quot;, &quot;sha512&quot;,
+	&quot;mdc2&quot;, &quot;rmd160&quot;
+) {
         printf &quot;#ifndef OPENSSL_NO_&quot;.uc($_).&quot;\n&quot; if ! /sha/;
-        printf &quot;    {FUNC_TYPE_MD, \&quot;&quot;.$_.&quot;\&quot;, dgst_main},\n&quot;;
+        printf &quot;    { FT_md, \&quot;&quot;.$_.&quot;\&quot;, dgst_main},\n&quot;;
         printf &quot;#endif\n&quot; if ! /sha/;
-	}
+}
 
 foreach (
 	&quot;aes-128-cbc&quot;, &quot;aes-128-ecb&quot;,
@@ -82,23 +95,35 @@ foreach (
 	&quot;rc2-cbc&quot;, &quot;rc2-ecb&quot;, &quot;rc2-cfb&quot;,&quot;rc2-ofb&quot;, &quot;rc2-64-cbc&quot;, &quot;rc2-40-cbc&quot;,
 	&quot;bf-cbc&quot;,  &quot;bf-ecb&quot;,     &quot;bf-cfb&quot;,   &quot;bf-ofb&quot;,
 	&quot;cast5-cbc&quot;,&quot;cast5-ecb&quot;, &quot;cast5-cfb&quot;,&quot;cast5-ofb&quot;,
-	&quot;cast-cbc&quot;, &quot;rc5-cbc&quot;,   &quot;rc5-ecb&quot;,  &quot;rc5-cfb&quot;,  &quot;rc5-ofb&quot;)
-	{
-	push(@files,$_);
-
-	$t=sprintf(&quot;    {FUNC_TYPE_CIPHER, \&quot;%s\&quot;, enc_main},\n&quot;, $_);
-	if    ($_ =~ /des/)  { $t=&quot;#ifndef OPENSSL_NO_DES\n${t}#endif\n&quot;; }
-	elsif ($_ =~ /aes/)  { $t=&quot;#ifndef OPENSSL_NO_AES\n${t}#endif\n&quot;; }
-	elsif ($_ =~ /camellia/)  { $t=&quot;#ifndef OPENSSL_NO_CAMELLIA\n${t}#endif\n&quot;; }
-	elsif ($_ =~ /idea/) { $t=&quot;#ifndef OPENSSL_NO_IDEA\n${t}#endif\n&quot;; }
-	elsif ($_ =~ /seed/) { $t=&quot;#ifndef OPENSSL_NO_SEED\n${t}#endif\n&quot;; }
-	elsif ($_ =~ /rc4/)  { $t=&quot;#ifndef OPENSSL_NO_RC4\n${t}#endif\n&quot;; }
-	elsif ($_ =~ /rc2/)  { $t=&quot;#ifndef OPENSSL_NO_RC2\n${t}#endif\n&quot;; }
-	elsif ($_ =~ /bf/)   { $t=&quot;#ifndef OPENSSL_NO_BF\n${t}#endif\n&quot;; }
-	elsif ($_ =~ /cast/) { $t=&quot;#ifndef OPENSSL_NO_CAST\n${t}#endif\n&quot;; }
-	elsif ($_ =~ /rc5/)  { $t=&quot;#ifndef OPENSSL_NO_RC5\n${t}#endif\n&quot;; }
-	elsif ($_ =~ /zlib/)  { $t=&quot;#ifdef ZLIB\n${t}#endif\n&quot;; }
-	print $t;
+	&quot;cast-cbc&quot;, &quot;rc5-cbc&quot;,   &quot;rc5-ecb&quot;,  &quot;rc5-cfb&quot;,  &quot;rc5-ofb&quot;
+) {
+	$str=&quot;    { FT_cipher, \&quot;$_\&quot;, enc_main, enc_options },\n&quot;;
+	if (/des/) {
+		printf &quot;#ifndef OPENSSL_NO_DES\n${str}#endif\n&quot;;
+	} elsif (/aes/) {
+		printf &quot;#ifndef OPENSSL_NO_AES\n${str}#endif\n&quot;;
+	} elsif (/camellia/) {
+		printf &quot;#ifndef OPENSSL_NO_CAMELLIA\n${str}#endif\n&quot;;
+	} elsif (/idea/) {
+		printf &quot;#ifndef OPENSSL_NO_IDEA\n${str}#endif\n&quot;;
+	} elsif (/seed/) {
+		printf &quot;#ifndef OPENSSL_NO_SEED\n${str}#endif\n&quot;;
+	} elsif (/rc4/) {
+		printf &quot;#ifndef OPENSSL_NO_RC4\n${str}#endif\n&quot;;
+	} elsif (/rc2/) {
+		printf &quot;#ifndef OPENSSL_NO_RC2\n${str}#endif\n&quot;;
+	} elsif (/bf/) {
+		printf &quot;#ifndef OPENSSL_NO_BF\n${str}#endif\n&quot;;
+	} elsif (/cast/) {
+		printf &quot;#ifndef OPENSSL_NO_CAST\n${str}#endif\n&quot;;
+	} elsif (/rc5/) {
+		printf &quot;#ifndef OPENSSL_NO_RC5\n${str}#endif\n&quot;;
+	} elsif (/zlib/) {
+		printf &quot;#ifdef ZLIB\n${str}#endif\n&quot;;
+	} else {
+		print $str;
 	}
+}
 
-print &quot;    {0, NULL, NULL}\n};\n&quot;;
+print &quot;    { 0, NULL, NULL}\n};\n&quot;;
+printf &quot;#endif\n&quot;;
diff --git a/apps/rand.c b/apps/rand.c
index 45f16b9..9a73935 100644
--- a/apps/rand.c
+++ b/apps/rand.c
@@ -1,4 +1,3 @@
-/* apps/rand.c */
 /* ====================================================================
  * Copyright (c) 1998-2001 The OpenSSL Project.  All rights reserved.
  *
@@ -63,135 +62,87 @@
 #include &lt;openssl/err.h&gt;
 #include &lt;openssl/rand.h&gt;
 
-#undef PROG
-#define PROG rand_main
-
-/*-
- * -out file         - write to file
- * -rand file:file   - PRNG seed files
- * -base64           - base64 encode output
- * -hex              - hex encode output
- * num               - write 'num' bytes
- */
-
-int MAIN(int, char **);
-
-int MAIN(int argc, char **argv)
-{
-    int i, r, ret = 1;
-    int badopt;
-    char *outfile = NULL;
-    char *inrand = NULL;
-    int base64 = 0;
-    int hex = 0;
-    BIO *out = NULL;
-    int num = -1;
+typedef enum OPTION_choice {
+    OPT_ERR = -1, OPT_EOF = 0, OPT_HELP,
+    OPT_OUT, OPT_ENGINE, OPT_RAND, OPT_BASE64, OPT_HEX
+} OPTION_CHOICE;
+
+OPTIONS rand_options[] = {
+    {OPT_HELP_STR, 1, '-', &quot;Usage: %s [flags] num\n&quot;},
+    {OPT_HELP_STR, 1, '-', &quot;Valid options are:\n&quot;},
+    {&quot;help&quot;, OPT_HELP, '-', &quot;Display this summary&quot;},
+    {&quot;out&quot;, OPT_OUT, '&gt;', &quot;Output file&quot;},
+    {&quot;rand&quot;, OPT_RAND, 's',
+     &quot;Load the file(s) into the random number generator&quot;},
+    {&quot;base64&quot;, OPT_BASE64, '-', &quot;Base64 encode output&quot;},
+    {&quot;hex&quot;, OPT_HEX, '-', &quot;Hex encode output&quot;},
 #ifndef OPENSSL_NO_ENGINE
-    char *engine = NULL;
+    {&quot;engine&quot;, OPT_ENGINE, 's', &quot;Use engine, possibly a hardware device&quot;},
 #endif
+    {NULL}
+};
 
-    apps_startup();
-
-    if (bio_err == NULL)
-        if ((bio_err = BIO_new(BIO_s_file())) != NULL)
-            BIO_set_fp(bio_err, stderr, BIO_NOCLOSE | BIO_FP_TEXT);
-
-    if (!load_config(bio_err, NULL))
-        goto err;
-
-    badopt = 0;
-    i = 0;
-    while (!badopt &amp;&amp; argv[++i] != NULL) {
-        if (strcmp(argv[i], &quot;-out&quot;) == 0) {
-            if ((argv[i + 1] != NULL) &amp;&amp; (outfile == NULL))
-                outfile = argv[++i];
-            else
-                badopt = 1;
-        }
-#ifndef OPENSSL_NO_ENGINE
-        else if (strcmp(argv[i], &quot;-engine&quot;) == 0) {
-            if ((argv[i + 1] != NULL) &amp;&amp; (engine == NULL))
-                engine = argv[++i];
-            else
-                badopt = 1;
+int rand_main(int argc, char **argv)
+{
+    BIO *out = NULL;
+    char *engine = NULL, *inrand = NULL, *outfile = NULL, *prog;
+    OPTION_CHOICE o;
+    int base64 = 0, hex = 0, i, num = -1, r, ret = 1;
+
+    prog = opt_init(argc, argv, rand_options);
+    while ((o = opt_next()) != OPT_EOF) {
+        switch (o) {
+        case OPT_EOF:
+        case OPT_ERR:
+ opthelp:
+            BIO_printf(bio_err, &quot;%s: Use -help for summary.\n&quot;, prog);
+            goto end;
+        case OPT_HELP:
+            opt_help(rand_options);
+            ret = 0;
+            goto end;
+        case OPT_OUT:
+            outfile = opt_arg();
+            break;
+        case OPT_ENGINE:
+            engine = opt_arg();
+            break;
+        case OPT_RAND:
+            inrand = opt_arg();
+            break;
+        case OPT_BASE64:
+            base64 = 1;
+            break;
+        case OPT_HEX:
+            hex = 1;
+            break;
         }
-#endif
-        else if (strcmp(argv[i], &quot;-rand&quot;) == 0) {
-            if ((argv[i + 1] != NULL) &amp;&amp; (inrand == NULL))
-                inrand = argv[++i];
-            else
-                badopt = 1;
-        } else if (strcmp(argv[i], &quot;-base64&quot;) == 0) {
-            if (!base64)
-                base64 = 1;
-            else
-                badopt = 1;
-        } else if (strcmp(argv[i], &quot;-hex&quot;) == 0) {
-            if (!hex)
-                hex = 1;
-            else
-                badopt = 1;
-        } else if (isdigit((unsigned char)argv[i][0])) {
-            if (num &lt; 0) {
-                r = sscanf(argv[i], &quot;%d&quot;, &amp;num);
-                if (r == 0 || num &lt; 0)
-                    badopt = 1;
-            } else
-                badopt = 1;
-        } else
-            badopt = 1;
     }
+    argc = opt_num_rest();
+    argv = opt_rest();
 
-    if (hex &amp;&amp; base64)
-        badopt = 1;
+    if (argc != 1 || (hex &amp;&amp; base64))
+        goto opthelp;
+    if (sscanf(argv[0], &quot;%d&quot;, &amp;num) != 1 || num &lt; 0)
+        goto opthelp;
 
-    if (num &lt; 0)
-        badopt = 1;
-
-    if (badopt) {
-        BIO_printf(bio_err, &quot;Usage: rand [options] num\n&quot;);
-        BIO_printf(bio_err, &quot;where options are\n&quot;);
-        BIO_printf(bio_err, &quot;-out file             - write to file\n&quot;);
-#ifndef OPENSSL_NO_ENGINE
-        BIO_printf(bio_err,
-                   &quot;-engine e             - use engine e, possibly a hardware device.\n&quot;);
-#endif
-        BIO_printf(bio_err, &quot;-rand file%cfile%c... - seed PRNG from files\n&quot;,
-                   LIST_SEPARATOR_CHAR, LIST_SEPARATOR_CHAR);
-        BIO_printf(bio_err, &quot;-base64               - base64 encode output\n&quot;);
-        BIO_printf(bio_err, &quot;-hex                  - hex encode output\n&quot;);
-        goto err;
-    }
 #ifndef OPENSSL_NO_ENGINE
-    setup_engine(bio_err, engine, 0);
+    setup_engine(engine, 0);
 #endif
 
-    app_RAND_load_file(NULL, bio_err, (inrand != NULL));
+    app_RAND_load_file(NULL, (inrand != NULL));
     if (inrand != NULL)
         BIO_printf(bio_err, &quot;%ld semi-random bytes loaded\n&quot;,
                    app_RAND_load_files(inrand));
 
-    out = BIO_new(BIO_s_file());
+    out = bio_open_default(outfile, &quot;w&quot;);
     if (out == NULL)
-        goto err;
-    if (outfile != NULL)
-        r = BIO_write_filename(out, outfile);
-    else {
-        r = BIO_set_fp(out, stdout, BIO_NOCLOSE | BIO_FP_TEXT);
-#ifdef OPENSSL_SYS_VMS
-        {
-            BIO *tmpbio = BIO_new(BIO_f_linebuffer());
-            out = BIO_push(tmpbio, out);
-        }
-#endif
-    }
-    if (r &lt;= 0)
-        goto err;
+        goto end;
 
     if (base64) {
         BIO *b64 = BIO_new(BIO_f_base64());
         if (b64 == NULL)
-            goto err;
+            goto end;
         out = BIO_push(b64, out);
     }
 
@@ -204,7 +155,7 @@ int MAIN(int argc, char **argv)
             chunk = sizeof buf;
         r = RAND_bytes(buf, chunk);
         if (r &lt;= 0)
-            goto err;
+            goto end;
         if (!hex)
             BIO_write(out, buf, chunk);
         else {
@@ -217,12 +168,10 @@ int MAIN(int argc, char **argv)
         BIO_puts(out, &quot;\n&quot;);
     (void)BIO_flush(out);
 
-    app_RAND_write_file(NULL, bio_err);
+    app_RAND_write_file(NULL);
     ret = 0;
 
- err:
-    ERR_print_errors(bio_err);
+ end:
     BIO_free_all(out);
-    apps_shutdown();
-    OPENSSL_EXIT(ret);
+    return (ret);
 }
diff --git a/apps/req.c b/apps/req.c
index 3cedf2c..1237c33 100644
--- a/apps/req.c
+++ b/apps/req.c
@@ -1,4 +1,3 @@
-/* apps/req.c */
 /* Copyright (C) 1995-1998 Eric Young (<A HREF="../../../mailman/listinfo/openssl-commits.html">eay at cryptsoft.com</A>)
  * All rights reserved.
  *
@@ -93,30 +92,6 @@
 #define DEFAULT_KEY_LENGTH      512
 #define MIN_KEY_LENGTH          384
 
-#undef PROG
-#define PROG    req_main
-
-/*-
- * -inform arg  - input format - default PEM (DER or PEM)
- * -outform arg - output format - default PEM
- * -in arg      - input file - default stdin
- * -out arg     - output file - default stdout
- * -verify      - check request signature
- * -noout       - don't print stuff out.
- * -text        - print out human readable text.
- * -nodes       - no des encryption
- * -config file - Load configuration file.
- * -key file    - make a request using key in file (or use it for verification).
- * -keyform arg - key file format.
- * -rand file(s) - load the file(s) into the PRNG.
- * -newkey      - make a key and a request.
- * -modulus     - print RSA modulus.
- * -pubkey      - output Public Key.
- * -x509        - output a self signed X509 structure instead.
- * -asn1-kludge - output new certificate request in a format that some CA's
- *                require.  This format is wrong
- */
-
 static int make_REQ(X509_REQ *req, EVP_PKEY *pkey, char *dn, int mutlirdn,
                     int attribs, unsigned long chtype);
 static int build_subject(X509_REQ *req, char *subj, unsigned long chtype,
@@ -137,323 +112,270 @@ static int add_DN_object(X509_NAME *n, char *text, const char *def,
 static int genpkey_cb(EVP_PKEY_CTX *ctx);
 static int req_check_len(int len, int n_min, int n_max);
 static int check_end(const char *str, const char *end);
-static EVP_PKEY_CTX *set_keygen_ctx(BIO *err, const char *gstr,
+static EVP_PKEY_CTX *set_keygen_ctx(const char *gstr,
                                     int *pkey_type, long *pkeylen,
                                     char **palgnam, ENGINE *keygen_engine);
-#ifndef MONOLITH
-static char *default_config_file = NULL;
-#endif
 static CONF *req_conf = NULL;
 static int batch = 0;
 
-int MAIN(int, char **);
+typedef enum OPTION_choice {
+    OPT_ERR = -1, OPT_EOF = 0, OPT_HELP,
+    OPT_INFORM, OPT_OUTFORM, OPT_ENGINE, OPT_KEYGEN_ENGINE, OPT_KEY,
+    OPT_PUBKEY, OPT_NEW, OPT_CONFIG, OPT_KEYFORM, OPT_IN, OPT_OUT,
+    OPT_KEYOUT, OPT_PASSIN, OPT_PASSOUT, OPT_RAND, OPT_NEWKEY,
+    OPT_PKEYOPT, OPT_SIGOPT, OPT_BATCH, OPT_NEWHDR, OPT_MODULUS,
+    OPT_VERIFY, OPT_NODES, OPT_NOOUT, OPT_VERBOSE, OPT_UTF8,
+    OPT_NAMEOPT, OPT_REQOPT, OPT_SUBJECT, OPT_TEXT, OPT_X509,
+    OPT_ASN1_KLUDGE, OPT_NO_ASN1_KLUDGE, OPT_MULTIVALUE_RDN,
+    OPT_DAYS, OPT_SET_SERIAL, OPT_EXTENSIONS, OPT_REQEXTS, OPT_MD
+} OPTION_CHOICE;
+
+OPTIONS req_options[] = {
+    {&quot;help&quot;, OPT_HELP, '-', &quot;Display this summary&quot;},
+    {&quot;inform&quot;, OPT_INFORM, 'F', &quot;Input format - DER or PEM&quot;},
+    {&quot;outform&quot;, OPT_OUTFORM, 'F', &quot;Output format - DER or PEM&quot;},
+    {&quot;in&quot;, OPT_IN, '&lt;', &quot;Input file&quot;},
+    {&quot;out&quot;, OPT_OUT, '&gt;', &quot;Output file&quot;},
+    {&quot;keygen_engine&quot;, OPT_KEYGEN_ENGINE, 's'},
+    {&quot;key&quot;, OPT_KEY, '&lt;', &quot;Use the private key contained in file&quot;},
+    {&quot;keyform&quot;, OPT_KEYFORM, 'F', &quot;Key file format&quot;},
+    {&quot;pubkey&quot;, OPT_PUBKEY, '-', &quot;Output public key&quot;},
+    {&quot;new&quot;, OPT_NEW, '-', &quot;New request&quot;},
+    {&quot;config&quot;, OPT_CONFIG, '&lt;', &quot;Request template file&quot;},
+    {&quot;keyout&quot;, OPT_KEYOUT, '&gt;', &quot;File to send the key to&quot;},
+    {&quot;passin&quot;, OPT_PASSIN, 's', &quot;Private key password source&quot;},
+    {&quot;passout&quot;, OPT_PASSOUT, 's'},
+    {&quot;rand&quot;, OPT_RAND, 's',
+     &quot;Load the file(s) into the random number generator&quot;},
+    {&quot;newkey&quot;, OPT_NEWKEY, 's', &quot;Specify as type:bits&quot;},
+    {&quot;pkeyopt&quot;, OPT_PKEYOPT, 's'},
+    {&quot;sigopt&quot;, OPT_SIGOPT, 's'},
+    {&quot;batch&quot;, OPT_BATCH, '-',
+     &quot;Do not ask anything during request generation&quot;},
+    {&quot;newhdr&quot;, OPT_NEWHDR, '-', &quot;Output \&quot;NEW\&quot; in the header lines&quot;},
+    {&quot;modulus&quot;, OPT_MODULUS, '-', &quot;RSA modulus&quot;},
+    {&quot;verify&quot;, OPT_VERIFY, '-', &quot;Verify signature on REQ&quot;},
+    {&quot;nodes&quot;, OPT_NODES, '-', &quot;Don't encrypt the output key&quot;},
+    {&quot;noout&quot;, OPT_NOOUT, '-', &quot;Do not output REQ&quot;},
+    {&quot;verbose&quot;, OPT_VERBOSE, '-'},
+    {&quot;utf8&quot;, OPT_UTF8, '-', &quot;Input characters are UTF8 (default ASCII)&quot;},
+    {&quot;nameopt&quot;, OPT_NAMEOPT, 's', &quot;Various certificate name options&quot;},
+    {&quot;reqopt&quot;, OPT_REQOPT, 's', &quot;Various request text options&quot;},
+    {&quot;text&quot;, OPT_TEXT, '-', &quot;Text form of request&quot;},
+    {&quot;x509&quot;, OPT_X509, '-',
+     &quot;Output a x509 structure instead of a cert request&quot;},
+    {&quot;asn1-kludge&quot;, OPT_ASN1_KLUDGE, '-',
+     &quot;Output the request in a format that is wrong&quot;},
+    {OPT_MORE_STR, 1, 1, &quot;(Required by some CA's)&quot;},
+    {&quot;no-asn1-kludge&quot;, OPT_NO_ASN1_KLUDGE, '-'},
+    {&quot;subject&quot;, OPT_SUBJECT, 's', &quot;Output the request's subject&quot;},
+    {&quot;multivalue-rdn&quot;, OPT_MULTIVALUE_RDN, '-',
+     &quot;Enable support for multivalued RDNs&quot;},
+    {&quot;days&quot;, OPT_DAYS, 'p', &quot;Number of days cert is valid for&quot;},
+    {&quot;set-serial&quot;, OPT_SET_SERIAL, 'p', &quot;Serial number to use&quot;},
+    {&quot;extensions&quot;, OPT_EXTENSIONS, 's',
+     &quot;Cert extension section (override value in config file)&quot;},
+    {&quot;reqexts&quot;, OPT_REQEXTS, 's',
+     &quot;Request extension section (override value in config file)&quot;},
+#ifndef OPENSSL_NO_ENGINE
+    {&quot;engine&quot;, OPT_ENGINE, 's', &quot;Use engine, possibly a hardware device&quot;},
+#endif
+    {&quot;&quot;, OPT_MD, '-', &quot;Any supported digest&quot;},
+    {NULL}
+};
 
-int MAIN(int argc, char **argv)
+int req_main(int argc, char **argv)
 {
+    ASN1_INTEGER *serial = NULL;
+    BIO *in = NULL, *out = NULL;
     ENGINE *e = NULL, *gen_eng = NULL;
-    unsigned long nmflag = 0, reqflag = 0;
-    int ex = 1, x509 = 0, days = 30;
-    X509 *x509ss = NULL;
-    X509_REQ *req = NULL;
+    EVP_PKEY *pkey = NULL;
     EVP_PKEY_CTX *genctx = NULL;
-    const char *keyalg = NULL;
-    char *keyalgstr = NULL;
     STACK_OF(OPENSSL_STRING) *pkeyopts = NULL, *sigopts = NULL;
-    EVP_PKEY *pkey = NULL;
-    int i = 0, badops = 0, newreq = 0, verbose = 0, pkey_type = -1;
-    long newkey = -1;
-    BIO *in = NULL, *out = NULL;
-    int informat, outformat, verify = 0, noout = 0, text = 0, keyform =
-        FORMAT_PEM;
-    int nodes = 0, kludge = 0, newhdr = 0, subject = 0, pubkey = 0;
-    char *infile, *outfile, *prog, *keyfile = NULL, *template =
-        NULL, *keyout = NULL;
-#ifndef OPENSSL_NO_ENGINE
-    char *engine = NULL;
-#endif
-    char *extensions = NULL;
-    char *req_exts = NULL;
+    X509 *x509ss = NULL;
+    X509_REQ *req = NULL;
     const EVP_CIPHER *cipher = NULL;
-    ASN1_INTEGER *serial = NULL;
-    int modulus = 0;
-    char *inrand = NULL;
-    char *passargin = NULL, *passargout = NULL;
-    char *passin = NULL, *passout = NULL;
-    char *p;
-    char *subj = NULL;
-    int multirdn = 0;
     const EVP_MD *md_alg = NULL, *digest = NULL;
-    unsigned long chtype = MBSTRING_ASC;
-#ifndef MONOLITH
-    char *to_free;
-    long errline;
-#endif
+    char *engine = NULL, *extensions = NULL, *infile = NULL;
+    char *outfile = NULL, *keyfile = NULL, *inrand = NULL;
+    char *keyalgstr = NULL, *p, *prog, *passargin = NULL, *passargout = NULL;
+    char *passin = NULL, *passout = NULL, *req_exts = NULL, *subj = NULL;
+    char *template = NULL, *keyout = NULL;
+    const char *keyalg = NULL;
+    OPTION_CHOICE o;
+    int ret = 1, x509 = 0, days = 30, i = 0, newreq = 0, verbose =
+        0, pkey_type = -1;
+    int informat = FORMAT_PEM, outformat = FORMAT_PEM, keyform = FORMAT_PEM;
+    int modulus = 0, multirdn = 0, verify = 0, noout = 0, text = 0;
+    int nodes = 0, kludge = 0, newhdr = 0, subject = 0, pubkey = 0;
+    long newkey = -1;
+    unsigned long chtype = MBSTRING_ASC, nmflag = 0, reqflag = 0;
 
-    req_conf = NULL;
 #ifndef OPENSSL_NO_DES
     cipher = EVP_des_ede3_cbc();
 #endif
-    apps_startup();
-
-    if (bio_err == NULL)
-        if ((bio_err = BIO_new(BIO_s_file())) != NULL)
-            BIO_set_fp(bio_err, stderr, BIO_NOCLOSE | BIO_FP_TEXT);
-
-    infile = NULL;
-    outfile = NULL;
-    informat = FORMAT_PEM;
-    outformat = FORMAT_PEM;
-
-    prog = argv[0];
-    argc--;
-    argv++;
-    while (argc &gt;= 1) {
-        if (strcmp(*argv, &quot;-inform&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            informat = str2fmt(*(++argv));
-        } else if (strcmp(*argv, &quot;-outform&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            outformat = str2fmt(*(++argv));
-        }
+
+    prog = opt_init(argc, argv, req_options);
+    while ((o = opt_next()) != OPT_EOF) {
+        switch (o) {
+        case OPT_EOF:
+        case OPT_ERR:
+ opthelp:
+            BIO_printf(bio_err, &quot;%s: Use -help for summary.\n&quot;, prog);
+            goto end;
+        case OPT_HELP:
+            opt_help(req_options);
+            ret = 0;
+            goto end;
+        case OPT_INFORM:
+            if (!opt_format(opt_arg(), OPT_FMT_PEMDER, &amp;informat))
+                goto opthelp;
+            break;
+        case OPT_OUTFORM:
+            if (!opt_format(opt_arg(), OPT_FMT_PEMDER, &amp;outformat))
+                goto opthelp;
+            break;
 #ifndef OPENSSL_NO_ENGINE
-        else if (strcmp(*argv, &quot;-engine&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            engine = *(++argv);
-        } else if (strcmp(*argv, &quot;-keygen_engine&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            gen_eng = ENGINE_by_id(*(++argv));
+        case OPT_ENGINE:
+            engine = optarg;
+            break;
+        case OPT_KEYGEN_ENGINE:
+            gen_eng = ENGINE_by_id(opt_arg());
             if (gen_eng == NULL) {
                 BIO_printf(bio_err, &quot;Can't find keygen engine %s\n&quot;, *argv);
                 goto end;
             }
-        }
+            break;
 #endif
-        else if (strcmp(*argv, &quot;-key&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            keyfile = *(++argv);
-        } else if (strcmp(*argv, &quot;-pubkey&quot;) == 0) {
+        case OPT_KEY:
+            keyfile = opt_arg();
+            break;
+        case OPT_PUBKEY:
             pubkey = 1;
-        } else if (strcmp(*argv, &quot;-new&quot;) == 0) {
+            break;
+        case OPT_NEW:
             newreq = 1;
-        } else if (strcmp(*argv, &quot;-config&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            template = *(++argv);
-        } else if (strcmp(*argv, &quot;-keyform&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            keyform = str2fmt(*(++argv));
-        } else if (strcmp(*argv, &quot;-in&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            infile = *(++argv);
-        } else if (strcmp(*argv, &quot;-out&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            outfile = *(++argv);
-        } else if (strcmp(*argv, &quot;-keyout&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            keyout = *(++argv);
-        } else if (strcmp(*argv, &quot;-passin&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            passargin = *(++argv);
-        } else if (strcmp(*argv, &quot;-passout&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            passargout = *(++argv);
-        } else if (strcmp(*argv, &quot;-rand&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            inrand = *(++argv);
-        } else if (strcmp(*argv, &quot;-newkey&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            keyalg = *(++argv);
+            break;
+        case OPT_CONFIG:
+            template = opt_arg();
+            break;
+        case OPT_KEYFORM:
+            if (!opt_format(opt_arg(), OPT_FMT_PEMDER, &amp;keyform))
+                goto opthelp;
+            break;
+        case OPT_IN:
+            infile = opt_arg();
+            break;
+        case OPT_OUT:
+            outfile = opt_arg();
+            break;
+        case OPT_KEYOUT:
+            keyout = opt_arg();
+            break;
+        case OPT_PASSIN:
+            passargin = opt_arg();
+            break;
+        case OPT_PASSOUT:
+            passargout = opt_arg();
+            break;
+        case OPT_RAND:
+            inrand = opt_arg();
+            break;
+        case OPT_NEWKEY:
+            keyalg = opt_arg();
             newreq = 1;
-        } else if (strcmp(*argv, &quot;-pkeyopt&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
+            break;
+        case OPT_PKEYOPT:
             if (!pkeyopts)
                 pkeyopts = sk_OPENSSL_STRING_new_null();
-            if (!pkeyopts || !sk_OPENSSL_STRING_push(pkeyopts, *(++argv)))
-                goto bad;
-        } else if (strcmp(*argv, &quot;-sigopt&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
+            if (!pkeyopts || !sk_OPENSSL_STRING_push(pkeyopts, opt_arg()))
+                goto opthelp;
+            break;
+        case OPT_SIGOPT:
             if (!sigopts)
                 sigopts = sk_OPENSSL_STRING_new_null();
-            if (!sigopts || !sk_OPENSSL_STRING_push(sigopts, *(++argv)))
-                goto bad;
-        } else if (strcmp(*argv, &quot;-batch&quot;) == 0)
+            if (!sigopts || !sk_OPENSSL_STRING_push(sigopts, opt_arg()))
+                goto opthelp;
+            break;
+        case OPT_BATCH:
             batch = 1;
-        else if (strcmp(*argv, &quot;-newhdr&quot;) == 0)
+            break;
+        case OPT_NEWHDR:
             newhdr = 1;
-        else if (strcmp(*argv, &quot;-modulus&quot;) == 0)
+            break;
+        case OPT_MODULUS:
             modulus = 1;
-        else if (strcmp(*argv, &quot;-verify&quot;) == 0)
+            break;
+        case OPT_VERIFY:
             verify = 1;
-        else if (strcmp(*argv, &quot;-nodes&quot;) == 0)
+            break;
+        case OPT_NODES:
             nodes = 1;
-        else if (strcmp(*argv, &quot;-noout&quot;) == 0)
+            break;
+        case OPT_NOOUT:
             noout = 1;
-        else if (strcmp(*argv, &quot;-verbose&quot;) == 0)
+            break;
+        case OPT_VERBOSE:
             verbose = 1;
-        else if (strcmp(*argv, &quot;-utf8&quot;) == 0)
+            break;
+        case OPT_UTF8:
             chtype = MBSTRING_UTF8;
-        else if (strcmp(*argv, &quot;-nameopt&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            if (!set_name_ex(&amp;nmflag, *(++argv)))
-                goto bad;
-        } else if (strcmp(*argv, &quot;-reqopt&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            if (!set_cert_ex(&amp;reqflag, *(++argv)))
-                goto bad;
-        } else if (strcmp(*argv, &quot;-subject&quot;) == 0)
-            subject = 1;
-        else if (strcmp(*argv, &quot;-text&quot;) == 0)
+            break;
+        case OPT_NAMEOPT:
+            if (!set_name_ex(&amp;nmflag, opt_arg()))
+                goto opthelp;
+            break;
+        case OPT_REQOPT:
+            if (!set_cert_ex(&amp;reqflag, opt_arg()))
+                goto opthelp;
+            break;
+        case OPT_TEXT:
             text = 1;
-        else if (strcmp(*argv, &quot;-x509&quot;) == 0)
+            break;
+        case OPT_X509:
             x509 = 1;
-        else if (strcmp(*argv, &quot;-asn1-kludge&quot;) == 0)
+            break;
+        case OPT_ASN1_KLUDGE:
             kludge = 1;
-        else if (strcmp(*argv, &quot;-no-asn1-kludge&quot;) == 0)
+            break;
+        case OPT_NO_ASN1_KLUDGE:
             kludge = 0;
-        else if (strcmp(*argv, &quot;-subj&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            subj = *(++argv);
-        } else if (strcmp(*argv, &quot;-multivalue-rdn&quot;) == 0)
+            break;
+            multirdn = 1;
+        case OPT_DAYS:
+            days = atoi(opt_arg());
+            break;
+        case OPT_SET_SERIAL:
+            serial = s2i_ASN1_INTEGER(NULL, opt_arg());
+            if (serial == NULL)
+                goto opthelp;
+            break;
+        case OPT_SUBJECT:
+            subj = opt_arg();
+            break;
+        case OPT_MULTIVALUE_RDN:
             multirdn = 1;
-        else if (strcmp(*argv, &quot;-days&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            days = atoi(*(++argv));
-            if (days == 0)
-                days = 30;
-        } else if (strcmp(*argv, &quot;-set_serial&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            serial = s2i_ASN1_INTEGER(NULL, *(++argv));
-            if (!serial)
-                goto bad;
-        } else if (strcmp(*argv, &quot;-extensions&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            extensions = *(++argv);
-        } else if (strcmp(*argv, &quot;-reqexts&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            req_exts = *(++argv);
-        } else if ((md_alg = EVP_get_digestbyname(&amp;((*argv)[1]))) != NULL) {
-            /* ok */
+            break;
+        case OPT_EXTENSIONS:
+            extensions = opt_arg();
+            break;
+        case OPT_REQEXTS:
+            req_exts = opt_arg();
+            break;
+        case OPT_MD:
+            if (!opt_md(opt_unknown(), &amp;md_alg))
+                goto opthelp;
             digest = md_alg;
-        } else {
-            BIO_printf(bio_err, &quot;unknown option %s\n&quot;, *argv);
-            badops = 1;
             break;
         }
-        argc--;
-        argv++;
-    }
-
-    if (badops) {
- bad:
-        BIO_printf(bio_err, &quot;%s [options] &lt;infile &gt;outfile\n&quot;, prog);
-        BIO_printf(bio_err, &quot;where options  are\n&quot;);
-        BIO_printf(bio_err, &quot; -inform arg    input format - DER or PEM\n&quot;);
-        BIO_printf(bio_err, &quot; -outform arg   output format - DER or PEM\n&quot;);
-        BIO_printf(bio_err, &quot; -in arg        input file\n&quot;);
-        BIO_printf(bio_err, &quot; -out arg       output file\n&quot;);
-        BIO_printf(bio_err, &quot; -text          text form of request\n&quot;);
-        BIO_printf(bio_err, &quot; -pubkey        output public key\n&quot;);
-        BIO_printf(bio_err, &quot; -noout         do not output REQ\n&quot;);
-        BIO_printf(bio_err, &quot; -verify        verify signature on REQ\n&quot;);
-        BIO_printf(bio_err, &quot; -modulus       RSA modulus\n&quot;);
-        BIO_printf(bio_err, &quot; -nodes         don't encrypt the output key\n&quot;);
-#ifndef OPENSSL_NO_ENGINE
-        BIO_printf(bio_err,
-                   &quot; -engine e      use engine e, possibly a hardware device\n&quot;);
-#endif
-        BIO_printf(bio_err, &quot; -subject       output the request's subject\n&quot;);
-        BIO_printf(bio_err, &quot; -passin        private key password source\n&quot;);
-        BIO_printf(bio_err,
-                   &quot; -key file      use the private key contained in file\n&quot;);
-        BIO_printf(bio_err, &quot; -keyform arg   key file format\n&quot;);
-        BIO_printf(bio_err, &quot; -keyout arg    file to send the key to\n&quot;);
-        BIO_printf(bio_err, &quot; -rand file%cfile%c...\n&quot;, LIST_SEPARATOR_CHAR,
-                   LIST_SEPARATOR_CHAR);
-        BIO_printf(bio_err,
-                   &quot;                load the file (or the files in the directory) into\n&quot;);
-        BIO_printf(bio_err, &quot;                the random number generator\n&quot;);
-        BIO_printf(bio_err,
-                   &quot; -newkey rsa:bits generate a new RSA key of 'bits' in size\n&quot;);
-        BIO_printf(bio_err,
-                   &quot; -newkey dsa:file generate a new DSA key, parameters taken from CA in 'file'\n&quot;);
-#ifndef OPENSSL_NO_EC
-        BIO_printf(bio_err,
-                   &quot; -newkey ec:file generate a new EC key, parameters taken from CA in 'file'\n&quot;);
-#endif
-        BIO_printf(bio_err,
-                   &quot; -[digest]      Digest to sign with (md5, sha1, md2, mdc2, md4)\n&quot;);
-        BIO_printf(bio_err, &quot; -config file   request template file.\n&quot;);
-        BIO_printf(bio_err,
-                   &quot; -subj arg      set or modify request subject\n&quot;);
-        BIO_printf(bio_err,
-                   &quot; -multivalue-rdn enable support for multivalued RDNs\n&quot;);
-        BIO_printf(bio_err, &quot; -new           new request.\n&quot;);
-        BIO_printf(bio_err,
-                   &quot; -batch         do not ask anything during request generation\n&quot;);
-        BIO_printf(bio_err,
-                   &quot; -x509          output a x509 structure instead of a cert. req.\n&quot;);
-        BIO_printf(bio_err,
-                   &quot; -days          number of days a certificate generated by -x509 is valid for.\n&quot;);
-        BIO_printf(bio_err,
-                   &quot; -set_serial    serial number to use for a certificate generated by -x509.\n&quot;);
-        BIO_printf(bio_err,
-                   &quot; -newhdr        output \&quot;NEW\&quot; in the header lines\n&quot;);
-        BIO_printf(bio_err,
-                   &quot; -asn1-kludge   Output the 'request' in a format that is wrong but some CA's\n&quot;);
-        BIO_printf(bio_err,
-                   &quot;                have been reported as requiring\n&quot;);
-        BIO_printf(bio_err,
-                   &quot; -extensions .. specify certificate extension section (override value in config file)\n&quot;);
-        BIO_printf(bio_err,
-                   &quot; -reqexts ..    specify request extension section (override value in config file)\n&quot;);
-        BIO_printf(bio_err,
-                   &quot; -utf8          input characters are UTF8 (default ASCII)\n&quot;);
-        BIO_printf(bio_err,
-                   &quot; -nameopt arg    - various certificate name options\n&quot;);
-        BIO_printf(bio_err,
-                   &quot; -reqopt arg    - various request text options\n\n&quot;);
-        goto end;
     }
+    argc = opt_num_rest();
+    argv = opt_rest();
 
-    ERR_load_crypto_strings();
-    if (!app_passwd(bio_err, passargin, passargout, &amp;passin, &amp;passout)) {
+    if (!app_passwd(passargin, passargout, &amp;passin, &amp;passout)) {
         BIO_printf(bio_err, &quot;Error getting passwords\n&quot;);
         goto end;
     }
-#ifndef MONOLITH                /* else this has happened in openssl.c
-                                 * (global `config') */
-    /* Lets load up our environment a little */
-    p = getenv(&quot;OPENSSL_CONF&quot;);
-    if (p == NULL)
-        p = getenv(&quot;SSLEAY_CONF&quot;);
-    if (p == NULL)
-        p = to_free = make_config_name();
-    default_config_file = p;
-    config = NCONF_new(NULL);
-    i = NCONF_load(config, p, &amp;errline);
-#endif
 
     if (template != NULL) {
         long errline = -1;
@@ -481,8 +403,6 @@ int MAIN(int argc, char **argv)
     }
 
     if (req_conf != NULL) {
-        if (!load_config(bio_err, req_conf))
-            goto end;
         p = NCONF_get_string(req_conf, NULL, &quot;oid_file&quot;);
         if (p == NULL)
             ERR_clear_error();
@@ -501,16 +421,17 @@ int MAIN(int argc, char **argv)
             }
         }
     }
-    if (!add_oid_section(bio_err, req_conf))
+    if (!add_oid_section(req_conf))
         goto end;
 
     if (md_alg == NULL) {
         p = NCONF_get_string(req_conf, SECTION, &quot;default_md&quot;);
         if (p == NULL)
             ERR_clear_error();
-        if (p != NULL) {
-            if ((md_alg = EVP_get_digestbyname(p)) != NULL)
-                digest = md_alg;
+        else {
+            if (!opt_md(p, &amp;md_alg))
+                goto opthelp;
+            digest = md_alg;
         }
     }
 
@@ -577,29 +498,20 @@ int MAIN(int argc, char **argv)
             goto end;
         }
     }
-
-    in = BIO_new(BIO_s_file());
-    out = BIO_new(BIO_s_file());
-    if ((in == NULL) || (out == NULL))
-        goto end;
-
 #ifndef OPENSSL_NO_ENGINE
-    e = setup_engine(bio_err, engine, 0);
+    e = setup_engine(engine, 0);
 #endif
 
     if (keyfile != NULL) {
-        pkey = load_key(bio_err, keyfile, keyform, 0, passin, e,
-                        &quot;Private Key&quot;);
+        pkey = load_key(keyfile, keyform, 0, passin, e, &quot;Private Key&quot;);
         if (!pkey) {
-            /*
-             * load_key() has already printed an appropriate message
-             */
+            /* load_key() has already printed an appropriate message */
             goto end;
         } else {
             char *randfile = NCONF_get_string(req_conf, SECTION, &quot;RANDFILE&quot;);
             if (randfile == NULL)
                 ERR_clear_error();
-            app_RAND_load_file(randfile, bio_err, 0);
+            app_RAND_load_file(randfile, 0);
         }
     }
 
@@ -607,7 +519,7 @@ int MAIN(int argc, char **argv)
         char *randfile = NCONF_get_string(req_conf, SECTION, &quot;RANDFILE&quot;);
         if (randfile == NULL)
             ERR_clear_error();
-        app_RAND_load_file(randfile, bio_err, 0);
+        app_RAND_load_file(randfile, 0);
         if (inrand)
             app_RAND_load_files(inrand);
 
@@ -616,7 +528,7 @@ int MAIN(int argc, char **argv)
         }
 
         if (keyalg) {
-            genctx = set_keygen_ctx(bio_err, keyalg, &amp;pkey_type, &amp;newkey,
+            genctx = set_keygen_ctx(keyalg, &amp;pkey_type, &amp;newkey,
                                     &amp;keyalgstr, gen_eng);
             if (!genctx)
                 goto end;
@@ -631,7 +543,7 @@ int MAIN(int argc, char **argv)
         }
 
         if (!genctx) {
-            genctx = set_keygen_ctx(bio_err, NULL, &amp;pkey_type, &amp;newkey,
+            genctx = set_keygen_ctx(NULL, &amp;pkey_type, &amp;newkey,
                                     &amp;keyalgstr, gen_eng);
             if (!genctx)
                 goto end;
@@ -663,7 +575,7 @@ int MAIN(int argc, char **argv)
         EVP_PKEY_CTX_free(genctx);
         genctx = NULL;
 
-        app_RAND_write_file(randfile, bio_err);
+        app_RAND_write_file(randfile);
 
         if (keyout == NULL) {
             keyout = NCONF_get_string(req_conf, SECTION, KEYFILE);
@@ -671,22 +583,13 @@ int MAIN(int argc, char **argv)
                 ERR_clear_error();
         }
 
-        if (keyout == NULL) {
+        if (keyout == NULL)
             BIO_printf(bio_err, &quot;writing new private key to stdout\n&quot;);
-            BIO_set_fp(out, stdout, BIO_NOCLOSE);
-#ifdef OPENSSL_SYS_VMS
-            {
-                BIO *tmpbio = BIO_new(BIO_f_linebuffer());
-                out = BIO_push(tmpbio, out);
-            }
-#endif
-        } else {
+        else
             BIO_printf(bio_err, &quot;writing new private key to '%s'\n&quot;, keyout);
-            if (BIO_write_filename(out, keyout) &lt;= 0) {
-                perror(keyout);
-                goto end;
-            }
-        }
+        out = bio_open_default(keyout, &quot;w&quot;);
+        if (out == NULL)
+            goto end;
 
         p = NCONF_get_string(req_conf, SECTION, &quot;encrypt_rsa_key&quot;);
         if (p == NULL) {
@@ -721,24 +624,14 @@ int MAIN(int argc, char **argv)
          * 'format' info should not be changed.
          */
         kludge = -1;
-        if (infile == NULL)
-            BIO_set_fp(in, stdin, BIO_NOCLOSE);
-        else {
-            if (BIO_read_filename(in, infile) &lt;= 0) {
-                perror(infile);
-                goto end;
-            }
-        }
+        in = bio_open_default(infile, RB(informat));
+        if (in == NULL)
+            goto end;
 
         if (informat == FORMAT_ASN1)
             req = d2i_X509_REQ_bio(in, NULL);
-        else if (informat == FORMAT_PEM)
+        else
             req = PEM_read_bio_X509_REQ(in, NULL, NULL, NULL);
-        else {
-            BIO_printf(bio_err,
-                       &quot;bad input format specified for X509 request\n&quot;);
-            goto end;
-        }
         if (req == NULL) {
             BIO_printf(bio_err, &quot;unable to load X509 request\n&quot;);
             goto end;
@@ -814,7 +707,7 @@ int MAIN(int argc, char **argv)
                 goto end;
             }
 
-            i = do_X509_sign(bio_err, x509ss, pkey, digest, sigopts);
+            i = do_X509_sign(x509ss, pkey, digest, sigopts);
             if (!i) {
                 ERR_print_errors(bio_err);
                 goto end;
@@ -835,7 +728,7 @@ int MAIN(int argc, char **argv)
                            req_exts);
                 goto end;
             }
-            i = do_X509_REQ_sign(bio_err, req, pkey, digest, sigopts);
+            i = do_X509_REQ_sign(req, pkey, digest, sigopts);
             if (!i) {
                 ERR_print_errors(bio_err);
                 goto end;
@@ -857,7 +750,7 @@ int MAIN(int argc, char **argv)
 
         if (build_subject(req, subj, chtype, multirdn) == 0) {
             BIO_printf(bio_err, &quot;ERROR: cannot modify subject\n&quot;);
-            ex = 1;
+            ret = 1;
             goto end;
         }
 
@@ -874,9 +767,9 @@ int MAIN(int argc, char **argv)
 
         if (pkey == NULL) {
             pkey = X509_REQ_get_pubkey(req);
+            tmp = 1;
             if (pkey == NULL)
                 goto end;
-            tmp = 1;
         }
 
         i = X509_REQ_verify(req, pkey);
@@ -895,28 +788,15 @@ int MAIN(int argc, char **argv)
     }
 
     if (noout &amp;&amp; !text &amp;&amp; !modulus &amp;&amp; !subject &amp;&amp; !pubkey) {
-        ex = 0;
+        ret = 0;
         goto end;
     }
 
-    if (outfile == NULL) {
-        BIO_set_fp(out, stdout, BIO_NOCLOSE);
-#ifdef OPENSSL_SYS_VMS
-        {
-            BIO *tmpbio = BIO_new(BIO_f_linebuffer());
-            out = BIO_push(tmpbio, out);
-        }
-#endif
-    } else {
-        if ((keyout != NULL) &amp;&amp; (strcmp(outfile, keyout) == 0))
-            i = (int)BIO_append_filename(out, outfile);
-        else
-            i = (int)BIO_write_filename(out, outfile);
-        if (!i) {
-            perror(outfile);
-            goto end;
-        }
-    }
+    out = bio_open_default(outfile,
+                           keyout != NULL &amp;&amp; outfile != NULL &amp;&amp;
+                           strcmp(keyout, outfile) == 0 ? &quot;a&quot; : &quot;w&quot;);
+    if (out == NULL)
+        goto end;
 
     if (pubkey) {
         EVP_PKEY *tpubkey;
@@ -971,15 +851,10 @@ int MAIN(int argc, char **argv)
     if (!noout &amp;&amp; !x509) {
         if (outformat == FORMAT_ASN1)
             i = i2d_X509_REQ_bio(out, req);
-        else if (outformat == FORMAT_PEM) {
-            if (newhdr)
-                i = PEM_write_bio_X509_REQ_NEW(out, req);
-            else
-                i = PEM_write_bio_X509_REQ(out, req);
-        } else {
-            BIO_printf(bio_err, &quot;bad output format specified for outfile\n&quot;);
-            goto end;
-        }
+        else if (newhdr)
+            i = PEM_write_bio_X509_REQ_NEW(out, req);
+        else
+            i = PEM_write_bio_X509_REQ(out, req);
         if (!i) {
             BIO_printf(bio_err, &quot;unable to write X509 request\n&quot;);
             goto end;
@@ -988,24 +863,16 @@ int MAIN(int argc, char **argv)
     if (!noout &amp;&amp; x509 &amp;&amp; (x509ss != NULL)) {
         if (outformat == FORMAT_ASN1)
             i = i2d_X509_bio(out, x509ss);
-        else if (outformat == FORMAT_PEM)
+        else
             i = PEM_write_bio_X509(out, x509ss);
-        else {
-            BIO_printf(bio_err, &quot;bad output format specified for outfile\n&quot;);
-            goto end;
-        }
         if (!i) {
             BIO_printf(bio_err, &quot;unable to write X509 certificate\n&quot;);
             goto end;
         }
     }
-    ex = 0;
+    ret = 0;
  end:
-#ifndef MONOLITH
-    if (to_free)
-        OPENSSL_free(to_free);
-#endif
-    if (ex) {
+    if (ret) {
         ERR_print_errors(bio_err);
     }
     if ((req_conf != NULL) &amp;&amp; (req_conf != config))
@@ -1032,8 +899,7 @@ int MAIN(int argc, char **argv)
     if (passargout &amp;&amp; passout)
         OPENSSL_free(passout);
     OBJ_cleanup();
-    apps_shutdown();
-    OPENSSL_EXIT(ex);
+    return (ret);
 }
 
 static int make_REQ(X509_REQ *req, EVP_PKEY *pkey, char *subj, int multirdn,
@@ -1499,7 +1365,7 @@ static int check_end(const char *str, const char *end)
     return strcmp(tmp, end);
 }
 
-static EVP_PKEY_CTX *set_keygen_ctx(BIO *err, const char *gstr,
+static EVP_PKEY_CTX *set_keygen_ctx(const char *gstr,
                                     int *pkey_type, long *pkeylen,
                                     char **palgnam, ENGINE *keygen_engine)
 {
@@ -1536,7 +1402,7 @@ static EVP_PKEY_CTX *set_keygen_ctx(BIO *err, const char *gstr,
         ameth = EVP_PKEY_asn1_find_str(&amp;tmpeng, gstr, len);
 
         if (!ameth) {
-            BIO_printf(err, &quot;Unknown algorithm %.*s\n&quot;, len, gstr);
+            BIO_printf(bio_err, &quot;Unknown algorithm %.*s\n&quot;, len, gstr);
             return NULL;
         }
 
@@ -1558,7 +1424,7 @@ static EVP_PKEY_CTX *set_keygen_ctx(BIO *err, const char *gstr,
     if (paramfile) {
         pbio = BIO_new_file(paramfile, &quot;r&quot;);
         if (!pbio) {
-            BIO_printf(err, &quot;Can't open parameter file %s\n&quot;, paramfile);
+            BIO_printf(bio_err, &quot;Can't open parameter file %s\n&quot;, paramfile);
             return NULL;
         }
         param = PEM_read_bio_Parameters(pbio, NULL);
@@ -1576,13 +1442,13 @@ static EVP_PKEY_CTX *set_keygen_ctx(BIO *err, const char *gstr,
         BIO_free(pbio);
 
         if (!param) {
-            BIO_printf(err, &quot;Error reading parameter file %s\n&quot;, paramfile);
+            BIO_printf(bio_err, &quot;Error reading parameter file %s\n&quot;, paramfile);
             return NULL;
         }
         if (*pkey_type == -1)
             *pkey_type = EVP_PKEY_id(param);
         else if (*pkey_type != EVP_PKEY_base_id(param)) {
-            BIO_printf(err, &quot;Key Type does not match parameters\n&quot;);
+            BIO_printf(bio_err, &quot;Key Type does not match parameters\n&quot;);
             EVP_PKEY_free(param);
             return NULL;
         }
@@ -1594,7 +1460,7 @@ static EVP_PKEY_CTX *set_keygen_ctx(BIO *err, const char *gstr,
         const char *anam;
         ameth = EVP_PKEY_asn1_find(&amp;tmpeng, *pkey_type);
         if (!ameth) {
-            BIO_puts(err, &quot;Internal error: can't find key algorithm\n&quot;);
+            BIO_puts(bio_err, &quot;Internal error: can't find key algorithm\n&quot;);
             return NULL;
         }
         EVP_PKEY_asn1_get0_info(NULL, NULL, NULL, NULL, &amp;anam, ameth);
@@ -1613,21 +1479,21 @@ static EVP_PKEY_CTX *set_keygen_ctx(BIO *err, const char *gstr,
         gctx = EVP_PKEY_CTX_new_id(*pkey_type, keygen_engine);
 
     if (!gctx) {
-        BIO_puts(err, &quot;Error allocating keygen context\n&quot;);
-        ERR_print_errors(err);
+        BIO_puts(bio_err, &quot;Error allocating keygen context\n&quot;);
+        ERR_print_errors(bio_err);
         return NULL;
     }
 
     if (EVP_PKEY_keygen_init(gctx) &lt;= 0) {
-        BIO_puts(err, &quot;Error initializing keygen context\n&quot;);
-        ERR_print_errors(err);
+        BIO_puts(bio_err, &quot;Error initializing keygen context\n&quot;);
+        ERR_print_errors(bio_err);
         return NULL;
     }
 #ifndef OPENSSL_NO_RSA
     if ((*pkey_type == EVP_PKEY_RSA) &amp;&amp; (keylen != -1)) {
         if (EVP_PKEY_CTX_set_rsa_keygen_bits(gctx, keylen) &lt;= 0) {
-            BIO_puts(err, &quot;Error setting RSA keysize\n&quot;);
-            ERR_print_errors(err);
+            BIO_puts(bio_err, &quot;Error setting RSA keysize\n&quot;);
+            ERR_print_errors(bio_err);
             EVP_PKEY_CTX_free(gctx);
             return NULL;
         }
@@ -1656,18 +1522,19 @@ static int genpkey_cb(EVP_PKEY_CTX *ctx)
     return 1;
 }
 
-static int do_sign_init(BIO *err, EVP_MD_CTX *ctx, EVP_PKEY *pkey,
+static int do_sign_init(EVP_MD_CTX *ctx, EVP_PKEY *pkey,
                         const EVP_MD *md, STACK_OF(OPENSSL_STRING) *sigopts)
 {
     EVP_PKEY_CTX *pkctx = NULL;
     int i;
+
     EVP_MD_CTX_init(ctx);
     if (!EVP_DigestSignInit(ctx, &amp;pkctx, md, NULL, pkey))
         return 0;
     for (i = 0; i &lt; sk_OPENSSL_STRING_num(sigopts); i++) {
         char *sigopt = sk_OPENSSL_STRING_value(sigopts, i);
         if (pkey_ctrl_string(pkctx, sigopt) &lt;= 0) {
-            BIO_printf(err, &quot;parameter error \&quot;%s\&quot;\n&quot;, sigopt);
+            BIO_printf(bio_err, &quot;parameter error \&quot;%s\&quot;\n&quot;, sigopt);
             ERR_print_errors(bio_err);
             return 0;
         }
@@ -1675,39 +1542,42 @@ static int do_sign_init(BIO *err, EVP_MD_CTX *ctx, EVP_PKEY *pkey,
     return 1;
 }
 
-int do_X509_sign(BIO *err, X509 *x, EVP_PKEY *pkey, const EVP_MD *md,
+int do_X509_sign(X509 *x, EVP_PKEY *pkey, const EVP_MD *md,
                  STACK_OF(OPENSSL_STRING) *sigopts)
 {
     int rv;
     EVP_MD_CTX mctx;
+
     EVP_MD_CTX_init(&amp;mctx);
-    rv = do_sign_init(err, &amp;mctx, pkey, md, sigopts);
+    rv = do_sign_init(&amp;mctx, pkey, md, sigopts);
     if (rv &gt; 0)
         rv = X509_sign_ctx(x, &amp;mctx);
     EVP_MD_CTX_cleanup(&amp;mctx);
     return rv &gt; 0 ? 1 : 0;
 }
 
-int do_X509_REQ_sign(BIO *err, X509_REQ *x, EVP_PKEY *pkey, const EVP_MD *md,
+int do_X509_REQ_sign(X509_REQ *x, EVP_PKEY *pkey, const EVP_MD *md,
                      STACK_OF(OPENSSL_STRING) *sigopts)
 {
     int rv;
     EVP_MD_CTX mctx;
+
     EVP_MD_CTX_init(&amp;mctx);
-    rv = do_sign_init(err, &amp;mctx, pkey, md, sigopts);
+    rv = do_sign_init(&amp;mctx, pkey, md, sigopts);
     if (rv &gt; 0)
         rv = X509_REQ_sign_ctx(x, &amp;mctx);
     EVP_MD_CTX_cleanup(&amp;mctx);
     return rv &gt; 0 ? 1 : 0;
 }
 
-int do_X509_CRL_sign(BIO *err, X509_CRL *x, EVP_PKEY *pkey, const EVP_MD *md,
+int do_X509_CRL_sign(X509_CRL *x, EVP_PKEY *pkey, const EVP_MD *md,
                      STACK_OF(OPENSSL_STRING) *sigopts)
 {
     int rv;
     EVP_MD_CTX mctx;
+
     EVP_MD_CTX_init(&amp;mctx);
-    rv = do_sign_init(err, &amp;mctx, pkey, md, sigopts);
+    rv = do_sign_init(&amp;mctx, pkey, md, sigopts);
     if (rv &gt; 0)
         rv = X509_CRL_sign_ctx(x, &amp;mctx);
     EVP_MD_CTX_cleanup(&amp;mctx);
diff --git a/apps/rsa.c b/apps/rsa.c
index 2f3f871..7f7069c 100644
--- a/apps/rsa.c
+++ b/apps/rsa.c
@@ -1,4 +1,3 @@
-/* apps/rsa.c */
 /* Copyright (C) 1995-1998 Eric Young (<A HREF="../../../mailman/listinfo/openssl-commits.html">eay at cryptsoft.com</A>)
  * All rights reserved.
  *
@@ -55,6 +54,54 @@
  * copied and put under another distribution licence
  * [including the GNU Public Licence.]
  */
+/* ====================================================================
+ * Copyright (c) 1999-2015 The OpenSSL Project.  All rights reserved.
+ *
+ * Redistribution and use in source and binary forms, with or without
+ * modification, are permitted provided that the following conditions
+ * are met:
+ *
+ * 1. Redistributions of source code must retain the above copyright
+ *    notice, this list of conditions and the following disclaimer.
+ *
+ * 2. Redistributions in binary form must reproduce the above copyright
+ *    notice, this list of conditions and the following disclaimer in
+ *    the documentation and/or other materials provided with the
+ *    distribution.
+ *
+ * 3. All advertising materials mentioning features or use of this
+ *    software must display the following acknowledgment:
+ *    &quot;This product includes software developed by the OpenSSL Project
+ *    for use in the OpenSSL Toolkit. (<A HREF="http://www.OpenSSL.org/">http://www.OpenSSL.org/</A>)&quot;
+ *
+ * 4. The names &quot;OpenSSL Toolkit&quot; and &quot;OpenSSL Project&quot; must not be used to
+ *    endorse or promote products derived from this software without
+ *    prior written permission. For written permission, please contact
+ *    <A HREF="../../../mailman/listinfo/openssl-commits.html">licensing at OpenSSL.org.</A>
+ *
+ * 5. Products derived from this software may not be called &quot;OpenSSL&quot;
+ *    nor may &quot;OpenSSL&quot; appear in their names without prior written
+ *    permission of the OpenSSL Project.
+ *
+ * 6. Redistributions of any form whatsoever must retain the following
+ *    acknowledgment:
+ *    &quot;This product includes software developed by the OpenSSL Project
+ *    for use in the OpenSSL Toolkit (<A HREF="http://www.OpenSSL.org/">http://www.OpenSSL.org/</A>)&quot;
+ *
+ * THIS SOFTWARE IS PROVIDED BY THE OpenSSL PROJECT ``AS IS'' AND ANY
+ * EXPRESSED OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
+ * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR
+ * PURPOSE ARE DISCLAIMED.  IN NO EVENT SHALL THE OpenSSL PROJECT OR
+ * ITS CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
+ * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT
+ * NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;
+ * LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)
+ * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT,
+ * STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)
+ * ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED
+ * OF THE POSSIBILITY OF SUCH DAMAGE.
+ * ====================================================================
+ */
 
 #include &lt;openssl/opensslconf.h&gt;
 #ifndef OPENSSL_NO_RSA
@@ -71,197 +118,142 @@
 # include &lt;openssl/pem.h&gt;
 # include &lt;openssl/bn.h&gt;
 
-# undef PROG
-# define PROG    rsa_main
-
-/*-
- * -inform arg  - input format - default PEM (one of DER, NET or PEM)
- * -outform arg - output format - default PEM
- * -in arg      - input file - default stdin
- * -out arg     - output file - default stdout
- * -des         - encrypt output if PEM format with DES in cbc mode
- * -des3        - encrypt output if PEM format
- * -idea        - encrypt output if PEM format
- * -seed        - encrypt output if PEM format
- * -aes128      - encrypt output if PEM format
- * -aes192      - encrypt output if PEM format
- * -aes256      - encrypt output if PEM format
- * -camellia128 - encrypt output if PEM format
- * -camellia192 - encrypt output if PEM format
- * -camellia256 - encrypt output if PEM format
- * -text        - print a text version
- * -modulus     - print the RSA key modulus
- * -check       - verify key consistency
- * -pubin       - Expect a public key in input file.
- * -pubout      - Output a public key.
- */
-
-int MAIN(int, char **);
+typedef enum OPTION_choice {
+    OPT_ERR = -1, OPT_EOF = 0, OPT_HELP,
+    OPT_INFORM, OPT_OUTFORM, OPT_ENGINE, OPT_IN, OPT_OUT,
+    OPT_PUBIN, OPT_PUBOUT, OPT_PASSOUT, OPT_PASSIN,
+    OPT_RSAPUBKEY_IN, OPT_RSAPUBKEY_OUT, OPT_PVK_STRONG, OPT_PVK_WEAK,
+    OPT_PVK_NONE, OPT_NOOUT, OPT_TEXT, OPT_MODULUS, OPT_CHECK, OPT_CIPHER
+} OPTION_CHOICE;
+
+OPTIONS rsa_options[] = {
+    {&quot;help&quot;, OPT_HELP, '-', &quot;Display this summary&quot;},
+    {&quot;inform&quot;, OPT_INFORM, 'f', &quot;Input format, one of DER NET PEM&quot;},
+    {&quot;outform&quot;, OPT_OUTFORM, 'f', &quot;Output format, one of DER NET PEM PVK&quot;},
+    {&quot;in&quot;, OPT_IN, '&lt;', &quot;Input file&quot;},
+    {&quot;out&quot;, OPT_OUT, '&gt;', &quot;Output file&quot;},
+    {&quot;pubin&quot;, OPT_PUBIN, '-', &quot;Expect a public key in input file&quot;},
+    {&quot;pubout&quot;, OPT_PUBOUT, '-', &quot;Output a public key&quot;},
+    {&quot;passout&quot;, OPT_PASSOUT, 's', &quot;Output file pass phrase source&quot;},
+    {&quot;passin&quot;, OPT_PASSIN, 's', &quot;Input file pass phrase source&quot;},
+    {&quot;RSAPublicKey_in&quot;, OPT_RSAPUBKEY_IN, '-', &quot;Input is an RSAPublicKye&quot;},
+    {&quot;RSAPublicKey_out&quot;, OPT_RSAPUBKEY_OUT, '-', &quot;Output is an RSAPublicKye&quot;},
+    {&quot;pvk-strong&quot;, OPT_PVK_STRONG, '-'},
+    {&quot;pvk-weak&quot;, OPT_PVK_WEAK, '-'},
+    {&quot;pvk-none&quot;, OPT_PVK_NONE, '-'},
+    {&quot;noout&quot;, OPT_NOOUT, '-', &quot;Don't print key out&quot;},
+    {&quot;text&quot;, OPT_TEXT, '-', &quot;Print the key in text&quot;},
+    {&quot;modulus&quot;, OPT_MODULUS, '-', &quot;Print the RSA key modulus&quot;},
+    {&quot;check&quot;, OPT_CHECK, '-', &quot;Verify key consistency&quot;},
+    {&quot;&quot;, OPT_CIPHER, '-', &quot;Any supported cipher&quot;},
+# ifndef OPENSSL_NO_ENGINE
+    {&quot;engine&quot;, OPT_ENGINE, 's', &quot;Use engine, possibly a hardware device&quot;},
+# endif
+    {NULL}
+};
 
-int MAIN(int argc, char **argv)
+int rsa_main(int argc, char **argv)
 {
     ENGINE *e = NULL;
-    int ret = 1;
+    BIO *out = NULL;
     RSA *rsa = NULL;
-    int i, badops = 0, sgckey = 0;
     const EVP_CIPHER *enc = NULL;
-    BIO *out = NULL;
-    int informat, outformat, text = 0, check = 0, noout = 0;
-    int pubin = 0, pubout = 0;
-    char *infile, *outfile, *prog;
-    char *passargin = NULL, *passargout = NULL;
-    char *passin = NULL, *passout = NULL;
-# ifndef OPENSSL_NO_ENGINE
-    char *engine = NULL;
-# endif
-    int modulus = 0;
-#ifndef OPENSSL_NO_RC4
-    int pvk_encr = 2;
+    char *engine = NULL, *infile = NULL, *outfile = NULL, *prog;
+    char *passin = NULL, *passout = NULL, *passinarg = NULL, *passoutarg = NULL;
+    int i;
+    int informat = FORMAT_PEM, outformat = FORMAT_PEM, text = 0, check = 0;
+    int noout = 0, modulus = 0, pubin = 0, pubout = 0, pvk_encr = 2, ret = 1;
+    OPTION_CHOICE o;
+
+    prog = opt_init(argc, argv, rsa_options);
+    while ((o = opt_next()) != OPT_EOF) {
+        switch (o) {
+        case OPT_EOF:
+        case OPT_ERR:
+#ifdef OPENSSL_NO_RC4
+        case OPT_PVK_STRONG:
+        case OPT_PVK_WEAK:
+        case OPT_PVK_NONE:
 #endif
-
-    apps_startup();
-
-    if (bio_err == NULL)
-        if ((bio_err = BIO_new(BIO_s_file())) != NULL)
-            BIO_set_fp(bio_err, stderr, BIO_NOCLOSE | BIO_FP_TEXT);
-
-    if (!load_config(bio_err, NULL))
-        goto end;
-
-    infile = NULL;
-    outfile = NULL;
-    informat = FORMAT_PEM;
-    outformat = FORMAT_PEM;
-
-    prog = argv[0];
-    argc--;
-    argv++;
-    while (argc &gt;= 1) {
-        if (strcmp(*argv, &quot;-inform&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            informat = str2fmt(*(++argv));
-        } else if (strcmp(*argv, &quot;-outform&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            outformat = str2fmt(*(++argv));
-        } else if (strcmp(*argv, &quot;-in&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            infile = *(++argv);
-        } else if (strcmp(*argv, &quot;-out&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            outfile = *(++argv);
-        } else if (strcmp(*argv, &quot;-passin&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            passargin = *(++argv);
-        } else if (strcmp(*argv, &quot;-passout&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            passargout = *(++argv);
-        }
-# ifndef OPENSSL_NO_ENGINE
-        else if (strcmp(*argv, &quot;-engine&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            engine = *(++argv);
-        }
-# endif
-        else if (strcmp(*argv, &quot;-sgckey&quot;) == 0)
-            sgckey = 1;
-        else if (strcmp(*argv, &quot;-pubin&quot;) == 0)
+ opthelp:
+            BIO_printf(bio_err, &quot;%s: Use -help for summary.\n&quot;, prog);
+            goto end;
+        case OPT_HELP:
+            opt_help(rsa_options);
+            ret = 0;
+            goto end;
+        case OPT_INFORM:
+            if (!opt_format(opt_arg(), OPT_FMT_ANY, &amp;informat))
+                goto opthelp;
+            break;
+        case OPT_IN:
+            infile = opt_arg();
+            break;
+        case OPT_OUTFORM:
+            if (!opt_format(opt_arg(), OPT_FMT_ANY, &amp;outformat))
+                goto opthelp;
+            break;
+        case OPT_OUT:
+            outfile = opt_arg();
+            break;
+        case OPT_PASSIN:
+            passinarg = opt_arg();
+            break;
+        case OPT_PASSOUT:
+            passoutarg = opt_arg();
+            break;
+        case OPT_ENGINE:
+            engine = opt_arg();
+            break;
+        case OPT_PUBIN:
             pubin = 1;
-        else if (strcmp(*argv, &quot;-pubout&quot;) == 0)
+            break;
+        case OPT_PUBOUT:
             pubout = 1;
-        else if (strcmp(*argv, &quot;-RSAPublicKey_in&quot;) == 0)
+            break;
+        case OPT_RSAPUBKEY_IN:
             pubin = 2;
-        else if (strcmp(*argv, &quot;-RSAPublicKey_out&quot;) == 0)
+            break;
+        case OPT_RSAPUBKEY_OUT:
             pubout = 2;
+            break;
 #ifndef OPENSSL_NO_RC4
-        else if (strcmp(*argv, &quot;-pvk-strong&quot;) == 0)
+        case OPT_PVK_STRONG:
             pvk_encr = 2;
-        else if (strcmp(*argv, &quot;-pvk-weak&quot;) == 0)
+            break;
+        case OPT_PVK_WEAK:
             pvk_encr = 1;
-        else if (strcmp(*argv, &quot;-pvk-none&quot;) == 0)
+            break;
+        case OPT_PVK_NONE:
             pvk_encr = 0;
+            break;
 #endif
-        else if (strcmp(*argv, &quot;-noout&quot;) == 0)
+        case OPT_NOOUT:
             noout = 1;
-        else if (strcmp(*argv, &quot;-text&quot;) == 0)
+            break;
+        case OPT_TEXT:
             text = 1;
-        else if (strcmp(*argv, &quot;-modulus&quot;) == 0)
+            break;
+        case OPT_MODULUS:
             modulus = 1;
-        else if (strcmp(*argv, &quot;-check&quot;) == 0)
+            break;
+        case OPT_CHECK:
             check = 1;
-        else if ((enc = EVP_get_cipherbyname(&amp;(argv[0][1]))) == NULL) {
-            BIO_printf(bio_err, &quot;unknown option %s\n&quot;, *argv);
-            badops = 1;
+            break;
+        case OPT_CIPHER:
+            if (!opt_cipher(opt_unknown(), &amp;enc))
+                goto opthelp;
             break;
         }
-        argc--;
-        argv++;
     }
+    argc = opt_num_rest();
+    argv = opt_rest();
 
-    if (badops) {
- bad:
-        BIO_printf(bio_err, &quot;%s [options] &lt;infile &gt;outfile\n&quot;, prog);
-        BIO_printf(bio_err, &quot;where options are\n&quot;);
-        BIO_printf(bio_err,
-                   &quot; -inform arg     input format - one of DER NET PEM\n&quot;);
-        BIO_printf(bio_err,
-                   &quot; -outform arg    output format - one of DER NET PEM\n&quot;);
-        BIO_printf(bio_err, &quot; -in arg         input file\n&quot;);
-        BIO_printf(bio_err, &quot; -sgckey         Use IIS SGC key format\n&quot;);
-        BIO_printf(bio_err,
-                   &quot; -passin arg     input file pass phrase source\n&quot;);
-        BIO_printf(bio_err, &quot; -out arg        output file\n&quot;);
-        BIO_printf(bio_err,
-                   &quot; -passout arg    output file pass phrase source\n&quot;);
-        BIO_printf(bio_err,
-                   &quot; -des            encrypt PEM output with cbc des\n&quot;);
-        BIO_printf(bio_err,
-                   &quot; -des3           encrypt PEM output with ede cbc des using 168 bit key\n&quot;);
-# ifndef OPENSSL_NO_IDEA
-        BIO_printf(bio_err,
-                   &quot; -idea           encrypt PEM output with cbc idea\n&quot;);
-# endif
-# ifndef OPENSSL_NO_SEED
-        BIO_printf(bio_err,
-                   &quot; -seed           encrypt PEM output with cbc seed\n&quot;);
-# endif
-# ifndef OPENSSL_NO_AES
-        BIO_printf(bio_err, &quot; -aes128, -aes192, -aes256\n&quot;);
-        BIO_printf(bio_err,
-                   &quot;                 encrypt PEM output with cbc aes\n&quot;);
-# endif
-# ifndef OPENSSL_NO_CAMELLIA
-        BIO_printf(bio_err, &quot; -camellia128, -camellia192, -camellia256\n&quot;);
-        BIO_printf(bio_err,
-                   &quot;                 encrypt PEM output with cbc camellia\n&quot;);
-# endif
-        BIO_printf(bio_err, &quot; -text           print the key in text\n&quot;);
-        BIO_printf(bio_err, &quot; -noout          don't print key out\n&quot;);
-        BIO_printf(bio_err, &quot; -modulus        print the RSA key modulus\n&quot;);
-        BIO_printf(bio_err, &quot; -check          verify key consistency\n&quot;);
-        BIO_printf(bio_err,
-                   &quot; -pubin          expect a public key in input file\n&quot;);
-        BIO_printf(bio_err, &quot; -pubout         output a public key\n&quot;);
 # ifndef OPENSSL_NO_ENGINE
-        BIO_printf(bio_err,
-                   &quot; -engine e       use engine e, possibly a hardware device.\n&quot;);
+    e = setup_engine(engine, 0);
 # endif
-        goto end;
-    }
-
-    ERR_load_crypto_strings();
 
-# ifndef OPENSSL_NO_ENGINE
-    e = setup_engine(bio_err, engine, 0);
-# endif
-
-    if (!app_passwd(bio_err, passargin, passargout, &amp;passin, &amp;passout)) {
+    if (!app_passwd(passinarg, passoutarg, &amp;passin, &amp;passout)) {
         BIO_printf(bio_err, &quot;Error getting passwords\n&quot;);
         goto end;
     }
@@ -271,8 +263,6 @@ int MAIN(int argc, char **argv)
         goto end;
     }
 
-    out = BIO_new(BIO_s_file());
-
     {
         EVP_PKEY *pkey;
 
@@ -283,18 +273,12 @@ int MAIN(int argc, char **argv)
                     tmpformat = FORMAT_PEMRSA;
                 else if (informat == FORMAT_ASN1)
                     tmpformat = FORMAT_ASN1RSA;
-            } else if (informat == FORMAT_NETSCAPE &amp;&amp; sgckey)
-                tmpformat = FORMAT_IISSGC;
-            else
+            } else
                 tmpformat = informat;
 
-            pkey = load_pubkey(bio_err, infile, tmpformat, 1,
-                               passin, e, &quot;Public Key&quot;);
+            pkey = load_pubkey(infile, tmpformat, 1, passin, e, &quot;Public Key&quot;);
         } else
-            pkey = load_key(bio_err, infile,
-                            (informat == FORMAT_NETSCAPE &amp;&amp; sgckey ?
-                             FORMAT_IISSGC : informat), 1,
-                            passin, e, &quot;Private Key&quot;);
+            pkey = load_key(infile, informat, 1, passin, e, &quot;Private Key&quot;);
 
         if (pkey != NULL)
             rsa = EVP_PKEY_get1_RSA(pkey);
@@ -306,20 +290,9 @@ int MAIN(int argc, char **argv)
         goto end;
     }
 
-    if (outfile == NULL) {
-        BIO_set_fp(out, stdout, BIO_NOCLOSE);
-# ifdef OPENSSL_SYS_VMS
-        {
-            BIO *tmpbio = BIO_new(BIO_f_linebuffer());
-            out = BIO_push(tmpbio, out);
-        }
-# endif
-    } else {
-        if (BIO_write_filename(out, outfile) &lt;= 0) {
-            perror(outfile);
-            goto end;
-        }
-    }
+    out = bio_open_default(outfile, &quot;w&quot;);
+    if (out == NULL)
+        goto end;
 
     if (text)
         if (!RSA_print(out, rsa, 0)) {
@@ -379,13 +352,13 @@ int MAIN(int argc, char **argv)
         int size;
 
         i = 1;
-        size = i2d_RSA_NET(rsa, NULL, NULL, sgckey);
+        size = i2d_RSA_NET(rsa, NULL, NULL, 0);
         if ((p = (unsigned char *)OPENSSL_malloc(size)) == NULL) {
             BIO_printf(bio_err, &quot;Memory allocation failure\n&quot;);
             goto end;
         }
         pp = p;
-        i2d_RSA_NET(rsa, &amp;p, NULL, sgckey);
+        i2d_RSA_NET(rsa, &amp;p, NULL, 0);
         BIO_write(out, (char *)pp, size);
         OPENSSL_free(pp);
     }
@@ -428,8 +401,7 @@ int MAIN(int argc, char **argv)
         OPENSSL_free(passin);
     if (passout)
         OPENSSL_free(passout);
-    apps_shutdown();
-    OPENSSL_EXIT(ret);
+    return (ret);
 }
 #else                           /* !OPENSSL_NO_RSA */
 
diff --git a/apps/rsautl.c b/apps/rsautl.c
index d642f9a..0466746 100644
--- a/apps/rsautl.c
+++ b/apps/rsautl.c
@@ -1,4 +1,3 @@
-/* rsautl.c */
 /*
  * Written by Dr Stephen N Henson (<A HREF="../../../mailman/listinfo/openssl-commits.html">steve at openssl.org</A>) for the OpenSSL project
  * 2000.
@@ -75,150 +74,162 @@
 # define KEY_PUBKEY      2
 # define KEY_CERT        3
 
-static void usage(void);
-
-# undef PROG
-
-# define PROG rsautl_main
-
-int MAIN(int argc, char **);
+typedef enum OPTION_choice {
+    OPT_ERR = -1, OPT_EOF = 0, OPT_HELP,
+    OPT_ENGINE, OPT_IN, OPT_OUT, OPT_ASN1PARSE, OPT_HEXDUMP,
+    OPT_RAW, OPT_OAEP, OPT_SSL, OPT_PKCS, OPT_X931,
+    OPT_SIGN, OPT_VERIFY, OPT_REV, OPT_ENCRYPT, OPT_DECRYPT,
+    OPT_PUBIN, OPT_CERTIN, OPT_INKEY, OPT_PASSIN, OPT_KEYFORM
+} OPTION_CHOICE;
+
+OPTIONS rsautl_options[] = {
+    {&quot;help&quot;, OPT_HELP, '-', &quot;Display this summary&quot;},
+    {&quot;in&quot;, OPT_IN, '&lt;', &quot;Input file&quot;},
+    {&quot;out&quot;, OPT_OUT, '&gt;', &quot;Output file&quot;},
+    {&quot;inkey&quot;, OPT_INKEY, '&lt;', &quot;Input key&quot;},
+    {&quot;keyform&quot;, OPT_KEYFORM, 'F', &quot;Private key format - default PEM&quot;},
+    {&quot;pubin&quot;, OPT_PUBIN, '-', &quot;Input is an RSA public&quot;},
+    {&quot;certin&quot;, OPT_CERTIN, '-', &quot;Input is a cert carrying an RSA public key&quot;},
+    {&quot;ssl&quot;, OPT_SSL, '-', &quot;Use SSL v2 padding&quot;},
+    {&quot;raw&quot;, OPT_RAW, '-', &quot;Use no padding&quot;},
+    {&quot;pkcs&quot;, OPT_PKCS, '-', &quot;Use PKCS#1 v1.5 padding (default)&quot;},
+    {&quot;oaep&quot;, OPT_OAEP, '-', &quot;Use PKCS#1 OAEP&quot;},
+    {&quot;sign&quot;, OPT_SIGN, '-', &quot;Sign with private key&quot;},
+    {&quot;verify&quot;, OPT_VERIFY, '-', &quot;Verify with public key&quot;},
+    {&quot;asn1parse&quot;, OPT_ASN1PARSE, '-'},
+    {&quot;hexdump&quot;, OPT_HEXDUMP, '-', &quot;Hex dump output&quot;},
+    {&quot;x931&quot;, OPT_X931, '-', &quot;Use ANSI X9.31 padding&quot;},
+    {&quot;rev&quot;, OPT_REV, '-'},
+    {&quot;encrypt&quot;, OPT_ENCRYPT, '-', &quot;Encrypt with public key&quot;},
+    {&quot;decrypt&quot;, OPT_DECRYPT, '-', &quot;Decrypt with private key&quot;},
+    {&quot;passin&quot;, OPT_PASSIN, 's', &quot;Pass phrase source&quot;},
+# ifndef OPENSSL_NO_ENGINE
+    {&quot;engine&quot;, OPT_ENGINE, 's', &quot;Use engine, possibly a hardware device&quot;},
+# endif
+    {NULL}
+};
 
-int MAIN(int argc, char **argv)
+int rsautl_main(int argc, char **argv)
 {
-    ENGINE *e = NULL;
     BIO *in = NULL, *out = NULL;
-    char *infile = NULL, *outfile = NULL;
-# ifndef OPENSSL_NO_ENGINE
-    char *engine = NULL;
-# endif
-    char *keyfile = NULL;
-    char rsa_mode = RSA_VERIFY, key_type = KEY_PRIVKEY;
-    int keyform = FORMAT_PEM;
-    char need_priv = 0, badarg = 0, rev = 0;
-    char hexdump = 0, asn1parse = 0;
-    X509 *x;
+    ENGINE *e = NULL;
     EVP_PKEY *pkey = NULL;
     RSA *rsa = NULL;
-    unsigned char *rsa_in = NULL, *rsa_out = NULL, pad;
-    char *passargin = NULL, *passin = NULL;
-    int rsa_inlen, rsa_outlen = 0;
-    int keysize;
-
-    int ret = 1;
-
-    argc--;
-    argv++;
-
-    if (!bio_err)
-        bio_err = BIO_new_fp(stderr, BIO_NOCLOSE);
-
-    if (!load_config(bio_err, NULL))
-        goto end;
-    ERR_load_crypto_strings();
-    OpenSSL_add_all_algorithms();
-    pad = RSA_PKCS1_PADDING;
-
-    while (argc &gt;= 1) {
-        if (!strcmp(*argv, &quot;-in&quot;)) {
-            if (--argc &lt; 1)
-                badarg = 1;
-            else
-                infile = *(++argv);
-        } else if (!strcmp(*argv, &quot;-out&quot;)) {
-            if (--argc &lt; 1)
-                badarg = 1;
-            else
-                outfile = *(++argv);
-        } else if (!strcmp(*argv, &quot;-inkey&quot;)) {
-            if (--argc &lt; 1)
-                badarg = 1;
-            else
-                keyfile = *(++argv);
-        } else if (!strcmp(*argv, &quot;-passin&quot;)) {
-            if (--argc &lt; 1)
-                badarg = 1;
-            else
-                passargin = *(++argv);
-        } else if (strcmp(*argv, &quot;-keyform&quot;) == 0) {
-            if (--argc &lt; 1)
-                badarg = 1;
-            else
-                keyform = str2fmt(*(++argv));
-# ifndef OPENSSL_NO_ENGINE
-        } else if (!strcmp(*argv, &quot;-engine&quot;)) {
-            if (--argc &lt; 1)
-                badarg = 1;
-            else
-                engine = *(++argv);
-# endif
-        } else if (!strcmp(*argv, &quot;-pubin&quot;)) {
-            key_type = KEY_PUBKEY;
-        } else if (!strcmp(*argv, &quot;-certin&quot;)) {
-            key_type = KEY_CERT;
-        } else if (!strcmp(*argv, &quot;-asn1parse&quot;))
+    X509 *x;
+    char *engine = NULL, *infile = NULL, *outfile = NULL, *keyfile = NULL;
+    char *passinarg = NULL, *passin = NULL, *prog;
+    char rsa_mode = RSA_VERIFY, key_type = KEY_PRIVKEY;
+    unsigned char *rsa_in = NULL, *rsa_out = NULL, pad = RSA_PKCS1_PADDING;
+    int rsa_inlen, keyformat = FORMAT_PEM, keysize, ret = 1;
+    int rsa_outlen = 0, hexdump = 0, asn1parse = 0, need_priv = 0, rev = 0;
+    OPTION_CHOICE o;
+
+    prog = opt_init(argc, argv, rsautl_options);
+    while ((o = opt_next()) != OPT_EOF) {
+        switch (o) {
+        case OPT_EOF:
+        case OPT_ERR:
+ opthelp:
+            BIO_printf(bio_err, &quot;%s: Use -help for summary.\n&quot;, prog);
+            goto end;
+        case OPT_HELP:
+            opt_help(rsautl_options);
+            ret = 0;
+            goto end;
+        case OPT_KEYFORM:
+            if (!opt_format(opt_arg(), OPT_FMT_PEMDER, &amp;keyformat))
+                goto opthelp;
+            break;
+        case OPT_IN:
+            infile = opt_arg();
+            break;
+        case OPT_OUT:
+            outfile = opt_arg();
+            break;
+        case OPT_ENGINE:
+            engine = opt_arg();
+            break;
+        case OPT_ASN1PARSE:
             asn1parse = 1;
-        else if (!strcmp(*argv, &quot;-hexdump&quot;))
+            break;
+        case OPT_HEXDUMP:
             hexdump = 1;
-        else if (!strcmp(*argv, &quot;-raw&quot;))
+            break;
+        case OPT_RAW:
             pad = RSA_NO_PADDING;
-        else if (!strcmp(*argv, &quot;-oaep&quot;))
+            break;
+        case OPT_OAEP:
             pad = RSA_PKCS1_OAEP_PADDING;
-        else if (!strcmp(*argv, &quot;-ssl&quot;))
+            break;
+        case OPT_SSL:
             pad = RSA_SSLV23_PADDING;
-        else if (!strcmp(*argv, &quot;-pkcs&quot;))
+            break;
+        case OPT_PKCS:
             pad = RSA_PKCS1_PADDING;
-        else if (!strcmp(*argv, &quot;-x931&quot;))
+            break;
+        case OPT_X931:
             pad = RSA_X931_PADDING;
-        else if (!strcmp(*argv, &quot;-sign&quot;)) {
+            break;
+        case OPT_SIGN:
             rsa_mode = RSA_SIGN;
             need_priv = 1;
-        } else if (!strcmp(*argv, &quot;-verify&quot;))
+            break;
+        case OPT_VERIFY:
             rsa_mode = RSA_VERIFY;
-        else if (!strcmp(*argv, &quot;-rev&quot;))
+            break;
+        case OPT_REV:
             rev = 1;
-        else if (!strcmp(*argv, &quot;-encrypt&quot;))
+            break;
+        case OPT_ENCRYPT:
             rsa_mode = RSA_ENCRYPT;
-        else if (!strcmp(*argv, &quot;-decrypt&quot;)) {
+            break;
+        case OPT_DECRYPT:
             rsa_mode = RSA_DECRYPT;
             need_priv = 1;
-        } else
-            badarg = 1;
-        if (badarg) {
-            usage();
-            goto end;
+            break;
+        case OPT_PUBIN:
+            key_type = KEY_PUBKEY;
+            break;
+        case OPT_CERTIN:
+            key_type = KEY_CERT;
+            break;
+        case OPT_INKEY:
+            keyfile = opt_arg();
+            break;
+        case OPT_PASSIN:
+            passinarg = opt_arg();
+            break;
         }
-        argc--;
-        argv++;
     }
+    argc = opt_num_rest();
+    argv = opt_rest();
 
     if (need_priv &amp;&amp; (key_type != KEY_PRIVKEY)) {
         BIO_printf(bio_err, &quot;A private key is needed for this operation\n&quot;);
         goto end;
     }
 # ifndef OPENSSL_NO_ENGINE
-    e = setup_engine(bio_err, engine, 0);
+    e = setup_engine(engine, 0);
 # endif
-    if (!app_passwd(bio_err, passargin, NULL, &amp;passin, NULL)) {
+    if (!app_passwd(passinarg, NULL, &amp;passin, NULL)) {
         BIO_printf(bio_err, &quot;Error getting password\n&quot;);
         goto end;
     }
 
 /* FIXME: seed PRNG only if needed */
-    app_RAND_load_file(NULL, bio_err, 0);
+    app_RAND_load_file(NULL, 0);
 
     switch (key_type) {
     case KEY_PRIVKEY:
-        pkey = load_key(bio_err, keyfile, keyform, 0,
-                        passin, e, &quot;Private Key&quot;);
+        pkey = load_key(keyfile, keyformat, 0, passin, e, &quot;Private Key&quot;);
         break;
 
     case KEY_PUBKEY:
-        pkey = load_pubkey(bio_err, keyfile, keyform, 0,
-                           NULL, e, &quot;Public Key&quot;);
+        pkey = load_pubkey(keyfile, keyformat, 0, NULL, e, &quot;Public Key&quot;);
         break;
 
     case KEY_CERT:
-        x = load_cert(bio_err, keyfile, keyform, NULL, e, &quot;Certificate&quot;);
+        x = load_cert(keyfile, keyformat, NULL, e, &quot;Certificate&quot;);
         if (x) {
             pkey = X509_get_pubkey(x);
             X509_free(x);
@@ -239,30 +250,12 @@ int MAIN(int argc, char **argv)
         goto end;
     }
 
-    if (infile) {
-        if (!(in = BIO_new_file(infile, &quot;rb&quot;))) {
-            BIO_printf(bio_err, &quot;Error Reading Input File\n&quot;);
-            ERR_print_errors(bio_err);
-            goto end;
-        }
-    } else
-        in = BIO_new_fp(stdin, BIO_NOCLOSE);
-
-    if (outfile) {
-        if (!(out = BIO_new_file(outfile, &quot;wb&quot;))) {
-            BIO_printf(bio_err, &quot;Error Reading Output File\n&quot;);
-            ERR_print_errors(bio_err);
-            goto end;
-        }
-    } else {
-        out = BIO_new_fp(stdout, BIO_NOCLOSE);
-# ifdef OPENSSL_SYS_VMS
-        {
-            BIO *tmpbio = BIO_new(BIO_f_linebuffer());
-            out = BIO_push(tmpbio, out);
-        }
-# endif
-    }
+    in = bio_open_default(infile, &quot;rb&quot;);
+    if (in == NULL)
+        goto end;
+    out = bio_open_default(outfile, &quot;wb&quot;);
+    if (out == NULL)
+        goto end;
 
     keysize = RSA_size(rsa);
 
@@ -270,7 +263,6 @@ int MAIN(int argc, char **argv)
     rsa_out = OPENSSL_malloc(keysize);
     if (!rsa_in || !rsa_out) {
         BIO_printf(bio_err, &quot;Out of memory\n&quot;);
-        ERR_print_errors(bio_err);
         goto end;
     }
 
@@ -278,7 +270,7 @@ int MAIN(int argc, char **argv)
     rsa_inlen = BIO_read(in, rsa_in, keysize * 2);
     if (rsa_inlen &lt;= 0) {
         BIO_printf(bio_err, &quot;Error reading input Data\n&quot;);
-        exit(1);
+        goto end;
     }
     if (rev) {
         int i;
@@ -338,34 +330,6 @@ int MAIN(int argc, char **argv)
     return ret;
 }
 
-static void usage()
-{
-    BIO_printf(bio_err, &quot;Usage: rsautl [options]\n&quot;);
-    BIO_printf(bio_err, &quot;-in file        input file\n&quot;);
-    BIO_printf(bio_err, &quot;-out file       output file\n&quot;);
-    BIO_printf(bio_err, &quot;-inkey file     input key\n&quot;);
-    BIO_printf(bio_err, &quot;-keyform arg    private key format - default PEM\n&quot;);
-    BIO_printf(bio_err, &quot;-pubin          input is an RSA public\n&quot;);
-    BIO_printf(bio_err,
-               &quot;-certin         input is a certificate carrying an RSA public key\n&quot;);
-    BIO_printf(bio_err, &quot;-ssl            use SSL v2 padding\n&quot;);
-    BIO_printf(bio_err, &quot;-raw            use no padding\n&quot;);
-    BIO_printf(bio_err,
-               &quot;-pkcs           use PKCS#1 v1.5 padding (default)\n&quot;);
-    BIO_printf(bio_err, &quot;-oaep           use PKCS#1 OAEP\n&quot;);
-    BIO_printf(bio_err, &quot;-sign           sign with private key\n&quot;);
-    BIO_printf(bio_err, &quot;-verify         verify with public key\n&quot;);
-    BIO_printf(bio_err, &quot;-encrypt        encrypt with public key\n&quot;);
-    BIO_printf(bio_err, &quot;-decrypt        decrypt with private key\n&quot;);
-    BIO_printf(bio_err, &quot;-hexdump        hex dump output\n&quot;);
-# ifndef OPENSSL_NO_ENGINE
-    BIO_printf(bio_err,
-               &quot;-engine e       use engine e, possibly a hardware device.\n&quot;);
-    BIO_printf(bio_err, &quot;-passin arg    pass phrase source\n&quot;);
-# endif
-
-}
-
 #else                           /* !OPENSSL_NO_RSA */
 
 # if PEDANTIC
diff --git a/apps/s_apps.h b/apps/s_apps.h
index b0aeeff..db8d039 100644
--- a/apps/s_apps.h
+++ b/apps/s_apps.h
@@ -178,9 +178,9 @@ int init_client(int *sock, const char *server, int port, int type);
 int init_client_unix(int *sock, const char *server);
 #endif
 int should_retry(int i);
-int extract_port(const char *str, short *port_ptr);
+int extract_port(const char *str, unsigned short *port_ptr);
 int extract_host_port(char *str, char **host_ptr, unsigned char *ip,
-                      short *p);
+                      unsigned short *p);
 
 long bio_dump_callback(BIO *bio, int cmd, const char *argp,
                        int argi, long argl, long ret);
@@ -202,15 +202,12 @@ typedef struct ssl_excert_st SSL_EXCERT;
 
 void ssl_ctx_set_excert(SSL_CTX *ctx, SSL_EXCERT *exc);
 void ssl_excert_free(SSL_EXCERT *exc);
-int args_excert(char ***pargs, int *pargc,
-                int *badarg, BIO *err, SSL_EXCERT **pexc);
-int load_excert(SSL_EXCERT **pexc, BIO *err);
+int args_excert(int option, SSL_EXCERT **pexc);
+int load_excert(SSL_EXCERT **pexc);
 void print_ssl_summary(BIO *bio, SSL *s);
 #ifdef HEADER_SSL_H
-int args_ssl(char ***pargs, int *pargc, SSL_CONF_CTX *cctx,
-             int *badarg, BIO *err, STACK_OF(OPENSSL_STRING) **pstr);
-int args_ssl_call(SSL_CTX *ctx, BIO *err, SSL_CONF_CTX *cctx,
-                  STACK_OF(OPENSSL_STRING) *str, int no_ecdhe, int no_jpake);
+int config_ctx(SSL_CONF_CTX *cctx, STACK_OF(OPENSSL_STRING) *str,
+               SSL_CTX *ctx, int no_ecdhe, int no_jpake);
 int ssl_ctx_add_crls(SSL_CTX *ctx, STACK_OF(X509_CRL) *crls,
                      int crl_download);
 int ssl_load_stores(SSL_CTX *ctx, const char *vfyCApath,
diff --git a/apps/s_cb.c b/apps/s_cb.c
index 06050db..ddd65a9 100644
--- a/apps/s_cb.c
+++ b/apps/s_cb.c
@@ -1,4 +1,3 @@
-/* apps/s_cb.c - callback functions used by s_client, s_server, and s_time */
 /* Copyright (C) 1995-1998 Eric Young (<A HREF="../../../mailman/listinfo/openssl-commits.html">eay at cryptsoft.com</A>)
  * All rights reserved.
  *
@@ -109,12 +108,12 @@
  *
  */
 
+/* callback functions used by s_client, s_server, and s_time */
 #include &lt;stdio.h&gt;
 #include &lt;stdlib.h&gt;
+#include &lt;assert.h&gt;
 #define USE_SOCKETS
-#define NON_MAIN
 #include &quot;apps.h&quot;
-#undef NON_MAIN
 #undef USE_SOCKETS
 #include &lt;openssl/err.h&gt;
 #include &lt;openssl/rand.h&gt;
@@ -200,11 +199,6 @@ int verify_callback(int ok, X509_STORE_CTX *ctx)
 int set_cert_stuff(SSL_CTX *ctx, char *cert_file, char *key_file)
 {
     if (cert_file != NULL) {
-        /*-
-        SSL *ssl;
-        X509 *x509;
-        */
-
         if (SSL_CTX_use_certificate_file(ctx, cert_file,
                                          SSL_FILETYPE_PEM) &lt;= 0) {
             BIO_printf(bio_err, &quot;unable to get certificate from '%s'\n&quot;,
@@ -221,21 +215,6 @@ int set_cert_stuff(SSL_CTX *ctx, char *cert_file, char *key_file)
             return (0);
         }
 
-        /*-
-        In theory this is no longer needed
-        ssl=SSL_new(ctx);
-        x509=SSL_get_certificate(ssl);
-
-        if (x509 != NULL) {
-                EVP_PKEY *pktmp;
-                pktmp = X509_get_pubkey(x509);
-                EVP_PKEY_copy_parameters(pktmp,
-                                        SSL_get_privatekey(ssl));
-                EVP_PKEY_free(pktmp);
-        }
-        SSL_free(ssl);
-        */
-
         /*
          * If we are using DSA, we can copy the parameters from the private
          * key
@@ -456,17 +435,17 @@ int ssl_print_curves(BIO *out, SSL *s, int noshared)
 {
     int i, ncurves, *curves, nid;
     const char *cname;
+
     ncurves = SSL_get1_curves(s, NULL);
     if (ncurves &lt;= 0)
         return 1;
     curves = OPENSSL_malloc(ncurves * sizeof(int));
     if (!curves) {
-        BIO_puts(out, &quot;Malloc error getting supported curves\n&quot;);
+        BIO_printf(out, &quot;Out of memory\n&quot;);
         return 0;
     }
     SSL_get1_curves(s, curves);
 
-
     BIO_puts(out, &quot;Supported Elliptic Curves: &quot;);
     for (i = 0; i &lt; ncurves; i++) {
         if (i)
@@ -1178,11 +1157,10 @@ static int set_cert_cb(SSL *ssl, void *arg)
         X509_NAME_print_ex(bio_err, X509_get_subject_name(exc-&gt;cert), 0,
                            XN_FLAG_ONELINE);
         BIO_puts(bio_err, &quot;\n&quot;);
-
         print_chain_flags(bio_err, ssl, rv);
         if (rv &amp; CERT_PKEY_VALID) {
             if (!SSL_use_certificate(ssl, exc-&gt;cert)
-               || !SSL_use_PrivateKey(ssl, exc-&gt;key)) {
+                    || !SSL_use_PrivateKey(ssl, exc-&gt;key)) {
                 return 0;
             }
             /*
@@ -1251,7 +1229,7 @@ void ssl_excert_free(SSL_EXCERT *exc)
     }
 }
 
-int load_excert(SSL_EXCERT **pexc, BIO *err)
+int load_excert(SSL_EXCERT **pexc)
 {
     SSL_EXCERT *exc = *pexc;
     if (!exc)
@@ -1264,25 +1242,24 @@ int load_excert(SSL_EXCERT **pexc, BIO *err)
     }
     for (; exc; exc = exc-&gt;next) {
         if (!exc-&gt;certfile) {
-            BIO_printf(err, &quot;Missing filename\n&quot;);
+            BIO_printf(bio_err, &quot;Missing filename\n&quot;);
             return 0;
         }
-        exc-&gt;cert = load_cert(err, exc-&gt;certfile, exc-&gt;certform,
+        exc-&gt;cert = load_cert(exc-&gt;certfile, exc-&gt;certform,
                               NULL, NULL, &quot;Server Certificate&quot;);
         if (!exc-&gt;cert)
             return 0;
         if (exc-&gt;keyfile) {
-            exc-&gt;key = load_key(err, exc-&gt;keyfile, exc-&gt;keyform,
+            exc-&gt;key = load_key(exc-&gt;keyfile, exc-&gt;keyform,
                                 0, NULL, NULL, &quot;Server Key&quot;);
         } else {
-            exc-&gt;key = load_key(err, exc-&gt;certfile, exc-&gt;certform,
+            exc-&gt;key = load_key(exc-&gt;certfile, exc-&gt;certform,
                                 0, NULL, NULL, &quot;Server Key&quot;);
         }
         if (!exc-&gt;key)
             return 0;
         if (exc-&gt;chainfile) {
-            exc-&gt;chain = load_certs(err,
-                                    exc-&gt;chainfile, FORMAT_PEM,
+            exc-&gt;chain = load_certs(exc-&gt;chainfile, FORMAT_PEM,
                                     NULL, NULL, &quot;Server Chain&quot;);
             if (!exc-&gt;chain)
                 return 0;
@@ -1291,86 +1268,70 @@ int load_excert(SSL_EXCERT **pexc, BIO *err)
     return 1;
 }
 
-int args_excert(char ***pargs, int *pargc,
-                int *badarg, BIO *err, SSL_EXCERT **pexc)
+enum range { OPT_X_ENUM };
+
+int args_excert(int opt, SSL_EXCERT **pexc)
 {
-    char *arg = **pargs, *argn = (*pargs)[1];
     SSL_EXCERT *exc = *pexc;
-    int narg = 2;
-    if (!exc) {
-        if (ssl_excert_prepend(&amp;exc))
-            *pexc = exc;
-        else {
-            BIO_printf(err, &quot;Error initialising xcert\n&quot;);
-            *badarg = 1;
+
+    assert(opt &gt; OPT_X__FIRST);
+    assert(opt &lt; OPT_X__LAST);
+
+    if (exc == NULL) {
+        if (!ssl_excert_prepend(&amp;exc)) {
+            BIO_printf(bio_err, &quot; %s: Error initialising xcert\n&quot;,
+                       opt_getprog());
             goto err;
         }
+        *pexc = exc;
     }
-    if (strcmp(arg, &quot;-xcert&quot;) == 0) {
-        if (!argn) {
-            *badarg = 1;
-            return 1;
-        }
+
+    switch ((enum range)opt) {
+    case OPT_X__FIRST:
+    case OPT_X__LAST:
+        return 0;
+    case OPT_X_CERT:
         if (exc-&gt;certfile &amp;&amp; !ssl_excert_prepend(&amp;exc)) {
-            BIO_printf(err, &quot;Error adding xcert\n&quot;);
-            *badarg = 1;
+            BIO_printf(bio_err, &quot;%s: Error adding xcert\n&quot;, opt_getprog());
             goto err;
         }
-        exc-&gt;certfile = argn;
-    } else if (strcmp(arg, &quot;-xkey&quot;) == 0) {
-        if (!argn) {
-            *badarg = 1;
-            return 1;
-        }
+        exc-&gt;certfile = opt_arg();
+        break;
+    case OPT_X_KEY:
         if (exc-&gt;keyfile) {
-            BIO_printf(err, &quot;Key already specified\n&quot;);
-            *badarg = 1;
-            return 1;
-        }
-        exc-&gt;keyfile = argn;
-    } else if (strcmp(arg, &quot;-xchain&quot;) == 0) {
-        if (!argn) {
-            *badarg = 1;
-            return 1;
-        }
-        if (exc-&gt;chainfile) {
-            BIO_printf(err, &quot;Chain already specified\n&quot;);
-            *badarg = 1;
-            return 1;
-        }
-        exc-&gt;chainfile = argn;
-    } else if (strcmp(arg, &quot;-xchain_build&quot;) == 0) {
-        narg = 1;
-        exc-&gt;build_chain = 1;
-    } else if (strcmp(arg, &quot;-xcertform&quot;) == 0) {
-        if (!argn) {
-            *badarg = 1;
+            BIO_printf(bio_err, &quot;%s: Key already specified\n&quot;, opt_getprog());
             goto err;
         }
-        exc-&gt;certform = str2fmt(argn);
-    } else if (strcmp(arg, &quot;-xkeyform&quot;) == 0) {
-        if (!argn) {
-            *badarg = 1;
+        exc-&gt;keyfile = opt_arg();
+        break;
+    case OPT_X_CHAIN:
+        if (exc-&gt;chainfile) {
+            BIO_printf(bio_err, &quot;%s: Chain already specified\n&quot;,
+                       opt_getprog());
             goto err;
         }
-        exc-&gt;keyform = str2fmt(argn);
-    } else
-        return 0;
-
-    (*pargs) += narg;
-
-    if (pargc)
-        *pargc -= narg;
-
-    *pexc = exc;
-
+        exc-&gt;chainfile = opt_arg();
+        break;
+    case OPT_X_CHAIN_BUILD:
+        exc-&gt;build_chain = 1;
+        break;
+    case OPT_X_CERTFORM:
+        if (!opt_format(opt_arg(), OPT_FMT_PEMDER, &amp;exc-&gt;certform))
+            return 0;
+        break;
+    case OPT_X_KEYFORM:
+        if (!opt_format(opt_arg(), OPT_FMT_PEMDER, &amp;exc-&gt;keyform))
+            return 0;
+        break;
+    }
     return 1;
 
  err:
-    ERR_print_errors(err);
-    ssl_excert_free(exc);
+    ERR_print_errors(bio_err);
+    if (exc)
+        ssl_excert_free(exc);
     *pexc = NULL;
-    return 1;
+    return 0;
 }
 
 static void print_raw_cipherlist(BIO *bio, SSL *s)
@@ -1438,72 +1399,31 @@ void print_ssl_summary(BIO *bio, SSL *s)
 #endif
 }
 
-int args_ssl(char ***pargs, int *pargc, SSL_CONF_CTX *cctx,
-             int *badarg, BIO *err, STACK_OF(OPENSSL_STRING) **pstr)
-{
-    char *arg = **pargs, *argn = (*pargs)[1];
-    int rv;
-
-    /* Attempt to run SSL configuration command */
-    rv = SSL_CONF_cmd_argv(cctx, pargc, pargs);
-    /* If parameter not recognised just return */
-    if (rv == 0)
-        return 0;
-    /* see if missing argument error */
-    if (rv == -3) {
-        BIO_printf(err, &quot;%s needs an argument\n&quot;, arg);
-        *badarg = 1;
-        goto end;
-    }
-    /* Check for some other error */
-    if (rv &lt; 0) {
-        BIO_printf(err, &quot;Error with command: \&quot;%s %s\&quot;\n&quot;,
-                   arg, argn ? argn : &quot;&quot;);
-        *badarg = 1;
-        goto end;
-    }
-    /* Store command and argument */
-    /* If only one argument processed store value as NULL */
-    if (rv == 1)
-        argn = NULL;
-    if (!*pstr)
-        *pstr = sk_OPENSSL_STRING_new_null();
-    if (!*pstr || !sk_OPENSSL_STRING_push(*pstr, arg) ||
-        !sk_OPENSSL_STRING_push(*pstr, argn)) {
-        BIO_puts(err, &quot;Memory allocation failure\n&quot;);
-        goto end;
-    }
-
- end:
-    if (*badarg)
-        ERR_print_errors(err);
-
-    return 1;
-}
-
-int args_ssl_call(SSL_CTX *ctx, BIO *err, SSL_CONF_CTX *cctx,
-                  STACK_OF(OPENSSL_STRING) *str, int no_ecdhe, int no_jpake)
+int config_ctx(SSL_CONF_CTX *cctx, STACK_OF(OPENSSL_STRING) *str,
+               SSL_CTX *ctx, int no_ecdhe, int no_jpake)
 {
     int i;
+
     SSL_CONF_CTX_set_ssl_ctx(cctx, ctx);
     for (i = 0; i &lt; sk_OPENSSL_STRING_num(str); i += 2) {
-        const char *param = sk_OPENSSL_STRING_value(str, i);
-        const char *value = sk_OPENSSL_STRING_value(str, i + 1);
-        /*
-         * If no_ecdhe or named curve already specified don't need a default.
-         */
-        if (!no_ecdhe &amp;&amp; !strcmp(param, &quot;-named_curve&quot;))
+        const char *flag = sk_OPENSSL_STRING_value(str, i);
+        const char *arg = sk_OPENSSL_STRING_value(str, i + 1);
+        /* If no_ecdhe or named curve already specified don't need a default. */
+        if (!no_ecdhe &amp;&amp; !strcmp(flag, &quot;-named_curve&quot;))
             no_ecdhe = 1;
 #ifndef OPENSSL_NO_JPAKE
-        if (!no_jpake &amp;&amp; !strcmp(param, &quot;-cipher&quot;)) {
-            BIO_puts(err, &quot;JPAKE sets cipher to PSK\n&quot;);
+        if (!no_jpake &amp;&amp; !strcmp(flag, &quot;-cipher&quot;)) {
+            BIO_puts(bio_err, &quot;JPAKE sets cipher to PSK\n&quot;);
             return 0;
         }
 #endif
-        if (SSL_CONF_cmd(cctx, param, value) &lt;= 0) {
-            BIO_printf(err, &quot;Error with command: \&quot;%s %s\&quot;\n&quot;,
-                       param, value ? value : &quot;&quot;);
-            ERR_print_errors(err);
+        if (SSL_CONF_cmd(cctx, flag, arg) &lt;= 0) {
+            if (arg)
+                BIO_printf(bio_err, &quot;Error with command: \&quot;%s %s\&quot;\n&quot;,
+                           flag, arg);
+            else
+                BIO_printf(bio_err, &quot;Error with command: \&quot;%s\&quot;\n&quot;, flag);
+            ERR_print_errors(bio_err);
             return 0;
         }
     }
@@ -1514,23 +1434,23 @@ int args_ssl_call(SSL_CTX *ctx, BIO *err, SSL_CONF_CTX *cctx,
      */
     if (!no_ecdhe) {
         if (SSL_CONF_cmd(cctx, &quot;-named_curve&quot;, &quot;P-256&quot;) &lt;= 0) {
-            BIO_puts(err, &quot;Error setting EC curve\n&quot;);
-            ERR_print_errors(err);
+            BIO_puts(bio_err, &quot;Error setting EC curve\n&quot;);
+            ERR_print_errors(bio_err);
             return 0;
         }
     }
 #ifndef OPENSSL_NO_JPAKE
     if (!no_jpake) {
         if (SSL_CONF_cmd(cctx, &quot;-cipher&quot;, &quot;PSK&quot;) &lt;= 0) {
-            BIO_puts(err, &quot;Error setting cipher to PSK\n&quot;);
-            ERR_print_errors(err);
+            BIO_puts(bio_err, &quot;Error setting cipher to PSK\n&quot;);
+            ERR_print_errors(bio_err);
             return 0;
         }
     }
 #endif
     if (!SSL_CONF_CTX_finish(cctx)) {
-        BIO_puts(err, &quot;Error finishing context\n&quot;);
-        ERR_print_errors(err);
+        BIO_puts(bio_err, &quot;Error finishing context\n&quot;);
+        ERR_print_errors(bio_err);
         return 0;
     }
     return 1;
diff --git a/apps/s_client.c b/apps/s_client.c
index 761f352..900efe7 100644
--- a/apps/s_client.c
+++ b/apps/s_client.c
@@ -1,4 +1,3 @@
-/* apps/s_client.c */
 /* Copyright (C) 1995-1998 Eric Young (<A HREF="../../../mailman/listinfo/openssl-commits.html">eay at cryptsoft.com</A>)
  * All rights reserved.
  *
@@ -141,6 +140,7 @@
 #include &lt;stdlib.h&gt;
 #include &lt;string.h&gt;
 #include &lt;openssl/e_os2.h&gt;
+
 /*
  * With IPv6, it looks like Digital has mixed up the proper order of
  * recursive header file inclusion, resulting in the compiler complaining
@@ -172,22 +172,8 @@ typedef unsigned int u_int;
 # undef FIONBIO
 #endif
 
-#undef PROG
-#define PROG    s_client_main
-
-/*
- * #define SSL_HOST_NAME &quot;www.netscape.com&quot;
- */
-/*
- * #define SSL_HOST_NAME &quot;193.118.187.102&quot;
- */
 #define SSL_HOST_NAME   &quot;localhost&quot;
 
-/* no default cert. */
-/*
- * #define TEST_CERT &quot;client.pem&quot;
- */
-
 #undef BUFSIZZ
 #define BUFSIZZ 1024*8
 
@@ -196,32 +182,26 @@ extern int verify_error;
 extern int verify_return_error;
 extern int verify_quiet;
 
-#ifdef FIONBIO
 static int c_nbio = 0;
-#endif
-static int c_Pause = 0;
-static int c_debug = 0;
-#ifndef OPENSSL_NO_TLSEXT
 static int c_tlsextdebug = 0;
 static int c_status_req = 0;
-#endif
+static int c_Pause = 0;
+static int c_debug = 0;
 static int c_msg = 0;
 static int c_showcerts = 0;
-
 static char *keymatexportlabel = NULL;
 static int keymatexportlen = 20;
-
-static void sc_usage(void);
-static void print_stuff(BIO *berr, SSL *con, int full);
-#ifndef OPENSSL_NO_TLSEXT
-static int ocsp_resp_cb(SSL *s, void *arg);
-#endif
 static BIO *bio_c_out = NULL;
 static BIO *bio_c_msg = NULL;
 static int c_quiet = 0;
 static int c_ign_eof = 0;
 static int c_brief = 0;
 
+static void print_stuff(BIO *berr, SSL *con, int full);
+#ifndef OPENSSL_NO_TLSEXT
+static int ocsp_resp_cb(SSL *s, void *arg);
+#endif
+
 #ifndef OPENSSL_NO_PSK
 /* Default PSK identity and key */
 static char *psk_identity = &quot;Client_identity&quot;;
@@ -290,147 +270,6 @@ static unsigned int psk_client_cb(SSL *ssl, const char *hint, char *identity,
 }
 #endif
 
-static void sc_usage(void)
-{
-    BIO_printf(bio_err, &quot;usage: s_client args\n&quot;);
-    BIO_printf(bio_err, &quot;\n&quot;);
-    BIO_printf(bio_err, &quot; -host host     - use -connect instead\n&quot;);
-    BIO_printf(bio_err, &quot; -port port     - use -connect instead\n&quot;);
-    BIO_printf(bio_err,
-               &quot; -connect host:port - connect over TCP/IP (default is %s:%s)\n&quot;,
-               SSL_HOST_NAME, PORT_STR);
-    BIO_printf(bio_err,
-               &quot; -unix path    - connect over unix domain sockets\n&quot;);
-    BIO_printf(bio_err,
-               &quot; -verify arg   - turn on peer certificate verification\n&quot;);
-    BIO_printf(bio_err,
-               &quot; -verify_return_error - return verification errors\n&quot;);
-    BIO_printf(bio_err,
-               &quot; -cert arg     - certificate file to use, PEM format assumed\n&quot;);
-    BIO_printf(bio_err,
-               &quot; -certform arg - certificate format (PEM or DER) PEM default\n&quot;);
-    BIO_printf(bio_err,
-               &quot; -key arg      - Private key file to use, in cert file if\n&quot;);
-    BIO_printf(bio_err, &quot;                 not specified but cert file is.\n&quot;);
-    BIO_printf(bio_err,
-               &quot; -keyform arg  - key format (PEM or DER) PEM default\n&quot;);
-    BIO_printf(bio_err,
-               &quot; -pass arg     - private key file pass phrase source\n&quot;);
-    BIO_printf(bio_err, &quot; -CApath arg   - PEM format directory of CA's\n&quot;);
-    BIO_printf(bio_err, &quot; -CAfile arg   - PEM format file of CA's\n&quot;);
-    BIO_printf(bio_err,
-               &quot; -trusted_first - Use local CA's first when building trust chain\n&quot;);
-    BIO_printf(bio_err,
-               &quot; -no_alt_chains - only ever use the first certificate chain found\n&quot;);
-    BIO_printf(bio_err,
-               &quot; -reconnect    - Drop and re-make the connection with the same Session-ID\n&quot;);
-    BIO_printf(bio_err,
-               &quot; -pause        - sleep(1) after each read(2) and write(2) system call\n&quot;);
-    BIO_printf(bio_err,
-               &quot; -prexit       - print session information even on connection failure\n&quot;);
-    BIO_printf(bio_err,
-               &quot; -showcerts    - show all certificates in the chain\n&quot;);
-    BIO_printf(bio_err, &quot; -debug        - extra output\n&quot;);
-#ifdef WATT32
-    BIO_printf(bio_err, &quot; -wdebug       - WATT-32 tcp debugging\n&quot;);
-#endif
-    BIO_printf(bio_err, &quot; -msg          - Show protocol messages\n&quot;);
-    BIO_printf(bio_err, &quot; -nbio_test    - more ssl protocol testing\n&quot;);
-    BIO_printf(bio_err, &quot; -state        - print the 'ssl' states\n&quot;);
-#ifdef FIONBIO
-    BIO_printf(bio_err, &quot; -nbio         - Run with non-blocking IO\n&quot;);
-#endif
-    BIO_printf(bio_err,
-               &quot; -crlf         - convert LF from terminal into CRLF\n&quot;);
-    BIO_printf(bio_err, &quot; -quiet        - no s_client output\n&quot;);
-    BIO_printf(bio_err,
-               &quot; -ign_eof      - ignore input eof (default when -quiet)\n&quot;);
-    BIO_printf(bio_err, &quot; -no_ign_eof   - don't ignore input eof\n&quot;);
-#ifndef OPENSSL_NO_PSK
-    BIO_printf(bio_err, &quot; -psk_identity arg - PSK identity\n&quot;);
-    BIO_printf(bio_err, &quot; -psk arg      - PSK in hex (without 0x)\n&quot;);
-# ifndef OPENSSL_NO_JPAKE
-    BIO_printf(bio_err, &quot; -jpake arg    - JPAKE secret to use\n&quot;);
-# endif
-#endif
-#ifndef OPENSSL_NO_SRP
-    BIO_printf(bio_err,
-               &quot; -srpuser user     - SRP authentification for 'user'\n&quot;);
-    BIO_printf(bio_err, &quot; -srppass arg      - password for 'user'\n&quot;);
-    BIO_printf(bio_err,
-               &quot; -srp_lateuser     - SRP username into second ClientHello message\n&quot;);
-    BIO_printf(bio_err,
-               &quot; -srp_moregroups   - Tolerate other than the known g N values.\n&quot;);
-    BIO_printf(bio_err,
-               &quot; -srp_strength int - minimal length in bits for N (default %d).\n&quot;,
-               SRP_MINIMAL_N);
-#endif
-#ifndef OPENSSL_NO_SSL3_METHOD
-    BIO_printf(bio_err, &quot; -ssl3         - just use SSLv3\n&quot;);
-#endif
-    BIO_printf(bio_err, &quot; -tls1_2       - just use TLSv1.2\n&quot;);
-    BIO_printf(bio_err, &quot; -tls1_1       - just use TLSv1.1\n&quot;);
-    BIO_printf(bio_err, &quot; -tls1         - just use TLSv1\n&quot;);
-    BIO_printf(bio_err, &quot; -dtls1        - just use DTLSv1\n&quot;);
-    BIO_printf(bio_err, &quot; -fallback_scsv - send TLS_FALLBACK_SCSV\n&quot;);
-    BIO_printf(bio_err, &quot; -mtu          - set the link layer MTU\n&quot;);
-    BIO_printf(bio_err,
-               &quot; -no_tls1_2/-no_tls1_1/-no_tls1/-no_ssl3 - turn off that protocol\n&quot;);
-    BIO_printf(bio_err,
-               &quot; -bugs         - Switch on all SSL implementation bug workarounds\n&quot;);
-    BIO_printf(bio_err,
-               &quot; -cipher       - preferred cipher to use, use the 'openssl ciphers'\n&quot;);
-    BIO_printf(bio_err,
-               &quot;                 command to see what is available\n&quot;);
-    BIO_printf(bio_err,
-               &quot; -starttls prot - use the STARTTLS command before starting TLS\n&quot;);
-    BIO_printf(bio_err,
-               &quot;                 for those protocols that support it, where\n&quot;);
-    BIO_printf(bio_err,
-               &quot;                 'prot' defines which one to assume.  Currently,\n&quot;);
-    BIO_printf(bio_err,
-               &quot;                 only \&quot;smtp\&quot;, \&quot;pop3\&quot;, \&quot;imap\&quot;, \&quot;ftp\&quot; and \&quot;xmpp\&quot;\n&quot;);
-    BIO_printf(bio_err, &quot;                 are supported.\n&quot;);
-    BIO_printf(bio_err,
-               &quot; -xmpphost host - When used with \&quot;-starttls xmpp\&quot; specifies the virtual host.\n&quot;);
-#ifndef OPENSSL_NO_ENGINE
-    BIO_printf(bio_err,
-               &quot; -engine id    - Initialise and use the specified engine\n&quot;);
-#endif
-    BIO_printf(bio_err, &quot; -rand file%cfile%c...\n&quot;, LIST_SEPARATOR_CHAR,
-               LIST_SEPARATOR_CHAR);
-    BIO_printf(bio_err, &quot; -sess_out arg - file to write SSL session to\n&quot;);
-    BIO_printf(bio_err, &quot; -sess_in arg  - file to read SSL session from\n&quot;);
-#ifndef OPENSSL_NO_TLSEXT
-    BIO_printf(bio_err,
-               &quot; -servername host  - Set TLS extension servername in ClientHello\n&quot;);
-    BIO_printf(bio_err,
-               &quot; -tlsextdebug      - hex dump of all TLS extensions received\n&quot;);
-    BIO_printf(bio_err,
-               &quot; -status           - request certificate status from server\n&quot;);
-    BIO_printf(bio_err,
-               &quot; -no_ticket        - disable use of RFC4507bis session tickets\n&quot;);
-    BIO_printf(bio_err,
-               &quot; -serverinfo types - send empty ClientHello extensions (comma-separated numbers)\n&quot;);
-# ifndef OPENSSL_NO_NEXTPROTONEG
-    BIO_printf(bio_err,
-               &quot; -nextprotoneg arg - enable NPN extension, considering named protocols supported (comma-separated list)\n&quot;);
-# endif
-    BIO_printf(bio_err,
-               &quot; -alpn arg         - enable ALPN extension, considering named protocols supported (comma-separated list)\n&quot;);
-#endif
-    BIO_printf(bio_err,
-               &quot; -legacy_renegotiation - enable use of legacy renegotiation (dangerous)\n&quot;);
-#ifndef OPENSSL_NO_SRTP
-    BIO_printf(bio_err,
-               &quot; -use_srtp profiles - Offer SRTP key management with a colon-separated profile list\n&quot;);
-#endif
-    BIO_printf(bio_err,
-               &quot; -keymatexport label   - Export keying material using label\n&quot;);
-    BIO_printf(bio_err,
-               &quot; -keymatexportlen len  - Export len bytes of keying material (default 20)\n&quot;);
-}
-
 #ifndef OPENSSL_NO_TLSEXT
 
 /* This is a context that we pass to callbacks */
@@ -551,10 +390,9 @@ static char *ssl_give_srp_client_pwd_cb(SSL *s, void *arg)
     int l;
 
     if (!pass) {
-        BIO_printf(bio_err, &quot;Malloc failure\n&quot;);
+        BIO_printf(bio_err, &quot;Out of memory\n&quot;);
         return NULL;
     }
-
     cb_tmp.password = (char *)srp_arg-&gt;srppassin;
     cb_tmp.prompt_info = &quot;SRP user&quot;;
     if ((l = password_callback(pass, PWD_STRLEN, 0, &amp;cb_tmp)) &lt; 0) {
@@ -568,9 +406,8 @@ static char *ssl_give_srp_client_pwd_cb(SSL *s, void *arg)
 }
 
 # endif
-# ifndef OPENSSL_NO_SRTP
+
 char *srtp_profiles = NULL;
-# endif
 
 # ifndef OPENSSL_NO_NEXTPROTONEG
 /* This the context that we pass to next_proto_cb */
@@ -629,503 +466,586 @@ static int serverinfo_cli_parse_cb(SSL *s, unsigned int ext_type,
 
 #endif
 
-enum {
-    PROTO_OFF = 0,
+typedef enum OPTION_choice {
+    OPT_ERR = -1, OPT_EOF = 0, OPT_HELP,
+    OPT_HOST, OPT_PORT, OPT_CONNECT, OPT_UNIX, OPT_VERIFY,
+    OPT_CERT, OPT_CRL, OPT_CRL_DOWNLOAD, OPT_SESS_OUT, OPT_SESS_IN,
+    OPT_CERTFORM, OPT_CRLFORM, OPT_VERIFY_RET_ERROR, OPT_VERIFY_QUIET,
+    OPT_BRIEF, OPT_PREXIT, OPT_CRLF, OPT_QUIET, OPT_NBIO,
+    OPT_SSL_CLIENT_ENGINE, OPT_RAND, OPT_IGN_EOF, OPT_NO_IGN_EOF,
+    OPT_PAUSE, OPT_DEBUG, OPT_TLSEXTDEBUG, OPT_STATUS, OPT_WDEBUG,
+    OPT_MSG, OPT_MSGFILE, OPT_ENGINE, OPT_TRACE, OPT_SECURITY_DEBUG,
+    OPT_SECURITY_DEBUG_VERBOSE, OPT_SHOWCERTS, OPT_NBIO_TEST, OPT_STATE,
+    OPT_PSK_IDENTITY, OPT_PSK, OPT_SRPUSER, OPT_SRPPASS, OPT_SRP_STRENGTH,
+    OPT_SRP_LATEUSER, OPT_SRP_MOREGROUPS, OPT_SSL3,
+    OPT_TLS1_2, OPT_TLS1_1, OPT_TLS1, OPT_DTLS, OPT_DTLS1,
+    OPT_DTLS1_2, OPT_TIMEOUT, OPT_MTU, OPT_KEYFORM, OPT_PASS,
+    OPT_CERT_CHAIN, OPT_CAPATH, OPT_CHAINCAPATH, OPT_VERIFYCAPATH,
+    OPT_KEY, OPT_RECONNECT, OPT_BUILD_CHAIN, OPT_CAFILE, OPT_KRB5SVC,
+    OPT_CHAINCAFILE, OPT_VERIFYCAFILE, OPT_NEXTPROTONEG, OPT_ALPN,
+    OPT_SERVERINFO, OPT_STARTTLS, OPT_SERVERNAME, OPT_JPAKE,
+    OPT_USE_SRTP, OPT_KEYMATEXPORT, OPT_KEYMATEXPORTLEN,
+    OPT_V_ENUM,
+    OPT_X_ENUM,
+    OPT_S_ENUM,
+    OPT_FALLBACKSCSV
+} OPTION_CHOICE;
+
+OPTIONS s_client_options[] = {
+    {&quot;help&quot;, OPT_HELP, '-', &quot;Display this summary&quot;},
+    {&quot;host&quot;, OPT_HOST, 's', &quot;Use -connect instead&quot;},
+    {&quot;port&quot;, OPT_PORT, 'p', &quot;Use -connect instead&quot;},
+    {&quot;connect&quot;, OPT_CONNECT, 's',
+     &quot;TCP/IP where to connect (default is &quot; SSL_HOST_NAME &quot;:&quot; PORT_STR &quot;)&quot;},
+    {&quot;unix&quot;, OPT_UNIX, 's', &quot;Connect over unix domain sockets&quot;},
+    {&quot;verify&quot;, OPT_VERIFY, 'p', &quot;Turn on peer certificate verification&quot;},
+    {&quot;cert&quot;, OPT_CERT, '&lt;', &quot;Certificate file to use, PEM format assumed&quot;},
+    {&quot;certform&quot;, OPT_CERTFORM, 'F',
+     &quot;Certificate format (PEM or DER) PEM default&quot;},
+    {&quot;key&quot;, OPT_KEY, '&lt;', &quot;Private key file to use, if not in -cert file&quot;},
+    {&quot;keyform&quot;, OPT_KEYFORM, 'F', &quot;Key format (PEM or DER) PEM default&quot;},
+    {&quot;pass&quot;, OPT_PASS, 's', &quot;Private key file pass phrase source&quot;},
+    {&quot;CApath&quot;, OPT_CAPATH, '/', &quot;PEM format directory of CA's&quot;},
+    {&quot;CAfile&quot;, OPT_CAFILE, '&lt;', &quot;PEM format file of CA's&quot;},
+    {&quot;reconnect&quot;, OPT_RECONNECT, '-',
+     &quot;Drop and re-make the connection with the same Session-ID&quot;},
+    {&quot;pause&quot;, OPT_PAUSE, '-', &quot;Sleep  after each read and write system call&quot;},
+    {&quot;showcerts&quot;, OPT_SHOWCERTS, '-', &quot;Show all certificates in the chain&quot;},
+    {&quot;debug&quot;, OPT_DEBUG, '-', &quot;Extra output&quot;},
+    {&quot;msg&quot;, OPT_MSG, '-', &quot;Show protocol messages&quot;},
+    {&quot;msgfile&quot;, OPT_MSGFILE, '&gt;'},
+    {&quot;nbio_test&quot;, OPT_NBIO_TEST, '-', &quot;More ssl protocol testing&quot;},
+    {&quot;state&quot;, OPT_STATE, '-', &quot;Print the ssl states&quot;},
+    {&quot;crlf&quot;, OPT_CRLF, '-', &quot;Convert LF from terminal into CRLF&quot;},
+    {&quot;quiet&quot;, OPT_QUIET, '-', &quot;No s_client output&quot;},
+    {&quot;ign_eof&quot;, OPT_IGN_EOF, '-', &quot;Ignore input eof (default when -quiet)&quot;},
+    {&quot;no_ign_eof&quot;, OPT_NO_IGN_EOF, '-', &quot;Don't ignore input eof&quot;},
+#ifndef OPENSSL_NO_SSL3
+    {&quot;ssl3&quot;, OPT_SSL3, '-', &quot;Just use SSLv3&quot;},
+#endif
+    {&quot;tls1_2&quot;, OPT_TLS1_2, '-', &quot;Just use TLSv1.2&quot;},
+    {&quot;tls1_1&quot;, OPT_TLS1_1, '-', &quot;Just use TLSv1.1&quot;},
+    {&quot;tls1&quot;, OPT_TLS1, '-', &quot;Just use TLSv1&quot;},
+    {&quot;dtls&quot;, OPT_DTLS, '-'},
+    {&quot;dtls1&quot;, OPT_DTLS1, '-', &quot;Just use DTLSv1&quot;},
+    {&quot;dtls1_2&quot;, OPT_DTLS1_2, '-'},
+    {&quot;timeout&quot;, OPT_TIMEOUT, '-'},
+    {&quot;mtu&quot;, OPT_MTU, 'p', &quot;Set the link layer MTU&quot;},
+    {&quot;starttls&quot;, OPT_STARTTLS, 's',
+     &quot;Use the STARTTLS command before starting TLS&quot;},
+    {&quot;rand&quot;, OPT_RAND, 's',
+     &quot;Load the file(s) into the random number generator&quot;},
+    {&quot;sess_out&quot;, OPT_SESS_OUT, '&gt;', &quot;File to write SSL session to&quot;},
+    {&quot;sess_in&quot;, OPT_SESS_IN, '&lt;', &quot;File to read SSL session from&quot;},
+    {&quot;use_srtp&quot;, OPT_USE_SRTP, '&lt;',
+     &quot;Offer SRTP key management with a colon-separated profile list&quot;},
+    {&quot;keymatexport&quot;, OPT_KEYMATEXPORT, 's',
+     &quot;Export keying material using label&quot;},
+    {&quot;keymatexportlen&quot;, OPT_KEYMATEXPORTLEN, 'p',
+     &quot;Export len bytes of keying material (default 20)&quot;},
+    {&quot;fallback_scsv&quot;, OPT_FALLBACKSCSV, '-', &quot;Send the fallback SCSV&quot;},
+#ifdef WATT32
+    {&quot;wdebug&quot;, OPT_WDEBUG, '-', &quot;WATT-32 tcp debugging&quot;},
+#endif
+#ifdef FIONBIO
+    {&quot;nbio&quot;, OPT_NBIO, '-', &quot;Use non-blocking IO&quot;},
+#endif
+#ifndef OPENSSL_NO_PSK
+    {&quot;psk_identity&quot;, OPT_PSK_IDENTITY, 's', &quot;PSK identity&quot;},
+    {&quot;psk&quot;, OPT_PSK, 's', &quot;PSK in hex (without 0x)&quot;},
+# ifndef OPENSSL_NO_JPAKE
+    {&quot;jpake&quot;, OPT_JPAKE, 's', &quot;JPAKE secret to use&quot;},
+# endif
+#endif
+#ifndef OPENSSL_NO_KRB5
+    {&quot;krb5svc&quot;, OPT_KRB5SVC, 's', &quot;Kerberos service name&quot;},
+#endif
+#ifndef OPENSSL_NO_SRP
+    {&quot;srpuser&quot;, OPT_SRPUSER, 's', &quot;SRP authentification for 'user'&quot;},
+    {&quot;srppass&quot;, OPT_SRPPASS, 's', &quot;Password for 'user'&quot;},
+    {&quot;srp_lateuser&quot;, OPT_SRP_LATEUSER, '-',
+     &quot;SRP username into second ClientHello message&quot;},
+    {&quot;srp_moregroups&quot;, OPT_SRP_MOREGROUPS, '-',
+     &quot;Tolerate other than the known g N values.&quot;},
+    {&quot;srp_strength&quot;, OPT_SRP_STRENGTH, 'p', &quot;Minimal mength in bits for N&quot;},
+#endif
+#ifndef OPENSSL_NO_TLSEXT
+    {&quot;servername&quot;, OPT_SERVERNAME, 's',
+     &quot;Set TLS extension servername in ClientHello&quot;},
+    {&quot;tlsextdebug&quot;, OPT_TLSEXTDEBUG, '-',
+     &quot;Hex dump of all TLS extensions received&quot;},
+    {&quot;status&quot;, OPT_STATUS, '-', &quot;Request certificate status from server&quot;},
+    {&quot;serverinfo&quot;, OPT_SERVERINFO, 's',
+     &quot;types  Send empty ClientHello extensions (comma-separated numbers)&quot;},
+    {&quot;alpn&quot;, OPT_ALPN, 's',
+     &quot;Enable ALPN extension, considering named protocols supported (comma-separated list)&quot;},
+# ifndef OPENSSL_NO_NEXTPROTONEG
+    {&quot;nextprotoneg&quot;, OPT_NEXTPROTONEG, 's',
+     &quot;Enable NPN extension, considering named protocols supported (comma-separated list)&quot;},
+# endif
+#endif
+    {&quot;CRL&quot;, OPT_CRL, '&lt;'},
+    {&quot;crl_download&quot;, OPT_CRL_DOWNLOAD, '-'},
+    {&quot;CRLform&quot;, OPT_CRLFORM, 'F'},
+    {&quot;verify_return_error&quot;, OPT_VERIFY_RET_ERROR, '-'},
+    {&quot;verify_quiet&quot;, OPT_VERIFY_QUIET, '-'},
+    {&quot;brief&quot;, OPT_BRIEF, '-'},
+    {&quot;prexit&quot;, OPT_PREXIT, '-'},
+    {&quot;ssl_client_engine&quot;, OPT_SSL_CLIENT_ENGINE, 's'},
+    {&quot;trace&quot;, OPT_TRACE, '-'},
+    {&quot;security_debug&quot;, OPT_SECURITY_DEBUG, '-'},
+    {&quot;security_debug_verbose&quot;, OPT_SECURITY_DEBUG_VERBOSE, '-'},
+    {&quot;cert_chain&quot;, OPT_CERT_CHAIN, '&lt;'},
+    {&quot;chainCApath&quot;, OPT_CHAINCAPATH, '/'},
+    {&quot;verifyCApath&quot;, OPT_VERIFYCAPATH, '/'},
+    {&quot;build_chain&quot;, OPT_BUILD_CHAIN, '-'},
+    {&quot;chainCAfile&quot;, OPT_CHAINCAFILE, '&lt;'},
+    {&quot;verifyCAfile&quot;, OPT_VERIFYCAFILE, '&lt;'},
+#ifndef OPENSSL_NO_ENGINE
+    {&quot;engine&quot;, OPT_ENGINE, 's', &quot;Use engine, possibly a hardware device&quot;},
+#endif
+    OPT_S_OPTIONS,
+    OPT_V_OPTIONS,
+    OPT_X_OPTIONS,
+    {NULL}
+};
+
+typedef enum PROTOCOL_choice {
+    PROTO_OFF,
     PROTO_SMTP,
     PROTO_POP3,
     PROTO_IMAP,
     PROTO_FTP,
     PROTO_XMPP
+} PROTOCOL_CHOICE;
+
+static OPT_PAIR services[] = {
+    {&quot;smtp&quot;, PROTO_SMTP},
+    {&quot;pop3&quot;, PROTO_POP3},
+    {&quot;imap&quot;, PROTO_IMAP},
+    {&quot;ftp&quot;, PROTO_FTP},
+    {&quot;xmpp&quot;, PROTO_XMPP},
+    {NULL}
 };
 
-int MAIN(int, char **);
-
-int MAIN(int argc, char **argv)
+int s_client_main(int argc, char **argv)
 {
-    int build_chain = 0;
-    SSL *con = NULL;
-#ifndef OPENSSL_NO_KRB5
-    KSSL_CTX *kctx;
-#endif
-    int s, k, width, state = 0;
-    char *cbuf = NULL, *sbuf = NULL, *mbuf = NULL;
-    int cbuf_len, cbuf_off;
-    int sbuf_len, sbuf_off;
-    fd_set readfds, writefds;
-    short port = PORT;
-    int full_log = 1;
-    char *host = SSL_HOST_NAME;
-    const char *unix_path = NULL;
-    char *xmpphost = NULL;
-    char *cert_file = NULL, *key_file = NULL, *chain_file = NULL;
-    int cert_format = FORMAT_PEM, key_format = FORMAT_PEM;
-    char *passarg = NULL, *pass = NULL;
-    X509 *cert = NULL;
+    BIO *sbio;
     EVP_PKEY *key = NULL;
-    STACK_OF(X509) *chain = NULL;
-    char *CApath = NULL, *CAfile = NULL;
-    char *chCApath = NULL, *chCAfile = NULL;
-    char *vfyCApath = NULL, *vfyCAfile = NULL;
-    int reconnect = 0, badop = 0, verify = SSL_VERIFY_NONE;
-    int crlf = 0;
-    int write_tty, read_tty, write_ssl, read_ssl, tty_on, ssl_pending;
+    SSL *con = NULL;
     SSL_CTX *ctx = NULL;
-    int ret = 1, in_init = 1, i, nbio_test = 0;
-    int starttls_proto = PROTO_OFF;
-    int prexit = 0;
+    STACK_OF(X509) *chain = NULL;
+    X509 *cert = NULL;
     X509_VERIFY_PARAM *vpm = NULL;
-    int badarg = 0;
-    const SSL_METHOD *meth = NULL;
-    int socket_type = SOCK_STREAM;
-    BIO *sbio;
-    char *inrand = NULL;
-    int mbuf_len = 0;
+    SSL_EXCERT *exc = NULL;
+    SSL_CONF_CTX *cctx = NULL;
+    STACK_OF(OPENSSL_STRING) *ssl_args = NULL;
+    STACK_OF(X509_CRL) *crls = NULL;
+    const SSL_METHOD *meth = SSLv23_client_method();
+    char *CApath = NULL, *CAfile = NULL, *cbuf = NULL, *sbuf = NULL, *mbuf =
+        NULL;
+    char *cert_file = NULL, *key_file = NULL, *chain_file = NULL, *prog;
+    char *chCApath = NULL, *chCAfile = NULL, *host = SSL_HOST_NAME, *inrand =
+        NULL;
+    char *passarg = NULL, *pass = NULL, *vfyCApath = NULL, *vfyCAfile = NULL;
+    char *sess_in = NULL, *sess_out = NULL, *crl_file = NULL, *p;
+    char *engine_id = NULL, *ssl_client_engine_id = NULL;
+    char *jpake_secret = NULL;
+    const char *unix_path = NULL;
+    struct sockaddr peer;
     struct timeval timeout, *timeoutp;
+    fd_set readfds, writefds;
+    int build_chain = 0, cbuf_len, cbuf_off, cert_format = FORMAT_PEM;
+    int key_format = FORMAT_PEM, crlf = 0, full_log = 1, mbuf_len = 0;
+    int prexit = 0;
+    int enable_timeouts = 0, sdebug = 0, peerlen = sizeof peer;
+    int reconnect = 0, verify = SSL_VERIFY_NONE, vpmtouched = 0;
+    int ret = 1, in_init = 1, i, nbio_test = 0, s, k, width, state = 0;
+    int sbuf_len, sbuf_off, socket_type = SOCK_STREAM;
+    int starttls_proto = PROTO_OFF, crl_format = FORMAT_PEM, crl_download = 0;
+    int write_tty, read_tty, write_ssl, read_ssl, tty_on, ssl_pending;
+    int fallback_scsv = 0;
+    long socket_mtu = 0, randamt = 0;
+    unsigned short port = PORT;
+    OPTION_CHOICE o;
+#ifndef OPENSSL_NO_KRB5
+    KSSL_CTX *kctx;
+    const char *krb5svc = NULL;
+#endif
 #ifndef OPENSSL_NO_ENGINE
-    char *engine_id = NULL;
-    char *ssl_client_engine_id = NULL;
     ENGINE *ssl_client_engine = NULL;
-#endif
     ENGINE *e = NULL;
+#endif
 #if defined(OPENSSL_SYS_WINDOWS) || defined(OPENSSL_SYS_MSDOS) || defined(OPENSSL_SYS_NETWARE)
     struct timeval tv;
 #endif
 #ifndef OPENSSL_NO_TLSEXT
     char *servername = NULL;
+    const char *alpn_in = NULL;
     tlsextctx tlsextcbp = { NULL, 0 };
+# define MAX_SI_TYPES 100
+    unsigned short serverinfo_types[MAX_SI_TYPES];
+    int serverinfo_count = 0, start = 0, len;
 # ifndef OPENSSL_NO_NEXTPROTONEG
     const char *next_proto_neg_in = NULL;
 # endif
-    const char *alpn_in = NULL;
-# define MAX_SI_TYPES 100
-    unsigned short serverinfo_types[MAX_SI_TYPES];
-    int serverinfo_types_count = 0;
-#endif
-    char *sess_in = NULL;
-    char *sess_out = NULL;
-    struct sockaddr peer;
-    int peerlen = sizeof(peer);
-    int fallback_scsv = 0;
-    int enable_timeouts = 0;
-    long socket_mtu = 0;
-#ifndef OPENSSL_NO_JPAKE
-    static char *jpake_secret = NULL;
-# define no_jpake !jpake_secret
-#else
-# define no_jpake 1
 #endif
 #ifndef OPENSSL_NO_SRP
     char *srppass = NULL;
     int srp_lateuser = 0;
     SRP_ARG srp_arg = { NULL, NULL, 0, 0, 0, 1024 };
 #endif
-    SSL_EXCERT *exc = NULL;
-
-    SSL_CONF_CTX *cctx = NULL;
-    STACK_OF(OPENSSL_STRING) *ssl_args = NULL;
-
-    char *crl_file = NULL;
-    int crl_format = FORMAT_PEM;
-    int crl_download = 0;
-    STACK_OF(X509_CRL) *crls = NULL;
-    int sdebug = 0;
-
-    meth = SSLv23_client_method();
 
-    apps_startup();
+    prog = opt_progname(argv[0]);
     c_Pause = 0;
     c_quiet = 0;
     c_ign_eof = 0;
     c_debug = 0;
     c_msg = 0;
     c_showcerts = 0;
-
-    if (bio_err == NULL)
-        bio_err = BIO_new_fp(stderr, BIO_NOCLOSE);
-
-    if (!load_config(bio_err, NULL))
-        goto end;
+    c_nbio = 0;
+    verify_depth = 0;
+    verify_error = X509_V_OK;
+    vpm = X509_VERIFY_PARAM_new();
+    cbuf = OPENSSL_malloc(BUFSIZZ);
+    sbuf = OPENSSL_malloc(BUFSIZZ);
+    mbuf = OPENSSL_malloc(BUFSIZZ);
     cctx = SSL_CONF_CTX_new();
-    if (!cctx)
-        goto end;
-    SSL_CONF_CTX_set_flags(cctx, SSL_CONF_FLAG_CLIENT);
-    SSL_CONF_CTX_set_flags(cctx, SSL_CONF_FLAG_CMDLINE);
 
-    if (((cbuf = OPENSSL_malloc(BUFSIZZ)) == NULL) ||
-        ((sbuf = OPENSSL_malloc(BUFSIZZ)) == NULL) ||
-        ((mbuf = OPENSSL_malloc(BUFSIZZ)) == NULL)) {
-        BIO_printf(bio_err, &quot;out of memory\n&quot;);
+    if (vpm == NULL || cctx == NULL
+        || cbuf == NULL || sbuf == NULL || mbuf == NULL) {
+        BIO_printf(bio_err, &quot;%s: out of memory\n&quot;, prog);
         goto end;
     }
 
-    verify_depth = 0;
-    verify_error = X509_V_OK;
-#ifdef FIONBIO
-    c_nbio = 0;
-#endif
+    SSL_CONF_CTX_set_flags(cctx, SSL_CONF_FLAG_CLIENT | SSL_CONF_FLAG_CMDLINE);
 
-    argc--;
-    argv++;
-    while (argc &gt;= 1) {
-        if (strcmp(*argv, &quot;-host&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            host = *(++argv);
-        } else if (strcmp(*argv, &quot;-port&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            port = atoi(*(++argv));
-            if (port == 0)
-                goto bad;
-        } else if (strcmp(*argv, &quot;-connect&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            if (!extract_host_port(*(++argv), &amp;host, NULL, &amp;port))
-                goto bad;
-        } else if (strcmp(*argv, &quot;-unix&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            unix_path = *(++argv);
-        } else if (strcmp(*argv, &quot;-xmpphost&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            xmpphost = *(++argv);
-        } else if (strcmp(*argv, &quot;-verify&quot;) == 0) {
+    prog = opt_init(argc, argv, s_client_options);
+    while ((o = opt_next()) != OPT_EOF) {
+        switch (o) {
+#ifndef WATT32
+        case OPT_WDEBUG:
+#endif
+#ifdef OPENSSL_NO_JPAKE
+        case OPT_JPAKE:
+#endif
+#ifdef OPENSSL_NO_SSL_TRACE
+        case OPT_TRACE:
+#endif
+        case OPT_EOF:
+        case OPT_ERR:
+ opthelp:
+            BIO_printf(bio_err, &quot;%s: Use -help for summary.\n&quot;, prog);
+            goto end;
+        case OPT_HELP:
+            opt_help(s_client_options);
+            ret = 0;
+            goto end;
+        case OPT_HOST:
+            host = opt_arg();
+            break;
+        case OPT_PORT:
+            port = atoi(opt_arg());
+            break;
+        case OPT_CONNECT:
+            if (!extract_host_port(opt_arg(), &amp;host, NULL, &amp;port))
+                goto end;
+            break;
+        case OPT_UNIX:
+            unix_path = opt_arg();
+            break;
+        case OPT_VERIFY:
             verify = SSL_VERIFY_PEER;
-            if (--argc &lt; 1)
-                goto bad;
-            verify_depth = atoi(*(++argv));
+            verify_depth = atoi(opt_arg());
             if (!c_quiet)
                 BIO_printf(bio_err, &quot;verify depth is %d\n&quot;, verify_depth);
-        } else if (strcmp(*argv, &quot;-cert&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            cert_file = *(++argv);
-        } else if (strcmp(*argv, &quot;-CRL&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            crl_file = *(++argv);
-        } else if (strcmp(*argv, &quot;-crl_download&quot;) == 0)
+            break;
+        case OPT_CERT:
+            cert_file = opt_arg();
+            break;
+        case OPT_CRL:
+            crl_file = opt_arg();
+            break;
+        case OPT_CRL_DOWNLOAD:
             crl_download = 1;
-        else if (strcmp(*argv, &quot;-sess_out&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            sess_out = *(++argv);
-        } else if (strcmp(*argv, &quot;-sess_in&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            sess_in = *(++argv);
-        } else if (strcmp(*argv, &quot;-certform&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            cert_format = str2fmt(*(++argv));
-        } else if (strcmp(*argv, &quot;-CRLform&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            crl_format = str2fmt(*(++argv));
-        } else if (args_verify(&amp;argv, &amp;argc, &amp;badarg, bio_err, &amp;vpm)) {
-            if (badarg)
-                goto bad;
-            continue;
-        } else if (strcmp(*argv, &quot;-verify_return_error&quot;) == 0)
+            break;
+        case OPT_SESS_OUT:
+            sess_out = opt_arg();
+            break;
+        case OPT_SESS_IN:
+            sess_in = opt_arg();
+            break;
+        case OPT_CERTFORM:
+            if (!opt_format(opt_arg(), OPT_FMT_PEMDER, &amp;cert_format))
+                goto opthelp;
+            break;
+        case OPT_CRLFORM:
+            if (!opt_format(opt_arg(), OPT_FMT_PEMDER, &amp;crl_format))
+                goto opthelp;
+            break;
+        case OPT_VERIFY_RET_ERROR:
             verify_return_error = 1;
-        else if (strcmp(*argv, &quot;-verify_quiet&quot;) == 0)
-            verify_quiet = 1;
-        else if (strcmp(*argv, &quot;-brief&quot;) == 0) {
-            c_brief = 1;
+            break;
+        case OPT_VERIFY_QUIET:
             verify_quiet = 1;
-            c_quiet = 1;
-        } else if (args_excert(&amp;argv, &amp;argc, &amp;badarg, bio_err, &amp;exc)) {
-            if (badarg)
-                goto bad;
-            continue;
-        } else if (args_ssl(&amp;argv, &amp;argc, cctx, &amp;badarg, bio_err, &amp;ssl_args)) {
-            if (badarg)
-                goto bad;
-            continue;
-        } else if (strcmp(*argv, &quot;-prexit&quot;) == 0)
+            break;
+        case OPT_BRIEF:
+            c_brief = verify_quiet = c_quiet = 1;
+            break;
+        case OPT_S_CASES:
+            if (ssl_args == NULL)
+                ssl_args = sk_OPENSSL_STRING_new_null();
+            if (ssl_args == NULL
+                || !sk_OPENSSL_STRING_push(ssl_args, opt_flag())
+                || !sk_OPENSSL_STRING_push(ssl_args, opt_arg())) {
+                BIO_printf(bio_err, &quot;%s: Memory allocation failure\n&quot;, prog);
+                goto end;
+            }
+            break;
+        case OPT_V_CASES:
+            if (!opt_verify(o, vpm))
+                goto end;
+            vpmtouched++;
+            break;
+        case OPT_X_CASES:
+            if (!args_excert(o, &amp;exc))
+                goto end;
+            break;
+        case OPT_PREXIT:
             prexit = 1;
-        else if (strcmp(*argv, &quot;-crlf&quot;) == 0)
+            break;
+        case OPT_CRLF:
             crlf = 1;
-        else if (strcmp(*argv, &quot;-quiet&quot;) == 0) {
-            c_quiet = 1;
-            c_ign_eof = 1;
-        } else if (strcmp(*argv, &quot;-ign_eof&quot;) == 0)
+            break;
+        case OPT_QUIET:
+            c_quiet = c_ign_eof = 1;
+            break;
+        case OPT_NBIO:
+            c_nbio = 1;
+            break;
+        case OPT_KRB5SVC:
+#ifndef OPENSSL_NO_KRB5
+            krb5svc = opt_arg();
+#endif
+            break;
+        case OPT_ENGINE:
+            engine_id = opt_arg();
+            break;
+        case OPT_SSL_CLIENT_ENGINE:
+            ssl_client_engine_id = opt_arg();
+            break;
+        case OPT_RAND:
+            inrand = opt_arg();
+            break;
+        case OPT_IGN_EOF:
             c_ign_eof = 1;
-        else if (strcmp(*argv, &quot;-no_ign_eof&quot;) == 0)
+            break;
+        case OPT_NO_IGN_EOF:
             c_ign_eof = 0;
-        else if (strcmp(*argv, &quot;-pause&quot;) == 0)
+            break;
+        case OPT_PAUSE:
             c_Pause = 1;
-        else if (strcmp(*argv, &quot;-debug&quot;) == 0)
+            break;
+        case OPT_DEBUG:
             c_debug = 1;
+            break;
 #ifndef OPENSSL_NO_TLSEXT
-        else if (strcmp(*argv, &quot;-tlsextdebug&quot;) == 0)
+        case OPT_TLSEXTDEBUG:
             c_tlsextdebug = 1;
-        else if (strcmp(*argv, &quot;-status&quot;) == 0)
+            break;
+        case OPT_STATUS:
             c_status_req = 1;
+            break;
 #endif
 #ifdef WATT32
-        else if (strcmp(*argv, &quot;-wdebug&quot;) == 0)
+        case OPT_WDEBUG:
             dbug_init();
+            break;
 #endif
-        else if (strcmp(*argv, &quot;-msg&quot;) == 0)
+        case OPT_MSG:
             c_msg = 1;
-        else if (strcmp(*argv, &quot;-msgfile&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            bio_c_msg = BIO_new_file(*(++argv), &quot;w&quot;);
-        }
+            break;
+        case OPT_MSGFILE:
+            bio_c_msg = BIO_new_file(opt_arg(), &quot;w&quot;);
+            break;
 #ifndef OPENSSL_NO_SSL_TRACE
-        else if (strcmp(*argv, &quot;-trace&quot;) == 0)
+        case OPT_TRACE:
             c_msg = 2;
+            break;
 #endif
-        else if (strcmp(*argv, &quot;-security_debug&quot;) == 0) {
+        case OPT_SECURITY_DEBUG:
             sdebug = 1;
-        } else if (strcmp(*argv, &quot;-security_debug_verbose&quot;) == 0) {
+            break;
+        case OPT_SECURITY_DEBUG_VERBOSE:
             sdebug = 2;
-        } else if (strcmp(*argv, &quot;-showcerts&quot;) == 0)
+            break;
+        case OPT_SHOWCERTS:
             c_showcerts = 1;
-        else if (strcmp(*argv, &quot;-nbio_test&quot;) == 0)
+            break;
+        case OPT_NBIO_TEST:
             nbio_test = 1;
-        else if (strcmp(*argv, &quot;-state&quot;) == 0)
+            break;
+        case OPT_STATE:
             state = 1;
+            break;
 #ifndef OPENSSL_NO_PSK
-        else if (strcmp(*argv, &quot;-psk_identity&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            psk_identity = *(++argv);
-        } else if (strcmp(*argv, &quot;-psk&quot;) == 0) {
-            size_t j;
-
-            if (--argc &lt; 1)
-                goto bad;
-            psk_key = *(++argv);
-            for (j = 0; j &lt; strlen(psk_key); j++) {
-                if (isxdigit((unsigned char)psk_key[j]))
+        case OPT_PSK_IDENTITY:
+            psk_identity = opt_arg();
+            break;
+        case OPT_PSK:
+            for (p = psk_key = opt_arg(); *p; p++) {
+                if (isxdigit(*p))
                     continue;
-                BIO_printf(bio_err, &quot;Not a hex number '%s'\n&quot;, *argv);
-                goto bad;
+                BIO_printf(bio_err, &quot;Not a hex number '%s'\n&quot;, psk_key);
+                goto end;
             }
-        }
+            break;
 #endif
 #ifndef OPENSSL_NO_SRP
-        else if (strcmp(*argv, &quot;-srpuser&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            srp_arg.srplogin = *(++argv);
+        case OPT_SRPUSER:
+            srp_arg.srplogin = opt_arg();
             meth = TLSv1_client_method();
-        } else if (strcmp(*argv, &quot;-srppass&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            srppass = *(++argv);
+            break;
+        case OPT_SRPPASS:
+            srppass = opt_arg();
             meth = TLSv1_client_method();
-        } else if (strcmp(*argv, &quot;-srp_strength&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            srp_arg.strength = atoi(*(++argv));
+            break;
+        case OPT_SRP_STRENGTH:
+            srp_arg.strength = atoi(opt_arg());
             BIO_printf(bio_err, &quot;SRP minimal length for N is %d\n&quot;,
                        srp_arg.strength);
             meth = TLSv1_client_method();
-        } else if (strcmp(*argv, &quot;-srp_lateuser&quot;) == 0) {
+            break;
+        case OPT_SRP_LATEUSER:
             srp_lateuser = 1;
             meth = TLSv1_client_method();
-        } else if (strcmp(*argv, &quot;-srp_moregroups&quot;) == 0) {
+            break;
+        case OPT_SRP_MOREGROUPS:
             srp_arg.amp = 1;
             meth = TLSv1_client_method();
-        }
+            break;
 #endif
-#ifndef OPENSSL_NO_SSL3_METHOD
-        else if (strcmp(*argv, &quot;-ssl3&quot;) == 0)
+#ifndef OPENSSL_NO_SSL3
+        case OPT_SSL3:
             meth = SSLv3_client_method();
+            break;
 #endif
-        else if (strcmp(*argv, &quot;-tls1_2&quot;) == 0)
+        case OPT_TLS1_2:
             meth = TLSv1_2_client_method();
-        else if (strcmp(*argv, &quot;-tls1_1&quot;) == 0)
+            break;
+        case OPT_TLS1_1:
             meth = TLSv1_1_client_method();
-        else if (strcmp(*argv, &quot;-tls1&quot;) == 0)
+            break;
+        case OPT_TLS1:
             meth = TLSv1_client_method();
+            break;
 #ifndef OPENSSL_NO_DTLS1
-        else if (strcmp(*argv, &quot;-dtls&quot;) == 0) {
+        case OPT_DTLS:
             meth = DTLS_client_method();
             socket_type = SOCK_DGRAM;
-        } else if (strcmp(*argv, &quot;-dtls1&quot;) == 0) {
+            break;
+        case OPT_DTLS1:
             meth = DTLSv1_client_method();
             socket_type = SOCK_DGRAM;
-        } else if (strcmp(*argv, &quot;-dtls1_2&quot;) == 0) {
+            break;
+        case OPT_DTLS1_2:
             meth = DTLSv1_2_client_method();
             socket_type = SOCK_DGRAM;
-        } else if (strcmp(*argv, &quot;-timeout&quot;) == 0)
+            break;
+        case OPT_TIMEOUT:
             enable_timeouts = 1;
-        else if (strcmp(*argv, &quot;-mtu&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            socket_mtu = atol(*(++argv));
-        }
+            break;
+        case OPT_MTU:
+            socket_mtu = atol(opt_arg());
+            break;
 #endif
-        else if (strcmp(*argv, &quot;-fallback_scsv&quot;) == 0) {
+        case OPT_FALLBACKSCSV:
             fallback_scsv = 1;
-        } else if (strcmp(*argv, &quot;-keyform&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            key_format = str2fmt(*(++argv));
-        } else if (strcmp(*argv, &quot;-pass&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            passarg = *(++argv);
-        } else if (strcmp(*argv, &quot;-cert_chain&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            chain_file = *(++argv);
-        } else if (strcmp(*argv, &quot;-key&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            key_file = *(++argv);
-        } else if (strcmp(*argv, &quot;-reconnect&quot;) == 0) {
+            break;
+        case OPT_KEYFORM:
+            if (!opt_format(opt_arg(), OPT_FMT_PEMDER, &amp;key_format))
+                goto opthelp;
+            break;
+        case OPT_PASS:
+            passarg = opt_arg();
+            break;
+        case OPT_CERT_CHAIN:
+            chain_file = opt_arg();
+            break;
+        case OPT_KEY:
+            key_file = opt_arg();
+            break;
+        case OPT_RECONNECT:
             reconnect = 5;
-        } else if (strcmp(*argv, &quot;-CApath&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            CApath = *(++argv);
-        } else if (strcmp(*argv, &quot;-chainCApath&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            chCApath = *(++argv);
-        } else if (strcmp(*argv, &quot;-verifyCApath&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            vfyCApath = *(++argv);
-        } else if (strcmp(*argv, &quot;-build_chain&quot;) == 0)
+            break;
+        case OPT_CAPATH:
+            CApath = opt_arg();
+            break;
+        case OPT_CHAINCAPATH:
+            chCApath = opt_arg();
+            break;
+        case OPT_VERIFYCAPATH:
+            vfyCApath = opt_arg();
+            break;
+        case OPT_BUILD_CHAIN:
             build_chain = 1;
-        else if (strcmp(*argv, &quot;-CAfile&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            CAfile = *(++argv);
-        } else if (strcmp(*argv, &quot;-chainCAfile&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            chCAfile = *(++argv);
-        } else if (strcmp(*argv, &quot;-verifyCAfile&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            vfyCAfile = *(++argv);
-        }
+            break;
+        case OPT_CAFILE:
+            CAfile = opt_arg();
+            break;
+        case OPT_CHAINCAFILE:
+            chCAfile = opt_arg();
+            break;
+        case OPT_VERIFYCAFILE:
+            vfyCAfile = opt_arg();
+            break;
 #ifndef OPENSSL_NO_TLSEXT
-# ifndef OPENSSL_NO_NEXTPROTONEG
-        else if (strcmp(*argv, &quot;-nextprotoneg&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            next_proto_neg_in = *(++argv);
-        }
-# endif
-        else if (strcmp(*argv, &quot;-alpn&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            alpn_in = *(++argv);
-        } else if (strcmp(*argv, &quot;-serverinfo&quot;) == 0) {
-            char *c;
-            int start = 0;
-            int len;
-
-            if (--argc &lt; 1)
-                goto bad;
-            c = *(++argv);
-            serverinfo_types_count = 0;
-            len = strlen(c);
-            for (i = 0; i &lt;= len; ++i) {
-                if (i == len || c[i] == ',') {
-                    serverinfo_types[serverinfo_types_count]
-                        = atoi(c + start);
-                    serverinfo_types_count++;
+        case OPT_NEXTPROTONEG:
+            next_proto_neg_in = opt_arg();
+            break;
+        case OPT_ALPN:
+            alpn_in = opt_arg();
+            break;
+        case OPT_SERVERINFO:
+            p = opt_arg();
+            len = strlen(p);
+            for (start = 0, i = 0; i &lt;= len; ++i) {
+                if (i == len || p[i] == ',') {
+                    serverinfo_types[serverinfo_count] = atoi(p + start);
+                    if (++serverinfo_count == MAX_SI_TYPES)
+                        break;
                     start = i + 1;
                 }
-                if (serverinfo_types_count == MAX_SI_TYPES)
-                    break;
             }
-        }
-#endif
-#ifdef FIONBIO
-        else if (strcmp(*argv, &quot;-nbio&quot;) == 0) {
-            c_nbio = 1;
-        }
-#endif
-        else if (strcmp(*argv, &quot;-starttls&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            ++argv;
-            if (strcmp(*argv, &quot;smtp&quot;) == 0)
-                starttls_proto = PROTO_SMTP;
-            else if (strcmp(*argv, &quot;pop3&quot;) == 0)
-                starttls_proto = PROTO_POP3;
-            else if (strcmp(*argv, &quot;imap&quot;) == 0)
-                starttls_proto = PROTO_IMAP;
-            else if (strcmp(*argv, &quot;ftp&quot;) == 0)
-                starttls_proto = PROTO_FTP;
-            else if (strcmp(*argv, &quot;xmpp&quot;) == 0)
-                starttls_proto = PROTO_XMPP;
-            else
-                goto bad;
-        }
-#ifndef OPENSSL_NO_ENGINE
-        else if (strcmp(*argv, &quot;-engine&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            engine_id = *(++argv);
-        } else if (strcmp(*argv, &quot;-ssl_client_engine&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            ssl_client_engine_id = *(++argv);
-        }
+            break;
 #endif
-        else if (strcmp(*argv, &quot;-rand&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            inrand = *(++argv);
-        }
+        case OPT_STARTTLS:
+            if (!opt_pair(opt_arg(), services, &amp;starttls_proto))
+                goto end;
 #ifndef OPENSSL_NO_TLSEXT
-        else if (strcmp(*argv, &quot;-servername&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            servername = *(++argv);
+        case OPT_SERVERNAME:
+            servername = opt_arg();
             /* meth=TLSv1_client_method(); */
-        }
+            break;
 #endif
 #ifndef OPENSSL_NO_JPAKE
-        else if (strcmp(*argv, &quot;-jpake&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            jpake_secret = *++argv;
-        }
-#endif
-#ifndef OPENSSL_NO_SRTP
-        else if (strcmp(*argv, &quot;-use_srtp&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            srtp_profiles = *(++argv);
-        }
+        case OPT_JPAKE:
+            jpake_secret = opt_arg();
+            break;
 #endif
-        else if (strcmp(*argv, &quot;-keymatexport&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            keymatexportlabel = *(++argv);
-        } else if (strcmp(*argv, &quot;-keymatexportlen&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            keymatexportlen = atoi(*(++argv));
-            if (keymatexportlen == 0)
-                goto bad;
-        } else {
-            BIO_printf(bio_err, &quot;unknown option %s\n&quot;, *argv);
-            badop = 1;
+        case OPT_USE_SRTP:
+            srtp_profiles = opt_arg();
+            break;
+        case OPT_KEYMATEXPORT:
+            keymatexportlabel = opt_arg();
+            break;
+        case OPT_KEYMATEXPORTLEN:
+            keymatexportlen = atoi(opt_arg());
             break;
         }
-        argc--;
-        argv++;
-    }
-    if (badop) {
- bad:
-        sc_usage();
-        goto end;
     }
+    argc = opt_num_rest();
+    argv = opt_rest();
 
     if (unix_path &amp;&amp; (socket_type != SOCK_STREAM)) {
         BIO_printf(bio_err,
@@ -1142,9 +1062,6 @@ int MAIN(int argc, char **argv)
     }
 #endif
 
-    OpenSSL_add_ssl_algorithms();
-    SSL_load_error_strings();
-
 #if !defined(OPENSSL_NO_TLSEXT) &amp;&amp; !defined(OPENSSL_NO_NEXTPROTONEG)
     next_proto.status = -1;
     if (next_proto_neg_in) {
@@ -1159,16 +1076,17 @@ int MAIN(int argc, char **argv)
 #endif
 
 #ifndef OPENSSL_NO_ENGINE
-    e = setup_engine(bio_err, engine_id, 1);
+    e = setup_engine(engine_id, 1);
     if (ssl_client_engine_id) {
         ssl_client_engine = ENGINE_by_id(ssl_client_engine_id);
-        if (!ssl_client_engine) {
+        if (ssl_client_engine == NULL) {
             BIO_printf(bio_err, &quot;Error getting client auth engine\n&quot;);
             goto end;
         }
     }
 #endif
-    if (!app_passwd(bio_err, passarg, NULL, &amp;pass, NULL)) {
+
+    if (!app_passwd(passarg, NULL, &amp;pass, NULL)) {
         BIO_printf(bio_err, &quot;Error getting password\n&quot;);
         goto end;
     }
@@ -1177,28 +1095,25 @@ int MAIN(int argc, char **argv)
         key_file = cert_file;
 
     if (key_file) {
-
-        key = load_key(bio_err, key_file, key_format, 0, pass, e,
+        key = load_key(key_file, key_format, 0, pass, e,
                        &quot;client certificate private key file&quot;);
-        if (!key) {
+        if (key == NULL) {
             ERR_print_errors(bio_err);
             goto end;
         }
-
     }
 
     if (cert_file) {
-        cert = load_cert(bio_err, cert_file, cert_format,
+        cert = load_cert(cert_file, cert_format,
                          NULL, e, &quot;client certificate file&quot;);
-
-        if (!cert) {
+        if (cert == NULL) {
             ERR_print_errors(bio_err);
             goto end;
         }
     }
 
     if (chain_file) {
-        chain = load_certs(bio_err, chain_file, FORMAT_PEM,
+        chain = load_certs(chain_file, FORMAT_PEM,
                            NULL, e, &quot;client certificate chain&quot;);
         if (!chain)
             goto end;
@@ -1207,13 +1122,13 @@ int MAIN(int argc, char **argv)
     if (crl_file) {
         X509_CRL *crl;
         crl = load_crl(crl_file, crl_format);
-        if (!crl) {
+        if (crl == NULL) {
             BIO_puts(bio_err, &quot;Error loading CRL\n&quot;);
             ERR_print_errors(bio_err);
             goto end;
         }
         crls = sk_X509_CRL_new_null();
-        if (!crls || !sk_X509_CRL_push(crls, crl)) {
+        if (crls == NULL || !sk_X509_CRL_push(crls, crl)) {
             BIO_puts(bio_err, &quot;Error adding CRL\n&quot;);
             ERR_print_errors(bio_err);
             X509_CRL_free(crl);
@@ -1221,30 +1136,29 @@ int MAIN(int argc, char **argv)
         }
     }
 
-    if (!load_excert(&amp;exc, bio_err))
+    if (!load_excert(&amp;exc))
         goto end;
 
-    if (!app_RAND_load_file(NULL, bio_err, 1) &amp;&amp; inrand == NULL
+    if (!app_RAND_load_file(NULL, 1) &amp;&amp; inrand == NULL
         &amp;&amp; !RAND_status()) {
         BIO_printf(bio_err,
                    &quot;warning, not much extra random data, consider using the -rand option\n&quot;);
     }
-    if (inrand != NULL)
-        BIO_printf(bio_err, &quot;%ld semi-random bytes loaded\n&quot;,
-                   app_RAND_load_files(inrand));
+    if (inrand != NULL) {
+        randamt = app_RAND_load_files(inrand);
+        BIO_printf(bio_err, &quot;%ld semi-random bytes loaded\n&quot;, randamt);
+    }
 
     if (bio_c_out == NULL) {
         if (c_quiet &amp;&amp; !c_debug) {
             bio_c_out = BIO_new(BIO_s_null());
             if (c_msg &amp;&amp; !bio_c_msg)
-                bio_c_msg = BIO_new_fp(stdout, BIO_NOCLOSE);
-        } else {
-            if (bio_c_out == NULL)
-                bio_c_out = BIO_new_fp(stdout, BIO_NOCLOSE);
-        }
+                bio_c_msg = dup_bio_out();
+        } else if (bio_c_out == NULL)
+            bio_c_out = dup_bio_out();
     }
 #ifndef OPENSSL_NO_SRP
-    if (!app_passwd(bio_err, srppass, NULL, &amp;srp_arg.srppassin, NULL)) {
+    if (!app_passwd(srppass, NULL, &amp;srp_arg.srppassin, NULL)) {
         BIO_printf(bio_err, &quot;Error getting password\n&quot;);
         goto end;
     }
@@ -1259,16 +1173,14 @@ int MAIN(int argc, char **argv)
     if (sdebug)
         ssl_ctx_security_debug(ctx, bio_err, sdebug);
 
-    if (vpm &amp;&amp; !SSL_CTX_set1_param(ctx, vpm)) {
+    if (vpmtouched &amp;&amp; !SSL_CTX_set1_param(ctx, vpm)) {
         BIO_printf(bio_err, &quot;Error setting verify params\n&quot;);
         ERR_print_errors(bio_err);
         goto end;
     }
 
-    if (!args_ssl_call(ctx, bio_err, cctx, ssl_args, 1, no_jpake)) {
-        ERR_print_errors(bio_err);
+    if (!config_ctx(cctx, ssl_args, ctx, 1, jpake_secret == NULL))
         goto end;
-    }
 
     if (!ssl_load_stores(ctx, vfyCApath, vfyCAfile, chCApath, chCAfile,
                          crls, crl_download)) {
@@ -1289,12 +1201,7 @@ int MAIN(int argc, char **argv)
 #endif
 
 #ifndef OPENSSL_NO_PSK
-# ifdef OPENSSL_NO_JPAKE
-    if (psk_key != NULL)
-# else
-    if (psk_key != NULL || jpake_secret)
-# endif
-    {
+    if (psk_key != NULL || jpake_secret) {
         if (c_debug)
             BIO_printf(bio_c_out,
                        &quot;PSK key given or JPAKE in use, setting client callback\n&quot;);
@@ -1303,14 +1210,15 @@ int MAIN(int argc, char **argv)
 #endif
 #ifndef OPENSSL_NO_SRTP
     if (srtp_profiles != NULL) {
-        /* Returns 0 on success!! */
-        if (SSL_CTX_set_tlsext_use_srtp(ctx, srtp_profiles)) {
+        /* Returns 0 on success! */
+        if (SSL_CTX_set_tlsext_use_srtp(ctx, srtp_profiles) != 0) {
             BIO_printf(bio_err, &quot;Error setting SRTP profile\n&quot;);
             ERR_print_errors(bio_err);
             goto end;
         }
     }
 #endif
+
     if (exc)
         ssl_ctx_set_excert(ctx, exc);
 
@@ -1327,22 +1235,23 @@ int MAIN(int argc, char **argv)
             BIO_printf(bio_err, &quot;Error parsing -alpn argument\n&quot;);
             goto end;
         }
-        /* Returns 0 on success!! */
-        if (SSL_CTX_set_alpn_protos(ctx, alpn, alpn_len)) {
-            BIO_printf(bio_err, &quot;Error setting ALPN\n&quot;);
+        /* Returns 0 on success! */
+        if (SSL_CTX_set_alpn_protos(ctx, alpn, alpn_len) != 0) {
+           BIO_printf(bio_err, &quot;Error setting ALPN\n&quot;);
             goto end;
         }
         OPENSSL_free(alpn);
     }
 #endif
 #ifndef OPENSSL_NO_TLSEXT
-    for (i = 0; i &lt; serverinfo_types_count; i++) {
+    for (i = 0; i &lt; serverinfo_count; i++) {
         if (!SSL_CTX_add_client_custom_ext(ctx,
-                                      serverinfo_types[i],
-                                      NULL, NULL, NULL,
-                                      serverinfo_cli_parse_cb, NULL)) {
-            BIO_printf(bio_err, &quot;Warning: Unable to add custom extension %u. &quot;
-                       &quot;Skipping\n&quot;, serverinfo_types[i]);
+                                           serverinfo_types[i],
+                                           NULL, NULL, NULL,
+                                           serverinfo_cli_parse_cb, NULL)) {
+            BIO_printf(bio_err,
+                    &quot;Warning: Unable to add custom extension %u, skipping\n&quot;,
+                    serverinfo_types[i]);
         }
     }
 #endif
@@ -1352,12 +1261,9 @@ int MAIN(int argc, char **argv)
 
     SSL_CTX_set_verify(ctx, verify, verify_callback);
 
-    if ((CAfile || CApath)
-        &amp;&amp; !SSL_CTX_load_verify_locations(ctx, CAfile, CApath)) {
-        ERR_print_errors(bio_err);
-    }
-    if (!SSL_CTX_set_default_verify_paths(ctx)) {
+    if (!ctx_set_verify_locations(ctx, CAfile, CApath)) {
         ERR_print_errors(bio_err);
+        goto end;
     }
 
     ssl_ctx_add_crls(ctx, crls, crl_download);
@@ -1429,6 +1335,8 @@ int MAIN(int argc, char **argv)
     if (con &amp;&amp; (kctx = kssl_ctx_new()) != NULL) {
         SSL_set0_kssl_ctx(con, kctx);
         kssl_ctx_setstring(kctx, KSSL_SERVER, host);
+        if (krb5svc)
+            kssl_ctx_setstring(kctx, KSSL_SERVICE, krb5svc);
     }
 #endif                          /* OPENSSL_NO_KRB5 */
 
@@ -1554,111 +1462,131 @@ int MAIN(int argc, char **argv)
     sbuf_len = 0;
     sbuf_off = 0;
 
-    /* This is an ugly hack that does a lot of assumptions */
-    /*
-     * We do have to handle multi-line responses which may come in a single
-     * packet or not. We therefore have to use BIO_gets() which does need a
-     * buffering BIO. So during the initial chitchat we do push a buffering
-     * BIO into the chain that is removed again later on to not disturb the
-     * rest of the s_client operation.
-     */
-    if (starttls_proto == PROTO_SMTP) {
-        int foundit = 0;
-        BIO *fbio = BIO_new(BIO_f_buffer());
-        BIO_push(fbio, sbio);
-        /* wait for multi-line response to end from SMTP */
-        do {
-            mbuf_len = BIO_gets(fbio, mbuf, BUFSIZZ);
+    switch ((PROTOCOL_CHOICE) starttls_proto) {
+    case PROTO_OFF:
+        break;
+    case PROTO_SMTP:
+        {
+            /*
+             * This is an ugly hack that does a lot of assumptions. We do
+             * have to handle multi-line responses which may come in a single
+             * packet or not. We therefore have to use BIO_gets() which does
+             * need a buffering BIO. So during the initial chitchat we do
+             * push a buffering BIO into the chain that is removed again
+             * later on to not disturb the rest of the s_client operation.
+             */
+            int foundit = 0;
+            BIO *fbio = BIO_new(BIO_f_buffer());
+            BIO_push(fbio, sbio);
+            /* wait for multi-line response to end from SMTP */
+            do {
+                mbuf_len = BIO_gets(fbio, mbuf, BUFSIZZ);
+            }
+            while (mbuf_len &gt; 3 &amp;&amp; mbuf[3] == '-');
+            BIO_printf(fbio, &quot;EHLO openssl.client.net\r\n&quot;);
+            (void)BIO_flush(fbio);
+            /* wait for multi-line response to end EHLO SMTP response */
+            do {
+                mbuf_len = BIO_gets(fbio, mbuf, BUFSIZZ);
+                if (strstr(mbuf, &quot;STARTTLS&quot;))
+                    foundit = 1;
+            }
+            while (mbuf_len &gt; 3 &amp;&amp; mbuf[3] == '-');
+            (void)BIO_flush(fbio);
+            BIO_pop(fbio);
+            BIO_free(fbio);
+            if (!foundit)
+                BIO_printf(bio_err,
+                           &quot;didn't found starttls in server response,&quot;
+                           &quot; try anyway...\n&quot;);
+            BIO_printf(sbio, &quot;STARTTLS\r\n&quot;);
+            BIO_read(sbio, sbuf, BUFSIZZ);
         }
-        while (mbuf_len &gt; 3 &amp;&amp; mbuf[3] == '-');
-        /* STARTTLS command requires EHLO... */
-        BIO_printf(fbio, &quot;EHLO openssl.client.net\r\n&quot;);
-        (void)BIO_flush(fbio);
-        /* wait for multi-line response to end EHLO SMTP response */
-        do {
-            mbuf_len = BIO_gets(fbio, mbuf, BUFSIZZ);
-            if (strstr(mbuf, &quot;STARTTLS&quot;))
-                foundit = 1;
+        break;
+    case PROTO_POP3:
+        {
+            BIO_read(sbio, mbuf, BUFSIZZ);
+            BIO_printf(sbio, &quot;STLS\r\n&quot;);
+            mbuf_len = BIO_read(sbio, sbuf, BUFSIZZ);
+            if (mbuf_len &lt; 0) {
+                BIO_printf(bio_err, &quot;BIO_read failed\n&quot;);
+                goto end;
+            }
         }
-        while (mbuf_len &gt; 3 &amp;&amp; mbuf[3] == '-');
-        (void)BIO_flush(fbio);
-        BIO_pop(fbio);
-        BIO_free(fbio);
-        if (!foundit)
-            BIO_printf(bio_err,
-                       &quot;didn't found starttls in server response,&quot;
-                       &quot; try anyway...\n&quot;);
-        BIO_printf(sbio, &quot;STARTTLS\r\n&quot;);
-        BIO_read(sbio, sbuf, BUFSIZZ);
-    } else if (starttls_proto == PROTO_POP3) {
-        BIO_read(sbio, mbuf, BUFSIZZ);
-        BIO_printf(sbio, &quot;STLS\r\n&quot;);
-        BIO_read(sbio, sbuf, BUFSIZZ);
-    } else if (starttls_proto == PROTO_IMAP) {
-        int foundit = 0;
-        BIO *fbio = BIO_new(BIO_f_buffer());
-        BIO_push(fbio, sbio);
-        BIO_gets(fbio, mbuf, BUFSIZZ);
-        /* STARTTLS command requires CAPABILITY... */
-        BIO_printf(fbio, &quot;. CAPABILITY\r\n&quot;);
-        (void)BIO_flush(fbio);
-        /* wait for multi-line CAPABILITY response */
-        do {
-            mbuf_len = BIO_gets(fbio, mbuf, BUFSIZZ);
-            if (strstr(mbuf, &quot;STARTTLS&quot;))
-                foundit = 1;
+        break;
+    case PROTO_IMAP:
+        {
+            int foundit = 0;
+            BIO *fbio = BIO_new(BIO_f_buffer());
+            BIO_push(fbio, sbio);
+            BIO_gets(fbio, mbuf, BUFSIZZ);
+            /* STARTTLS command requires CAPABILITY... */
+            BIO_printf(fbio, &quot;. CAPABILITY\r\n&quot;);
+            (void)BIO_flush(fbio);
+            /* wait for multi-line CAPABILITY response */
+            do {
+                mbuf_len = BIO_gets(fbio, mbuf, BUFSIZZ);
+                if (strstr(mbuf, &quot;STARTTLS&quot;))
+                    foundit = 1;
+            }
+            while (mbuf_len &gt; 3 &amp;&amp; mbuf[0] != '.');
+            (void)BIO_flush(fbio);
+            BIO_pop(fbio);
+            BIO_free(fbio);
+            if (!foundit)
+                BIO_printf(bio_err,
+                           &quot;didn't found STARTTLS in server response,&quot;
+                           &quot; try anyway...\n&quot;);
+            BIO_printf(sbio, &quot;. STARTTLS\r\n&quot;);
+            BIO_read(sbio, sbuf, BUFSIZZ);
         }
-        while (mbuf_len &gt; 3 &amp;&amp; mbuf[0] != '.');
-        (void)BIO_flush(fbio);
-        BIO_pop(fbio);
-        BIO_free(fbio);
-        if (!foundit)
-            BIO_printf(bio_err,
-                       &quot;didn't found STARTTLS in server response,&quot;
-                       &quot; try anyway...\n&quot;);
-        BIO_printf(sbio, &quot;. STARTTLS\r\n&quot;);
-        BIO_read(sbio, sbuf, BUFSIZZ);
-    } else if (starttls_proto == PROTO_FTP) {
-        BIO *fbio = BIO_new(BIO_f_buffer());
-        BIO_push(fbio, sbio);
-        /* wait for multi-line response to end from FTP */
-        do {
-            mbuf_len = BIO_gets(fbio, mbuf, BUFSIZZ);
+        break;
+    case PROTO_FTP:
+        {
+            BIO *fbio = BIO_new(BIO_f_buffer());
+            BIO_push(fbio, sbio);
+            /* wait for multi-line response to end from FTP */
+            do {
+                mbuf_len = BIO_gets(fbio, mbuf, BUFSIZZ);
+            }
+            while (mbuf_len &gt; 3 &amp;&amp; mbuf[3] == '-');
+            (void)BIO_flush(fbio);
+            BIO_pop(fbio);
+            BIO_free(fbio);
+            BIO_printf(sbio, &quot;AUTH TLS\r\n&quot;);
+            BIO_read(sbio, sbuf, BUFSIZZ);
         }
-        while (mbuf_len &gt; 3 &amp;&amp; mbuf[3] == '-');
-        (void)BIO_flush(fbio);
-        BIO_pop(fbio);
-        BIO_free(fbio);
-        BIO_printf(sbio, &quot;AUTH TLS\r\n&quot;);
-        BIO_read(sbio, sbuf, BUFSIZZ);
-    }
-    if (starttls_proto == PROTO_XMPP) {
-        int seen = 0;
-        BIO_printf(sbio, &quot;&lt;stream:stream &quot;
-                   &quot;xmlns:stream='<A HREF="http://etherx.jabber.org/streams">http://etherx.jabber.org/streams</A>' &quot;
-                   &quot;xmlns='jabber:client' to='%s' version='1.0'&gt;&quot;, xmpphost ?
-                   xmpphost : host);
-        seen = BIO_read(sbio, mbuf, BUFSIZZ);
-        mbuf[seen] = 0;
-        while (!strstr
-               (mbuf, &quot;&lt;starttls xmlns='urn:ietf:params:xml:ns:xmpp-tls'&quot;)
-               &amp;&amp; !strstr(mbuf,
-                          &quot;&lt;starttls xmlns=\&quot;urn:ietf:params:xml:ns:xmpp-tls\&quot;&quot;))
+        break;
+    case PROTO_XMPP:
         {
+            int seen = 0;
+            BIO_printf(sbio, &quot;&lt;stream:stream &quot;
+                       &quot;xmlns:stream='<A HREF="http://etherx.jabber.org/streams">http://etherx.jabber.org/streams</A>' &quot;
+                       &quot;xmlns='jabber:client' to='%s' version='1.0'&gt;&quot;,
+                       host);
             seen = BIO_read(sbio, mbuf, BUFSIZZ);
+            mbuf[seen] = 0;
+            while (!strstr
+                   (mbuf, &quot;&lt;starttls xmlns='urn:ietf:params:xml:ns:xmpp-tls'&quot;)
+                   &amp;&amp; !strstr(mbuf,
+                              &quot;&lt;starttls xmlns=\&quot;urn:ietf:params:xml:ns:xmpp-tls\&quot;&quot;))
+            {
+                seen = BIO_read(sbio, mbuf, BUFSIZZ);
 
-            if (seen &lt;= 0)
-                goto shut;
+                if (seen &lt;= 0)
+                    goto shut;
 
-            mbuf[seen] = 0;
+                mbuf[seen] = 0;
+            }
+            BIO_printf(sbio,
+                       &quot;&lt;starttls xmlns='urn:ietf:params:xml:ns:xmpp-tls'/&gt;&quot;);
+            seen = BIO_read(sbio, sbuf, BUFSIZZ);
+            sbuf[seen] = 0;
+            if (!strstr(sbuf, &quot;&lt;proceed&quot;))
+                goto shut;
+            mbuf[0] = 0;
         }
-        BIO_printf(sbio,
-                   &quot;&lt;starttls xmlns='urn:ietf:params:xml:ns:xmpp-tls'/&gt;&quot;);
-        seen = BIO_read(sbio, sbuf, BUFSIZZ);
-        sbuf[seen] = 0;
-        if (!strstr(sbuf, &quot;&lt;proceed&quot;))
-            goto shut;
-        mbuf[0] = 0;
+        break;
     }
 
     for (;;) {
@@ -1678,6 +1606,13 @@ int MAIN(int argc, char **argv)
             tty_on = 1;
             if (in_init) {
                 in_init = 0;
+#ifndef OPENSSL_NO_TLSEXT
+                if (servername != NULL &amp;&amp; !SSL_session_reused(con)) {
+                    BIO_printf(bio_c_out,
+                               &quot;Server did %sacknowledge servername extension.\n&quot;,
+                               tlsextcbp.ack ? &quot;&quot; : &quot;not &quot;);
+                }
+#endif
                 if (sess_out) {
                     BIO *stmp = BIO_new_file(sess_out, &quot;w&quot;);
                     if (stmp) {
@@ -1697,9 +1632,10 @@ int MAIN(int argc, char **argv)
                     full_log--;
 
                 if (starttls_proto) {
-                    BIO_printf(bio_err, &quot;%s&quot;, mbuf);
+                    BIO_write(bio_err, mbuf, mbuf_len);
                     /* We don't need to know any more */
-                    starttls_proto = PROTO_OFF;
+                    if (!reconnect)
+                        starttls_proto = PROTO_OFF;
                 }
 
                 if (reconnect) {
@@ -1736,8 +1672,6 @@ int MAIN(int argc, char **argv)
                     openssl_fdset(SSL_get_fd(con), &amp;writefds);
             }
 #endif
-/*-         printf(&quot;mode tty(%d %d%d) ssl(%d%d)\n&quot;,
-                    tty_on,read_tty,write_tty,read_ssl,write_ssl);*/
 
             /*
              * Note: under VMS with SOCKETSHR the second parameter is
@@ -2037,8 +1971,7 @@ int MAIN(int argc, char **argv)
     if (vpm)
         X509_VERIFY_PARAM_free(vpm);
     ssl_excert_free(exc);
-    if (ssl_args)
-        sk_OPENSSL_STRING_free(ssl_args);
+    sk_OPENSSL_STRING_free(ssl_args);
     SSL_CONF_CTX_free(cctx);
 #ifndef OPENSSL_NO_JPAKE
     if (jpake_secret &amp;&amp; psk_key)
@@ -2060,8 +1993,7 @@ int MAIN(int argc, char **argv)
     bio_c_out = NULL;
     BIO_free(bio_c_msg);
     bio_c_msg = NULL;
-    apps_shutdown();
-    OPENSSL_EXIT(ret);
+    return (ret);
 }
 
 static void print_stuff(BIO *bio, SSL *s, int full)
@@ -2083,7 +2015,7 @@ static void print_stuff(BIO *bio, SSL *s, int full)
 
         sk = SSL_get_peer_cert_chain(s);
         if (sk != NULL) {
-            got_a_chain = 1;    /* we don't have it for SSL2 (yet) */
+            got_a_chain = 1;
 
             BIO_printf(bio, &quot;---\nCertificate chain\n&quot;);
             for (i = 0; i &lt; sk_X509_num(sk); i++) {
diff --git a/apps/s_server.c b/apps/s_server.c
index 8e350c8..2aaa2cb 100644
--- a/apps/s_server.c
+++ b/apps/s_server.c
@@ -1,4 +1,3 @@
-/* apps/s_server.c */
 /* Copyright (C) 1995-1998 Eric Young (<A HREF="../../../mailman/listinfo/openssl-commits.html">eay at cryptsoft.com</A>)
  * All rights reserved.
  *
@@ -199,7 +198,6 @@ static int sv_body(char *hostname, int s, int stype, unsigned char *context);
 static int www_body(char *hostname, int s, int stype, unsigned char *context);
 static int rev_body(char *hostname, int s, int stype, unsigned char *context);
 static void close_accept_socket(void);
-static void sv_usage(void);
 static int init_ssl_connection(SSL *s);
 static void print_stats(BIO *bp, SSL_CTX *ctx);
 static int generate_session_id(const SSL *ssl, unsigned char *id,
@@ -210,9 +208,7 @@ static void free_sessions(void);
 static DH *load_dh_param(const char *dhfile);
 #endif
 
-#ifdef MONOLITH
 static void s_server_init(void);
-#endif
 
 /* static int load_CA(SSL_CTX *ctx, char *file);*/
 
@@ -225,8 +221,6 @@ static int accept_socket = -1;
 #ifndef OPENSSL_NO_TLSEXT
 # define TEST_CERT2      &quot;server2.pem&quot;
 #endif
-#undef PROG
-#define PROG            s_server_main
 
 extern int verify_depth, verify_return_error, verify_quiet;
 
@@ -394,10 +388,10 @@ static int ssl_srp_server_param_cb(SSL *s, int *ad, void *arg)
 
 #endif
 
-#ifdef MONOLITH
 static void s_server_init(void)
 {
     accept_socket = -1;
+    verify_depth = 0;
     s_server_verify = SSL_VERIFY_NONE;
     s_dcert_file = NULL;
     s_dkey_file = NULL;
@@ -405,208 +399,23 @@ static void s_server_init(void)
     s_cert_file = TEST_CERT;
     s_key_file = NULL;
     s_chain_file = NULL;
-# ifndef OPENSSL_NO_TLSEXT
+#ifndef OPENSSL_NO_TLSEXT
     s_cert_file2 = TEST_CERT2;
     s_key_file2 = NULL;
     ctx2 = NULL;
-# endif
-# ifdef FIONBIO
+#endif
     s_nbio = 0;
-# endif
     s_nbio_test = 0;
     ctx = NULL;
     www = 0;
-
     bio_s_out = NULL;
     s_debug = 0;
     s_msg = 0;
     s_quiet = 0;
     s_brief = 0;
-# ifndef OPENSSL_NO_ENGINE
-    engine_id = NULL;
-# endif
-}
-#endif
-
-static void sv_usage(void)
-{
-    BIO_printf(bio_err, &quot;usage: s_server [args ...]\n&quot;);
-    BIO_printf(bio_err, &quot;\n&quot;);
-    BIO_printf(bio_err,
-               &quot; -accept port  - TCP/IP port to accept on (default is %d)\n&quot;,
-               PORT);
-    BIO_printf(bio_err, &quot; -unix path    - unix domain socket to accept on\n&quot;);
-    BIO_printf(bio_err,
-               &quot; -unlink       - for -unix, unlink existing socket first\n&quot;);
-    BIO_printf(bio_err, &quot; -context arg  - set session ID context\n&quot;);
-    BIO_printf(bio_err,
-               &quot; -verify arg   - turn on peer certificate verification\n&quot;);
-    BIO_printf(bio_err,
-               &quot; -Verify arg   - turn on peer certificate verification, must have a cert.\n&quot;);
-    BIO_printf(bio_err,
-               &quot; -verify_return_error - return verification errors\n&quot;);
-    BIO_printf(bio_err, &quot; -cert arg     - certificate file to use\n&quot;);
-    BIO_printf(bio_err, &quot;                 (default is %s)\n&quot;, TEST_CERT);
-    BIO_printf(bio_err,
-               &quot; -naccept arg  - terminate after 'arg' connections\n&quot;);
-#ifndef OPENSSL_NO_TLSEXT
-    BIO_printf(bio_err,
-               &quot; -serverinfo arg - PEM serverinfo file for certificate\n&quot;);
-#endif
-    BIO_printf(bio_err,
-               &quot; -no_resumption_on_reneg - set SSL_OP_NO_SESSION_RESUMPTION_ON_RENEGOTIATION flag\n&quot;);
-    BIO_printf(bio_err,
-               &quot; -crl_check    - check the peer certificate has not been revoked by its CA.\n&quot;
-               &quot;                 The CRL(s) are appended to the certificate file\n&quot;);
-    BIO_printf(bio_err,
-               &quot; -crl_check_all - check the peer certificate has not been revoked by its CA\n&quot;
-               &quot;                 or any other CRL in the CA chain. CRL(s) are appened to the\n&quot;
-               &quot;                 the certificate file.\n&quot;);
-    BIO_printf(bio_err,
-               &quot; -certform arg - certificate format (PEM or DER) PEM default\n&quot;);
-    BIO_printf(bio_err,
-               &quot; -key arg      - Private Key file to use, in cert file if\n&quot;);
-    BIO_printf(bio_err, &quot;                 not specified (default is %s)\n&quot;,
-               TEST_CERT);
-    BIO_printf(bio_err,
-               &quot; -keyform arg  - key format (PEM, DER or ENGINE) PEM default\n&quot;);
-    BIO_printf(bio_err,
-               &quot; -pass arg     - private key file pass phrase source\n&quot;);
-    BIO_printf(bio_err,
-               &quot; -dcert arg    - second certificate file to use (usually for DSA)\n&quot;);
-    BIO_printf(bio_err,
-               &quot; -dcertform x  - second certificate format (PEM or DER) PEM default\n&quot;);
-    BIO_printf(bio_err,
-               &quot; -dkey arg     - second private key file to use (usually for DSA)\n&quot;);
-    BIO_printf(bio_err,
-               &quot; -dkeyform arg - second key format (PEM, DER or ENGINE) PEM default\n&quot;);
-    BIO_printf(bio_err,
-               &quot; -dpass arg    - second private key file pass phrase source\n&quot;);
-    BIO_printf(bio_err,
-               &quot; -dhparam arg  - DH parameter file to use, in cert file if not specified\n&quot;);
-    BIO_printf(bio_err,
-               &quot;                 or a default set of parameters is used\n&quot;);
-#ifndef OPENSSL_NO_EC
-    BIO_printf(bio_err,
-               &quot; -named_curve arg  - Elliptic curve name to use for ephemeral ECDH keys.\n&quot;
-               &quot;                 Use \&quot;openssl ecparam -list_curves\&quot; for all names\n&quot;
-               &quot;                 (default is nistp256).\n&quot;);
-#endif
-#ifdef FIONBIO
-    BIO_printf(bio_err, &quot; -nbio         - Run with non-blocking IO\n&quot;);
-#endif
-    BIO_printf(bio_err,
-               &quot; -nbio_test    - test with the non-blocking test bio\n&quot;);
-    BIO_printf(bio_err,
-               &quot; -crlf         - convert LF from terminal into CRLF\n&quot;);
-    BIO_printf(bio_err, &quot; -debug        - Print more output\n&quot;);
-    BIO_printf(bio_err, &quot; -msg          - Show protocol messages\n&quot;);
-    BIO_printf(bio_err, &quot; -state        - Print the SSL states\n&quot;);
-    BIO_printf(bio_err, &quot; -CApath arg   - PEM format directory of CA's\n&quot;);
-    BIO_printf(bio_err, &quot; -CAfile arg   - PEM format file of CA's\n&quot;);
-    BIO_printf(bio_err,
-               &quot; -trusted_first - Use locally trusted CA's first when building trust chain\n&quot;);
-    BIO_printf(bio_err,
-               &quot; -no_alt_chains - only ever use the first certificate chain found\n&quot;);
-    BIO_printf(bio_err,
-               &quot; -nocert       - Don't use any certificates (Anon-DH)\n&quot;);
-    BIO_printf(bio_err,
-               &quot; -cipher arg   - play with 'openssl ciphers' to see what goes here\n&quot;);
-    BIO_printf(bio_err, &quot; -serverpref   - Use server's cipher preferences\n&quot;);
-    BIO_printf(bio_err, &quot; -quiet        - No server output\n&quot;);
-    BIO_printf(bio_err, &quot; -no_tmp_rsa   - Do not generate a tmp RSA key\n&quot;);
-#ifndef OPENSSL_NO_PSK
-    BIO_printf(bio_err, &quot; -psk_hint arg - PSK identity hint to use\n&quot;);
-    BIO_printf(bio_err, &quot; -psk arg      - PSK in hex (without 0x)\n&quot;);
-# ifndef OPENSSL_NO_JPAKE
-    BIO_printf(bio_err, &quot; -jpake arg    - JPAKE secret to use\n&quot;);
-# endif
-#endif
-#ifndef OPENSSL_NO_SRP
-    BIO_printf(bio_err, &quot; -srpvfile file      - The verifier file for SRP\n&quot;);
-    BIO_printf(bio_err,
-               &quot; -srpuserseed string - A seed string for a default user salt.\n&quot;);
-#endif
-#ifndef OPENSSL_NO_SSL3_METHOD
-    BIO_printf(bio_err, &quot; -ssl3         - Just talk SSLv3\n&quot;);
-#endif
-    BIO_printf(bio_err, &quot; -tls1_2       - Just talk TLSv1.2\n&quot;);
-    BIO_printf(bio_err, &quot; -tls1_1       - Just talk TLSv1.1\n&quot;);
-    BIO_printf(bio_err, &quot; -tls1         - Just talk TLSv1\n&quot;);
-    BIO_printf(bio_err, &quot; -dtls1        - Just talk DTLSv1\n&quot;);
-    BIO_printf(bio_err, &quot; -dtls1_2      - Just talk DTLSv1.2\n&quot;);
-    BIO_printf(bio_err, &quot; -timeout      - Enable timeouts\n&quot;);
-    BIO_printf(bio_err, &quot; -mtu          - Set link layer MTU\n&quot;);
-    BIO_printf(bio_err, &quot; -chain        - Read a certificate chain\n&quot;);
-    BIO_printf(bio_err, &quot; -no_ssl3      - Just disable SSLv3\n&quot;);
-    BIO_printf(bio_err, &quot; -no_tls1      - Just disable TLSv1\n&quot;);
-    BIO_printf(bio_err, &quot; -no_tls1_1    - Just disable TLSv1.1\n&quot;);
-    BIO_printf(bio_err, &quot; -no_tls1_2    - Just disable TLSv1.2\n&quot;);
-#ifndef OPENSSL_NO_DH
-    BIO_printf(bio_err, &quot; -no_dhe       - Disable ephemeral DH\n&quot;);
-#endif
-#ifndef OPENSSL_NO_EC
-    BIO_printf(bio_err, &quot; -no_ecdhe     - Disable ephemeral ECDH\n&quot;);
-#endif
-    BIO_printf(bio_err,
-               &quot;-no_resume_ephemeral - Disable caching and tickets if ephemeral (EC)DH is used\n&quot;);
-    BIO_printf(bio_err, &quot; -bugs         - Turn on SSL bug compatibility\n&quot;);
-    BIO_printf(bio_err,
-               &quot; -www          - Respond to a 'GET /' with a status page\n&quot;);
-    BIO_printf(bio_err,
-               &quot; -WWW          - Respond to a 'GET /&lt;path&gt; HTTP/1.0' with file ./&lt;path&gt;\n&quot;);
-    BIO_printf(bio_err,
-               &quot; -HTTP         - Respond to a 'GET /&lt;path&gt; HTTP/1.0' with file ./&lt;path&gt;\n&quot;);
-    BIO_printf(bio_err,
-               &quot;                 with the assumption it contains a complete HTTP response.\n&quot;);
 #ifndef OPENSSL_NO_ENGINE
-    BIO_printf(bio_err,
-               &quot; -engine id    - Initialise and use the specified engine\n&quot;);
-#endif
-    BIO_printf(bio_err,
-               &quot; -id_prefix arg - Generate SSL/TLS session IDs prefixed by 'arg'\n&quot;);
-    BIO_printf(bio_err, &quot; -rand file%cfile%c...\n&quot;, LIST_SEPARATOR_CHAR,
-               LIST_SEPARATOR_CHAR);
-#ifndef OPENSSL_NO_TLSEXT
-    BIO_printf(bio_err,
-               &quot; -servername host - servername for HostName TLS extension\n&quot;);
-    BIO_printf(bio_err,
-               &quot; -servername_fatal - on mismatch send fatal alert (default warning alert)\n&quot;);
-    BIO_printf(bio_err,
-               &quot; -cert2 arg    - certificate file to use for servername\n&quot;);
-    BIO_printf(bio_err, &quot;                 (default is %s)\n&quot;, TEST_CERT2);
-    BIO_printf(bio_err,
-               &quot; -key2 arg     - Private Key file to use for servername, in cert file if\n&quot;);
-    BIO_printf(bio_err, &quot;                 not specified (default is %s)\n&quot;,
-               TEST_CERT2);
-    BIO_printf(bio_err,
-               &quot; -tlsextdebug  - hex dump of all TLS extensions received\n&quot;);
-    BIO_printf(bio_err,
-               &quot; -no_ticket    - disable use of RFC4507bis session tickets\n&quot;);
-    BIO_printf(bio_err,
-               &quot; -legacy_renegotiation - enable use of legacy renegotiation (dangerous)\n&quot;);
-# ifndef OPENSSL_NO_NEXTPROTONEG
-    BIO_printf(bio_err,
-               &quot; -nextprotoneg arg - set the advertised protocols for the NPN extension (comma-separated list)\n&quot;);
-# endif
-# ifndef OPENSSL_NO_SRTP
-    BIO_printf(bio_err,
-               &quot; -use_srtp profiles - Offer SRTP key management with a colon-separated profile list\n&quot;);
-# endif
-    BIO_printf(bio_err,
-               &quot; -alpn arg  - set the advertised protocols for the ALPN extension (comma-separated list)\n&quot;);
+    engine_id = NULL;
 #endif
-    BIO_printf(bio_err,
-               &quot; -keymatexport label   - Export keying material using label\n&quot;);
-    BIO_printf(bio_err,
-               &quot; -keymatexportlen len  - Export len bytes of keying material (default 20)\n&quot;);
-    BIO_printf(bio_err,
-               &quot; -status           - respond to certificate status requests\n&quot;);
-    BIO_printf(bio_err,
-               &quot; -status_verbose   - enable status request verbose printout\n&quot;);
-    BIO_printf(bio_err,
-               &quot; -status_timeout n - status request responder timeout\n&quot;);
-    BIO_printf(bio_err, &quot; -status_url URL   - status request fallback URL\n&quot;);
 }
 
 static int local_argc = 0;
@@ -705,8 +514,7 @@ static int ebcdic_write(BIO *b, const char *in, int inl)
         num = num + num;        /* double the size */
         if (num &lt; inl)
             num = inl;
-        wbuf =
-            (EBCDIC_OUTBUFF *) OPENSSL_malloc(sizeof(EBCDIC_OUTBUFF) + num);
+        wbuf = (EBCDIC_OUTBUFF *) OPENSSL_malloc(sizeof(EBCDIC_OUTBUFF) + num);
         if (!wbuf)
             return 0;
         OPENSSL_free(b-&gt;ptr);
@@ -807,11 +615,10 @@ typedef struct tlsextstatusctx_st {
     char *host, *path, *port;
     int use_ssl;
     int timeout;
-    BIO *err;
     int verbose;
 } tlsextstatusctx;
 
-static tlsextstatusctx tlscstatp = { NULL, NULL, NULL, 0, -1, NULL, 0 };
+static tlsextstatusctx tlscstatp = { NULL, NULL, NULL, 0, -1, 0 };
 
 /*
  * Certificate Status callback. This is called when a client includes a
@@ -825,7 +632,6 @@ static tlsextstatusctx tlscstatp = { NULL, NULL, NULL, 0, -1, NULL, 0 };
 static int cert_status_cb(SSL *s, void *arg)
 {
     tlsextstatusctx *srctx = arg;
-    BIO *err = srctx-&gt;err;
     char *host, *port, *path;
     int use_ssl;
     unsigned char *rspder = NULL;
@@ -840,23 +646,24 @@ static int cert_status_cb(SSL *s, void *arg)
     STACK_OF(X509_EXTENSION) *exts;
     int ret = SSL_TLSEXT_ERR_NOACK;
     int i;
+
     if (srctx-&gt;verbose)
-        BIO_puts(err, &quot;cert_status: callback called\n&quot;);
+        BIO_puts(bio_err, &quot;cert_status: callback called\n&quot;);
     /* Build up OCSP query from server certificate */
     x = SSL_get_certificate(s);
     aia = X509_get1_ocsp(x);
     if (aia) {
         if (!OCSP_parse_url(sk_OPENSSL_STRING_value(aia, 0),
                             &amp;host, &amp;port, &amp;path, &amp;use_ssl)) {
-            BIO_puts(err, &quot;cert_status: can't parse AIA URL\n&quot;);
+            BIO_puts(bio_err, &quot;cert_status: can't parse AIA URL\n&quot;);
             goto err;
         }
         if (srctx-&gt;verbose)
-            BIO_printf(err, &quot;cert_status: AIA URL: %s\n&quot;,
+            BIO_printf(bio_err, &quot;cert_status: AIA URL: %s\n&quot;,
                        sk_OPENSSL_STRING_value(aia, 0));
     } else {
         if (!srctx-&gt;host) {
-            BIO_puts(srctx-&gt;err,
+            BIO_puts(bio_err,
                      &quot;cert_status: no AIA and no default responder URL\n&quot;);
             goto done;
         }
@@ -872,7 +679,7 @@ static int cert_status_cb(SSL *s, void *arg)
         goto err;
     if (X509_STORE_get_by_subject(&amp;inctx, X509_LU_X509,
                                   X509_get_issuer_name(x), &amp;obj) &lt;= 0) {
-        BIO_puts(err, &quot;cert_status: Can't retrieve issuer certificate.\n&quot;);
+        BIO_puts(bio_err, &quot;cert_status: Can't retrieve issuer certificate.\n&quot;);
         X509_STORE_CTX_cleanup(&amp;inctx);
         goto done;
     }
@@ -894,10 +701,10 @@ static int cert_status_cb(SSL *s, void *arg)
         if (!OCSP_REQUEST_add_ext(req, ext, -1))
             goto err;
     }
-    resp = process_responder(err, req, host, path, port, use_ssl, NULL,
+    resp = process_responder(req, host, path, port, use_ssl, NULL,
                              srctx-&gt;timeout);
     if (!resp) {
-        BIO_puts(err, &quot;cert_status: error querying responder\n&quot;);
+        BIO_puts(bio_err, &quot;cert_status: error querying responder\n&quot;);
         goto done;
     }
     rspderlen = i2d_OCSP_RESPONSE(resp, &amp;rspder);
@@ -905,13 +712,13 @@ static int cert_status_cb(SSL *s, void *arg)
         goto err;
     SSL_set_tlsext_status_ocsp_resp(s, rspder, rspderlen);
     if (srctx-&gt;verbose) {
-        BIO_puts(err, &quot;cert_status: ocsp response sent:\n&quot;);
-        OCSP_RESPONSE_print(err, resp, 2);
+        BIO_puts(bio_err, &quot;cert_status: ocsp response sent:\n&quot;);
+        OCSP_RESPONSE_print(bio_err, resp, 2);
     }
     ret = SSL_TLSEXT_ERR_OK;
  done:
     if (ret != SSL_TLSEXT_ERR_OK)
-        ERR_print_errors(err);
+        ERR_print_errors(bio_err);
     if (aia) {
         OPENSSL_free(host);
         OPENSSL_free(path);
@@ -995,14 +802,7 @@ static int not_resumable_sess_cb(SSL *s, int is_forward_secure)
     return is_forward_secure;
 }
 
-int MAIN(int, char **);
-
-#ifndef OPENSSL_NO_JPAKE
 static char *jpake_secret = NULL;
-# define no_jpake !jpake_secret
-#else
-# define no_jpake 1
-#endif
 #ifndef OPENSSL_NO_SRP
 static srpsrvparm srp_callback_parm;
 #endif
@@ -1010,41 +810,214 @@ static srpsrvparm srp_callback_parm;
 static char *srtp_profiles = NULL;
 #endif
 
-int MAIN(int argc, char *argv[])
+typedef enum OPTION_choice {
+    OPT_ERR = -1, OPT_EOF = 0, OPT_HELP,
+    OPT_ENGINE, OPT_PORT, OPT_UNIX, OPT_UNLINK, OPT_NACCEPT,
+    OPT_VERIFY, OPT_UPPER_V_VERIFY, OPT_CONTEXT, OPT_CERT, OPT_CRL,
+    OPT_CRL_DOWNLOAD, OPT_SERVERINFO, OPT_CERTFORM, OPT_KEY, OPT_KEYFORM,
+    OPT_PASS, OPT_CERT_CHAIN, OPT_DHPARAM, OPT_DCERTFORM, OPT_DCERT,
+    OPT_DKEYFORM, OPT_DPASS, OPT_DKEY, OPT_DCERT_CHAIN, OPT_NOCERT,
+    OPT_CAPATH, OPT_CHAINCAPATH, OPT_VERIFYCAPATH, OPT_NO_CACHE,
+    OPT_EXT_CACHE, OPT_CRLFORM, OPT_VERIFY_RET_ERROR, OPT_VERIFY_QUIET,
+    OPT_BUILD_CHAIN, OPT_CAFILE, OPT_CHAINCAFILE, OPT_VERIFYCAFILE,
+    OPT_NBIO, OPT_NBIO_TEST, OPT_IGN_EOF, OPT_NO_IGN_EOF, OPT_DEBUG,
+    OPT_TLSEXTDEBUG, OPT_STATUS, OPT_STATUS_VERBOSE, OPT_STATUS_TIMEOUT,
+    OPT_STATUS_URL, OPT_MSG, OPT_MSGFILE, OPT_TRACE, OPT_SECURITY_DEBUG,
+    OPT_SECURITY_DEBUG_VERBOSE, OPT_STATE, OPT_CRLF, OPT_QUIET,
+    OPT_BRIEF, OPT_NO_TMP_RSA, OPT_NO_DHE, OPT_NO_ECDHE,
+    OPT_NO_RESUME_EPHEMERAL, OPT_PSK_HINT, OPT_PSK, OPT_SRPVFILE,
+    OPT_SRPUSERSEED, OPT_REV, OPT_WWW, OPT_UPPER_WWW, OPT_HTTP,
+#ifndef OPENSSL_NO_SSL3
+    OPT_SSL3,
+#endif
+    OPT_TLS1_2, OPT_TLS1_1, OPT_TLS1, OPT_DTLS, OPT_DTLS1,
+    OPT_DTLS1_2, OPT_TIMEOUT, OPT_MTU, OPT_CHAIN,
+    OPT_ID_PREFIX, OPT_RAND, OPT_SERVERNAME, OPT_SERVERNAME_FATAL,
+    OPT_CERT2, OPT_KEY2, OPT_NEXTPROTONEG, OPT_ALPN, OPT_JPAKE,
+    OPT_SRTP_PROFILES, OPT_KEYMATEXPORT, OPT_KEYMATEXPORTLEN,
+    OPT_S_ENUM,
+    OPT_V_ENUM,
+    OPT_X_ENUM
+} OPTION_CHOICE;
+
+OPTIONS s_server_options[] = {
+    {&quot;help&quot;, OPT_HELP, '-', &quot;Display this summary&quot;},
+
+    {&quot;port&quot;, OPT_PORT, 'p'},
+    {&quot;accept&quot;, OPT_PORT, 'p',
+     &quot;TCP/IP port to accept on (default is &quot; PORT_STR &quot;)&quot;},
+    {&quot;unix&quot;, OPT_UNIX, 's', &quot;Unix domain socket to accept on&quot;},
+    {&quot;unlink&quot;, OPT_UNLINK, '-', &quot;For -unix, unlink existing socket first&quot;},
+    {&quot;context&quot;, OPT_CONTEXT, 's', &quot;Set session ID context&quot;},
+    {&quot;verify&quot;, OPT_VERIFY, 'n', &quot;Turn on peer certificate verification&quot;},
+    {&quot;Verify&quot;, OPT_UPPER_V_VERIFY, 'n',
+     &quot;Turn on peer certificate verification, must have a cert&quot;},
+    {&quot;cert&quot;, OPT_CERT, '&lt;', &quot;Certificate file to use; default is &quot; TEST_CERT},
+    {&quot;naccept&quot;, OPT_NACCEPT, 'p', &quot;Terminate after pnum connections&quot;},
+#ifndef OPENSSL_NO_TLSEXT
+    {&quot;serverinfo&quot;, OPT_SERVERINFO, 's',
+     &quot;PEM serverinfo file for certificate&quot;},
+#endif
+    {&quot;certform&quot;, OPT_CERTFORM, 'F',
+     &quot;Certificate format (PEM or DER) PEM default&quot;},
+    {&quot;key&quot;, OPT_KEY, '&lt;',
+     &quot;Private Key if not in -cert; default is &quot; TEST_CERT},
+    {&quot;keyform&quot;, OPT_KEYFORM, 'f',
+     &quot;Key format (PEM, DER or ENGINE) PEM default&quot;},
+    {&quot;pass&quot;, OPT_PASS, 's', &quot;Private key file pass phrase source&quot;},
+    {&quot;dcert&quot;, OPT_DCERT, '&lt;',
+     &quot;Second certificate file to use (usually for DSA)&quot;},
+    {&quot;dcertform&quot;, OPT_DCERTFORM, 'F',
+     &quot;Second certificate format (PEM or DER) PEM default&quot;},
+    {&quot;dkey&quot;, OPT_DKEY, '&lt;',
+     &quot;Second private key file to use (usually for DSA)&quot;},
+    {&quot;dkeyform&quot;, OPT_DKEYFORM, 'F',
+     &quot;Second key format (PEM, DER or ENGINE) PEM default&quot;},
+    {&quot;dpass&quot;, OPT_DPASS, 's', &quot;Second private key file pass phrase source&quot;},
+#ifdef FIONBIO
+    {&quot;nbio&quot;, OPT_NBIO, '-', &quot;Use non-blocking IO&quot;},
+#endif
+    {&quot;nbio_test&quot;, OPT_NBIO_TEST, '-', &quot;Test with the non-blocking test bio&quot;},
+    {&quot;crlf&quot;, OPT_CRLF, '-', &quot;Convert LF from terminal into CRLF&quot;},
+    {&quot;debug&quot;, OPT_DEBUG, '-', &quot;Print more output&quot;},
+    {&quot;msg&quot;, OPT_MSG, '-', &quot;Show protocol messages&quot;},
+    {&quot;msgfile&quot;, OPT_MSGFILE, '&gt;'},
+    {&quot;state&quot;, OPT_STATE, '-', &quot;Print the SSL states&quot;},
+    {&quot;CApath&quot;, OPT_CAPATH, '/', &quot;PEM format directory of CA's&quot;},
+    {&quot;CAfile&quot;, OPT_CAFILE, '&lt;', &quot;PEM format file of CA's&quot;},
+    {&quot;nocert&quot;, OPT_NOCERT, '-', &quot;Don't use any certificates (Anon-DH)&quot;},
+    {&quot;quiet&quot;, OPT_QUIET, '-', &quot;No server output&quot;},
+    {&quot;no_tmp_rsa&quot;, OPT_NO_TMP_RSA, '-', &quot;Do not generate a tmp RSA key&quot;},
+#ifndef OPENSSL_NO_PSK
+    {&quot;psk_hint&quot;, OPT_PSK_HINT, 's', &quot;PSK identity hint to use&quot;},
+    {&quot;psk&quot;, OPT_PSK, 's', &quot;PSK in hex (without 0x)&quot;},
+# ifndef OPENSSL_NO_JPAKE
+    {&quot;jpake&quot;, OPT_JPAKE, 's', &quot;JPAKE secret to use&quot;},
+# endif
+#endif
+#ifndef OPENSSL_NO_SRP
+    {&quot;srpvfile&quot;, OPT_SRPVFILE, '&lt;', &quot;The verifier file for SRP&quot;},
+    {&quot;srpuserseed&quot;, OPT_SRPUSERSEED, 's',
+     &quot;A seed string for a default user salt&quot;},
+#endif
+#ifndef OPENSSL_NO_SSL3
+    {&quot;ssl3&quot;, OPT_SSL3, '-', &quot;Just talk SSLv3&quot;},
+#endif
+    {&quot;tls1_2&quot;, OPT_TLS1_2, '-', &quot;just talk TLSv1.2&quot;},
+    {&quot;tls1_1&quot;, OPT_TLS1_1, '-', &quot;Just talk TLSv1.1&quot;},
+    {&quot;tls1&quot;, OPT_TLS1, '-', &quot;Just talk TLSv1&quot;},
+#ifndef OPENSSL_NO_DTLS1
+    {&quot;dtls&quot;, OPT_DTLS, '-'},
+    {&quot;dtls1&quot;, OPT_DTLS1, '-', &quot;Just talk DTLSv1&quot;},
+    {&quot;dtls1_2&quot;, OPT_DTLS1_2, '-', &quot;Just talk DTLSv1.2&quot;},
+    {&quot;timeout&quot;, OPT_TIMEOUT, '-', &quot;Enable timeouts&quot;},
+    {&quot;mtu&quot;, OPT_MTU, 'p', &quot;Set link layer MTU&quot;},
+    {&quot;chain&quot;, OPT_CHAIN, '-', &quot;Read a certificate chain&quot;},
+#endif
+#ifndef OPENSSL_NO_DH
+    {&quot;no_dhe&quot;, OPT_NO_DHE, '-', &quot;Disable ephemeral DH&quot;},
+#endif
+#ifndef OPENSSL_NO_EC
+    {&quot;no_ecdhe&quot;, OPT_NO_ECDHE, '-', &quot;Disable ephemeral ECDH&quot;},
+#endif
+    {&quot;no_resume_ephemeral&quot;, OPT_NO_RESUME_EPHEMERAL, '-',
+     &quot;Disable caching and tickets if ephemeral (EC)DH is used&quot;},
+    {&quot;www&quot;, OPT_WWW, '-', &quot;Respond to a 'GET /' with a status page&quot;},
+    {&quot;WWW&quot;, OPT_UPPER_WWW, '-', &quot;Respond to a 'GET with the file ./path&quot;},
+    {&quot;HTTP&quot;, OPT_HTTP, '-', &quot;Like -WWW but ./path incluedes HTTP headers&quot;},
+    {&quot;id_prefix&quot;, OPT_ID_PREFIX, 's',
+     &quot;Generate SSL/TLS session IDs prefixed by arg&quot;},
+    {&quot;rand&quot;, OPT_RAND, 's',
+     &quot;Load the file(s) into the random number generator&quot;},
+#ifndef OPENSSL_NO_TLSEXT
+    {&quot;servername&quot;, OPT_SERVERNAME, 's',
+     &quot;Servername for HostName TLS extension&quot;},
+    {&quot;servername_fatal&quot;, OPT_SERVERNAME_FATAL, '-',
+     &quot;mismatch send fatal alert (default warning alert)&quot;},
+    {&quot;cert2&quot;, OPT_CERT2, '&lt;',
+     &quot;Certificate file to use for servername; default is&quot; TEST_CERT2},
+    {&quot;key2&quot;, OPT_KEY2, '&lt;',
+     &quot;-Private Key file to use for servername if not in -cert2&quot;},
+    {&quot;tlsextdebug&quot;, OPT_TLSEXTDEBUG, '-',
+     &quot;Hex dump of all TLS extensions received&quot;},
+# ifndef OPENSSL_NO_NEXTPROTONEG
+    {&quot;nextprotoneg&quot;, OPT_NEXTPROTONEG, 's',
+     &quot;Set the advertised protocols for the NPN extension (comma-separated list)&quot;},
+# endif
+    {&quot;use_srtp&quot;, OPT_SRTP_PROFILES, '&lt;',
+     &quot;Offer SRTP key management with a colon-separated profile list&quot;},
+    {&quot;alpn&quot;, OPT_ALPN, 's',
+     &quot;Set the advertised protocols for the ALPN extension (comma-separated list)&quot;},
+#endif
+    {&quot;keymatexport&quot;, OPT_KEYMATEXPORT, 's',
+     &quot;Export keying material using label&quot;},
+    {&quot;keymatexportlen&quot;, OPT_KEYMATEXPORTLEN, 'p',
+     &quot;Export len bytes of keying material (default 20)&quot;},
+    {&quot;CRL&quot;, OPT_CRL, '&lt;'},
+    {&quot;crl_download&quot;, OPT_CRL_DOWNLOAD, '-'},
+    {&quot;cert_chain&quot;, OPT_CERT_CHAIN, '&lt;'},
+    {&quot;dcert_chain&quot;, OPT_DCERT_CHAIN, '&lt;'},
+    {&quot;chainCApath&quot;, OPT_CHAINCAPATH, '/'},
+    {&quot;verifyCApath&quot;, OPT_VERIFYCAPATH, '/'},
+    {&quot;no_cache&quot;, OPT_NO_CACHE, '-'},
+    {&quot;ext_cache&quot;, OPT_EXT_CACHE, '-'},
+    {&quot;CRLform&quot;, OPT_CRLFORM, 'F'},
+    {&quot;verify_return_error&quot;, OPT_VERIFY_RET_ERROR, '-'},
+    {&quot;verify_quiet&quot;, OPT_VERIFY_QUIET, '-'},
+    {&quot;build_chain&quot;, OPT_BUILD_CHAIN, '-'},
+    {&quot;chainCAfile&quot;, OPT_CHAINCAFILE, '&lt;'},
+    {&quot;verifyCAfile&quot;, OPT_VERIFYCAFILE, '&lt;'},
+    {&quot;ign_eof&quot;, OPT_IGN_EOF, '-'},
+    {&quot;no_ign_eof&quot;, OPT_NO_IGN_EOF, '-'},
+    {&quot;status&quot;, OPT_STATUS, '-'},
+    {&quot;status_verbose&quot;, OPT_STATUS_VERBOSE, '-'},
+    {&quot;status_timeout&quot;, OPT_STATUS_TIMEOUT, 'n'},
+    {&quot;status_url&quot;, OPT_STATUS_URL, 's'},
+    {&quot;trace&quot;, OPT_TRACE, '-'},
+    {&quot;security_debug&quot;, OPT_SECURITY_DEBUG, '-'},
+    {&quot;security_debug_verbose&quot;, OPT_SECURITY_DEBUG_VERBOSE, '-'},
+    {&quot;brief&quot;, OPT_BRIEF, '-'},
+    {&quot;rev&quot;, OPT_REV, '-'},
+#ifndef OPENSSL_NO_ENGINE
+    {&quot;engine&quot;, OPT_ENGINE, 's'},
+#endif
+    OPT_S_OPTIONS,
+    OPT_V_OPTIONS,
+    OPT_X_OPTIONS,
+    {NULL}
+};
+
+int s_server_main(int argc, char *argv[])
 {
+    ENGINE *e = NULL;
+    EVP_PKEY *s_key = NULL, *s_dkey = NULL;
+    SSL_CONF_CTX *cctx = NULL;
+    const SSL_METHOD *meth = SSLv23_server_method();
+    SSL_EXCERT *exc = NULL;
+    STACK_OF(OPENSSL_STRING) *ssl_args = NULL;
+    STACK_OF(X509) *s_chain = NULL, *s_dchain = NULL;
+    STACK_OF(X509_CRL) *crls = NULL;
+    X509 *s_cert = NULL, *s_dcert = NULL;
     X509_VERIFY_PARAM *vpm = NULL;
-    int badarg = 0;
-    short port = PORT;
+    char *CApath = NULL, *CAfile = NULL, *chCApath = NULL, *chCAfile = NULL;
+    char *dhfile = NULL, *dpassarg = NULL, *dpass = NULL, *inrand = NULL;
+    char *passarg = NULL, *pass = NULL, *vfyCApath = NULL, *vfyCAfile = NULL;
+    char *crl_file = NULL, *prog, *p;
     const char *unix_path = NULL;
 #ifndef NO_SYS_UN_H
     int unlink_unix_path = 0;
 #endif
     int (*server_cb) (char *hostname, int s, int stype,
                       unsigned char *context);
-    char *CApath = NULL, *CAfile = NULL;
-    char *chCApath = NULL, *chCAfile = NULL;
-    char *vfyCApath = NULL, *vfyCAfile = NULL;
-    unsigned char *context = NULL;
-    char *dhfile = NULL;
-    int badop = 0;
-    int ret = 1;
-    int build_chain = 0;
-    int no_tmp_rsa = 0, no_dhe = 0, no_ecdhe = 0, nocert = 0;
-    int state = 0;
-    const SSL_METHOD *meth = NULL;
-    int socket_type = SOCK_STREAM;
-    ENGINE *e = NULL;
-    char *inrand = NULL;
+    int vpmtouched = 0, build_chain = 0, no_cache = 0, ext_cache = 0;
+    int no_tmp_rsa = 0, no_dhe = 0, no_ecdhe = 0, nocert = 0, ret = 1;
     int s_cert_format = FORMAT_PEM, s_key_format = FORMAT_PEM;
-    char *passarg = NULL, *pass = NULL;
-    char *dpassarg = NULL, *dpass = NULL;
     int s_dcert_format = FORMAT_PEM, s_dkey_format = FORMAT_PEM;
-    X509 *s_cert = NULL, *s_dcert = NULL;
-    STACK_OF(X509) *s_chain = NULL, *s_dchain = NULL;
-    EVP_PKEY *s_key = NULL, *s_dkey = NULL;
-    int no_cache = 0, ext_cache = 0;
-    int rev = 0, naccept = -1;
-    int sdebug = 0;
+    int rev = 0, naccept = -1, sdebug = 0, socket_type = SOCK_STREAM;
+    int state = 0, crl_format = FORMAT_PEM, crl_download = 0;
+    unsigned short port = PORT;
+    unsigned char *context = NULL;
+    OPTION_CHOICE o;
 #ifndef OPENSSL_NO_TLSEXT
     EVP_PKEY *s_key2 = NULL;
     X509 *s_cert2 = NULL;
@@ -1064,449 +1037,394 @@ int MAIN(int argc, char *argv[])
     char *srpuserseed = NULL;
     char *srp_verifier_file = NULL;
 #endif
-    SSL_EXCERT *exc = NULL;
-    SSL_CONF_CTX *cctx = NULL;
-    STACK_OF(OPENSSL_STRING) *ssl_args = NULL;
-
-    char *crl_file = NULL;
-    int crl_format = FORMAT_PEM;
-    int crl_download = 0;
-    STACK_OF(X509_CRL) *crls = NULL;
-
-    meth = SSLv23_server_method();
 
     local_argc = argc;
     local_argv = argv;
 
-    apps_startup();
-#ifdef MONOLITH
     s_server_init();
-#endif
-
-    if (bio_err == NULL)
-        bio_err = BIO_new_fp(stderr, BIO_NOCLOSE);
-
-    if (!load_config(bio_err, NULL))
-        goto end;
-
     cctx = SSL_CONF_CTX_new();
-    if (!cctx)
+    vpm = X509_VERIFY_PARAM_new();
+    if (cctx == NULL || vpm == NULL)
         goto end;
-    SSL_CONF_CTX_set_flags(cctx, SSL_CONF_FLAG_SERVER);
-    SSL_CONF_CTX_set_flags(cctx, SSL_CONF_FLAG_CMDLINE);
-
-    verify_depth = 0;
-#ifdef FIONBIO
-    s_nbio = 0;
-#endif
-    s_nbio_test = 0;
-
-    argc--;
-    argv++;
+    SSL_CONF_CTX_set_flags(cctx, SSL_CONF_FLAG_SERVER | SSL_CONF_FLAG_CMDLINE);
+
+    prog = opt_init(argc, argv, s_server_options);
+    while ((o = opt_next()) != OPT_EOF) {
+        switch (o) {
+        case OPT_EOF:
+        case OPT_ERR:
+ opthelp:
+            BIO_printf(bio_err, &quot;%s: Use -help for summary.\n&quot;, prog);
+            goto end;
+        case OPT_HELP:
+            opt_help(s_server_options);
+            ret = 0;
+            goto end;
 
-    while (argc &gt;= 1) {
-        if ((strcmp(*argv, &quot;-port&quot;) == 0) || (strcmp(*argv, &quot;-accept&quot;) == 0)) {
-            if (--argc &lt; 1)
-                goto bad;
-            if (!extract_port(*(++argv), &amp;port))
-                goto bad;
-        } else if (strcmp(*argv, &quot;-unix&quot;) == 0) {
+        case OPT_PORT:
+            if (!extract_port(opt_arg(), &amp;port))
+                goto end;
+            break;
+        case OPT_UNIX:
 #ifdef NO_SYS_UN_H
             BIO_printf(bio_err, &quot;unix domain sockets unsupported\n&quot;);
-            goto bad;
+            goto end;
 #else
-            if (--argc &lt; 1)
-                goto bad;
-            unix_path = *(++argv);
+            unix_path = opt_arg();
 #endif
-        } else if (strcmp(*argv, &quot;-unlink&quot;) == 0) {
+            break;
+        case OPT_UNLINK:
 #ifdef NO_SYS_UN_H
             BIO_printf(bio_err, &quot;unix domain sockets unsupported\n&quot;);
-            goto bad;
+            goto end;
 #else
             unlink_unix_path = 1;
 #endif
-        } else if (strcmp(*argv, &quot;-naccept&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            naccept = atol(*(++argv));
-            if (naccept &lt;= 0) {
-                BIO_printf(bio_err, &quot;bad accept value %s\n&quot;, *argv);
-                goto bad;
-            }
-        } else if (strcmp(*argv, &quot;-verify&quot;) == 0) {
+            break;
+        case OPT_NACCEPT:
+            naccept = atol(opt_arg());
+            break;
+        case OPT_VERIFY:
             s_server_verify = SSL_VERIFY_PEER | SSL_VERIFY_CLIENT_ONCE;
-            if (--argc &lt; 1)
-                goto bad;
-            verify_depth = atoi(*(++argv));
+            verify_depth = atoi(opt_arg());
             if (!s_quiet)
                 BIO_printf(bio_err, &quot;verify depth is %d\n&quot;, verify_depth);
-        } else if (strcmp(*argv, &quot;-Verify&quot;) == 0) {
+            break;
+        case OPT_UPPER_V_VERIFY:
             s_server_verify =
                 SSL_VERIFY_PEER | SSL_VERIFY_FAIL_IF_NO_PEER_CERT |
                 SSL_VERIFY_CLIENT_ONCE;
-            if (--argc &lt; 1)
-                goto bad;
-            verify_depth = atoi(*(++argv));
+            verify_depth = atoi(opt_arg());
             if (!s_quiet)
                 BIO_printf(bio_err,
                            &quot;verify depth is %d, must return a certificate\n&quot;,
                            verify_depth);
-        } else if (strcmp(*argv, &quot;-context&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            context = (unsigned char *)*(++argv);
-        } else if (strcmp(*argv, &quot;-cert&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            s_cert_file = *(++argv);
-        } else if (strcmp(*argv, &quot;-CRL&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            crl_file = *(++argv);
-        } else if (strcmp(*argv, &quot;-crl_download&quot;) == 0)
+            break;
+        case OPT_CONTEXT:
+            context = (unsigned char *)opt_arg();
+            break;
+        case OPT_CERT:
+            s_cert_file = opt_arg();
+            break;
+        case OPT_CRL:
+            crl_file = opt_arg();
+            break;
+        case OPT_CRL_DOWNLOAD:
             crl_download = 1;
+            break;
 #ifndef OPENSSL_NO_TLSEXT
-        else if (strcmp(*argv, &quot;-serverinfo&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            s_serverinfo_file = *(++argv);
-        }
+        case OPT_SERVERINFO:
+            s_serverinfo_file = opt_arg();
+            break;
 #endif
-        else if (strcmp(*argv, &quot;-certform&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            s_cert_format = str2fmt(*(++argv));
-        } else if (strcmp(*argv, &quot;-key&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            s_key_file = *(++argv);
-        } else if (strcmp(*argv, &quot;-keyform&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            s_key_format = str2fmt(*(++argv));
-        } else if (strcmp(*argv, &quot;-pass&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            passarg = *(++argv);
-        } else if (strcmp(*argv, &quot;-cert_chain&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            s_chain_file = *(++argv);
-        } else if (strcmp(*argv, &quot;-dhparam&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            dhfile = *(++argv);
-        } else if (strcmp(*argv, &quot;-dcertform&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            s_dcert_format = str2fmt(*(++argv));
-        } else if (strcmp(*argv, &quot;-dcert&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            s_dcert_file = *(++argv);
-        } else if (strcmp(*argv, &quot;-dkeyform&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            s_dkey_format = str2fmt(*(++argv));
-        } else if (strcmp(*argv, &quot;-dpass&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            dpassarg = *(++argv);
-        } else if (strcmp(*argv, &quot;-dkey&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            s_dkey_file = *(++argv);
-        } else if (strcmp(*argv, &quot;-dcert_chain&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            s_dchain_file = *(++argv);
-        } else if (strcmp(*argv, &quot;-nocert&quot;) == 0) {
+        case OPT_CERTFORM:
+            if (!opt_format(opt_arg(), OPT_FMT_PEMDER, &amp;s_cert_format))
+                goto opthelp;
+            break;
+        case OPT_KEY:
+            s_key_file = opt_arg();
+            break;
+        case OPT_KEYFORM:
+            if (!opt_format(opt_arg(), OPT_FMT_ANY, &amp;s_key_format))
+                goto opthelp;
+            break;
+        case OPT_PASS:
+            passarg = opt_arg();
+            break;
+        case OPT_CERT_CHAIN:
+            s_chain_file = opt_arg();
+            break;
+        case OPT_DHPARAM:
+            dhfile = opt_arg();
+            break;
+        case OPT_DCERTFORM:
+            if (!opt_format(opt_arg(), OPT_FMT_PEMDER, &amp;s_dcert_format))
+                goto opthelp;
+            break;
+        case OPT_DCERT:
+            s_dcert_file = opt_arg();
+            break;
+        case OPT_DKEYFORM:
+            if (!opt_format(opt_arg(), OPT_FMT_PEMDER, &amp;s_dkey_format))
+                goto opthelp;
+            break;
+        case OPT_DPASS:
+            dpassarg = opt_arg();
+            break;
+        case OPT_DKEY:
+            s_dkey_file = opt_arg();
+            break;
+        case OPT_DCERT_CHAIN:
+            s_dchain_file = opt_arg();
+            break;
+        case OPT_NOCERT:
             nocert = 1;
-        } else if (strcmp(*argv, &quot;-CApath&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            CApath = *(++argv);
-        } else if (strcmp(*argv, &quot;-chainCApath&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            chCApath = *(++argv);
-        } else if (strcmp(*argv, &quot;-verifyCApath&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            vfyCApath = *(++argv);
-        } else if (strcmp(*argv, &quot;-no_cache&quot;) == 0)
+            break;
+        case OPT_CAPATH:
+            CApath = opt_arg();
+            break;
+        case OPT_CHAINCAPATH:
+            chCApath = opt_arg();
+            break;
+        case OPT_VERIFYCAPATH:
+            vfyCApath = opt_arg();
+            break;
+        case OPT_NO_CACHE:
             no_cache = 1;
-        else if (strcmp(*argv, &quot;-ext_cache&quot;) == 0)
+            break;
+        case OPT_EXT_CACHE:
             ext_cache = 1;
-        else if (strcmp(*argv, &quot;-CRLform&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            crl_format = str2fmt(*(++argv));
-        } else if (args_verify(&amp;argv, &amp;argc, &amp;badarg, bio_err, &amp;vpm)) {
-            if (badarg)
-                goto bad;
-            continue;
-        } else if (args_excert(&amp;argv, &amp;argc, &amp;badarg, bio_err, &amp;exc)) {
-            if (badarg)
-                goto bad;
-            continue;
-        } else if (args_ssl(&amp;argv, &amp;argc, cctx, &amp;badarg, bio_err, &amp;ssl_args)) {
-            if (badarg)
-                goto bad;
-            continue;
-        } else if (strcmp(*argv, &quot;-verify_return_error&quot;) == 0)
+            break;
+        case OPT_CRLFORM:
+            if (!opt_format(opt_arg(), OPT_FMT_PEMDER, &amp;crl_format))
+                goto opthelp;
+            break;
+        case OPT_S_CASES:
+            if (ssl_args == NULL)
+                ssl_args = sk_OPENSSL_STRING_new_null();
+            if (ssl_args == NULL
+                || !sk_OPENSSL_STRING_push(ssl_args, opt_flag())
+                || !sk_OPENSSL_STRING_push(ssl_args, opt_arg())) {
+                BIO_printf(bio_err, &quot;%s: Memory allocation failure\n&quot;, prog);
+                goto end;
+            }
+            break;
+        case OPT_V_CASES:
+            if (!opt_verify(o, vpm))
+                goto end;
+            vpmtouched++;
+            break;
+        case OPT_X_CASES:
+            if (!args_excert(o, &amp;exc))
+                goto end;
+            break;
+        case OPT_VERIFY_RET_ERROR:
             verify_return_error = 1;
-        else if (strcmp(*argv, &quot;-verify_quiet&quot;) == 0)
+            break;
+        case OPT_VERIFY_QUIET:
             verify_quiet = 1;
-        else if (strcmp(*argv, &quot;-build_chain&quot;) == 0)
+            break;
+        case OPT_BUILD_CHAIN:
             build_chain = 1;
-        else if (strcmp(*argv, &quot;-CAfile&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            CAfile = *(++argv);
-        } else if (strcmp(*argv, &quot;-chainCAfile&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            chCAfile = *(++argv);
-        } else if (strcmp(*argv, &quot;-verifyCAfile&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            vfyCAfile = *(++argv);
-        }
-#ifdef FIONBIO
-        else if (strcmp(*argv, &quot;-nbio&quot;) == 0) {
-            s_nbio = 1;
-        }
-#endif
-        else if (strcmp(*argv, &quot;-nbio_test&quot;) == 0) {
-#ifdef FIONBIO
+            break;
+        case OPT_CAFILE:
+            CAfile = opt_arg();
+            break;
+        case OPT_CHAINCAFILE:
+            chCAfile = opt_arg();
+            break;
+        case OPT_VERIFYCAFILE:
+            vfyCAfile = opt_arg();
+            break;
+        case OPT_NBIO:
             s_nbio = 1;
-#endif
-            s_nbio_test = 1;
-        } else if (strcmp(*argv, &quot;-ign_eof&quot;) == 0)
+            break;
+        case OPT_NBIO_TEST:
+            s_nbio = s_nbio_test = 1;
+            break;
+        case OPT_IGN_EOF:
             s_ign_eof = 1;
-        else if (strcmp(*argv, &quot;-no_ign_eof&quot;) == 0)
+            break;
+        case OPT_NO_IGN_EOF:
             s_ign_eof = 0;
-        else if (strcmp(*argv, &quot;-debug&quot;) == 0) {
+            break;
+        case OPT_DEBUG:
             s_debug = 1;
-        }
+            break;
 #ifndef OPENSSL_NO_TLSEXT
-        else if (strcmp(*argv, &quot;-tlsextdebug&quot;) == 0)
+        case OPT_TLSEXTDEBUG:
             s_tlsextdebug = 1;
-        else if (strcmp(*argv, &quot;-status&quot;) == 0)
-            s_tlsextstatus = 1;
-        else if (strcmp(*argv, &quot;-status_verbose&quot;) == 0) {
+            break;
+        case OPT_STATUS:
             s_tlsextstatus = 1;
-            tlscstatp.verbose = 1;
-        } else if (!strcmp(*argv, &quot;-status_timeout&quot;)) {
+            break;
+        case OPT_STATUS_VERBOSE:
+            s_tlsextstatus = tlscstatp.verbose = 1;
+            break;
+        case OPT_STATUS_TIMEOUT:
             s_tlsextstatus = 1;
-            if (--argc &lt; 1)
-                goto bad;
-            tlscstatp.timeout = atoi(*(++argv));
-        } else if (!strcmp(*argv, &quot;-status_url&quot;)) {
+            tlscstatp.timeout = atoi(opt_arg());
+            break;
+        case OPT_STATUS_URL:
             s_tlsextstatus = 1;
-            if (--argc &lt; 1)
-                goto bad;
-            if (!OCSP_parse_url(*(++argv),
+            if (!OCSP_parse_url(opt_arg(),
                                 &amp;tlscstatp.host,
                                 &amp;tlscstatp.port,
                                 &amp;tlscstatp.path, &amp;tlscstatp.use_ssl)) {
                 BIO_printf(bio_err, &quot;Error parsing URL\n&quot;);
-                goto bad;
+                goto end;
             }
-        }
+            break;
 #endif
-        else if (strcmp(*argv, &quot;-msg&quot;) == 0) {
+        case OPT_MSG:
             s_msg = 1;
-        } else if (strcmp(*argv, &quot;-msgfile&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            bio_s_msg = BIO_new_file(*(++argv), &quot;w&quot;);
-        }
+            break;
+        case OPT_MSGFILE:
+            bio_s_msg = BIO_new_file(opt_arg(), &quot;w&quot;);
+            break;
 #ifndef OPENSSL_NO_SSL_TRACE
-        else if (strcmp(*argv, &quot;-trace&quot;) == 0) {
+        case OPT_TRACE:
             s_msg = 2;
-        }
+            break;
+#else
+        case OPT_TRACE:
+            goto opthelp;
 #endif
-        else if (strcmp(*argv, &quot;-security_debug&quot;) == 0) {
+        case OPT_SECURITY_DEBUG:
             sdebug = 1;
-        } else if (strcmp(*argv, &quot;-security_debug_verbose&quot;) == 0) {
+            break;
+        case OPT_SECURITY_DEBUG_VERBOSE:
             sdebug = 2;
-        } else if (strcmp(*argv, &quot;-state&quot;) == 0) {
+            break;
+        case OPT_STATE:
             state = 1;
-        } else if (strcmp(*argv, &quot;-crlf&quot;) == 0) {
+            break;
+        case OPT_CRLF:
             s_crlf = 1;
-        } else if (strcmp(*argv, &quot;-quiet&quot;) == 0) {
-            s_quiet = 1;
-        } else if (strcmp(*argv, &quot;-brief&quot;) == 0) {
+            break;
+        case OPT_QUIET:
             s_quiet = 1;
-            s_brief = 1;
-            verify_quiet = 1;
-        } else if (strcmp(*argv, &quot;-no_tmp_rsa&quot;) == 0) {
+            break;
+        case OPT_BRIEF:
+            s_quiet = s_brief = verify_quiet = 1;
+            break;
+        case OPT_NO_TMP_RSA:
             no_tmp_rsa = 1;
-        } else if (strcmp(*argv, &quot;-no_dhe&quot;) == 0) {
+            break;
+        case OPT_NO_DHE:
             no_dhe = 1;
-        } else if (strcmp(*argv, &quot;-no_ecdhe&quot;) == 0) {
+            break;
+        case OPT_NO_ECDHE:
             no_ecdhe = 1;
-        } else if (strcmp(*argv, &quot;-no_resume_ephemeral&quot;) == 0) {
+            break;
+        case OPT_NO_RESUME_EPHEMERAL:
             no_resume_ephemeral = 1;
-        }
+            break;
 #ifndef OPENSSL_NO_PSK
-        else if (strcmp(*argv, &quot;-psk_hint&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            psk_identity_hint = *(++argv);
-        } else if (strcmp(*argv, &quot;-psk&quot;) == 0) {
-            size_t i;
-
-            if (--argc &lt; 1)
-                goto bad;
-            psk_key = *(++argv);
-            for (i = 0; i &lt; strlen(psk_key); i++) {
-                if (isxdigit((unsigned char)psk_key[i]))
+        case OPT_PSK_HINT:
+            psk_identity_hint = opt_arg();
+            break;
+        case OPT_PSK:
+            for (p = psk_key = opt_arg(); *p; p++) {
+                if (isxdigit(*p))
                     continue;
                 BIO_printf(bio_err, &quot;Not a hex number '%s'\n&quot;, *argv);
-                goto bad;
+                goto end;
             }
-        }
+            break;
 #endif
 #ifndef OPENSSL_NO_SRP
-        else if (strcmp(*argv, &quot;-srpvfile&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            srp_verifier_file = *(++argv);
+        case OPT_SRPVFILE:
+            srp_verifier_file = opt_arg();
             meth = TLSv1_server_method();
-        } else if (strcmp(*argv, &quot;-srpuserseed&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            srpuserseed = *(++argv);
+            break;
+        case OPT_SRPUSERSEED:
+            srpuserseed = opt_arg();
             meth = TLSv1_server_method();
-        }
+            break;
 #endif
-        else if (strcmp(*argv, &quot;-rev&quot;) == 0) {
+        case OPT_REV:
             rev = 1;
-        } else if (strcmp(*argv, &quot;-www&quot;) == 0) {
+            break;
+        case OPT_WWW:
             www = 1;
-        } else if (strcmp(*argv, &quot;-WWW&quot;) == 0) {
+            break;
+        case OPT_UPPER_WWW:
             www = 2;
-        } else if (strcmp(*argv, &quot;-HTTP&quot;) == 0) {
+            break;
+        case OPT_HTTP:
             www = 3;
-        }
-#ifndef OPENSSL_NO_SSL3_METHOD
-        else if (strcmp(*argv, &quot;-ssl3&quot;) == 0) {
-            meth = SSLv3_server_method();
-        }
+            break;
+#ifndef OPENSSL_NO_SSL3
+        case OPT_SSL3:
+            meth = SSLv3_client_method();
+            break;
 #endif
-        else if (strcmp(*argv, &quot;-tls1&quot;) == 0) {
-            meth = TLSv1_server_method();
-        } else if (strcmp(*argv, &quot;-tls1_1&quot;) == 0) {
-            meth = TLSv1_1_server_method();
-        } else if (strcmp(*argv, &quot;-tls1_2&quot;) == 0) {
-            meth = TLSv1_2_server_method();
-        }
+        case OPT_TLS1_2:
+            meth = TLSv1_2_client_method();
+            break;
+        case OPT_TLS1_1:
+            meth = TLSv1_1_client_method();
+            break;
+        case OPT_TLS1:
+            meth = TLSv1_client_method();
+            break;
 #ifndef OPENSSL_NO_DTLS1
-        else if (strcmp(*argv, &quot;-dtls&quot;) == 0) {
-            meth = DTLS_server_method();
+        case OPT_DTLS:
+            meth = DTLS_client_method();
             socket_type = SOCK_DGRAM;
-        } else if (strcmp(*argv, &quot;-dtls1&quot;) == 0) {
-            meth = DTLSv1_server_method();
+            break;
+        case OPT_DTLS1:
+            meth = DTLSv1_client_method();
             socket_type = SOCK_DGRAM;
-        } else if (strcmp(*argv, &quot;-dtls1_2&quot;) == 0) {
-            meth = DTLSv1_2_server_method();
+            break;
+        case OPT_DTLS1_2:
+            meth = DTLSv1_2_client_method();
             socket_type = SOCK_DGRAM;
-        } else if (strcmp(*argv, &quot;-timeout&quot;) == 0)
+            break;
+        case OPT_TIMEOUT:
             enable_timeouts = 1;
-        else if (strcmp(*argv, &quot;-mtu&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            socket_mtu = atol(*(++argv));
-        } else if (strcmp(*argv, &quot;-chain&quot;) == 0)
+            break;
+        case OPT_MTU:
+            socket_mtu = atol(opt_arg());
+            break;
+        case OPT_CHAIN:
             cert_chain = 1;
+            break;
 #endif
-        else if (strcmp(*argv, &quot;-id_prefix&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            session_id_prefix = *(++argv);
-        }
-#ifndef OPENSSL_NO_ENGINE
-        else if (strcmp(*argv, &quot;-engine&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            engine_id = *(++argv);
-        }
-#endif
-        else if (strcmp(*argv, &quot;-rand&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            inrand = *(++argv);
-        }
+        case OPT_ID_PREFIX:
+            session_id_prefix = opt_arg();
+            break;
+        case OPT_ENGINE:
+            engine_id = opt_arg();
+            break;
+        case OPT_RAND:
+            inrand = opt_arg();
+            break;
 #ifndef OPENSSL_NO_TLSEXT
-        else if (strcmp(*argv, &quot;-servername&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            tlsextcbp.servername = *(++argv);
-        } else if (strcmp(*argv, &quot;-servername_fatal&quot;) == 0) {
+        case OPT_SERVERNAME:
+            tlsextcbp.servername = opt_arg();
+            break;
+        case OPT_SERVERNAME_FATAL:
             tlsextcbp.extension_error = SSL_TLSEXT_ERR_ALERT_FATAL;
-        } else if (strcmp(*argv, &quot;-cert2&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            s_cert_file2 = *(++argv);
-        } else if (strcmp(*argv, &quot;-key2&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            s_key_file2 = *(++argv);
-        }
+            break;
+        case OPT_CERT2:
+            s_cert_file2 = opt_arg();
+            break;
+        case OPT_KEY2:
+            s_key_file2 = opt_arg();
+            break;
 # ifndef OPENSSL_NO_NEXTPROTONEG
-        else if (strcmp(*argv, &quot;-nextprotoneg&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            next_proto_neg_in = *(++argv);
-        }
+        case OPT_NEXTPROTONEG:
+            next_proto_neg_in = opt_arg();
+            break;
 # endif
-        else if (strcmp(*argv, &quot;-alpn&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            alpn_in = *(++argv);
-        }
+        case OPT_ALPN:
+            alpn_in = opt_arg();
+            break;
 #endif
 #if !defined(OPENSSL_NO_JPAKE) &amp;&amp; !defined(OPENSSL_NO_PSK)
-        else if (strcmp(*argv, &quot;-jpake&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            jpake_secret = *(++argv);
-        }
-#endif
-#ifndef OPENSSL_NO_SRTP
-        else if (strcmp(*argv, &quot;-use_srtp&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            srtp_profiles = *(++argv);
-        }
+        case OPT_JPAKE:
+            jpake_secret = opt_arg();
+            break;
+#else
+        case OPT_JPAKE:
+            goto opthelp;
 #endif
-        else if (strcmp(*argv, &quot;-keymatexport&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            keymatexportlabel = *(++argv);
-        } else if (strcmp(*argv, &quot;-keymatexportlen&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            keymatexportlen = atoi(*(++argv));
-            if (keymatexportlen == 0)
-                goto bad;
-        } else {
-            BIO_printf(bio_err, &quot;unknown option %s\n&quot;, *argv);
-            badop = 1;
+        case OPT_SRTP_PROFILES:
+            srtp_profiles = opt_arg();
+            break;
+        case OPT_KEYMATEXPORT:
+            keymatexportlabel = opt_arg();
+            break;
+        case OPT_KEYMATEXPORTLEN:
+            keymatexportlen = atoi(opt_arg());
             break;
         }
-        argc--;
-        argv++;
-    }
-    if (badop) {
- bad:
-        sv_usage();
-        goto end;
     }
+    argc = opt_num_rest();
+    argv = opt_rest();
+
 #ifndef OPENSSL_NO_DTLS1
     if (www &amp;&amp; socket_type == SOCK_DGRAM) {
         BIO_printf(bio_err, &quot;Can't use -HTTP, -www or -WWW with DTLS\n&quot;);
@@ -1529,14 +1447,11 @@ int MAIN(int argc, char *argv[])
     }
 #endif
 
-    SSL_load_error_strings();
-    OpenSSL_add_ssl_algorithms();
-
 #ifndef OPENSSL_NO_ENGINE
-    e = setup_engine(bio_err, engine_id, 1);
+    e = setup_engine(engine_id, 1);
 #endif
 
-    if (!app_passwd(bio_err, passarg, dpassarg, &amp;pass, &amp;dpass)) {
+    if (!app_passwd(passarg, dpassarg, &amp;pass, &amp;dpass)) {
         BIO_printf(bio_err, &quot;Error getting password\n&quot;);
         goto end;
     }
@@ -1548,18 +1463,18 @@ int MAIN(int argc, char *argv[])
         s_key_file2 = s_cert_file2;
 #endif
 
-    if (!load_excert(&amp;exc, bio_err))
+    if (!load_excert(&amp;exc))
         goto end;
 
     if (nocert == 0) {
-        s_key = load_key(bio_err, s_key_file, s_key_format, 0, pass, e,
+        s_key = load_key(s_key_file, s_key_format, 0, pass, e,
                          &quot;server certificate private key file&quot;);
         if (!s_key) {
             ERR_print_errors(bio_err);
             goto end;
         }
 
-        s_cert = load_cert(bio_err, s_cert_file, s_cert_format,
+        s_cert = load_cert(s_cert_file, s_cert_format,
                            NULL, e, &quot;server certificate file&quot;);
 
         if (!s_cert) {
@@ -1567,21 +1482,21 @@ int MAIN(int argc, char *argv[])
             goto end;
         }
         if (s_chain_file) {
-            s_chain = load_certs(bio_err, s_chain_file, FORMAT_PEM,
+            s_chain = load_certs(s_chain_file, FORMAT_PEM,
                                  NULL, e, &quot;server certificate chain&quot;);
             if (!s_chain)
                 goto end;
         }
 #ifndef OPENSSL_NO_TLSEXT
         if (tlsextcbp.servername) {
-            s_key2 = load_key(bio_err, s_key_file2, s_key_format, 0, pass, e,
+            s_key2 = load_key(s_key_file2, s_key_format, 0, pass, e,
                               &quot;second server certificate private key file&quot;);
             if (!s_key2) {
                 ERR_print_errors(bio_err);
                 goto end;
             }
 
-            s_cert2 = load_cert(bio_err, s_cert_file2, s_cert_format,
+            s_cert2 = load_cert(s_cert_file2, s_cert_format,
                                 NULL, e, &quot;second server certificate file&quot;);
 
             if (!s_cert2) {
@@ -1635,14 +1550,14 @@ int MAIN(int argc, char *argv[])
         if (s_dkey_file == NULL)
             s_dkey_file = s_dcert_file;
 
-        s_dkey = load_key(bio_err, s_dkey_file, s_dkey_format,
+        s_dkey = load_key(s_dkey_file, s_dkey_format,
                           0, dpass, e, &quot;second certificate private key file&quot;);
         if (!s_dkey) {
             ERR_print_errors(bio_err);
             goto end;
         }
 
-        s_dcert = load_cert(bio_err, s_dcert_file, s_dcert_format,
+        s_dcert = load_cert(s_dcert_file, s_dcert_format,
                             NULL, e, &quot;second server certificate file&quot;);
 
         if (!s_dcert) {
@@ -1650,7 +1565,7 @@ int MAIN(int argc, char *argv[])
             goto end;
         }
         if (s_dchain_file) {
-            s_dchain = load_certs(bio_err, s_dchain_file, FORMAT_PEM,
+            s_dchain = load_certs(s_dchain_file, FORMAT_PEM,
                                   NULL, e, &quot;second server certificate chain&quot;);
             if (!s_dchain)
                 goto end;
@@ -1658,7 +1573,7 @@ int MAIN(int argc, char *argv[])
 
     }
 
-    if (!app_RAND_load_file(NULL, bio_err, 1) &amp;&amp; inrand == NULL
+    if (!app_RAND_load_file(NULL, 1) &amp;&amp; inrand == NULL
         &amp;&amp; !RAND_status()) {
         BIO_printf(bio_err,
                    &quot;warning, not much extra random data, consider using the -rand option\n&quot;);
@@ -1671,10 +1586,10 @@ int MAIN(int argc, char *argv[])
         if (s_quiet &amp;&amp; !s_debug) {
             bio_s_out = BIO_new(BIO_s_null());
             if (s_msg &amp;&amp; !bio_s_msg)
-                bio_s_msg = BIO_new_fp(stdout, BIO_NOCLOSE);
+                bio_s_msg = dup_bio_out();
         } else {
             if (bio_s_out == NULL)
-                bio_s_out = BIO_new_fp(stdout, BIO_NOCLOSE);
+                bio_s_out = dup_bio_out();
         }
     }
 #if !defined(OPENSSL_NO_RSA) || !defined(OPENSSL_NO_DSA) || !defined(OPENSSL_NO_EC)
@@ -1724,8 +1639,8 @@ int MAIN(int argc, char *argv[])
 
 #ifndef OPENSSL_NO_SRTP
     if (srtp_profiles != NULL) {
-        /* Returns 0 on success!! */
-        if (SSL_CTX_set_tlsext_use_srtp(ctx, srtp_profiles)) {
+        /* Returns 0 on success! */
+        if (SSL_CTX_set_tlsext_use_srtp(ctx, srtp_profiles) != 0) {
             BIO_printf(bio_err, &quot;Error setting SRTP profile\n&quot;);
             ERR_print_errors(bio_err);
             goto end;
@@ -1733,20 +1648,18 @@ int MAIN(int argc, char *argv[])
     }
 #endif
 
-    if ((!SSL_CTX_load_verify_locations(ctx, CAfile, CApath)) ||
-        (!SSL_CTX_set_default_verify_paths(ctx))) {
-        /* BIO_printf(bio_err,&quot;X509_load_verify_locations\n&quot;); */
+    if (!ctx_set_verify_locations(ctx, CAfile, CApath)) {
         ERR_print_errors(bio_err);
-        /* goto end; */
+        goto end;
     }
-    if (vpm &amp;&amp; !SSL_CTX_set1_param(ctx, vpm)) {
-        BIO_printf(bio_err, &quot;Error setting X509 params\n&quot;);
+    if (vpmtouched &amp;&amp; !SSL_CTX_set1_param(ctx, vpm)) {
+        BIO_printf(bio_err, &quot;Error setting verify params\n&quot;);
         ERR_print_errors(bio_err);
         goto end;
     }
 
     ssl_ctx_add_crls(ctx, crls, 0);
-    if (!args_ssl_call(ctx, bio_err, cctx, ssl_args, no_ecdhe, no_jpake))
+    if (!config_ctx(cctx, ssl_args, ctx, no_ecdhe, jpake_secret == NULL))
         goto end;
 
     if (!ssl_load_stores(ctx, vfyCApath, vfyCAfile, chCApath, chCAfile,
@@ -1799,14 +1712,14 @@ int MAIN(int argc, char *argv[])
             (!SSL_CTX_set_default_verify_paths(ctx2))) {
             ERR_print_errors(bio_err);
         }
-        if (vpm &amp;&amp; !SSL_CTX_set1_param(ctx2, vpm))  {
-            BIO_printf(bio_err, &quot;Error setting X509 params\n&quot;);
+        if (vpmtouched &amp;&amp; !SSL_CTX_set1_param(ctx2, vpm)) {
+            BIO_printf(bio_err, &quot;Error setting verify params\n&quot;);
             ERR_print_errors(bio_err);
             goto end;
         }
 
         ssl_ctx_add_crls(ctx2, crls, 0);
-        if (!args_ssl_call(ctx2, bio_err, cctx, ssl_args, no_ecdhe, no_jpake))
+        if (!config_ctx(cctx, ssl_args, ctx2, no_ecdhe, jpake_secret == NULL))
             goto end;
     }
 # ifndef OPENSSL_NO_NEXTPROTONEG
@@ -1926,8 +1839,8 @@ int MAIN(int argc, char *argv[])
 
     SSL_CTX_set_verify(ctx, s_server_verify, verify_callback);
     if (!SSL_CTX_set_session_id_context(ctx,
-        (void *)&amp;s_server_session_id_context,
-        sizeof s_server_session_id_context)) {
+                (void *)&amp;s_server_session_id_context,
+                sizeof s_server_session_id_context)) {
         BIO_printf(bio_err, &quot;error setting session id context\n&quot;);
         ERR_print_errors(bio_err);
         goto end;
@@ -1941,13 +1854,12 @@ int MAIN(int argc, char *argv[])
     if (ctx2) {
         SSL_CTX_set_verify(ctx2, s_server_verify, verify_callback);
         if (!SSL_CTX_set_session_id_context(ctx2,
-                                       (void *)&amp;s_server_session_id_context,
-                                       sizeof s_server_session_id_context)) {
+                    (void *)&amp;s_server_session_id_context,
+                    sizeof s_server_session_id_context)) {
             BIO_printf(bio_err, &quot;error setting session id context\n&quot;);
             ERR_print_errors(bio_err);
             goto end;
         }
-
         tlsextcbp.biodebug = bio_s_out;
         SSL_CTX_set_tlsext_servername_callback(ctx2, ssl_servername_cb);
         SSL_CTX_set_tlsext_servername_arg(ctx2, &amp;tlsextcbp);
@@ -2043,8 +1955,7 @@ int MAIN(int argc, char *argv[])
         OPENSSL_free(alpn_ctx.data);
 #endif
     ssl_excert_free(exc);
-    if (ssl_args)
-        sk_OPENSSL_STRING_free(ssl_args);
+    sk_OPENSSL_STRING_free(ssl_args);
     SSL_CONF_CTX_free(cctx);
 #ifndef OPENSSL_NO_JPAKE
     if (jpake_secret &amp;&amp; psk_key)
@@ -2054,8 +1965,7 @@ int MAIN(int argc, char *argv[])
     bio_s_out = NULL;
     BIO_free(bio_s_msg);
     bio_s_msg = NULL;
-    apps_shutdown();
-    OPENSSL_EXIT(ret);
+    return (ret);
 }
 
 static void print_stats(BIO *bio, SSL_CTX *ssl_ctx)
@@ -2129,19 +2039,21 @@ static int sv_body(char *hostname, int s, int stype, unsigned char *context)
         }
         if (s_tlsextstatus) {
             SSL_CTX_set_tlsext_status_cb(ctx, cert_status_cb);
-            tlscstatp.err = bio_err;
             SSL_CTX_set_tlsext_status_arg(ctx, &amp;tlscstatp);
         }
 #endif
 #ifndef OPENSSL_NO_KRB5
         if ((kctx = kssl_ctx_new()) != NULL) {
             SSL_set0_kssl_ctx(con, kctx);
-            kssl_ctx_setstring(kctx, KSSL_SERVICE, KRB5SVC);
-            kssl_ctx_setstring(kctx, KSSL_KEYTAB, KRB5KEYTAB);
+            kssl_ctx_setstring(kctx, KSSL_SERVICE,
+                               krb5svc ? krb5svc : KRB5SVC);
+            if (krb5tab)
+                kssl_ctx_setstring(kctx, KSSL_KEYTAB, krb5tab);
         }
 #endif                          /* OPENSSL_NO_KRB5 */
-        if (context &amp;&amp; !SSL_set_session_id_context(con, context,
-                                                   strlen((char *)context))) {
+        if (context
+                &amp;&amp; !SSL_set_session_id_context(con,
+                        context, strlen((char *)context))) {
             BIO_printf(bio_err, &quot;Error setting session id context\n&quot;);
             ret = -1;
             goto err;
@@ -2308,6 +2220,7 @@ static int sv_body(char *hostname, int s, int stype, unsigned char *context)
             if (!s_quiet &amp;&amp; !s_brief) {
                 if ((i &lt;= 0) || (buf[0] == 'Q')) {
                     BIO_printf(bio_s_out, &quot;DONE\n&quot;);
+                    (void)BIO_flush(bio_s_out);
                     SHUTDOWN(s);
                     close_accept_socket();
                     ret = -11;
@@ -2315,6 +2228,7 @@ static int sv_body(char *hostname, int s, int stype, unsigned char *context)
                 }
                 if ((i &lt;= 0) || (buf[0] == 'q')) {
                     BIO_printf(bio_s_out, &quot;DONE\n&quot;);
+                    (void)BIO_flush(bio_s_out);
                     if (SSL_version(con) != DTLS1_VERSION)
                         SHUTDOWN(s);
                     /*
@@ -2403,12 +2317,14 @@ static int sv_body(char *hostname, int s, int stype, unsigned char *context)
                 case SSL_ERROR_SYSCALL:
                 case SSL_ERROR_SSL:
                     BIO_printf(bio_s_out, &quot;ERROR\n&quot;);
+                    (void)BIO_flush(bio_s_out);
                     ERR_print_errors(bio_err);
                     ret = 1;
                     goto err;
                     /* break; */
                 case SSL_ERROR_ZERO_RETURN:
                     BIO_printf(bio_s_out, &quot;DONE\n&quot;);
+                    (void)BIO_flush(bio_s_out);
                     ret = 1;
                     goto err;
                 }
@@ -2462,11 +2378,13 @@ static int sv_body(char *hostname, int s, int stype, unsigned char *context)
                 case SSL_ERROR_SYSCALL:
                 case SSL_ERROR_SSL:
                     BIO_printf(bio_s_out, &quot;ERROR\n&quot;);
+                    (void)BIO_flush(bio_s_out);
                     ERR_print_errors(bio_err);
                     ret = 1;
                     goto err;
                 case SSL_ERROR_ZERO_RETURN:
                     BIO_printf(bio_s_out, &quot;DONE\n&quot;);
+                    (void)BIO_flush(bio_s_out);
                     ret = 1;
                     goto err;
                 }
@@ -2547,6 +2465,7 @@ static int init_ssl_connection(SSL *con)
         }
 
         BIO_printf(bio_err, &quot;ERROR\n&quot;);
+
         verify_error = SSL_get_verify_result(con);
         if (verify_error != X509_V_OK) {
             BIO_printf(bio_err, &quot;verify error:%s\n&quot;,
@@ -2666,6 +2585,9 @@ static int www_body(char *hostname, int s, int stype, unsigned char *context)
 #ifndef OPENSSL_NO_KRB5
     KSSL_CTX *kctx;
 #endif
+#ifdef RENEG
+    int total_bytes = 0;
+#endif
 
     buf = OPENSSL_malloc(bufsize);
     if (buf == NULL)
@@ -2705,9 +2627,8 @@ static int www_body(char *hostname, int s, int stype, unsigned char *context)
     }
 #endif                          /* OPENSSL_NO_KRB5 */
     if (context &amp;&amp; !SSL_set_session_id_context(con, context,
-                                               strlen((char *)context))) {
+                        strlen((char *)context)))
         goto err;
-    }
 
     sbio = BIO_new_socket(s, BIO_NOCLOSE);
     if (s_nbio_test) {
@@ -2821,7 +2742,7 @@ static int www_body(char *hostname, int s, int stype, unsigned char *context)
             j = sk_SSL_CIPHER_num(sk);
             for (i = 0; i &lt; j; i++) {
                 c = sk_SSL_CIPHER_value(sk, i);
-                BIO_printf(io, &quot;%-11s:%-25s&quot;,
+                BIO_printf(io, &quot;%-11s:%-25s &quot;,
                            SSL_CIPHER_get_version(c), SSL_CIPHER_get_name(c));
                 if ((((i + 1) % 2) == 0) &amp;&amp; (i + 1 != j))
                     BIO_puts(io, &quot;\n&quot;);
@@ -3003,10 +2924,8 @@ static int www_body(char *hostname, int s, int stype, unsigned char *context)
     SSL_set_shutdown(con, SSL_SENT_SHUTDOWN | SSL_RECEIVED_SHUTDOWN);
 
  err:
-
     if (ret &gt;= 0)
         BIO_printf(bio_s_out, &quot;ACCEPT\n&quot;);
-
     if (buf != NULL)
         OPENSSL_free(buf);
     BIO_free_all(io);
@@ -3051,7 +2970,7 @@ static int rev_body(char *hostname, int s, int stype, unsigned char *context)
     }
 #endif                          /* OPENSSL_NO_KRB5 */
     if (context &amp;&amp; !SSL_set_session_id_context(con, context,
-                                               strlen((char *)context))) {
+                        strlen((char *)context))) {
         ERR_print_errors(bio_err);
         goto err;
     }
@@ -3228,19 +3147,21 @@ static int add_session(SSL *ssl, SSL_SESSION *session)
 
     sess = OPENSSL_malloc(sizeof(simple_ssl_session));
     if (!sess) {
-        BIO_printf(bio_err, &quot;Out of memory adding session to external cache\n&quot;);
+        BIO_printf(bio_err, &quot;Out of memory adding to external cache\n&quot;);
         return 0;
     }
 
     SSL_SESSION_get_id(session, &amp;sess-&gt;idlen);
     sess-&gt;derlen = i2d_SSL_SESSION(session, NULL);
+    if (sess-&gt;derlen &lt; 0) {
+        BIO_printf(bio_err, &quot;Error encoding session\n&quot;);
+        return 0;
+    }
 
     sess-&gt;id = BUF_memdup(SSL_SESSION_get_id(session, NULL), sess-&gt;idlen);
-
     sess-&gt;der = OPENSSL_malloc(sess-&gt;derlen);
     if (!sess-&gt;id || !sess-&gt;der) {
-        BIO_printf(bio_err, &quot;Out of memory adding session to external cache\n&quot;);
-
+        BIO_printf(bio_err, &quot;Out of memory adding to external cache\n&quot;);
         if (sess-&gt;id)
             OPENSSL_free(sess-&gt;id);
         if (sess-&gt;der)
@@ -3249,7 +3170,9 @@ static int add_session(SSL *ssl, SSL_SESSION *session)
         return 0;
     }
     p = sess-&gt;der;
-    if (i2d_SSL_SESSION(session, &amp;p) &lt; 0) {
+
+    /* Assume it still works. */
+    if (i2d_SSL_SESSION(session, &amp;p) != sess-&gt;derlen) {
         BIO_printf(bio_err, &quot;Error encoding session\n&quot;);
         return 0;
     }
diff --git a/apps/s_socket.c b/apps/s_socket.c
index 5bdfc6c..4c440dc 100644
--- a/apps/s_socket.c
+++ b/apps/s_socket.c
@@ -1,6 +1,3 @@
-/*
- * apps/s_socket.c - socket-related functions used by s_client and s_server
- */
 /* Copyright (C) 1995-1998 Eric Young (<A HREF="../../../mailman/listinfo/openssl-commits.html">eay at cryptsoft.com</A>)
  * All rights reserved.
  *
@@ -57,7 +54,56 @@
  * copied and put under another distribution licence
  * [including the GNU Public Licence.]
  */
+/* ====================================================================
+ * Copyright (c) 199-2015 The OpenSSL Project.  All rights reserved.
+ *
+ * Redistribution and use in source and binary forms, with or without
+ * modification, are permitted provided that the following conditions
+ * are met:
+ *
+ * 1. Redistributions of source code must retain the above copyright
+ *    notice, this list of conditions and the following disclaimer.
+ *
+ * 2. Redistributions in binary form must reproduce the above copyright
+ *    notice, this list of conditions and the following disclaimer in
+ *    the documentation and/or other materials provided with the
+ *    distribution.
+ *
+ * 3. All advertising materials mentioning features or use of this
+ *    software must display the following acknowledgment:
+ *    &quot;This product includes software developed by the OpenSSL Project
+ *    for use in the OpenSSL Toolkit. (<A HREF="http://www.OpenSSL.org/">http://www.OpenSSL.org/</A>)&quot;
+ *
+ * 4. The names &quot;OpenSSL Toolkit&quot; and &quot;OpenSSL Project&quot; must not be used to
+ *    endorse or promote products derived from this software without
+ *    prior written permission. For written permission, please contact
+ *    <A HREF="../../../mailman/listinfo/openssl-commits.html">licensing at OpenSSL.org.</A>
+ *
+ * 5. Products derived from this software may not be called &quot;OpenSSL&quot;
+ *    nor may &quot;OpenSSL&quot; appear in their names without prior written
+ *    permission of the OpenSSL Project.
+ *
+ * 6. Redistributions of any form whatsoever must retain the following
+ *    acknowledgment:
+ *    &quot;This product includes software developed by the OpenSSL Project
+ *    for use in the OpenSSL Toolkit (<A HREF="http://www.OpenSSL.org/">http://www.OpenSSL.org/</A>)&quot;
+ *
+ * THIS SOFTWARE IS PROVIDED BY THE OpenSSL PROJECT ``AS IS'' AND ANY
+ * EXPRESSED OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
+ * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR
+ * PURPOSE ARE DISCLAIMED.  IN NO EVENT SHALL THE OpenSSL PROJECT OR
+ * ITS CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
+ * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT
+ * NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;
+ * LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)
+ * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT,
+ * STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)
+ * ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED
+ * OF THE POSSIBILITY OF SUCH DAMAGE.
+ * ====================================================================
+ */
 
+/* socket-related functions used by s_client and s_server */
 #include &lt;stdio.h&gt;
 #include &lt;stdlib.h&gt;
 #include &lt;string.h&gt;
@@ -76,10 +122,8 @@ typedef unsigned int u_int;
 #endif
 
 #define USE_SOCKETS
-#define NON_MAIN
 #include &quot;apps.h&quot;
 #undef USE_SOCKETS
-#undef NON_MAIN
 #include &quot;s_apps.h&quot;
 #include &lt;openssl/ssl.h&gt;
 
@@ -185,7 +229,7 @@ static int ssl_sock_init(void)
             return (0);
         }
     }
-# endif                         /* OPENSSL_SYS_WINDOWS */
+# endif
     return (1);
 }
 
@@ -503,16 +547,6 @@ static int do_accept(int acc_sock, int *sock, char **host)
         return (0);
     }
 
-/*-
-    ling.l_onoff=1;
-    ling.l_linger=0;
-    i=setsockopt(ret,SOL_SOCKET,SO_LINGER,(char *)&amp;ling,sizeof(ling));
-    if (i &lt; 0) { perror(&quot;linger&quot;); return(0); }
-    i=0;
-    i=setsockopt(ret,SOL_SOCKET,SO_KEEPALIVE,(char *)&amp;i,sizeof(i));
-    if (i &lt; 0) { perror(&quot;keepalive&quot;); return(0); }
-*/
-
     if (host == NULL)
         goto end;
 # ifndef BIT_FIELD_LIMITS
@@ -580,7 +614,7 @@ static int do_accept_unix(int acc_sock, int *sock)
 # endif
 
 int extract_host_port(char *str, char **host_ptr, unsigned char *ip,
-                      short *port_ptr)
+                      unsigned short *port_ptr)
 {
     char *h, *p;
 
@@ -645,7 +679,7 @@ static int host_ip(const char *str, unsigned char ip[4])
     return (0);
 }
 
-int extract_port(const char *str, short *port_ptr)
+int extract_port(const char *str, unsigned short *port_ptr)
 {
     int i;
     struct servent *s;
diff --git a/apps/s_time.c b/apps/s_time.c
index 8f4980b..5bca72b 100644
--- a/apps/s_time.c
+++ b/apps/s_time.c
@@ -1,4 +1,3 @@
-/* apps/s_time.c */
 /* Copyright (C) 1995-1998 Eric Young (<A HREF="../../../mailman/listinfo/openssl-commits.html">eay at cryptsoft.com</A>)
  * All rights reserved.
  *
@@ -82,9 +81,6 @@
 # include OPENSSL_UNISTD
 #endif
 
-#undef PROG
-#define PROG s_time_main
-
 #undef ioctl
 #define ioctl ioctlsocket
 
@@ -107,286 +103,171 @@
 
 #undef SECONDS
 #define SECONDS 30
+#define SECONDSSTR &quot;30&quot;
+
 extern int verify_depth;
 extern int verify_error;
 
-static void s_time_usage(void);
-static int parseArgs(int argc, char **argv);
-static SSL *doConnection(SSL *scon);
-static void s_time_init(void);
-
-/***********************************************************************
- * Static data declarations
- */
+static SSL *doConnection(SSL *scon, const char *host, SSL_CTX *ctx);
 
-/* static char *port=PORT_STR;*/
-static char *host = SSL_CONNECT_NAME;
-static char *t_cert_file = NULL;
-static char *t_key_file = NULL;
-static char *CApath = NULL;
-static char *CAfile = NULL;
-static char *tm_cipher = NULL;
-static int tm_verify = SSL_VERIFY_NONE;
-static int maxTime = SECONDS;
-static SSL_CTX *tm_ctx = NULL;
-static const SSL_METHOD *s_time_meth = NULL;
-static char *s_www_path = NULL;
-static long bytes_read = 0;
-static int st_bugs = 0;
-static int perform = 0;
-#ifdef FIONBIO
-static int t_nbio = 0;
+typedef enum OPTION_choice {
+    OPT_ERR = -1, OPT_EOF = 0, OPT_HELP,
+    OPT_CONNECT, OPT_CIPHER, OPT_CERT, OPT_KEY, OPT_CAPATH,
+    OPT_CAFILE, OPT_NEW, OPT_REUSE, OPT_BUGS, OPT_VERIFY, OPT_TIME,
+#ifndef OPENSSL_NO_SSL3
+    OPT_SSL3,
 #endif
-#ifdef OPENSSL_SYS_WIN32
-static int exitNow = 0;         /* Set when it's time to exit main */
+    OPT_WWW
+} OPTION_CHOICE;
+
+OPTIONS s_time_options[] = {
+    {&quot;help&quot;, OPT_HELP, '-', &quot;Display this summary&quot;},
+    {&quot;connect&quot;, OPT_CONNECT, 's',
+     &quot;Where to connect as post:port (default is &quot; SSL_CONNECT_NAME &quot;)&quot;},
+    {&quot;cipher&quot;, OPT_CIPHER, 's', &quot;Cipher to use, see 'openssl ciphers'&quot;},
+    {&quot;cert&quot;, OPT_CERT, '&lt;', &quot;Cert file to use, PEM format assumed&quot;},
+    {&quot;key&quot;, OPT_KEY, '&lt;', &quot;File with key, PEM; default is -cert file&quot;},
+    {&quot;CApath&quot;, OPT_CAPATH, '/', &quot;PEM format directory of CA's&quot;},
+    {&quot;cafile&quot;, OPT_CAFILE, '&lt;', &quot;PEM format file of CA's&quot;},
+    {&quot;new&quot;, OPT_NEW, '-', &quot;Just time new connections&quot;},
+    {&quot;reuse&quot;, OPT_REUSE, '-', &quot;Just time connection reuse&quot;},
+    {&quot;bugs&quot;, OPT_BUGS, '-', &quot;Turn on SSL bug compatibility&quot;},
+    {&quot;verify&quot;, OPT_VERIFY, 'p',
+     &quot;Turn on peer certificate verification, set depth&quot;},
+    {&quot;time&quot;, OPT_TIME, 'p', &quot;Sf seconds to collect data, default&quot; SECONDSSTR},
+    {&quot;www&quot;, OPT_WWW, 's', &quot;Fetch specified page from the site&quot;},
+#ifndef OPENSSL_NO_SSL3
+    {&quot;ssl3&quot;, OPT_SSL3, '-', &quot;Just use SSLv3&quot;},
 #endif
+    {NULL}
+};
 
-static void s_time_init(void)
-{
-    host = SSL_CONNECT_NAME;
-    t_cert_file = NULL;
-    t_key_file = NULL;
-    CApath = NULL;
-    CAfile = NULL;
-    tm_cipher = NULL;
-    tm_verify = SSL_VERIFY_NONE;
-    maxTime = SECONDS;
-    tm_ctx = NULL;
-    s_time_meth = NULL;
-    s_www_path = NULL;
-    bytes_read = 0;
-    st_bugs = 0;
-    perform = 0;
-
-#ifdef FIONBIO
-    t_nbio = 0;
-#endif
-#ifdef OPENSSL_SYS_WIN32
-    exitNow = 0;                /* Set when it's time to exit main */
-#endif
-}
+#define START   0
+#define STOP    1
 
-/***********************************************************************
- * usage - display usage message
- */
-static void s_time_usage(void)
+static double tm_Time_F(int s)
 {
-    static char umsg[] = &quot;\
--time arg     - max number of seconds to collect data, default %d\n\
--verify arg   - turn on peer certificate verification, arg == depth\n\
--cert arg     - certificate file to use, PEM format assumed\n\
--key arg      - RSA file to use, PEM format assumed, key is in cert file\n\
-                file if not specified by this option\n\
--CApath arg   - PEM format directory of CA's\n\
--CAfile arg   - PEM format file of CA's\n\
--cipher       - preferred cipher to use, play with 'openssl ciphers'\n\n&quot;;
-
-    printf(&quot;usage: s_time &lt;args&gt;\n\n&quot;);
-
-    printf(&quot;-connect host:port - host:port to connect to (default is %s)\n&quot;,
-           SSL_CONNECT_NAME);
-#ifdef FIONBIO
-    printf(&quot;-nbio         - Run with non-blocking IO\n&quot;);
-    printf(&quot;-ssl3         - Just use SSLv3\n&quot;);
-    printf(&quot;-bugs         - Turn on SSL bug compatibility\n&quot;);
-    printf(&quot;-new          - Just time new connections\n&quot;);
-    printf(&quot;-reuse        - Just time connection reuse\n&quot;);
-    printf(&quot;-www page     - Retrieve 'page' from the site\n&quot;);
-#endif
-    printf(umsg, SECONDS);
+    return app_tminterval(s, 1);
 }
 
-/***********************************************************************
- * parseArgs - Parse command line arguments and initialize data
- *
- * Returns 0 if ok, -1 on bad args
- */
-static int parseArgs(int argc, char **argv)
+int s_time_main(int argc, char **argv)
 {
-    int badop = 0;
+    char buf[1024 * 8];
+    SSL *scon = NULL;
+    SSL_CTX *ctx = NULL;
+    const SSL_METHOD *meth = NULL;
+    char *CApath = NULL, *CAfile = NULL, *cipher = NULL, *www_path = NULL;
+    char *host = SSL_CONNECT_NAME, *certfile = NULL, *keyfile = NULL, *prog;
+    double totalTime = 0.0;
+    int maxtime = SECONDS, nConn = 0, perform = 3, ret = 1, i, st_bugs =
+        0, ver;
+    long bytes_read = 0, finishtime = 0;
+    OPTION_CHOICE o;
+#ifdef OPENSSL_SYS_WIN32
+    int exitNow = 0;            /* Set when it's time to exit main */
+#endif
 
+    meth = SSLv23_client_method();
     verify_depth = 0;
     verify_error = X509_V_OK;
 
-    argc--;
-    argv++;
-
-    while (argc &gt;= 1) {
-        if (strcmp(*argv, &quot;-connect&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            host = *(++argv);
-        }
-        else if (strcmp(*argv, &quot;-reuse&quot;) == 0)
+    prog = opt_init(argc, argv, s_time_options);
+    while ((o = opt_next()) != OPT_EOF) {
+        switch (o) {
+        case OPT_EOF:
+        case OPT_ERR:
+ opthelp:
+            BIO_printf(bio_err, &quot;%s: Use -help for summary.\n&quot;, prog);
+            goto end;
+        case OPT_HELP:
+            opt_help(s_time_options);
+            ret = 0;
+            goto end;
+        case OPT_CONNECT:
+            host = opt_arg();
+            break;
+        case OPT_REUSE:
             perform = 2;
-        else if (strcmp(*argv, &quot;-new&quot;) == 0)
+            break;
+        case OPT_NEW:
             perform = 1;
-        else if (strcmp(*argv, &quot;-verify&quot;) == 0) {
-
-            tm_verify = SSL_VERIFY_PEER | SSL_VERIFY_CLIENT_ONCE;
-            if (--argc &lt; 1)
-                goto bad;
-            verify_depth = atoi(*(++argv));
-            BIO_printf(bio_err, &quot;verify depth is %d\n&quot;, verify_depth);
-
-        } else if (strcmp(*argv, &quot;-cert&quot;) == 0) {
-
-            if (--argc &lt; 1)
-                goto bad;
-            t_cert_file = *(++argv);
-
-        } else if (strcmp(*argv, &quot;-key&quot;) == 0) {
-
-            if (--argc &lt; 1)
-                goto bad;
-            t_key_file = *(++argv);
-
-        } else if (strcmp(*argv, &quot;-CApath&quot;) == 0) {
-
-            if (--argc &lt; 1)
-                goto bad;
-            CApath = *(++argv);
-
-        } else if (strcmp(*argv, &quot;-CAfile&quot;) == 0) {
-
-            if (--argc &lt; 1)
-                goto bad;
-            CAfile = *(++argv);
-
-        } else if (strcmp(*argv, &quot;-cipher&quot;) == 0) {
-
-            if (--argc &lt; 1)
-                goto bad;
-            tm_cipher = *(++argv);
-        }
-#ifdef FIONBIO
-        else if (strcmp(*argv, &quot;-nbio&quot;) == 0) {
-            t_nbio = 1;
-        }
-#endif
-        else if (strcmp(*argv, &quot;-www&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            s_www_path = *(++argv);
-            if (strlen(s_www_path) &gt; MYBUFSIZ - 100) {
-                BIO_printf(bio_err, &quot;-www option too long\n&quot;);
-                badop = 1;
-            }
-        } else if (strcmp(*argv, &quot;-bugs&quot;) == 0)
+            break;
+        case OPT_VERIFY:
+            if (!opt_int(opt_arg(), &amp;verify_depth))
+                goto opthelp;
+            BIO_printf(bio_err, &quot;%s: verify depth is %d\n&quot;,
+                       prog, verify_depth);
+            break;
+        case OPT_CERT:
+            certfile = opt_arg();
+            break;
+        case OPT_KEY:
+            keyfile = opt_arg();
+            break;
+        case OPT_CAPATH:
+            CApath = opt_arg();
+            break;
+        case OPT_CAFILE:
+            CAfile = opt_arg();
+            break;
+        case OPT_CIPHER:
+            cipher = opt_arg();
+            break;
+        case OPT_BUGS:
             st_bugs = 1;
-#ifndef OPENSSL_NO_SSL3
-        else if (strcmp(*argv, &quot;-ssl3&quot;) == 0)
-            s_time_meth = SSLv3_client_method();
-#endif
-        else if (strcmp(*argv, &quot;-time&quot;) == 0) {
-
-            if (--argc &lt; 1)
-                goto bad;
-            maxTime = atoi(*(++argv));
-            if (maxTime &lt;= 0) {
-                BIO_printf(bio_err, &quot;time must be &gt; 0\n&quot;);
-                badop = 1;
+            break;
+        case OPT_TIME:
+            if (!opt_int(opt_arg(), &amp;maxtime))
+                goto opthelp;
+            break;
+        case OPT_WWW:
+            www_path = opt_arg();
+            if (strlen(www_path) &gt; MYBUFSIZ - 100) {
+                BIO_printf(bio_err, &quot;%s: -www option too long\n&quot;, prog);
+                goto end;
             }
-        } else {
-            BIO_printf(bio_err, &quot;unknown option %s\n&quot;, *argv);
-            badop = 1;
             break;
+#ifndef OPENSSL_NO_SSL3
+        case OPT_SSL3:
+            meth = SSLv3_client_method();
+            break;
+#endif
         }
-
-        argc--;
-        argv++;
     }
+    argc = opt_num_rest();
+    argv = opt_rest();
 
-    if (perform == 0)
-        perform = 3;
-
-    if (badop) {
- bad:
-        s_time_usage();
-        return -1;
+    if (cipher == NULL)
+        cipher = getenv(&quot;SSL_CIPHER&quot;);
+    if (cipher == NULL) {
+        fprintf(stderr, &quot;No CIPHER specified\n&quot;);
+        goto end;
     }
 
-    return 0;                   /* Valid args */
-}
-
-/***********************************************************************
- * TIME - time functions
- */
-#define START   0
-#define STOP    1
-
-static double tm_Time_F(int s)
-{
-    return app_tminterval(s, 1);
-}
-
-/***********************************************************************
- * MAIN - main processing area for client
- *                      real name depends on MONOLITH
- */
-int MAIN(int, char **);
-
-int MAIN(int argc, char **argv)
-{
-    double totalTime = 0.0;
-    int nConn = 0;
-    SSL *scon = NULL;
-    long finishtime = 0;
-    int ret = 1, i;
-    char buf[1024 * 8];
-    int ver;
-
-    apps_startup();
-    s_time_init();
-
-    if (bio_err == NULL)
-        bio_err = BIO_new_fp(stderr, BIO_NOCLOSE);
-
-    s_time_meth = SSLv23_client_method();
-
-    /* parse the command line arguments */
-    if (parseArgs(argc, argv) &lt; 0)
+    if ((ctx = SSL_CTX_new(meth)) == NULL)
         goto end;
 
-    OpenSSL_add_ssl_algorithms();
-    if ((tm_ctx = SSL_CTX_new(s_time_meth)) == NULL)
-        return (1);
-
-    SSL_CTX_set_quiet_shutdown(tm_ctx, 1);
+    SSL_CTX_set_quiet_shutdown(ctx, 1);
 
     if (st_bugs)
-        SSL_CTX_set_options(tm_ctx, SSL_OP_ALL);
-    if (!SSL_CTX_set_cipher_list(tm_ctx, tm_cipher))
+        SSL_CTX_set_options(ctx, SSL_OP_ALL);
+    if (!SSL_CTX_set_cipher_list(ctx, cipher))
         goto end;
-    if (!set_cert_stuff(tm_ctx, t_cert_file, t_key_file))
+    if (!set_cert_stuff(ctx, certfile, keyfile))
         goto end;
 
-    SSL_load_error_strings();
-
-    if ((!SSL_CTX_load_verify_locations(tm_ctx, CAfile, CApath)) ||
-        (!SSL_CTX_set_default_verify_paths(tm_ctx))) {
-        /*
-         * BIO_printf(bio_err,&quot;error setting default verify locations\n&quot;);
-         */
+    if (!ctx_set_verify_locations(ctx, CAfile, CApath)) {
         ERR_print_errors(bio_err);
-        /* goto end; */
-    }
-
-    if (tm_cipher == NULL)
-        tm_cipher = getenv(&quot;SSL_CIPHER&quot;);
-
-    if (tm_cipher == NULL) {
-        fprintf(stderr, &quot;No CIPHER specified\n&quot;);
+        goto end;
     }
-
     if (!(perform &amp; 1))
         goto next;
-    printf(&quot;Collecting connection statistics for %d seconds\n&quot;, maxTime);
+    printf(&quot;Collecting connection statistics for %d seconds\n&quot;, maxtime);
 
     /* Loop and time how long it takes to make connections */
 
     bytes_read = 0;
-    finishtime = (long)time(NULL) + maxTime;
+    finishtime = (long)time(NULL) + maxtime;
     tm_Time_F(START);
     for (;;) {
         if (finishtime &lt; (long)time(NULL))
@@ -400,12 +281,12 @@ int MAIN(int argc, char **argv)
             goto end;
 #endif
 
-        if ((scon = doConnection(NULL)) == NULL)
+        if ((scon = doConnection(NULL, host, ctx)) == NULL)
             goto end;
 
-        if (s_www_path != NULL) {
+        if (www_path != NULL) {
             BIO_snprintf(buf, sizeof buf, &quot;GET %s HTTP/1.0\r\n\r\n&quot;,
-                         s_www_path);
+                         www_path);
             if (SSL_write(scon, buf, strlen(buf)) &lt;= 0)
                 goto end;
             while ((i = SSL_read(scon, buf, sizeof(buf))) &gt; 0)
@@ -438,13 +319,13 @@ int MAIN(int argc, char **argv)
     }
     totalTime += tm_Time_F(STOP); /* Add the time for this iteration */
 
-    i = (int)((long)time(NULL) - finishtime + maxTime);
+    i = (int)((long)time(NULL) - finishtime + maxtime);
     printf
         (&quot;\n\n%d connections in %.2fs; %.2f connections/user sec, bytes read %ld\n&quot;,
          nConn, totalTime, ((double)nConn / totalTime), bytes_read);
     printf
         (&quot;%d connections in %ld real seconds, %ld bytes read per connection\n&quot;,
-         nConn, (long)time(NULL) - finishtime + maxTime, bytes_read / nConn);
+         nConn, (long)time(NULL) - finishtime + maxtime, bytes_read / nConn);
 
     /*
      * Now loop and time connections using the same session id over and over
@@ -456,16 +337,17 @@ int MAIN(int argc, char **argv)
     printf(&quot;\n\nNow timing with session id reuse.\n&quot;);
 
     /* Get an SSL object so we can reuse the session id */
-    if ((scon = doConnection(NULL)) == NULL) {
+    if ((scon = doConnection(NULL, host, ctx)) == NULL) {
         fprintf(stderr, &quot;Unable to get connection\n&quot;);
         goto end;
     }
 
-    if (s_www_path != NULL) {
-        BIO_snprintf(buf, sizeof buf, &quot;GET %s HTTP/1.0\r\n\r\n&quot;, s_www_path);
+    if (www_path != NULL) {
+        BIO_snprintf(buf, sizeof buf, &quot;GET %s HTTP/1.0\r\n\r\n&quot;, www_path);
         if (SSL_write(scon, buf, strlen(buf)) &lt;= 0)
             goto end;
-        while (SSL_read(scon, buf, sizeof(buf)) &gt; 0) ;
+        while (SSL_read(scon, buf, sizeof(buf)) &gt; 0)
+            continue;
     }
 #ifdef NO_SHUTDOWN
     SSL_set_shutdown(scon, SSL_SENT_SHUTDOWN | SSL_RECEIVED_SHUTDOWN);
@@ -477,7 +359,7 @@ int MAIN(int argc, char **argv)
     nConn = 0;
     totalTime = 0.0;
 
-    finishtime = (long)time(NULL) + maxTime;
+    finishtime = (long)time(NULL) + maxtime;
 
     printf(&quot;starting\n&quot;);
     bytes_read = 0;
@@ -495,12 +377,12 @@ int MAIN(int argc, char **argv)
             goto end;
 #endif
 
-        if ((doConnection(scon)) == NULL)
+        if ((doConnection(scon, host, ctx)) == NULL)
             goto end;
 
-        if (s_www_path) {
+        if (www_path) {
             BIO_snprintf(buf, sizeof buf, &quot;GET %s HTTP/1.0\r\n\r\n&quot;,
-                         s_www_path);
+                         www_path);
             if (SSL_write(scon, buf, strlen(buf)) &lt;= 0)
                 goto end;
             while ((i = SSL_read(scon, buf, sizeof(buf))) &gt; 0)
@@ -535,27 +417,20 @@ int MAIN(int argc, char **argv)
          nConn, totalTime, ((double)nConn / totalTime), bytes_read);
     printf
         (&quot;%d connections in %ld real seconds, %ld bytes read per connection\n&quot;,
-         nConn, (long)time(NULL) - finishtime + maxTime,
-         bytes_read / (nConn?nConn:1));
+         nConn, (long)time(NULL) - finishtime + maxtime, bytes_read / nConn);
 
     ret = 0;
+
  end:
     SSL_free(scon);
-
-    SSL_CTX_free(tm_ctx);
-    tm_ctx = NULL;
-    apps_shutdown();
-    OPENSSL_EXIT(ret);
+    SSL_CTX_free(ctx);
+    return (ret);
 }
 
 /*-
  * doConnection - make a connection
- * Args:
- *              scon    = earlier ssl connection for session id, or NULL
- * Returns:
- *              SSL *   = the connection pointer.
  */
-static SSL *doConnection(SSL *scon)
+static SSL *doConnection(SSL *scon, const char *host, SSL_CTX *ctx)
 {
     BIO *conn;
     SSL *serverCon;
@@ -565,11 +440,10 @@ static SSL *doConnection(SSL *scon)
     if ((conn = BIO_new(BIO_s_connect())) == NULL)
         return (NULL);
 
-/*      BIO_set_conn_port(conn,port);*/
     BIO_set_conn_hostname(conn, host);
 
     if (scon == NULL)
-        serverCon = SSL_new(tm_ctx);
+        serverCon = SSL_new(ctx);
     else {
         serverCon = scon;
         SSL_set_connect_state(serverCon);
diff --git a/apps/sess_id.c b/apps/sess_id.c
index 9421e40..cfecd86 100644
--- a/apps/sess_id.c
+++ b/apps/sess_id.c
@@ -1,4 +1,3 @@
-/* apps/sess_id.c */
 /* Copyright (C) 1995-1998 Eric Young (<A HREF="../../../mailman/listinfo/openssl-commits.html">eay at cryptsoft.com</A>)
  * All rights reserved.
  *
@@ -66,94 +65,81 @@
 #include &lt;openssl/pem.h&gt;
 #include &lt;openssl/ssl.h&gt;
 
-#undef PROG
-#define PROG    sess_id_main
-
-static const char *sess_id_usage[] = {
-    &quot;usage: sess_id args\n&quot;,
-    &quot;\n&quot;,
-    &quot; -inform arg     - input format - default PEM (DER or PEM)\n&quot;,
-    &quot; -outform arg    - output format - default PEM (PEM, DER or NSS)\n&quot;,
-    &quot; -in arg         - input file - default stdin\n&quot;,
-    &quot; -out arg        - output file - default stdout\n&quot;,
-    &quot; -text           - print ssl session id details\n&quot;,
-    &quot; -cert           - output certificate \n&quot;,
-    &quot; -noout          - no output of encoded session info\n&quot;,
-    &quot; -context arg    - set the session ID context\n&quot;,
-    NULL
+typedef enum OPTION_choice {
+    OPT_ERR = -1, OPT_EOF = 0, OPT_HELP,
+    OPT_INFORM, OPT_OUTFORM, OPT_IN, OPT_OUT,
+    OPT_TEXT, OPT_CERT, OPT_NOOUT, OPT_CONTEXT
+} OPTION_CHOICE;
+
+OPTIONS sess_id_options[] = {
+    {&quot;help&quot;, OPT_HELP, '-', &quot;Display this summary&quot;},
+    {&quot;inform&quot;, OPT_INFORM, 'F', &quot;Input format - default PEM (DER or PEM)&quot;},
+    {&quot;outform&quot;, OPT_OUTFORM, 'F',
+     &quot;Output format - default PEM (PEM, DER or NSS)&quot;},
+    {&quot;in&quot;, OPT_IN, 's', &quot;Input file - default stdin&quot;},
+    {&quot;out&quot;, OPT_OUT, 's', &quot;Output file - default stdout&quot;},
+    {&quot;text&quot;, OPT_TEXT, '-', &quot;Print ssl session id details&quot;},
+    {&quot;cert&quot;, OPT_CERT, '-', &quot;Output certificate &quot;},
+    {&quot;noout&quot;, OPT_NOOUT, '-', &quot;Don't output the encoded session info&quot;},
+    {&quot;context&quot;, OPT_CONTEXT, 's', &quot;Set the session ID context&quot;},
+    {NULL}
 };
 
 static SSL_SESSION *load_sess_id(char *file, int format);
 
-int MAIN(int, char **);
-
-int MAIN(int argc, char **argv)
+int sess_id_main(int argc, char **argv)
 {
     SSL_SESSION *x = NULL;
     X509 *peer = NULL;
-    int ret = 1, i, num, badops = 0;
     BIO *out = NULL;
-    int informat, outformat;
-    char *infile = NULL, *outfile = NULL, *context = NULL;
-    int cert = 0, noout = 0, text = 0;
-    const char **pp;
-
-    apps_startup();
-
-    if (bio_err == NULL)
-        if ((bio_err = BIO_new(BIO_s_file())) != NULL)
-            BIO_set_fp(bio_err, stderr, BIO_NOCLOSE | BIO_FP_TEXT);
-
-    informat = FORMAT_PEM;
-    outformat = FORMAT_PEM;
-
-    argc--;
-    argv++;
-    num = 0;
-    while (argc &gt;= 1) {
-        if (strcmp(*argv, &quot;-inform&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            informat = str2fmt(*(++argv));
-        } else if (strcmp(*argv, &quot;-outform&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            outformat = str2fmt(*(++argv));
-        } else if (strcmp(*argv, &quot;-in&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            infile = *(++argv);
-        } else if (strcmp(*argv, &quot;-out&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            outfile = *(++argv);
-        } else if (strcmp(*argv, &quot;-text&quot;) == 0)
+    char *infile = NULL, *outfile = NULL, *context = NULL, *prog;
+    int informat = FORMAT_PEM, outformat = FORMAT_PEM;
+    int cert = 0, noout = 0, text = 0, ret = 1, i, num = 0;
+    OPTION_CHOICE o;
+
+    prog = opt_init(argc, argv, sess_id_options);
+    while ((o = opt_next()) != OPT_EOF) {
+        switch (o) {
+        case OPT_EOF:
+        case OPT_ERR:
+ opthelp:
+            BIO_printf(bio_err, &quot;%s: Use -help for summary.\n&quot;, prog);
+            goto end;
+        case OPT_HELP:
+            opt_help(sess_id_options);
+            ret = 0;
+            goto end;
+        case OPT_INFORM:
+            if (!opt_format(opt_arg(), OPT_FMT_PEMDER, &amp;informat))
+                goto opthelp;
+            break;
+        case OPT_OUTFORM:
+            if (!opt_format(opt_arg(), OPT_FMT_PEMDER, &amp;outformat))
+                goto opthelp;
+            break;
+        case OPT_IN:
+            infile = opt_arg();
+            break;
+        case OPT_OUT:
+            outfile = opt_arg();
+            break;
+        case OPT_TEXT:
             text = ++num;
-        else if (strcmp(*argv, &quot;-cert&quot;) == 0)
+            break;
+        case OPT_CERT:
             cert = ++num;
-        else if (strcmp(*argv, &quot;-noout&quot;) == 0)
+            break;
+        case OPT_NOOUT:
             noout = ++num;
-        else if (strcmp(*argv, &quot;-context&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            context = *++argv;
-        } else {
-            BIO_printf(bio_err, &quot;unknown option %s\n&quot;, *argv);
-            badops = 1;
+            break;
+        case OPT_CONTEXT:
+            context = opt_arg();
             break;
         }
-        argc--;
-        argv++;
     }
+    argc = opt_num_rest();
+    argv = opt_rest();
 
-    if (badops) {
- bad:
-        for (pp = sess_id_usage; (*pp != NULL); pp++)
-            BIO_printf(bio_err, &quot;%s&quot;, *pp);
-        goto end;
-    }
-
-    ERR_load_crypto_strings();
     x = load_sess_id(infile, informat);
     if (x == NULL) {
         goto end;
@@ -166,33 +152,20 @@ int MAIN(int argc, char **argv)
             BIO_printf(bio_err, &quot;Context too long\n&quot;);
             goto end;
         }
-        if (!SSL_SESSION_set1_id_context(x, (unsigned char *)context, ctx_len)) {
+        if (!SSL_SESSION_set1_id_context(x, (unsigned char *)context,
+                    ctx_len)) {
             BIO_printf(bio_err, &quot;Error setting id context\n&quot;);
             goto end;
         }
     }
 
     if (!noout || text) {
-        out = BIO_new(BIO_s_file());
-        if (out == NULL) {
-            ERR_print_errors(bio_err);
+        const char* modeflag = &quot;w&quot;;
+        if (outformat == FORMAT_ASN1 || outformat == FORMAT_NSS)
+            modeflag = &quot;wb&quot;;
+        out = bio_open_default(outfile, modeflag);
+        if (out == NULL)
             goto end;
-        }
-
-        if (outfile == NULL) {
-            BIO_set_fp(out, stdout, BIO_NOCLOSE);
-#ifdef OPENSSL_SYS_VMS
-            {
-                BIO *tmpbio = BIO_new(BIO_f_linebuffer());
-                out = BIO_push(tmpbio, out);
-            }
-#endif
-        } else {
-            if (BIO_write_filename(out, outfile) &lt;= 0) {
-                perror(outfile);
-                goto end;
-            }
-        }
     }
 
     if (text) {
@@ -240,8 +213,7 @@ int MAIN(int argc, char **argv)
     BIO_free_all(out);
     if (x != NULL)
         SSL_SESSION_free(x);
-    apps_shutdown();
-    OPENSSL_EXIT(ret);
+    return (ret);
 }
 
 static SSL_SESSION *load_sess_id(char *infile, int format)
@@ -249,28 +221,13 @@ static SSL_SESSION *load_sess_id(char *infile, int format)
     SSL_SESSION *x = NULL;
     BIO *in = NULL;
 
-    in = BIO_new(BIO_s_file());
-    if (in == NULL) {
-        ERR_print_errors(bio_err);
+    in = bio_open_default(infile, RB(format));
+    if (in == NULL)
         goto end;
-    }
-
-    if (infile == NULL)
-        BIO_set_fp(in, stdin, BIO_NOCLOSE);
-    else {
-        if (BIO_read_filename(in, infile) &lt;= 0) {
-            perror(infile);
-            goto end;
-        }
-    }
     if (format == FORMAT_ASN1)
         x = d2i_SSL_SESSION_bio(in, NULL);
-    else if (format == FORMAT_PEM)
+    else
         x = PEM_read_bio_SSL_SESSION(in, NULL, NULL, NULL);
-    else {
-        BIO_printf(bio_err, &quot;bad input format specified for input crl\n&quot;);
-        goto end;
-    }
     if (x == NULL) {
         BIO_printf(bio_err, &quot;unable to load SSL_SESSION\n&quot;);
         ERR_print_errors(bio_err);
diff --git a/apps/smime.c b/apps/smime.c
index 930978f..532446f 100644
--- a/apps/smime.c
+++ b/apps/smime.c
@@ -1,4 +1,3 @@
-/* smime.c */
 /*
  * Written by Dr Stephen N Henson (<A HREF="../../../mailman/listinfo/openssl-commits.html">steve at openssl.org</A>) for the OpenSSL
  * project.
@@ -68,8 +67,6 @@
 #include &lt;openssl/x509_vfy.h&gt;
 #include &lt;openssl/x509v3.h&gt;
 
-#undef PROG
-#define PROG smime_main
 static int save_certs(char *signerfile, STACK_OF(X509) *signers);
 static int smime_cb(int ok, X509_STORE_CTX *ctx);
 
@@ -83,277 +80,315 @@ static int smime_cb(int ok, X509_STORE_CTX *ctx);
 #define SMIME_PK7OUT    (5 | SMIME_IP | SMIME_OP)
 #define SMIME_RESIGN    (6 | SMIME_IP | SMIME_OP | SMIME_SIGNERS)
 
-int MAIN(int, char **);
+typedef enum OPTION_choice {
+    OPT_ERR = -1, OPT_EOF = 0, OPT_HELP,
+    OPT_ENCRYPT, OPT_DECRYPT, OPT_SIGN, OPT_RESIGN, OPT_VERIFY,
+    OPT_PK7OUT, OPT_TEXT, OPT_NOINTERN, OPT_NOVERIFY, OPT_NOCHAIN,
+    OPT_NOCERTS, OPT_NOATTR, OPT_NODETACH, OPT_NOSMIMECAP,
+    OPT_BINARY, OPT_NOSIGS, OPT_STREAM, OPT_INDEF, OPT_NOINDEF,
+    OPT_NOOLDMIME, OPT_CRLFEOL, OPT_RAND, OPT_ENGINE, OPT_PASSIN,
+    OPT_TO, OPT_FROM, OPT_SUBJECT, OPT_SIGNER, OPT_RECIP, OPT_MD,
+    OPT_CIPHER, OPT_INKEY, OPT_KEYFORM, OPT_CERTFILE, OPT_CAFILE,
+    OPT_V_ENUM,
+    OPT_CAPATH, OPT_IN, OPT_INFORM, OPT_OUT, OPT_OUTFORM, OPT_CONTENT
+} OPTION_CHOICE;
+
+OPTIONS smime_options[] = {
+    {OPT_HELP_STR, 1, '-', &quot;Usage: %s [options] cert.pem...\n&quot;},
+    {OPT_HELP_STR, 1, '-',
+        &quot;  cert.pem... recipient certs for encryption\n&quot;},
+    {OPT_HELP_STR, 1, '-', &quot;Valid options are:\n&quot;},
+    {&quot;help&quot;, OPT_HELP, '-', &quot;Display this summary&quot;},
+    {&quot;encrypt&quot;, OPT_ENCRYPT, '-', &quot;Encrypt message&quot;},
+    {&quot;decrypt&quot;, OPT_DECRYPT, '-', &quot;Decrypt encrypted message&quot;},
+    {&quot;sign&quot;, OPT_SIGN, '-', &quot;Sign message&quot;},
+    {&quot;verify&quot;, OPT_VERIFY, '-', &quot;Verify signed message&quot;},
+    {&quot;pk7out&quot;, OPT_PK7OUT, '-', &quot;Output PKCS#7 structure&quot;},
+    {&quot;nointern&quot;, OPT_NOINTERN, '-',
+     &quot;Don't search certificates in message for signer&quot;},
+    {&quot;nosigs&quot;, OPT_NOSIGS, '-', &quot;Don't verify message signature&quot;},
+    {&quot;noverify&quot;, OPT_NOVERIFY, '-', &quot;Don't verify signers certificate&quot;},
+    {&quot;nocerts&quot;, OPT_NOCERTS, '-',
+     &quot;Don't include signers certificate when signing&quot;},
+    {&quot;nodetach&quot;, OPT_NODETACH, '-', &quot;Use opaque signing&quot;},
+    {&quot;noattr&quot;, OPT_NOATTR, '-', &quot;Don't include any signed attributes&quot;},
+    {&quot;binary&quot;, OPT_BINARY, '-', &quot;Don't translate message to text&quot;},
+    {&quot;certfile&quot;, OPT_CERTFILE, '&lt;', &quot;Other certificates file&quot;},
+    {&quot;signer&quot;, OPT_SIGNER, '&lt;', &quot;Signer certificate file&quot;},
+    {&quot;recip&quot;, OPT_RECIP, '&lt;', &quot;Recipient certificate file for decryption&quot;},
+    {&quot;in&quot;, OPT_IN, '&lt;', &quot;Input file&quot;},
+    {&quot;inform&quot;, OPT_INFORM, 'F', &quot;Input format SMIME (default), PEM or DER&quot;},
+    {&quot;inkey&quot;, OPT_INKEY, '&lt;',
+     &quot;Input private key (if not signer or recipient)&quot;},
+    {&quot;keyform&quot;, OPT_KEYFORM, 'f', &quot;Input private key format (PEM or ENGINE)&quot;},
+    {&quot;out&quot;, OPT_OUT, '&gt;', &quot;Output file&quot;},
+    {&quot;outform&quot;, OPT_OUTFORM, 'F',
+     &quot;Output format SMIME (default), PEM or DER&quot;},
+    {&quot;content&quot;, OPT_CONTENT, '&lt;',
+     &quot;Supply or override content for detached signature&quot;},
+    {&quot;to&quot;, OPT_TO, 's', &quot;To address&quot;},
+    {&quot;from&quot;, OPT_FROM, 's', &quot;From address&quot;},
+    {&quot;subject&quot;, OPT_SUBJECT, 's', &quot;Subject&quot;},
+    {&quot;text&quot;, OPT_TEXT, '-', &quot;Include or delete text MIME headers&quot;},
+    {&quot;CApath&quot;, OPT_CAPATH, '/', &quot;Trusted certificates directory&quot;},
+    {&quot;CAfile&quot;, OPT_CAFILE, '&lt;', &quot;Trusted certificates file&quot;},
+    {&quot;resign&quot;, OPT_RESIGN, '-'},
+    {&quot;nochain&quot;, OPT_NOCHAIN, '-'},
+    {&quot;nosmimecap&quot;, OPT_NOSMIMECAP, '-'},
+    {&quot;stream&quot;, OPT_STREAM, '-'},
+    {&quot;indef&quot;, OPT_INDEF, '-'},
+    {&quot;noindef&quot;, OPT_NOINDEF, '-'},
+    {&quot;nooldmime&quot;, OPT_NOOLDMIME, '-'},
+    {&quot;crlfeol&quot;, OPT_CRLFEOL, '-'},
+    {&quot;rand&quot;, OPT_RAND, 's',
+     &quot;Load the file(s) into the random number generator&quot;},
+    {&quot;passin&quot;, OPT_PASSIN, 's', &quot;Input file pass phrase source&quot;},
+    {&quot;md&quot;, OPT_MD, 's'},
+    {&quot;&quot;, OPT_CIPHER, '-', &quot;Any supported cipher&quot;},
+    OPT_V_OPTIONS,
+#ifndef OPENSSL_NO_ENGINE
+    {&quot;engine&quot;, OPT_ENGINE, 's', &quot;Use engine, possibly a hardware device&quot;},
+#endif
+    {NULL}
+};
 
-int MAIN(int argc, char **argv)
+int smime_main(int argc, char **argv)
 {
-    ENGINE *e = NULL;
-    int operation = 0;
-    int ret = 0;
-    char **args;
-    const char *inmode = &quot;r&quot;, *outmode = &quot;w&quot;;
-    char *infile = NULL, *outfile = NULL;
-    char *signerfile = NULL, *recipfile = NULL;
-    STACK_OF(OPENSSL_STRING) *sksigners = NULL, *skkeys = NULL;
-    char *certfile = NULL, *keyfile = NULL, *contfile = NULL;
-    const EVP_CIPHER *cipher = NULL;
-    PKCS7 *p7 = NULL;
-    X509_STORE *store = NULL;
-    X509 *cert = NULL, *recip = NULL, *signer = NULL;
+    BIO *in = NULL, *out = NULL, *indata = NULL;
     EVP_PKEY *key = NULL;
+    PKCS7 *p7 = NULL;
+    STACK_OF(OPENSSL_STRING) *sksigners = NULL, *skkeys = NULL;
     STACK_OF(X509) *encerts = NULL, *other = NULL;
-    BIO *in = NULL, *out = NULL, *indata = NULL;
-    int badarg = 0;
-    int flags = PKCS7_DETACHED;
-    char *to = NULL, *from = NULL, *subject = NULL;
-    char *CAfile = NULL, *CApath = NULL;
-    char *passargin = NULL, *passin = NULL;
-    char *inrand = NULL;
-    int need_rand = 0;
-    int indef = 0;
+    X509 *cert = NULL, *recip = NULL, *signer = NULL;
+    X509_STORE *store = NULL;
+    X509_VERIFY_PARAM *vpm = NULL;
+    const EVP_CIPHER *cipher = NULL;
     const EVP_MD *sign_md = NULL;
-    int informat = FORMAT_SMIME, outformat = FORMAT_SMIME;
-    int keyform = FORMAT_PEM;
+    char *CAfile = NULL, *CApath = NULL, *inrand = NULL, *engine = NULL;
+    char *certfile = NULL, *keyfile = NULL, *contfile = NULL, *prog;
+    char *infile = NULL, *outfile = NULL, *signerfile = NULL, *recipfile =
+        NULL;
+    char *passinarg = NULL, *passin = NULL, *to = NULL, *from =
+        NULL, *subject = NULL;
+    const char *inmode = &quot;r&quot;, *outmode = &quot;w&quot;;
+    OPTION_CHOICE o;
+    int flags = PKCS7_DETACHED, operation = 0, ret = 0, need_rand = 0, indef =
+        0;
+    int informat = FORMAT_SMIME, outformat = FORMAT_SMIME, keyform =
+        FORMAT_PEM;
+    int vpmtouched = 0, rv = 0;
 #ifndef OPENSSL_NO_ENGINE
-    char *engine = NULL;
+    ENGINE *e = NULL;
 #endif
 
-    X509_VERIFY_PARAM *vpm = NULL;
-
-    args = argv + 1;
-    ret = 1;
-
-    apps_startup();
-
-    if (bio_err == NULL) {
-        if ((bio_err = BIO_new(BIO_s_file())) != NULL)
-            BIO_set_fp(bio_err, stderr, BIO_NOCLOSE | BIO_FP_TEXT);
-    }
-
-    if (!load_config(bio_err, NULL))
-        goto end;
+    if ((vpm = X509_VERIFY_PARAM_new()) == NULL)
+        return 1;
 
-    while (!badarg &amp;&amp; *args &amp;&amp; *args[0] == '-') {
-        if (!strcmp(*args, &quot;-encrypt&quot;))
+    prog = opt_init(argc, argv, smime_options);
+    while ((o = opt_next()) != OPT_EOF) {
+        switch (o) {
+        case OPT_EOF:
+        case OPT_ERR:
+ opthelp:
+            BIO_printf(bio_err, &quot;%s: Use -help for summary.\n&quot;, prog);
+            goto end;
+        case OPT_HELP:
+            opt_help(smime_options);
+            ret = 0;
+            goto end;
+        case OPT_INFORM:
+            if (!opt_format(opt_arg(), OPT_FMT_PEMDER, &amp;informat))
+                goto opthelp;
+            break;
+        case OPT_IN:
+            infile = opt_arg();
+            break;
+        case OPT_OUTFORM:
+            if (!opt_format(opt_arg(), OPT_FMT_PEMDER, &amp;outformat))
+                goto opthelp;
+            break;
+        case OPT_OUT:
+            outfile = opt_arg();
+            break;
+        case OPT_ENCRYPT:
             operation = SMIME_ENCRYPT;
-        else if (!strcmp(*args, &quot;-decrypt&quot;))
+            break;
+        case OPT_DECRYPT:
             operation = SMIME_DECRYPT;
-        else if (!strcmp(*args, &quot;-sign&quot;))
+            break;
+        case OPT_SIGN:
             operation = SMIME_SIGN;
-        else if (!strcmp(*args, &quot;-resign&quot;))
+            break;
+        case OPT_RESIGN:
             operation = SMIME_RESIGN;
-        else if (!strcmp(*args, &quot;-verify&quot;))
+            break;
+        case OPT_VERIFY:
             operation = SMIME_VERIFY;
-        else if (!strcmp(*args, &quot;-pk7out&quot;))
+            break;
+        case OPT_PK7OUT:
             operation = SMIME_PK7OUT;
-#ifndef OPENSSL_NO_DES
-        else if (!strcmp(*args, &quot;-des3&quot;))
-            cipher = EVP_des_ede3_cbc();
-        else if (!strcmp(*args, &quot;-des&quot;))
-            cipher = EVP_des_cbc();
-#endif
-#ifndef OPENSSL_NO_SEED
-        else if (!strcmp(*args, &quot;-seed&quot;))
-            cipher = EVP_seed_cbc();
-#endif
-#ifndef OPENSSL_NO_RC2
-        else if (!strcmp(*args, &quot;-rc2-40&quot;))
-            cipher = EVP_rc2_40_cbc();
-        else if (!strcmp(*args, &quot;-rc2-128&quot;))
-            cipher = EVP_rc2_cbc();
-        else if (!strcmp(*args, &quot;-rc2-64&quot;))
-            cipher = EVP_rc2_64_cbc();
-#endif
-#ifndef OPENSSL_NO_AES
-        else if (!strcmp(*args, &quot;-aes128&quot;))
-            cipher = EVP_aes_128_cbc();
-        else if (!strcmp(*args, &quot;-aes192&quot;))
-            cipher = EVP_aes_192_cbc();
-        else if (!strcmp(*args, &quot;-aes256&quot;))
-            cipher = EVP_aes_256_cbc();
-#endif
-#ifndef OPENSSL_NO_CAMELLIA
-        else if (!strcmp(*args, &quot;-camellia128&quot;))
-            cipher = EVP_camellia_128_cbc();
-        else if (!strcmp(*args, &quot;-camellia192&quot;))
-            cipher = EVP_camellia_192_cbc();
-        else if (!strcmp(*args, &quot;-camellia256&quot;))
-            cipher = EVP_camellia_256_cbc();
-#endif
-        else if (!strcmp(*args, &quot;-text&quot;))
+            break;
+        case OPT_TEXT:
             flags |= PKCS7_TEXT;
-        else if (!strcmp(*args, &quot;-nointern&quot;))
+            break;
+        case OPT_NOINTERN:
             flags |= PKCS7_NOINTERN;
-        else if (!strcmp(*args, &quot;-noverify&quot;))
+            break;
+        case OPT_NOVERIFY:
             flags |= PKCS7_NOVERIFY;
-        else if (!strcmp(*args, &quot;-nochain&quot;))
+            break;
+        case OPT_NOCHAIN:
             flags |= PKCS7_NOCHAIN;
-        else if (!strcmp(*args, &quot;-nocerts&quot;))
+            break;
+        case OPT_NOCERTS:
             flags |= PKCS7_NOCERTS;
-        else if (!strcmp(*args, &quot;-noattr&quot;))
+            break;
+        case OPT_NOATTR:
             flags |= PKCS7_NOATTR;
-        else if (!strcmp(*args, &quot;-nodetach&quot;))
+            break;
+        case OPT_NODETACH:
             flags &amp;= ~PKCS7_DETACHED;
-        else if (!strcmp(*args, &quot;-nosmimecap&quot;))
+            break;
+        case OPT_NOSMIMECAP:
             flags |= PKCS7_NOSMIMECAP;
-        else if (!strcmp(*args, &quot;-binary&quot;))
+            break;
+        case OPT_BINARY:
             flags |= PKCS7_BINARY;
-        else if (!strcmp(*args, &quot;-nosigs&quot;))
+            break;
+        case OPT_NOSIGS:
             flags |= PKCS7_NOSIGS;
-        else if (!strcmp(*args, &quot;-stream&quot;))
+            break;
+        case OPT_STREAM:
+        case OPT_INDEF:
             indef = 1;
-        else if (!strcmp(*args, &quot;-indef&quot;))
-            indef = 1;
-        else if (!strcmp(*args, &quot;-noindef&quot;))
+            break;
+        case OPT_NOINDEF:
             indef = 0;
-        else if (!strcmp(*args, &quot;-nooldmime&quot;))
+            break;
+        case OPT_NOOLDMIME:
             flags |= PKCS7_NOOLDMIMETYPE;
-        else if (!strcmp(*args, &quot;-crlfeol&quot;))
+            break;
+        case OPT_CRLFEOL:
             flags |= PKCS7_CRLFEOL;
-        else if (!strcmp(*args, &quot;-rand&quot;)) {
-            if (!args[1])
-                goto argerr;
-            args++;
-            inrand = *args;
+            break;
+        case OPT_RAND:
+            inrand = opt_arg();
             need_rand = 1;
-        }
-#ifndef OPENSSL_NO_ENGINE
-        else if (!strcmp(*args, &quot;-engine&quot;)) {
-            if (!args[1])
-                goto argerr;
-            engine = *++args;
-        }
-#endif
-        else if (!strcmp(*args, &quot;-passin&quot;)) {
-            if (!args[1])
-                goto argerr;
-            passargin = *++args;
-        } else if (!strcmp(*args, &quot;-to&quot;)) {
-            if (!args[1])
-                goto argerr;
-            to = *++args;
-        } else if (!strcmp(*args, &quot;-from&quot;)) {
-            if (!args[1])
-                goto argerr;
-            from = *++args;
-        } else if (!strcmp(*args, &quot;-subject&quot;)) {
-            if (!args[1])
-                goto argerr;
-            subject = *++args;
-        } else if (!strcmp(*args, &quot;-signer&quot;)) {
-            if (!args[1])
-                goto argerr;
+            break;
+        case OPT_ENGINE:
+            engine = opt_arg();
+            break;
+        case OPT_PASSIN:
+            passinarg = opt_arg();
+            break;
+        case OPT_TO:
+            to = opt_arg();
+            break;
+        case OPT_FROM:
+            from = opt_arg();
+            break;
+        case OPT_SUBJECT:
+            subject = opt_arg();
+            break;
+        case OPT_SIGNER:
             /* If previous -signer argument add signer to list */
-
             if (signerfile) {
-                if (!sksigners)
-                    sksigners = sk_OPENSSL_STRING_new_null();
+                if (sksigners == NULL
+                    &amp;&amp; (sksigners = sk_OPENSSL_STRING_new_null()) == NULL)
+                    goto end;
                 sk_OPENSSL_STRING_push(sksigners, signerfile);
-                if (!keyfile)
+                if (keyfile == NULL)
                     keyfile = signerfile;
-                if (!skkeys)
-                    skkeys = sk_OPENSSL_STRING_new_null();
+                if (skkeys == NULL
+                    &amp;&amp; (skkeys = sk_OPENSSL_STRING_new_null()) == NULL)
+                    goto end;
                 sk_OPENSSL_STRING_push(skkeys, keyfile);
                 keyfile = NULL;
             }
-            signerfile = *++args;
-        } else if (!strcmp(*args, &quot;-recip&quot;)) {
-            if (!args[1])
-                goto argerr;
-            recipfile = *++args;
-        } else if (!strcmp(*args, &quot;-md&quot;)) {
-            if (!args[1])
-                goto argerr;
-            sign_md = EVP_get_digestbyname(*++args);
-            if (sign_md == NULL) {
-                BIO_printf(bio_err, &quot;Unknown digest %s\n&quot;, *args);
-                goto argerr;
-            }
-        } else if (!strcmp(*args, &quot;-inkey&quot;)) {
-            if (!args[1])
-                goto argerr;
+            signerfile = opt_arg();
+            break;
+        case OPT_RECIP:
+            recipfile = opt_arg();
+            break;
+        case OPT_MD:
+            if (!opt_md(opt_arg(), &amp;sign_md))
+                goto opthelp;
+            break;
+        case OPT_CIPHER:
+            if (!opt_cipher(opt_unknown(), &amp;cipher))
+                goto opthelp;
+            break;
+        case OPT_INKEY:
             /* If previous -inkey arument add signer to list */
             if (keyfile) {
-                if (!signerfile) {
-                    BIO_puts(bio_err, &quot;Illegal -inkey without -signer\n&quot;);
-                    goto argerr;
+                if (signerfile == NULL) {
+                    BIO_printf(bio_err,
+                               &quot;%s: Must have -signer before -inkey\n&quot;, prog);
+                    goto opthelp;
                 }
-                if (!sksigners)
-                    sksigners = sk_OPENSSL_STRING_new_null();
+                if (sksigners == NULL
+                    &amp;&amp; (sksigners = sk_OPENSSL_STRING_new_null()) == NULL)
+                    goto end;
                 sk_OPENSSL_STRING_push(sksigners, signerfile);
                 signerfile = NULL;
-                if (!skkeys)
-                    skkeys = sk_OPENSSL_STRING_new_null();
+                if (skkeys == NULL
+                    &amp;&amp; (skkeys = sk_OPENSSL_STRING_new_null()) == NULL)
+                    goto end;
                 sk_OPENSSL_STRING_push(skkeys, keyfile);
             }
-            keyfile = *++args;
-        } else if (!strcmp(*args, &quot;-keyform&quot;)) {
-            if (!args[1])
-                goto argerr;
-            keyform = str2fmt(*++args);
-        } else if (!strcmp(*args, &quot;-certfile&quot;)) {
-            if (!args[1])
-                goto argerr;
-            certfile = *++args;
-        } else if (!strcmp(*args, &quot;-CAfile&quot;)) {
-            if (!args[1])
-                goto argerr;
-            CAfile = *++args;
-        } else if (!strcmp(*args, &quot;-CApath&quot;)) {
-            if (!args[1])
-                goto argerr;
-            CApath = *++args;
-        } else if (!strcmp(*args, &quot;-in&quot;)) {
-            if (!args[1])
-                goto argerr;
-            infile = *++args;
-        } else if (!strcmp(*args, &quot;-inform&quot;)) {
-            if (!args[1])
-                goto argerr;
-            informat = str2fmt(*++args);
-        } else if (!strcmp(*args, &quot;-outform&quot;)) {
-            if (!args[1])
-                goto argerr;
-            outformat = str2fmt(*++args);
-        } else if (!strcmp(*args, &quot;-out&quot;)) {
-            if (!args[1])
-                goto argerr;
-            outfile = *++args;
-        } else if (!strcmp(*args, &quot;-content&quot;)) {
-            if (!args[1])
-                goto argerr;
-            contfile = *++args;
-        } else if (args_verify(&amp;args, NULL, &amp;badarg, bio_err, &amp;vpm))
-            continue;
-        else if ((cipher = EVP_get_cipherbyname(*args + 1)) == NULL)
-            badarg = 1;
-        args++;
+            keyfile = opt_arg();
+            break;
+        case OPT_KEYFORM:
+            if (!opt_format(opt_arg(), OPT_FMT_ANY, &amp;keyform))
+                goto opthelp;
+            break;
+        case OPT_CERTFILE:
+            certfile = opt_arg();
+            break;
+        case OPT_CAFILE:
+            CAfile = opt_arg();
+            break;
+        case OPT_CAPATH:
+            CApath = opt_arg();
+            break;
+        case OPT_CONTENT:
+            contfile = opt_arg();
+            break;
+        case OPT_V_CASES:
+            if (!opt_verify(o, vpm))
+                goto opthelp;
+            vpmtouched++;
+            break;
+        }
     }
+    argc = opt_num_rest();
+    argv = opt_rest();
 
     if (!(operation &amp; SMIME_SIGNERS) &amp;&amp; (skkeys || sksigners)) {
         BIO_puts(bio_err, &quot;Multiple signers or keys not allowed\n&quot;);
-        goto argerr;
+        goto opthelp;
     }
 
     if (operation &amp; SMIME_SIGNERS) {
         /* Check to see if any final signer needs to be appended */
         if (keyfile &amp;&amp; !signerfile) {
             BIO_puts(bio_err, &quot;Illegal -inkey without -signer\n&quot;);
-            goto argerr;
+            goto opthelp;
         }
         if (signerfile) {
-            if (!sksigners)
-                sksigners = sk_OPENSSL_STRING_new_null();
+            if (!sksigners
+                &amp;&amp; (sksigners = sk_OPENSSL_STRING_new_null()) == NULL)
+                goto end;
             sk_OPENSSL_STRING_push(sksigners, signerfile);
-            if (!skkeys)
-                skkeys = sk_OPENSSL_STRING_new_null();
+            if (!skkeys &amp;&amp; (skkeys = sk_OPENSSL_STRING_new_null()) == NULL)
+                goto end;
             if (!keyfile)
                 keyfile = signerfile;
             sk_OPENSSL_STRING_push(skkeys, keyfile);
         }
         if (!sksigners) {
             BIO_printf(bio_err, &quot;No signer certificate specified\n&quot;);
-            badarg = 1;
+            goto opthelp;
         }
         signerfile = NULL;
         keyfile = NULL;
@@ -362,118 +397,28 @@ int MAIN(int argc, char **argv)
         if (!recipfile &amp;&amp; !keyfile) {
             BIO_printf(bio_err,
                        &quot;No recipient certificate or key specified\n&quot;);
-            badarg = 1;
+            goto opthelp;
         }
     } else if (operation == SMIME_ENCRYPT) {
-        if (!*args) {
+        if (argc == 0) {
             BIO_printf(bio_err, &quot;No recipient(s) certificate(s) specified\n&quot;);
-            badarg = 1;
+            goto opthelp;
         }
         need_rand = 1;
     } else if (!operation)
-        badarg = 1;
-
-    if (badarg) {
- argerr:
-        BIO_printf(bio_err, &quot;Usage smime [options] cert.pem ...\n&quot;);
-        BIO_printf(bio_err, &quot;where options are\n&quot;);
-        BIO_printf(bio_err, &quot;-encrypt       encrypt message\n&quot;);
-        BIO_printf(bio_err, &quot;-decrypt       decrypt encrypted message\n&quot;);
-        BIO_printf(bio_err, &quot;-sign          sign message\n&quot;);
-        BIO_printf(bio_err, &quot;-verify        verify signed message\n&quot;);
-        BIO_printf(bio_err, &quot;-pk7out        output PKCS#7 structure\n&quot;);
-#ifndef OPENSSL_NO_DES
-        BIO_printf(bio_err, &quot;-des3          encrypt with triple DES\n&quot;);
-        BIO_printf(bio_err, &quot;-des           encrypt with DES\n&quot;);
-#endif
-#ifndef OPENSSL_NO_SEED
-        BIO_printf(bio_err, &quot;-seed          encrypt with SEED\n&quot;);
-#endif
-#ifndef OPENSSL_NO_RC2
-        BIO_printf(bio_err, &quot;-rc2-40        encrypt with RC2-40 (default)\n&quot;);
-        BIO_printf(bio_err, &quot;-rc2-64        encrypt with RC2-64\n&quot;);
-        BIO_printf(bio_err, &quot;-rc2-128       encrypt with RC2-128\n&quot;);
-#endif
-#ifndef OPENSSL_NO_AES
-        BIO_printf(bio_err, &quot;-aes128, -aes192, -aes256\n&quot;);
-        BIO_printf(bio_err,
-                   &quot;               encrypt PEM output with cbc aes\n&quot;);
-#endif
-#ifndef OPENSSL_NO_CAMELLIA
-        BIO_printf(bio_err, &quot;-camellia128, -camellia192, -camellia256\n&quot;);
-        BIO_printf(bio_err,
-                   &quot;               encrypt PEM output with cbc camellia\n&quot;);
-#endif
-        BIO_printf(bio_err,
-                   &quot;-nointern      don't search certificates in message for signer\n&quot;);
-        BIO_printf(bio_err,
-                   &quot;-nosigs        don't verify message signature\n&quot;);
-        BIO_printf(bio_err,
-                   &quot;-noverify      don't verify signers certificate\n&quot;);
-        BIO_printf(bio_err,
-                   &quot;-nocerts       don't include signers certificate when signing\n&quot;);
-        BIO_printf(bio_err, &quot;-nodetach      use opaque signing\n&quot;);
-        BIO_printf(bio_err,
-                   &quot;-noattr        don't include any signed attributes\n&quot;);
-        BIO_printf(bio_err,
-                   &quot;-binary        don't translate message to text\n&quot;);
-        BIO_printf(bio_err, &quot;-certfile file other certificates file\n&quot;);
-        BIO_printf(bio_err, &quot;-signer file   signer certificate file\n&quot;);
-        BIO_printf(bio_err,
-                   &quot;-recip  file   recipient certificate file for decryption\n&quot;);
-        BIO_printf(bio_err, &quot;-in file       input file\n&quot;);
-        BIO_printf(bio_err,
-                   &quot;-inform arg    input format SMIME (default), PEM or DER\n&quot;);
-        BIO_printf(bio_err,
-                   &quot;-inkey file    input private key (if not signer or recipient)\n&quot;);
-        BIO_printf(bio_err,
-                   &quot;-keyform arg   input private key format (PEM or ENGINE)\n&quot;);
-        BIO_printf(bio_err, &quot;-out file      output file\n&quot;);
-        BIO_printf(bio_err,
-                   &quot;-outform arg   output format SMIME (default), PEM or DER\n&quot;);
-        BIO_printf(bio_err,
-                   &quot;-content file  supply or override content for detached signature\n&quot;);
-        BIO_printf(bio_err, &quot;-to addr       to address\n&quot;);
-        BIO_printf(bio_err, &quot;-from ad       from address\n&quot;);
-        BIO_printf(bio_err, &quot;-subject s     subject\n&quot;);
-        BIO_printf(bio_err,
-                   &quot;-text          include or delete text MIME headers\n&quot;);
-        BIO_printf(bio_err,
-                   &quot;-CApath dir    trusted certificates directory\n&quot;);
-        BIO_printf(bio_err, &quot;-CAfile file   trusted certificates file\n&quot;);
-        BIO_printf(bio_err,
-                   &quot;-trusted_first use locally trusted CA's first when building trust chain\n&quot;);
-        BIO_printf(bio_err,
-                   &quot;-no_alt_chains only ever use the first certificate chain found\n&quot;);
-        BIO_printf(bio_err,
-                   &quot;-crl_check     check revocation status of signer's certificate using CRLs\n&quot;);
-        BIO_printf(bio_err,
-                   &quot;-crl_check_all check revocation status of signer's certificate chain using CRLs\n&quot;);
-#ifndef OPENSSL_NO_ENGINE
-        BIO_printf(bio_err,
-                   &quot;-engine e      use engine e, possibly a hardware device.\n&quot;);
-#endif
-        BIO_printf(bio_err, &quot;-passin arg    input file pass phrase source\n&quot;);
-        BIO_printf(bio_err, &quot;-rand file%cfile%c...\n&quot;, LIST_SEPARATOR_CHAR,
-                   LIST_SEPARATOR_CHAR);
-        BIO_printf(bio_err,
-                   &quot;               load the file (or the files in the directory) into\n&quot;);
-        BIO_printf(bio_err, &quot;               the random number generator\n&quot;);
-        BIO_printf(bio_err,
-                   &quot;cert.pem       recipient certificate(s) for encryption\n&quot;);
-        goto end;
-    }
+        goto opthelp;
+
 #ifndef OPENSSL_NO_ENGINE
-    e = setup_engine(bio_err, engine, 0);
+    e = setup_engine(engine, 0);
 #endif
 
-    if (!app_passwd(bio_err, passargin, NULL, &amp;passin, NULL)) {
+    if (!app_passwd(passinarg, NULL, &amp;passin, NULL)) {
         BIO_printf(bio_err, &quot;Error getting password\n&quot;);
         goto end;
     }
 
     if (need_rand) {
-        app_RAND_load_file(NULL, bio_err, (inrand != NULL));
+        app_RAND_load_file(NULL, (inrand != NULL));
         if (inrand != NULL)
             BIO_printf(bio_err, &quot;%ld semi-random bytes loaded\n&quot;,
                        app_RAND_load_files(inrand));
@@ -510,19 +455,21 @@ int MAIN(int argc, char **argv)
 #endif
         }
         encerts = sk_X509_new_null();
-        while (*args) {
-            if (!(cert = load_cert(bio_err, *args, FORMAT_PEM,
-                                   NULL, e, &quot;recipient certificate file&quot;))) {
+        if (!encerts)
+            goto end;
+        while (*argv) {
+            cert = load_cert(*argv, FORMAT_PEM,
+                             NULL, e, &quot;recipient certificate file&quot;);
+            if (cert == NULL)
                 goto end;
-            }
             sk_X509_push(encerts, cert);
             cert = NULL;
-            args++;
+            argv++;
         }
     }
 
     if (certfile) {
-        if (!(other = load_certs(bio_err, certfile, FORMAT_PEM, NULL,
+        if (!(other = load_certs(certfile, FORMAT_PEM, NULL,
                                  e, &quot;certificate file&quot;))) {
             ERR_print_errors(bio_err);
             goto end;
@@ -530,7 +477,7 @@ int MAIN(int argc, char **argv)
     }
 
     if (recipfile &amp;&amp; (operation == SMIME_DECRYPT)) {
-        if (!(recip = load_cert(bio_err, recipfile, FORMAT_PEM, NULL,
+        if (!(recip = load_cert(recipfile, FORMAT_PEM, NULL,
                                 e, &quot;recipient certificate file&quot;))) {
             ERR_print_errors(bio_err);
             goto end;
@@ -547,19 +494,14 @@ int MAIN(int argc, char **argv)
         keyfile = NULL;
 
     if (keyfile) {
-        key = load_key(bio_err, keyfile, keyform, 0, passin, e,
-                       &quot;signing key file&quot;);
+        key = load_key(keyfile, keyform, 0, passin, e, &quot;signing key file&quot;);
         if (!key)
             goto end;
     }
 
-    if (infile) {
-        if (!(in = BIO_new_file(infile, inmode))) {
-            BIO_printf(bio_err, &quot;Can't open input file %s\n&quot;, infile);
-            goto end;
-        }
-    } else
-        in = BIO_new_fp(stdin, BIO_NOCLOSE);
+    in = bio_open_default(infile, inmode);
+    if (in == NULL)
+        goto end;
 
     if (operation &amp; SMIME_IP) {
         if (informat == FORMAT_SMIME)
@@ -586,26 +528,15 @@ int MAIN(int argc, char **argv)
         }
     }
 
-    if (outfile) {
-        if (!(out = BIO_new_file(outfile, outmode))) {
-            BIO_printf(bio_err, &quot;Can't open output file %s\n&quot;, outfile);
-            goto end;
-        }
-    } else {
-        out = BIO_new_fp(stdout, BIO_NOCLOSE);
-#ifdef OPENSSL_SYS_VMS
-        {
-            BIO *tmpbio = BIO_new(BIO_f_linebuffer());
-            out = BIO_push(tmpbio, out);
-        }
-#endif
-    }
+    out = bio_open_default(outfile, outmode);
+    if (out == NULL)
+        goto end;
 
     if (operation == SMIME_VERIFY) {
-        if (!(store = setup_verify(bio_err, CAfile, CApath)))
+        if (!(store = setup_verify(CAfile, CApath)))
             goto end;
         X509_STORE_set_verify_cb(store, smime_cb);
-        if (vpm)
+        if (vpmtouched)
             X509_STORE_set1_param(store, vpm);
     }
 
@@ -642,12 +573,11 @@ int MAIN(int argc, char **argv)
         for (i = 0; i &lt; sk_OPENSSL_STRING_num(sksigners); i++) {
             signerfile = sk_OPENSSL_STRING_value(sksigners, i);
             keyfile = sk_OPENSSL_STRING_value(skkeys, i);
-            signer = load_cert(bio_err, signerfile, FORMAT_PEM, NULL,
+            signer = load_cert(signerfile, FORMAT_PEM, NULL,
                                e, &quot;signer certificate&quot;);
             if (!signer)
                 goto end;
-            key = load_key(bio_err, keyfile, keyform, 0, passin, e,
-                           &quot;signing key file&quot;);
+            key = load_key(keyfile, keyform, 0, passin, e, &quot;signing key file&quot;);
             if (!key)
                 goto end;
             if (!PKCS7_sign_add_signer(p7, signer, key, sign_md, flags))
@@ -701,22 +631,27 @@ int MAIN(int argc, char **argv)
             BIO_printf(out, &quot;Subject: %s\n&quot;, subject);
         if (outformat == FORMAT_SMIME) {
             if (operation == SMIME_RESIGN)
-                SMIME_write_PKCS7(out, p7, indata, flags);
+                rv = SMIME_write_PKCS7(out, p7, indata, flags);
             else
-                SMIME_write_PKCS7(out, p7, in, flags);
+                rv = SMIME_write_PKCS7(out, p7, in, flags);
         } else if (outformat == FORMAT_PEM)
-            PEM_write_bio_PKCS7_stream(out, p7, in, flags);
+            rv = PEM_write_bio_PKCS7_stream(out, p7, in, flags);
         else if (outformat == FORMAT_ASN1)
-            i2d_PKCS7_bio_stream(out, p7, in, flags);
+            rv = i2d_PKCS7_bio_stream(out, p7, in, flags);
         else {
             BIO_printf(bio_err, &quot;Bad output format for PKCS#7 file\n&quot;);
             goto end;
         }
+        if (rv == 0) {
+            BIO_printf(bio_err, &quot;Error writing output\n&quot;);
+            ret = 3;
+            goto end;
+        }
     }
     ret = 0;
  end:
     if (need_rand)
-        app_RAND_write_file(NULL, bio_err);
+        app_RAND_write_file(NULL);
     if (ret)
         ERR_print_errors(bio_err);
     sk_X509_pop_free(encerts, X509_free);
@@ -768,7 +703,7 @@ static int smime_cb(int ok, X509_STORE_CTX *ctx)
         &amp;&amp; ((error != X509_V_OK) || (ok != 2)))
         return ok;
 
-    policies_print(NULL, ctx);
+    policies_print(bio_err, ctx);
 
     return ok;
 
diff --git a/apps/speed.c b/apps/speed.c
index 71aa74a..1a01d33 100644
--- a/apps/speed.c
+++ b/apps/speed.c
@@ -1,4 +1,3 @@
-/* apps/speed.c -*- mode:C; c-file-style: &quot;eay&quot; -*- */
 /* Copyright (C) 1995-1998 Eric Young (<A HREF="../../../mailman/listinfo/openssl-commits.html">eay at cryptsoft.com</A>)
  * All rights reserved.
  *
@@ -77,12 +76,8 @@
 #define ECDSA_SECONDS   10
 #define ECDH_SECONDS    10
 
-#undef PROG
-#define PROG speed_main
-
 #include &lt;stdio.h&gt;
 #include &lt;stdlib.h&gt;
-
 #include &lt;string.h&gt;
 #include &lt;math.h&gt;
 #include &quot;apps.h&quot;
@@ -133,9 +128,9 @@
 #ifndef OPENSSL_NO_MD5
 # include &lt;openssl/md5.h&gt;
 #endif
-# include &lt;openssl/hmac.h&gt;
+#include &lt;openssl/hmac.h&gt;
 #include &lt;openssl/evp.h&gt;
-# include &lt;openssl/sha.h&gt;
+#include &lt;openssl/sha.h&gt;
 #ifndef OPENSSL_NO_RMD160
 # include &lt;openssl/ripemd.h&gt;
 #endif
@@ -220,6 +215,7 @@ static int do_multi(int multi);
 
 #define EC_NUM       16
 #define MAX_ECDH_SIZE 256
+#define MISALIGN        64
 
 static const char *names[ALGOR_NUM] = {
     &quot;md2&quot;, &quot;mdc2&quot;, &quot;md4&quot;, &quot;md5&quot;, &quot;hmac(md5)&quot;, &quot;sha1&quot;, &quot;rmd160&quot;, &quot;rc4&quot;,
@@ -232,7 +228,9 @@ static const char *names[ALGOR_NUM] = {
 };
 
 static double results[ALGOR_NUM][SIZE_NUM];
-static int lengths[SIZE_NUM] = { 16, 64, 256, 1024, 8 * 1024 };
+static int lengths[SIZE_NUM] = {
+    16, 64, 256, 1024, 8 * 1024
+};
 
 #ifndef OPENSSL_NO_RSA
 static double rsa_results[RSA_NUM][2];
@@ -340,22 +338,253 @@ static void *KDF1_SHA1(const void *in, size_t inlen, void *out,
 
 static void multiblock_speed(const EVP_CIPHER *evp_cipher);
 
-int MAIN(int, char **);
+static int found(const char *name, const OPT_PAIR * pairs, int *result)
+{
+    for (; pairs-&gt;name; pairs++)
+        if (strcmp(name, pairs-&gt;name) == 0) {
+            *result = pairs-&gt;retval;
+            return 1;
+        }
+    return 0;
+}
+
+typedef enum OPTION_choice {
+    OPT_ERR = -1, OPT_EOF = 0, OPT_HELP,
+    OPT_ELAPSED, OPT_EVP, OPT_DECRYPT, OPT_ENGINE, OPT_MULTI,
+    OPT_MR, OPT_MB, OPT_MISALIGN
+} OPTION_CHOICE;
+
+OPTIONS speed_options[] = {
+    {OPT_HELP_STR, 1, '-', &quot;Usage: %s [options] ciphers...\n&quot;},
+    {OPT_HELP_STR, 1, '-', &quot;Valid options are:\n&quot;},
+    {&quot;help&quot;, OPT_HELP, '-', &quot;Display this summary&quot;},
+#if defined(TIMES) || defined(USE_TOD)
+    {&quot;elapsed&quot;, OPT_ELAPSED, '-',
+     &quot;Measure time in real time instead of CPU user time&quot;},
+#endif
+    {&quot;evp&quot;, OPT_EVP, 's', &quot;Use specified EVP cipher&quot;},
+    {&quot;decrypt&quot;, OPT_DECRYPT, '-',
+     &quot;Time decryption instead of encryption (only EVP)&quot;},
+#ifndef NO_FORK
+    {&quot;multi&quot;, OPT_MULTI, 'p', &quot;Run benchmarks in parallel&quot;},
+#endif
+    {&quot;mr&quot;, OPT_MR, '-', &quot;Produce machine readable output&quot;},
+    {&quot;mb&quot;, OPT_MB, '-'},
+    {&quot;misalign&quot;, OPT_MISALIGN, 'n', &quot;Amount to mis-align buffers&quot;},
+#ifndef OPENSSL_NO_ENGINE
+    {&quot;engine&quot;, OPT_ENGINE, 's', &quot;Use engine, possibly a hardware device&quot;},
+#endif
+};
+
+#define D_MD2           0
+#define D_MDC2          1
+#define D_MD4           2
+#define D_MD5           3
+#define D_HMAC          4
+#define D_SHA1          5
+#define D_RMD160        6
+#define D_RC4           7
+#define D_CBC_DES       8
+#define D_EDE3_DES      9
+#define D_CBC_IDEA      10
+#define D_CBC_SEED      11
+#define D_CBC_RC2       12
+#define D_CBC_RC5       13
+#define D_CBC_BF        14
+#define D_CBC_CAST      15
+#define D_CBC_128_AES   16
+#define D_CBC_192_AES   17
+#define D_CBC_256_AES   18
+#define D_CBC_128_CML   19
+#define D_CBC_192_CML   20
+#define D_CBC_256_CML   21
+#define D_EVP           22
+#define D_SHA256        23
+#define D_SHA512        24
+#define D_WHIRLPOOL     25
+#define D_IGE_128_AES   26
+#define D_IGE_192_AES   27
+#define D_IGE_256_AES   28
+#define D_GHASH         29
+OPT_PAIR doit_choices[] = {
+#ifndef OPENSSL_NO_MD2
+    {&quot;md2&quot;, D_MD2},
+#endif
+#ifndef OPENSSL_NO_MDC2
+    {&quot;mdc2&quot;, D_MDC2},
+#endif
+#ifndef OPENSSL_NO_MD4
+    {&quot;md4&quot;, D_MD4},
+#endif
+#ifndef OPENSSL_NO_MD5
+    {&quot;md5&quot;, D_MD5},
+#endif
+#ifndef OPENSSL_NO_MD5
+    {&quot;hmac&quot;, D_HMAC},
+#endif
+    {&quot;sha1&quot;, D_SHA1},
+    {&quot;sha256&quot;, D_SHA256},
+    {&quot;sha512&quot;, D_SHA512},
+#ifndef OPENSSL_NO_WHIRLPOOL
+    {&quot;whirlpool&quot;, D_WHIRLPOOL},
+#endif
+#ifndef OPENSSL_NO_RIPEMD
+    {&quot;ripemd&quot;, D_RMD160},
+    {&quot;rmd160&quot;, D_RMD160},
+    {&quot;ripemd160&quot;, D_RMD160},
+#endif
+#ifndef OPENSSL_NO_RC4
+    {&quot;rc4&quot;, D_RC4},
+#endif
+#ifndef OPENSSL_NO_DES
+    {&quot;des-cbc&quot;, D_CBC_DES},
+    {&quot;des-ede3&quot;, D_EDE3_DES},
+#endif
+#ifndef OPENSSL_NO_AES
+    {&quot;aes-128-cbc&quot;, D_CBC_128_AES},
+    {&quot;aes-192-cbc&quot;, D_CBC_192_AES},
+    {&quot;aes-256-cbc&quot;, D_CBC_256_AES},
+    {&quot;aes-128-ige&quot;, D_IGE_128_AES},
+    {&quot;aes-192-ige&quot;, D_IGE_192_AES},
+    {&quot;aes-256-ige&quot;, D_IGE_256_AES},
+#endif
+#ifndef OPENSSL_NO_RC2
+    {&quot;rc2-cbc&quot;, D_CBC_RC2},
+    {&quot;rc2&quot;, D_CBC_RC2},
+#endif
+#ifndef OPENSSL_NO_RC5
+    {&quot;rc5-cbc&quot;, D_CBC_RC5},
+    {&quot;rc5&quot;, D_CBC_RC5},
+#endif
+#ifndef OPENSSL_NO_IDEA
+    {&quot;idea-cbc&quot;, D_CBC_IDEA},
+    {&quot;idea&quot;, D_CBC_IDEA},
+#endif
+#ifndef OPENSSL_NO_SEED
+    {&quot;seed-cbc&quot;, D_CBC_SEED},
+    {&quot;seed&quot;, D_CBC_SEED},
+#endif
+#ifndef OPENSSL_NO_BF
+    {&quot;bf-cbc&quot;, D_CBC_BF},
+    {&quot;blowfish&quot;, D_CBC_BF},
+    {&quot;bf&quot;, D_CBC_BF},
+#endif
+#ifndef OPENSSL_NO_CAST
+    {&quot;cast-cbc&quot;, D_CBC_CAST},
+    {&quot;cast&quot;, D_CBC_CAST},
+    {&quot;cast5&quot;, D_CBC_CAST},
+#endif
+    {&quot;ghash&quot;, D_GHASH},
+    {NULL}
+};
+
+#define R_DSA_512       0
+#define R_DSA_1024      1
+#define R_DSA_2048      2
+static OPT_PAIR dsa_choices[] = {
+    {&quot;dsa512&quot;, R_DSA_512},
+    {&quot;dsa1024&quot;, R_DSA_1024},
+    {&quot;dsa2048&quot;, R_DSA_2048},
+    {NULL},
+};
 
-int MAIN(int argc, char **argv)
+#define R_RSA_512       0
+#define R_RSA_1024      1
+#define R_RSA_2048      2
+#define R_RSA_3072      3
+#define R_RSA_4096      4
+#define R_RSA_7680      5
+#define R_RSA_15360     6
+static OPT_PAIR rsa_choices[] = {
+    {&quot;rsa512&quot;, R_RSA_512},
+    {&quot;rsa1024&quot;, R_RSA_1024},
+    {&quot;rsa2048&quot;, R_RSA_2048},
+    {&quot;rsa3072&quot;, R_RSA_3072},
+    {&quot;rsa4096&quot;, R_RSA_4096},
+    {&quot;rsa7680&quot;, R_RSA_7680},
+    {&quot;rsa15360&quot;, R_RSA_15360},
+    {NULL}
+};
+
+#define R_EC_P160    0
+#define R_EC_P192    1
+#define R_EC_P224    2
+#define R_EC_P256    3
+#define R_EC_P384    4
+#define R_EC_P521    5
+#define R_EC_K163    6
+#define R_EC_K233    7
+#define R_EC_K283    8
+#define R_EC_K409    9
+#define R_EC_K571    10
+#define R_EC_B163    11
+#define R_EC_B233    12
+#define R_EC_B283    13
+#define R_EC_B409    14
+#define R_EC_B571    15
+#ifndef OPENSSL_NO_ECA
+static OPT_PAIR ecdsa_choices[] = {
+    {&quot;ecdsap160&quot;, R_EC_P160},
+    {&quot;ecdsap192&quot;, R_EC_P192},
+    {&quot;ecdsap224&quot;, R_EC_P224},
+    {&quot;ecdsap256&quot;, R_EC_P256},
+    {&quot;ecdsap384&quot;, R_EC_P384},
+    {&quot;ecdsap521&quot;, R_EC_P521},
+    {&quot;ecdsak163&quot;, R_EC_K163},
+    {&quot;ecdsak233&quot;, R_EC_K233},
+    {&quot;ecdsak283&quot;, R_EC_K283},
+    {&quot;ecdsak409&quot;, R_EC_K409},
+    {&quot;ecdsak571&quot;, R_EC_K571},
+    {&quot;ecdsab163&quot;, R_EC_B163},
+    {&quot;ecdsab233&quot;, R_EC_B233},
+    {&quot;ecdsab283&quot;, R_EC_B283},
+    {&quot;ecdsab409&quot;, R_EC_B409},
+    {&quot;ecdsab571&quot;, R_EC_B571},
+    {NULL}
+};
+static OPT_PAIR ecdh_choices[] = {
+    {&quot;ecdhp160&quot;, R_EC_P160},
+    {&quot;ecdhp192&quot;, R_EC_P192},
+    {&quot;ecdhp224&quot;, R_EC_P224},
+    {&quot;ecdhp256&quot;, R_EC_P256},
+    {&quot;ecdhp384&quot;, R_EC_P384},
+    {&quot;ecdhp521&quot;, R_EC_P521},
+    {&quot;ecdhk163&quot;, R_EC_K163},
+    {&quot;ecdhk233&quot;, R_EC_K233},
+    {&quot;ecdhk283&quot;, R_EC_K283},
+    {&quot;ecdhk409&quot;, R_EC_K409},
+    {&quot;ecdhk571&quot;, R_EC_K571},
+    {&quot;ecdhb163&quot;, R_EC_B163},
+    {&quot;ecdhb233&quot;, R_EC_B233},
+    {&quot;ecdhb283&quot;, R_EC_B283},
+    {&quot;ecdhb409&quot;, R_EC_B409},
+    {&quot;ecdhb571&quot;, R_EC_B571},
+    {NULL}
+};
+#endif
+
+int speed_main(int argc, char **argv)
 {
+    char *prog;
+    const EVP_CIPHER *evp_cipher = NULL;
+    const EVP_MD *evp_md = NULL;
+    double d = 0.0;
+    OPTION_CHOICE o;
+    int decrypt = 0, multiblock = 0, doit[ALGOR_NUM], pr_header = 0;
+    int dsa_doit[DSA_NUM], rsa_doit[RSA_NUM];
+    int ret = 1, i, j, k, misalign = MAX_MISALIGNMENT + 1;
+    long c[ALGOR_NUM][SIZE_NUM], count = 0, save_count = 0;
     unsigned char *buf_malloc = NULL, *buf2_malloc = NULL;
     unsigned char *buf = NULL, *buf2 = NULL;
-    int mret = 1;
-    long count = 0, save_count = 0;
-    int i, j, k;
+    unsigned char *save_buf = NULL, *save_buf2 = NULL;
+    unsigned char md[EVP_MAX_MD_SIZE];
+#ifndef NO_FORK
+    int multi = 0;
+#endif
+    /* What follows are the buffers and key material. */
 #if !defined(OPENSSL_NO_RSA) || !defined(OPENSSL_NO_DSA)
     long rsa_count;
 #endif
-#ifndef OPENSSL_NO_RSA
-    unsigned rsa_num;
-#endif
-    unsigned char md[EVP_MAX_MD_SIZE];
 #ifndef OPENSSL_NO_MD2
     unsigned char md2[MD2_DIGEST_LENGTH];
 #endif
@@ -375,7 +604,7 @@ int MAIN(int argc, char **argv)
 #ifndef OPENSSL_NO_WHIRLPOOL
     unsigned char whirlpool[WHIRLPOOL_DIGEST_LENGTH];
 #endif
-#ifndef OPENSSL_NO_RMD160
+#ifndef OPENSSL_NO_RIPEMD
     unsigned char rmd160[RIPEMD160_DIGEST_LENGTH];
 #endif
 #ifndef OPENSSL_NO_RC4
@@ -428,6 +657,7 @@ int MAIN(int argc, char **argv)
         0x56, 0x78, 0x9a, 0xbc, 0xde, 0xf0, 0x12, 0x34,
         0x78, 0x9a, 0xbc, 0xde, 0xf0, 0x12, 0x34, 0x56
     };
+    CAMELLIA_KEY camellia_ks1, camellia_ks2, camellia_ks3;
 #endif
 #ifndef OPENSSL_NO_AES
 # define MAX_BLOCK_SIZE 128
@@ -437,12 +667,15 @@ int MAIN(int argc, char **argv)
     unsigned char DES_iv[8];
     unsigned char iv[2 * MAX_BLOCK_SIZE / 8];
 #ifndef OPENSSL_NO_DES
-    static DES_cblock key =
-        { 0x12, 0x34, 0x56, 0x78, 0x9a, 0xbc, 0xde, 0xf0 };
-    static DES_cblock key2 =
-        { 0x34, 0x56, 0x78, 0x9a, 0xbc, 0xde, 0xf0, 0x12 };
-    static DES_cblock key3 =
-        { 0x56, 0x78, 0x9a, 0xbc, 0xde, 0xf0, 0x12, 0x34 };
+    static DES_cblock key = {
+        0x12, 0x34, 0x56, 0x78, 0x9a, 0xbc, 0xde, 0xf0
+    };
+    static DES_cblock key2 = {
+        0x34, 0x56, 0x78, 0x9a, 0xbc, 0xde, 0xf0, 0x12
+    };
+    static DES_cblock key3 = {
+        0x56, 0x78, 0x9a, 0xbc, 0xde, 0xf0, 0x12, 0x34
+    };
     DES_key_schedule sch;
     DES_key_schedule sch2;
     DES_key_schedule sch3;
@@ -450,73 +683,8 @@ int MAIN(int argc, char **argv)
 #ifndef OPENSSL_NO_AES
     AES_KEY aes_ks1, aes_ks2, aes_ks3;
 #endif
-#ifndef OPENSSL_NO_CAMELLIA
-    CAMELLIA_KEY camellia_ks1, camellia_ks2, camellia_ks3;
-#endif
-#define D_MD2           0
-#define D_MDC2          1
-#define D_MD4           2
-#define D_MD5           3
-#define D_HMAC          4
-#define D_SHA1          5
-#define D_RMD160        6
-#define D_RC4           7
-#define D_CBC_DES       8
-#define D_EDE3_DES      9
-#define D_CBC_IDEA      10
-#define D_CBC_SEED      11
-#define D_CBC_RC2       12
-#define D_CBC_RC5       13
-#define D_CBC_BF        14
-#define D_CBC_CAST      15
-#define D_CBC_128_AES   16
-#define D_CBC_192_AES   17
-#define D_CBC_256_AES   18
-#define D_CBC_128_CML   19
-#define D_CBC_192_CML   20
-#define D_CBC_256_CML   21
-#define D_EVP           22
-#define D_SHA256        23
-#define D_SHA512        24
-#define D_WHIRLPOOL     25
-#define D_IGE_128_AES   26
-#define D_IGE_192_AES   27
-#define D_IGE_256_AES   28
-#define D_GHASH         29
-    double d = 0.0;
-    long c[ALGOR_NUM][SIZE_NUM];
-
-#ifndef OPENSSL_SYS_WIN32
-#endif
-#define R_DSA_512       0
-#define R_DSA_1024      1
-#define R_DSA_2048      2
-#define R_RSA_512       0
-#define R_RSA_1024      1
-#define R_RSA_2048      2
-#define R_RSA_3072      3
-#define R_RSA_4096      4
-#define R_RSA_7680      5
-#define R_RSA_15360     6
-
-#define R_EC_P160    0
-#define R_EC_P192    1
-#define R_EC_P224    2
-#define R_EC_P256    3
-#define R_EC_P384    4
-#define R_EC_P521    5
-#define R_EC_K163    6
-#define R_EC_K233    7
-#define R_EC_K283    8
-#define R_EC_K409    9
-#define R_EC_K571    10
-#define R_EC_B163    11
-#define R_EC_B233    12
-#define R_EC_B283    13
-#define R_EC_B409    14
-#define R_EC_B571    15
-
 #ifndef OPENSSL_NO_RSA
+    unsigned rsa_num;
     RSA *rsa_key[RSA_NUM];
     long rsa_c[RSA_NUM][2];
     static unsigned int rsa_bits[RSA_NUM] = {
@@ -545,85 +713,51 @@ int MAIN(int argc, char **argv)
      */
     static unsigned int test_curves[EC_NUM] = {
         /* Prime Curves */
-        NID_secp160r1,
-        NID_X9_62_prime192v1,
-        NID_secp224r1,
-        NID_X9_62_prime256v1,
-        NID_secp384r1,
-        NID_secp521r1,
+        NID_secp160r1, NID_X9_62_prime192v1, NID_secp224r1,
+        NID_X9_62_prime256v1, NID_secp384r1, NID_secp521r1,
         /* Binary Curves */
-        NID_sect163k1,
-        NID_sect233k1,
-        NID_sect283k1,
-        NID_sect409k1,
-        NID_sect571k1,
-        NID_sect163r2,
-        NID_sect233r1,
-        NID_sect283r1,
-        NID_sect409r1,
+        NID_sect163k1, NID_sect233k1, NID_sect283k1,
+        NID_sect409k1, NID_sect571k1, NID_sect163r2,
+        NID_sect233r1, NID_sect283r1, NID_sect409r1,
         NID_sect571r1
     };
     static const char *test_curves_names[EC_NUM] = {
         /* Prime Curves */
-        &quot;secp160r1&quot;,
-        &quot;nistp192&quot;,
-        &quot;nistp224&quot;,
-        &quot;nistp256&quot;,
-        &quot;nistp384&quot;,
-        &quot;nistp521&quot;,
+        &quot;secp160r1&quot;, &quot;nistp192&quot;, &quot;nistp224&quot;,
+        &quot;nistp256&quot;, &quot;nistp384&quot;, &quot;nistp521&quot;,
         /* Binary Curves */
-        &quot;nistk163&quot;,
-        &quot;nistk233&quot;,
-        &quot;nistk283&quot;,
-        &quot;nistk409&quot;,
-        &quot;nistk571&quot;,
-        &quot;nistb163&quot;,
-        &quot;nistb233&quot;,
-        &quot;nistb283&quot;,
-        &quot;nistb409&quot;,
+        &quot;nistk163&quot;, &quot;nistk233&quot;, &quot;nistk283&quot;,
+        &quot;nistk409&quot;, &quot;nistk571&quot;, &quot;nistb163&quot;,
+        &quot;nistb233&quot;, &quot;nistb283&quot;, &quot;nistb409&quot;,
         &quot;nistb571&quot;
     };
     static int test_curves_bits[EC_NUM] = {
-        160, 192, 224, 256, 384, 521,
-        163, 233, 283, 409, 571,
-        163, 233, 283, 409, 571
+        160, 192, 224,
+        256, 384, 521,
+        163, 233, 283,
+        409, 571, 163,
+        233, 283, 409,
+        571
     };
-
 #endif
-
 #ifndef OPENSSL_NO_EC
     unsigned char ecdsasig[256];
     unsigned int ecdsasiglen;
     EC_KEY *ecdsa[EC_NUM];
     long ecdsa_c[EC_NUM][2];
+    int ecdsa_doit[EC_NUM];
     EC_KEY *ecdh_a[EC_NUM], *ecdh_b[EC_NUM];
     unsigned char secret_a[MAX_ECDH_SIZE], secret_b[MAX_ECDH_SIZE];
     int secret_size_a, secret_size_b;
     int ecdh_checks = 0;
     int secret_idx = 0;
     long ecdh_c[EC_NUM][2];
-    int ecdsa_doit[EC_NUM];
     int ecdh_doit[EC_NUM];
 #endif
-
-    int rsa_doit[RSA_NUM];
-    int dsa_doit[DSA_NUM];
-    int doit[ALGOR_NUM];
-    int pr_header = 0;
-    const EVP_CIPHER *evp_cipher = NULL;
-    const EVP_MD *evp_md = NULL;
-    int decrypt = 0;
-#ifndef NO_FORK
-    int multi = 0;
-#endif
-    int multiblock = 0;
-    int misalign = MAX_MISALIGNMENT + 1;
-
 #ifndef TIMES
     usertime = -1;
 #endif
 
-    apps_startup();
     memset(results, 0, sizeof(results));
 #ifndef OPENSSL_NO_DSA
     memset(dsa_key, 0, sizeof(dsa_key));
@@ -631,41 +765,15 @@ int MAIN(int argc, char **argv)
 #ifndef OPENSSL_NO_EC
     for (i = 0; i &lt; EC_NUM; i++)
         ecdsa[i] = NULL;
-    for (i = 0; i &lt; EC_NUM; i++) {
-        ecdh_a[i] = NULL;
-        ecdh_b[i] = NULL;
-    }
+    for (i = 0; i &lt; EC_NUM; i++)
+        ecdh_a[i] = ecdh_b[i] = NULL;
 #endif
-
-    if (bio_err == NULL)
-        if ((bio_err = BIO_new(BIO_s_file())) != NULL)
-            BIO_set_fp(bio_err, stderr, BIO_NOCLOSE | BIO_FP_TEXT);
-
-    if (!load_config(bio_err, NULL))
-        goto end;
-
 #ifndef OPENSSL_NO_RSA
     memset(rsa_key, 0, sizeof(rsa_key));
     for (i = 0; i &lt; RSA_NUM; i++)
         rsa_key[i] = NULL;
 #endif
 
-    if ((buf_malloc =
-         (unsigned char *)OPENSSL_malloc(BUFSIZE + misalign)) == NULL) {
-        BIO_printf(bio_err, &quot;out of memory\n&quot;);
-        goto end;
-    }
-    if ((buf2_malloc =
-         (unsigned char *)OPENSSL_malloc(BUFSIZE + misalign)) == NULL) {
-        BIO_printf(bio_err, &quot;out of memory\n&quot;);
-        goto end;
-    }
-
-    misalign = 0;               /* set later and buf/buf2 are adjusted
-                                 * accordingly */
-    buf = buf_malloc;
-    buf2 = buf2_malloc;
-
     memset(c, 0, sizeof(c));
     memset(DES_iv, 0, sizeof(DES_iv));
     memset(iv, 0, sizeof(iv));
@@ -683,521 +791,164 @@ int MAIN(int argc, char **argv)
         ecdh_doit[i] = 0;
 #endif
 
-    j = 0;
-    argc--;
-    argv++;
-    while (argc) {
-        if ((argc &gt; 0) &amp;&amp; (strcmp(*argv, &quot;-elapsed&quot;) == 0)) {
+    if ((buf_malloc =
+         (unsigned char *)OPENSSL_malloc((int)BUFSIZE + misalign)) == NULL) {
+        BIO_printf(bio_err, &quot;out of memory\n&quot;);
+        goto end;
+    }
+    if ((buf2_malloc =
+         (unsigned char *)OPENSSL_malloc((int)BUFSIZE + misalign)) == NULL) {
+        BIO_printf(bio_err, &quot;out of memory\n&quot;);
+        goto end;
+    }
+    misalign = 0;
+    buf = buf_malloc;
+    buf2 = buf2_malloc;
+
+    prog = opt_init(argc, argv, speed_options);
+    while ((o = opt_next()) != OPT_EOF) {
+        switch (o) {
+        case OPT_EOF:
+        case OPT_ERR:
+ opterr:
+            BIO_printf(bio_err, &quot;%s: Use -help for summary.\n&quot;, prog);
+            goto end;
+        case OPT_HELP:
+            opt_help(speed_options);
+            ret = 0;
+            goto end;
+        case OPT_ELAPSED:
             usertime = 0;
-            j--;                /* Otherwise, -elapsed gets confused with an
-                                 * algorithm. */
-        } else if ((argc &gt; 0) &amp;&amp; (strcmp(*argv, &quot;-evp&quot;) == 0)) {
-            argc--;
-            argv++;
-            if (argc == 0) {
-                BIO_printf(bio_err, &quot;no EVP given\n&quot;);
-                goto end;
-            }
-            evp_cipher = EVP_get_cipherbyname(*argv);
-            if (!evp_cipher) {
-                evp_md = EVP_get_digestbyname(*argv);
-            }
-            if (!evp_cipher &amp;&amp; !evp_md) {
-                BIO_printf(bio_err, &quot;%s is an unknown cipher or digest\n&quot;,
-                           *argv);
+            break;
+        case OPT_EVP:
+            evp_cipher = EVP_get_cipherbyname(opt_arg());
+            if (evp_cipher == NULL)
+                evp_md = EVP_get_digestbyname(opt_arg());
+            if (evp_cipher == NULL &amp;&amp; evp_md == NULL) {
+                BIO_printf(bio_err,
+                           &quot;%s: %s  an unknown cipher or digest\n&quot;,
+                           prog, opt_arg());
                 goto end;
             }
             doit[D_EVP] = 1;
-        } else if (argc &gt; 0 &amp;&amp; !strcmp(*argv, &quot;-decrypt&quot;)) {
+            break;
+        case OPT_DECRYPT:
             decrypt = 1;
-            j--;                /* Otherwise, -elapsed gets confused with an
-                                 * algorithm. */
-        }
+            break;
 #ifndef OPENSSL_NO_ENGINE
-        else if ((argc &gt; 0) &amp;&amp; (strcmp(*argv, &quot;-engine&quot;) == 0)) {
-            argc--;
-            argv++;
-            if (argc == 0) {
-                BIO_printf(bio_err, &quot;no engine given\n&quot;);
-                goto end;
-            }
-            setup_engine(bio_err, *argv, 0);
-            /*
-             * j will be increased again further down.  We just don't want
-             * speed to confuse an engine with an algorithm, especially when
-             * none is given (which means all of them should be run)
-             */
-            j--;
-        }
+        case OPT_ENGINE:
+            setup_engine(opt_arg(), 0);
+            break;
 #endif
 #ifndef NO_FORK
-        else if ((argc &gt; 0) &amp;&amp; (strcmp(*argv, &quot;-multi&quot;) == 0)) {
-            argc--;
-            argv++;
-            if (argc == 0) {
-                BIO_printf(bio_err, &quot;no multi count given\n&quot;);
-                goto end;
-            }
-            multi = atoi(argv[0]);
-            if (multi &lt;= 0) {
-                BIO_printf(bio_err, &quot;bad multi count\n&quot;);
-                goto end;
-            }
-            j--;                /* Otherwise, -mr gets confused with an
-                                 * algorithm. */
-        }
+        case OPT_MULTI:
+            multi = atoi(opt_arg());
+            break;
 #endif
-        else if (argc &gt; 0 &amp;&amp; !strcmp(*argv, &quot;-mr&quot;)) {
-            mr = 1;
-            j--;                /* Otherwise, -mr gets confused with an
-                                 * algorithm. */
-        } else if (argc &gt; 0 &amp;&amp; !strcmp(*argv, &quot;-mb&quot;)) {
-            multiblock = 1;
-            j--;
-        } else if (argc &gt; 0 &amp;&amp; !strcmp(*argv, &quot;-misalign&quot;)) {
-            argc--;
-            argv++;
-            if (argc == 0) {
-                BIO_printf(bio_err, &quot;no misalignment given\n&quot;);
+        case OPT_MISALIGN:
+            if (!opt_int(opt_arg(), &amp;misalign))
                 goto end;
-            }
-            misalign = atoi(argv[0]);
-            if (misalign &lt; 0 || misalign &gt; MAX_MISALIGNMENT) {
+            if (misalign &gt; MISALIGN) {
                 BIO_printf(bio_err,
-                           &quot;misalignment is outsize permitted range 0-%d\n&quot;,
-                           MAX_MISALIGNMENT);
-                goto end;
+                           &quot;%s: Maximum offset is %d\n&quot;, prog, MISALIGN);
+                goto opterr;
             }
             buf = buf_malloc + misalign;
             buf2 = buf2_malloc + misalign;
-            j--;
-        } else
-#ifndef OPENSSL_NO_MD2
-        if (strcmp(*argv, &quot;md2&quot;) == 0)
-            doit[D_MD2] = 1;
-        else
-#endif
-#ifndef OPENSSL_NO_MDC2
-        if (strcmp(*argv, &quot;mdc2&quot;) == 0)
-            doit[D_MDC2] = 1;
-        else
-#endif
-#ifndef OPENSSL_NO_MD4
-        if (strcmp(*argv, &quot;md4&quot;) == 0)
-            doit[D_MD4] = 1;
-        else
-#endif
-#ifndef OPENSSL_NO_MD5
-        if (strcmp(*argv, &quot;md5&quot;) == 0)
-            doit[D_MD5] = 1;
-        else
-#endif
-#ifndef OPENSSL_NO_MD5
-        if (strcmp(*argv, &quot;hmac&quot;) == 0)
-            doit[D_HMAC] = 1;
-        else
-#endif
-        if (strcmp(*argv, &quot;sha1&quot;) == 0)
-            doit[D_SHA1] = 1;
-        else if (strcmp(*argv, &quot;sha&quot;) == 0)
-            doit[D_SHA1] = 1, doit[D_SHA256] = 1, doit[D_SHA512] = 1;
-        else if (strcmp(*argv, &quot;sha256&quot;) == 0)
-            doit[D_SHA256] = 1;
-        else if (strcmp(*argv, &quot;sha512&quot;) == 0)
-            doit[D_SHA512] = 1;
-        else
-#ifndef OPENSSL_NO_WHIRLPOOL
-        if (strcmp(*argv, &quot;whirlpool&quot;) == 0)
-            doit[D_WHIRLPOOL] = 1;
-        else
-#endif
-#ifndef OPENSSL_NO_RMD160
-        if (strcmp(*argv, &quot;ripemd&quot;) == 0)
-            doit[D_RMD160] = 1;
-        else if (strcmp(*argv, &quot;rmd160&quot;) == 0)
-            doit[D_RMD160] = 1;
-        else if (strcmp(*argv, &quot;ripemd160&quot;) == 0)
-            doit[D_RMD160] = 1;
-        else
-#endif
-#ifndef OPENSSL_NO_RC4
-        if (strcmp(*argv, &quot;rc4&quot;) == 0)
-            doit[D_RC4] = 1;
-        else
-#endif
+            break;
+        case OPT_MR:
+            mr = 1;
+            break;
+        case OPT_MB:
+            multiblock = 1;
+            break;
+        }
+    }
+    argc = opt_num_rest();
+    argv = opt_rest();
+
+    /* Remaining arguments are algorithms. */
+    for ( ; *argv; argv++) {
+        if (found(*argv, doit_choices, &amp;i)) {
+            doit[i] = 1;
+            continue;
+        }
 #ifndef OPENSSL_NO_DES
-        if (strcmp(*argv, &quot;des-cbc&quot;) == 0)
-            doit[D_CBC_DES] = 1;
-        else if (strcmp(*argv, &quot;des-ede3&quot;) == 0)
-            doit[D_EDE3_DES] = 1;
-        else
-#endif
-#ifndef OPENSSL_NO_AES
-        if (strcmp(*argv, &quot;aes-128-cbc&quot;) == 0)
-            doit[D_CBC_128_AES] = 1;
-        else if (strcmp(*argv, &quot;aes-192-cbc&quot;) == 0)
-            doit[D_CBC_192_AES] = 1;
-        else if (strcmp(*argv, &quot;aes-256-cbc&quot;) == 0)
-            doit[D_CBC_256_AES] = 1;
-        else if (strcmp(*argv, &quot;aes-128-ige&quot;) == 0)
-            doit[D_IGE_128_AES] = 1;
-        else if (strcmp(*argv, &quot;aes-192-ige&quot;) == 0)
-            doit[D_IGE_192_AES] = 1;
-        else if (strcmp(*argv, &quot;aes-256-ige&quot;) == 0)
-            doit[D_IGE_256_AES] = 1;
-        else
-#endif
-#ifndef OPENSSL_NO_CAMELLIA
-        if (strcmp(*argv, &quot;camellia-128-cbc&quot;) == 0)
-            doit[D_CBC_128_CML] = 1;
-        else if (strcmp(*argv, &quot;camellia-192-cbc&quot;) == 0)
-            doit[D_CBC_192_CML] = 1;
-        else if (strcmp(*argv, &quot;camellia-256-cbc&quot;) == 0)
-            doit[D_CBC_256_CML] = 1;
-        else
+        if (strcmp(*argv, &quot;des&quot;) == 0) {
+            doit[D_CBC_DES] = doit[D_EDE3_DES] = 1;
+            continue;
+        }
 #endif
+        if (strcmp(*argv, &quot;sha&quot;) == 0) {
+            doit[D_SHA1] = doit[D_SHA256] = doit[D_SHA512] = 1;
+            continue;
+        }
 #ifndef OPENSSL_NO_RSA
 # ifndef RSA_NULL
         if (strcmp(*argv, &quot;openssl&quot;) == 0) {
             RSA_set_default_method(RSA_PKCS1_SSLeay());
-            j--;
-        } else
+            continue;
+        }
 # endif
-#endif                         /* !OPENSSL_NO_RSA */
-        if (strcmp(*argv, &quot;dsa512&quot;) == 0)
-            dsa_doit[R_DSA_512] = 2;
-        else if (strcmp(*argv, &quot;dsa1024&quot;) == 0)
-            dsa_doit[R_DSA_1024] = 2;
-        else if (strcmp(*argv, &quot;dsa2048&quot;) == 0)
-            dsa_doit[R_DSA_2048] = 2;
-        else if (strcmp(*argv, &quot;rsa512&quot;) == 0)
-            rsa_doit[R_RSA_512] = 2;
-        else if (strcmp(*argv, &quot;rsa1024&quot;) == 0)
-            rsa_doit[R_RSA_1024] = 2;
-        else if (strcmp(*argv, &quot;rsa2048&quot;) == 0)
-            rsa_doit[R_RSA_2048] = 2;
-        else if (strcmp(*argv, &quot;rsa3072&quot;) == 0)
-            rsa_doit[R_RSA_3072] = 2;
-        else if (strcmp(*argv, &quot;rsa4096&quot;) == 0)
-            rsa_doit[R_RSA_4096] = 2;
-        else if (strcmp(*argv, &quot;rsa7680&quot;) == 0)
-            rsa_doit[R_RSA_7680] = 2;
-        else if (strcmp(*argv, &quot;rsa15360&quot;) == 0)
-            rsa_doit[R_RSA_15360] = 2;
-        else
-#ifndef OPENSSL_NO_RC2
-        if (strcmp(*argv, &quot;rc2-cbc&quot;) == 0)
-            doit[D_CBC_RC2] = 1;
-        else if (strcmp(*argv, &quot;rc2&quot;) == 0)
-            doit[D_CBC_RC2] = 1;
-        else
-#endif
-#ifndef OPENSSL_NO_RC5
-        if (strcmp(*argv, &quot;rc5-cbc&quot;) == 0)
-            doit[D_CBC_RC5] = 1;
-        else if (strcmp(*argv, &quot;rc5&quot;) == 0)
-            doit[D_CBC_RC5] = 1;
-        else
-#endif
-#ifndef OPENSSL_NO_IDEA
-        if (strcmp(*argv, &quot;idea-cbc&quot;) == 0)
-            doit[D_CBC_IDEA] = 1;
-        else if (strcmp(*argv, &quot;idea&quot;) == 0)
-            doit[D_CBC_IDEA] = 1;
-        else
-#endif
-#ifndef OPENSSL_NO_SEED
-        if (strcmp(*argv, &quot;seed-cbc&quot;) == 0)
-            doit[D_CBC_SEED] = 1;
-        else if (strcmp(*argv, &quot;seed&quot;) == 0)
-            doit[D_CBC_SEED] = 1;
-        else
-#endif
-#ifndef OPENSSL_NO_BF
-        if (strcmp(*argv, &quot;bf-cbc&quot;) == 0)
-            doit[D_CBC_BF] = 1;
-        else if (strcmp(*argv, &quot;blowfish&quot;) == 0)
-            doit[D_CBC_BF] = 1;
-        else if (strcmp(*argv, &quot;bf&quot;) == 0)
-            doit[D_CBC_BF] = 1;
-        else
-#endif
-#ifndef OPENSSL_NO_CAST
-        if (strcmp(*argv, &quot;cast-cbc&quot;) == 0)
-            doit[D_CBC_CAST] = 1;
-        else if (strcmp(*argv, &quot;cast&quot;) == 0)
-            doit[D_CBC_CAST] = 1;
-        else if (strcmp(*argv, &quot;cast5&quot;) == 0)
-            doit[D_CBC_CAST] = 1;
-        else
+        if (strcmp(*argv, &quot;rsa&quot;) == 0) {
+            rsa_doit[R_RSA_512] = rsa_doit[R_RSA_1024] =
+                rsa_doit[R_RSA_2048] = rsa_doit[R_RSA_3072] =
+                rsa_doit[R_RSA_4096] = rsa_doit[R_RSA_7680] =
+                rsa_doit[R_RSA_15360] = 1;
+            continue;
+        }
+        if (found(*argv, rsa_choices, &amp;i)) {
+            rsa_doit[i] = 1;
+            continue;
+        }
 #endif
-#ifndef OPENSSL_NO_DES
-        if (strcmp(*argv, &quot;des&quot;) == 0) {
-            doit[D_CBC_DES] = 1;
-            doit[D_EDE3_DES] = 1;
-        } else
+#ifndef OPENSSL_NO_DSA
+        if (strcmp(*argv, &quot;dsa&quot;) == 0) {
+            dsa_doit[R_DSA_512] = dsa_doit[R_DSA_1024] =
+                dsa_doit[R_DSA_2048] = 1;
+            continue;
+        }
+        if (found(*argv, dsa_choices, &amp;i)) {
+            dsa_doit[i] = 2;
+            continue;
+        }
 #endif
 #ifndef OPENSSL_NO_AES
         if (strcmp(*argv, &quot;aes&quot;) == 0) {
-            doit[D_CBC_128_AES] = 1;
-            doit[D_CBC_192_AES] = 1;
-            doit[D_CBC_256_AES] = 1;
-        } else if (strcmp(*argv, &quot;ghash&quot;) == 0) {
-            doit[D_GHASH] = 1;
-        } else
+            doit[D_CBC_128_AES] = doit[D_CBC_192_AES] =
+                doit[D_CBC_256_AES] = 1;
+            continue;
+        }
 #endif
 #ifndef OPENSSL_NO_CAMELLIA
         if (strcmp(*argv, &quot;camellia&quot;) == 0) {
-            doit[D_CBC_128_CML] = 1;
-            doit[D_CBC_192_CML] = 1;
-            doit[D_CBC_256_CML] = 1;
-        } else
-#endif
-#ifndef OPENSSL_NO_RSA
-        if (strcmp(*argv, &quot;rsa&quot;) == 0) {
-            rsa_doit[R_RSA_512] = 1;
-            rsa_doit[R_RSA_1024] = 1;
-            rsa_doit[R_RSA_2048] = 1;
-            rsa_doit[R_RSA_3072] = 1;
-            rsa_doit[R_RSA_4096] = 1;
-            rsa_doit[R_RSA_7680] = 1;
-            rsa_doit[R_RSA_15360] = 1;
-        } else
-#endif
-#ifndef OPENSSL_NO_DSA
-        if (strcmp(*argv, &quot;dsa&quot;) == 0) {
-            dsa_doit[R_DSA_512] = 1;
-            dsa_doit[R_DSA_1024] = 1;
-            dsa_doit[R_DSA_2048] = 1;
-        } else
+            doit[D_CBC_128_CML] = doit[D_CBC_192_CML] =
+                doit[D_CBC_256_CML] = 1;
+            continue;
+        }
 #endif
 #ifndef OPENSSL_NO_EC
-        if (strcmp(*argv, &quot;ecdsap160&quot;) == 0)
-            ecdsa_doit[R_EC_P160] = 2;
-        else if (strcmp(*argv, &quot;ecdsap192&quot;) == 0)
-            ecdsa_doit[R_EC_P192] = 2;
-        else if (strcmp(*argv, &quot;ecdsap224&quot;) == 0)
-            ecdsa_doit[R_EC_P224] = 2;
-        else if (strcmp(*argv, &quot;ecdsap256&quot;) == 0)
-            ecdsa_doit[R_EC_P256] = 2;
-        else if (strcmp(*argv, &quot;ecdsap384&quot;) == 0)
-            ecdsa_doit[R_EC_P384] = 2;
-        else if (strcmp(*argv, &quot;ecdsap521&quot;) == 0)
-            ecdsa_doit[R_EC_P521] = 2;
-        else if (strcmp(*argv, &quot;ecdsak163&quot;) == 0)
-            ecdsa_doit[R_EC_K163] = 2;
-        else if (strcmp(*argv, &quot;ecdsak233&quot;) == 0)
-            ecdsa_doit[R_EC_K233] = 2;
-        else if (strcmp(*argv, &quot;ecdsak283&quot;) == 0)
-            ecdsa_doit[R_EC_K283] = 2;
-        else if (strcmp(*argv, &quot;ecdsak409&quot;) == 0)
-            ecdsa_doit[R_EC_K409] = 2;
-        else if (strcmp(*argv, &quot;ecdsak571&quot;) == 0)
-            ecdsa_doit[R_EC_K571] = 2;
-        else if (strcmp(*argv, &quot;ecdsab163&quot;) == 0)
-            ecdsa_doit[R_EC_B163] = 2;
-        else if (strcmp(*argv, &quot;ecdsab233&quot;) == 0)
-            ecdsa_doit[R_EC_B233] = 2;
-        else if (strcmp(*argv, &quot;ecdsab283&quot;) == 0)
-            ecdsa_doit[R_EC_B283] = 2;
-        else if (strcmp(*argv, &quot;ecdsab409&quot;) == 0)
-            ecdsa_doit[R_EC_B409] = 2;
-        else if (strcmp(*argv, &quot;ecdsab571&quot;) == 0)
-            ecdsa_doit[R_EC_B571] = 2;
-        else if (strcmp(*argv, &quot;ecdsa&quot;) == 0) {
+        if (strcmp(*argv, &quot;ecdsa&quot;) == 0) {
             for (i = 0; i &lt; EC_NUM; i++)
                 ecdsa_doit[i] = 1;
-        } else if (strcmp(*argv, &quot;ecdhp160&quot;) == 0)
-            ecdh_doit[R_EC_P160] = 2;
-        else if (strcmp(*argv, &quot;ecdhp192&quot;) == 0)
-            ecdh_doit[R_EC_P192] = 2;
-        else if (strcmp(*argv, &quot;ecdhp224&quot;) == 0)
-            ecdh_doit[R_EC_P224] = 2;
-        else if (strcmp(*argv, &quot;ecdhp256&quot;) == 0)
-            ecdh_doit[R_EC_P256] = 2;
-        else if (strcmp(*argv, &quot;ecdhp384&quot;) == 0)
-            ecdh_doit[R_EC_P384] = 2;
-        else if (strcmp(*argv, &quot;ecdhp521&quot;) == 0)
-            ecdh_doit[R_EC_P521] = 2;
-        else if (strcmp(*argv, &quot;ecdhk163&quot;) == 0)
-            ecdh_doit[R_EC_K163] = 2;
-        else if (strcmp(*argv, &quot;ecdhk233&quot;) == 0)
-            ecdh_doit[R_EC_K233] = 2;
-        else if (strcmp(*argv, &quot;ecdhk283&quot;) == 0)
-            ecdh_doit[R_EC_K283] = 2;
-        else if (strcmp(*argv, &quot;ecdhk409&quot;) == 0)
-            ecdh_doit[R_EC_K409] = 2;
-        else if (strcmp(*argv, &quot;ecdhk571&quot;) == 0)
-            ecdh_doit[R_EC_K571] = 2;
-        else if (strcmp(*argv, &quot;ecdhb163&quot;) == 0)
-            ecdh_doit[R_EC_B163] = 2;
-        else if (strcmp(*argv, &quot;ecdhb233&quot;) == 0)
-            ecdh_doit[R_EC_B233] = 2;
-        else if (strcmp(*argv, &quot;ecdhb283&quot;) == 0)
-            ecdh_doit[R_EC_B283] = 2;
-        else if (strcmp(*argv, &quot;ecdhb409&quot;) == 0)
-            ecdh_doit[R_EC_B409] = 2;
-        else if (strcmp(*argv, &quot;ecdhb571&quot;) == 0)
-            ecdh_doit[R_EC_B571] = 2;
-        else if (strcmp(*argv, &quot;ecdh&quot;) == 0) {
+            continue;
+        }
+        if (found(*argv, ecdsa_choices, &amp;i)) {
+            ecdsa_doit[i] = 2;
+            continue;
+        }
+        if (strcmp(*argv, &quot;ecdh&quot;) == 0) {
             for (i = 0; i &lt; EC_NUM; i++)
                 ecdh_doit[i] = 1;
-        } else
-#endif
-        {
-            BIO_printf(bio_err, &quot;Error: bad option or value\n&quot;);
-            BIO_printf(bio_err, &quot;\n&quot;);
-            BIO_printf(bio_err, &quot;Available values:\n&quot;);
-#ifndef OPENSSL_NO_MD2
-            BIO_printf(bio_err, &quot;md2      &quot;);
-#endif
-#ifndef OPENSSL_NO_MDC2
-            BIO_printf(bio_err, &quot;mdc2     &quot;);
-#endif
-#ifndef OPENSSL_NO_MD4
-            BIO_printf(bio_err, &quot;md4      &quot;);
-#endif
-#ifndef OPENSSL_NO_MD5
-            BIO_printf(bio_err, &quot;md5      &quot;);
-            BIO_printf(bio_err, &quot;hmac     &quot;);
-#endif
-            BIO_printf(bio_err, &quot;sha1     &quot;);
-            BIO_printf(bio_err, &quot;sha256   &quot;);
-            BIO_printf(bio_err, &quot;sha512   &quot;);
-#ifndef OPENSSL_NO_WHIRLPOOL
-            BIO_printf(bio_err, &quot;whirlpool&quot;);
-#endif
-#ifndef OPENSSL_NO_RMD160
-            BIO_printf(bio_err, &quot;rmd160&quot;);
-#endif
-            BIO_printf(bio_err, &quot;\n&quot;);
-
-#ifndef OPENSSL_NO_IDEA
-            BIO_printf(bio_err, &quot;idea-cbc &quot;);
-#endif
-#ifndef OPENSSL_NO_SEED
-            BIO_printf(bio_err, &quot;seed-cbc &quot;);
-#endif
-#ifndef OPENSSL_NO_RC2
-            BIO_printf(bio_err, &quot;rc2-cbc  &quot;);
-#endif
-#ifndef OPENSSL_NO_RC5
-            BIO_printf(bio_err, &quot;rc5-cbc  &quot;);
-#endif
-#ifndef OPENSSL_NO_BF
-            BIO_printf(bio_err, &quot;bf-cbc&quot;);
-#endif
-#if !defined(OPENSSL_NO_IDEA) || !defined(OPENSSL_NO_SEED) || !defined(OPENSSL_NO_RC2) || \
-    !defined(OPENSSL_NO_BF) || !defined(OPENSSL_NO_RC5)
-            BIO_printf(bio_err, &quot;\n&quot;);
-#endif
-#ifndef OPENSSL_NO_DES
-            BIO_printf(bio_err, &quot;des-cbc  des-ede3 &quot;);
-#endif
-#ifndef OPENSSL_NO_AES
-            BIO_printf(bio_err, &quot;aes-128-cbc aes-192-cbc aes-256-cbc &quot;);
-            BIO_printf(bio_err, &quot;aes-128-ige aes-192-ige aes-256-ige &quot;);
-#endif
-#ifndef OPENSSL_NO_CAMELLIA
-            BIO_printf(bio_err, &quot;\n&quot;);
-            BIO_printf(bio_err,
-                       &quot;camellia-128-cbc camellia-192-cbc camellia-256-cbc &quot;);
-#endif
-#ifndef OPENSSL_NO_RC4
-            BIO_printf(bio_err, &quot;rc4&quot;);
-#endif
-            BIO_printf(bio_err, &quot;\n&quot;);
-
-#ifndef OPENSSL_NO_RSA
-            BIO_printf(bio_err,
-                       &quot;rsa512   rsa1024  rsa2048  rsa3072  rsa4096\n&quot;);
-            BIO_printf(bio_err, &quot;rsa7680  rsa15360\n&quot;);
-#endif
-
-#ifndef OPENSSL_NO_DSA
-            BIO_printf(bio_err, &quot;dsa512   dsa1024  dsa2048\n&quot;);
-#endif
-#ifndef OPENSSL_NO_EC
-            BIO_printf(bio_err, &quot;ecdsap160 ecdsap192 ecdsap224 &quot;
-                       &quot;ecdsap256 ecdsap384 ecdsap521\n&quot;);
-            BIO_printf(bio_err,
-                       &quot;ecdsak163 ecdsak233 ecdsak283 ecdsak409 ecdsak571\n&quot;);
-            BIO_printf(bio_err,
-                       &quot;ecdsab163 ecdsab233 ecdsab283 ecdsab409 ecdsab571\n&quot;);
-            BIO_printf(bio_err, &quot;ecdsa\n&quot;);
-            BIO_printf(bio_err, &quot;ecdhp160  ecdhp192  ecdhp224 &quot;
-                       &quot;ecdhp256  ecdhp384  ecdhp521\n&quot;);
-            BIO_printf(bio_err,
-                       &quot;ecdhk163  ecdhk233  ecdhk283  ecdhk409  ecdhk571\n&quot;);
-            BIO_printf(bio_err,
-                       &quot;ecdhb163  ecdhb233  ecdhb283  ecdhb409  ecdhb571\n&quot;);
-            BIO_printf(bio_err, &quot;ecdh\n&quot;);
-#endif
-
-#ifndef OPENSSL_NO_IDEA
-            BIO_printf(bio_err, &quot;idea     &quot;);
-#endif
-#ifndef OPENSSL_NO_SEED
-            BIO_printf(bio_err, &quot;seed     &quot;);
-#endif
-#ifndef OPENSSL_NO_RC2
-            BIO_printf(bio_err, &quot;rc2      &quot;);
-#endif
-#ifndef OPENSSL_NO_DES
-            BIO_printf(bio_err, &quot;des      &quot;);
-#endif
-#ifndef OPENSSL_NO_AES
-            BIO_printf(bio_err, &quot;aes      &quot;);
-#endif
-#ifndef OPENSSL_NO_CAMELLIA
-            BIO_printf(bio_err, &quot;camellia &quot;);
-#endif
-#ifndef OPENSSL_NO_RSA
-            BIO_printf(bio_err, &quot;rsa      &quot;);
-#endif
-#ifndef OPENSSL_NO_BF
-            BIO_printf(bio_err, &quot;blowfish&quot;);
-#endif
-#if !defined(OPENSSL_NO_IDEA) || !defined(OPENSSL_NO_SEED) || \
-    !defined(OPENSSL_NO_RC2) || !defined(OPENSSL_NO_DES) || \
-    !defined(OPENSSL_NO_RSA) || !defined(OPENSSL_NO_BF) || \
-    !defined(OPENSSL_NO_AES) || !defined(OPENSSL_NO_CAMELLIA)
-            BIO_printf(bio_err, &quot;\n&quot;);
-#endif
-
-            BIO_printf(bio_err, &quot;\n&quot;);
-            BIO_printf(bio_err, &quot;Available options:\n&quot;);
-#if defined(TIMES) || defined(USE_TOD)
-            BIO_printf(bio_err, &quot;-elapsed        &quot;
-                       &quot;measure time in real time instead of CPU user time.\n&quot;);
-#endif
-#ifndef OPENSSL_NO_ENGINE
-            BIO_printf(bio_err,
-                       &quot;-engine e       &quot;
-                       &quot;use engine e, possibly a hardware device.\n&quot;);
-#endif
-            BIO_printf(bio_err, &quot;-evp e          &quot; &quot;use EVP e.\n&quot;);
-            BIO_printf(bio_err,
-                       &quot;-decrypt        &quot;
-                       &quot;time decryption instead of encryption (only EVP).\n&quot;);
-            BIO_printf(bio_err,
-                       &quot;-mr             &quot;
-                       &quot;produce machine readable output.\n&quot;);
-            BIO_printf(bio_err,
-                       &quot;-mb             &quot;
-                       &quot;perform multi-block benchmark (for specific ciphers)\n&quot;);
-            BIO_printf(bio_err,
-                       &quot;-misalign n     &quot;
-                       &quot;perform benchmark with misaligned data\n&quot;);
-#ifndef NO_FORK
-            BIO_printf(bio_err,
-                       &quot;-multi n        &quot; &quot;run n benchmarks in parallel.\n&quot;);
-#endif
-            goto end;
+            continue;
         }
-        argc--;
-        argv++;
-        j++;
+        if (found(*argv, ecdh_choices, &amp;i)) {
+            ecdh_doit[i] = 2;
+            continue;
+        }
+#endif
+        BIO_printf(bio_err, &quot;%s: Unknown algorithm %s\n&quot;, prog, *argv);
+        goto end;
     }
 
 #ifndef NO_FORK
@@ -1205,11 +956,11 @@ int MAIN(int argc, char **argv)
         goto show_res;
 #endif
 
-    if (j == 0) {
-        for (i = 0; i &lt; ALGOR_NUM; i++) {
+    /* No parameters; turn on everything. */
+    if (argc == 0) {
+        for (i = 0; i &lt; ALGOR_NUM; i++)
             if (i != D_EVP)
                 doit[i] = 1;
-        }
         for (i = 0; i &lt; RSA_NUM; i++)
             rsa_doit[i] = 1;
         for (i = 0; i &lt; DSA_NUM; i++)
@@ -1449,6 +1200,7 @@ int MAIN(int argc, char **argv)
             }
         }
     }
+
     ecdh_c[R_EC_P160][0] = count / 1000;
     ecdh_c[R_EC_P160][1] = count / 1000;
     for (i = R_EC_P192; i &lt;= R_EC_P521; i++) {
@@ -1910,7 +1662,7 @@ int MAIN(int argc, char **argv)
                 goto end;
             }
             multiblock_speed(evp_cipher);
-            mret = 0;
+            ret = 0;
             goto end;
         }
 #endif
@@ -1965,16 +1717,15 @@ int MAIN(int argc, char **argv)
             print_result(D_EVP, j, count, d);
         }
     }
-#ifndef OPENSSL_SYS_WIN32
-#endif
+
     RAND_bytes(buf, 36);
 #ifndef OPENSSL_NO_RSA
     for (j = 0; j &lt; RSA_NUM; j++) {
-        int ret;
+        int st;
         if (!rsa_doit[j])
             continue;
-        ret = RSA_sign(NID_md5_sha1, buf, 36, buf2, &amp;rsa_num, rsa_key[j]);
-        if (ret == 0) {
+        st = RSA_sign(NID_md5_sha1, buf, 36, buf2, &amp;rsa_num, rsa_key[j]);
+        if (st == 0) {
             BIO_printf(bio_err,
                        &quot;RSA sign failure.  No RSA sign will be done.\n&quot;);
             ERR_print_errors(bio_err);
@@ -1985,9 +1736,9 @@ int MAIN(int argc, char **argv)
             /* RSA_blinding_on(rsa_key[j],NULL); */
             Time_F(START);
             for (count = 0, run = 1; COND(rsa_c[j][0]); count++) {
-                ret = RSA_sign(NID_md5_sha1, buf, 36, buf2,
-                               &amp;rsa_num, rsa_key[j]);
-                if (ret == 0) {
+                st = RSA_sign(NID_md5_sha1, buf, 36, buf2,
+                              &amp;rsa_num, rsa_key[j]);
+                if (st == 0) {
                     BIO_printf(bio_err, &quot;RSA sign failure\n&quot;);
                     ERR_print_errors(bio_err);
                     count = 1;
@@ -2003,8 +1754,8 @@ int MAIN(int argc, char **argv)
             rsa_count = count;
         }
 
-        ret = RSA_verify(NID_md5_sha1, buf, 36, buf2, rsa_num, rsa_key[j]);
-        if (ret &lt;= 0) {
+        st = RSA_verify(NID_md5_sha1, buf, 36, buf2, rsa_num, rsa_key[j]);
+        if (st &lt;= 0) {
             BIO_printf(bio_err,
                        &quot;RSA verify failure.  No RSA verify will be done.\n&quot;);
             ERR_print_errors(bio_err);
@@ -2014,9 +1765,9 @@ int MAIN(int argc, char **argv)
                                rsa_c[j][1], rsa_bits[j], RSA_SECONDS);
             Time_F(START);
             for (count = 0, run = 1; COND(rsa_c[j][1]); count++) {
-                ret = RSA_verify(NID_md5_sha1, buf, 36, buf2,
-                                 rsa_num, rsa_key[j]);
-                if (ret &lt;= 0) {
+                st = RSA_verify(NID_md5_sha1, buf, 36, buf2,
+                                rsa_num, rsa_key[j]);
+                if (st &lt;= 0) {
                     BIO_printf(bio_err, &quot;RSA verify failure\n&quot;);
                     ERR_print_errors(bio_err);
                     count = 1;
@@ -2047,15 +1798,15 @@ int MAIN(int argc, char **argv)
     }
     for (j = 0; j &lt; DSA_NUM; j++) {
         unsigned int kk;
-        int ret;
+        int st;
 
         if (!dsa_doit[j])
             continue;
 
         /* DSA_generate_key(dsa_key[j]); */
         /* DSA_sign_setup(dsa_key[j],NULL); */
-        ret = DSA_sign(EVP_PKEY_DSA, buf, 20, buf2, &amp;kk, dsa_key[j]);
-        if (ret == 0) {
+        st = DSA_sign(EVP_PKEY_DSA, buf, 20, buf2, &amp;kk, dsa_key[j]);
+        if (st == 0) {
             BIO_printf(bio_err,
                        &quot;DSA sign failure.  No DSA sign will be done.\n&quot;);
             ERR_print_errors(bio_err);
@@ -2065,8 +1816,8 @@ int MAIN(int argc, char **argv)
                                dsa_c[j][0], dsa_bits[j], DSA_SECONDS);
             Time_F(START);
             for (count = 0, run = 1; COND(dsa_c[j][0]); count++) {
-                ret = DSA_sign(EVP_PKEY_DSA, buf, 20, buf2, &amp;kk, dsa_key[j]);
-                if (ret == 0) {
+                st = DSA_sign(EVP_PKEY_DSA, buf, 20, buf2, &amp;kk, dsa_key[j]);
+                if (st == 0) {
                     BIO_printf(bio_err, &quot;DSA sign failure\n&quot;);
                     ERR_print_errors(bio_err);
                     count = 1;
@@ -2082,8 +1833,8 @@ int MAIN(int argc, char **argv)
             rsa_count = count;
         }
 
-        ret = DSA_verify(EVP_PKEY_DSA, buf, 20, buf2, kk, dsa_key[j]);
-        if (ret &lt;= 0) {
+        st = DSA_verify(EVP_PKEY_DSA, buf, 20, buf2, kk, dsa_key[j]);
+        if (st &lt;= 0) {
             BIO_printf(bio_err,
                        &quot;DSA verify failure.  No DSA verify will be done.\n&quot;);
             ERR_print_errors(bio_err);
@@ -2093,8 +1844,8 @@ int MAIN(int argc, char **argv)
                                dsa_c[j][1], dsa_bits[j], DSA_SECONDS);
             Time_F(START);
             for (count = 0, run = 1; COND(dsa_c[j][1]); count++) {
-                ret = DSA_verify(EVP_PKEY_DSA, buf, 20, buf2, kk, dsa_key[j]);
-                if (ret &lt;= 0) {
+                st = DSA_verify(EVP_PKEY_DSA, buf, 20, buf2, kk, dsa_key[j]);
+                if (st &lt;= 0) {
                     BIO_printf(bio_err, &quot;DSA verify failure\n&quot;);
                     ERR_print_errors(bio_err);
                     count = 1;
@@ -2125,7 +1876,7 @@ int MAIN(int argc, char **argv)
         rnd_fake = 1;
     }
     for (j = 0; j &lt; EC_NUM; j++) {
-        int ret;
+        int st;
 
         if (!ecdsa_doit[j])
             continue;           /* Ignore Curve */
@@ -2136,11 +1887,10 @@ int MAIN(int argc, char **argv)
             rsa_count = 1;
         } else {
             EC_KEY_precompute_mult(ecdsa[j], NULL);
-
             /* Perform ECDSA signature test */
             EC_KEY_generate_key(ecdsa[j]);
-            ret = ECDSA_sign(0, buf, 20, ecdsasig, &amp;ecdsasiglen, ecdsa[j]);
-            if (ret == 0) {
+            st = ECDSA_sign(0, buf, 20, ecdsasig, &amp;ecdsasiglen, ecdsa[j]);
+            if (st == 0) {
                 BIO_printf(bio_err,
                            &quot;ECDSA sign failure.  No ECDSA sign will be done.\n&quot;);
                 ERR_print_errors(bio_err);
@@ -2152,9 +1902,9 @@ int MAIN(int argc, char **argv)
 
                 Time_F(START);
                 for (count = 0, run = 1; COND(ecdsa_c[j][0]); count++) {
-                    ret = ECDSA_sign(0, buf, 20,
-                                     ecdsasig, &amp;ecdsasiglen, ecdsa[j]);
-                    if (ret == 0) {
+                    st = ECDSA_sign(0, buf, 20,
+                                    ecdsasig, &amp;ecdsasiglen, ecdsa[j]);
+                    if (st == 0) {
                         BIO_printf(bio_err, &quot;ECDSA sign failure\n&quot;);
                         ERR_print_errors(bio_err);
                         count = 1;
@@ -2172,8 +1922,8 @@ int MAIN(int argc, char **argv)
             }
 
             /* Perform ECDSA verification test */
-            ret = ECDSA_verify(0, buf, 20, ecdsasig, ecdsasiglen, ecdsa[j]);
-            if (ret != 1) {
+            st = ECDSA_verify(0, buf, 20, ecdsasig, ecdsasiglen, ecdsa[j]);
+            if (st != 1) {
                 BIO_printf(bio_err,
                            &quot;ECDSA verify failure.  No ECDSA verify will be done.\n&quot;);
                 ERR_print_errors(bio_err);
@@ -2184,10 +1934,9 @@ int MAIN(int argc, char **argv)
                                    test_curves_bits[j], ECDSA_SECONDS);
                 Time_F(START);
                 for (count = 0, run = 1; COND(ecdsa_c[j][1]); count++) {
-                    ret =
-                        ECDSA_verify(0, buf, 20, ecdsasig, ecdsasiglen,
-                                     ecdsa[j]);
-                    if (ret != 1) {
+                    st = ECDSA_verify(0, buf, 20, ecdsasig, ecdsasiglen,
+                                      ecdsa[j]);
+                    if (st != 1) {
                         BIO_printf(bio_err, &quot;ECDSA verify failure\n&quot;);
                         ERR_print_errors(bio_err);
                         count = 1;
@@ -2211,6 +1960,9 @@ int MAIN(int argc, char **argv)
     }
     if (rnd_fake)
         RAND_cleanup();
+#endif
+
+#ifndef OPENSSL_NO_EC
     if (RAND_status() != 1) {
         RAND_seed(rnd_seed, sizeof rnd_seed);
         rnd_fake = 1;
@@ -2306,8 +2058,8 @@ int MAIN(int argc, char **argv)
  show_res:
 #endif
     if (!mr) {
-        fprintf(stdout, &quot;%s\n&quot;, SSLeay_version(SSLEAY_VERSION));
-        fprintf(stdout, &quot;%s\n&quot;, SSLeay_version(SSLEAY_BUILT_ON));
+        printf(&quot;%s\n&quot;, SSLeay_version(SSLEAY_VERSION));
+        printf(&quot;%s\n&quot;, SSLeay_version(SSLEAY_BUILT_ON));
         printf(&quot;options:&quot;);
         printf(&quot;%s &quot;, BN_options());
 #ifndef OPENSSL_NO_MD2
@@ -2328,36 +2080,36 @@ int MAIN(int argc, char **argv)
 #ifndef OPENSSL_NO_BF
         printf(&quot;%s &quot;, BF_options());
 #endif
-        fprintf(stdout, &quot;\n%s\n&quot;, SSLeay_version(SSLEAY_CFLAGS));
+        printf(&quot;\n%s\n&quot;, SSLeay_version(SSLEAY_CFLAGS));
     }
 
     if (pr_header) {
         if (mr)
-            fprintf(stdout, &quot;+H&quot;);
+            printf(&quot;+H&quot;);
         else {
-            fprintf(stdout,
-                    &quot;The 'numbers' are in 1000s of bytes per second processed.\n&quot;);
-            fprintf(stdout, &quot;type        &quot;);
+            printf
+                (&quot;The 'numbers' are in 1000s of bytes per second processed.\n&quot;);
+            printf(&quot;type        &quot;);
         }
         for (j = 0; j &lt; SIZE_NUM; j++)
-            fprintf(stdout, mr ? &quot;:%d&quot; : &quot;%7d bytes&quot;, lengths[j]);
-        fprintf(stdout, &quot;\n&quot;);
+            printf(mr ? &quot;:%d&quot; : &quot;%7d bytes&quot;, lengths[j]);
+        printf(&quot;\n&quot;);
     }
 
     for (k = 0; k &lt; ALGOR_NUM; k++) {
         if (!doit[k])
             continue;
         if (mr)
-            fprintf(stdout, &quot;+F:%d:%s&quot;, k, names[k]);
+            printf(&quot;+F:%d:%s&quot;, k, names[k]);
         else
-            fprintf(stdout, &quot;%-13s&quot;, names[k]);
+            printf(&quot;%-13s&quot;, names[k]);
         for (j = 0; j &lt; SIZE_NUM; j++) {
             if (results[k][j] &gt; 10000 &amp;&amp; !mr)
-                fprintf(stdout, &quot; %11.2fk&quot;, results[k][j] / 1e3);
+                printf(&quot; %11.2fk&quot;, results[k][j] / 1e3);
             else
-                fprintf(stdout, mr ? &quot;:%.2f&quot; : &quot; %11.2f &quot;, results[k][j]);
+                printf(mr ? &quot;:%.2f&quot; : &quot; %11.2f &quot;, results[k][j]);
         }
-        fprintf(stdout, &quot;\n&quot;);
+        printf(&quot;\n&quot;);
     }
 #ifndef OPENSSL_NO_RSA
     j = 1;
@@ -2369,12 +2121,12 @@ int MAIN(int argc, char **argv)
             j = 0;
         }
         if (mr)
-            fprintf(stdout, &quot;+F2:%u:%u:%f:%f\n&quot;,
-                    k, rsa_bits[k], rsa_results[k][0], rsa_results[k][1]);
+            printf(&quot;+F2:%u:%u:%f:%f\n&quot;,
+                   k, rsa_bits[k], rsa_results[k][0], rsa_results[k][1]);
         else
-            fprintf(stdout, &quot;rsa %4u bits %8.6fs %8.6fs %8.1f %8.1f\n&quot;,
-                    rsa_bits[k], rsa_results[k][0], rsa_results[k][1],
-                    1.0 / rsa_results[k][0], 1.0 / rsa_results[k][1]);
+            printf(&quot;rsa %4u bits %8.6fs %8.6fs %8.1f %8.1f\n&quot;,
+                   rsa_bits[k], rsa_results[k][0], rsa_results[k][1],
+                   1.0 / rsa_results[k][0], 1.0 / rsa_results[k][1]);
     }
 #endif
 #ifndef OPENSSL_NO_DSA
@@ -2387,12 +2139,12 @@ int MAIN(int argc, char **argv)
             j = 0;
         }
         if (mr)
-            fprintf(stdout, &quot;+F3:%u:%u:%f:%f\n&quot;,
-                    k, dsa_bits[k], dsa_results[k][0], dsa_results[k][1]);
+            printf(&quot;+F3:%u:%u:%f:%f\n&quot;,
+                   k, dsa_bits[k], dsa_results[k][0], dsa_results[k][1]);
         else
-            fprintf(stdout, &quot;dsa %4u bits %8.6fs %8.6fs %8.1f %8.1f\n&quot;,
-                    dsa_bits[k], dsa_results[k][0], dsa_results[k][1],
-                    1.0 / dsa_results[k][0], 1.0 / dsa_results[k][1]);
+            printf(&quot;dsa %4u bits %8.6fs %8.6fs %8.1f %8.1f\n&quot;,
+                   dsa_bits[k], dsa_results[k][0], dsa_results[k][1],
+                   1.0 / dsa_results[k][0], 1.0 / dsa_results[k][1]);
     }
 #endif
 #ifndef OPENSSL_NO_EC
@@ -2406,17 +2158,19 @@ int MAIN(int argc, char **argv)
         }
 
         if (mr)
-            fprintf(stdout, &quot;+F4:%u:%u:%f:%f\n&quot;,
-                    k, test_curves_bits[k],
-                    ecdsa_results[k][0], ecdsa_results[k][1]);
+            printf(&quot;+F4:%u:%u:%f:%f\n&quot;,
+                   k, test_curves_bits[k],
+                   ecdsa_results[k][0], ecdsa_results[k][1]);
         else
-            fprintf(stdout,
-                    &quot;%4u bit ecdsa (%s) %8.4fs %8.4fs %8.1f %8.1f\n&quot;,
-                    test_curves_bits[k],
-                    test_curves_names[k],
-                    ecdsa_results[k][0], ecdsa_results[k][1],
-                    1.0 / ecdsa_results[k][0], 1.0 / ecdsa_results[k][1]);
+            printf(&quot;%4u bit ecdsa (%s) %8.4fs %8.4fs %8.1f %8.1f\n&quot;,
+                   test_curves_bits[k],
+                   test_curves_names[k],
+                   ecdsa_results[k][0], ecdsa_results[k][1],
+                   1.0 / ecdsa_results[k][0], 1.0 / ecdsa_results[k][1]);
     }
+#endif
+
+#ifndef OPENSSL_NO_EC
     j = 1;
     for (k = 0; k &lt; EC_NUM; k++) {
         if (!ecdh_doit[k])
@@ -2426,26 +2180,24 @@ int MAIN(int argc, char **argv)
             j = 0;
         }
         if (mr)
-            fprintf(stdout, &quot;+F5:%u:%u:%f:%f\n&quot;,
-                    k, test_curves_bits[k],
-                    ecdh_results[k][0], 1.0 / ecdh_results[k][0]);
+            printf(&quot;+F5:%u:%u:%f:%f\n&quot;,
+                   k, test_curves_bits[k],
+                   ecdh_results[k][0], 1.0 / ecdh_results[k][0]);
 
         else
-            fprintf(stdout, &quot;%4u bit ecdh (%s) %8.4fs %8.1f\n&quot;,
-                    test_curves_bits[k],
-                    test_curves_names[k],
-                    ecdh_results[k][0], 1.0 / ecdh_results[k][0]);
+            printf(&quot;%4u bit ecdh (%s) %8.4fs %8.1f\n&quot;,
+                   test_curves_bits[k],
+                   test_curves_names[k],
+                   ecdh_results[k][0], 1.0 / ecdh_results[k][0]);
     }
 #endif
 
-    mret = 0;
+    ret = 0;
 
  end:
     ERR_print_errors(bio_err);
-    if (buf_malloc != NULL)
-        OPENSSL_free(buf_malloc);
-    if (buf2_malloc != NULL)
-        OPENSSL_free(buf2_malloc);
+    OPENSSL_free(save_buf);
+    OPENSSL_free(save_buf2);
 #ifndef OPENSSL_NO_RSA
     for (i = 0; i &lt; RSA_NUM; i++)
         RSA_free(rsa_key[i]);
@@ -2456,16 +2208,14 @@ int MAIN(int argc, char **argv)
 #endif
 
 #ifndef OPENSSL_NO_EC
-    for (i = 0; i &lt; EC_NUM; i++)
-        EC_KEY_free(ecdsa[i]);
     for (i = 0; i &lt; EC_NUM; i++) {
+        EC_KEY_free(ecdsa[i]);
         EC_KEY_free(ecdh_a[i]);
         EC_KEY_free(ecdh_b[i]);
     }
 #endif
 
-    apps_shutdown();
-    OPENSSL_EXIT(mret);
+    return (ret);
 }
 
 static void print_message(const char *s, long num, int length)
@@ -2617,25 +2367,6 @@ static int do_multi(int multi)
                     rsa_results[k][1] = 1 / (1 / rsa_results[k][1] + 1 / d);
                 else
                     rsa_results[k][1] = d;
-            } else if (!strncmp(buf, &quot;+F2:&quot;, 4)) {
-                int k;
-                double d;
-
-                p = buf + 4;
-                k = atoi(sstrsep(&amp;p, sep));
-                sstrsep(&amp;p, sep);
-
-                d = atof(sstrsep(&amp;p, sep));
-                if (n)
-                    rsa_results[k][0] = 1 / (1 / rsa_results[k][0] + 1 / d);
-                else
-                    rsa_results[k][0] = d;
-
-                d = atof(sstrsep(&amp;p, sep));
-                if (n)
-                    rsa_results[k][1] = 1 / (1 / rsa_results[k][1] + 1 / d);
-                else
-                    rsa_results[k][1] = d;
             }
 # ifndef OPENSSL_NO_DSA
             else if (!strncmp(buf, &quot;+F3:&quot;, 4)) {
@@ -2682,6 +2413,9 @@ static int do_multi(int multi)
                 else
                     ecdsa_results[k][1] = d;
             }
+# endif
+
+# ifndef OPENSSL_NO_EC
             else if (!strncmp(buf, &quot;+F5:&quot;, 4)) {
                 int k;
                 double d;
@@ -2700,6 +2434,7 @@ static int do_multi(int multi)
 # endif
 
             else if (!strncmp(buf, &quot;+H:&quot;, 3)) {
+                ;
             } else
                 fprintf(stderr, &quot;Unknown type '%s' from child %d\n&quot;, buf, n);
         }
@@ -2724,11 +2459,10 @@ static void multiblock_speed(const EVP_CIPHER *evp_cipher)
     inp = OPENSSL_malloc(mblengths[num - 1]);
     out = OPENSSL_malloc(mblengths[num - 1] + 1024);
     if (!inp || !out) {
-        BIO_printf(bio_err,&quot;Out of memory\n&quot;);
+        BIO_printf(bio_err, &quot;Out of memory\n&quot;);
         goto end;
     }
 
-
     EVP_CIPHER_CTX_init(&amp;ctx);
     EVP_EncryptInit_ex(&amp;ctx, evp_cipher, NULL, no_key, no_iv);
     EVP_CIPHER_CTX_ctrl(&amp;ctx, EVP_CTRL_AEAD_SET_MAC_KEY, sizeof(no_key),
@@ -2779,8 +2513,7 @@ static void multiblock_speed(const EVP_CIPHER *evp_cipher)
             }
         }
         d = Time_F(STOP);
-        BIO_printf(bio_err,
-                   mr ? &quot;+R:%d:%s:%f\n&quot;
+        BIO_printf(bio_err, mr ? &quot;+R:%d:%s:%f\n&quot;
                    : &quot;%d %s's in %.2fs\n&quot;, count, &quot;evp&quot;, d);
         results[D_EVP][j] = ((double)count) / d * mblengths[j];
     }
diff --git a/apps/spkac.c b/apps/spkac.c
index 8b06ec4..ee2e596 100644
--- a/apps/spkac.c
+++ b/apps/spkac.c
@@ -1,5 +1,3 @@
-/* apps/spkac.c */
-
 /*
  * Written by Dr Stephen N Henson (<A HREF="../../../mailman/listinfo/openssl-commits.html">steve at openssl.org</A>) for the OpenSSL project
  * 1999. Based on an original idea by Massimiliano Pala (<A HREF="../../../mailman/listinfo/openssl-commits.html">madwolf at openca.org</A>).
@@ -70,128 +68,105 @@
 #include &lt;openssl/x509.h&gt;
 #include &lt;openssl/pem.h&gt;
 
-#undef PROG
-#define PROG    spkac_main
-
-/*-
- * -in arg      - input file - default stdin
- * -out arg     - output file - default stdout
- */
-
-int MAIN(int, char **);
+typedef enum OPTION_choice {
+    OPT_ERR = -1, OPT_EOF = 0, OPT_HELP,
+    OPT_NOOUT, OPT_PUBKEY, OPT_VERIFY, OPT_IN, OPT_OUT,
+    OPT_ENGINE, OPT_KEY, OPT_CHALLENGE, OPT_PASSIN, OPT_SPKAC,
+    OPT_SPKSECT
+} OPTION_CHOICE;
+
+OPTIONS spkac_options[] = {
+    {&quot;help&quot;, OPT_HELP, '-', &quot;Display this summary&quot;},
+    {&quot;in&quot;, OPT_IN, '&lt;', &quot;Input file&quot;},
+    {&quot;out&quot;, OPT_OUT, '&gt;', &quot;Output file&quot;},
+    {&quot;key&quot;, OPT_KEY, '&lt;', &quot;Create SPKAC using private key&quot;},
+    {&quot;passin&quot;, OPT_PASSIN, 's', &quot;Input file pass phrase source&quot;},
+    {&quot;challenge&quot;, OPT_CHALLENGE, 's', &quot;Challenge string&quot;},
+    {&quot;spkac&quot;, OPT_SPKAC, 's', &quot;Alternative SPKAC name&quot;},
+    {&quot;noout&quot;, OPT_NOOUT, '-', &quot;Don't print SPKAC&quot;},
+    {&quot;pubkey&quot;, OPT_PUBKEY, '-', &quot;Output public key&quot;},
+    {&quot;verify&quot;, OPT_VERIFY, '-', &quot;Verify SPKAC signature&quot;},
+    {&quot;spksect&quot;, OPT_SPKSECT, 's'},
+#ifndef OPENSSL_NO_ENGINE
+    {&quot;engine&quot;, OPT_ENGINE, 's', &quot;Use engine, possibly a hardware device&quot;},
+#endif
+    {NULL}
+};
 
-int MAIN(int argc, char **argv)
+int spkac_main(int argc, char **argv)
 {
-    ENGINE *e = NULL;
-    int i, badops = 0, ret = 1;
     BIO *in = NULL, *out = NULL;
-    int verify = 0, noout = 0, pubkey = 0;
-    char *infile = NULL, *outfile = NULL, *prog;
-    char *passargin = NULL, *passin = NULL;
-    const char *spkac = &quot;SPKAC&quot;, *spksect = &quot;default&quot;;
-    char *spkstr = NULL;
-    char *challenge = NULL, *keyfile = NULL;
     CONF *conf = NULL;
-    NETSCAPE_SPKI *spki = NULL;
+    ENGINE *e = NULL;
     EVP_PKEY *pkey = NULL;
-#ifndef OPENSSL_NO_ENGINE
-    char *engine = NULL;
-#endif
-
-    apps_startup();
-
-    if (!bio_err)
-        bio_err = BIO_new_fp(stderr, BIO_NOCLOSE);
-
-    if (!load_config(bio_err, NULL))
-        goto end;
-
-    prog = argv[0];
-    argc--;
-    argv++;
-    while (argc &gt;= 1) {
-        if (strcmp(*argv, &quot;-in&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            infile = *(++argv);
-        } else if (strcmp(*argv, &quot;-out&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            outfile = *(++argv);
-        } else if (strcmp(*argv, &quot;-passin&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            passargin = *(++argv);
-        } else if (strcmp(*argv, &quot;-key&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            keyfile = *(++argv);
-        } else if (strcmp(*argv, &quot;-challenge&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            challenge = *(++argv);
-        } else if (strcmp(*argv, &quot;-spkac&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            spkac = *(++argv);
-        } else if (strcmp(*argv, &quot;-spksect&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            spksect = *(++argv);
-        }
-#ifndef OPENSSL_NO_ENGINE
-        else if (strcmp(*argv, &quot;-engine&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            engine = *(++argv);
-        }
-#endif
-        else if (strcmp(*argv, &quot;-noout&quot;) == 0)
+    NETSCAPE_SPKI *spki = NULL;
+    char *challenge = NULL, *keyfile = NULL, *engine = NULL;
+    char *infile = NULL, *outfile = NULL, *passinarg = NULL, *passin = NULL;
+    char *spkstr = NULL, *prog;
+    const char *spkac = &quot;SPKAC&quot;, *spksect = &quot;default&quot;;
+    int i, ret = 1, verify = 0, noout = 0, pubkey = 0;
+    OPTION_CHOICE o;
+
+    prog = opt_init(argc, argv, spkac_options);
+    while ((o = opt_next()) != OPT_EOF) {
+        switch (o) {
+        case OPT_EOF:
+        case OPT_ERR:
+            BIO_printf(bio_err, &quot;%s: Use -help for summary.\n&quot;, prog);
+            goto end;
+        case OPT_HELP:
+            opt_help(spkac_options);
+            ret = 0;
+            goto end;
+        case OPT_IN:
+            infile = opt_arg();
+            break;
+        case OPT_OUT:
+            outfile = opt_arg();
+            break;
+        case OPT_NOOUT:
             noout = 1;
-        else if (strcmp(*argv, &quot;-pubkey&quot;) == 0)
+            break;
+        case OPT_PUBKEY:
             pubkey = 1;
-        else if (strcmp(*argv, &quot;-verify&quot;) == 0)
+            break;
+        case OPT_VERIFY:
             verify = 1;
-        else
-            badops = 1;
-        argc--;
-        argv++;
-    }
+            break;
+        case OPT_PASSIN:
+            passinarg = opt_arg();
+            break;
+        case OPT_KEY:
+            keyfile = opt_arg();
+            break;
+        case OPT_CHALLENGE:
+            challenge = opt_arg();
+            break;
+        case OPT_SPKAC:
+            spkac = opt_arg();
+            break;
+        case OPT_SPKSECT:
+            spksect = opt_arg();
+            break;
+        case OPT_ENGINE:
+            engine = opt_arg();
+            break;
 
-    if (badops) {
- bad:
-        BIO_printf(bio_err, &quot;%s [options]\n&quot;, prog);
-        BIO_printf(bio_err, &quot;where options are\n&quot;);
-        BIO_printf(bio_err, &quot; -in arg        input file\n&quot;);
-        BIO_printf(bio_err, &quot; -out arg       output file\n&quot;);
-        BIO_printf(bio_err,
-                   &quot; -key arg       create SPKAC using private key\n&quot;);
-        BIO_printf(bio_err,
-                   &quot; -passin arg    input file pass phrase source\n&quot;);
-        BIO_printf(bio_err, &quot; -challenge arg challenge string\n&quot;);
-        BIO_printf(bio_err, &quot; -spkac arg     alternative SPKAC name\n&quot;);
-        BIO_printf(bio_err, &quot; -noout         don't print SPKAC\n&quot;);
-        BIO_printf(bio_err, &quot; -pubkey        output public key\n&quot;);
-        BIO_printf(bio_err, &quot; -verify        verify SPKAC signature\n&quot;);
-#ifndef OPENSSL_NO_ENGINE
-        BIO_printf(bio_err,
-                   &quot; -engine e      use engine e, possibly a hardware device.\n&quot;);
-#endif
-        goto end;
+        }
     }
+    argc = opt_num_rest();
+    argv = opt_rest();
 
-    ERR_load_crypto_strings();
-    if (!app_passwd(bio_err, passargin, NULL, &amp;passin, NULL)) {
+    if (!app_passwd(passinarg, NULL, &amp;passin, NULL)) {
         BIO_printf(bio_err, &quot;Error getting password\n&quot;);
         goto end;
     }
 #ifndef OPENSSL_NO_ENGINE
-    e = setup_engine(bio_err, engine, 0);
+    e = setup_engine(engine, 0);
 #endif
 
     if (keyfile) {
-        pkey = load_key(bio_err,
-                        strcmp(keyfile, &quot;-&quot;) ? keyfile : NULL,
+        pkey = load_key(strcmp(keyfile, &quot;-&quot;) ? keyfile : NULL,
                         FORMAT_PEM, 1, passin, e, &quot;private key&quot;);
         if (!pkey) {
             goto end;
@@ -204,39 +179,18 @@ int MAIN(int argc, char **argv)
         NETSCAPE_SPKI_sign(spki, pkey, EVP_md5());
         spkstr = NETSCAPE_SPKI_b64_encode(spki);
 
-        if (outfile)
-            out = BIO_new_file(outfile, &quot;w&quot;);
-        else {
-            out = BIO_new_fp(stdout, BIO_NOCLOSE);
-#ifdef OPENSSL_SYS_VMS
-            {
-                BIO *tmpbio = BIO_new(BIO_f_linebuffer());
-                out = BIO_push(tmpbio, out);
-            }
-#endif
-        }
-
-        if (!out) {
-            BIO_printf(bio_err, &quot;Error opening output file\n&quot;);
-            ERR_print_errors(bio_err);
+        out = bio_open_default(outfile, &quot;w&quot;);
+        if (out == NULL)
             goto end;
-        }
         BIO_printf(out, &quot;SPKAC=%s\n&quot;, spkstr);
         OPENSSL_free(spkstr);
         ret = 0;
         goto end;
     }
 
-    if (infile)
-        in = BIO_new_file(infile, &quot;r&quot;);
-    else
-        in = BIO_new_fp(stdin, BIO_NOCLOSE);
-
-    if (!in) {
-        BIO_printf(bio_err, &quot;Error opening input file\n&quot;);
-        ERR_print_errors(bio_err);
+    in = bio_open_default(infile, &quot;r&quot;);
+    if (in == NULL)
         goto end;
-    }
 
     conf = NCONF_new(NULL);
     i = NCONF_load_bio(conf, in, NULL);
@@ -263,23 +217,9 @@ int MAIN(int argc, char **argv)
         goto end;
     }
 
-    if (outfile)
-        out = BIO_new_file(outfile, &quot;w&quot;);
-    else {
-        out = BIO_new_fp(stdout, BIO_NOCLOSE);
-#ifdef OPENSSL_SYS_VMS
-        {
-            BIO *tmpbio = BIO_new(BIO_f_linebuffer());
-            out = BIO_push(tmpbio, out);
-        }
-#endif
-    }
-
-    if (!out) {
-        BIO_printf(bio_err, &quot;Error opening output file\n&quot;);
-        ERR_print_errors(bio_err);
+    out = bio_open_default(outfile, &quot;w&quot;);
+    if (out == NULL)
         goto end;
-    }
 
     if (!noout)
         NETSCAPE_SPKI_print(out, spki);
@@ -307,6 +247,5 @@ int MAIN(int argc, char **argv)
     EVP_PKEY_free(pkey);
     if (passin)
         OPENSSL_free(passin);
-    apps_shutdown();
-    OPENSSL_EXIT(ret);
+    return (ret);
 }
diff --git a/apps/srp.c b/apps/srp.c
index 5acc783..bacd670 100644
--- a/apps/srp.c
+++ b/apps/srp.c
@@ -1,4 +1,3 @@
-/* apps/srp.c */
 /*
  * Written by Peter Sylvester (<A HREF="../../../mailman/listinfo/openssl-commits.html">peter.sylvester at edelweb.fr</A>) for the EdelKey
  * project and contributed to the OpenSSL project 2004.
@@ -71,9 +70,6 @@
 
 # include &quot;apps.h&quot;
 
-# undef PROG
-# define PROG srp_main
-
 # define BASE_SECTION    &quot;srp&quot;
 # define CONFIG_FILE &quot;openssl.cnf&quot;
 
@@ -82,41 +78,12 @@
 # define ENV_DATABASE            &quot;srpvfile&quot;
 # define ENV_DEFAULT_SRP         &quot;default_srp&quot;
 
-static char *srp_usage[] = {
-    &quot;usage: srp [args] [user] \n&quot;,
-    &quot;\n&quot;,
-    &quot; -verbose        Talk a lot while doing things\n&quot;,
-    &quot; -config file    A config file\n&quot;,
-    &quot; -name arg       The particular srp definition to use\n&quot;,
-    &quot; -srpvfile arg   The srp verifier file name\n&quot;,
-    &quot; -add            add an user and srp verifier\n&quot;,
-    &quot; -modify         modify the srp verifier of an existing user\n&quot;,
-    &quot; -delete         delete user from verifier file\n&quot;,
-    &quot; -list           list user\n&quot;,
-    &quot; -gn arg         g and N values to be used for new verifier\n&quot;,
-    &quot; -userinfo arg   additional info to be set for user\n&quot;,
-    &quot; -passin arg     input file pass phrase source\n&quot;,
-    &quot; -passout arg    output file pass phrase source\n&quot;,
-# ifndef OPENSSL_NO_ENGINE
-    &quot; -engine e         - use engine e, possibly a hardware device.\n&quot;,
-# endif
-    NULL
-};
-
 # ifdef EFENCE
 extern int EF_PROTECT_FREE;
 extern int EF_PROTECT_BELOW;
 extern int EF_ALIGNMENT;
 # endif
 
-static CONF *conf = NULL;
-static char *section = NULL;
-
-# define VERBOSE if (verbose)
-# define VVERBOSE if (verbose&gt;1)
-
-int MAIN(int, char **);
-
 static int get_index(CA_DB *db, char *id, char type)
 {
     char **pp;
@@ -216,18 +183,17 @@ static char *srp_verify_user(const char *user, const char *srp_verifier,
     cb_tmp.password = passin;
 
     if (password_callback(password, 1024, 0, &amp;cb_tmp) &gt; 0) {
-        VERBOSE BIO_printf(bio,
-                           &quot;Validating\n&quot;
-                           &quot; user=\&quot;%s\&quot;\n&quot;
-                           &quot; srp_verifier=\&quot;%s\&quot;\n&quot;
-                           &quot; srp_usersalt=\&quot;%s\&quot;\n&quot;
-                           &quot; g=\&quot;%s\&quot;\n N=\&quot;%s\&quot;\n&quot;,
-                           user, srp_verifier, srp_usersalt, g, N);
+        if (verbose)
+            BIO_printf(bio,
+                       &quot;Validating\n   user=\&quot;%s\&quot;\n srp_verifier=\&quot;%s\&quot;\n srp_usersalt=\&quot;%s\&quot;\n g=\&quot;%s\&quot;\n N=\&quot;%s\&quot;\n&quot;,
+                       user, srp_verifier, srp_usersalt, g, N);
         BIO_printf(bio, &quot;Pass %s\n&quot;, password);
 
         OPENSSL_assert(srp_usersalt != NULL);
-        if (!(gNid = SRP_create_verifier(user, password, &amp;srp_usersalt,
-                                         &amp;verifier, N, g))) {
+        if (!
+            (gNid =
+             SRP_create_verifier(user, password, &amp;srp_usersalt, &amp;verifier, N,
+                                 g))) {
             BIO_printf(bio, &quot;Internal error validating SRP verifier\n&quot;);
         } else {
             if (strcmp(verifier, srp_verifier))
@@ -250,56 +216,66 @@ static char *srp_create_user(char *user, char **srp_verifier,
     cb_tmp.password = passout;
 
     if (password_callback(password, 1024, 1, &amp;cb_tmp) &gt; 0) {
-        VERBOSE BIO_printf(bio,
-                           &quot;Creating\n&quot;
-                           &quot; user=\&quot;%s\&quot;\n&quot;
-                           &quot; g=\&quot;%s\&quot;\n&quot; &quot; N=\&quot;%s\&quot;\n&quot;, user, g, N);
-        if (!(gNid = SRP_create_verifier(user, password, &amp;salt,
-                                         srp_verifier, N, g))) {
+        if (verbose)
+            BIO_printf(bio, &quot;Creating\n user=\&quot;%s\&quot;\n g=\&quot;%s\&quot;\n N=\&quot;%s\&quot;\n&quot;,
+                       user, g, N);
+        if (!
+            (gNid =
+             SRP_create_verifier(user, password, &amp;salt, srp_verifier, N,
+                                 g))) {
             BIO_printf(bio, &quot;Internal error creating SRP verifier\n&quot;);
         } else
             *srp_usersalt = salt;
-        VVERBOSE BIO_printf(bio, &quot;gNid=%s salt =\&quot;%s\&quot;\n verifier =\&quot;%s\&quot;\n&quot;,
-                            gNid, salt, *srp_verifier);
+        if (verbose &gt; 1)
+            BIO_printf(bio, &quot;gNid=%s salt =\&quot;%s\&quot;\n verifier =\&quot;%s\&quot;\n&quot;, gNid,
+                       salt, *srp_verifier);
 
     }
     return gNid;
 }
 
-int MAIN(int argc, char **argv)
-{
-    int add_user = 0;
-    int list_user = 0;
-    int delete_user = 0;
-    int modify_user = 0;
-    char *user = NULL;
-
-    char *passargin = NULL, *passargout = NULL;
-    char *passin = NULL, *passout = NULL;
-    char *gN = NULL;
-    int gNindex = -1;
-    char **gNrow = NULL;
-    int maxgN = -1;
-
-    char *userinfo = NULL;
-
-    int badops = 0;
-    int ret = 1;
-    int errors = 0;
-    int verbose = 0;
-    int doupdatedb = 0;
-    char *configfile = NULL;
-    char *dbfile = NULL;
-    CA_DB *db = NULL;
-    char **pp;
-    int i;
-    long errorline = -1;
-    char *randfile = NULL;
+typedef enum OPTION_choice {
+    OPT_ERR = -1, OPT_EOF = 0, OPT_HELP,
+    OPT_VERBOSE, OPT_CONFIG, OPT_NAME, OPT_SRPVFILE, OPT_ADD,
+    OPT_DELETE, OPT_MODIFY, OPT_LIST, OPT_GN, OPT_USERINFO,
+    OPT_PASSIN, OPT_PASSOUT, OPT_ENGINE
+} OPTION_CHOICE;
+
+OPTIONS srp_options[] = {
+    {&quot;help&quot;, OPT_HELP, '-', &quot;Display this summary&quot;},
+    {&quot;verbose&quot;, OPT_VERBOSE, '-', &quot;Talk a lot while doing things&quot;},
+    {&quot;config&quot;, OPT_CONFIG, '&lt;', &quot;A config file&quot;},
+    {&quot;name&quot;, OPT_NAME, 's', &quot;The particular srp definition to use&quot;},
+    {&quot;srpvfile&quot;, OPT_SRPVFILE, '&lt;', &quot;The srp verifier file name&quot;},
+    {&quot;add&quot;, OPT_ADD, '-', &quot;Add a user and srp verifier&quot;},
+    {&quot;modify&quot;, OPT_MODIFY, '-',
+     &quot;Modify the srp verifier of an existing user&quot;},
+    {&quot;delete&quot;, OPT_DELETE, '-', &quot;Delete user from verifier file&quot;},
+    {&quot;list&quot;, OPT_LIST, '-', &quot;List users&quot;},
+    {&quot;gn&quot;, OPT_GN, 's', &quot;Set g and N values to be used for new verifier&quot;},
+    {&quot;userinfo&quot;, OPT_USERINFO, 's', &quot;Additional info to be set for user&quot;},
+    {&quot;passin&quot;, OPT_PASSIN, 's', &quot;Input file pass phrase source&quot;},
+    {&quot;passout&quot;, OPT_PASSOUT, 's', &quot;Output file pass phrase source&quot;},
 # ifndef OPENSSL_NO_ENGINE
-    char *engine = NULL;
+    {&quot;engine&quot;, OPT_ENGINE, 's', &quot;Use engine, possibly a hardware device&quot;},
 # endif
-    char *tofree = NULL;
+    {NULL}
+};
+
+int srp_main(int argc, char **argv)
+{
+    CA_DB *db = NULL;
     DB_ATTR db_attr;
+    CONF *conf = NULL;
+    int gNindex = -1, maxgN = -1, ret = 1, errors = 0, verbose =
+        0, i, doupdatedb = 0;
+    int mode = OPT_ERR;
+    char *user = NULL, *passinarg = NULL, *passoutarg = NULL;
+    char *passin = NULL, *passout = NULL, *gN = NULL, *userinfo = NULL;
+    char *randfile = NULL, *engine = NULL, *tofree = NULL, *section = NULL;
+    char **gNrow = NULL, *configfile = NULL, *dbfile = NULL, **pp, *prog;
+    long errorline = -1;
+    OPTION_CHOICE o;
 
 # ifdef EFENCE
     EF_PROTECT_FREE = 1;
@@ -307,119 +283,89 @@ int MAIN(int argc, char **argv)
     EF_ALIGNMENT = 0;
 # endif
 
-    apps_startup();
-
-    conf = NULL;
-    section = NULL;
-
-    if (bio_err == NULL)
-        if ((bio_err = BIO_new(BIO_s_file())) != NULL)
-            BIO_set_fp(bio_err, stderr, BIO_NOCLOSE | BIO_FP_TEXT);
-
-    argc--;
-    argv++;
-    while (argc &gt;= 1 &amp;&amp; badops == 0) {
-        if (strcmp(*argv, &quot;-verbose&quot;) == 0)
+    prog = opt_init(argc, argv, srp_options);
+    while ((o = opt_next()) != OPT_EOF) {
+        switch (o) {
+        case OPT_EOF:
+        case OPT_ERR:
+ opthelp:
+            BIO_printf(bio_err, &quot;%s: Use -help for summary.\n&quot;, prog);
+            goto end;
+        case OPT_HELP:
+            opt_help(srp_options);
+            ret = 0;
+            goto end;
+        case OPT_VERBOSE:
             verbose++;
-        else if (strcmp(*argv, &quot;-config&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            configfile = *(++argv);
-        } else if (strcmp(*argv, &quot;-name&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            section = *(++argv);
-        } else if (strcmp(*argv, &quot;-srpvfile&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            dbfile = *(++argv);
-        } else if (strcmp(*argv, &quot;-add&quot;) == 0)
-            add_user = 1;
-        else if (strcmp(*argv, &quot;-delete&quot;) == 0)
-            delete_user = 1;
-        else if (strcmp(*argv, &quot;-modify&quot;) == 0)
-            modify_user = 1;
-        else if (strcmp(*argv, &quot;-list&quot;) == 0)
-            list_user = 1;
-        else if (strcmp(*argv, &quot;-gn&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            gN = *(++argv);
-        } else if (strcmp(*argv, &quot;-userinfo&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            userinfo = *(++argv);
-        } else if (strcmp(*argv, &quot;-passin&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            passargin = *(++argv);
-        } else if (strcmp(*argv, &quot;-passout&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            passargout = *(++argv);
-        }
-# ifndef OPENSSL_NO_ENGINE
-        else if (strcmp(*argv, &quot;-engine&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            engine = *(++argv);
-        }
-# endif
-
-        else if (**argv == '-') {
- bad:
-            BIO_printf(bio_err, &quot;unknown option %s\n&quot;, *argv);
-            badops = 1;
             break;
-        } else
+        case OPT_CONFIG:
+            configfile = opt_arg();
             break;
-
-        argc--;
-        argv++;
+        case OPT_NAME:
+            section = opt_arg();
+            break;
+        case OPT_SRPVFILE:
+            dbfile = opt_arg();
+            break;
+        case OPT_ADD:
+        case OPT_DELETE:
+        case OPT_MODIFY:
+        case OPT_LIST:
+            if (mode != OPT_ERR) {
+                BIO_printf(bio_err,
+                           &quot;%s: Only one of -add/delete-modify/-list\n&quot;,
+                           prog);
+                goto opthelp;
+            }
+            mode = o;
+            break;
+        case OPT_GN:
+            gN = opt_arg();
+            break;
+        case OPT_USERINFO:
+            userinfo = opt_arg();
+            break;
+        case OPT_PASSIN:
+            passinarg = opt_arg();
+            break;
+        case OPT_PASSOUT:
+            passoutarg = opt_arg();
+            break;
+        case OPT_ENGINE:
+            engine = opt_arg();
+            break;
+        }
     }
+    argc = opt_num_rest();
+    argv = opt_rest();
 
     if (dbfile &amp;&amp; configfile) {
         BIO_printf(bio_err,
                    &quot;-dbfile and -configfile cannot be specified together.\n&quot;);
-        badops = 1;
+        goto end;
     }
-    if (add_user + delete_user + modify_user + list_user != 1) {
-        BIO_printf(bio_err, &quot;Exactly one of the options &quot;
-                   &quot;-add, -delete, -modify -list must be specified.\n&quot;);
-        badops = 1;
+    if (mode == OPT_ERR) {
+        BIO_printf(bio_err,
+                   &quot;Exactly one of the options -add, -delete, -modify -list must be specified.\n&quot;);
+        goto opthelp;
     }
-    if (delete_user + modify_user + delete_user == 1 &amp;&amp; argc &lt;= 0) {
-        BIO_printf(bio_err, &quot;Need at least one user for options &quot;
-                   &quot;-add, -delete, -modify. \n&quot;);
-        badops = 1;
+    if ((mode == OPT_DELETE || mode == OPT_MODIFY || OPT_ADD) &amp;&amp; argc &lt; 1) {
+        BIO_printf(bio_err,
+                   &quot;Need at least one user for options -add, -delete, -modify. \n&quot;);
+        goto opthelp;
     }
     if ((passin || passout) &amp;&amp; argc != 1) {
         BIO_printf(bio_err,
                    &quot;-passin, -passout arguments only valid with one user.\n&quot;);
-        badops = 1;
+        goto opthelp;
     }
-
-    if (badops) {
-        for (pp = srp_usage; (*pp != NULL); pp++)
-            BIO_printf(bio_err, &quot;%s&quot;, *pp);
-
-        BIO_printf(bio_err, &quot; -rand file%cfile%c...\n&quot;, LIST_SEPARATOR_CHAR,
-                   LIST_SEPARATOR_CHAR);
-        BIO_printf(bio_err,
-                   &quot;                 load the file (or the files in the directory) into\n&quot;);
-        BIO_printf(bio_err, &quot;                 the random number generator\n&quot;);
-        goto err;
-    }
-
-    ERR_load_crypto_strings();
-
 # ifndef OPENSSL_NO_ENGINE
-    setup_engine(bio_err, engine, 0);
+    setup_engine(engine, 0);
 # endif
 
-    if (!app_passwd(bio_err, passargin, passargout, &amp;passin, &amp;passout)) {
+    if (!app_passwd(passinarg, passoutarg, &amp;passin, &amp;passout)) {
         BIO_printf(bio_err, &quot;Error getting passwords\n&quot;);
-        goto err;
+        goto end;
     }
 
     if (!dbfile) {
@@ -439,7 +385,7 @@ int MAIN(int argc, char **argv)
             tofree = OPENSSL_malloc(len);
             if (!tofree) {
                 BIO_printf(bio_err, &quot;Out of memory\n&quot;);
-                goto err;
+                goto end;
             }
             strcpy(tofree, s);
 # else
@@ -447,7 +393,7 @@ int MAIN(int argc, char **argv)
             tofree = OPENSSL_malloc(len);
             if (!tofree) {
                 BIO_printf(bio_err, &quot;Out of memory\n&quot;);
-                goto err;
+                goto end;
             }
             BUF_strlcpy(tofree, s, len);
             BUF_strlcat(tofree, &quot;/&quot;, len);
@@ -456,8 +402,8 @@ int MAIN(int argc, char **argv)
             configfile = tofree;
         }
 
-        VERBOSE BIO_printf(bio_err, &quot;Using configuration from %s\n&quot;,
-                           configfile);
+        if (verbose)
+            BIO_printf(bio_err, &quot;Using configuration from %s\n&quot;, configfile);
         conf = NCONF_new(NULL);
         if (NCONF_load(conf, configfile, &amp;errorline) &lt;= 0) {
             if (errorline &lt;= 0)
@@ -466,53 +412,53 @@ int MAIN(int argc, char **argv)
             else
                 BIO_printf(bio_err, &quot;error on line %ld of config file '%s'\n&quot;,
                            errorline, configfile);
-            goto err;
+            goto end;
         }
         if (tofree) {
             OPENSSL_free(tofree);
             tofree = NULL;
         }
 
-        if (!load_config(bio_err, conf))
-            goto err;
-
         /* Lets get the config section we are using */
         if (section == NULL) {
-            VERBOSE BIO_printf(bio_err,
-                               &quot;trying to read &quot; ENV_DEFAULT_SRP
-                               &quot; in \&quot; BASE_SECTION \&quot;\n&quot;);
+            if (verbose)
+                BIO_printf(bio_err,
+                           &quot;trying to read &quot; ENV_DEFAULT_SRP
+                           &quot; in \&quot; BASE_SECTION \&quot;\n&quot;);
 
             section = NCONF_get_string(conf, BASE_SECTION, ENV_DEFAULT_SRP);
             if (section == NULL) {
                 lookup_fail(BASE_SECTION, ENV_DEFAULT_SRP);
-                goto err;
+                goto end;
             }
         }
 
         if (randfile == NULL &amp;&amp; conf)
             randfile = NCONF_get_string(conf, BASE_SECTION, &quot;RANDFILE&quot;);
 
-        VERBOSE BIO_printf(bio_err,
-                           &quot;trying to read &quot; ENV_DATABASE
-                           &quot; in section \&quot;%s\&quot;\n&quot;, section);
+        if (verbose)
+            BIO_printf(bio_err,
+                       &quot;trying to read &quot; ENV_DATABASE &quot; in section \&quot;%s\&quot;\n&quot;,
+                       section);
 
         if ((dbfile = NCONF_get_string(conf, section, ENV_DATABASE)) == NULL) {
             lookup_fail(section, ENV_DATABASE);
-            goto err;
+            goto end;
         }
 
     }
     if (randfile == NULL)
         ERR_clear_error();
     else
-        app_RAND_load_file(randfile, bio_err, 0);
+        app_RAND_load_file(randfile, 0);
 
-    VERBOSE BIO_printf(bio_err, &quot;Trying to read SRP verifier file \&quot;%s\&quot;\n&quot;,
-                       dbfile);
+    if (verbose)
+        BIO_printf(bio_err, &quot;Trying to read SRP verifier file \&quot;%s\&quot;\n&quot;,
+                   dbfile);
 
     db = load_index(dbfile, &amp;db_attr);
     if (db == NULL)
-        goto err;
+        goto end;
 
     /* Lets check some fields */
     for (i = 0; i &lt; sk_OPENSSL_PSTRING_num(db-&gt;db-&gt;data); i++) {
@@ -527,46 +473,50 @@ int MAIN(int argc, char **argv)
         }
     }
 
-    VERBOSE BIO_printf(bio_err, &quot;Database initialised\n&quot;);
+    if (verbose)
+        BIO_printf(bio_err, &quot;Database initialised\n&quot;);
 
     if (gNindex &gt;= 0) {
         gNrow = sk_OPENSSL_PSTRING_value(db-&gt;db-&gt;data, gNindex);
         print_entry(db, bio_err, gNindex, verbose &gt; 1, &quot;Default g and N&quot;);
     } else if (maxgN &gt; 0 &amp;&amp; !SRP_get_default_gN(gN)) {
         BIO_printf(bio_err, &quot;No g and N value for index \&quot;%s\&quot;\n&quot;, gN);
-        goto err;
+        goto end;
     } else {
-        VERBOSE BIO_printf(bio_err, &quot;Database has no g N information.\n&quot;);
+        if (verbose)
+            BIO_printf(bio_err, &quot;Database has no g N information.\n&quot;);
         gNrow = NULL;
     }
 
-    VVERBOSE BIO_printf(bio_err, &quot;Starting user processing\n&quot;);
+    if (verbose &gt; 1)
+        BIO_printf(bio_err, &quot;Starting user processing\n&quot;);
 
     if (argc &gt; 0)
         user = *(argv++);
 
-    while (list_user || user) {
+    while (mode == OPT_LIST || user) {
         int userindex = -1;
         if (user)
-            VVERBOSE BIO_printf(bio_err, &quot;Processing user \&quot;%s\&quot;\n&quot;, user);
+            if (verbose &gt; 1)
+                BIO_printf(bio_err, &quot;Processing user \&quot;%s\&quot;\n&quot;, user);
         if ((userindex = get_index(db, user, 'U')) &gt;= 0) {
-            print_user(db, bio_err, userindex, (verbose &gt; 0) || list_user);
+            print_user(db, bio_err, userindex, (verbose &gt; 0)
+                       || mode == OPT_LIST);
         }
 
-        if (list_user) {
+        if (mode == OPT_LIST) {
             if (user == NULL) {
                 BIO_printf(bio_err, &quot;List all users\n&quot;);
 
                 for (i = 0; i &lt; sk_OPENSSL_PSTRING_num(db-&gt;db-&gt;data); i++) {
                     print_user(db, bio_err, i, 1);
                 }
-                list_user = 0;
             } else if (userindex &lt; 0) {
                 BIO_printf(bio_err,
                            &quot;user \&quot;%s\&quot; does not exist, ignored. t\n&quot;, user);
                 errors++;
             }
-        } else if (add_user) {
+        } else if (mode == OPT_ADD) {
             if (userindex &gt;= 0) {
                 /* reactivation of a new user */
                 char **row =
@@ -581,26 +531,31 @@ int MAIN(int argc, char **argv)
                 row[DB_srpverifier] = NULL;
                 row[DB_srpsalt] = NULL;
                 row[DB_srpinfo] = NULL;
-                if (!(gNid = srp_create_user(user, &amp;(row[DB_srpverifier]),
-                                             &amp;(row[DB_srpsalt]),
-                                             gNrow ? gNrow[DB_srpsalt] : gN,
-                                             gNrow ? gNrow[DB_srpverifier] :
-                                             NULL, passout, bio_err,
-                                             verbose))) {
+                if (!
+                    (gNid =
+                     srp_create_user(user, &amp;(row[DB_srpverifier]),
+                                     &amp;(row[DB_srpsalt]),
+                                     gNrow ? gNrow[DB_srpsalt] : gN,
+                                     gNrow ? gNrow[DB_srpverifier] : NULL,
+                                     passout, bio_err, verbose))) {
                     BIO_printf(bio_err,
-                               &quot;Cannot create srp verifier for user \&quot;%s\&quot;,&quot;
-                               &quot; operation abandoned .\n&quot;, user);
+                               &quot;Cannot create srp verifier for user \&quot;%s\&quot;, operation abandoned .\n&quot;,
+                               user);
                     errors++;
-                    goto err;
+                    goto end;
                 }
                 row[DB_srpid] = BUF_strdup(user);
                 row[DB_srptype] = BUF_strdup(&quot;v&quot;);
                 row[DB_srpgN] = BUF_strdup(gNid);
 
                 if (!row[DB_srpid] || !row[DB_srpgN] || !row[DB_srptype]
-                    || !row[DB_srpverifier] || !row[DB_srpsalt]
-                    || (userinfo
-                        &amp;&amp; (!(row[DB_srpinfo] = BUF_strdup(userinfo))))
+                    || !row[DB_srpverifier] || !row[DB_srpsalt] || (userinfo
+                                                                    &amp;&amp;
+                                                                    (!(row
+                                                                       [DB_srpinfo]
+                                                                       =
+                                                                       BUF_strdup
+                                                                       (userinfo))))
                     || !update_index(db, bio_err, row)) {
                     if (row[DB_srpid])
                         OPENSSL_free(row[DB_srpid]);
@@ -614,11 +569,11 @@ int MAIN(int argc, char **argv)
                         OPENSSL_free(row[DB_srpverifier]);
                     if (row[DB_srpsalt])
                         OPENSSL_free(row[DB_srpsalt]);
-                    goto err;
+                    goto end;
                 }
                 doupdatedb = 1;
             }
-        } else if (modify_user) {
+        } else if (mode == OPT_MODIFY) {
             if (userindex &lt; 0) {
                 BIO_printf(bio_err,
                            &quot;user \&quot;%s\&quot; does not exist, operation ignored.\n&quot;,
@@ -640,9 +595,10 @@ int MAIN(int argc, char **argv)
                     if (row[DB_srptype][0] == 'V') {
                         int user_gN;
                         char **irow = NULL;
-                        VERBOSE BIO_printf(bio_err,
-                                           &quot;Verifying password for user \&quot;%s\&quot;\n&quot;,
-                                           user);
+                        if (verbose)
+                            BIO_printf(bio_err,
+                                       &quot;Verifying password for user \&quot;%s\&quot;\n&quot;,
+                                       user);
                         if ((user_gN =
                              get_index(db, row[DB_srpgN], DB_SRP_INDEX)) &gt;= 0)
                             irow =
@@ -658,25 +614,25 @@ int MAIN(int argc, char **argv)
                                        &quot;Invalid password for user \&quot;%s\&quot;, operation abandoned.\n&quot;,
                                        user);
                             errors++;
-                            goto err;
+                            goto end;
                         }
                     }
-                    VERBOSE BIO_printf(bio_err,
-                                       &quot;Password for user \&quot;%s\&quot; ok.\n&quot;,
-                                       user);
-
-                    if (!(gNid = srp_create_user(user, &amp;(row[DB_srpverifier]),
-                                                 &amp;(row[DB_srpsalt]),
-                                                 gNrow ? gNrow[DB_srpsalt] :
-                                                 NULL,
-                                                 gNrow ? gNrow[DB_srpverifier]
-                                                 : NULL, passout, bio_err,
-                                                 verbose))) {
+                    if (verbose)
+                        BIO_printf(bio_err, &quot;Password for user \&quot;%s\&quot; ok.\n&quot;,
+                                   user);
+
+                    if (!
+                        (gNid =
+                         srp_create_user(user, &amp;(row[DB_srpverifier]),
+                                         &amp;(row[DB_srpsalt]),
+                                         gNrow ? gNrow[DB_srpsalt] : NULL,
+                                         gNrow ? gNrow[DB_srpverifier] : NULL,
+                                         passout, bio_err, verbose))) {
                         BIO_printf(bio_err,
-                                   &quot;Cannot create srp verifier for user \&quot;%s\&quot;,&quot;
-                                   &quot; operation abandoned.\n&quot;, user);
+                                   &quot;Cannot create srp verifier for user \&quot;%s\&quot;, operation abandoned.\n&quot;,
+                                   user);
                         errors++;
-                        goto err;
+                        goto end;
                     }
 
                     row[DB_srptype][0] = 'v';
@@ -686,12 +642,12 @@ int MAIN(int argc, char **argv)
                         || !row[DB_srpverifier] || !row[DB_srpsalt]
                         || (userinfo
                             &amp;&amp; (!(row[DB_srpinfo] = BUF_strdup(userinfo)))))
-                        goto err;
+                        goto end;
 
                     doupdatedb = 1;
                 }
             }
-        } else if (delete_user) {
+        } else if (mode == OPT_DELETE) {
             if (userindex &lt; 0) {
                 BIO_printf(bio_err,
                            &quot;user \&quot;%s\&quot; does not exist, operation ignored. t\n&quot;,
@@ -711,11 +667,11 @@ int MAIN(int argc, char **argv)
             user = *(argv++);
         else {
             user = NULL;
-            list_user = 0;
         }
     }
 
-    VERBOSE BIO_printf(bio_err, &quot;User procession done.\n&quot;);
+    if (verbose)
+        BIO_printf(bio_err, &quot;User procession done.\n&quot;);
 
     if (doupdatedb) {
         /* Lets check some fields */
@@ -728,37 +684,41 @@ int MAIN(int argc, char **argv)
             }
         }
 
-        VERBOSE BIO_printf(bio_err, &quot;Trying to update srpvfile.\n&quot;);
+        if (verbose)
+            BIO_printf(bio_err, &quot;Trying to update srpvfile.\n&quot;);
         if (!save_index(dbfile, &quot;new&quot;, db))
-            goto err;
+            goto end;
 
-        VERBOSE BIO_printf(bio_err, &quot;Temporary srpvfile created.\n&quot;);
+        if (verbose)
+            BIO_printf(bio_err, &quot;Temporary srpvfile created.\n&quot;);
         if (!rotate_index(dbfile, &quot;new&quot;, &quot;old&quot;))
-            goto err;
+            goto end;
 
-        VERBOSE BIO_printf(bio_err, &quot;srpvfile updated.\n&quot;);
+        if (verbose)
+            BIO_printf(bio_err, &quot;srpvfile updated.\n&quot;);
     }
 
     ret = (errors != 0);
- err:
+ end:
     if (errors != 0)
-        VERBOSE BIO_printf(bio_err, &quot;User errors %d.\n&quot;, errors);
+        if (verbose)
+            BIO_printf(bio_err, &quot;User errors %d.\n&quot;, errors);
 
-    VERBOSE BIO_printf(bio_err, &quot;SRP terminating with code %d.\n&quot;, ret);
+    if (verbose)
+        BIO_printf(bio_err, &quot;SRP terminating with code %d.\n&quot;, ret);
     if (tofree)
         OPENSSL_free(tofree);
     if (ret)
         ERR_print_errors(bio_err);
     if (randfile)
-        app_RAND_write_file(randfile, bio_err);
+        app_RAND_write_file(randfile);
     if (conf)
         NCONF_free(conf);
     if (db)
         free_index(db);
 
     OBJ_cleanup();
-    apps_shutdown();
-    OPENSSL_EXIT(ret);
+    return (ret);
 }
 
 #endif
diff --git a/apps/testdsa.h b/apps/testdsa.h
index 550c625..4eb13d1 100644
--- a/apps/testdsa.h
+++ b/apps/testdsa.h
@@ -1,8 +1,57 @@
-/* NOCW */
-/* used by apps/speed.c */
+/* ====================================================================
+ * Copyright (c) 199-2015 The OpenSSL Project.  All rights reserved.
+ *
+ * Redistribution and use in source and binary forms, with or without
+ * modification, are permitted provided that the following conditions
+ * are met:
+ *
+ * 1. Redistributions of source code must retain the above copyright
+ *    notice, this list of conditions and the following disclaimer.
+ *
+ * 2. Redistributions in binary form must reproduce the above copyright
+ *    notice, this list of conditions and the following disclaimer in
+ *    the documentation and/or other materials provided with the
+ *    distribution.
+ *
+ * 3. All advertising materials mentioning features or use of this
+ *    software must display the following acknowledgment:
+ *    &quot;This product includes software developed by the OpenSSL Project
+ *    for use in the OpenSSL Toolkit. (<A HREF="http://www.OpenSSL.org/">http://www.OpenSSL.org/</A>)&quot;
+ *
+ * 4. The names &quot;OpenSSL Toolkit&quot; and &quot;OpenSSL Project&quot; must not be used to
+ *    endorse or promote products derived from this software without
+ *    prior written permission. For written permission, please contact
+ *    <A HREF="../../../mailman/listinfo/openssl-commits.html">licensing at OpenSSL.org.</A>
+ *
+ * 5. Products derived from this software may not be called &quot;OpenSSL&quot;
+ *    nor may &quot;OpenSSL&quot; appear in their names without prior written
+ *    permission of the OpenSSL Project.
+ *
+ * 6. Redistributions of any form whatsoever must retain the following
+ *    acknowledgment:
+ *    &quot;This product includes software developed by the OpenSSL Project
+ *    for use in the OpenSSL Toolkit (<A HREF="http://www.OpenSSL.org/">http://www.OpenSSL.org/</A>)&quot;
+ *
+ * THIS SOFTWARE IS PROVIDED BY THE OpenSSL PROJECT ``AS IS'' AND ANY
+ * EXPRESSED OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
+ * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR
+ * PURPOSE ARE DISCLAIMED.  IN NO EVENT SHALL THE OpenSSL PROJECT OR
+ * ITS CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
+ * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT
+ * NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;
+ * LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)
+ * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT,
+ * STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)
+ * ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED
+ * OF THE POSSIBILITY OF SUCH DAMAGE.
+ * ====================================================================
+ */
+
+/* used by speed.c */
 DSA *get_dsa512(void);
 DSA *get_dsa1024(void);
 DSA *get_dsa2048(void);
+
 static unsigned char dsa512_priv[] = {
     0x65, 0xe5, 0xc7, 0x38, 0x60, 0x24, 0xb5, 0x89, 0xd4, 0x9c, 0xeb, 0x4c,
     0x9c, 0x1d, 0x7a, 0x22, 0xbd, 0xd1, 0xc2, 0xd2,
diff --git a/apps/ts.c b/apps/ts.c
index 4c32ada..e0f4313 100644
--- a/apps/ts.c
+++ b/apps/ts.c
@@ -1,4 +1,3 @@
-/* apps/ts.c */
 /*
  * Written by Zoltan Glozik (<A HREF="../../../mailman/listinfo/openssl-commits.html">zglozik at stones.com</A>) for the OpenSSL project
  * 2002.
@@ -68,9 +67,6 @@
 #include &lt;openssl/ts.h&gt;
 #include &lt;openssl/bn.h&gt;
 
-#undef PROG
-#define PROG    ts_main
-
 /* Length of the nonce of the request in bits (must be a multiple of 8). */
 #define NONCE_LENGTH            64
 
@@ -86,8 +82,6 @@ static CONF *load_config_file(const char *configfile);
 static int query_command(const char *data, char *digest,
                          const EVP_MD *md, const char *policy, int no_nonce,
                          int cert, const char *in, const char *out, int text);
-static BIO *BIO_open_with_default(const char *file, const char *mode,
-                                  FILE *default_fp);
 static TS_REQ *create_query(BIO *data_bio, char *digest, const EVP_MD *md,
                             const char *policy, int no_nonce, int cert);
 static int create_digest(BIO *input, char *digest,
@@ -102,8 +96,8 @@ static int reply_command(CONF *conf, char *section, char *engine,
                          int text);
 static TS_RESP *read_PKCS7(BIO *in_bio);
 static TS_RESP *create_response(CONF *conf, const char *section, char *engine,
-                                char *queryfile, char *passin, char *inkey,
-                                char *signer, char *chain,
+                                char *queryfile, char *passin,
+                                char *inkey, char *signer, char *chain,
                                 const char *policy);
 static ASN1_INTEGER *serial_cb(TS_RESP_CTX *ctx, void *data);
 static ASN1_INTEGER *next_serial(const char *serialfile);
@@ -112,163 +106,201 @@ static int save_ts_serial(const char *serialfile, ASN1_INTEGER *serial);
 /* Verify related functions. */
 static int verify_command(char *data, char *digest, char *queryfile,
                           char *in, int token_in,
-                          char *ca_path, char *ca_file, char *untrusted);
+                          char *CApath, char *CAfile, char *untrusted);
 static TS_VERIFY_CTX *create_verify_ctx(char *data, char *digest,
                                         char *queryfile,
-                                        char *ca_path, char *ca_file,
+                                        char *CApath, char *CAfile,
                                         char *untrusted);
-static X509_STORE *create_cert_store(char *ca_path, char *ca_file);
+static X509_STORE *create_cert_store(char *CApath, char *CAfile);
 static int verify_cb(int ok, X509_STORE_CTX *ctx);
 
-/* Main function definition. */
-int MAIN(int, char **);
+typedef enum OPTION_choice {
+    OPT_ERR = -1, OPT_EOF = 0, OPT_HELP,
+    OPT_ENGINE, OPT_CONFIG, OPT_SECTION, OPT_QUERY, OPT_DATA,
+    OPT_DIGEST, OPT_RAND, OPT_POLICY, OPT_NO_NONCE, OPT_CERT,
+    OPT_IN, OPT_TOKEN_IN, OPT_OUT, OPT_TOKEN_OUT, OPT_TEXT,
+    OPT_REPLY, OPT_QUERYFILE, OPT_PASSIN, OPT_INKEY, OPT_SIGNER,
+    OPT_CHAIN, OPT_VERIFY, OPT_CAPATH, OPT_CAFILE, OPT_UNTRUSTED,
+    OPT_MD
+} OPTION_CHOICE;
+
+OPTIONS ts_options[] = {
+    {&quot;help&quot;, OPT_HELP, '-', &quot;Display this summary&quot;},
+    {&quot;config&quot;, OPT_CONFIG, '&lt;', &quot;Configuration file&quot;},
+    {&quot;section&quot;, OPT_SECTION, 's', &quot;Section to use within config file&quot;},
+    {&quot;query&quot;, OPT_QUERY, '-', &quot;Generate a TS query&quot;},
+    {&quot;data&quot;, OPT_DATA, '&lt;', &quot;File to hash&quot;},
+    {&quot;digest&quot;, OPT_DIGEST, 's', &quot;Digest (as a hex string)&quot;},
+    {&quot;rand&quot;, OPT_RAND, 's',
+     &quot;Load the file(s) into the random number generator&quot;},
+    {&quot;policy&quot;, OPT_POLICY, 's', &quot;Policy OID to use&quot;},
+    {&quot;no_nonce&quot;, OPT_NO_NONCE, '-', &quot;Do not include a nonce&quot;},
+    {&quot;cert&quot;, OPT_CERT, '-', &quot;Put cert request into query&quot;},
+    {&quot;in&quot;, OPT_IN, '&lt;', &quot;Input file&quot;},
+    {&quot;token_in&quot;, OPT_TOKEN_IN, '-', &quot;Input is a PKCS#7 file&quot;},
+    {&quot;out&quot;, OPT_OUT, '&gt;', &quot;Output file&quot;},
+    {&quot;token_out&quot;, OPT_TOKEN_OUT, '-', &quot;Output is a PKCS#7 file&quot;},
+    {&quot;text&quot;, OPT_TEXT, '-', &quot;Output text (not DER)&quot;},
+    {&quot;reply&quot;, OPT_REPLY, '-', &quot;Generate a TS reply&quot;},
+    {&quot;queryfile&quot;, OPT_QUERYFILE, '&lt;', &quot;File containing a TS query&quot;},
+    {&quot;passin&quot;, OPT_PASSIN, 's'},
+    {&quot;inkey&quot;, OPT_INKEY, '&lt;', &quot;File with private key for reply&quot;},
+    {&quot;signer&quot;, OPT_SIGNER, 's'},
+    {&quot;chain&quot;, OPT_CHAIN, '&lt;', &quot;File with signer CA chain&quot;},
+    {&quot;verify&quot;, OPT_VERIFY, '-', &quot;Verify a TS response&quot;},
+    {&quot;CApath&quot;, OPT_CAPATH, '/', &quot;Path to trusted CA files&quot;},
+    {&quot;CAfile&quot;, OPT_CAFILE, '&lt;', &quot;File with trusted CA certs&quot;},
+    {&quot;untrusted&quot;, OPT_UNTRUSTED, '&lt;', &quot;File with untrusted certs&quot;},
+#ifndef OPENSSL_NO_ENGINE
+    {&quot;engine&quot;, OPT_ENGINE, 's', &quot;Use engine, possibly a hardware device&quot;},
+#endif
+    {&quot;&quot;, OPT_MD, '-', &quot;Any supported digest&quot;},
+    {NULL}
+};
 
-int MAIN(int argc, char **argv)
+/*
+ * This comand is so complex, special help is needed.
+ */
+static char* opt_helplist[] = {
+    &quot;Typical uses:&quot;,
+    &quot;ts -query [-rand file...] [-config file] [-data file]&quot;,
+    &quot;          [-digest hexstring] [-policy oid] [-no_nonce] [-cert]&quot;,
+    &quot;          [-in file] [-out file] [-text]&quot;,
+    &quot;  or&quot;,
+    &quot;ts -reply [-config file] [-section tsa_section]&quot;,
+    &quot;          [-queryfile file] [-passin password]&quot;,
+    &quot;          [-signer tsa_cert.pem] [-inkey private_key.pem]&quot;,
+    &quot;          [-chain certs_file.pem] [-policy oid]&quot;,
+    &quot;          [-in file] [-token_in] [-out file] [-token_out]&quot;,
+#ifndef OPENSSL_NO_ENGINE
+    &quot;          [-text]&quot;,
+#else
+    &quot;          [-text] [-engine id]&quot;,
+#endif
+    &quot;  or&quot;,
+    &quot;ts -verify -CApath dir -CAfile file.pem -untrusted file.pem&quot;,
+    &quot;           [-data file] [-digest hexstring]&quot;,
+    &quot;           [-queryfile file] -in file [-token_in]&quot;,
+    NULL,
+};
+
+int ts_main(int argc, char **argv)
 {
-    int ret = 1;
-    char *configfile = NULL;
-    char *section = NULL;
     CONF *conf = NULL;
-    enum mode {
-        CMD_NONE, CMD_QUERY, CMD_REPLY, CMD_VERIFY
-    } mode = CMD_NONE;
-    char *data = NULL;
-    char *digest = NULL;
+    char *CAfile = NULL, *untrusted = NULL, *engine = NULL, *prog, **helpp;
+    char *configfile = NULL, *section = NULL, *password = NULL;
+    char *data = NULL, *digest = NULL, *rnd = NULL, *policy = NULL;
+    char *in = NULL, *out = NULL, *queryfile = NULL, *passin = NULL;
+    char *inkey = NULL, *signer = NULL, *chain = NULL, *CApath = NULL;
     const EVP_MD *md = NULL;
-    char *rnd = NULL;
-    char *policy = NULL;
-    int no_nonce = 0;
-    int cert = 0;
-    char *in = NULL;
-    char *out = NULL;
-    int text = 0;
-    char *queryfile = NULL;
-    char *passin = NULL;        /* Password source. */
-    char *password = NULL;      /* Password itself. */
-    char *inkey = NULL;
-    char *signer = NULL;
-    char *chain = NULL;
-    char *ca_path = NULL;
-    char *ca_file = NULL;
-    char *untrusted = NULL;
-    char *engine = NULL;
+    OPTION_CHOICE o, mode = OPT_ERR;
+    int ret = 1, no_nonce = 0, cert = 0, text = 0;
     /* Input is ContentInfo instead of TimeStampResp. */
     int token_in = 0;
     /* Output is ContentInfo instead of TimeStampResp. */
     int token_out = 0;
-    int free_bio_err = 0;
 
-    ERR_load_crypto_strings();
-    apps_startup();
-
-    if (bio_err == NULL &amp;&amp; (bio_err = BIO_new(BIO_s_file())) != NULL) {
-        BIO_set_fp(bio_err, stderr, BIO_NOCLOSE | BIO_FP_TEXT);
-        free_bio_err = 1;
-    }
-
-    if (!load_config(bio_err, NULL))
-        goto cleanup;
-
-    for (argc--, argv++; argc &gt; 0; argc--, argv++) {
-        if (strcmp(*argv, &quot;-config&quot;) == 0) {
-            if (argc-- &lt; 1)
-                goto usage;
-            configfile = *++argv;
-        } else if (strcmp(*argv, &quot;-section&quot;) == 0) {
-            if (argc-- &lt; 1)
-                goto usage;
-            section = *++argv;
-        } else if (strcmp(*argv, &quot;-query&quot;) == 0) {
-            if (mode != CMD_NONE)
-                goto usage;
-            mode = CMD_QUERY;
-        } else if (strcmp(*argv, &quot;-data&quot;) == 0) {
-            if (argc-- &lt; 1)
-                goto usage;
-            data = *++argv;
-        } else if (strcmp(*argv, &quot;-digest&quot;) == 0) {
-            if (argc-- &lt; 1)
-                goto usage;
-            digest = *++argv;
-        } else if (strcmp(*argv, &quot;-rand&quot;) == 0) {
-            if (argc-- &lt; 1)
-                goto usage;
-            rnd = *++argv;
-        } else if (strcmp(*argv, &quot;-policy&quot;) == 0) {
-            if (argc-- &lt; 1)
-                goto usage;
-            policy = *++argv;
-        } else if (strcmp(*argv, &quot;-no_nonce&quot;) == 0) {
+    prog = opt_init(argc, argv, ts_options);
+    while ((o = opt_next()) != OPT_EOF) {
+        switch (o) {
+        case OPT_EOF:
+        case OPT_ERR:
+ opthelp:
+            BIO_printf(bio_err, &quot;%s: Use -help for summary.\n&quot;, prog);
+            goto end;
+        case OPT_HELP:
+            opt_help(ts_options);
+            for (helpp = opt_helplist; *helpp; ++helpp)
+                BIO_printf(bio_err, &quot;%s\n&quot;, *helpp);
+            ret = 0;
+            goto end;
+        case OPT_CONFIG:
+            configfile = opt_arg();
+            break;
+        case OPT_SECTION:
+            section = opt_arg();
+            break;
+        case OPT_QUERY:
+        case OPT_REPLY:
+        case OPT_VERIFY:
+            if (mode != OPT_ERR)
+                goto opthelp;
+            mode = o;
+            break;
+        case OPT_DATA:
+            data = opt_arg();
+            break;
+        case OPT_DIGEST:
+            digest = opt_arg();
+            break;
+        case OPT_RAND:
+            rnd = opt_arg();
+            break;
+        case OPT_POLICY:
+            policy = opt_arg();
+            break;
+        case OPT_NO_NONCE:
             no_nonce = 1;
-        } else if (strcmp(*argv, &quot;-cert&quot;) == 0) {
+            break;
+        case OPT_CERT:
             cert = 1;
-        } else if (strcmp(*argv, &quot;-in&quot;) == 0) {
-            if (argc-- &lt; 1)
-                goto usage;
-            in = *++argv;
-        } else if (strcmp(*argv, &quot;-token_in&quot;) == 0) {
+            break;
+        case OPT_IN:
+            in = opt_arg();
+            break;
+        case OPT_TOKEN_IN:
             token_in = 1;
-        } else if (strcmp(*argv, &quot;-out&quot;) == 0) {
-            if (argc-- &lt; 1)
-                goto usage;
-            out = *++argv;
-        } else if (strcmp(*argv, &quot;-token_out&quot;) == 0) {
+            break;
+        case OPT_OUT:
+            out = opt_arg();
+            break;
+        case OPT_TOKEN_OUT:
             token_out = 1;
-        } else if (strcmp(*argv, &quot;-text&quot;) == 0) {
+            break;
+        case OPT_TEXT:
             text = 1;
-        } else if (strcmp(*argv, &quot;-reply&quot;) == 0) {
-            if (mode != CMD_NONE)
-                goto usage;
-            mode = CMD_REPLY;
-        } else if (strcmp(*argv, &quot;-queryfile&quot;) == 0) {
-            if (argc-- &lt; 1)
-                goto usage;
-            queryfile = *++argv;
-        } else if (strcmp(*argv, &quot;-passin&quot;) == 0) {
-            if (argc-- &lt; 1)
-                goto usage;
-            passin = *++argv;
-        } else if (strcmp(*argv, &quot;-inkey&quot;) == 0) {
-            if (argc-- &lt; 1)
-                goto usage;
-            inkey = *++argv;
-        } else if (strcmp(*argv, &quot;-signer&quot;) == 0) {
-            if (argc-- &lt; 1)
-                goto usage;
-            signer = *++argv;
-        } else if (strcmp(*argv, &quot;-chain&quot;) == 0) {
-            if (argc-- &lt; 1)
-                goto usage;
-            chain = *++argv;
-        } else if (strcmp(*argv, &quot;-verify&quot;) == 0) {
-            if (mode != CMD_NONE)
-                goto usage;
-            mode = CMD_VERIFY;
-        } else if (strcmp(*argv, &quot;-CApath&quot;) == 0) {
-            if (argc-- &lt; 1)
-                goto usage;
-            ca_path = *++argv;
-        } else if (strcmp(*argv, &quot;-CAfile&quot;) == 0) {
-            if (argc-- &lt; 1)
-                goto usage;
-            ca_file = *++argv;
-        } else if (strcmp(*argv, &quot;-untrusted&quot;) == 0) {
-            if (argc-- &lt; 1)
-                goto usage;
-            untrusted = *++argv;
-        } else if (strcmp(*argv, &quot;-engine&quot;) == 0) {
-            if (argc-- &lt; 1)
-                goto usage;
-            engine = *++argv;
-        } else if ((md = EVP_get_digestbyname(*argv + 1)) != NULL) {
-            /* empty. */
-        } else
-            goto usage;
+            break;
+        case OPT_QUERYFILE:
+            queryfile = opt_arg();
+            break;
+        case OPT_PASSIN:
+            passin = opt_arg();
+            break;
+        case OPT_INKEY:
+            inkey = opt_arg();
+            break;
+        case OPT_SIGNER:
+            signer = opt_arg();
+            break;
+        case OPT_CHAIN:
+            chain = opt_arg();
+            break;
+        case OPT_CAPATH:
+            CApath = opt_arg();
+            break;
+        case OPT_CAFILE:
+            CAfile = opt_arg();
+            break;
+        case OPT_UNTRUSTED:
+            untrusted = opt_arg();
+            break;
+        case OPT_ENGINE:
+            engine = opt_arg();
+            break;
+        case OPT_MD:
+            if (!opt_md(opt_unknown(), &amp;md))
+                goto opthelp;
+            break;
+        }
     }
+    argc = opt_num_rest();
+    argv = opt_rest();
+    if (mode == OPT_ERR || argc != 0)
+        goto opthelp;
 
     /* Seed the random number generator if it is going to be used. */
-    if (mode == CMD_QUERY &amp;&amp; !no_nonce) {
-        if (!app_RAND_load_file(NULL, bio_err, 1) &amp;&amp; rnd == NULL)
+    if (mode == OPT_QUERY &amp;&amp; !no_nonce) {
+        if (!app_RAND_load_file(NULL, 1) &amp;&amp; rnd == NULL)
             BIO_printf(bio_err, &quot;warning, not much extra random &quot;
                        &quot;data, consider using the -rand option\n&quot;);
         if (rnd != NULL)
@@ -277,95 +309,68 @@ int MAIN(int argc, char **argv)
     }
 
     /* Get the password if required. */
-    if (mode == CMD_REPLY &amp;&amp; passin &amp;&amp;
-        !app_passwd(bio_err, passin, NULL, &amp;password, NULL)) {
+    if (mode == OPT_REPLY &amp;&amp; passin &amp;&amp;
+        !app_passwd(passin, NULL, &amp;password, NULL)) {
         BIO_printf(bio_err, &quot;Error getting password.\n&quot;);
-        goto cleanup;
+        goto end;
     }
 
     /*
      * Check consistency of parameters and execute the appropriate function.
      */
     switch (mode) {
-    case CMD_NONE:
-        goto usage;
-    case CMD_QUERY:
+    default:
+    case OPT_ERR:
+        goto opthelp;
+    case OPT_QUERY:
         /*
          * Data file and message imprint cannot be specified at the same
          * time.
          */
         ret = data != NULL &amp;&amp; digest != NULL;
         if (ret)
-            goto usage;
+            goto opthelp;
         /* Load the config file for possible policy OIDs. */
         conf = load_config_file(configfile);
         ret = !query_command(data, digest, md, policy, no_nonce, cert,
                              in, out, text);
         break;
-    case CMD_REPLY:
+    case OPT_REPLY:
         conf = load_config_file(configfile);
         if (in == NULL) {
             ret = !(queryfile != NULL &amp;&amp; conf != NULL &amp;&amp; !token_in);
             if (ret)
-                goto usage;
+                goto opthelp;
         } else {
             /* 'in' and 'queryfile' are exclusive. */
             ret = !(queryfile == NULL);
             if (ret)
-                goto usage;
+                goto opthelp;
         }
-
         ret = !reply_command(conf, section, engine, queryfile,
                              password, inkey, signer, chain, policy,
                              in, token_in, out, token_out, text);
         break;
-    case CMD_VERIFY:
+    case OPT_VERIFY:
         ret = !(((queryfile &amp;&amp; !data &amp;&amp; !digest)
                  || (!queryfile &amp;&amp; data &amp;&amp; !digest)
                  || (!queryfile &amp;&amp; !data &amp;&amp; digest))
                 &amp;&amp; in != NULL);
         if (ret)
-            goto usage;
+            goto opthelp;
 
         ret = !verify_command(data, digest, queryfile, in, token_in,
-                              ca_path, ca_file, untrusted);
+                              CApath, CAfile, untrusted);
     }
 
-    goto cleanup;
-
- usage:
-    BIO_printf(bio_err, &quot;usage:\n&quot;
-               &quot;ts -query [-rand file%cfile%c...] [-config configfile] &quot;
-               &quot;[-data file_to_hash] [-digest digest_bytes]&quot;
-               &quot;[-md2|-md4|-md5|-sha|-sha1|-mdc2|-ripemd160] &quot;
-               &quot;[-policy object_id] [-no_nonce] [-cert] &quot;
-               &quot;[-in request.tsq] [-out request.tsq] [-text]\n&quot;,
-               LIST_SEPARATOR_CHAR, LIST_SEPARATOR_CHAR);
-    BIO_printf(bio_err, &quot;or\n&quot;
-               &quot;ts -reply [-config configfile] [-section tsa_section] &quot;
-               &quot;[-queryfile request.tsq] [-passin password] &quot;
-               &quot;[-signer tsa_cert.pem] [-inkey private_key.pem] &quot;
-               &quot;[-chain certs_file.pem] [-policy object_id] &quot;
-               &quot;[-in response.tsr] [-token_in] &quot;
-               &quot;[-out response.tsr] [-token_out] [-text] [-engine id]\n&quot;);
-    BIO_printf(bio_err, &quot;or\n&quot;
-               &quot;ts -verify [-data file_to_hash] [-digest digest_bytes] &quot;
-               &quot;[-queryfile request.tsq] &quot;
-               &quot;-in response.tsr [-token_in] &quot;
-               &quot;-CApath ca_path -CAfile ca_file.pem &quot;
-               &quot;-untrusted cert_file.pem\n&quot;);
- cleanup:
+ end:
     /* Clean up. */
-    app_RAND_write_file(NULL, bio_err);
+    app_RAND_write_file(NULL);
     NCONF_free(conf);
     OPENSSL_free(password);
     OBJ_cleanup();
-    if (free_bio_err) {
-        BIO_free_all(bio_err);
-        bio_err = NULL;
-    }
 
-    OPENSSL_EXIT(ret);
+    return (ret);
 }
 
 /*
@@ -418,7 +423,7 @@ static CONF *load_config_file(const char *configfile)
             }
         } else
             ERR_clear_error();
-        if (!add_oid_section(bio_err, conf))
+        if (!add_oid_section(conf))
             ERR_print_errors(bio_err);
     }
     return conf;
@@ -427,7 +432,6 @@ static CONF *load_config_file(const char *configfile)
 /*
  * Query-related method definitions.
  */
-
 static int query_command(const char *data, char *digest, const EVP_MD *md,
                          const char *policy, int no_nonce,
                          int cert, const char *in, const char *out, int text)
@@ -444,20 +448,16 @@ static int query_command(const char *data, char *digest, const EVP_MD *md,
             goto end;
         query = d2i_TS_REQ_bio(in_bio, NULL);
     } else {
-        /*
-         * Open the file if no explicit digest bytes were specified.
-         */
-        if (!digest &amp;&amp; !(data_bio = BIO_open_with_default(data, &quot;rb&quot;, stdin)))
+        /* Open the file if no explicit digest bytes were specified. */
+        if (!digest &amp;&amp; !(data_bio = bio_open_default(data, &quot;rb&quot;)))
             goto end;
-        /* Creating the query object. */
         query = create_query(data_bio, digest, md, policy, no_nonce, cert);
-        /* Saving the random number generator state. */
     }
     if (query == NULL)
         goto end;
 
     /* Write query either in ASN.1 or in text format. */
-    if ((out_bio = BIO_open_with_default(out, &quot;wb&quot;, stdout)) == NULL)
+    if ((out_bio = bio_open_default(out, &quot;wb&quot;)) == NULL)
         goto end;
     if (text) {
         /* Text output. */
@@ -483,13 +483,6 @@ static int query_command(const char *data, char *digest, const EVP_MD *md,
     return ret;
 }
 
-static BIO *BIO_open_with_default(const char *file, const char *mode,
-                                  FILE *default_fp)
-{
-    return file == NULL ? BIO_new_fp(default_fp, BIO_NOCLOSE)
-        : BIO_new_file(file, mode);
-}
-
 static TS_REQ *create_query(BIO *data_bio, char *digest, const EVP_MD *md,
                             const char *policy, int no_nonce, int cert)
 {
@@ -686,7 +679,7 @@ static int reply_command(CONF *conf, char *section, char *engine,
         goto end;
 
     /* Write response either in ASN.1 or text format. */
-    if ((out_bio = BIO_open_with_default(out, &quot;wb&quot;, stdout)) == NULL)
+    if ((out_bio = bio_open_default(out, &quot;wb&quot;)) == NULL)
         goto end;
     if (text) {
         /* Text output. */
@@ -771,8 +764,9 @@ static TS_RESP *read_PKCS7(BIO *in_bio)
 }
 
 static TS_RESP *create_response(CONF *conf, const char *section, char *engine,
-                                char *queryfile, char *passin, char *inkey,
-                                char *signer, char *chain, const char *policy)
+                                char *queryfile, char *passin,
+                                char *inkey, char *signer, char *chain,
+                                const char *policy)
 {
     int ret = 0;
     TS_RESP *response = NULL;
@@ -944,7 +938,7 @@ static int save_ts_serial(const char *serialfile, ASN1_INTEGER *serial)
 
 static int verify_command(char *data, char *digest, char *queryfile,
                           char *in, int token_in,
-                          char *ca_path, char *ca_file, char *untrusted)
+                          char *CApath, char *CAfile, char *untrusted)
 {
     BIO *in_bio = NULL;
     PKCS7 *token = NULL;
@@ -964,7 +958,7 @@ static int verify_command(char *data, char *digest, char *queryfile,
     }
 
     if (!(verify_ctx = create_verify_ctx(data, digest, queryfile,
-                                         ca_path, ca_file, untrusted)))
+                                         CApath, CAfile, untrusted)))
         goto end;
 
     /* Checking the token or response against the request. */
@@ -992,7 +986,7 @@ static int verify_command(char *data, char *digest, char *queryfile,
 
 static TS_VERIFY_CTX *create_verify_ctx(char *data, char *digest,
                                         char *queryfile,
-                                        char *ca_path, char *ca_file,
+                                        char *CApath, char *CAfile,
                                         char *untrusted)
 {
     TS_VERIFY_CTX *ctx = NULL;
@@ -1036,7 +1030,7 @@ static TS_VERIFY_CTX *create_verify_ctx(char *data, char *digest,
     ctx-&gt;flags |= TS_VFY_SIGNATURE;
 
     /* Initialising the X509_STORE object. */
-    if (!(ctx-&gt;store = create_cert_store(ca_path, ca_file)))
+    if (!(ctx-&gt;store = create_cert_store(CApath, CAfile)))
         goto err;
 
     /* Loading untrusted certificates. */
@@ -1054,7 +1048,7 @@ static TS_VERIFY_CTX *create_verify_ctx(char *data, char *digest,
     return ctx;
 }
 
-static X509_STORE *create_cert_store(char *ca_path, char *ca_file)
+static X509_STORE *create_cert_store(char *CApath, char *CAfile)
 {
     X509_STORE *cert_ctx = NULL;
     X509_LOOKUP *lookup = NULL;
@@ -1067,29 +1061,29 @@ static X509_STORE *create_cert_store(char *ca_path, char *ca_file)
     X509_STORE_set_verify_cb(cert_ctx, verify_cb);
 
     /* Adding a trusted certificate directory source. */
-    if (ca_path) {
+    if (CApath) {
         lookup = X509_STORE_add_lookup(cert_ctx, X509_LOOKUP_hash_dir());
         if (lookup == NULL) {
             BIO_printf(bio_err, &quot;memory allocation failure\n&quot;);
             goto err;
         }
-        i = X509_LOOKUP_add_dir(lookup, ca_path, X509_FILETYPE_PEM);
+        i = X509_LOOKUP_add_dir(lookup, CApath, X509_FILETYPE_PEM);
         if (!i) {
-            BIO_printf(bio_err, &quot;Error loading directory %s\n&quot;, ca_path);
+            BIO_printf(bio_err, &quot;Error loading directory %s\n&quot;, CApath);
             goto err;
         }
     }
 
     /* Adding a trusted certificate file source. */
-    if (ca_file) {
+    if (CAfile) {
         lookup = X509_STORE_add_lookup(cert_ctx, X509_LOOKUP_file());
         if (lookup == NULL) {
             BIO_printf(bio_err, &quot;memory allocation failure\n&quot;);
             goto err;
         }
-        i = X509_LOOKUP_load_file(lookup, ca_file, X509_FILETYPE_PEM);
+        i = X509_LOOKUP_load_file(lookup, CAfile, X509_FILETYPE_PEM);
         if (!i) {
-            BIO_printf(bio_err, &quot;Error loading file %s\n&quot;, ca_file);
+            BIO_printf(bio_err, &quot;Error loading file %s\n&quot;, CAfile);
             goto err;
         }
     }
@@ -1102,19 +1096,5 @@ static X509_STORE *create_cert_store(char *ca_path, char *ca_file)
 
 static int verify_cb(int ok, X509_STORE_CTX *ctx)
 {
-    /*-
-    char buf[256];
-
-    if (!ok)
-            {
-            X509_NAME_oneline(X509_get_subject_name(ctx-&gt;current_cert),
-                              buf, sizeof(buf));
-            printf(&quot;%s\n&quot;, buf);
-            printf(&quot;error %d at %d depth lookup: %s\n&quot;,
-                   ctx-&gt;error, ctx-&gt;error_depth,
-                    X509_verify_cert_error_string(ctx-&gt;error));
-            }
-    */
-
     return ok;
 }
diff --git a/apps/verify.c b/apps/verify.c
index e771be2..61e85ce 100644
--- a/apps/verify.c
+++ b/apps/verify.c
@@ -1,4 +1,3 @@
-/* apps/verify.c */
 /* Copyright (C) 1995-1998 Eric Young (<A HREF="../../../mailman/listinfo/openssl-commits.html">eay at cryptsoft.com</A>)
  * All rights reserved.
  *
@@ -66,209 +65,173 @@
 #include &lt;openssl/x509v3.h&gt;
 #include &lt;openssl/pem.h&gt;
 
-#undef PROG
-#define PROG    verify_main
-
 static int cb(int ok, X509_STORE_CTX *ctx);
 static int check(X509_STORE *ctx, char *file,
                  STACK_OF(X509) *uchain, STACK_OF(X509) *tchain,
                  STACK_OF(X509_CRL) *crls, ENGINE *e, int show_chain);
 static int v_verbose = 0, vflags = 0;
 
-int MAIN(int, char **);
+typedef enum OPTION_choice {
+    OPT_ERR = -1, OPT_EOF = 0, OPT_HELP,
+    OPT_ENGINE, OPT_CAPATH, OPT_CAFILE, OPT_UNTRUSTED, OPT_TRUSTED,
+    OPT_CRLFILE, OPT_CRL_DOWNLOAD, OPT_SHOW_CHAIN,
+    OPT_V_ENUM,
+    OPT_VERBOSE
+} OPTION_CHOICE;
+
+OPTIONS verify_options[] = {
+    {OPT_HELP_STR, 1, '-', &quot;Usage: %s [options] cert.pem...\n&quot;},
+    {OPT_HELP_STR, 1, '-', &quot;Valid options are:\n&quot;},
+    {&quot;help&quot;, OPT_HELP, '-', &quot;Display this summary&quot;},
+    {&quot;verbose&quot;, OPT_VERBOSE, '-'},
+    {&quot;CApath&quot;, OPT_CAPATH, '/'},
+    {&quot;CAfile&quot;, OPT_CAFILE, '&lt;'},
+    {&quot;untrusted&quot;, OPT_UNTRUSTED, '&lt;'},
+    {&quot;trusted&quot;, OPT_TRUSTED, '&lt;'},
+    {&quot;CRLfile&quot;, OPT_CRLFILE, '&lt;'},
+    {&quot;crl_download&quot;, OPT_CRL_DOWNLOAD, '-'},
+    {&quot;show_chain&quot;, OPT_SHOW_CHAIN, '-'},
+#ifndef OPENSSL_NO_ENGINE
+    {&quot;engine&quot;, OPT_ENGINE, 's', &quot;Use engine, possibly a hardware device&quot;},
+#endif
+    OPT_V_OPTIONS,
+    {NULL}
+};
 
-int MAIN(int argc, char **argv)
+int verify_main(int argc, char **argv)
 {
     ENGINE *e = NULL;
-    int i, ret = 1, badarg = 0;
-    char *CApath = NULL, *CAfile = NULL;
-    char *untfile = NULL, *trustfile = NULL, *crlfile = NULL;
     STACK_OF(X509) *untrusted = NULL, *trusted = NULL;
     STACK_OF(X509_CRL) *crls = NULL;
-    X509_STORE *cert_ctx = NULL;
-    X509_LOOKUP *lookup = NULL;
+    X509_STORE *store = NULL;
     X509_VERIFY_PARAM *vpm = NULL;
-    int crl_download = 0, show_chain = 0;
-#ifndef OPENSSL_NO_ENGINE
-    char *engine = NULL;
-#endif
+    char *prog, *CApath = NULL, *CAfile = NULL, *engine = NULL;
+    char *untfile = NULL, *trustfile = NULL, *crlfile = NULL;
+    int vpmtouched = 0, crl_download = 0, show_chain = 0, i = 0, ret = 1;
+    OPTION_CHOICE o;
 
-    cert_ctx = X509_STORE_new();
-    if (cert_ctx == NULL)
+    if ((vpm = X509_VERIFY_PARAM_new()) == NULL)
         goto end;
-    X509_STORE_set_verify_cb(cert_ctx, cb);
-
-    ERR_load_crypto_strings();
-
-    apps_startup();
 
-    if (bio_err == NULL)
-        if ((bio_err = BIO_new(BIO_s_file())) != NULL)
-            BIO_set_fp(bio_err, stderr, BIO_NOCLOSE | BIO_FP_TEXT);
-
-    if (!load_config(bio_err, NULL))
-        goto end;
+    prog = opt_init(argc, argv, verify_options);
+    while ((o = opt_next()) != OPT_EOF) {
+        switch (o) {
+        case OPT_EOF:
+        case OPT_ERR:
+            BIO_printf(bio_err, &quot;%s: Use -help for summary.\n&quot;, prog);
+            goto end;
+        case OPT_HELP:
+            opt_help(verify_options);
+            BIO_printf(bio_err, &quot;Recognized usages:\n&quot;);
+            for (i = 0; i &lt; X509_PURPOSE_get_count(); i++) {
+                X509_PURPOSE *ptmp;
+                ptmp = X509_PURPOSE_get0(i);
+                BIO_printf(bio_err, &quot;\t%-10s\t%s\n&quot;,
+                        X509_PURPOSE_get0_sname(ptmp),
+                        X509_PURPOSE_get0_name(ptmp));
+            }
 
-    argc--;
-    argv++;
-    for (;;) {
-        if (argc &gt;= 1) {
-            if (strcmp(*argv, &quot;-CApath&quot;) == 0) {
-                if (argc-- &lt; 1)
-                    goto end;
-                CApath = *(++argv);
-            } else if (strcmp(*argv, &quot;-CAfile&quot;) == 0) {
-                if (argc-- &lt; 1)
-                    goto end;
-                CAfile = *(++argv);
-            } else if (args_verify(&amp;argv, &amp;argc, &amp;badarg, bio_err, &amp;vpm)) {
-                if (badarg)
-                    goto end;
-                continue;
-            } else if (strcmp(*argv, &quot;-untrusted&quot;) == 0) {
-                if (argc-- &lt; 1)
-                    goto end;
-                untfile = *(++argv);
-            } else if (strcmp(*argv, &quot;-trusted&quot;) == 0) {
-                if (argc-- &lt; 1)
-                    goto end;
-                trustfile = *(++argv);
-            } else if (strcmp(*argv, &quot;-CRLfile&quot;) == 0) {
-                if (argc-- &lt; 1)
-                    goto end;
-                crlfile = *(++argv);
-            } else if (strcmp(*argv, &quot;-crl_download&quot;) == 0)
-                crl_download = 1;
-            else if (strcmp(*argv, &quot;-show_chain&quot;) == 0)
-                show_chain = 1;
-#ifndef OPENSSL_NO_ENGINE
-            else if (strcmp(*argv, &quot;-engine&quot;) == 0) {
-                if (--argc &lt; 1)
-                    goto end;
-                engine = *(++argv);
+            BIO_printf(bio_err, &quot;Recognized verify names:\n&quot;);
+            for (i = 0; i &lt; X509_VERIFY_PARAM_get_count(); i++) {
+                const X509_VERIFY_PARAM *vptmp;
+                vptmp = X509_VERIFY_PARAM_get0(i);
+                BIO_printf(bio_err, &quot;\t%-10s\n&quot;,
+                        X509_VERIFY_PARAM_get0_name(vptmp));
             }
-#endif
-            else if (strcmp(*argv, &quot;-help&quot;) == 0)
-                goto end;
-            else if (strcmp(*argv, &quot;-verbose&quot;) == 0)
-                v_verbose = 1;
-            else if (argv[0][0] == '-')
+            ret = 0;
+            goto end;
+        case OPT_V_CASES:
+            if (!opt_verify(o, vpm))
                 goto end;
-            else
-                break;
-            argc--;
-            argv++;
-        } else
+            vpmtouched++;
+            break;
+        case OPT_CAPATH:
+            CApath = opt_arg();
+            break;
+        case OPT_CAFILE:
+            CAfile = opt_arg();
+            break;
+        case OPT_UNTRUSTED:
+            untfile = opt_arg();
+            break;
+        case OPT_TRUSTED:
+            trustfile = opt_arg();
+            break;
+        case OPT_CRLFILE:
+            crlfile = opt_arg();
+            break;
+        case OPT_CRL_DOWNLOAD:
+            crl_download = 1;
             break;
+        case OPT_SHOW_CHAIN:
+            show_chain = 1;
+            break;
+        case OPT_ENGINE:
+            engine = opt_arg();
+            break;
+        case OPT_VERBOSE:
+            v_verbose = 1;
+            break;
+        }
     }
+    argc = opt_num_rest();
+    argv = opt_rest();
 
 #ifndef OPENSSL_NO_ENGINE
-    e = setup_engine(bio_err, engine, 0);
+    e = setup_engine(engine, 0);
 #endif
+    if (!(store = setup_verify(CAfile, CApath)))
+        goto end;
+    X509_STORE_set_verify_cb(store, cb);
 
-    if (vpm)
-        X509_STORE_set1_param(cert_ctx, vpm);
-
-    lookup = X509_STORE_add_lookup(cert_ctx, X509_LOOKUP_file());
-    if (lookup == NULL)
-        abort();
-    if (CAfile) {
-        i = X509_LOOKUP_load_file(lookup, CAfile, X509_FILETYPE_PEM);
-        if (!i) {
-            BIO_printf(bio_err, &quot;Error loading file %s\n&quot;, CAfile);
-            ERR_print_errors(bio_err);
-            goto end;
-        }
-    } else
-        X509_LOOKUP_load_file(lookup, NULL, X509_FILETYPE_DEFAULT);
-
-    lookup = X509_STORE_add_lookup(cert_ctx, X509_LOOKUP_hash_dir());
-    if (lookup == NULL)
-        abort();
-    if (CApath) {
-        i = X509_LOOKUP_add_dir(lookup, CApath, X509_FILETYPE_PEM);
-        if (!i) {
-            BIO_printf(bio_err, &quot;Error loading directory %s\n&quot;, CApath);
-            ERR_print_errors(bio_err);
-            goto end;
-        }
-    } else
-        X509_LOOKUP_add_dir(lookup, NULL, X509_FILETYPE_DEFAULT);
+    if (vpmtouched)
+        X509_STORE_set1_param(store, vpm);
 
     ERR_clear_error();
 
     if (untfile) {
-        untrusted = load_certs(bio_err, untfile, FORMAT_PEM,
+        untrusted = load_certs(untfile, FORMAT_PEM,
                                NULL, e, &quot;untrusted certificates&quot;);
         if (!untrusted)
             goto end;
     }
 
     if (trustfile) {
-        trusted = load_certs(bio_err, trustfile, FORMAT_PEM,
+        trusted = load_certs(trustfile, FORMAT_PEM,
                              NULL, e, &quot;trusted certificates&quot;);
         if (!trusted)
             goto end;
     }
 
     if (crlfile) {
-        crls = load_crls(bio_err, crlfile, FORMAT_PEM, NULL, e, &quot;other CRLs&quot;);
+        crls = load_crls(crlfile, FORMAT_PEM, NULL, e, &quot;other CRLs&quot;);
         if (!crls)
             goto end;
     }
 
     if (crl_download)
-        store_setup_crl_download(cert_ctx);
+        store_setup_crl_download(store);
 
     ret = 0;
     if (argc &lt; 1) {
-        if (1 !=
-            check(cert_ctx, NULL, untrusted, trusted, crls, e, show_chain))
+        if (check(store, NULL, untrusted, trusted, crls, e, show_chain) != 1)
             ret = -1;
     } else {
         for (i = 0; i &lt; argc; i++)
-            if (1 !=
-                check(cert_ctx, argv[i], untrusted, trusted, crls, e,
-                      show_chain))
+            if (check(store, argv[i], untrusted, trusted, crls, e,
+                      show_chain) != 1)
                 ret = -1;
     }
 
  end:
-    if (ret == 1) {
-        BIO_printf(bio_err,
-                   &quot;usage: verify [-verbose] [-CApath path] [-CAfile file] [-trusted_first] [-purpose purpose] [-crl_check] [-no_alt_chains]&quot;);
-#ifndef OPENSSL_NO_ENGINE
-        BIO_printf(bio_err, &quot; [-engine e]&quot;);
-#endif
-        BIO_printf(bio_err, &quot; cert1 cert2 ...\n&quot;);
-
-        BIO_printf(bio_err, &quot;recognized usages:\n&quot;);
-        for (i = 0; i &lt; X509_PURPOSE_get_count(); i++) {
-            X509_PURPOSE *ptmp;
-            ptmp = X509_PURPOSE_get0(i);
-            BIO_printf(bio_err, &quot;\t%-10s\t%s\n&quot;,
-                       X509_PURPOSE_get0_sname(ptmp),
-                       X509_PURPOSE_get0_name(ptmp));
-        }
-
-        BIO_printf(bio_err, &quot;recognized verify names:\n&quot;);
-        for (i = 0; i &lt; X509_VERIFY_PARAM_get_count(); i++) {
-            const X509_VERIFY_PARAM *vptmp;
-            vptmp = X509_VERIFY_PARAM_get0(i);
-            BIO_printf(bio_err, &quot;\t%-10s\n&quot;,
-                       X509_VERIFY_PARAM_get0_name(vptmp));
-        }
-
-    }
     if (vpm)
         X509_VERIFY_PARAM_free(vpm);
-    if (cert_ctx != NULL)
-        X509_STORE_free(cert_ctx);
+    if (store != NULL)
+        X509_STORE_free(store);
     sk_X509_pop_free(untrusted, X509_free);
     sk_X509_pop_free(trusted, X509_free);
     sk_X509_CRL_pop_free(crls, X509_CRL_free);
-    apps_shutdown();
-    OPENSSL_EXIT(ret &lt; 0 ? 2 : ret);
+    return (ret &lt; 0 ? 2 : ret);
 }
 
 static int check(X509_STORE *ctx, char *file,
@@ -280,10 +243,10 @@ static int check(X509_STORE *ctx, char *file,
     X509_STORE_CTX *csc;
     STACK_OF(X509) *chain = NULL;
 
-    x = load_cert(bio_err, file, FORMAT_PEM, NULL, e, &quot;certificate file&quot;);
+    x = load_cert(file, FORMAT_PEM, NULL, e, &quot;certificate file&quot;);
     if (x == NULL)
         goto end;
-    fprintf(stdout, &quot;%s: &quot;, (file == NULL) ? &quot;stdin&quot; : file);
+    printf(&quot;%s: &quot;, (file == NULL) ? &quot;stdin&quot; : file);
 
     csc = X509_STORE_CTX_new();
     if (csc == NULL) {
@@ -307,7 +270,7 @@ static int check(X509_STORE *ctx, char *file,
     ret = 0;
  end:
     if (i &gt; 0) {
-        fprintf(stdout, &quot;OK\n&quot;);
+        printf(&quot;OK\n&quot;);
         ret = 1;
     } else
         ERR_print_errors(bio_err);
@@ -348,7 +311,7 @@ static int cb(int ok, X509_STORE_CTX *ctx)
                X509_verify_cert_error_string(cert_error));
         switch (cert_error) {
         case X509_V_ERR_NO_EXPLICIT_POLICY:
-            policies_print(NULL, ctx);
+            policies_print(bio_err, ctx);
         case X509_V_ERR_CERT_HAS_EXPIRED:
 
             /*
@@ -373,7 +336,7 @@ static int cb(int ok, X509_STORE_CTX *ctx)
 
     }
     if (cert_error == X509_V_OK &amp;&amp; ok == 2)
-        policies_print(NULL, ctx);
+        policies_print(bio_out, ctx);
     if (!v_verbose)
         ERR_clear_error();
     return (ok);
diff --git a/apps/version.c b/apps/version.c
index 8807d4c..1fa7cfe 100644
--- a/apps/version.c
+++ b/apps/version.c
@@ -1,4 +1,3 @@
-/* apps/version.c */
 /* Copyright (C) 1995-1998 Eric Young (<A HREF="../../../mailman/listinfo/openssl-commits.html">eay at cryptsoft.com</A>)
  * All rights reserved.
  *
@@ -132,45 +131,66 @@
 # include &lt;openssl/blowfish.h&gt;
 #endif
 
-#undef PROG
-#define PROG    version_main
+typedef enum OPTION_choice {
+    OPT_ERR = -1, OPT_EOF = 0, OPT_HELP,
+    OPT_B, OPT_D, OPT_F, OPT_O, OPT_P, OPT_V, OPT_A
+} OPTION_CHOICE;
 
-int MAIN(int, char **);
+OPTIONS version_options[] = {
+    {&quot;help&quot;, OPT_HELP, '-', &quot;Display this summary&quot;},
+    {&quot;a&quot;, OPT_A, '-', &quot;Show all data&quot;},
+    {&quot;b&quot;, OPT_B, '-', &quot;Show build date&quot;},
+    {&quot;d&quot;, OPT_D, '-', &quot;Show configuration directory&quot;},
+    {&quot;f&quot;, OPT_F, '-', &quot;Show compiler flags used&quot;},
+    {&quot;o&quot;, OPT_O, '-', &quot;Show some internal datatype options&quot;},
+    {&quot;p&quot;, OPT_P, '-', &quot;Show target build platform&quot;},
+    {&quot;v&quot;, OPT_V, '-', &quot;Show library version&quot;},
+    {NULL}
+};
 
-int MAIN(int argc, char **argv)
+int version_main(int argc, char **argv)
 {
-    int i, ret = 0;
+    int ret = 1, dirty = 0;
     int cflags = 0, version = 0, date = 0, options = 0, platform = 0, dir = 0;
+    char *prog;
+    OPTION_CHOICE o;
 
-    apps_startup();
-
-    if (bio_err == NULL)
-        if ((bio_err = BIO_new(BIO_s_file())) != NULL)
-            BIO_set_fp(bio_err, stderr, BIO_NOCLOSE | BIO_FP_TEXT);
-
-    if (argc == 1)
-        version = 1;
-    for (i = 1; i &lt; argc; i++) {
-        if (strcmp(argv[i], &quot;-v&quot;) == 0)
-            version = 1;
-        else if (strcmp(argv[i], &quot;-b&quot;) == 0)
-            date = 1;
-        else if (strcmp(argv[i], &quot;-f&quot;) == 0)
-            cflags = 1;
-        else if (strcmp(argv[i], &quot;-o&quot;) == 0)
-            options = 1;
-        else if (strcmp(argv[i], &quot;-p&quot;) == 0)
-            platform = 1;
-        else if (strcmp(argv[i], &quot;-d&quot;) == 0)
-            dir = 1;
-        else if (strcmp(argv[i], &quot;-a&quot;) == 0)
-            date = version = cflags = options = platform = dir = 1;
-        else {
-            BIO_printf(bio_err, &quot;usage:version -[avbofpd]\n&quot;);
-            ret = 1;
+    prog = opt_init(argc, argv, version_options);
+    while ((o = opt_next()) != OPT_EOF) {
+        switch (o) {
+        case OPT_EOF:
+        case OPT_ERR:
+            BIO_printf(bio_err, &quot;%s: Use -help for summary.\n&quot;, prog);
             goto end;
+        case OPT_HELP:
+            opt_help(version_options);
+            ret = 0;
+            goto end;
+        case OPT_B:
+            dirty = date = 1;
+            break;
+        case OPT_D:
+            dirty = dir = 1;
+            break;
+        case OPT_F:
+            dirty = cflags = 1;
+            break;
+        case OPT_O:
+            dirty = options = 1;
+            break;
+        case OPT_P:
+            dirty = platform = 1;
+            break;
+        case OPT_V:
+            dirty = version = 1;
+            break;
+        case OPT_A:
+            cflags = version = date = platform = dir = 1;
+            break;
         }
     }
+    if (!dirty)
+        version = 1;
 
     if (version) {
         if (SSLeay() == SSLEAY_VERSION_NUMBER) {
@@ -208,7 +228,7 @@ int MAIN(int argc, char **argv)
         printf(&quot;%s\n&quot;, SSLeay_version(SSLEAY_CFLAGS));
     if (dir)
         printf(&quot;%s\n&quot;, SSLeay_version(SSLEAY_DIR));
+    ret = 0;
  end:
-    apps_shutdown();
-    OPENSSL_EXIT(ret);
+    return (ret);
 }
diff --git a/apps/vms_decc_init.c b/apps/vms_decc_init.c
index 3b6de11..3c953aa 100644
--- a/apps/vms_decc_init.c
+++ b/apps/vms_decc_init.c
@@ -1,3 +1,55 @@
+/*
+ * Written by sms and contributed to the OpenSSL project.
+ */
+/* ====================================================================
+ * Copyright (c) 2010 The OpenSSL Project.  All rights reserved.
+ *
+ * Redistribution and use in source and binary forms, with or without
+ * modification, are permitted provided that the following conditions
+ * are met:
+ *
+ * 1. Redistributions of source code must retain the above copyright
+ *    notice, this list of conditions and the following disclaimer.
+ *
+ * 2. Redistributions in binary form must reproduce the above copyright
+ *    notice, this list of conditions and the following disclaimer in
+ *    the documentation and/or other materials provided with the
+ *    distribution.
+ *
+ * 3. All advertising materials mentioning features or use of this
+ *    software must display the following acknowledgment:
+ *    &quot;This product includes software developed by the OpenSSL Project
+ *    for use in the OpenSSL Toolkit. (<A HREF="http://www.OpenSSL.org/">http://www.OpenSSL.org/</A>)&quot;
+ *
+ * 4. The names &quot;OpenSSL Toolkit&quot; and &quot;OpenSSL Project&quot; must not be used to
+ *    endorse or promote products derived from this software without
+ *    prior written permission. For written permission, please contact
+ *    <A HREF="../../../mailman/listinfo/openssl-commits.html">licensing at OpenSSL.org.</A>
+ *
+ * 5. Products derived from this software may not be called &quot;OpenSSL&quot;
+ *    nor may &quot;OpenSSL&quot; appear in their names without prior written
+ *    permission of the OpenSSL Project.
+ *
+ * 6. Redistributions of any form whatsoever must retain the following
+ *    acknowledgment:
+ *    &quot;This product includes software developed by the OpenSSL Project
+ *    for use in the OpenSSL Toolkit (<A HREF="http://www.OpenSSL.org/">http://www.OpenSSL.org/</A>)&quot;
+ *
+ * THIS SOFTWARE IS PROVIDED BY THE OpenSSL PROJECT ``AS IS'' AND ANY
+ * EXPRESSED OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
+ * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR
+ * PURPOSE ARE DISCLAIMED.  IN NO EVENT SHALL THE OpenSSL PROJECT OR
+ * ITS CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
+ * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT
+ * NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;
+ * LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)
+ * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT,
+ * STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)
+ * ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED
+ * OF THE POSSIBILITY OF SUCH DAMAGE.
+ * ====================================================================
+ */
+
 #if defined( __VMS) &amp;&amp; !defined( OPENSSL_NO_DECC_INIT) &amp;&amp; \
  defined( __DECC) &amp;&amp; !defined( __VAX) &amp;&amp; (__CRTL_VER &gt;= 70301000)
 # define USE_DECC_INIT 1
@@ -5,17 +57,11 @@
 
 #ifdef USE_DECC_INIT
 
-/*-
- * 2010-04-26 SMS.
- *
- *----------------------------------------------------------------------
- *
- *       decc_init()
- *
- *    On non-VAX systems, uses LIB$INITIALIZE to set a collection of C
- *    RTL features without using the DECC$* logical name method.
- *
- *----------------------------------------------------------------------
+/*
+ * ----------------------------------------------------------------------
+ * decc_init() On non-VAX systems, uses LIB$INITIALIZE to set a collection
+ * of C RTL features without using the DECC$* logical name method.
+ * ----------------------------------------------------------------------
  */
 
 # include &lt;stdio.h&gt;
@@ -57,6 +103,42 @@ decc_feat_t decc_feat_array[] = {
     {(char *)NULL, 0}
 };
 
+char **copy_argv(int *argc, char *argv[])
+{
+    /*-
+     * The note below is for historical purpose.  On VMS now we always
+     * copy argv &quot;safely.&quot;
+     *
+     * 2011-03-22 SMS.
+     * If we have 32-bit pointers everywhere, then we're safe, and
+     * we bypass this mess, as on non-VMS systems.
+     * Problem 1: Compaq/HP C before V7.3 always used 32-bit
+     * pointers for argv[].
+     * Fix 1: For a 32-bit argv[], when we're using 64-bit pointers
+     * everywhere else, we always allocate and use a 64-bit
+     * duplicate of argv[].
+     * Problem 2: Compaq/HP C V7.3 (Alpha, IA64) before ECO1 failed
+     * to NULL-terminate a 64-bit argv[].  (As this was written, the
+     * compiler ECO was available only on IA64.)
+     * Fix 2: Unless advised not to (VMS_TRUST_ARGV), we test a
+     * 64-bit argv[argc] for NULL, and, if necessary, use a
+     * (properly) NULL-terminated (64-bit) duplicate of argv[].
+     * The same code is used in either case to duplicate argv[].
+     * Some of these decisions could be handled in preprocessing,
+     * but the code tends to get even uglier, and the penalty for
+     * deciding at compile- or run-time is tiny.
+     */
+
+    int i, count = *argc;
+    char **newargv = (char **)OPENSSL_malloc((count + 1) * sizeof *newargv);
+
+    for (i = 0; i &lt; count; i++)
+        newargv[i] = argv[i];
+    newargv[i] = NULL;
+    *argc = i;
+    return newargv;
+}
+
 /* LIB$INITIALIZE initialization function. */
 
 static void decc_init(void)
diff --git a/apps/winrand.c b/apps/winrand.c
index 44f57a3..a5fe791 100644
--- a/apps/winrand.c
+++ b/apps/winrand.c
@@ -1,4 +1,3 @@
-/* apps/winrand.c */
 /* ====================================================================
  * Copyright (c) 1998-2000 The OpenSSL Project.  All rights reserved.
  *
diff --git a/apps/x509.c b/apps/x509.c
index 380f0f0..903e6b9 100644
--- a/apps/x509.c
+++ b/apps/x509.c
@@ -1,4 +1,3 @@
-/* apps/x509.c */
 /* Copyright (C) 1995-1998 Eric Young (<A HREF="../../../mailman/listinfo/openssl-commits.html">eay at cryptsoft.com</A>)
  * All rights reserved.
  *
@@ -77,82 +76,10 @@
 # include &lt;openssl/dsa.h&gt;
 #endif
 
-#undef PROG
-#define PROG x509_main
-
 #undef POSTFIX
 #define POSTFIX &quot;.srl&quot;
 #define DEF_DAYS        30
 
-static const char *x509_usage[] = {
-    &quot;usage: x509 args\n&quot;,
-    &quot; -inform arg     - input format - default PEM (one of DER, NET or PEM)\n&quot;,
-    &quot; -outform arg    - output format - default PEM (one of DER, NET or PEM)\n&quot;,
-    &quot; -keyform arg    - private key format - default PEM\n&quot;,
-    &quot; -CAform arg     - CA format - default PEM\n&quot;,
-    &quot; -CAkeyform arg  - CA key format - default PEM\n&quot;,
-    &quot; -in arg         - input file - default stdin\n&quot;,
-    &quot; -out arg        - output file - default stdout\n&quot;,
-    &quot; -passin arg     - private key password source\n&quot;,
-    &quot; -serial         - print serial number value\n&quot;,
-    &quot; -subject_hash   - print subject hash value\n&quot;,
-#ifndef OPENSSL_NO_MD5
-    &quot; -subject_hash_old   - print old-style (MD5) subject hash value\n&quot;,
-#endif
-    &quot; -issuer_hash    - print issuer hash value\n&quot;,
-#ifndef OPENSSL_NO_MD5
-    &quot; -issuer_hash_old    - print old-style (MD5) issuer hash value\n&quot;,
-#endif
-    &quot; -hash           - synonym for -subject_hash\n&quot;,
-    &quot; -subject        - print subject DN\n&quot;,
-    &quot; -issuer         - print issuer DN\n&quot;,
-    &quot; -email          - print email address(es)\n&quot;,
-    &quot; -startdate      - notBefore field\n&quot;,
-    &quot; -enddate        - notAfter field\n&quot;,
-    &quot; -purpose        - print out certificate purposes\n&quot;,
-    &quot; -dates          - both Before and After dates\n&quot;,
-    &quot; -modulus        - print the RSA key modulus\n&quot;,
-    &quot; -pubkey         - output the public key\n&quot;,
-    &quot; -fingerprint    - print the certificate fingerprint\n&quot;,
-    &quot; -alias          - output certificate alias\n&quot;,
-    &quot; -noout          - no certificate output\n&quot;,
-    &quot; -ocspid         - print OCSP hash values for the subject name and public key\n&quot;,
-    &quot; -ocsp_uri       - print OCSP Responder URL(s)\n&quot;,
-    &quot; -trustout       - output a \&quot;trusted\&quot; certificate\n&quot;,
-    &quot; -clrtrust       - clear all trusted purposes\n&quot;,
-    &quot; -clrreject      - clear all rejected purposes\n&quot;,
-    &quot; -addtrust arg   - trust certificate for a given purpose\n&quot;,
-    &quot; -addreject arg  - reject certificate for a given purpose\n&quot;,
-    &quot; -setalias arg   - set certificate alias\n&quot;,
-    &quot; -days arg       - How long till expiry of a signed certificate - def 30 days\n&quot;,
-    &quot; -checkend arg   - check whether the cert expires in the next arg seconds\n&quot;,
-    &quot;                   exit 1 if so, 0 if not\n&quot;,
-    &quot; -signkey arg    - self sign cert with arg\n&quot;,
-    &quot; -x509toreq      - output a certification request object\n&quot;,
-    &quot; -req            - input is a certificate request, sign and output.\n&quot;,
-    &quot; -CA arg         - set the CA certificate, must be PEM format.\n&quot;,
-    &quot; -CAkey arg      - set the CA key, must be PEM format\n&quot;,
-    &quot;                   missing, it is assumed to be in the CA file.\n&quot;,
-    &quot; -CAcreateserial - create serial number file if it does not exist\n&quot;,
-    &quot; -CAserial arg   - serial file\n&quot;,
-    &quot; -set_serial     - serial number to use\n&quot;,
-    &quot; -text           - print the certificate in text form\n&quot;,
-    &quot; -C              - print out C code forms\n&quot;,
-    &quot; -md2/-md5/-sha1/-mdc2 - digest to use\n&quot;,
-    &quot; -extfile        - configuration file with X509V3 extensions to add\n&quot;,
-    &quot; -extensions     - section from config file with X509V3 extensions to add\n&quot;,
-    &quot; -clrext         - delete extensions before signing and input certificate\n&quot;,
-    &quot; -nameopt arg    - various certificate name options\n&quot;,
-#ifndef OPENSSL_NO_ENGINE
-    &quot; -engine e       - use engine e, possibly a hardware device.\n&quot;,
-#endif
-    &quot; -certopt arg    - various certificate text options\n&quot;,
-    &quot; -checkhost host - check certificate matches \&quot;host\&quot;\n&quot;,
-    &quot; -checkemail email - check certificate matches \&quot;email\&quot;\n&quot;,
-    &quot; -checkip ipaddr - check certificate matches \&quot;ipaddr\&quot;\n&quot;,
-    NULL
-};
-
 static int callb(int ok, X509_STORE_CTX *ctx);
 static int sign(X509 *x, EVP_PKEY *pkey, int days, int clrext,
                 const EVP_MD *digest, CONF *conf, char *section);
@@ -160,347 +87,425 @@ static int x509_certify(X509_STORE *ctx, char *CAfile, const EVP_MD *digest,
                         X509 *x, X509 *xca, EVP_PKEY *pkey,
                         STACK_OF(OPENSSL_STRING) *sigopts, char *serial,
                         int create, int days, int clrext, CONF *conf,
-                        char *section, ASN1_INTEGER *sno);
+                        char *section, ASN1_INTEGER *sno, int reqfile);
 static int purpose_print(BIO *bio, X509 *cert, X509_PURPOSE *pt);
-static int reqfile = 0;
+
 #ifdef OPENSSL_SSL_DEBUG_BROKEN_PROTOCOL
 static int force_version = 2;
 #endif
 
-int MAIN(int, char **);
+typedef enum OPTION_choice {
+    OPT_ERR = -1, OPT_EOF = 0, OPT_HELP,
+    OPT_INFORM, OPT_OUTFORM, OPT_KEYFORM, OPT_REQ, OPT_CAFORM,
+    OPT_CAKEYFORM, OPT_SIGOPT, OPT_DAYS, OPT_PASSIN, OPT_EXTFILE,
+    OPT_EXTENSIONS, OPT_IN, OPT_OUT, OPT_SIGNKEY, OPT_CA,
+    OPT_CAKEY, OPT_CASERIAL, OPT_SET_SERIAL, OPT_FORCE_PUBKEY,
+    OPT_ADDTRUST, OPT_ADDREJECT, OPT_SETALIAS, OPT_CERTOPT, OPT_NAMEOPT,
+    OPT_C, OPT_EMAIL, OPT_OCSP_URI, OPT_SERIAL, OPT_NEXT_SERIAL,
+    OPT_MODULUS, OPT_PUBKEY, OPT_X509TOREQ, OPT_TEXT, OPT_HASH,
+    OPT_ISSUER_HASH, OPT_SUBJECT, OPT_ISSUER, OPT_FINGERPRINT, OPT_DATES,
+    OPT_PURPOSE, OPT_STARTDATE, OPT_ENDDATE, OPT_CHECKEND, OPT_CHECKHOST,
+    OPT_CHECKEMAIL, OPT_CHECKIP, OPT_NOOUT, OPT_TRUSTOUT, OPT_CLRTRUST,
+    OPT_CLRREJECT, OPT_ALIAS, OPT_CACREATESERIAL, OPT_CLREXT, OPT_OCSPID,
+#ifndef OPENSSL_NO_MD5
+    OPT_SUBJECT_HASH_OLD,
+    OPT_ISSUER_HASH_OLD,
+#endif
+#ifdef OPENSSL_SSL_DEBUG_BROKEN_PROTOCOL
+    OPT_FORCE_VERSION,
+#endif
+    OPT_BADSIG, OPT_MD, OPT_ENGINE, OPT_NOCERT
+} OPTION_CHOICE;
+
+OPTIONS x509_options[] = {
+    {&quot;help&quot;, OPT_HELP, '-', &quot;Display this summary&quot;},
+    {&quot;inform&quot;, OPT_INFORM, 'f',
+     &quot;Input format - default PEM (one of DER, NET or PEM)&quot;},
+    {&quot;in&quot;, OPT_IN, '&lt;', &quot;Input file - default stdin&quot;},
+    {&quot;outform&quot;, OPT_OUTFORM, 'f',
+     &quot;Output format - default PEM (one of DER, NET or PEM)&quot;},
+    {&quot;out&quot;, OPT_OUT, '&gt;', &quot;Output file - default stdout&quot;},
+    {&quot;keyform&quot;, OPT_KEYFORM, 'F', &quot;Private key format - default PEM&quot;},
+    {&quot;passin&quot;, OPT_PASSIN, 's', &quot;Private key password source&quot;},
+    {&quot;serial&quot;, OPT_SERIAL, '-', &quot;Print serial number value&quot;},
+    {&quot;subject_hash&quot;, OPT_HASH, '-', &quot;Print subject hash value&quot;},
+    {&quot;issuer_hash&quot;, OPT_ISSUER_HASH, '-', &quot;Print issuer hash value&quot;},
+#ifndef OPENSSL_NO_MD5
+    {&quot;subject_hash_old&quot;, OPT_SUBJECT_HASH_OLD, '-',
+     &quot;Print old-style (MD5) issuer hash value&quot;},
+    {&quot;issuer_hash_old&quot;, OPT_ISSUER_HASH_OLD, '-',
+     &quot;Print old-style (MD5) subject hash value&quot;},
+#endif
+    {&quot;hash&quot;, OPT_HASH, '-', &quot;Synonym for -subject_hash&quot;},
+    {&quot;subject&quot;, OPT_SUBJECT, '-', &quot;Print subject DN&quot;},
+    {&quot;issuer&quot;, OPT_ISSUER, '-', &quot;Print issuer DN&quot;},
+    {&quot;email&quot;, OPT_EMAIL, '-', &quot;Print email address(es)&quot;},
+    {&quot;startdate&quot;, OPT_STARTDATE, '-', &quot;Set notBefore field&quot;},
+    {&quot;enddate&quot;, OPT_ENDDATE, '-', &quot;Set notAfter field&quot;},
+    {&quot;purpose&quot;, OPT_PURPOSE, '-', &quot;Print out certificate purposes&quot;},
+    {&quot;dates&quot;, OPT_DATES, '-', &quot;Both Before and After dates&quot;},
+    {&quot;modulus&quot;, OPT_MODULUS, '-', &quot;Print the RSA key modulus&quot;},
+    {&quot;pubkey&quot;, OPT_PUBKEY, '-', &quot;Output the public key&quot;},
+    {&quot;fingerprint&quot;, OPT_FINGERPRINT, '-',
+     &quot;Print the certificate fingerprint&quot;},
+    {&quot;alias&quot;, OPT_ALIAS, '-', &quot;Output certificate alias&quot;},
+    {&quot;noout&quot;, OPT_NOOUT, '-', &quot;No output, just status&quot;},
+    {&quot;nocert&quot;, OPT_NOCERT, '-', &quot;No certificate output&quot;},
+    {&quot;ocspid&quot;, OPT_OCSPID, '-',
+     &quot;Print OCSP hash values for the subject name and public key&quot;},
+    {&quot;ocsp_uri&quot;, OPT_OCSP_URI, '-', &quot;Print OCSP Responder URL(s)&quot;},
+    {&quot;trustout&quot;, OPT_TRUSTOUT, '-', &quot;Output a trusted certificate&quot;},
+    {&quot;clrtrust&quot;, OPT_CLRTRUST, '-', &quot;Clear all trusted purposes&quot;},
+    {&quot;clrext&quot;, OPT_CLREXT, '-', &quot;Clear all rejected purposes&quot;},
+    {&quot;addtrust&quot;, OPT_ADDTRUST, 's', &quot;Trust certificate for a given purpose&quot;},
+    {&quot;addreject&quot;, OPT_ADDREJECT, 's',
+     &quot;Reject certificate for a given purpose&quot;},
+    {&quot;setalias&quot;, OPT_SETALIAS, 's', &quot;Set certificate alias&quot;},
+    {&quot;days&quot;, OPT_DAYS, 'n',
+     &quot;How long till expiry of a signed certificate - def 30 days&quot;},
+    {&quot;checkend&quot;, OPT_CHECKEND, 'p',
+     &quot;Check whether the cert expires in the next arg seconds&quot;},
+    {OPT_MORE_STR, 1, 1, &quot;Exit 1 if so, 0 if not&quot;},
+    {&quot;signkey&quot;, OPT_SIGNKEY, '&lt;', &quot;Self sign cert with arg&quot;},
+    {&quot;x509toreq&quot;, OPT_X509TOREQ, '-',
+     &quot;Output a certification request object&quot;},
+    {&quot;req&quot;, OPT_REQ, '-', &quot;Input is a certificate request, sign and output&quot;},
+    {&quot;CA&quot;, OPT_CA, '&lt;', &quot;Set the CA certificate, must be PEM format&quot;},
+    {&quot;CAkey&quot;, OPT_CAKEY, '&lt;',
+     &quot;The CA key, must be PEM format; if not in CAfile&quot;},
+    {&quot;CAcreateserial&quot;, OPT_CACREATESERIAL, '-',
+     &quot;Create serial number file if it does not exist&quot;},
+    {&quot;CAserial&quot;, OPT_CASERIAL, '&lt;', &quot;Serial file&quot;},
+    {&quot;set_serial&quot;, OPT_SET_SERIAL, 's', &quot;Serial number to use&quot;},
+    {&quot;text&quot;, OPT_TEXT, '-', &quot;Print the certificate in text form&quot;},
+    {&quot;C&quot;, OPT_C, '-', &quot;Print out C code forms&quot;},
+    {&quot;extfile&quot;, OPT_EXTFILE, '&lt;', &quot;File with X509V3 extensions to add&quot;},
+    {&quot;extensions&quot;, OPT_EXTENSIONS, 's', &quot;Section from config file to use&quot;},
+    {&quot;nameopt&quot;, OPT_NAMEOPT, 's', &quot;Various certificate name options&quot;},
+    {&quot;certopt&quot;, OPT_CERTOPT, 's', &quot;Various certificate text options&quot;},
+    {&quot;checkhost&quot;, OPT_CHECKHOST, 's', &quot;Check certificate matches host&quot;},
+    {&quot;checkemail&quot;, OPT_CHECKEMAIL, 's', &quot;Check certificate matches email&quot;},
+    {&quot;checkip&quot;, OPT_CHECKIP, 's', &quot;Check certificate matches ipaddr&quot;},
+    {&quot;CAform&quot;, OPT_CAFORM, 'F', &quot;CA format - default PEM&quot;},
+    {&quot;CAkeyform&quot;, OPT_CAKEYFORM, 'F', &quot;CA key format - default PEM&quot;},
+    {&quot;sigopt&quot;, OPT_SIGOPT, 's'},
+    {&quot;force_pubkey&quot;, OPT_FORCE_PUBKEY, '&lt;'},
+    {&quot;next_serial&quot;, OPT_NEXT_SERIAL, '-'},
+    {&quot;clrreject&quot;, OPT_CLRREJECT, '-'},
+    {&quot;badsig&quot;, OPT_BADSIG, '-'},
+    {&quot;&quot;, OPT_MD, '-', &quot;Any supported digest&quot;},
+#ifndef OPENSSL_NO_ENGINE
+    {&quot;engine&quot;, OPT_ENGINE, 's', &quot;Use engine, possibly a hardware device&quot;},
+#endif
+#ifdef OPENSSL_SSL_DEBUG_BROKEN_PROTOCOL
+    {&quot;force_version&quot;, OPT_FORCE_VERSION, 'p'},
+#endif
+    {NULL}
+};
 
-int MAIN(int argc, char **argv)
+int x509_main(int argc, char **argv)
 {
-    ENGINE *e = NULL;
-    int ret = 1;
-    X509_REQ *req = NULL;
-    X509 *x = NULL, *xca = NULL;
-    ASN1_OBJECT *objtmp;
-    STACK_OF(OPENSSL_STRING) *sigopts = NULL;
-    EVP_PKEY *Upkey = NULL, *CApkey = NULL, *fkey = NULL;
     ASN1_INTEGER *sno = NULL;
-    int i, num, badops = 0, badsig = 0;
+    ASN1_OBJECT *objtmp;
     BIO *out = NULL;
-    BIO *STDout = NULL;
+    CONF *extconf = NULL;
+    EVP_PKEY *Upkey = NULL, *CApkey = NULL, *fkey = NULL;
     STACK_OF(ASN1_OBJECT) *trust = NULL, *reject = NULL;
-    int informat, outformat, keyformat, CAformat, CAkeyformat;
+    STACK_OF(OPENSSL_STRING) *sigopts = NULL;
+    X509 *x = NULL, *xca = NULL;
+    X509_REQ *req = NULL, *rq = NULL;
+    X509_STORE *ctx = NULL;
+    const EVP_MD *digest = NULL;
+    char *CAkeyfile = NULL, *CAserial = NULL, *fkeyfile = NULL, *alias = NULL;
+    char *checkhost = NULL, *checkemail = NULL, *checkip = NULL;
+    char *extsect = NULL, *extfile = NULL, *passin = NULL, *passinarg = NULL;
     char *infile = NULL, *outfile = NULL, *keyfile = NULL, *CAfile = NULL;
-    char *CAkeyfile = NULL, *CAserial = NULL;
-    char *fkeyfile = NULL;
-    char *alias = NULL;
+    char buf[256];
+    char *engine = NULL, *prog;
+    int C = 0, x509req = 0, days = DEF_DAYS, modulus = 0, pubkey = 0, pprint =
+        0;
+    int CAformat = FORMAT_PEM, CAkeyformat = FORMAT_PEM;
+    int fingerprint = 0, reqfile = 0, need_rand = 0, checkend =
+        0, checkoffset = 0;
+    int informat = FORMAT_PEM, outformat = FORMAT_PEM, keyformat = FORMAT_PEM;
+    int next_serial = 0, subject_hash = 0, issuer_hash = 0, ocspid = 0;
+    int noout = 0, sign_flag = 0, CA_flag = 0, CA_createserial = 0, email = 0;
+    int ocsp_uri = 0, trustout = 0, clrtrust = 0, clrreject = 0, aliasout = 0;
+    int ret = 1, i, num = 0, badsig = 0, clrext = 0, nocert = 0;
     int text = 0, serial = 0, subject = 0, issuer = 0, startdate =
         0, enddate = 0;
-    int next_serial = 0;
-    int subject_hash = 0, issuer_hash = 0, ocspid = 0;
-#ifndef OPENSSL_NO_MD5
-    int subject_hash_old = 0, issuer_hash_old = 0;
-#endif
-    int noout = 0, sign_flag = 0, CA_flag = 0, CA_createserial = 0, email = 0;
-    int ocsp_uri = 0;
-    int trustout = 0, clrtrust = 0, clrreject = 0, aliasout = 0, clrext = 0;
-    int C = 0;
-    int x509req = 0, days = DEF_DAYS, modulus = 0, pubkey = 0;
-    int pprint = 0;
-    const char **pp;
-    X509_STORE *ctx = NULL;
-    X509_REQ *rq = NULL;
-    int fingerprint = 0;
-    char buf[256];
-    const EVP_MD *md_alg, *digest = NULL;
-    CONF *extconf = NULL;
-    char *extsect = NULL, *extfile = NULL, *passin = NULL, *passargin = NULL;
-    int need_rand = 0;
-    int checkend = 0, checkoffset = 0;
     unsigned long nmflag = 0, certflag = 0;
-    char *checkhost = NULL;
-    char *checkemail = NULL;
-    char *checkip = NULL;
+    OPTION_CHOICE o;
 #ifndef OPENSSL_NO_ENGINE
-    char *engine = NULL;
+    ENGINE *e = NULL;
 #endif
-
-    reqfile = 0;
-
-    apps_startup();
-
-    if (bio_err == NULL)
-        bio_err = BIO_new_fp(stderr, BIO_NOCLOSE);
-
-    if (!load_config(bio_err, NULL))
-        goto end;
-    STDout = BIO_new_fp(stdout, BIO_NOCLOSE);
-#ifdef OPENSSL_SYS_VMS
-    {
-        BIO *tmpbio = BIO_new(BIO_f_linebuffer());
-        STDout = BIO_push(tmpbio, STDout);
-    }
+#ifndef OPENSSL_NO_MD5
+    int subject_hash_old = 0, issuer_hash_old = 0;
 #endif
 
-    informat = FORMAT_PEM;
-    outformat = FORMAT_PEM;
-    keyformat = FORMAT_PEM;
-    CAformat = FORMAT_PEM;
-    CAkeyformat = FORMAT_PEM;
-
     ctx = X509_STORE_new();
     if (ctx == NULL)
         goto end;
     X509_STORE_set_verify_cb(ctx, callb);
 
-    argc--;
-    argv++;
-    num = 0;
-    while (argc &gt;= 1) {
-        if (strcmp(*argv, &quot;-inform&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            informat = str2fmt(*(++argv));
-        } else if (strcmp(*argv, &quot;-outform&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            outformat = str2fmt(*(++argv));
-        } else if (strcmp(*argv, &quot;-keyform&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            keyformat = str2fmt(*(++argv));
-        } else if (strcmp(*argv, &quot;-req&quot;) == 0) {
-            reqfile = 1;
-            need_rand = 1;
-        } else if (strcmp(*argv, &quot;-CAform&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            CAformat = str2fmt(*(++argv));
-        } else if (strcmp(*argv, &quot;-CAkeyform&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            CAkeyformat = str2fmt(*(++argv));
-        } else if (strcmp(*argv, &quot;-sigopt&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
+    prog = opt_init(argc, argv, x509_options);
+    while ((o = opt_next()) != OPT_EOF) {
+        switch (o) {
+        case OPT_EOF:
+        case OPT_ERR:
+ opthelp:
+            BIO_printf(bio_err, &quot;%s: Use -help for summary.\n&quot;, prog);
+            goto end;
+        case OPT_HELP:
+            opt_help(x509_options);
+            ret = 0;
+            goto end;
+        case OPT_INFORM:
+            if (!opt_format(opt_arg(), OPT_FMT_ANY, &amp;informat))
+                goto opthelp;
+            break;
+        case OPT_IN:
+            infile = opt_arg();
+            break;
+        case OPT_OUTFORM:
+            if (!opt_format(opt_arg(), OPT_FMT_ANY, &amp;outformat))
+                goto opthelp;
+            break;
+        case OPT_KEYFORM:
+            if (!opt_format(opt_arg(), OPT_FMT_PEMDER, &amp;keyformat))
+                goto opthelp;
+            break;
+        case OPT_CAFORM:
+            if (!opt_format(opt_arg(), OPT_FMT_PEMDER, &amp;CAformat))
+                goto opthelp;
+            break;
+        case OPT_CAKEYFORM:
+            if (!opt_format(opt_arg(), OPT_FMT_PEMDER, &amp;CAkeyformat))
+                goto opthelp;
+            break;
+        case OPT_OUT:
+            outfile = opt_arg();
+            break;
+        case OPT_REQ:
+            reqfile = need_rand = 1;
+            break;
+
+        case OPT_SIGOPT:
             if (!sigopts)
                 sigopts = sk_OPENSSL_STRING_new_null();
-            if (!sigopts || !sk_OPENSSL_STRING_push(sigopts, *(++argv)))
-                goto bad;
-        }
+            if (!sigopts || !sk_OPENSSL_STRING_push(sigopts, opt_arg()))
+                goto opthelp;
+            break;
 #ifdef OPENSSL_SSL_DEBUG_BROKEN_PROTOCOL
-        else if (strcmp(*argv, &quot;-force_version&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            force_version = atoi(*(++argv)) - 1;
-        }
+        case OPT_FORCE_VERSION:
+            force_version = atoi(opt_arg()) - 1;
+            break;
 #endif
-        else if (strcmp(*argv, &quot;-days&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            days = atoi(*(++argv));
-            if (days == 0) {
-                BIO_printf(bio_err, &quot;bad number of days\n&quot;);
-                goto bad;
-            }
-        } else if (strcmp(*argv, &quot;-passin&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            passargin = *(++argv);
-        } else if (strcmp(*argv, &quot;-extfile&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            extfile = *(++argv);
-        } else if (strcmp(*argv, &quot;-extensions&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            extsect = *(++argv);
-        } else if (strcmp(*argv, &quot;-in&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            infile = *(++argv);
-        } else if (strcmp(*argv, &quot;-out&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            outfile = *(++argv);
-        } else if (strcmp(*argv, &quot;-signkey&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            keyfile = *(++argv);
+        case OPT_DAYS:
+            days = atoi(opt_arg());
+            break;
+        case OPT_PASSIN:
+            passinarg = opt_arg();
+            break;
+        case OPT_EXTFILE:
+            extfile = opt_arg();
+            break;
+        case OPT_EXTENSIONS:
+            extsect = opt_arg();
+            break;
+        case OPT_SIGNKEY:
+            keyfile = opt_arg();
             sign_flag = ++num;
             need_rand = 1;
-        } else if (strcmp(*argv, &quot;-CA&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            CAfile = *(++argv);
+            break;
+        case OPT_CA:
+            CAfile = opt_arg();
             CA_flag = ++num;
             need_rand = 1;
-        } else if (strcmp(*argv, &quot;-CAkey&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            CAkeyfile = *(++argv);
-        } else if (strcmp(*argv, &quot;-CAserial&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            CAserial = *(++argv);
-        } else if (strcmp(*argv, &quot;-set_serial&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            if (!(sno = s2i_ASN1_INTEGER(NULL, *(++argv))))
-                goto bad;
-        } else if (strcmp(*argv, &quot;-force_pubkey&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            fkeyfile = *(++argv);
-        } else if (strcmp(*argv, &quot;-addtrust&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            if (!(objtmp = OBJ_txt2obj(*(++argv), 0))) {
-                BIO_printf(bio_err, &quot;Invalid trust object value %s\n&quot;, *argv);
-                goto bad;
+            break;
+        case OPT_CAKEY:
+            CAkeyfile = opt_arg();
+            break;
+        case OPT_CASERIAL:
+            CAserial = opt_arg();
+            break;
+        case OPT_SET_SERIAL:
+            if ((sno = s2i_ASN1_INTEGER(NULL, opt_arg())) == NULL)
+                goto opthelp;
+            break;
+        case OPT_FORCE_PUBKEY:
+            fkeyfile = opt_arg();
+            break;
+        case OPT_ADDTRUST:
+            if ((objtmp = OBJ_txt2obj(opt_arg(), 0)) == NULL) {
+                BIO_printf(bio_err,
+                           &quot;%s: Invalid trust object value %s\n&quot;,
+                           prog, opt_arg());
+                goto opthelp;
             }
-            if (!trust)
-                trust = sk_ASN1_OBJECT_new_null();
+            if (trust == NULL &amp;&amp; (trust = sk_ASN1_OBJECT_new_null()) == NULL)
+                goto end;
             sk_ASN1_OBJECT_push(trust, objtmp);
             trustout = 1;
-        } else if (strcmp(*argv, &quot;-addreject&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            if (!(objtmp = OBJ_txt2obj(*(++argv), 0))) {
+            break;
+        case OPT_ADDREJECT:
+            if ((objtmp = OBJ_txt2obj(opt_arg(), 0)) == NULL) {
                 BIO_printf(bio_err,
-                           &quot;Invalid reject object value %s\n&quot;, *argv);
-                goto bad;
+                           &quot;%s: Invalid reject object value %s\n&quot;,
+                           prog, opt_arg());
+                goto opthelp;
             }
-            if (!reject)
-                reject = sk_ASN1_OBJECT_new_null();
+            if (reject == NULL
+                &amp;&amp; (reject = sk_ASN1_OBJECT_new_null()) == NULL)
+                goto end;
             sk_ASN1_OBJECT_push(reject, objtmp);
             trustout = 1;
-        } else if (strcmp(*argv, &quot;-setalias&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            alias = *(++argv);
+            break;
+        case OPT_SETALIAS:
+            alias = opt_arg();
             trustout = 1;
-        } else if (strcmp(*argv, &quot;-certopt&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            if (!set_cert_ex(&amp;certflag, *(++argv)))
-                goto bad;
-        } else if (strcmp(*argv, &quot;-nameopt&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            if (!set_name_ex(&amp;nmflag, *(++argv)))
-                goto bad;
-        }
-#ifndef OPENSSL_NO_ENGINE
-        else if (strcmp(*argv, &quot;-engine&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            engine = *(++argv);
-        }
-#endif
-        else if (strcmp(*argv, &quot;-C&quot;) == 0)
+            break;
+        case OPT_CERTOPT:
+            if (!set_cert_ex(&amp;certflag, opt_arg()))
+                goto opthelp;
+            break;
+        case OPT_NAMEOPT:
+            if (!set_name_ex(&amp;nmflag, opt_arg()))
+                goto opthelp;
+            break;
+        case OPT_ENGINE:
+            engine = opt_arg();
+            break;
+        case OPT_C:
             C = ++num;
-        else if (strcmp(*argv, &quot;-email&quot;) == 0)
+            break;
+        case OPT_EMAIL:
             email = ++num;
-        else if (strcmp(*argv, &quot;-ocsp_uri&quot;) == 0)
+            break;
+        case OPT_OCSP_URI:
             ocsp_uri = ++num;
-        else if (strcmp(*argv, &quot;-serial&quot;) == 0)
+            break;
+        case OPT_SERIAL:
             serial = ++num;
-        else if (strcmp(*argv, &quot;-next_serial&quot;) == 0)
+            break;
+        case OPT_NEXT_SERIAL:
             next_serial = ++num;
-        else if (strcmp(*argv, &quot;-modulus&quot;) == 0)
+            break;
+        case OPT_MODULUS:
             modulus = ++num;
-        else if (strcmp(*argv, &quot;-pubkey&quot;) == 0)
+            break;
+        case OPT_PUBKEY:
             pubkey = ++num;
-        else if (strcmp(*argv, &quot;-x509toreq&quot;) == 0)
+            break;
+        case OPT_X509TOREQ:
             x509req = ++num;
-        else if (strcmp(*argv, &quot;-text&quot;) == 0)
+            break;
+        case OPT_TEXT:
             text = ++num;
-        else if (strcmp(*argv, &quot;-hash&quot;) == 0
-                 || strcmp(*argv, &quot;-subject_hash&quot;) == 0)
-            subject_hash = ++num;
-#ifndef OPENSSL_NO_MD5
-        else if (strcmp(*argv, &quot;-subject_hash_old&quot;) == 0)
-            subject_hash_old = ++num;
-#endif
-        else if (strcmp(*argv, &quot;-issuer_hash&quot;) == 0)
-            issuer_hash = ++num;
-#ifndef OPENSSL_NO_MD5
-        else if (strcmp(*argv, &quot;-issuer_hash_old&quot;) == 0)
-            issuer_hash_old = ++num;
-#endif
-        else if (strcmp(*argv, &quot;-subject&quot;) == 0)
+            break;
+        case OPT_SUBJECT:
             subject = ++num;
-        else if (strcmp(*argv, &quot;-issuer&quot;) == 0)
+            break;
+        case OPT_ISSUER:
             issuer = ++num;
-        else if (strcmp(*argv, &quot;-fingerprint&quot;) == 0)
+            break;
+        case OPT_FINGERPRINT:
             fingerprint = ++num;
-        else if (strcmp(*argv, &quot;-dates&quot;) == 0) {
-            startdate = ++num;
-            enddate = ++num;
-        } else if (strcmp(*argv, &quot;-purpose&quot;) == 0)
+            break;
+        case OPT_HASH:
+            subject_hash = ++num;
+            break;
+        case OPT_ISSUER_HASH:
+            issuer_hash = ++num;
+            break;
+        case OPT_PURPOSE:
             pprint = ++num;
-        else if (strcmp(*argv, &quot;-startdate&quot;) == 0)
+            break;
+        case OPT_STARTDATE:
             startdate = ++num;
-        else if (strcmp(*argv, &quot;-enddate&quot;) == 0)
+            break;
+        case OPT_ENDDATE:
             enddate = ++num;
-        else if (strcmp(*argv, &quot;-checkend&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            checkoffset = atoi(*(++argv));
-            checkend = 1;
-        } else if (strcmp(*argv, &quot;-checkhost&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            checkhost = *(++argv);
-        } else if (strcmp(*argv, &quot;-checkemail&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            checkemail = *(++argv);
-        } else if (strcmp(*argv, &quot;-checkip&quot;) == 0) {
-            if (--argc &lt; 1)
-                goto bad;
-            checkip = *(++argv);
-        } else if (strcmp(*argv, &quot;-noout&quot;) == 0)
+            break;
+        case OPT_NOOUT:
             noout = ++num;
-        else if (strcmp(*argv, &quot;-trustout&quot;) == 0)
+            break;
+        case OPT_NOCERT:
+            nocert = 1;
+            break;
+        case OPT_TRUSTOUT:
             trustout = 1;
-        else if (strcmp(*argv, &quot;-clrtrust&quot;) == 0)
+            break;
+        case OPT_CLRTRUST:
             clrtrust = ++num;
-        else if (strcmp(*argv, &quot;-clrreject&quot;) == 0)
+            break;
+        case OPT_CLRREJECT:
             clrreject = ++num;
-        else if (strcmp(*argv, &quot;-alias&quot;) == 0)
+            break;
+        case OPT_ALIAS:
             aliasout = ++num;
-        else if (strcmp(*argv, &quot;-CAcreateserial&quot;) == 0)
+            break;
+        case OPT_CACREATESERIAL:
             CA_createserial = ++num;
-        else if (strcmp(*argv, &quot;-clrext&quot;) == 0)
+            break;
+        case OPT_CLREXT:
             clrext = 1;
-        else if (strcmp(*argv, &quot;-ocspid&quot;) == 0)
+            break;
+        case OPT_OCSPID:
             ocspid = ++num;
-        else if (strcmp(*argv, &quot;-badsig&quot;) == 0)
+            break;
+        case OPT_BADSIG:
             badsig = 1;
-        else if ((md_alg = EVP_get_digestbyname(*argv + 1))) {
-            /* ok */
-            digest = md_alg;
-        } else {
-            BIO_printf(bio_err, &quot;unknown option %s\n&quot;, *argv);
-            badops = 1;
             break;
+#ifndef OPENSSL_NO_MD5
+        case OPT_SUBJECT_HASH_OLD:
+            subject_hash_old = ++num;
+            break;
+        case OPT_ISSUER_HASH_OLD:
+            issuer_hash_old = ++num;
+            break;
+#endif
+        case OPT_DATES:
+            startdate = ++num;
+            enddate = ++num;
+            break;
+        case OPT_CHECKEND:
+            checkoffset = atoi(opt_arg());
+            checkend = 1;
+            break;
+        case OPT_CHECKHOST:
+            checkhost = opt_arg();
+            break;
+        case OPT_CHECKEMAIL:
+            checkemail = opt_arg();
+            break;
+        case OPT_CHECKIP:
+            checkip = opt_arg();
+            break;
+        case OPT_MD:
+            if (!opt_md(opt_unknown(), &amp;digest))
+                goto opthelp;
         }
-        argc--;
-        argv++;
+    }
+    argc = opt_num_rest();
+    argv = opt_rest();
+    if (argc != 0) {
+        BIO_printf(bio_err, &quot;%s: Unknown parameter %s\n&quot;, prog, argv[0]);
+        goto opthelp;
     }
 
-    if (badops) {
- bad:
-        for (pp = x509_usage; (*pp != NULL); pp++)
-            BIO_printf(bio_err, &quot;%s&quot;, *pp);
+    out = bio_open_default(outfile, &quot;w&quot;);
+    if (out == NULL)
         goto end;
-    }
+
 #ifndef OPENSSL_NO_ENGINE
-    e = setup_engine(bio_err, engine, 0);
+    e = setup_engine(engine, 0);
 #endif
 
     if (need_rand)
-        app_RAND_load_file(NULL, bio_err, 0);
-
-    ERR_load_crypto_strings();
+        app_RAND_load_file(NULL, 0);
 
-    if (!app_passwd(bio_err, passargin, NULL, &amp;passin, NULL)) {
+    if (!app_passwd(passinarg, NULL, &amp;passin, NULL)) {
         BIO_printf(bio_err, &quot;Error getting password\n&quot;);
         goto end;
     }
@@ -511,8 +516,7 @@ int MAIN(int argc, char **argv)
     }
 
     if (fkeyfile) {
-        fkey = load_pubkey(bio_err, fkeyfile, keyformat, 0,
-                           NULL, e, &quot;Forced key&quot;);
+        fkey = load_pubkey(fkeyfile, keyformat, 0, NULL, e, &quot;Forced key&quot;);
         if (fkey == NULL)
             goto end;
     }
@@ -564,21 +568,9 @@ int MAIN(int argc, char **argv)
             BIO_printf(bio_err, &quot;We need a private key to sign with\n&quot;);
             goto end;
         }
-        in = BIO_new(BIO_s_file());
-        if (in == NULL) {
-            ERR_print_errors(bio_err);
+        in = bio_open_default(infile, &quot;r&quot;);
+        if (in == NULL)
             goto end;
-        }
-
-        if (infile == NULL)
-            BIO_set_fp(in, stdin, BIO_NOCLOSE | BIO_FP_TEXT);
-        else {
-            if (BIO_read_filename(in, infile) &lt;= 0) {
-                perror(infile);
-                BIO_free(in);
-                goto end;
-            }
-        }
         req = PEM_read_bio_X509_REQ(in, NULL, NULL, NULL);
         BIO_free(in);
 
@@ -646,12 +638,12 @@ int MAIN(int argc, char **argv)
             EVP_PKEY_free(pkey);
         }
     } else
-        x = load_cert(bio_err, infile, informat, NULL, e, &quot;Certificate&quot;);
+        x = load_cert(infile, informat, NULL, e, &quot;Certificate&quot;);
 
     if (x == NULL)
         goto end;
     if (CA_flag) {
-        xca = load_cert(bio_err, CAfile, CAformat, NULL, e, &quot;CA Certificate&quot;);
+        xca = load_cert(CAfile, CAformat, NULL, e, &quot;CA Certificate&quot;);
         if (xca == NULL)
             goto end;
     }
@@ -659,25 +651,6 @@ int MAIN(int argc, char **argv)
     if (!noout || text || next_serial) {
         OBJ_create(&quot;2.99999.3&quot;, &quot;SET.ex3&quot;, &quot;SET x509v3 extension 3&quot;);
 
-        out = BIO_new(BIO_s_file());
-        if (out == NULL) {
-            ERR_print_errors(bio_err);
-            goto end;
-        }
-        if (outfile == NULL) {
-            BIO_set_fp(out, stdout, BIO_NOCLOSE);
-#ifdef OPENSSL_SYS_VMS
-            {
-                BIO *tmpbio = BIO_new(BIO_f_linebuffer());
-                out = BIO_push(tmpbio, out);
-            }
-#endif
-        } else {
-            if (BIO_write_filename(out, outfile) &lt;= 0) {
-                perror(outfile);
-                goto end;
-            }
-        }
     }
 
     if (alias)
@@ -705,15 +678,14 @@ int MAIN(int argc, char **argv)
     if (num) {
         for (i = 1; i &lt;= num; i++) {
             if (issuer == i) {
-                print_name(STDout, &quot;issuer= &quot;,
-                           X509_get_issuer_name(x), nmflag);
+                print_name(out, &quot;issuer= &quot;, X509_get_issuer_name(x), nmflag);
             } else if (subject == i) {
-                print_name(STDout, &quot;subject= &quot;,
+                print_name(out, &quot;subject= &quot;,
                            X509_get_subject_name(x), nmflag);
             } else if (serial == i) {
-                BIO_printf(STDout, &quot;serial=&quot;);
-                i2a_ASN1_INTEGER(STDout, X509_get_serialNumber(x));
-                BIO_printf(STDout, &quot;\n&quot;);
+                BIO_printf(out, &quot;serial=&quot;);
+                i2a_ASN1_INTEGER(out, X509_get_serialNumber(x));
+                BIO_printf(out, &quot;\n&quot;);
             } else if (next_serial == i) {
                 BIGNUM *bnser;
                 ASN1_INTEGER *ser;
@@ -738,39 +710,39 @@ int MAIN(int argc, char **argv)
                 else
                     emlst = X509_get1_ocsp(x);
                 for (j = 0; j &lt; sk_OPENSSL_STRING_num(emlst); j++)
-                    BIO_printf(STDout, &quot;%s\n&quot;,
+                    BIO_printf(out, &quot;%s\n&quot;,
                                sk_OPENSSL_STRING_value(emlst, j));
                 X509_email_free(emlst);
             } else if (aliasout == i) {
                 unsigned char *alstr;
                 alstr = X509_alias_get0(x, NULL);
                 if (alstr)
-                    BIO_printf(STDout, &quot;%s\n&quot;, alstr);
+                    BIO_printf(out, &quot;%s\n&quot;, alstr);
                 else
-                    BIO_puts(STDout, &quot;&lt;No Alias&gt;\n&quot;);
+                    BIO_puts(out, &quot;&lt;No Alias&gt;\n&quot;);
             } else if (subject_hash == i) {
-                BIO_printf(STDout, &quot;%08lx\n&quot;, X509_subject_name_hash(x));
+                BIO_printf(out, &quot;%08lx\n&quot;, X509_subject_name_hash(x));
             }
 #ifndef OPENSSL_NO_MD5
             else if (subject_hash_old == i) {
-                BIO_printf(STDout, &quot;%08lx\n&quot;, X509_subject_name_hash_old(x));
+                BIO_printf(out, &quot;%08lx\n&quot;, X509_subject_name_hash_old(x));
             }
 #endif
             else if (issuer_hash == i) {
-                BIO_printf(STDout, &quot;%08lx\n&quot;, X509_issuer_name_hash(x));
+                BIO_printf(out, &quot;%08lx\n&quot;, X509_issuer_name_hash(x));
             }
 #ifndef OPENSSL_NO_MD5
             else if (issuer_hash_old == i) {
-                BIO_printf(STDout, &quot;%08lx\n&quot;, X509_issuer_name_hash_old(x));
+                BIO_printf(out, &quot;%08lx\n&quot;, X509_issuer_name_hash_old(x));
             }
 #endif
             else if (pprint == i) {
                 X509_PURPOSE *ptmp;
                 int j;
-                BIO_printf(STDout, &quot;Certificate purposes:\n&quot;);
+                BIO_printf(out, &quot;Certificate purposes:\n&quot;);
                 for (j = 0; j &lt; X509_PURPOSE_get_count(); j++) {
                     ptmp = X509_PURPOSE_get0(j);
-                    purpose_print(STDout, x, ptmp);
+                    purpose_print(out, x, ptmp);
                 }
             } else if (modulus == i) {
                 EVP_PKEY *pkey;
@@ -781,19 +753,19 @@ int MAIN(int argc, char **argv)
                     ERR_print_errors(bio_err);
                     goto end;
                 }
-                BIO_printf(STDout, &quot;Modulus=&quot;);
+                BIO_printf(out, &quot;Modulus=&quot;);
 #ifndef OPENSSL_NO_RSA
                 if (pkey-&gt;type == EVP_PKEY_RSA)
-                    BN_print(STDout, pkey-&gt;pkey.rsa-&gt;n);
+                    BN_print(out, pkey-&gt;pkey.rsa-&gt;n);
                 else
 #endif
 #ifndef OPENSSL_NO_DSA
                 if (pkey-&gt;type == EVP_PKEY_DSA)
-                    BN_print(STDout, pkey-&gt;pkey.dsa-&gt;pub_key);
+                    BN_print(out, pkey-&gt;pkey.dsa-&gt;pub_key);
                 else
 #endif
-                    BIO_printf(STDout, &quot;Wrong Algorithm type&quot;);
-                BIO_printf(STDout, &quot;\n&quot;);
+                    BIO_printf(out, &quot;Wrong Algorithm type&quot;);
+                BIO_printf(out, &quot;\n&quot;);
                 EVP_PKEY_free(pkey);
             } else if (pubkey == i) {
                 EVP_PKEY *pkey;
@@ -804,77 +776,48 @@ int MAIN(int argc, char **argv)
                     ERR_print_errors(bio_err);
                     goto end;
                 }
-                PEM_write_bio_PUBKEY(STDout, pkey);
+                PEM_write_bio_PUBKEY(out, pkey);
                 EVP_PKEY_free(pkey);
             } else if (C == i) {
                 unsigned char *d;
                 char *m;
-                int y, z;
+                int len;
 
                 X509_NAME_oneline(X509_get_subject_name(x), buf, sizeof buf);
-                BIO_printf(STDout, &quot;/* subject:%s */\n&quot;, buf);
-                m = X509_NAME_oneline(X509_get_issuer_name(x), buf,
-                                      sizeof buf);
-                BIO_printf(STDout, &quot;/* issuer :%s */\n&quot;, buf);
+                BIO_printf(out, &quot;/*\n&quot;
+                                &quot; * Subject: %s\n&quot;, buf);
+
+                m = X509_NAME_oneline(X509_get_issuer_name(x), buf, sizeof buf);
+                BIO_printf(out, &quot; * Issuer:  %s\n&quot;
+                                &quot; */\n&quot;, buf);
 
-                z = i2d_X509(x, NULL);
-                m = OPENSSL_malloc(z);
+                len = i2d_X509(x, NULL);
+                m = OPENSSL_malloc(len);
                 if (!m) {
                     BIO_printf(bio_err, &quot;Out of memory\n&quot;);
-                    ERR_print_errors(bio_err);
                     goto end;
                 }
 
                 d = (unsigned char *)m;
-                z = i2d_X509_NAME(X509_get_subject_name(x), &amp;d);
-                BIO_printf(STDout, &quot;unsigned char XXX_subject_name[%d]={\n&quot;,
-                           z);
-                d = (unsigned char *)m;
-                for (y = 0; y &lt; z; y++) {
-                    BIO_printf(STDout, &quot;0x%02X,&quot;, d[y]);
-                    if ((y &amp; 0x0f) == 0x0f)
-                        BIO_printf(STDout, &quot;\n&quot;);
-                }
-                if (y % 16 != 0)
-                    BIO_printf(STDout, &quot;\n&quot;);
-                BIO_printf(STDout, &quot;};\n&quot;);
-
-                z = i2d_X509_PUBKEY(X509_get_X509_PUBKEY(x), &amp;d);
-                BIO_printf(STDout, &quot;unsigned char XXX_public_key[%d]={\n&quot;, z);
+                len = i2d_X509_NAME(X509_get_subject_name(x), &amp;d);
+                print_array(out, &quot;the_subject_name&quot;, len, (unsigned char *)m);
                 d = (unsigned char *)m;
-                for (y = 0; y &lt; z; y++) {
-                    BIO_printf(STDout, &quot;0x%02X,&quot;, d[y]);
-                    if ((y &amp; 0x0f) == 0x0f)
-                        BIO_printf(STDout, &quot;\n&quot;);
-                }
-                if (y % 16 != 0)
-                    BIO_printf(STDout, &quot;\n&quot;);
-                BIO_printf(STDout, &quot;};\n&quot;);
-
-                z = i2d_X509(x, &amp;d);
-                BIO_printf(STDout, &quot;unsigned char XXX_certificate[%d]={\n&quot;,
-                           z);
+                len = i2d_X509_PUBKEY(X509_get_X509_PUBKEY(x), &amp;d);
+                print_array(out, &quot;the_public_key&quot;, len, (unsigned char *)m);
                 d = (unsigned char *)m;
-                for (y = 0; y &lt; z; y++) {
-                    BIO_printf(STDout, &quot;0x%02X,&quot;, d[y]);
-                    if ((y &amp; 0x0f) == 0x0f)
-                        BIO_printf(STDout, &quot;\n&quot;);
-                }
-                if (y % 16 != 0)
-                    BIO_printf(STDout, &quot;\n&quot;);
-                BIO_printf(STDout, &quot;};\n&quot;);
-
+                len = i2d_X509(x, &amp;d);
+                print_array(out, &quot;the_certificate&quot;, len, (unsigned char *)m);
                 OPENSSL_free(m);
             } else if (text == i) {
-                X509_print_ex(STDout, x, nmflag, certflag);
+                X509_print_ex(out, x, nmflag, certflag);
             } else if (startdate == i) {
-                BIO_puts(STDout, &quot;notBefore=&quot;);
-                ASN1_TIME_print(STDout, X509_get_notBefore(x));
-                BIO_puts(STDout, &quot;\n&quot;);
+                BIO_puts(out, &quot;notBefore=&quot;);
+                ASN1_TIME_print(out, X509_get_notBefore(x));
+                BIO_puts(out, &quot;\n&quot;);
             } else if (enddate == i) {
-                BIO_puts(STDout, &quot;notAfter=&quot;);
-                ASN1_TIME_print(STDout, X509_get_notAfter(x));
-                BIO_puts(STDout, &quot;\n&quot;);
+                BIO_puts(out, &quot;notAfter=&quot;);
+                ASN1_TIME_print(out, X509_get_notAfter(x));
+                BIO_puts(out, &quot;\n&quot;);
             } else if (fingerprint == i) {
                 int j;
                 unsigned int n;
@@ -888,10 +831,10 @@ int MAIN(int argc, char **argv)
                     BIO_printf(bio_err, &quot;out of memory\n&quot;);
                     goto end;
                 }
-                BIO_printf(STDout, &quot;%s Fingerprint=&quot;,
+                BIO_printf(out, &quot;%s Fingerprint=&quot;,
                            OBJ_nid2sn(EVP_MD_type(fdig)));
                 for (j = 0; j &lt; (int)n; j++) {
-                    BIO_printf(STDout, &quot;%02X%c&quot;, md[j], (j + 1 == (int)n)
+                    BIO_printf(out, &quot;%02X%c&quot;, md[j], (j + 1 == (int)n)
                                ? '\n' : ':');
                 }
             }
@@ -900,8 +843,7 @@ int MAIN(int argc, char **argv)
             else if ((sign_flag == i) &amp;&amp; (x509req == 0)) {
                 BIO_printf(bio_err, &quot;Getting Private key\n&quot;);
                 if (Upkey == NULL) {
-                    Upkey = load_key(bio_err,
-                                     keyfile, keyformat, 0,
+                    Upkey = load_key(keyfile, keyformat, 0,
                                      passin, e, &quot;Private key&quot;);
                     if (Upkey == NULL)
                         goto end;
@@ -913,8 +855,7 @@ int MAIN(int argc, char **argv)
             } else if (CA_flag == i) {
                 BIO_printf(bio_err, &quot;Getting CA Private Key\n&quot;);
                 if (CAkeyfile != NULL) {
-                    CApkey = load_key(bio_err,
-                                      CAkeyfile, CAkeyformat,
+                    CApkey = load_key(CAkeyfile, CAkeyformat,
                                       0, passin, e, &quot;CA Private Key&quot;);
                     if (CApkey == NULL)
                         goto end;
@@ -924,7 +865,7 @@ int MAIN(int argc, char **argv)
                 if (!x509_certify(ctx, CAfile, digest, x, xca,
                                   CApkey, sigopts,
                                   CAserial, CA_createserial, days, clrext,
-                                  extconf, extsect, sno))
+                                  extconf, extsect, sno, reqfile))
                     goto end;
             } else if (x509req == i) {
                 EVP_PKEY *pk;
@@ -934,8 +875,7 @@ int MAIN(int argc, char **argv)
                     BIO_printf(bio_err, &quot;no request key file specified\n&quot;);
                     goto end;
                 } else {
-                    pk = load_key(bio_err,
-                                  keyfile, keyformat, 0,
+                    pk = load_key(keyfile, keyformat, 0,
                                   passin, e, &quot;request key&quot;);
                     if (pk == NULL)
                         goto end;
@@ -973,9 +913,9 @@ int MAIN(int argc, char **argv)
         goto end;
     }
 
-    print_cert_checks(STDout, x, checkhost, checkemail, checkip);
+    print_cert_checks(out, x, checkhost, checkemail, checkip);
 
-    if (noout) {
+    if (noout || nocert) {
         ret = 0;
         goto end;
     }
@@ -1012,11 +952,10 @@ int MAIN(int argc, char **argv)
     ret = 0;
  end:
     if (need_rand)
-        app_RAND_write_file(NULL, bio_err);
+        app_RAND_write_file(NULL);
     OBJ_cleanup();
     NCONF_free(extconf);
     BIO_free_all(out);
-    BIO_free_all(STDout);
     X509_STORE_free(ctx);
     X509_REQ_free(req);
     X509_free(x);
@@ -1032,8 +971,7 @@ int MAIN(int argc, char **argv)
     sk_ASN1_OBJECT_pop_free(reject, ASN1_OBJECT_free);
     if (passin)
         OPENSSL_free(passin);
-    apps_shutdown();
-    OPENSSL_EXIT(ret);
+    return (ret);
 }
 
 static ASN1_INTEGER *x509_load_serial(char *CAfile, char *serialfile,
@@ -1087,7 +1025,7 @@ static int x509_certify(X509_STORE *ctx, char *CAfile, const EVP_MD *digest,
                         STACK_OF(OPENSSL_STRING) *sigopts,
                         char *serialfile, int create,
                         int days, int clrext, CONF *conf, char *section,
-                        ASN1_INTEGER *sno)
+                        ASN1_INTEGER *sno, int reqfile)
 {
     int ret = 0;
     ASN1_INTEGER *bs = NULL;
@@ -1154,7 +1092,7 @@ static int x509_certify(X509_STORE *ctx, char *CAfile, const EVP_MD *digest,
             goto end;
     }
 
-    if (!do_X509_sign(bio_err, x, pkey, digest, sigopts))
+    if (!do_X509_sign(x, pkey, digest, sigopts))
         goto end;
     ret = 1;
  end:
@@ -1204,22 +1142,11 @@ static int sign(X509 *x, EVP_PKEY *pkey, int days, int clrext,
                 const EVP_MD *digest, CONF *conf, char *section)
 {
 
-    EVP_PKEY *pktmp;
-
-    pktmp = X509_get_pubkey(x);
-    EVP_PKEY_copy_parameters(pktmp, pkey);
-    EVP_PKEY_save_parameters(pktmp, 1);
-    EVP_PKEY_free(pktmp);
-
     if (!X509_set_issuer_name(x, X509_get_subject_name(x)))
         goto err;
     if (X509_gmtime_adj(X509_get_notBefore(x), 0) == NULL)
         goto err;
 
-    /* Lets just make it 12:00am GMT, Jan 1 1970 */
-    /* memcpy(x-&gt;cert_info-&gt;validity-&gt;notBefore,&quot;700101120000Z&quot;,13); */
-    /* 28 days to be certified */
-
     if (X509_gmtime_adj(X509_get_notAfter(x), (long)60 * 60 * 24 * days) ==
         NULL)
         goto err;
diff --git a/crypto/evp/c_allc.c b/crypto/evp/c_allc.c
index 7ae36d7..0a889ef 100644
--- a/crypto/evp/c_allc.c
+++ b/crypto/evp/c_allc.c
@@ -94,6 +94,7 @@ void OpenSSL_add_all_ciphers(void)
     EVP_add_cipher(EVP_des_ede());
     EVP_add_cipher(EVP_des_ede3());
     EVP_add_cipher(EVP_des_ede3_wrap());
+    EVP_add_cipher_alias(SN_id_smime_alg_CMS3DESwrap, &quot;des3-wrap&quot;);
 #endif
 
 #ifndef OPENSSL_NO_RC4
@@ -131,6 +132,9 @@ void OpenSSL_add_all_ciphers(void)
     EVP_add_cipher(EVP_rc2_64_cbc());
     EVP_add_cipher_alias(SN_rc2_cbc, &quot;RC2&quot;);
     EVP_add_cipher_alias(SN_rc2_cbc, &quot;rc2&quot;);
+    EVP_add_cipher_alias(SN_rc2_cbc, &quot;rc2-128&quot;);
+    EVP_add_cipher_alias(SN_rc2_64_cbc, &quot;rc2-64&quot;);
+    EVP_add_cipher_alias(SN_rc2_40_cbc, &quot;rc2-40&quot;);
 #endif
 
 #ifndef OPENSSL_NO_BF
@@ -178,6 +182,7 @@ void OpenSSL_add_all_ciphers(void)
     EVP_add_cipher(EVP_aes_128_xts());
     EVP_add_cipher(EVP_aes_128_ccm());
     EVP_add_cipher(EVP_aes_128_wrap());
+    EVP_add_cipher_alias(SN_id_aes128_wrap, &quot;aes128-wrap&quot;);
     EVP_add_cipher(EVP_aes_128_wrap_pad());
     EVP_add_cipher_alias(SN_aes_128_cbc, &quot;AES128&quot;);
     EVP_add_cipher_alias(SN_aes_128_cbc, &quot;aes128&quot;);
@@ -194,6 +199,7 @@ void OpenSSL_add_all_ciphers(void)
 # endif
     EVP_add_cipher(EVP_aes_192_ccm());
     EVP_add_cipher(EVP_aes_192_wrap());
+    EVP_add_cipher_alias(SN_id_aes192_wrap, &quot;aes192-wrap&quot;);
     EVP_add_cipher(EVP_aes_192_wrap_pad());
     EVP_add_cipher_alias(SN_aes_192_cbc, &quot;AES192&quot;);
     EVP_add_cipher_alias(SN_aes_192_cbc, &quot;aes192&quot;);
@@ -211,6 +217,7 @@ void OpenSSL_add_all_ciphers(void)
     EVP_add_cipher(EVP_aes_256_xts());
     EVP_add_cipher(EVP_aes_256_ccm());
     EVP_add_cipher(EVP_aes_256_wrap());
+    EVP_add_cipher_alias(SN_id_aes256_wrap, &quot;aes256-wrap&quot;);
     EVP_add_cipher(EVP_aes_256_wrap_pad());
     EVP_add_cipher_alias(SN_aes_256_cbc, &quot;AES256&quot;);
     EVP_add_cipher_alias(SN_aes_256_cbc, &quot;aes256&quot;);
diff --git a/ssl/ssl_conf.c b/ssl/ssl_conf.c
index 43821f6..97b4fb9 100644
--- a/ssl/ssl_conf.c
+++ b/ssl/ssl_conf.c
@@ -192,6 +192,7 @@ static int ssl_set_option_list(const char *elem, int len, void *usr)
 /* Single command line switches with no argument e.g. -no_ssl3 */
 static int ctrl_str_option(SSL_CONF_CTX *cctx, const char *cmd)
 {
+    /* See apps/apps.h if you change this table. */
     static const ssl_flag_tbl ssl_option_single[] = {
         SSL_FLAG_TBL(&quot;no_ssl3&quot;, SSL_OP_NO_SSLv3),
         SSL_FLAG_TBL(&quot;no_tls1&quot;, SSL_OP_NO_TLSv1),
@@ -457,6 +458,7 @@ typedef struct {
 #define SSL_CONF_CMD_STRING(name, cmdopt) \
         SSL_CONF_CMD(name, cmdopt, SSL_CONF_TYPE_STRING)
 
+/* See apps/apps.h if you change this table. */
 static const ssl_conf_cmd_tbl ssl_conf_cmds[] = {
     SSL_CONF_CMD_STRING(SignatureAlgorithms, &quot;sigalgs&quot;),
     SSL_CONF_CMD_STRING(ClientSignatureAlgorithms, &quot;client_sigalgs&quot;),
diff --git a/util/indent.pro b/util/indent.pro
index e871431..c2427a3 100644
--- a/util/indent.pro
+++ b/util/indent.pro
@@ -749,3 +749,5 @@
 -T ssl_trace_tbl
 -T _stdcall
 -T tls12_lookup
+-T OPTIONS
+-T OPT_PAIR
diff --git a/util/ssleay.num b/util/ssleay.num
index 7ea4a8a..f5f85ab 100755
--- a/util/ssleay.num
+++ b/util/ssleay.num
@@ -393,3 +393,5 @@ SSL_set_wbio                            427	EXIST::FUNCTION:
 SSL_SESSION_get0_ticket                 428	EXIST::FUNCTION:
 SSL_SESSION_get_ticket_lifetime_hint    429	EXIST::FUNCTION:
 SSL_set_rbio                            430	EXIST::FUNCTION:
+SSL_CIPHER_get_digest_nid               431	EXIST::FUNCTION:
+SSL_CIPHER_get_cipher_nid               432	EXIST::FUNCTION:
</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="000942.html">[openssl-commits] [openssl]  master update
</A></li>
	<LI>Next message: <A HREF="000944.html">[openssl-commits] [openssl]  master update
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#943">[ date ]</a>
              <a href="thread.html#943">[ thread ]</a>
              <a href="subject.html#943">[ subject ]</a>
              <a href="author.html#943">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="../../../mailman/listinfo/openssl-commits.html">More information about the openssl-commits
mailing list</a><br>
</body></html>
