<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [openssl]  master update
   </TITLE>
   <LINK REL="Index" HREF="https://mta.openssl.org/pipermail/openssl-commits/2020-December/index.html" >
   <LINK REL="made" HREF="mailto:openssl-commits%40openssl.org?Subject=Re%3A%20%5Bopenssl%5D%20%20master%20update&In-Reply-To=%3C1606943476.124718.11922.nullmailer%40dev.openssl.org%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="032486.html">
   <LINK REL="Next"  HREF="032489.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[openssl]  master update</H1>
    <B>Richard Levitte</B> 
    <A HREF="mailto:openssl-commits%40openssl.org?Subject=Re%3A%20%5Bopenssl%5D%20%20master%20update&In-Reply-To=%3C1606943476.124718.11922.nullmailer%40dev.openssl.org%3E"
       TITLE="[openssl]  master update">levitte at openssl.org
       </A><BR>
    <I>Wed Dec  2 21:11:16 UTC 2020</I>
    <P><UL>
        <LI>Previous message: <A HREF="032486.html">[openssl]  master update
</A></li>
        <LI>Next message: <A HREF="032489.html">[openssl]  master update
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#32488">[ date ]</a>
              <a href="thread.html#32488">[ thread ]</a>
              <a href="subject.html#32488">[ subject ]</a>
              <a href="author.html#32488">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>The branch master has been updated
       via  0a3b330cf09dd3746f4f9c5bb82d9bbcfff809c1 (commit)
       via  f91d003a0ef0c748a11ccdb19c7661a3f2df9ab0 (commit)
       via  0b27381fd544beca44df905991923a7fa374d80a (commit)
      from  4be35545aea9f76e3704fe88bb8f3fc135ceb4c8 (commit)


- Log -----------------------------------------------------------------
commit 0a3b330cf09dd3746f4f9c5bb82d9bbcfff809c1
Author: Richard Levitte &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">levitte at openssl.org</A>&gt;
Date:   Mon Nov 30 10:44:34 2020 +0100

    Add test to demonstrate the app's new engine key loading
    
    This adds a bit of functionality in ossltest, so it can now be used to
    load PEM files.  It takes the file name as key ID, but just to make
    sure faults aren't ignored, it requires all file names to be prefixed
    with 'ot:'.
    
    Reviewed-by: David von Oheimb &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">david.von.oheimb at siemens.com</A>&gt;
    (Merged from <A HREF="https://github.com/openssl/openssl/pull/13570">https://github.com/openssl/openssl/pull/13570</A>)

commit f91d003a0ef0c748a11ccdb19c7661a3f2df9ab0
Author: Richard Levitte &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">levitte at openssl.org</A>&gt;
Date:   Mon Nov 30 07:25:46 2020 +0100

    APPS: Adapt load_key() and load_pubkey() for the engine: loader
    
    These two functions react when the FORMAT_ENGINE format is given, and
    use the passed ENGINE |e| and the passed key argument to form a URI
    suitable for the engine: loader.
    
    Co-authored-by: David von Oheimb &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">david.von.oheimb at siemens.com</A>&gt;
    
    Reviewed-by: David von Oheimb &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">david.von.oheimb at siemens.com</A>&gt;
    (Merged from <A HREF="https://github.com/openssl/openssl/pull/13570">https://github.com/openssl/openssl/pull/13570</A>)

commit 0b27381fd544beca44df905991923a7fa374d80a
Author: Richard Levitte &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">levitte at openssl.org</A>&gt;
Date:   Fri Oct 12 17:02:58 2018 +0200

    APPS: Add OSSL_STORE loader for engine keys
    
    The idea is to be able to have our apps load engine keys using a URI:
    
        org.openssl.engine:{engineid}:{keyid}
    
    This is legacy, but added for the time being to support keys given to
    the application like this:
    
        -engine {engineid} -key {keyid} -keyform ENGINE
    
    This latter form is recognised internally, and rewritten into the URI
    form.
    
    Reviewed-by: David von Oheimb &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">david.von.oheimb at siemens.com</A>&gt;
    (Merged from <A HREF="https://github.com/openssl/openssl/pull/13570">https://github.com/openssl/openssl/pull/13570</A>)

-----------------------------------------------------------------------

Summary of changes:
 apps/cmp.c                       |   6 +-
 apps/include/apps.h              |   6 +-
 apps/include/engine_loader.h     |  21 ++++
 apps/lib/apps.c                  |  69 +++++++------
 apps/lib/build.info              |   2 +-
 apps/lib/engine.c                |  59 +++++-------
 apps/lib/engine_loader.c         | 203 +++++++++++++++++++++++++++++++++++++++
 apps/openssl.c                   |   2 +
 doc/man1/openssl-ca.pod.in       |   4 +-
 doc/man1/openssl-cmp.pod.in      |  46 +++++----
 doc/man1/openssl-cms.pod.in      |   4 +-
 doc/man1/openssl-dgst.pod.in     |   6 +-
 doc/man1/openssl-ec.pod.in       |   6 +-
 doc/man1/openssl-list.pod.in     |   1 -
 doc/man1/openssl-pkcs12.pod.in   |  20 ++--
 doc/man1/openssl-pkey.pod.in     |   6 +-
 doc/man1/openssl-pkeyutl.pod.in  |   8 +-
 doc/man1/openssl-req.pod.in      |   6 +-
 doc/man1/openssl-rsa.pod.in      |   6 +-
 doc/man1/openssl-rsautl.pod.in   |   6 +-
 doc/man1/openssl-s_client.pod.in |   8 +-
 doc/man1/openssl-s_server.pod.in |  18 +++-
 doc/man1/openssl-smime.pod.in    |   6 +-
 doc/man1/openssl-spkac.pod.in    |   8 +-
 doc/man1/openssl-ts.pod.in       |   6 +-
 doc/man1/openssl-verify.pod.in   |   2 +
 doc/man1/openssl-x509.pod.in     |  10 +-
 doc/man1/openssl.pod             |  41 ++++++--
 engines/e_ossltest.c             |  44 +++++++++
 test/recipes/90-test_store.t     |  41 +++++++-
 30 files changed, 510 insertions(+), 161 deletions(-)
 create mode 100644 apps/include/engine_loader.h
 create mode 100644 apps/lib/engine_loader.c

diff --git a/apps/cmp.c b/apps/cmp.c
index c9bbbb32ba..d57c67c644 100644
--- a/apps/cmp.c
+++ b/apps/cmp.c
@@ -409,11 +409,7 @@ const OPTIONS cmp_options[] = {
     {&quot;engine&quot;, OPT_ENGINE, 's',
      &quot;Use crypto engine with given identifier, possibly a hardware device.&quot;},
     {OPT_MORE_STR, 0, 0,
-     &quot;Engines may be defined in OpenSSL config file engine section.&quot;},
-    {OPT_MORE_STR, 0, 0,
-     &quot;Options like -key specifying keys held in the engine can give key IDs&quot;},
-    {OPT_MORE_STR, 0, 0,
-     &quot;prefixed by 'engine:', e.g. '-key engine:pkcs11:object=mykey;pin-value=1234'&quot;},
+     &quot;Engines may also be defined in OpenSSL config file engine section.&quot;},
 #endif
     OPT_PROV_OPTIONS,
 
diff --git a/apps/include/apps.h b/apps/include/apps.h
index 0848a2e03e..ddfa3c8383 100644
--- a/apps/include/apps.h
+++ b/apps/include/apps.h
@@ -36,6 +36,7 @@
 # include &quot;opt.h&quot;
 # include &quot;fmt.h&quot;
 # include &quot;platform.h&quot;
+# include &quot;engine_loader.h&quot;
 
 /*
  * quick macro when you need to pass an unsigned char instead of a char.
@@ -155,10 +156,7 @@ ENGINE *setup_engine_methods(const char *id, unsigned int methods, int debug);
 void release_engine(ENGINE *e);
 int init_engine(ENGINE *e);
 int finish_engine(ENGINE *e);
-EVP_PKEY *load_engine_private_key(ENGINE *e, const char *keyid,
-                                  const char *pass, const char *desc);
-EVP_PKEY *load_engine_public_key(ENGINE *e, const char *keyid,
-                                 const char *pass, const char *desc);
+char *make_engine_uri(ENGINE *e, const char *key_id, const char *desc);
 
 int get_legacy_pkey_id(OSSL_LIB_CTX *libctx, const char *algname, ENGINE *e);
 
diff --git a/apps/include/engine_loader.h b/apps/include/engine_loader.h
new file mode 100644
index 0000000000..11598639a5
--- /dev/null
+++ b/apps/include/engine_loader.h
@@ -0,0 +1,21 @@
+/*
+ * Copyright 2018 The OpenSSL Project Authors. All Rights Reserved.
+ *
+ * Licensed under the OpenSSL license (the &quot;License&quot;).  You may not use
+ * this file except in compliance with the License.  You can obtain a copy
+ * in the file LICENSE in the source distribution or at
+ * <A HREF="https://www.openssl.org/source/license.html">https://www.openssl.org/source/license.html</A>
+ */
+#ifndef HEADER_ENGINE_LOADER_H
+# define HEADER_ENGINE_LOADER_H
+
+# include &lt;openssl/store.h&gt;
+
+/* this is a private URI scheme */
+# define ENGINE_SCHEME          &quot;org.openssl.engine&quot;
+# define ENGINE_SCHEME_COLON    (ENGINE_SCHEME &quot;:&quot;)
+
+int setup_engine_loader(void);
+void destroy_engine_loader(void);
+
+#endif
diff --git a/apps/lib/apps.c b/apps/lib/apps.c
index 766002b6b0..699802044d 100644
--- a/apps/lib/apps.c
+++ b/apps/lib/apps.c
@@ -39,6 +39,8 @@
 #endif
 #include &lt;openssl/bn.h&gt;
 #include &lt;openssl/ssl.h&gt;
+#include &lt;openssl/store.h&gt;
+#include &quot;s_apps.h&quot;
 #include &quot;apps.h&quot;
 
 #ifdef _WIN32
@@ -558,25 +560,18 @@ EVP_PKEY *load_key(const char *uri, int format, int may_stdin,
                    const char *pass, ENGINE *e, const char *desc)
 {
     EVP_PKEY *pkey = NULL;
+    char *allocated_uri = NULL;
 
     if (desc == NULL)
         desc = &quot;private key&quot;;
 
     if (format == FORMAT_ENGINE) {
-        if (e == NULL) {
-            BIO_printf(bio_err, &quot;No engine specified for loading %s\n&quot;, desc);
-        } else {
-            pkey = load_engine_private_key(e, uri, pass, desc);
-            if (pkey == NULL) {
-                BIO_printf(bio_err, &quot;Cannot load %s from engine\n&quot;, desc);
-                ERR_print_errors(bio_err);
-            }
-        }
-    } else {
-        (void)load_key_certs_crls(uri, may_stdin, pass, desc,
-                                  &amp;pkey, NULL, NULL, NULL, NULL, NULL, NULL);
+        uri = allocated_uri = make_engine_uri(e, uri, desc);
     }
+    (void)load_key_certs_crls(uri, may_stdin, pass, desc,
+                              &amp;pkey, NULL, NULL, NULL, NULL, NULL, NULL);
 
+    OPENSSL_free(allocated_uri);
     return pkey;
 }
 
@@ -584,25 +579,18 @@ EVP_PKEY *load_pubkey(const char *uri, int format, int maybe_stdin,
                       const char *pass, ENGINE *e, const char *desc)
 {
     EVP_PKEY *pkey = NULL;
+    char *allocated_uri = NULL;
 
     if (desc == NULL)
         desc = &quot;public key&quot;;
 
     if (format == FORMAT_ENGINE) {
-        if (e == NULL) {
-            BIO_printf(bio_err, &quot;No engine specified for loading %s\n&quot;, desc);
-        } else {
-            pkey = load_engine_public_key(e, uri, pass, desc);
-            if (pkey == NULL) {
-                BIO_printf(bio_err, &quot;Cannot load %s from engine\n&quot;, desc);
-                ERR_print_errors(bio_err);
-            }
-        }
-    } else {
-        (void)load_key_certs_crls(uri, maybe_stdin, pass, desc,
-                                  NULL, &amp;pkey, NULL, NULL, NULL, NULL, NULL);
+        uri = allocated_uri = make_engine_uri(e, uri, desc);
     }
+    (void)load_key_certs_crls(uri, maybe_stdin, pass, desc,
+                              NULL, &amp;pkey, NULL, NULL, NULL, NULL, NULL);
 
+    OPENSSL_free(allocated_uri);
     return pkey;
 }
 
@@ -715,14 +703,25 @@ int load_key_certs_crls(const char *uri, int maybe_stdin,
         pparams != NULL ? &quot;params&quot; : pcert != NULL ? &quot;cert&quot; :
         pcrl != NULL ? &quot;CRL&quot; : pcerts != NULL ? &quot;certs&quot; :
         pcrls != NULL ? &quot;CRLs&quot; : NULL;
+    int cnt_expectations = 0;
+    int expect = 0;
     /* TODO make use of the engine reference 'eng' when loading pkeys */
 
-    if (ppkey != NULL)
+    if (ppkey != NULL) {
         *ppkey = NULL;
-    if (ppubkey != NULL)
+        cnt_expectations++;
+        expect = OSSL_STORE_INFO_PKEY;
+    }
+    if (ppubkey != NULL) {
         *ppubkey = NULL;
-    if (pcert != NULL)
+        cnt_expectations++;
+        expect = OSSL_STORE_INFO_PUBKEY;
+    }
+    if (pcert != NULL) {
         *pcert = NULL;
+        cnt_expectations++;
+        expect = OSSL_STORE_INFO_CERT;
+    }
     if (failed == NULL) {
         BIO_printf(bio_err, &quot;Internal error: nothing to load into from %s\n&quot;,
                    uri != NULL ? uri : &quot;&lt;stdin&gt;&quot;);
@@ -733,13 +732,22 @@ int load_key_certs_crls(const char *uri, int maybe_stdin,
             &amp;&amp; (*pcerts = sk_X509_new_null()) == NULL) {
         BIO_printf(bio_err, &quot;Out of memory loading&quot;);
         goto end;
+    } else {
+        cnt_expectations++;
+        expect = OSSL_STORE_INFO_CERT;
     }
-    if (pcrl != NULL)
+    if (pcrl != NULL) {
         *pcrl = NULL;
+        cnt_expectations++;
+        expect = OSSL_STORE_INFO_CRL;
+    }
     if (pcrls != NULL &amp;&amp; *pcrls == NULL
             &amp;&amp; (*pcrls = sk_X509_CRL_new_null()) == NULL) {
         BIO_printf(bio_err, &quot;Out of memory loading&quot;);
         goto end;
+    } else {
+        cnt_expectations++;
+        expect = OSSL_STORE_INFO_CRL;
     }
 
     uidata.password = pass;
@@ -767,6 +775,11 @@ int load_key_certs_crls(const char *uri, int maybe_stdin,
         goto end;
     }
 
+    if (cnt_expectations != 1)
+        expect = 0;
+    if (!OSSL_STORE_expect(ctx, expect))
+        goto end;
+
     failed = NULL;
     while (!OSSL_STORE_eof(ctx)) {
         OSSL_STORE_INFO *info = OSSL_STORE_load(ctx);
diff --git a/apps/lib/build.info b/apps/lib/build.info
index 9930ad6212..93d0a99df9 100644
--- a/apps/lib/build.info
+++ b/apps/lib/build.info
@@ -10,7 +10,7 @@ ENDIF
 # Source for libapps
 $LIBAPPSSRC=apps.c apps_ui.c opt.c fmt.c s_cb.c s_socket.c app_rand.c \
         columns.c app_params.c names.c app_provider.c app_x509.c http_server.c \
-        engine.c
+        engine.c engine_loader.c
 
 IF[{- !$disabled{apps} -}]
   LIBS{noinst}=../libapps.a
diff --git a/apps/lib/engine.c b/apps/lib/engine.c
index 4d9adc2818..e4a65b04e2 100644
--- a/apps/lib/engine.c
+++ b/apps/lib/engine.c
@@ -102,48 +102,37 @@ int finish_engine(ENGINE *e)
     return rv;
 }
 
-EVP_PKEY *load_engine_private_key(ENGINE *e, const char *keyid,
-                                  const char *pass, const char *desc)
+char *make_engine_uri(ENGINE *e, const char *key_id, const char *desc)
 {
-    EVP_PKEY *rv = NULL;
+    char *new_uri = NULL;
 
 #ifndef OPENSSL_NO_ENGINE
-    if (init_engine(e)) {
-        PW_CB_DATA cb_data;
-
-        cb_data.password = pass;
-        cb_data.prompt_info = keyid;
-
-        rv = ENGINE_load_private_key(e, keyid,
-                                     (UI_METHOD *)get_ui_method(), &amp;cb_data);
-        finish_engine(e);
-    }
-#else
-    BIO_printf(bio_err, &quot;Engines not supported for loading %s\n&quot;, desc);
-#endif
-    return rv;
-}
-
-EVP_PKEY *load_engine_public_key(ENGINE *e, const char *keyid,
-                                 const char *pass, const char *desc)
-{
-    EVP_PKEY *rv = NULL;
-
-#ifndef OPENSSL_NO_ENGINE
-    if (init_engine(e)) {
-        PW_CB_DATA cb_data;
-
-        cb_data.password = pass;
-        cb_data.prompt_info = keyid;
-
-        rv = ENGINE_load_public_key(e, keyid,
-                                    (UI_METHOD *)get_ui_method(), &amp;cb_data);
-        finish_engine(e);
+    if (e == NULL) {
+        BIO_printf(bio_err, &quot;No engine specified for loading %s\n&quot;, desc);
+    } else if (key_id == NULL) {
+        BIO_printf(bio_err, &quot;No engine key id specified for loading %s\n&quot;, desc);
+    } else {
+        const char *engineid = ENGINE_get_id(e);
+        size_t uri_sz =
+            sizeof(ENGINE_SCHEME_COLON) - 1
+            + strlen(engineid)
+            + 1 /* : */
+            + strlen(key_id)
+            + 1 /* \0 */
+            ;
+
+        new_uri = OPENSSL_malloc(uri_sz);
+        if (new_uri != NULL) {
+            OPENSSL_strlcpy(new_uri, ENGINE_SCHEME_COLON, uri_sz);
+            OPENSSL_strlcat(new_uri, engineid, uri_sz);
+            OPENSSL_strlcat(new_uri, &quot;:&quot;, uri_sz);
+            OPENSSL_strlcat(new_uri, key_id, uri_sz);
+        }
     }
 #else
     BIO_printf(bio_err, &quot;Engines not supported for loading %s\n&quot;, desc);
 #endif
-    return rv;
+    return new_uri;
 }
 
 int get_legacy_pkey_id(OSSL_LIB_CTX *libctx, const char *algname, ENGINE *e)
diff --git a/apps/lib/engine_loader.c b/apps/lib/engine_loader.c
new file mode 100644
index 0000000000..2b4480000c
--- /dev/null
+++ b/apps/lib/engine_loader.c
@@ -0,0 +1,203 @@
+/*
+ * Copyright 2018 The OpenSSL Project Authors. All Rights Reserved.
+ *
+ * Licensed under the OpenSSL license (the &quot;License&quot;).  You may not use
+ * this file except in compliance with the License.  You can obtain a copy
+ * in the file LICENSE in the source distribution or at
+ * <A HREF="https://www.openssl.org/source/license.html">https://www.openssl.org/source/license.html</A>
+ */
+
+/*
+ * Here is an STORE loader for ENGINE backed keys.  It relies on deprecated
+ * functions, and therefore need to have deprecation warnings suppressed.
+ * This file is not compiled at all in a '--api=3 no-deprecated' configuration.
+ */
+#define OPENSSL_SUPPRESS_DEPRECATED
+
+#include &quot;apps.h&quot;
+
+#ifndef OPENSSL_NO_ENGINE
+
+# include &lt;stdarg.h&gt;
+# include &lt;string.h&gt;
+# include &lt;openssl/engine.h&gt;
+# include &lt;openssl/store.h&gt;
+
+/*
+ * Support for legacy private engine keys via the 'org.openssl.engine:' scheme
+ *
+ * org.openssl.engine:{engineid}:{keyid}
+ *
+ * Note: we ONLY support ENGINE_load_private_key() and ENGINE_load_public_key()
+ * Note 2: This scheme has a precedent in code in PKIX-SSH. for exactly
+ * this sort of purpose.
+ */
+
+/* Local definition of OSSL_STORE_LOADER_CTX */
+struct ossl_store_loader_ctx_st {
+    ENGINE *e;                   /* Structural reference */
+    char *keyid;
+    int expected;
+    int loaded;                  /* 0 = key not loaded yet, 1 = key loaded */
+};
+
+static OSSL_STORE_LOADER_CTX *OSSL_STORE_LOADER_CTX_new(ENGINE *e, char *keyid)
+{
+    OSSL_STORE_LOADER_CTX *ctx = OPENSSL_zalloc(sizeof(*ctx));
+
+    if (ctx != NULL) {
+        ctx-&gt;e = e;
+        ctx-&gt;keyid = keyid;
+    }
+    return ctx;
+}
+
+static void OSSL_STORE_LOADER_CTX_free(OSSL_STORE_LOADER_CTX *ctx)
+{
+    if (ctx != NULL) {
+        ENGINE_free(ctx-&gt;e);
+        OPENSSL_free(ctx-&gt;keyid);
+        OPENSSL_free(ctx);
+    }
+}
+
+static OSSL_STORE_LOADER_CTX *engine_open(const OSSL_STORE_LOADER *loader,
+                                          const char *uri,
+                                          const UI_METHOD *ui_method,
+                                          void *ui_data)
+{
+    const char *p = uri, *q;
+    ENGINE *e = NULL;
+    char *keyid = NULL;
+    OSSL_STORE_LOADER_CTX *ctx = NULL;
+
+    if (strncasecmp(p, ENGINE_SCHEME_COLON, sizeof(ENGINE_SCHEME_COLON) - 1)
+        != 0)
+        return NULL;
+    p += sizeof(ENGINE_SCHEME_COLON) - 1;
+
+    /* Look for engine ID */
+    q = strchr(p, ':');
+    if (q != NULL                /* There is both an engine ID and a key ID */
+        &amp;&amp; p[0] != ':'           /* The engine ID is at least one character */
+        &amp;&amp; q[1] != '\0') {       /* The key ID is at least one character */
+        char engineid[256];
+        size_t engineid_l = q - p;
+
+        strncpy(engineid, p, engineid_l);
+        engineid[engineid_l] = '\0';
+        e = ENGINE_by_id(engineid);
+
+        keyid = OPENSSL_strdup(q + 1);
+    }
+
+    if (e != NULL)
+        ctx = OSSL_STORE_LOADER_CTX_new(e, keyid);
+
+    if (ctx == NULL) {
+        OPENSSL_free(keyid);
+        ENGINE_free(e);
+    }
+
+    return ctx;
+}
+
+static int engine_expect(OSSL_STORE_LOADER_CTX *ctx, int expected)
+{
+    if (expected == 0
+        || expected == OSSL_STORE_INFO_PUBKEY
+        || expected == OSSL_STORE_INFO_PKEY) {
+        ctx-&gt;expected = expected;
+        return 1;
+    }
+    return 0;
+}
+
+static OSSL_STORE_INFO *engine_load(OSSL_STORE_LOADER_CTX *ctx,
+                                    const UI_METHOD *ui_method, void *ui_data)
+{
+    EVP_PKEY *pkey = NULL, *pubkey = NULL;
+    OSSL_STORE_INFO *info = NULL;
+
+    if (ctx-&gt;loaded == 0) {
+        if (ENGINE_init(ctx-&gt;e)) {
+            if (ctx-&gt;expected == 0
+                || ctx-&gt;expected == OSSL_STORE_INFO_PKEY)
+                pkey =
+                    ENGINE_load_private_key(ctx-&gt;e, ctx-&gt;keyid,
+                                            (UI_METHOD *)ui_method, ui_data);
+            if ((pkey == NULL &amp;&amp; ctx-&gt;expected == 0)
+                || ctx-&gt;expected == OSSL_STORE_INFO_PUBKEY)
+                pubkey =
+                    ENGINE_load_public_key(ctx-&gt;e, ctx-&gt;keyid,
+                                           (UI_METHOD *)ui_method, ui_data);
+            ENGINE_finish(ctx-&gt;e);
+        }
+    }
+
+    ctx-&gt;loaded = 1;
+
+    if (pubkey != NULL)
+        info = OSSL_STORE_INFO_new_PUBKEY(pubkey);
+    else if (pkey != NULL)
+        info = OSSL_STORE_INFO_new_PKEY(pkey);
+    if (info == NULL) {
+        EVP_PKEY_free(pkey);
+        EVP_PKEY_free(pubkey);
+    }
+    return info;
+}
+
+static int engine_eof(OSSL_STORE_LOADER_CTX *ctx)
+{
+    return ctx-&gt;loaded != 0;
+}
+
+static int engine_error(OSSL_STORE_LOADER_CTX *ctx)
+{
+    return 0;
+}
+
+static int engine_close(OSSL_STORE_LOADER_CTX *ctx)
+{
+    OSSL_STORE_LOADER_CTX_free(ctx);
+    return 1;
+}
+
+int setup_engine_loader(void)
+{
+    OSSL_STORE_LOADER *loader = NULL;
+
+    if ((loader = OSSL_STORE_LOADER_new(NULL, ENGINE_SCHEME)) == NULL
+        || !OSSL_STORE_LOADER_set_open(loader, engine_open)
+        || !OSSL_STORE_LOADER_set_expect(loader, engine_expect)
+        || !OSSL_STORE_LOADER_set_load(loader, engine_load)
+        || !OSSL_STORE_LOADER_set_eof(loader, engine_eof)
+        || !OSSL_STORE_LOADER_set_error(loader, engine_error)
+        || !OSSL_STORE_LOADER_set_close(loader, engine_close)
+        || !OSSL_STORE_register_loader(loader)) {
+        OSSL_STORE_LOADER_free(loader);
+        loader = NULL;
+    }
+
+    return loader != NULL;
+}
+
+void destroy_engine_loader(void)
+{
+    OSSL_STORE_LOADER *loader = OSSL_STORE_unregister_loader(ENGINE_SCHEME);
+    OSSL_STORE_LOADER_free(loader);
+}
+
+#else  /* !OPENSSL_NO_ENGINE */
+
+int setup_engine_loader(void)
+{
+    return 0;
+}
+
+void destroy_engine_loader(void)
+{
+}
+
+#endif
diff --git a/apps/openssl.c b/apps/openssl.c
index 307303b257..9d697a8836 100644
--- a/apps/openssl.c
+++ b/apps/openssl.c
@@ -68,6 +68,7 @@ static int apps_startup(void)
         return 0;
 
     (void)setup_ui_method();
+    (void)setup_engine_loader();
 
     /*
      * NOTE: This is an undocumented feature required for testing only.
@@ -89,6 +90,7 @@ static void apps_shutdown(void)
 {
     app_providers_cleanup();
     OSSL_LIB_CTX_free(app_get0_libctx());
+    destroy_engine_loader();
     destroy_ui_method();
 }
 
diff --git a/doc/man1/openssl-ca.pod.in b/doc/man1/openssl-ca.pod.in
index b1d437a5c0..64a7054d63 100644
--- a/doc/man1/openssl-ca.pod.in
+++ b/doc/man1/openssl-ca.pod.in
@@ -33,7 +33,7 @@ B&lt;openssl&gt; B&lt;ca&gt;
 [B&lt;-days&gt; I&lt;arg&gt;]
 [B&lt;-md&gt; I&lt;arg&gt;]
 [B&lt;-policy&gt; I&lt;arg&gt;]
-[B&lt;-keyfile&gt; I&lt;arg&gt;]
+[B&lt;-keyfile&gt; I&lt;filename&gt;|I&lt;uri&gt;]
 [B&lt;-keyform&gt; B&lt;DER&gt;|B&lt;PEM&gt;|B&lt;P12&gt;|B&lt;ENGINE&gt;]
 [B&lt;-key&gt; I&lt;arg&gt;]
 [B&lt;-passin&gt; I&lt;arg&gt;]
@@ -148,7 +148,7 @@ The CA certificate, which must match with B&lt;-keyfile&gt;.
 The format of the data in certificate input files.
 This option has no effect and is retained for backward compatibility only.
 
-=item B&lt;-keyfile&gt; I&lt;filename&gt;
+=item B&lt;-keyfile&gt; I&lt;filename&gt;|I&lt;uri&gt;
 
 The CA private key to sign requests with. This must match with B&lt;-cert&gt;.
 
diff --git a/doc/man1/openssl-cmp.pod.in b/doc/man1/openssl-cmp.pod.in
index 291535b7a1..0993186158 100644
--- a/doc/man1/openssl-cmp.pod.in
+++ b/doc/man1/openssl-cmp.pod.in
@@ -21,7 +21,7 @@ Generic message options:
 
 Certificate enrollment options:
 
-[B&lt;-newkey&gt; I&lt;filename&gt;]
+[B&lt;-newkey&gt; I&lt;filename&gt;|I&lt;uri&gt;]
 [B&lt;-newkeypass&gt; I&lt;arg&gt;]
 [B&lt;-subject&gt; I&lt;name&gt;]
 [B&lt;-issuer&gt; I&lt;name&gt;]
@@ -90,7 +90,7 @@ TLS connection options:
 
 [B&lt;-tls_used&gt;]
 [B&lt;-tls_cert&gt; I&lt;filename&gt;]
-[B&lt;-tls_key&gt; I&lt;filename&gt;]
+[B&lt;-tls_key&gt; I&lt;filename&gt;|I&lt;uri&gt;]
 [B&lt;-tls_keypass&gt; I&lt;arg&gt;]
 [B&lt;-tls_extra&gt; I&lt;filenames&gt;]
 [B&lt;-tls_trusted&gt; I&lt;filenames&gt;]
@@ -139,6 +139,8 @@ Certificate verification options, for both CMP and TLS:
 
 {- $OpenSSL::safe::opt_v_synopsis -}
 
+=for openssl ifdef engine
+
 =head1 DESCRIPTION
 
 The B&lt;cmp&gt; command is a client implementation for the Certificate
@@ -241,9 +243,9 @@ e.g., C&lt;1.2.3.4:int:56789&gt;.
 
 =over 4
 
-=item B&lt;-newkey&gt; I&lt;filename&gt;
+=item B&lt;-newkey&gt; I&lt;filename&gt;|I&lt;uri&gt;
 
-The file containing the private or public key for the certificate requested
+The source of the private or public key for the certificate requested
 in Initialization Request (IR), Certification Request(CR), or
 Key Update Request (KUR).
 Default is the public key in the PKCS#10 CSR given with the B&lt;-csr&gt; option,
@@ -701,6 +703,7 @@ Default value is PEM.
 
 The format of the key input.
 The only value with effect is B&lt;ENGINE&gt;.
+See L&lt;openssl(1)/Format Options&gt; for details.
 
 =item B&lt;-otherpass&gt; I&lt;arg&gt;
 
@@ -712,27 +715,24 @@ If not given here, the password will be prompted for if needed.
 
 For more information about the format of B&lt;arg&gt; see the
 B&lt;PASS PHRASE ARGUMENTS&gt; section in L&lt;openssl(1)&gt;.
+
+{- $OpenSSL::safe::opt_engine_item -}
+
+=back
+
 {- output_off() if $disabled{&quot;deprecated-3.0&quot;}; &quot;&quot; -}
+As an alternative to using this combination:
 
-=item B&lt;-engine&gt; I&lt;id&gt;
+    -engine {engineid} -key {keyid} -keyform ENGINE
 
-Specifying a crypto engine B&lt;id&gt; will lead to obtaining a functional
-reference to the specified engine, initializing it if needed.
-The engine will be used for all algorithms supported for keys
-prefixed by C&lt;engine:&gt;.
-Engines may be defined in the OpenSSL config file as usual in an engine section.
+... it's also possible to just give the key ID in URI form to B&lt;-key&gt;,
+like this:
 
-Options specifying keys, like B&lt;-key&gt;, B&lt;-newkey&gt;, B&lt;-tls_key&gt; can prefix
-C&lt;engine:&gt; to engine-specific identifiers for security tokens objects held by
-the engine.
- The following example utilizes the RFC 7512 PKCS #11 URI scheme
-as supported, e.g., by libp11:
-C&lt;-key engine:pkcs11:object=my-private-key;type=private;pin-value=1234&gt;
+    -key org.openssl.engine:{engineid}:{keyid}
 
+This applies to all options specifying keys: B&lt;-key&gt;, B&lt;-newkey&gt;, and
+B&lt;-tls_key&gt;.
 {- output_on() if $disabled{&quot;deprecated-3.0&quot;}; &quot;&quot; -}
-{- $OpenSSL::safe::opt_provider_item -}
-
-=back
 
 =head2 TLS connection options
 
@@ -749,7 +749,7 @@ Client's TLS certificate.
 If the file includes further certs they are used (along with B&lt;-untrusted&gt;
 certs) for constructing the client cert chain provided to the TLS server.
 
-=item B&lt;-tls_key&gt; I&lt;filename&gt;
+=item B&lt;-tls_key&gt; I&lt;filename&gt;|I&lt;uri&gt;
 
 Private key for the client's TLS certificate.
 
@@ -1162,6 +1162,12 @@ and the above genm call reduces to
 L&lt;openssl-genrsa(1)&gt;, L&lt;openssl-ecparam(1)&gt;, L&lt;openssl-list(1)&gt;,
 L&lt;openssl-req(1)&gt;, L&lt;openssl-x509(1)&gt;, L&lt;x509v3_config(5)&gt;
 
+=head1 HISTORY
+
+The B&lt;cmp&gt; application was added in OpenSSL 3.0.
+
+The B&lt;-engine option&gt; was deprecated in OpenSSL 3.0.
+
 =head1 COPYRIGHT
 
 Copyright 2007-2020 The OpenSSL Project Authors. All Rights Reserved.
diff --git a/doc/man1/openssl-cms.pod.in b/doc/man1/openssl-cms.pod.in
index db1dc75978..fc2bae1bce 100644
--- a/doc/man1/openssl-cms.pod.in
+++ b/doc/man1/openssl-cms.pod.in
@@ -72,7 +72,7 @@ B&lt;openssl&gt; B&lt;cms&gt;
 [B&lt;-secretkey&gt; I&lt;key&gt;]
 [B&lt;-secretkeyid&gt; I&lt;id&gt;]
 [B&lt;-econtent_type&gt; I&lt;type&gt;]
-[B&lt;-inkey&gt; I&lt;file&gt;]
+[B&lt;-inkey&gt; I&lt;filename&gt;|I&lt;uri&gt;]
 [B&lt;-keyopt&gt; I&lt;name&gt;:I&lt;parameter&gt;]
 [B&lt;-passin&gt; I&lt;arg&gt;]
 [B&lt;-to&gt; I&lt;addr&gt;]
@@ -466,7 +466,7 @@ Set the encapsulated content type to I&lt;type&gt; if not supplied the B&lt;Data&gt; type
 is used. The I&lt;type&gt; argument can be any valid OID name in either text or
 numerical format.
 
-=item B&lt;-inkey&gt; I&lt;file&gt;
+=item B&lt;-inkey&gt; I&lt;filename&gt;|I&lt;uri&gt;
 
 The private key to use when signing or decrypting. This must match the
 corresponding certificate. If this option is not specified then the
diff --git a/doc/man1/openssl-dgst.pod.in b/doc/man1/openssl-dgst.pod.in
index 533f30725c..6276fab434 100644
--- a/doc/man1/openssl-dgst.pod.in
+++ b/doc/man1/openssl-dgst.pod.in
@@ -19,7 +19,7 @@ B&lt;openssl&gt; B&lt;dgst&gt;|I&lt;digest&gt;
 [B&lt;-xoflen&gt; I&lt;length&gt;]
 [B&lt;-r&gt;]
 [B&lt;-out&gt; I&lt;filename&gt;]
-[B&lt;-sign&gt; I&lt;filename&gt;]
+[B&lt;-sign&gt; I&lt;filename&gt;|I&lt;uri&gt;]
 [B&lt;-keyform&gt; B&lt;DER&gt;|B&lt;PEM&gt;|B&lt;P12&gt;|B&lt;ENGINE&gt;]
 [B&lt;-passin&gt; I&lt;arg&gt;]
 [B&lt;-verify&gt; I&lt;filename&gt;]
@@ -100,9 +100,9 @@ Used by programs like L&lt;sha1sum(1)&gt;.
 
 Filename to output to, or standard output by default.
 
-=item B&lt;-sign&gt; I&lt;filename&gt;
+=item B&lt;-sign&gt; I&lt;filename&gt;|I&lt;uri&gt;
 
-Digitally sign the digest using the private key in &quot;filename&quot;. Note this option
+Digitally sign the digest using the given private key. Note this option
 does not support Ed25519 or Ed448 private keys. Use the L&lt;openssl-pkeyutl(1)&gt;
 command instead for this.
 
diff --git a/doc/man1/openssl-ec.pod.in b/doc/man1/openssl-ec.pod.in
index 6f07607e53..2ba107d031 100644
--- a/doc/man1/openssl-ec.pod.in
+++ b/doc/man1/openssl-ec.pod.in
@@ -15,7 +15,7 @@ B&lt;openssl&gt; B&lt;ec&gt;
 [B&lt;-help&gt;]
 [B&lt;-inform&gt; B&lt;DER&gt;|B&lt;PEM&gt;|B&lt;P12&gt;|B&lt;ENGINE&gt;]
 [B&lt;-outform&gt; B&lt;DER&gt;|B&lt;PEM&gt;]
-[B&lt;-in&gt; I&lt;filename&gt;]
+[B&lt;-in&gt; I&lt;filename&gt;|I&lt;uri&gt;]
 [B&lt;-passin&gt; I&lt;arg&gt;]
 [B&lt;-out&gt; I&lt;filename&gt;]
 [B&lt;-passout&gt; I&lt;arg&gt;]
@@ -65,9 +65,9 @@ See L&lt;openssl(1)/Format Options&gt; for details.
 Private keys are an SEC1 private key or PKCS#8 format.
 Public keys are a B&lt;SubjectPublicKeyInfo&gt; as specified in IETF RFC 3280.
 
-=item B&lt;-in&gt; I&lt;filename&gt;
+=item B&lt;-in&gt; I&lt;filename&gt;|I&lt;uri&gt;
 
-This specifies the input filename to read a key from or standard input if this
+This specifies the input to read a key from or standard input if this
 option is not specified. If the key is encrypted a pass phrase will be
 prompted for.
 
diff --git a/doc/man1/openssl-list.pod.in b/doc/man1/openssl-list.pod.in
index 45e58da870..7d7ba6504e 100644
--- a/doc/man1/openssl-list.pod.in
+++ b/doc/man1/openssl-list.pod.in
@@ -158,7 +158,6 @@ This option is deprecated.
 
 Display a list of loaded engines.
 
-{- output_on() if $disabled{&quot;deprecated-3.0&quot;}; &quot;&quot; -}
 =item B&lt;-disabled&gt;
 
 Display a list of disabled features, those that were compiled out
diff --git a/doc/man1/openssl-pkcs12.pod.in b/doc/man1/openssl-pkcs12.pod.in
index e5da1ec980..db9f65a984 100644
--- a/doc/man1/openssl-pkcs12.pod.in
+++ b/doc/man1/openssl-pkcs12.pod.in
@@ -12,12 +12,12 @@ B&lt;openssl&gt; B&lt;pkcs12&gt;
 [B&lt;-export&gt;]
 [B&lt;-chain&gt;]
 [B&lt;-untrusted&gt; I&lt;filename&gt;]
-[B&lt;-inkey&gt; I&lt;file_or_id&gt;]
+[B&lt;-inkey&gt; I&lt;filename&gt;|I&lt;uri&gt;]
 [B&lt;-certfile&gt; I&lt;filename&gt;]
 [B&lt;-passcerts&gt; I&lt;arg&gt;]
 [B&lt;-name&gt; I&lt;name&gt;]
 [B&lt;-caname&gt; I&lt;name&gt;]
-[B&lt;-in&gt; I&lt;filename&gt;]
+[B&lt;-in&gt; I&lt;filename&gt;|I&lt;uri&gt;]
 [B&lt;-out&gt; I&lt;filename&gt;]
 [B&lt;-noout&gt;]
 [B&lt;-nomacver&gt;]
@@ -86,12 +86,13 @@ The default encryption algorithm is AES-256-CBC with PBKDF2 for key derivation.
 
 Print out a usage message.
 
-=item B&lt;-in&gt; I&lt;filename&gt;
+=item B&lt;-in&gt; I&lt;filename&gt;|I&lt;uri&gt;
 
 This specifies the input filename or URI.
 Standard input is used by default.
 Without the B&lt;-export&gt; option this is a PKCS#12 file to be parsed.
-With the B&lt;-export&gt; option this is a file with certificates and possibly a key.
+With the B&lt;-export&gt; option this is a file with certificates and possibly a key,
+or a URI that refers to a key accessed via an engine.
 
 =item B&lt;-out&gt; I&lt;filename&gt;
 
@@ -206,12 +207,13 @@ The order doesn't matter but one private key and
 its corresponding certificate should be present. If additional
 certificates are present they will also be included in the PKCS#12 file.
 
-=item B&lt;-inkey&gt; I&lt;file_or_id&gt;
+=item B&lt;-inkey&gt; I&lt;filename&gt;|I&lt;uri&gt;
 
-File to read private key from for PKCS12 output.
-If not present then the input file (B&lt;-in&gt; argument) must contain a private key.
-If no engine is used, the argument is taken as a file; if an engine is
-specified, the argument is given to the engine as a key identifier.
+The private key input for PKCS12 output. If this option is not specified then
+the input file (B&lt;-in&gt; argument) must contain a private key.
+If no engine is used, the argument is taken as a file;
+if the B&lt;-engine&gt; option is used or the URI has prefix C&lt;org.openssl.engine:&gt;
+then the rest of the URI is taken as key identifier for the given engine.
 
 =item B&lt;-name&gt; I&lt;friendlyname&gt;
 
diff --git a/doc/man1/openssl-pkey.pod.in b/doc/man1/openssl-pkey.pod.in
index 2b55497bdd..b1afeb534b 100644
--- a/doc/man1/openssl-pkey.pod.in
+++ b/doc/man1/openssl-pkey.pod.in
@@ -15,7 +15,7 @@ B&lt;openssl&gt; B&lt;pkey&gt;
 [B&lt;-help&gt;]
 [B&lt;-inform&gt; B&lt;DER&gt;|B&lt;PEM&gt;|B&lt;P12&gt;|B&lt;ENGINE&gt;]
 [B&lt;-outform&gt; B&lt;DER&gt;|B&lt;PEM&gt;]
-[B&lt;-in&gt; I&lt;filename&gt;]
+[B&lt;-in&gt; I&lt;filename&gt;|I&lt;uri&gt;]
 [B&lt;-passin&gt; I&lt;arg&gt;]
 [B&lt;-out&gt; I&lt;filename&gt;]
 [B&lt;-passout&gt; I&lt;arg&gt;]
@@ -58,9 +58,9 @@ See L&lt;openssl(1)/Format Options&gt; for details.
 The key output formats; the default is B&lt;PEM&gt;.
 See L&lt;openssl(1)/Format Options&gt; for details.
 
-=item B&lt;-in&gt; I&lt;filename&gt;
+=item B&lt;-in&gt; I&lt;filename&gt;|I&lt;uri&gt;
 
-This specifies the input filename to read a key from or standard input if this
+This specifies the input to read a key from or standard input if this
 option is not specified. If the key is encrypted a pass phrase will be
 prompted for.
 
diff --git a/doc/man1/openssl-pkeyutl.pod.in b/doc/man1/openssl-pkeyutl.pod.in
index 8fce576abe..a35c4dae65 100644
--- a/doc/man1/openssl-pkeyutl.pod.in
+++ b/doc/man1/openssl-pkeyutl.pod.in
@@ -14,7 +14,7 @@ B&lt;openssl&gt; B&lt;pkeyutl&gt;
 [B&lt;-digest&gt; I&lt;algorithm&gt;]
 [B&lt;-out&gt; I&lt;file&gt;]
 [B&lt;-sigfile&gt; I&lt;file&gt;]
-[B&lt;-inkey&gt; I&lt;file&gt;]
+[B&lt;-inkey&gt; I&lt;filename&gt;|I&lt;uri&gt;]
 [B&lt;-keyform&gt; B&lt;DER&gt;|B&lt;PEM&gt;|B&lt;P12&gt;|B&lt;ENGINE&gt;]
 [B&lt;-passin&gt; I&lt;arg&gt;]
 [B&lt;-peerkey&gt; I&lt;file&gt;]
@@ -85,9 +85,9 @@ default.
 
 Signature file, required for B&lt;-verify&gt; operations only
 
-=item B&lt;-inkey&gt; I&lt;file&gt;
+=item B&lt;-inkey&gt; I&lt;filename&gt;|I&lt;uri&gt;
 
-The input key file, by default it should be a private key.
+The input key, by default it should be a private key.
 
 =item B&lt;-keyform&gt; B&lt;DER&gt;|B&lt;PEM&gt;|B&lt;P12&gt;|B&lt;ENGINE&gt;
 
@@ -184,10 +184,12 @@ B&lt;-verifyrecover&gt; option when an ASN1 structure is signed.
 
 {- $OpenSSL::safe::opt_engine_item -}
 
+{- output_off() if $disabled{&quot;deprecated-3.0&quot;}; &quot;&quot; -}
 =item B&lt;-engine_impl&gt;
 
 When used with the B&lt;-engine&gt; option, it specifies to also use
 engine I&lt;id&gt; for crypto operations.
+{- output_on() if $disabled{&quot;deprecated-3.0&quot;}; &quot;&quot; -}
 
 {- $OpenSSL::safe::opt_r_item -}
 
diff --git a/doc/man1/openssl-req.pod.in b/doc/man1/openssl-req.pod.in
index 91a40cc89c..8fa5191702 100644
--- a/doc/man1/openssl-req.pod.in
+++ b/doc/man1/openssl-req.pod.in
@@ -25,7 +25,7 @@ B&lt;openssl&gt; B&lt;req&gt;
 [B&lt;-pkeyopt&gt; I&lt;opt&gt;:I&lt;value&gt;]
 [B&lt;-noenc&gt;]
 [B&lt;-nodes&gt;]
-[B&lt;-key&gt; I&lt;filename&gt;]
+[B&lt;-key&gt; I&lt;filename&gt;|I&lt;uri&gt;]
 [B&lt;-keyform&gt; B&lt;DER&gt;|B&lt;PEM&gt;|B&lt;P12&gt;|B&lt;ENGINE&gt;]
 [B&lt;-keyout&gt; I&lt;filename&gt;]
 [B&lt;-keygen_engine&gt; I&lt;id&gt;]
@@ -181,9 +181,9 @@ options supported depends on the public key algorithm used and its
 implementation.
 See L&lt;openssl-genpkey(1)/KEY GENERATION OPTIONS&gt; for more details.
 
-=item B&lt;-key&gt; I&lt;filename&gt;
+=item B&lt;-key&gt; I&lt;filename&gt;|I&lt;uri&gt;
 
-This specifies the file to read the private key from. It also
+This specifies the private key to use. It also
 accepts PKCS#8 format private keys for PEM format files.
 
 =item B&lt;-keyform&gt; B&lt;DER&gt;|B&lt;PEM&gt;|B&lt;P12&gt;|B&lt;ENGINE&gt;
diff --git a/doc/man1/openssl-rsa.pod.in b/doc/man1/openssl-rsa.pod.in
index 63fac355ee..f2e7f3474c 100644
--- a/doc/man1/openssl-rsa.pod.in
+++ b/doc/man1/openssl-rsa.pod.in
@@ -15,7 +15,7 @@ B&lt;openssl&gt; B&lt;rsa&gt;
 [B&lt;-help&gt;]
 [B&lt;-inform&gt; B&lt;DER&gt;|B&lt;PEM&gt;|B&lt;P12&gt;|B&lt;ENGINE&gt;]
 [B&lt;-outform&gt; B&lt;DER&gt;|B&lt;PEM&gt;]
-[B&lt;-in&gt; I&lt;filename&gt;]
+[B&lt;-in&gt; I&lt;filename&gt;|I&lt;uri&gt;]
 [B&lt;-passin&gt; I&lt;arg&gt;]
 [B&lt;-out&gt; I&lt;filename&gt;]
 [B&lt;-passout&gt; I&lt;arg&gt;]
@@ -74,9 +74,9 @@ See L&lt;openssl(1)/Format Options&gt; for details.
 When writing a private key, use the traditional PKCS#1 format
 instead of the PKCS#8 format.
 
-=item B&lt;-in&gt; I&lt;filename&gt;
+=item B&lt;-in&gt; I&lt;filename&gt;|I&lt;uri&gt;
 
-This specifies the input filename to read a key from or standard input if this
+This specifies the input to read a key from or standard input if this
 option is not specified. If the key is encrypted a pass phrase will be
 prompted for.
 
diff --git a/doc/man1/openssl-rsautl.pod.in b/doc/man1/openssl-rsautl.pod.in
index e573e493df..fed453b940 100644
--- a/doc/man1/openssl-rsautl.pod.in
+++ b/doc/man1/openssl-rsautl.pod.in
@@ -13,7 +13,7 @@ B&lt;openssl&gt; B&lt;rsautl&gt;
 [B&lt;-passin&gt; I&lt;arg&gt;]
 [B&lt;-rev&gt;]
 [B&lt;-out&gt; I&lt;file&gt;]
-[B&lt;-inkey&gt; I&lt;file&gt;]
+[B&lt;-inkey&gt; I&lt;filename&gt;|I&lt;uri&gt;]
 [B&lt;-keyform&gt; B&lt;DER&gt;|B&lt;PEM&gt;|B&lt;P12&gt;|B&lt;ENGINE&gt;]
 [B&lt;-pubin&gt;]
 [B&lt;-certin&gt;]
@@ -71,9 +71,9 @@ Reverse the order of the input.
 Specifies the output filename to write to or standard output by
 default.
 
-=item B&lt;-inkey&gt; I&lt;file&gt;
+=item B&lt;-inkey&gt; I&lt;filename&gt;|I&lt;uri&gt;
 
-The input key file, by default it should be an RSA private key.
+The input key, by default it should be an RSA private key.
 
 =item B&lt;-keyform&gt; B&lt;DER&gt;|B&lt;PEM&gt;|B&lt;P12&gt;|B&lt;ENGINE&gt;
 
diff --git a/doc/man1/openssl-s_client.pod.in b/doc/man1/openssl-s_client.pod.in
index 8ea0703e2b..ddaa69c1b7 100644
--- a/doc/man1/openssl-s_client.pod.in
+++ b/doc/man1/openssl-s_client.pod.in
@@ -35,7 +35,7 @@ B&lt;openssl&gt; B&lt;s_client&gt;
 [B&lt;-CRL&gt; I&lt;filename&gt;]
 [B&lt;-CRLform&gt; B&lt;DER&gt;|B&lt;PEM&gt;]
 [B&lt;-crl_download&gt;]
-[B&lt;-key&gt; I&lt;filename&gt;]
+[B&lt;-key&gt; I&lt;filename&gt;|I&lt;uri&gt;]
 [B&lt;-keyform&gt; B&lt;DER&gt;|B&lt;PEM&gt;|B&lt;P12&gt;|B&lt;ENGINE&gt;]
 [B&lt;-pass&gt; I&lt;arg&gt;]
 [B&lt;-chainCAfile&gt; I&lt;filename&gt;]
@@ -269,9 +269,9 @@ See L&lt;openssl(1)/Format Options&gt; for details.
 
 Download CRL from distribution points in the certificate.
 
-=item B&lt;-key&gt; I&lt;keyfile&gt;
+=item B&lt;-key&gt; I&lt;filename&gt;|I&lt;uri&gt;
 
-The client private key file to use.
+The client private key to use.
 If not specified then the certificate file will be used to read also the key.
 
 =item B&lt;-keyform&gt; B&lt;DER&gt;|B&lt;PEM&gt;|B&lt;P12&gt;|B&lt;ENGINE&gt;
@@ -786,9 +786,11 @@ Set the minimal acceptable length, in bits, for B&lt;N&gt;.
 
 {- $OpenSSL::safe::opt_engine_item -}
 
+{- output_off() if $disabled{&quot;deprecated-3.0&quot;}; &quot;&quot; -}
 =item B&lt;-ssl_client_engine&gt; I&lt;id&gt;
 
 Specify engine to be used for client certificate operations.
+{- output_on() if $disabled{&quot;deprecated-3.0&quot;}; &quot;&quot; -}
 
 {- $OpenSSL::safe::opt_v_item -}
 
diff --git a/doc/man1/openssl-s_server.pod.in b/doc/man1/openssl-s_server.pod.in
index 431fc235fa..e568fbab0a 100644
--- a/doc/man1/openssl-s_server.pod.in
+++ b/doc/man1/openssl-s_server.pod.in
@@ -24,14 +24,14 @@ B&lt;openssl&gt; B&lt;s_server&gt;
 [B&lt;-cert_chain&gt; I&lt;infile&gt;]
 [B&lt;-build_chain&gt;]
 [B&lt;-serverinfo&gt; I&lt;val&gt;]
-[B&lt;-key&gt; I&lt;infile&gt;]
-[B&lt;-key2&gt; I&lt;infile&gt;]
+[B&lt;-key&gt; I&lt;filename&gt;|I&lt;uri&gt;]
+[B&lt;-key2&gt; I&lt;filename&gt;|I&lt;uri&gt;]
 [B&lt;-keyform&gt; B&lt;DER&gt;|B&lt;PEM&gt;|B&lt;P12&gt;|B&lt;ENGINE&gt;]
 [B&lt;-pass&gt; I&lt;val&gt;]
 [B&lt;-dcert&gt; I&lt;infile&gt;]
 [B&lt;-dcertform&gt; B&lt;DER&gt;|B&lt;PEM&gt;|B&lt;P12&gt;]
 [B&lt;-dcert_chain&gt; I&lt;infile&gt;]
-[B&lt;-dkey&gt; I&lt;infile&gt;]
+[B&lt;-dkey&gt; I&lt;filename&gt;|I&lt;uri&gt;]
 [B&lt;-dkeyform&gt; B&lt;DER&gt;|B&lt;PEM&gt;|B&lt;P12&gt;|B&lt;ENGINE&gt;]
 [B&lt;-dpass&gt; I&lt;val&gt;]
 [B&lt;-nbio_test&gt;]
@@ -220,6 +220,10 @@ certificate and some require a certificate with a certain public key type:
 for example the DSS cipher suites require a certificate containing a DSS
 (DSA) key. If not specified then the filename F&lt;server.pem&gt; will be used.
 
+=item B&lt;-cert2&gt; I&lt;infile&gt;
+
+The certificate file to use for servername; default is C&lt;server2.pem&gt;.
+
 =item B&lt;-certform&gt; B&lt;DER&gt;|B&lt;PEM&gt;|B&lt;P12&gt;
 
 The server certificate file format.
@@ -244,11 +248,15 @@ followed by &quot;length&quot; bytes of extension data).  If the client sends
 an empty TLS ClientHello extension matching the type, the corresponding
 ServerHello extension will be returned.
 
-=item B&lt;-key&gt; I&lt;infile&gt;
+=item B&lt;-key&gt; I&lt;filename&gt;|I&lt;uri&gt;
 
 The private key to use. If not specified then the certificate file will
 be used.
 
+=item B&lt;-key2&gt; I&lt;filename&gt;|I&lt;uri&gt;
+
+The private Key file to use for servername if not given via B&lt;-cert2&gt;.
+
 =item B&lt;-keyform&gt; B&lt;DER&gt;|B&lt;PEM&gt;|B&lt;P12&gt;|B&lt;ENGINE&gt;
 
 The key format; the default is B&lt;PEM&gt;.
@@ -261,7 +269,7 @@ The private key and certificate file password source.
 For more information about the format of I&lt;val&gt;,
 see L&lt;openssl(1)/Pass Phrase Options&gt;.
 
-=item B&lt;-dcert&gt; I&lt;infile&gt;, B&lt;-dkey&gt; I&lt;infile&gt;
+=item B&lt;-dcert&gt; I&lt;infile&gt;, B&lt;-dkey&gt; I&lt;filename&gt;|I&lt;uri&gt;
 
 Specify an additional certificate and private key, these behave in the
 same manner as the B&lt;-cert&gt; and B&lt;-key&gt; options except there is no default
diff --git a/doc/man1/openssl-smime.pod.in b/doc/man1/openssl-smime.pod.in
index 09f0150b51..aa2dfaf8c5 100644
--- a/doc/man1/openssl-smime.pod.in
+++ b/doc/man1/openssl-smime.pod.in
@@ -34,7 +34,7 @@ B&lt;openssl&gt; B&lt;smime&gt;
 [B&lt;-outform&gt; B&lt;DER&gt;|B&lt;PEM&gt;|B&lt;SMIME&gt;]
 [B&lt;-keyform&gt; B&lt;DER&gt;|B&lt;PEM&gt;|B&lt;P12&gt;|B&lt;ENGINE&gt;]
 [B&lt;-passin&gt; I&lt;arg&gt;]
-[B&lt;-inkey&gt; I&lt;file_or_id&gt;]
+[B&lt;-inkey&gt; I&lt;filename&gt;|I&lt;uri&gt;]
 [B&lt;-out&gt; I&lt;file&gt;]
 [B&lt;-content&gt; I&lt;file&gt;]
 [B&lt;-to&gt; I&lt;addr&gt;]
@@ -259,15 +259,13 @@ Don't include any signed attributes when signing.
 The recipients certificate when decrypting a message. This certificate
 must match one of the recipients of the message or an error occurs.
 
-=item B&lt;-inkey&gt; I&lt;file_or_id&gt;
+=item B&lt;-inkey&gt; I&lt;filename&gt;|I&lt;uri&gt;
 
 The private key to use when signing or decrypting. This must match the
 corresponding certificate. If this option is not specified then the
 private key must be included in the certificate file specified with
 the B&lt;-recip&gt; or B&lt;-signer&gt; file. When signing this option can be used
 multiple times to specify successive keys.
-If no engine is used, the argument is taken as a file; if an engine is
-specified, the argument is given to the engine as a key identifier.
 
 =item B&lt;-passin&gt; I&lt;arg&gt;
 
diff --git a/doc/man1/openssl-spkac.pod.in b/doc/man1/openssl-spkac.pod.in
index e354a4c9ce..31df6b3b59 100644
--- a/doc/man1/openssl-spkac.pod.in
+++ b/doc/man1/openssl-spkac.pod.in
@@ -15,7 +15,7 @@ B&lt;openssl&gt; B&lt;spkac&gt;
 [B&lt;-help&gt;]
 [B&lt;-in&gt; I&lt;filename&gt;]
 [B&lt;-out&gt; I&lt;filename&gt;]
-[B&lt;-key&gt; I&lt;keyfile&gt;]
+[B&lt;-key&gt; I&lt;filename&gt;|I&lt;uri&gt;]
 [B&lt;-keyform&gt; B&lt;DER&gt;|B&lt;PEM&gt;|B&lt;P12&gt;|B&lt;ENGINE&gt;]
 [B&lt;-passin&gt; I&lt;arg&gt;]
 [B&lt;-challenge&gt; I&lt;string&gt;]
@@ -52,10 +52,10 @@ option is not specified. Ignored if the B&lt;-key&gt; option is used.
 Specifies the output filename to write to or standard output by
 default.
 
-=item B&lt;-key&gt; I&lt;keyfile&gt;
+=item B&lt;-key&gt; I&lt;filename&gt;|I&lt;uri&gt;
 
-Create an SPKAC file using the private key in I&lt;keyfile&gt;. The
-B&lt;-in&gt;, B&lt;-noout&gt;, B&lt;-spksect&gt; and B&lt;-verify&gt; options are ignored if
+Create an SPKAC file using the private key specified by I&lt;filename&gt; or I&lt;uri&gt;.
+The B&lt;-in&gt;, B&lt;-noout&gt;, B&lt;-spksect&gt; and B&lt;-verify&gt; options are ignored if
 present.
 
 =item B&lt;-keyform&gt; B&lt;DER&gt;|B&lt;PEM&gt;|B&lt;P12&gt;|B&lt;ENGINE&gt;
diff --git a/doc/man1/openssl-ts.pod.in b/doc/man1/openssl-ts.pod.in
index 86478958c1..c74f71b10a 100644
--- a/doc/man1/openssl-ts.pod.in
+++ b/doc/man1/openssl-ts.pod.in
@@ -32,7 +32,7 @@ B&lt;-reply&gt;
 [B&lt;-queryfile&gt; I&lt;request.tsq&gt;]
 [B&lt;-passin&gt; I&lt;password_src&gt;]
 [B&lt;-signer&gt; I&lt;tsa_cert.pem&gt;]
-[B&lt;-inkey&gt; I&lt;file_or_id&gt;]
+[B&lt;-inkey&gt; I&lt;filename&gt;|I&lt;uri&gt;]
 [B&lt;-I&lt;digest&gt;&gt;]
 [B&lt;-chain&gt; I&lt;certs_file.pem&gt;]
 [B&lt;-tspolicy&gt; I&lt;object_id&gt;]
@@ -225,12 +225,10 @@ timeStamping. The extended key usage must also be critical, otherwise
 the certificate is going to be refused. Overrides the B&lt;signer_cert&gt;
 variable of the config file. (Optional)
 
-=item B&lt;-inkey&gt; I&lt;file_or_id&gt;
+=item B&lt;-inkey&gt; I&lt;filename&gt;|I&lt;uri&gt;
 
 The signer private key of the TSA in PEM format. Overrides the
 B&lt;signer_key&gt; config file option. (Optional)
-If no engine is used, the argument is taken as a file; if an engine is
-specified, the argument is given to the engine as a key identifier.
 
 =item B&lt;-I&lt;digest&gt;&gt;
 
diff --git a/doc/man1/openssl-verify.pod.in b/doc/man1/openssl-verify.pod.in
index c404be74bf..9e3e49b2d7 100644
--- a/doc/man1/openssl-verify.pod.in
+++ b/doc/man1/openssl-verify.pod.in
@@ -79,9 +79,11 @@ Names and values of these options are algorithm-specific.
 {- $OpenSSL::safe::opt_name_item -}
 
 {- $OpenSSL::safe::opt_engine_item -}
+{- output_off() if $disabled{&quot;deprecated-3.0&quot;}; &quot;&quot; -}
 To load certificates or CRLs that require engine support, specify the
 B&lt;-engine&gt; option before any of the
 B&lt;-trusted&gt;, B&lt;-untrusted&gt; or B&lt;-CRLfile&gt; options.
+{- output_on() if $disabled{&quot;deprecated-3.0&quot;}; &quot;&quot; -}
 
 {- $OpenSSL::safe::opt_trust_item -}
 
diff --git a/doc/man1/openssl-x509.pod.in b/doc/man1/openssl-x509.pod.in
index e3e1fd2004..ffa2ab4aed 100644
--- a/doc/man1/openssl-x509.pod.in
+++ b/doc/man1/openssl-x509.pod.in
@@ -45,13 +45,13 @@ B&lt;openssl&gt; B&lt;x509&gt;
 [B&lt;-setalias&gt; I&lt;arg&gt;]
 [B&lt;-days&gt; I&lt;arg&gt;]
 [B&lt;-set_serial&gt; I&lt;n&gt;]
-[B&lt;-signkey&gt; I&lt;arg&gt;]
+[B&lt;-signkey&gt; I&lt;filename&gt;|I&lt;uri&gt;]
 [B&lt;-badsig&gt;]
 [B&lt;-passin&gt; I&lt;arg&gt;]
 [B&lt;-x509toreq&gt;]
 [B&lt;-req&gt;]
 [B&lt;-CA&gt; I&lt;filename&gt;]
-[B&lt;-CAkey&gt; I&lt;filename&gt;]
+[B&lt;-CAkey&gt; I&lt;filename&gt;|I&lt;uri&gt;]
 [B&lt;-CAcreateserial&gt;]
 [B&lt;-CAserial&gt; I&lt;filename&gt;]
 [B&lt;-new&gt;]
@@ -351,10 +351,10 @@ can thus behave like a &quot;mini CA&quot;.
 
 =over 4
 
-=item B&lt;-signkey&gt; I&lt;arg&gt;
+=item B&lt;-signkey&gt; I&lt;filename&gt;|I&lt;uri&gt;
 
 This option causes the input file to be self signed using the supplied
-private key or engine.
+private key.
 
 It sets the issuer name to the subject name (i.e., makes it self-issued)
 and changes the public key to the supplied value (unless overridden by
@@ -442,7 +442,7 @@ of the CA and it is digitally signed using the CAs private key.
 This option is normally combined with the B&lt;-req&gt; option. Without the
 B&lt;-req&gt; option the input is a certificate which must be self signed.
 
-=item B&lt;-CAkey&gt; I&lt;filename&gt;
+=item B&lt;-CAkey&gt; I&lt;filename&gt;|I&lt;uri&gt;
 
 Sets the CA private key to sign a certificate with. If this option is
 not specified then it is assumed that the CA private key is present in
diff --git a/doc/man1/openssl.pod b/doc/man1/openssl.pod
index bd3a9db226..0bb37d415d 100644
--- a/doc/man1/openssl.pod
+++ b/doc/man1/openssl.pod
@@ -527,6 +527,10 @@ of formats.
 Since OpenSSL 3.0 keys, single certificates, and CRLs can be read from
 files in any of the B&lt;DER&gt;, B&lt;PEM&gt; or B&lt;P12&gt; formats,
 while specifying their input format is no more needed.
+In order to access a key via an engine the input format B&lt;ENGINE&gt; may be used;
+alternatively the key identifier in the &lt;uri&gt; argument of the respective key
+option may be preceded by C&lt;org.openssl.engine:&gt;.
+See L&lt;openssl(1)/Engine Options&gt; for an example usage of the latter.
 
 The list of acceptable formats, and the default, is
 described in each command documentation.  The list of formats is
@@ -543,9 +547,7 @@ A binary format, encoded or parsed according to Distinguished Encoding Rules
 
 Used to specify that the cryptographic material is in an OpenSSL B&lt;engine&gt;.
 An engine must be configured or specified using the B&lt;-engine&gt; option.
-In addition, the B&lt;-input&gt; flag can be used to name a specific object in
-the engine.
-A password, such as the B&lt;-passin&gt; flag often must be specified as well.
+A password or PIN may be supplied to the engine using the B&lt;-passin&gt; option.
 
 =item B&lt;P12&gt;
 
@@ -1300,13 +1302,38 @@ respectively.
 
 =item B&lt;-engine&gt; I&lt;id&gt;
 
-Use the engine identified by I&lt;id&gt; and use all the methods it
-implements (algorithms, key storage, etc.), unless specified otherwise in
-the command-specific documentation or it is configured to do so, as described
-in L&lt;config(5)/Engine Configuration Module&gt;.
+Load the engine identified by I&lt;id&gt; and use all the methods it implements
+(algorithms, key storage, etc.), unless specified otherwise in the
+command-specific documentation or it is configured to do so, as described in
+L&lt;config(5)/Engine Configuration&gt;.
+
+The engine will be used for key ids specified with B&lt;-key&gt; and similar
+options when an option like B&lt;-keyform engine&gt; is given.
 
 =back
 
+Options specifying keys, like B&lt;-key&gt; and similar, can use the generic
+OpenSSL engine key loading URI scheme C&lt;org.openssl.engine:&gt; to retrieve
+private keys and public keys.  The URI syntax is as follows, in simplified
+form:
+
+    org.openssl.engine:{engineid}:{keyid}
+
+Where C&lt;{engineid}&gt; is the identity/name of the engine, and C&lt;{keyid}&gt; is a
+key identifier that's acceptable by that engine.  For example, when using an
+engine that interfaces against a PKCS#11 implementation, the generic key URI
+would be something like this (this happens to be an example for the PKCS#11
+engine that's part of OpenSC):
+
+    -key org.openssl.engine:pkcs11:label_some-private-key
+
+As a third possibility, for engines and providers that have implemented
+their own L&lt;OSSL_STORE_LOADER(3)&gt;, C&lt;org.openssl.engine:&gt; should not be
+necessary.  For a PKCS#11 implementation that has implemented such a loader,
+the PKCS#11 URI as defined in RFC 7512 should be possible to use directly:
+
+    -key pkcs11:object=some-private-key;pin-value=1234
+
 =head1 ENVIRONMENT
 
 The OpenSSL library can be take some configuration parameters from the
diff --git a/engines/e_ossltest.c b/engines/e_ossltest.c
index df2a3e14e8..15a7d75f1e 100644
--- a/engines/e_ossltest.c
+++ b/engines/e_ossltest.c
@@ -37,9 +37,14 @@
 #include &lt;openssl/aes.h&gt;
 #include &lt;openssl/rand.h&gt;
 #include &lt;openssl/crypto.h&gt;
+#include &lt;openssl/pem.h&gt;
 
 #include &quot;e_ossltest_err.c&quot;
 
+#ifdef _WIN32
+# define strncasecmp _strnicmp
+#endif
+
 /* Engine Id and Name */
 static const char *engine_ossltest_id = &quot;ossltest&quot;;
 static const char *engine_ossltest_name = &quot;OpenSSL Test engine support&quot;;
@@ -317,6 +322,43 @@ static void destroy_ciphers(void)
     _hidden_aes_128_cbc = NULL;
 }
 
+/* Key loading */
+static EVP_PKEY *load_key(ENGINE *eng, const char *key_id, int pub,
+                          UI_METHOD *ui_method, void *ui_data)
+{
+    BIO *in;
+    EVP_PKEY *key;
+
+    if (strncasecmp(key_id, &quot;ot:&quot;, 3) != 0)
+        return NULL;
+    key_id += 3;
+
+    fprintf(stderr, &quot;[ossltest]Loading %s key %s\n&quot;,
+            pub ? &quot;Public&quot; : &quot;Private&quot;, key_id);
+    in = BIO_new_file(key_id, &quot;r&quot;);
+    if (!in)
+        return NULL;
+    if (pub)
+        key = PEM_read_bio_PUBKEY(in, NULL, 0, NULL);
+    else
+        key = PEM_read_bio_PrivateKey(in, NULL, 0, NULL);
+    BIO_free(in);
+    return key;
+}
+
+static EVP_PKEY *ossltest_load_privkey(ENGINE *eng, const char *key_id,
+                                       UI_METHOD *ui_method, void *ui_data)
+{
+    return load_key(eng, key_id, 0, ui_method, ui_data);
+}
+
+static EVP_PKEY *ossltest_load_pubkey(ENGINE *eng, const char *key_id,
+                                      UI_METHOD *ui_method, void *ui_data)
+{
+    return load_key(eng, key_id, 1, ui_method, ui_data);
+}
+
+
 static int bind_ossltest(ENGINE *e)
 {
     /* Ensure the ossltest error handling is set up */
@@ -328,6 +370,8 @@ static int bind_ossltest(ENGINE *e)
         || !ENGINE_set_ciphers(e, ossltest_ciphers)
         || !ENGINE_set_RAND(e, ossltest_rand_method())
         || !ENGINE_set_destroy_function(e, ossltest_destroy)
+        || !ENGINE_set_load_privkey_function(e, ossltest_load_privkey)
+        || !ENGINE_set_load_pubkey_function(e, ossltest_load_pubkey)
         || !ENGINE_set_init_function(e, ossltest_init)
         || !ENGINE_set_finish_function(e, ossltest_finish)) {
         OSSLTESTerr(OSSLTEST_F_BIND_OSSLTEST, OSSLTEST_R_INIT_FAILED);
diff --git a/test/recipes/90-test_store.t b/test/recipes/90-test_store.t
index 05e4b341f5..a36a59fd8b 100644
--- a/test/recipes/90-test_store.t
+++ b/test/recipes/90-test_store.t
@@ -9,7 +9,8 @@
 use File::Spec::Functions;
 use File::Copy;
 use MIME::Base64;
-use OpenSSL::Test qw(:DEFAULT srctop_file srctop_dir bldtop_file data_file);
+use OpenSSL::Test qw(:DEFAULT srctop_file srctop_dir bldtop_file bldtop_dir
+                     data_file);
 use OpenSSL::Test::Utils;
 
 my $test_name = &quot;test_store&quot;;
@@ -31,6 +32,9 @@ my @src_files =
       &quot;test/testrsapub.pem&quot;,
       &quot;test/testcrl.pem&quot;,
       &quot;apps/server.pem&quot; );
+my @src_rsa_files =
+    ( &quot;test/testrsa.pem&quot;,
+      &quot;test/testrsapub.pem&quot; );
 my @generated_files =
     (
      ### generated from the source files
@@ -106,11 +110,46 @@ my $n = scalar @methods
         + 3
         + 11 );
 
+my $do_test_ossltest_store =
+    !(disabled(&quot;engine&quot;) || disabled(&quot;dynamic-engine&quot;));
+
+if ($do_test_ossltest_store) {
+    # test loading with apps 'org.openssl.engine:' loader, using the
+    # ossltest engine.
+    $n += 4 * scalar @src_rsa_files;
+}
+
 plan skip_all =&gt; &quot;No plan&quot; if $n == 0;
 
 plan tests =&gt; $n;
 
 indir &quot;store_$$&quot; =&gt; sub {
+    if ($do_test_ossltest_store) {
+        # ossltest loads PEM files, with names prefixed with 'ot:'.
+        # This prefix ensures that the files are, in fact, loaded through
+        # that engine and not mistakenly going through the 'file:' loader.
+
+        my $engine_scheme = 'org.openssl.engine:';
+        $ENV{OPENSSL_ENGINES} = bldtop_dir(&quot;engines&quot;);
+
+        foreach (@src_rsa_files) {
+            my $file = srctop_file($_);
+            my $file_abs = to_abs_file($file);
+            my @pubin = $_ =~ m|pub\.pem$| ? (&quot;-pubin&quot;) : ();
+
+            ok(run(app([&quot;openssl&quot;, &quot;rsa&quot;, &quot;-text&quot;, &quot;-noout&quot;, @pubin,
+                        &quot;-engine&quot;, &quot;ossltest&quot;, &quot;-inform&quot;, &quot;engine&quot;,
+                        &quot;-in&quot;, &quot;ot:$file&quot;])));
+            ok(run(app([&quot;openssl&quot;, &quot;rsa&quot;, &quot;-text&quot;, &quot;-noout&quot;, @pubin,
+                        &quot;-engine&quot;, &quot;ossltest&quot;, &quot;-inform&quot;, &quot;engine&quot;,
+                        &quot;-in&quot;, &quot;ot:$file_abs&quot;])));
+            ok(run(app([&quot;openssl&quot;, &quot;rsa&quot;, &quot;-text&quot;, &quot;-noout&quot;, @pubin,
+                        &quot;-in&quot;, &quot;${engine_scheme}ossltest:ot:$file&quot;])));
+            ok(run(app([&quot;openssl&quot;, &quot;rsa&quot;, &quot;-text&quot;, &quot;-noout&quot;, @pubin,
+                        &quot;-in&quot;, &quot;${engine_scheme}ossltest:ot:$file_abs&quot;])));
+        }
+    }
+
  SKIP:
     {
         init() or die &quot;init failed&quot;;
</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="032486.html">[openssl]  master update
</A></li>
	<LI>Next message: <A HREF="032489.html">[openssl]  master update
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#32488">[ date ]</a>
              <a href="thread.html#32488">[ thread ]</a>
              <a href="subject.html#32488">[ subject ]</a>
              <a href="author.html#32488">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="../../../mailman/listinfo/openssl-commits.html">More information about the openssl-commits
mailing list</a><br>
</body></html>
