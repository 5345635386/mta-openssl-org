<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [openssl]  master update
   </TITLE>
   <LINK REL="Index" HREF="https://mta.openssl.org/pipermail/openssl-commits/2020-December/index.html" >
   <LINK REL="made" HREF="mailto:openssl-commits%40openssl.org?Subject=Re%3A%20%5Bopenssl%5D%20%20master%20update&In-Reply-To=%3C1608024146.296724.29422.nullmailer%40dev.openssl.org%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="032628.html">
   <LINK REL="Next"  HREF="032634.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[openssl]  master update</H1>
    <B>beldmit at gmail.com</B> 
    <A HREF="mailto:openssl-commits%40openssl.org?Subject=Re%3A%20%5Bopenssl%5D%20%20master%20update&In-Reply-To=%3C1608024146.296724.29422.nullmailer%40dev.openssl.org%3E"
       TITLE="[openssl]  master update">beldmit at gmail.com
       </A><BR>
    <I>Tue Dec 15 09:22:26 UTC 2020</I>
    <P><UL>
        <LI>Previous message: <A HREF="032628.html">[openssl]  master update
</A></li>
        <LI>Next message: <A HREF="032634.html">[openssl]  master update
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#32633">[ date ]</a>
              <a href="thread.html#32633">[ thread ]</a>
              <a href="subject.html#32633">[ subject ]</a>
              <a href="author.html#32633">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>The branch master has been updated
       via  249d559545ab61dcec5089db3380d19b0ab5cb42 (commit)
       via  a08489e241501303c487ea84ca30acecfc271f28 (commit)
       via  8ce7579d7dd2060ac43c6c621b018b65af10bff0 (commit)
       via  a61fba5da6eec31d7b790602c1e21f06d722cdaa (commit)
       via  cb75a155b67942d32b808031199a7c947098e1e6 (commit)
       via  908465be599df1531457a476fc3a894c7dfbc6c8 (commit)
      from  52c6c12c1cad6f1046b34f4139d1aa3e967a5530 (commit)


- Log -----------------------------------------------------------------
commit 249d559545ab61dcec5089db3380d19b0ab5cb42
Author: Dmitry Belyavskiy &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">beldmit at gmail.com</A>&gt;
Date:   Sat Dec 12 06:23:20 2020 +0100

    Skip tests depending on deprecated list -*-commands options
    
    Reviewed-by: Paul Dale &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">paul.dale at oracle.com</A>&gt;
    (Merged from <A HREF="https://github.com/openssl/openssl/pull/13669">https://github.com/openssl/openssl/pull/13669</A>)

commit a08489e241501303c487ea84ca30acecfc271f28
Author: Dmitry Belyavskiy &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">beldmit at gmail.com</A>&gt;
Date:   Fri Dec 11 06:15:04 2020 +0100

    Documenting the options deprecating in CHANGES.md
    
    Reviewed-by: Paul Dale &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">paul.dale at oracle.com</A>&gt;
    (Merged from <A HREF="https://github.com/openssl/openssl/pull/13669">https://github.com/openssl/openssl/pull/13669</A>)

commit 8ce7579d7dd2060ac43c6c621b018b65af10bff0
Author: Dmitry Belyavskiy &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">beldmit at gmail.com</A>&gt;
Date:   Fri Dec 11 06:13:41 2020 +0100

    Documenting the options deprecating
    
    Reviewed-by: Paul Dale &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">paul.dale at oracle.com</A>&gt;
    (Merged from <A HREF="https://github.com/openssl/openssl/pull/13669">https://github.com/openssl/openssl/pull/13669</A>)

commit a61fba5da6eec31d7b790602c1e21f06d722cdaa
Author: Dmitry Belyavskiy &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">beldmit at gmail.com</A>&gt;
Date:   Fri Dec 11 03:15:09 2020 +0100

    Skip unavailable digests and ciphers in -*-commands
    
    Fixes #13594
    
    Reviewed-by: Paul Dale &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">paul.dale at oracle.com</A>&gt;
    (Merged from <A HREF="https://github.com/openssl/openssl/pull/13669">https://github.com/openssl/openssl/pull/13669</A>)

commit cb75a155b67942d32b808031199a7c947098e1e6
Author: Dmitry Belyavskiy &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">beldmit at gmail.com</A>&gt;
Date:   Fri Dec 11 01:31:30 2020 +0100

    Deprecate -cipher-commands and -digest-commands options
    
    Reviewed-by: Paul Dale &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">paul.dale at oracle.com</A>&gt;
    (Merged from <A HREF="https://github.com/openssl/openssl/pull/13669">https://github.com/openssl/openssl/pull/13669</A>)

commit 908465be599df1531457a476fc3a894c7dfbc6c8
Author: Dmitry Belyavskiy &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">beldmit at gmail.com</A>&gt;
Date:   Fri Dec 11 01:23:02 2020 +0100

    OPENSSL_NO_GOST has nothing to do with low-level algos
    
    Reviewed-by: Paul Dale &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">paul.dale at oracle.com</A>&gt;
    (Merged from <A HREF="https://github.com/openssl/openssl/pull/13669">https://github.com/openssl/openssl/pull/13669</A>)

-----------------------------------------------------------------------

Summary of changes:
 CHANGES.md                   |  6 +++++
 apps/include/apps.h          |  2 ++
 apps/lib/engine.c            | 28 +++++++++++++++++++++++
 apps/list.c                  | 53 ++++++++++++++++++++++++++++++++++++++++++--
 apps/progs.pl                |  1 -
 doc/man1/openssl-list.pod.in | 21 +++++++++++++-----
 test/recipes/20-test_enc.t   |  2 ++
 7 files changed, 104 insertions(+), 9 deletions(-)

diff --git a/CHANGES.md b/CHANGES.md
index b099baa27a..e31ee42db3 100644
--- a/CHANGES.md
+++ b/CHANGES.md
@@ -23,6 +23,12 @@ OpenSSL 3.0
 
 ### Changes between 1.1.1 and 3.0 [xx XXX xxxx]
 
+ * The -cipher-commands and -digest-commands options of the command line
+   utility list has been deprecated.
+   Instead use the -cipher-algorithms and -digest-algorithms options.
+
+   *Dmitry Belyavskiy*
+
  * Deprecated all the libcrypto and libssl error string loading
    functions: ERR_load_ASN1_strings(), ERR_load_ASYNC_strings(),
    ERR_load_BIO_strings(), ERR_load_BN_strings(), ERR_load_BUF_strings(),
diff --git a/apps/include/apps.h b/apps/include/apps.h
index ddfa3c8383..0a8d6f4060 100644
--- a/apps/include/apps.h
+++ b/apps/include/apps.h
@@ -159,6 +159,8 @@ int finish_engine(ENGINE *e);
 char *make_engine_uri(ENGINE *e, const char *key_id, const char *desc);
 
 int get_legacy_pkey_id(OSSL_LIB_CTX *libctx, const char *algname, ENGINE *e);
+const EVP_MD *get_digest_from_engine(const char *name);
+const EVP_CIPHER *get_cipher_from_engine(const char *name);
 
 # ifndef OPENSSL_NO_OCSP
 OCSP_RESPONSE *process_responder(OCSP_REQUEST *req,
diff --git a/apps/lib/engine.c b/apps/lib/engine.c
index e4a65b04e2..209c4b6b03 100644
--- a/apps/lib/engine.c
+++ b/apps/lib/engine.c
@@ -163,3 +163,31 @@ int get_legacy_pkey_id(OSSL_LIB_CTX *libctx, const char *algname, ENGINE *e)
 
     return pkey_id;
 }
+
+const EVP_MD *get_digest_from_engine(const char *name)
+{
+#ifndef OPENSSL_NO_ENGINE
+    ENGINE *eng;
+
+    eng = ENGINE_get_digest_engine(OBJ_sn2nid(name));
+    if (eng != NULL) {
+        ENGINE_finish(eng);
+        return EVP_get_digestbyname(name);
+    }
+#endif
+    return NULL;
+}
+
+const EVP_CIPHER *get_cipher_from_engine(const char *name)
+{
+#ifndef OPENSSL_NO_ENGINE
+    ENGINE *eng;
+
+    eng = ENGINE_get_cipher_engine(OBJ_sn2nid(name));
+    if (eng != NULL) {
+        ENGINE_finish(eng);
+        return EVP_get_cipherbyname(name);
+    }
+#endif
+    return NULL;
+}
diff --git a/apps/list.c b/apps/list.c
index 20973298a8..df25e00363 100644
--- a/apps/list.c
+++ b/apps/list.c
@@ -945,6 +945,38 @@ static void list_options_for_command(const char *command)
     BIO_printf(bio_out, &quot;- -\n&quot;);
 }
 
+static int is_md_available(const char *name)
+{
+    EVP_MD *md;
+
+    /* Look through providers' digests */
+    ERR_set_mark();
+    md = EVP_MD_fetch(NULL, name, NULL);
+    ERR_pop_to_mark();
+    if (md != NULL) {
+        EVP_MD_free(md);
+        return 1;
+    }
+
+    return (get_digest_from_engine(name) == NULL) ? 0 : 1;
+}
+
+static int is_cipher_available(const char *name)
+{
+    EVP_CIPHER *cipher;
+
+    /* Look through providers' ciphers */
+    ERR_set_mark();
+    cipher = EVP_CIPHER_fetch(NULL, name, NULL);
+    ERR_pop_to_mark();
+    if (cipher != NULL) {
+        EVP_CIPHER_free(cipher);
+        return 1;
+    }
+
+    return (get_cipher_from_engine(name) == NULL) ? 0 : 1;
+}
+
 static void list_type(FUNC_TYPE ft, int one)
 {
     FUNCTION *fp;
@@ -958,6 +990,18 @@ static void list_type(FUNC_TYPE ft, int one)
     for (fp = functions; fp-&gt;name != NULL; fp++) {
         if (fp-&gt;type != ft)
             continue;
+        switch (ft) {
+        case FT_cipher:
+            if (!is_cipher_available(fp-&gt;name))
+                continue;
+            break;
+        case FT_md:
+            if (!is_md_available(fp-&gt;name))
+                continue;
+            break;
+        default:
+            break;
+        }
         if (one) {
             BIO_printf(bio_out, &quot;%s\n&quot;, fp-&gt;name);
         } else {
@@ -1295,8 +1339,10 @@ const OPTIONS list_options[] = {
     {&quot;select&quot;, OPT_SELECT_NAME, 's', &quot;Select a single algorithm&quot;},
     {&quot;commands&quot;, OPT_COMMANDS, '-', &quot;List of standard commands&quot;},
     {&quot;standard-commands&quot;, OPT_COMMANDS, '-', &quot;List of standard commands&quot;},
+#ifndef OPENSSL_NO_DEPRECATED_3_0
     {&quot;digest-commands&quot;, OPT_DIGEST_COMMANDS, '-',
-     &quot;List of message digest commands&quot;},
+     &quot;List of message digest commands (deprecated)&quot;},
+#endif
     {&quot;digest-algorithms&quot;, OPT_DIGEST_ALGORITHMS, '-',
      &quot;List of message digest algorithms&quot;},
     {&quot;kdf-algorithms&quot;, OPT_KDF_ALGORITHMS, '-',
@@ -1307,7 +1353,10 @@ const OPTIONS list_options[] = {
      &quot;List of random number generators&quot;},
     {&quot;mac-algorithms&quot;, OPT_MAC_ALGORITHMS, '-',
      &quot;List of message authentication code algorithms&quot;},
-    {&quot;cipher-commands&quot;, OPT_CIPHER_COMMANDS, '-', &quot;List of cipher commands&quot;},
+#ifndef OPENSSL_NO_DEPRECATED_3_0
+    {&quot;cipher-commands&quot;, OPT_CIPHER_COMMANDS, '-', 
+    &quot;List of cipher commands (deprecated)&quot;},
+#endif
     {&quot;cipher-algorithms&quot;, OPT_CIPHER_ALGORITHMS, '-',
      &quot;List of cipher algorithms&quot;},
     {&quot;encoders&quot;, OPT_ENCODERS, '-', &quot;List of encoding methods&quot; },
diff --git a/apps/progs.pl b/apps/progs.pl
index 3ddb713238..a03b83139c 100644
--- a/apps/progs.pl
+++ b/apps/progs.pl
@@ -150,7 +150,6 @@ EOF
     );
     foreach my $cmd (
         &quot;md2&quot;, &quot;md4&quot;, &quot;md5&quot;,
-        &quot;gost&quot;,
         &quot;sha1&quot;, &quot;sha224&quot;, &quot;sha256&quot;, &quot;sha384&quot;,
         &quot;sha512&quot;, &quot;sha512-224&quot;, &quot;sha512-256&quot;,
         &quot;sha3-224&quot;, &quot;sha3-256&quot;, &quot;sha3-384&quot;, &quot;sha3-512&quot;,
diff --git a/doc/man1/openssl-list.pod.in b/doc/man1/openssl-list.pod.in
index 7d7ba6504e..b06478e711 100644
--- a/doc/man1/openssl-list.pod.in
+++ b/doc/man1/openssl-list.pod.in
@@ -14,13 +14,17 @@ B&lt;openssl list&gt;
 [B&lt;-1&gt;]
 [B&lt;-commands&gt;]
 [B&lt;-digest-commands&gt;]
-[B&lt;-digest-algorithms&gt;]
-[B&lt;-kdf-algorithms&gt;]
+{- output_off() if $disabled{&quot;deprecated-3.0&quot;}; &quot;&quot;
+-}[B&lt;-digest-algorithms&gt;]
+{- output_on() if $disabled{&quot;deprecated-3.0&quot;}; &quot;&quot;
+-}[B&lt;-kdf-algorithms&gt;]
 [B&lt;-mac-algorithms&gt;]
 [B&lt;-random-generators&gt;]
 [B&lt;-cipher-commands&gt;]
-[B&lt;-cipher-algorithms&gt;]
-[B&lt;-encoders&gt;]
+{- output_off() if $disabled{&quot;deprecated-3.0&quot;}; &quot;&quot;
+-}[B&lt;-cipher-algorithms&gt;]
+{- output_on() if $disabled{&quot;deprecated-3.0&quot;}; &quot;&quot;
+-}[B&lt;-encoders&gt;]
 [B&lt;-decoders&gt;]
 [B&lt;-key-managers&gt;]
 [B&lt;-key-exchange-algorithms&gt;]
@@ -71,13 +75,17 @@ Display a list of standard commands.
 
 =item B&lt;-digest-commands&gt;
 
+This option is deprecated. Use B&lt;digest-algorithms&gt; instead.
+
 Display a list of message digest commands, which are typically used
 as input to the L&lt;openssl-dgst(1)&gt; or L&lt;openssl-speed(1)&gt; commands.
 
 =item B&lt;-cipher-commands&gt;
 
+This option is deprecated. Use B&lt;cipher-algorithms&gt; instead.
+
 Display a list of cipher commands, which are typically used as input
-to the L&lt;openssl-dgst(1)&gt; or L&lt;openssl-speed(1)&gt; commands.
+to the L&lt;openssl-enc(1)&gt; or L&lt;openssl-speed(1)&gt; commands.
 
 =item B&lt;-digest-algorithms&gt;, B&lt;-kdf-algorithms&gt;, B&lt;-mac-algorithms&gt;,
 B&lt;-cipher-algorithms&gt;
@@ -209,7 +217,8 @@ In both cases, C&lt;bar&gt; is the name of the provider.
 
 =head1 HISTORY
 
-The B&lt;-engines&gt; option was deprecated in OpenSSL 3.0.
+The B&lt;-engines&gt;, B&lt;-digest-commands&gt;, and B&lt;-cipher-commands&gt; options
+were deprecated in OpenSSL 3.0.
 
 =head1 COPYRIGHT
 
diff --git a/test/recipes/20-test_enc.t b/test/recipes/20-test_enc.t
index 8cd4cf98b7..32a62ef2fd 100644
--- a/test/recipes/20-test_enc.t
+++ b/test/recipes/20-test_enc.t
@@ -18,6 +18,8 @@ use OpenSSL::Test qw/:DEFAULT srctop_file bldtop_dir/;
 use OpenSSL::Test::Utils;
 
 setup(&quot;test_enc&quot;);
+plan skip_all =&gt; &quot;Deprecated functions are disabled in this OpenSSL build&quot;
+    if disabled(&quot;deprecated&quot;);
 
 # We do it this way, because setup() may have moved us around,
 # so the directory portion of $0 might not be correct any more.
</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="032628.html">[openssl]  master update
</A></li>
	<LI>Next message: <A HREF="032634.html">[openssl]  master update
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#32633">[ date ]</a>
              <a href="thread.html#32633">[ thread ]</a>
              <a href="subject.html#32633">[ subject ]</a>
              <a href="author.html#32633">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="../../../mailman/listinfo/openssl-commits.html">More information about the openssl-commits
mailing list</a><br>
</body></html>
