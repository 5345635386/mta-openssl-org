<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [openssl-commits] [openssl]  master update
   </TITLE>
   <LINK REL="Index" HREF="https://mta.openssl.org/pipermail/openssl-commits/2017-June/index.html" >
   <LINK REL="made" HREF="mailto:openssl-commits%40openssl.org?Subject=Re%3A%20%5Bopenssl-commits%5D%20%5Bopenssl%5D%20%20master%20update&In-Reply-To=%3C1497926820.288409.17938.nullmailer%40dev.openssl.org%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="015102.html">
   <LINK REL="Next"  HREF="015114.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[openssl-commits] [openssl]  master update</H1>
    <B>Rich Salz</B> 
    <A HREF="mailto:openssl-commits%40openssl.org?Subject=Re%3A%20%5Bopenssl-commits%5D%20%5Bopenssl%5D%20%20master%20update&In-Reply-To=%3C1497926820.288409.17938.nullmailer%40dev.openssl.org%3E"
       TITLE="[openssl-commits] [openssl]  master update">rsalz at openssl.org
       </A><BR>
    <I>Tue Jun 20 02:47:00 UTC 2017</I>
    <P><UL>
        <LI>Previous message: <A HREF="015102.html">[openssl-commits] [openssl]  master update
</A></li>
        <LI>Next message: <A HREF="015114.html">[openssl-commits] [openssl]  master update
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#15112">[ date ]</a>
              <a href="thread.html#15112">[ thread ]</a>
              <a href="subject.html#15112">[ subject ]</a>
              <a href="author.html#15112">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>The branch master has been updated
       via  4f58c6b9febddb5bb074dff44bdc4c013cdb9544 (commit)
       via  a7b68c5b246dcad44270c321d6734b0a10c2633d (commit)
       via  6e5e196748b3dbfd2919b23e5b21688885e72881 (commit)
       via  8fe3127cda7ee89e169184eeeaaca5eebcf8664e (commit)
      from  f39a5501ce69cab0c7282f5dcbf2b80d8ee259f2 (commit)


- Log -----------------------------------------------------------------
commit 4f58c6b9febddb5bb074dff44bdc4c013cdb9544
Author: Pauli &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">paul.dale at oracle.com</A>&gt;
Date:   Tue Jun 20 07:58:51 2017 +1000

    Address style issues.
    Refactor count -&gt; c which makes the for loop more readable.
    
    Reviewed-by: Tim Hudson &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">tjh at openssl.org</A>&gt;
    Reviewed-by: Rich Salz &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">rsalz at openssl.org</A>&gt;
    (Merged from <A HREF="https://github.com/openssl/openssl/pull/3710">https://github.com/openssl/openssl/pull/3710</A>)

commit a7b68c5b246dcad44270c321d6734b0a10c2633d
Author: Pauli &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">paul.dale at oracle.com</A>&gt;
Date:   Tue Jun 20 07:58:14 2017 +1000

    Address double error and OSSLzu comments.
    
    Reviewed-by: Tim Hudson &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">tjh at openssl.org</A>&gt;
    Reviewed-by: Rich Salz &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">rsalz at openssl.org</A>&gt;
    (Merged from <A HREF="https://github.com/openssl/openssl/pull/3710">https://github.com/openssl/openssl/pull/3710</A>)

commit 6e5e196748b3dbfd2919b23e5b21688885e72881
Author: Pauli &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">paul.dale at oracle.com</A>&gt;
Date:   Mon Jun 19 11:49:27 2017 +1000

    Put error output back.
    
    Reviewed-by: Tim Hudson &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">tjh at openssl.org</A>&gt;
    Reviewed-by: Rich Salz &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">rsalz at openssl.org</A>&gt;
    (Merged from <A HREF="https://github.com/openssl/openssl/pull/3710">https://github.com/openssl/openssl/pull/3710</A>)

commit 8fe3127cda7ee89e169184eeeaaca5eebcf8664e
Author: Pauli &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">paul.dale at oracle.com</A>&gt;
Date:   Mon Jun 19 11:21:22 2017 +1000

    Update tests to avoid printf to stdout/stderr when running as test cases.
    
    Reviewed-by: Tim Hudson &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">tjh at openssl.org</A>&gt;
    Reviewed-by: Rich Salz &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">rsalz at openssl.org</A>&gt;
    (Merged from <A HREF="https://github.com/openssl/openssl/pull/3710">https://github.com/openssl/openssl/pull/3710</A>)

-----------------------------------------------------------------------

Summary of changes:
 test/asn1_encode_test.c    | 47 ++++++++++++++-------------------
 test/asn1_internal_test.c  | 22 ++++++++--------
 test/d2i_test.c            |  6 ++---
 test/enginetest.c          |  8 +++---
 test/evp_test.c            |  8 +++---
 test/lhash_test.c          | 16 +++++------
 test/pkey_meth_test.c      |  8 ++----
 test/ssl_test.c            | 25 +++++++++---------
 test/ssl_test_ctx.c        | 36 ++++++++++++-------------
 test/testutil.h            |  4 ++-
 test/testutil/tests.c      | 11 ++++++++
 test/tls13encryptiontest.c |  4 +--
 test/x509_internal_test.c  |  8 ++----
 test/x509aux.c             | 66 ++++++++++++++++++++++------------------------
 14 files changed, 131 insertions(+), 138 deletions(-)

diff --git a/test/asn1_encode_test.c b/test/asn1_encode_test.c
index 0c3a196..3da0750 100644
--- a/test/asn1_encode_test.c
+++ b/test/asn1_encode_test.c
@@ -712,14 +712,12 @@ static int do_print_item(const TEST_PACKAGE *package)
     unsigned char buf[DATA_BUF_SIZE];
     const ASN1_ITEM *i = ASN1_ITEM_ptr(package-&gt;asn1_type);
     ASN1_VALUE *o = (ASN1_VALUE *)&buf;
-    BIO *bio = BIO_new_fp(stdout, 0);
     int ret;
 
     OPENSSL_assert(package-&gt;encode_expectations_elem_size &lt;= DATA_BUF_SIZE);
 
     (void)RAND_bytes(buf, (int)package-&gt;encode_expectations_elem_size);
-    ret = ASN1_item_print(bio, o, 0, i, NULL);
-    BIO_free(bio);
+    ret = ASN1_item_print(bio_out, o, 0, i, NULL);
 
     return ret;
 }
@@ -745,18 +743,16 @@ static int test_intern(const TEST_PACKAGE *package)
                                                -&gt;encode_expectations)[pos],
                                  &amp;test_custom_data[i], package)) {
         case -1:
-            fprintf(stderr, &quot;Failed custom encode round trip %u of %s\n&quot;,
-                    i, package-&gt;name);
-            ERR_print_errors_fp(stderr);
+            TEST_error(&quot;Failed custom encode round trip %u of %s&quot;,
+                       i, package-&gt;name);
+            TEST_openssl_errors();
             fail++;
-            ERR_clear_error();
             break;
         case 0:
-            fprintf(stderr, &quot;Custom encode round trip %u of %s mismatch\n&quot;,
-                    i, package-&gt;name);
-            ERR_print_errors_fp(stderr);
+            TEST_error(&quot;Custom encode round trip %u of %s mismatch&quot;,
+                       i, package-&gt;name);
+            TEST_openssl_errors();
             fail++;
-            ERR_clear_error();
             break;
         case 1:
             break;
@@ -770,18 +766,16 @@ static int test_intern(const TEST_PACKAGE *package)
                                  package-&gt;encode_expectations_elem_size,
                                  package)) {
         case -1:
-            fprintf(stderr, &quot;Failed custom decode round trip %u of %s\n&quot;,
-                    i, package-&gt;name);
-            ERR_print_errors_fp(stderr);
+            TEST_error(&quot;Failed custom decode round trip %u of %s&quot;,
+                       i, package-&gt;name);
+            TEST_openssl_errors();
             fail++;
-            ERR_clear_error();
             break;
         case 0:
-            fprintf(stderr, &quot;Custom decode round trip %u of %s mismatch\n&quot;,
-                    i, package-&gt;name);
-            ERR_print_errors_fp(stderr);
+            TEST_error(&quot;Custom decode round trip %u of %s mismatch&quot;,
+                       i, package-&gt;name);
+            TEST_openssl_errors();
             fail++;
-            ERR_clear_error();
             break;
         case 1:
             break;
@@ -800,15 +794,14 @@ static int test_intern(const TEST_PACKAGE *package)
                            package-&gt;encdec_data_elem_size,
                            package)) {
         case -1:
-            fprintf(stderr, &quot;Failed encode/decode round trip %u of %s\n&quot;,
-                    i, package-&gt;name);
-            ERR_print_errors_fp(stderr);
-            ERR_clear_error();
+            TEST_error(&quot;Failed encode/decode round trip %u of %s&quot;,
+                       i, package-&gt;name);
+            TEST_openssl_errors();
             fail++;
             break;
         case 0:
-            fprintf(stderr, &quot;Encode/decode round trip %u of %s mismatch\n&quot;,
-                    i, package-&gt;name);
+            TEST_error(&quot;Encode/decode round trip %u of %s mismatch&quot;,
+                       i, package-&gt;name);
             fail++;
             break;
         case 1:
@@ -820,8 +813,8 @@ static int test_intern(const TEST_PACKAGE *package)
     }
 
     if (!do_print_item(package)) {
-        fprintf(stderr, &quot;Printing of %s failed\n&quot;, package-&gt;name);
-        ERR_print_errors_fp(stderr);
+        TEST_error(&quot;Printing of %s failed&quot;, package-&gt;name);
+        TEST_openssl_errors();
         fail++;
     }
 
diff --git a/test/asn1_internal_test.c b/test/asn1_internal_test.c
index f9fdeef..38ef610 100644
--- a/test/asn1_internal_test.c
+++ b/test/asn1_internal_test.c
@@ -1,5 +1,5 @@
 /*
- * Copyright 1999-2016 The OpenSSL Project Authors. All Rights Reserved.
+ * Copyright 1999-2017 The OpenSSL Project Authors. All Rights Reserved.
  *
  * Licensed under the OpenSSL license (the &quot;License&quot;).  You may not use
  * this file except in compliance with the License.  You can obtain a copy
@@ -40,14 +40,15 @@ static int test_tbl_standard()
         last_nid = tmp-&gt;nid;
     }
 
-    if (last_nid != 0) {
-        fprintf(stderr, &quot;asn1 tbl_standard: Table order OK\n&quot;);
+    if (TEST_int_ne(last_nid, 0)) {
+        TEST_info(&quot;asn1 tbl_standard: Table order OK&quot;);
         return 1;
     }
 
+    TEST_info(&quot;asn1 tbl_standard: out of order&quot;);
     for (tmp = tbl_standard, i = 0; i &lt; OSSL_NELEM(tbl_standard); i++, tmp++)
-        fprintf(stderr, &quot;asn1 tbl_standard: Index %&quot; OSSLzu &quot;, NID %d, Name=%s\n&quot;,
-                i, tmp-&gt;nid, OBJ_nid2ln(tmp-&gt;nid));
+        TEST_note(&quot;asn1 tbl_standard: Index %zu, NID %d, Name=%s&quot;,
+                  i, tmp-&gt;nid, OBJ_nid2ln(tmp-&gt;nid));
 
     return 0;
 }
@@ -76,17 +77,16 @@ static int test_standard_methods()
         last_pkey_id = (*tmp)-&gt;pkey_id;
     }
 
-    if (last_pkey_id != 0) {
-        fprintf(stderr, &quot;asn1 standard methods: Table order OK\n&quot;);
+    if (TEST_int_ne(last_pkey_id, 0)) {
+        TEST_info(&quot;asn1 standard methods: Table order OK&quot;);
         return 1;
     }
 
-    TEST_error(&quot;asn1 standard methods out of order&quot;);
+    TEST_note(&quot;asn1 standard methods: out of order&quot;);
     for (tmp = standard_methods, i = 0; i &lt; OSSL_NELEM(standard_methods);
          i++, tmp++)
-        fprintf(stderr, &quot;asn1 standard methods: Index %&quot; OSSLzu
-                &quot;, pkey ID %d, Name=%s\n&quot;, i, (*tmp)-&gt;pkey_id,
-                OBJ_nid2sn((*tmp)-&gt;pkey_id));
+        TEST_note(&quot;asn1 standard methods: Index %zu, pkey ID %d, Name=%s&quot;,
+                  i, (*tmp)-&gt;pkey_id, OBJ_nid2sn((*tmp)-&gt;pkey_id));
 
     return 0;
 }
diff --git a/test/d2i_test.c b/test/d2i_test.c
index 8126ace..58fbe4a 100644
--- a/test/d2i_test.c
+++ b/test/d2i_test.c
@@ -137,14 +137,14 @@ int test_main(int argc, char *argv[])
     item_type = ASN1_ITEM_lookup(test_type_name);
 
     if (item_type == NULL) {
-        TEST_error(&quot;Unknown type %s\n&quot;, test_type_name);
-        fprintf(stderr, &quot;Supported types:\n&quot;);
+        TEST_error(&quot;Unknown type %s&quot;, test_type_name);
+        TEST_note(&quot;Supported types:&quot;);
         for (i = 0;; i++) {
             const ASN1_ITEM *it = ASN1_ITEM_get(i);
 
             if (it == NULL)
                 break;
-            fprintf(stderr, &quot;\t%s\n&quot;, it-&gt;sname);
+            TEST_note(&quot;\t%s&quot;, it-&gt;sname);
         }
         return 1;
     }
diff --git a/test/enginetest.c b/test/enginetest.c
index 55bb4e0..d50e418 100644
--- a/test/enginetest.c
+++ b/test/enginetest.c
@@ -1,5 +1,5 @@
 /*
- * Copyright 2000-2016 The OpenSSL Project Authors. All Rights Reserved.
+ * Copyright 2000-2017 The OpenSSL Project Authors. All Rights Reserved.
  *
  * Licensed under the OpenSSL license (the &quot;License&quot;).  You may not use
  * this file except in compliance with the License.  You can obtain a copy
@@ -151,9 +151,9 @@ static int test_engines(void)
     }
     for (loop = 0; loop &lt; NUMTOADD; loop++) {
         if (!TEST_true(ENGINE_add(block[loop]))) {
-            printf(&quot;Adding stopped at %d, (%s,%s)&quot;,
-                   loop, ENGINE_get_id(block[loop]),
-                   ENGINE_get_name(block[loop]));
+            test_note(&quot;Adding stopped at %d, (%s,%s)&quot;,
+                      loop, ENGINE_get_id(block[loop]),
+                      ENGINE_get_name(block[loop]));
             goto cleanup_loop;
         }
     }
diff --git a/test/evp_test.c b/test/evp_test.c
index 81232ed..36e29c4 100644
--- a/test/evp_test.c
+++ b/test/evp_test.c
@@ -284,7 +284,7 @@ static int parse_bin(const char *value, unsigned char **buf, size_t *buflen)
     /* Otherwise assume as hex literal and convert it to binary buffer */
     if (!TEST_ptr(*buf = OPENSSL_hexstr2buf(value, &amp;len))) {
         TEST_info(&quot;Can't convert %s&quot;, value);
-        ERR_print_errors(bio_err);
+        TEST_openssl_errors();
         return -1;
     }
     /* Size of input buffer means we'll never overflow */
@@ -2208,7 +2208,7 @@ static int run_test(EVP_TEST *t)
             return 0;
         }
         if (!check_test_error(t)) {
-            test_openssl_errors();
+            TEST_openssl_errors();
             t-&gt;s.errors++;
         }
     }
@@ -2306,7 +2306,7 @@ top:
         pkey = PEM_read_bio_PrivateKey(t-&gt;s.key, NULL, 0, NULL);
         if (pkey == NULL &amp;&amp; !key_unsupported()) {
             TEST_info(&quot;Can't read private key %s&quot;, pp-&gt;value);
-            ERR_print_errors_fp(stderr);
+            TEST_openssl_errors();
             return 0;
         }
         klist = &amp;private_keys;
@@ -2315,7 +2315,7 @@ top:
         pkey = PEM_read_bio_PUBKEY(t-&gt;s.key, NULL, 0, NULL);
         if (pkey == NULL &amp;&amp; !key_unsupported()) {
             TEST_info(&quot;Can't read public key %s&quot;, pp-&gt;value);
-            ERR_print_errors_fp(stderr);
+            TEST_openssl_errors();
             return 0;
         }
         klist = &amp;public_keys;
diff --git a/test/lhash_test.c b/test/lhash_test.c
index a0d377e..44ce623 100644
--- a/test/lhash_test.c
+++ b/test/lhash_test.c
@@ -189,10 +189,10 @@ static int test_stress(void)
     if (!TEST_int_eq(lh_int_num_items(h), n))
             goto end;
 
-    fprintf(stderr, &quot;hash full statistics:\n&quot;);
-    OPENSSL_LH_stats((OPENSSL_LHASH *)h, stderr);
-    fprintf(stderr, &quot;\nhash full node usage:\n&quot;);
-    OPENSSL_LH_node_usage_stats((OPENSSL_LHASH *)h, stderr);
+    TEST_info(&quot;hash full statistics:&quot;);
+    OPENSSL_LH_stats_bio((OPENSSL_LHASH *)h, bio_err);
+    TEST_note(&quot;hash full node usage:&quot;);
+    OPENSSL_LH_node_usage_stats_bio((OPENSSL_LHASH *)h, bio_err);
 
     /* delete in a different order */
     for (i = 0; i &lt; n; i++) {
@@ -209,10 +209,10 @@ static int test_stress(void)
         OPENSSL_free(p);
     }
 
-    fprintf(stderr, &quot;\nhash empty statistics:\n&quot;);
-    OPENSSL_LH_stats((OPENSSL_LHASH *)h, stderr);
-    fprintf(stderr, &quot;\nhash empty node usage:\n&quot;);
-    OPENSSL_LH_node_usage_stats((OPENSSL_LHASH *)h, stderr);
+    TEST_info(&quot;hash empty statistics:&quot;);
+    OPENSSL_LH_stats_bio((OPENSSL_LHASH *)h, bio_err);
+    TEST_note(&quot;hash empty node usage:&quot;);
+    OPENSSL_LH_node_usage_stats_bio((OPENSSL_LHASH *)h, bio_err);
 
     testresult = 1;
 end:
diff --git a/test/pkey_meth_test.c b/test/pkey_meth_test.c
index adff232..414fc3c 100644
--- a/test/pkey_meth_test.c
+++ b/test/pkey_meth_test.c
@@ -1,5 +1,5 @@
 /*
- * Copyright 2016 The OpenSSL Project Authors. All Rights Reserved.
+ * Copyright 2016-2017 The OpenSSL Project Authors. All Rights Reserved.
  *
  * Licensed under the OpenSSL license (the &quot;License&quot;).  You may not use
  * this file except in compliance with the License.  You can obtain a copy
@@ -46,13 +46,9 @@ static int test_asn1_meths()
             EVP_PKEY_asn1_get0_info(&amp;pkey_id, NULL, NULL, &amp;info, NULL, ameth);
             if (info == NULL)
                 info = &quot;&lt;NO NAME&gt;&quot;;
-            fprintf(stderr, &quot;%d : %s : %s\n&quot;, pkey_id, OBJ_nid2ln(pkey_id),
-                    info);
+            TEST_note(&quot;%d : %s : %s&quot;, pkey_id, OBJ_nid2ln(pkey_id), info);
         }
-    } else {
-        fprintf(stderr, &quot;Order OK\n&quot;);
     }
-
     return good;
 }
 
diff --git a/test/ssl_test.c b/test/ssl_test.c
index 092e755..06dd189 100644
--- a/test/ssl_test.c
+++ b/test/ssl_test.c
@@ -1,5 +1,5 @@
 /*
- * Copyright 2016 The OpenSSL Project Authors. All Rights Reserved.
+ * Copyright 2016-2017 The OpenSSL Project Authors. All Rights Reserved.
  *
  * Licensed under the OpenSSL license (the &quot;License&quot;).  You may not use
  * this file except in compliance with the License.  You can obtain a copy
@@ -196,20 +196,17 @@ static int check_nid(const char *name, int expected_nid, int nid)
 
 static void print_ca_names(STACK_OF(X509_NAME) *names)
 {
-    BIO *err;
     int i;
 
     if (names == NULL || sk_X509_NAME_num(names) == 0) {
-        fprintf(stderr, &quot;    &lt;empty&gt;\n&quot;);
+        TEST_note(&quot;    &lt;empty&gt;&quot;);
         return;
     }
-    err = BIO_new_fp(stderr, BIO_NOCLOSE);
     for (i = 0; i &lt; sk_X509_NAME_num(names); i++) {
-        X509_NAME_print_ex(err, sk_X509_NAME_value(names, i), 4,
+        X509_NAME_print_ex(bio_err, sk_X509_NAME_value(names, i), 4,
                            XN_FLAG_ONELINE);
-        BIO_puts(err, &quot;\n&quot;);
+        BIO_puts(bio_err, &quot;\n&quot;);
     }
-    BIO_free(err);
 }
 
 static int check_ca_names(const char *name,
@@ -221,23 +218,25 @@ static int check_ca_names(const char *name,
     if (expected_names == NULL)
         return 1;
     if (names == NULL || sk_X509_NAME_num(names) == 0) {
-        if (sk_X509_NAME_num(expected_names) == 0)
+        if (TEST_int_eq(sk_X509_NAME_num(expected_names), 0))
             return 1;
         goto err;
     }
     if (sk_X509_NAME_num(names) != sk_X509_NAME_num(expected_names))
         goto err;
     for (i = 0; i &lt; sk_X509_NAME_num(names); i++) {
-        if (X509_NAME_cmp(sk_X509_NAME_value(names, i),
-                          sk_X509_NAME_value(expected_names, i)) != 0) {
+        if (!TEST_int_eq(X509_NAME_cmp(sk_X509_NAME_value(names, i),
+                                       sk_X509_NAME_value(expected_names, i)),
+                         0)) {
             goto err;
         }
     }
     return 1;
-    err:
-    fprintf(stderr, &quot;%s: list mismatch\nExpected Names:\n&quot;, name);
+err:
+    TEST_info(&quot;%s: list mismatch&quot;, name);
+    TEST_note(&quot;Expected Names:&quot;);
     print_ca_names(expected_names);
-    fprintf(stderr, &quot;Received Names:\n&quot;);
+    TEST_note(&quot;Received Names:&quot;);
     print_ca_names(names);
     return 0;
 }
diff --git a/test/ssl_test_ctx.c b/test/ssl_test_ctx.c
index 424eae8..78f15ca 100644
--- a/test/ssl_test_ctx.c
+++ b/test/ssl_test_ctx.c
@@ -1,5 +1,5 @@
 /*
- * Copyright 2016 The OpenSSL Project Authors. All Rights Reserved.
+ * Copyright 2016-2017 The OpenSSL Project Authors. All Rights Reserved.
  *
  * Licensed under the OpenSSL license (the &quot;License&quot;).  You may not use
  * this file except in compliance with the License.  You can obtain a copy
@@ -690,8 +690,8 @@ static int parse_client_options(SSL_TEST_CLIENT_CONF *client, const CONF *conf,
         for (j = 0; j &lt; OSSL_NELEM(ssl_test_client_options); j++) {
             if (strcmp(option-&gt;name, ssl_test_client_options[j].name) == 0) {
                 if (!ssl_test_client_options[j].parse(client, option-&gt;value)) {
-                    fprintf(stderr, &quot;Bad value %s for option %s\n&quot;,
-                            option-&gt;value, option-&gt;name);
+                    TEST_info(&quot;Bad value %s for option %s&quot;,
+                              option-&gt;value, option-&gt;name);
                     return 0;
                 }
                 found = 1;
@@ -699,7 +699,7 @@ static int parse_client_options(SSL_TEST_CLIENT_CONF *client, const CONF *conf,
             }
         }
         if (!found) {
-            fprintf(stderr, &quot;Unknown test option: %s\n&quot;, option-&gt;name);
+            TEST_info(&quot;Unknown test option: %s&quot;, option-&gt;name);
             return 0;
         }
     }
@@ -723,8 +723,8 @@ static int parse_server_options(SSL_TEST_SERVER_CONF *server, const CONF *conf,
         for (j = 0; j &lt; OSSL_NELEM(ssl_test_server_options); j++) {
             if (strcmp(option-&gt;name, ssl_test_server_options[j].name) == 0) {
                 if (!ssl_test_server_options[j].parse(server, option-&gt;value)) {
-                    fprintf(stderr, &quot;Bad value %s for option %s\n&quot;,
-                            option-&gt;value, option-&gt;name);
+                    TEST_info(&quot;Bad value %s for option %s&quot;,
+                               option-&gt;value, option-&gt;name);
                     return 0;
                 }
                 found = 1;
@@ -732,7 +732,7 @@ static int parse_server_options(SSL_TEST_SERVER_CONF *server, const CONF *conf,
             }
         }
         if (!found) {
-            fprintf(stderr, &quot;Unknown test option: %s\n&quot;, option-&gt;name);
+            TEST_info(&quot;Unknown test option: %s&quot;, option-&gt;name);
             return 0;
         }
     }
@@ -763,20 +763,20 @@ SSL_TEST_CTX *SSL_TEST_CTX_create(const CONF *conf, const char *test_section)
                                       option-&gt;value))
                 goto err;
         } else if (strcmp(option-&gt;name, &quot;server&quot;) == 0) {
-            if (!parse_server_options(&amp;ctx-&gt;extra.server, conf,
-                                      option-&gt;value))
+            if (!TEST_true(parse_server_options(&amp;ctx-&gt;extra.server, conf,
+                                                option-&gt;value)))
                 goto err;
         } else if (strcmp(option-&gt;name, &quot;server2&quot;) == 0) {
-            if (!parse_server_options(&amp;ctx-&gt;extra.server2, conf,
-                                      option-&gt;value))
+            if (!TEST_true(parse_server_options(&amp;ctx-&gt;extra.server2, conf,
+                                                option-&gt;value)))
                 goto err;
         } else if (strcmp(option-&gt;name, &quot;resume-client&quot;) == 0) {
-            if (!parse_client_options(&amp;ctx-&gt;resume_extra.client, conf,
-                                      option-&gt;value))
+            if (!TEST_true(parse_client_options(&amp;ctx-&gt;resume_extra.client, conf,
+                                                option-&gt;value)))
                 goto err;
         } else if (strcmp(option-&gt;name, &quot;resume-server&quot;) == 0) {
-            if (!parse_server_options(&amp;ctx-&gt;resume_extra.server, conf,
-                                      option-&gt;value))
+            if (!TEST_true(parse_server_options(&amp;ctx-&gt;resume_extra.server, conf,
+                                                option-&gt;value)))
                 goto err;
         } else if (strcmp(option-&gt;name, &quot;resume-server2&quot;) == 0) {
             if (!parse_server_options(&amp;ctx-&gt;resume_extra.server2, conf,
@@ -787,8 +787,8 @@ SSL_TEST_CTX *SSL_TEST_CTX_create(const CONF *conf, const char *test_section)
             for (j = 0; j &lt; OSSL_NELEM(ssl_test_ctx_options); j++) {
                 if (strcmp(option-&gt;name, ssl_test_ctx_options[j].name) == 0) {
                     if (!ssl_test_ctx_options[j].parse(ctx, option-&gt;value)) {
-                        fprintf(stderr, &quot;Bad value %s for option %s\n&quot;,
-                                option-&gt;value, option-&gt;name);
+                        TEST_info(&quot;Bad value %s for option %s&quot;,
+                                   option-&gt;value, option-&gt;name);
                         goto err;
                     }
                     found = 1;
@@ -796,7 +796,7 @@ SSL_TEST_CTX *SSL_TEST_CTX_create(const CONF *conf, const char *test_section)
                 }
             }
             if (!found) {
-                fprintf(stderr, &quot;Unknown test option: %s\n&quot;, option-&gt;name);
+                TEST_info(&quot;Unknown test option: %s&quot;, option-&gt;name);
                 goto err;
             }
         }
diff --git a/test/testutil.h b/test/testutil.h
index 027c706..1f3c19f 100644
--- a/test/testutil.h
+++ b/test/testutil.h
@@ -1,5 +1,5 @@
 /*
- * Copyright 2014-2016 The OpenSSL Project Authors. All Rights Reserved.
+ * Copyright 2014-2017 The OpenSSL Project Authors. All Rights Reserved.
  *
  * Licensed under the OpenSSL license (the &quot;License&quot;).  You may not use
  * this file except in compliance with the License.  You can obtain a copy
@@ -273,6 +273,7 @@ void test_info(const char *file, int line, const char *desc, ...)
 void test_info_c90(const char *desc, ...) PRINTF_FORMAT(1, 2);
 void test_note(const char *desc, ...) PRINTF_FORMAT(1, 2);
 void test_openssl_errors(void);
+void test_perror(const char *s);
 
 /*
  * The following macros provide wrapper calls to the test functions with
@@ -387,6 +388,7 @@ void test_openssl_errors(void);
 # endif
 # define TEST_note           test_note
 # define TEST_openssl_errors test_openssl_errors
+# define TEST_perror         test_perror
 
 /*
  * For &quot;impossible&quot; conditions such as malloc failures or bugs in test code,
diff --git a/test/testutil/tests.c b/test/testutil/tests.c
index 7a92388..283f1c7 100644
--- a/test/testutil/tests.c
+++ b/test/testutil/tests.c
@@ -11,6 +11,7 @@
 #include &quot;output.h&quot;
 #include &quot;tu_local.h&quot;
 
+#include &lt;errno.h&gt;
 #include &lt;string.h&gt;
 #include &lt;ctype.h&gt;
 #include &quot;../../e_os.h&quot;
@@ -135,6 +136,15 @@ void test_error(const char *file, int line, const char *desc, ...)
     test_printf_stderr(&quot;\n&quot;);
 }
 
+void test_perror(const char *s)
+{
+    /*
+     * Using openssl_strerror_r causes linking issues since it isn't
+     * exported from libcrypto.so
+     */
+    TEST_error(&quot;%s: %s&quot;, s, strerror(errno));
+}
+
 void test_note(const char *fmt, ...)
 {
     if (fmt != NULL) {
@@ -152,6 +162,7 @@ void test_note(const char *fmt, ...)
 void test_openssl_errors(void)
 {
     ERR_print_errors_cb(openssl_error_cb, NULL);
+    ERR_clear_error();
 }
 
 /*
diff --git a/test/tls13encryptiontest.c b/test/tls13encryptiontest.c
index 861a815..0d0108c 100644
--- a/test/tls13encryptiontest.c
+++ b/test/tls13encryptiontest.c
@@ -1,5 +1,5 @@
 /*
- * Copyright 2016 The OpenSSL Project Authors. All Rights Reserved.
+ * Copyright 2016-2017 The OpenSSL Project Authors. All Rights Reserved.
  *
  * Licensed under the OpenSSL license (the &quot;License&quot;).  You may not use
  * this file except in compliance with the License.  You can obtain a copy
@@ -385,7 +385,7 @@ static int test_tls13_encryption(void)
         seq = NULL;
     }
 
-    fprintf(stderr, &quot;PASS: %&quot;OSSLzu&quot; records tested\n&quot;, ctr);
+    TEST_note(&quot;PASS: %&quot;OSSLzu&quot; records tested&quot;, ctr);
     ret = 1;
 
  err:
diff --git a/test/x509_internal_test.c b/test/x509_internal_test.c
index 10cb0b1..220231f 100644
--- a/test/x509_internal_test.c
+++ b/test/x509_internal_test.c
@@ -1,5 +1,5 @@
 /*
- * Copyright 2016 The OpenSSL Project Authors. All Rights Reserved.
+ * Copyright 2016-2017 The OpenSSL Project Authors. All Rights Reserved.
  *
  * Licensed under the OpenSSL license (the &quot;License&quot;).  You may not use
  * this file except in compliance with the License.  You can obtain a copy
@@ -52,12 +52,8 @@ static int test_standard_exts()
         tmp = standard_exts;
         TEST_error(&quot;Extensions out of order!&quot;);
         for (i = 0; i &lt; STANDARD_EXTENSION_COUNT; i++, tmp++)
-            fprintf(stderr, &quot;%d : %s\n&quot;, (*tmp)-&gt;ext_nid,
-                    OBJ_nid2sn((*tmp)-&gt;ext_nid));
-    } else {
-        fprintf(stderr, &quot;Order OK\n&quot;);
+            TEST_note(&quot;%d : %s&quot;, (*tmp)-&gt;ext_nid, OBJ_nid2sn((*tmp)-&gt;ext_nid));
     }
-
     return good;
 }
 
diff --git a/test/x509aux.c b/test/x509aux.c
index 44a9db1..7bfacfd 100644
--- a/test/x509aux.c
+++ b/test/x509aux.c
@@ -1,5 +1,5 @@
 /*
- * Copyright 2016 The OpenSSL Project Authors. All Rights Reserved.
+ * Copyright 2016-2017 The OpenSSL Project Authors. All Rights Reserved.
  *
  * Licensed under the OpenSSL licenses, (the &quot;License&quot;);
  * you may not use this file except in compliance with the License.
@@ -25,7 +25,7 @@ static char **files;
 
 static int test_certs(int num)
 {
-    int count;
+    int c;
     char *name = 0;
     char *header = 0;
     unsigned char *data = 0;
@@ -38,29 +38,28 @@ static int test_certs(int num)
     if (!TEST_ptr(fp))
         return 0;
 
-    for (count = 0;
-         !err &amp;&amp; PEM_read_bio(fp, &amp;name, &amp;header, &amp;data, &amp;len);
-	 ++count) {
-        int trusted = strcmp(name, PEM_STRING_X509_TRUSTED) == 0;
+    for (c = 0; !err &amp;&amp; PEM_read_bio(fp, &amp;name, &amp;header, &amp;data, &amp;len); ++c) {
+        const int trusted = (strcmp(name, PEM_STRING_X509_TRUSTED) == 0);
+
         d2i_X509_t d2i = trusted ? d2i_X509_AUX : d2i_X509;
         i2d_X509_t i2d = trusted ? i2d_X509_AUX : i2d_X509;
         X509 *cert = NULL;
-	const unsigned char *p = data;
+        const unsigned char *p = data;
         unsigned char *buf = NULL;
         unsigned char *bufp;
         long enclen;
 
-	if (!trusted
+        if (!trusted
             &amp;&amp; strcmp(name, PEM_STRING_X509) != 0
-	    &amp;&amp; strcmp(name, PEM_STRING_X509_OLD) != 0) {
-	    fprintf(stderr, &quot;unexpected PEM object: %s\n&quot;, name);
+            &amp;&amp; strcmp(name, PEM_STRING_X509_OLD) != 0) {
+            TEST_error(&quot;unexpected PEM object: %s&quot;, name);
             err = 1;
-	    goto next;
+            goto next;
         }
         cert = d2i(NULL, &amp;p, len);
 
         if (cert == NULL || (p - data) != len) {
-	    fprintf(stderr, &quot;error parsing input %s\n&quot;, name);
+            TEST_error(&quot;error parsing input %s&quot;, name);
             err = 1;
             goto next;
         }
@@ -68,33 +67,31 @@ static int test_certs(int num)
         /* Test traditional 2-pass encoding into caller allocated buffer */
         enclen = i2d(cert, NULL);
         if (len != enclen) {
-	    fprintf(stderr, &quot;encoded length %ld of %s != input length %ld\n&quot;,
-                    enclen, name, len);
+            TEST_error(&quot;encoded length %ld of %s != input length %ld&quot;,
+                       enclen, name, len);
             err = 1;
             goto next;
         }
         if ((buf = bufp = OPENSSL_malloc(len)) == NULL) {
-            perror(&quot;malloc&quot;);
+            TEST_perror(&quot;malloc&quot;);
             err = 1;
             goto next;
         }
         enclen = i2d(cert, &amp;bufp);
         if (len != enclen) {
-	    fprintf(stderr, &quot;encoded length %ld of %s != input length %ld\n&quot;,
-                    enclen, name, len);
+            TEST_error(&quot;encoded length %ld of %s != input length %ld&quot;,
+                       enclen, name, len);
             err = 1;
             goto next;
         }
         enclen = (long) (bufp - buf);
         if (enclen != len) {
-	    fprintf(stderr, &quot;unexpected buffer position after encoding %s\n&quot;,
-                    name);
+            TEST_error(&quot;unexpected buffer position after encoding %s&quot;, name);
             err = 1;
             goto next;
         }
         if (memcmp(buf, data, len) != 0) {
-	    fprintf(stderr, &quot;encoded content of %s does not match input\n&quot;,
-                    name);
+            TEST_error(&quot;encoded content of %s does not match input&quot;, name);
             err = 1;
             goto next;
         }
@@ -104,14 +101,13 @@ static int test_certs(int num)
         /* Test 1-pass encoding into library allocated buffer */
         enclen = i2d(cert, &amp;buf);
         if (len != enclen) {
-	    fprintf(stderr, &quot;encoded length %ld of %s != input length %ld\n&quot;,
-                    enclen, name, len);
+            TEST_error(&quot;encoded length %ld of %s != input length %ld&quot;,
+                       enclen, name, len);
             err = 1;
             goto next;
         }
         if (memcmp(buf, data, len) != 0) {
-	    fprintf(stderr, &quot;encoded content of %s does not match input\n&quot;,
-                    name);
+            TEST_error(&quot;encoded content of %s does not match input&quot;, name);
             err = 1;
             goto next;
         }
@@ -124,33 +120,33 @@ static int test_certs(int num)
             /* Test 1-pass encoding into library allocated buffer */
             enclen = i2d(cert, &amp;buf);
             if (enclen &gt; len) {
-                fprintf(stderr, &quot;encoded length %ld of %s &gt; input length %ld\n&quot;,
-                        enclen, name, len);
+                TEST_error(&quot;encoded length %ld of %s &gt; input length %ld&quot;,
+                           enclen, name, len);
                 err = 1;
                 goto next;
             }
             if (memcmp(buf, data, enclen) != 0) {
-                fprintf(stderr, &quot;encoded cert content does not match input\n&quot;);
+                TEST_error(&quot;encoded cert content does not match input&quot;);
                 err = 1;
                 goto next;
             }
         }
 
-	/*
-	 * If any of these were null, PEM_read() would have failed.
-	 */
+        /*
+         * If any of these were null, PEM_read() would have failed.
+         */
     next:
         X509_free(cert);
         OPENSSL_free(buf);
-	OPENSSL_free(name);
-	OPENSSL_free(header);
-	OPENSSL_free(data);
+        OPENSSL_free(name);
+        OPENSSL_free(header);
+        OPENSSL_free(data);
     }
     BIO_free(fp);
 
     if (ERR_GET_REASON(ERR_peek_last_error()) == PEM_R_NO_START_LINE) {
         /* Reached end of PEM file */
-        if (count &gt; 0) {
+        if (c &gt; 0) {
             ERR_clear_error();
             return 1;
         }
</PRE>
















<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="015102.html">[openssl-commits] [openssl]  master update
</A></li>
	<LI>Next message: <A HREF="015114.html">[openssl-commits] [openssl]  master update
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#15112">[ date ]</a>
              <a href="thread.html#15112">[ thread ]</a>
              <a href="subject.html#15112">[ subject ]</a>
              <a href="author.html#15112">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="../../../mailman/listinfo/openssl-commits.html">More information about the openssl-commits
mailing list</a><br>
</body></html>
