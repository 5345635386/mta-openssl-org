<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [openssl]  master update
   </TITLE>
   <LINK REL="Index" HREF="https://mta.openssl.org/pipermail/openssl-commits/2022-February/index.html" >
   <LINK REL="made" HREF="mailto:openssl-commits%40openssl.org?Subject=Re%3A%20%5Bopenssl%5D%20%20master%20update&In-Reply-To=%3C1643692664.926074.3209790.nullmailer%40dev.openssl.org%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="036170.html">
   <LINK REL="Next"  HREF="036174.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[openssl]  master update</H1>
    <B>Dr. Paul Dale</B> 
    <A HREF="mailto:openssl-commits%40openssl.org?Subject=Re%3A%20%5Bopenssl%5D%20%20master%20update&In-Reply-To=%3C1643692664.926074.3209790.nullmailer%40dev.openssl.org%3E"
       TITLE="[openssl]  master update">pauli at openssl.org
       </A><BR>
    <I>Tue Feb  1 05:17:44 UTC 2022</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="036170.html">[openssl]  master update
</A></li>
        <LI>Next message (by thread): <A HREF="036174.html">[openssl]  master update
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#36172">[ date ]</a>
              <a href="thread.html#36172">[ thread ]</a>
              <a href="subject.html#36172">[ subject ]</a>
              <a href="author.html#36172">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>The branch master has been updated
       via  1751356267f64d5db8824cf4ff5b3496e15972da (commit)
       via  b9d8ad3f157fa816c423bec6f7b4328ef894577c (commit)
       via  d3aaf4e9e71944d869ae47821d7b5a8402234ee8 (commit)
       via  43332e405bea83a2d553e0519fdb04170879bc96 (commit)
       via  769cd46540b2ec2a2d91ee3886b9e4f9d78e9a51 (commit)
       via  2722eeceaa993f4488b295a22d2e1178f5ba1ce1 (commit)
       via  59558f9d8824747024b6ab756f3798a577ecae48 (commit)
       via  cdcdcf5c6fa382c879cb3503609519d56fa62e81 (commit)
       via  fe01052f775d1b5dff86ff9b405b6b0df5efd3cf (commit)
       via  4c1a841c3de645674ed2af92da25f7f5736fae1c (commit)
       via  d54c52c28ebb780e2ffc5b7752d35359215cf0a6 (commit)
       via  95bd5ff65985e992827f7178deda84d95b1e6f66 (commit)
       via  0a10f71d3071bae0183cd4277da64d100f6b48eb (commit)
       via  6585d3aa7638c8cea2d4bb9f10e7298002f652e5 (commit)
       via  c8adf19d2da318cd7b007753d6c8a7f9dc94d4ed (commit)
       via  5b030ec0800d4ad6022ecd00e18a19f77ada0b04 (commit)
      from  a841d450a443efccf4df02922ebe02e4c2f11a2b (commit)


- Log -----------------------------------------------------------------
commit 1751356267f64d5db8824cf4ff5b3496e15972da
Author: Pauli &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">pauli at openssl.org</A>&gt;
Date:   Wed Jan 26 12:01:57 2022 +1100

    indentation fix
    
    Reviewed-by: Shane Lontis &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">shane.lontis at oracle.com</A>&gt;
    (Merged from <A HREF="https://github.com/openssl/openssl/pull/17572">https://github.com/openssl/openssl/pull/17572</A>)

commit b9d8ad3f157fa816c423bec6f7b4328ef894577c
Author: Pauli &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">pauli at openssl.org</A>&gt;
Date:   Tue Jan 25 11:54:56 2022 +1100

    tls1 prf: implement ctx dup operation
    
    Reviewed-by: Shane Lontis &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">shane.lontis at oracle.com</A>&gt;
    (Merged from <A HREF="https://github.com/openssl/openssl/pull/17572">https://github.com/openssl/openssl/pull/17572</A>)

commit d3aaf4e9e71944d869ae47821d7b5a8402234ee8
Author: Pauli &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">pauli at openssl.org</A>&gt;
Date:   Tue Jan 25 11:54:42 2022 +1100

    pkcs12 kdf: implement ctx dup operation
    
    Reviewed-by: Shane Lontis &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">shane.lontis at oracle.com</A>&gt;
    (Merged from <A HREF="https://github.com/openssl/openssl/pull/17572">https://github.com/openssl/openssl/pull/17572</A>)

commit 43332e405bea83a2d553e0519fdb04170879bc96
Author: Pauli &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">pauli at openssl.org</A>&gt;
Date:   Tue Jan 25 11:47:23 2022 +1100

    test: change pkey kdf dup fail test to a pkey kdf dup success test
    
    Reviewed-by: Shane Lontis &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">shane.lontis at oracle.com</A>&gt;
    (Merged from <A HREF="https://github.com/openssl/openssl/pull/17572">https://github.com/openssl/openssl/pull/17572</A>)

commit 769cd46540b2ec2a2d91ee3886b9e4f9d78e9a51
Author: Pauli &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">pauli at openssl.org</A>&gt;
Date:   Mon Jan 24 17:38:57 2022 +1100

    k942 kdf: implement ctx dup operation
    
    Reviewed-by: Shane Lontis &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">shane.lontis at oracle.com</A>&gt;
    (Merged from <A HREF="https://github.com/openssl/openssl/pull/17572">https://github.com/openssl/openssl/pull/17572</A>)

commit 2722eeceaa993f4488b295a22d2e1178f5ba1ce1
Author: Pauli &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">pauli at openssl.org</A>&gt;
Date:   Mon Jan 24 17:32:16 2022 +1100

    ss KDF: implement ctx dup operation
    
    Reviewed-by: Shane Lontis &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">shane.lontis at oracle.com</A>&gt;
    (Merged from <A HREF="https://github.com/openssl/openssl/pull/17572">https://github.com/openssl/openssl/pull/17572</A>)

commit 59558f9d8824747024b6ab756f3798a577ecae48
Author: Pauli &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">pauli at openssl.org</A>&gt;
Date:   Mon Jan 24 17:22:37 2022 +1100

    ssh kdf: implement ctx dup operation
    
    Reviewed-by: Shane Lontis &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">shane.lontis at oracle.com</A>&gt;
    (Merged from <A HREF="https://github.com/openssl/openssl/pull/17572">https://github.com/openssl/openssl/pull/17572</A>)

commit cdcdcf5c6fa382c879cb3503609519d56fa62e81
Author: Pauli &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">pauli at openssl.org</A>&gt;
Date:   Mon Jan 24 17:17:58 2022 +1100

    scrypt: implement ctx dup operation
    
    Reviewed-by: Shane Lontis &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">shane.lontis at oracle.com</A>&gt;
    (Merged from <A HREF="https://github.com/openssl/openssl/pull/17572">https://github.com/openssl/openssl/pull/17572</A>)

commit fe01052f775d1b5dff86ff9b405b6b0df5efd3cf
Author: Pauli &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">pauli at openssl.org</A>&gt;
Date:   Mon Jan 24 17:08:58 2022 +1100

    pvk kdf: implement ctx dup operation
    
    Reviewed-by: Shane Lontis &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">shane.lontis at oracle.com</A>&gt;
    (Merged from <A HREF="https://github.com/openssl/openssl/pull/17572">https://github.com/openssl/openssl/pull/17572</A>)

commit 4c1a841c3de645674ed2af92da25f7f5736fae1c
Author: Pauli &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">pauli at openssl.org</A>&gt;
Date:   Mon Jan 24 17:02:29 2022 +1100

    krb5kdf: implement ctx dup operation
    
    Reviewed-by: Shane Lontis &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">shane.lontis at oracle.com</A>&gt;
    (Merged from <A HREF="https://github.com/openssl/openssl/pull/17572">https://github.com/openssl/openssl/pull/17572</A>)

commit d54c52c28ebb780e2ffc5b7752d35359215cf0a6
Author: Pauli &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">pauli at openssl.org</A>&gt;
Date:   Mon Jan 24 16:58:54 2022 +1100

    kbkdf: implement ctx dup operation
    
    Reviewed-by: Shane Lontis &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">shane.lontis at oracle.com</A>&gt;
    (Merged from <A HREF="https://github.com/openssl/openssl/pull/17572">https://github.com/openssl/openssl/pull/17572</A>)

commit 95bd5ff65985e992827f7178deda84d95b1e6f66
Author: Pauli &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">pauli at openssl.org</A>&gt;
Date:   Mon Jan 24 16:51:24 2022 +1100

    hkdf: implement ctx dup operation
    
    Reviewed-by: Shane Lontis &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">shane.lontis at oracle.com</A>&gt;
    (Merged from <A HREF="https://github.com/openssl/openssl/pull/17572">https://github.com/openssl/openssl/pull/17572</A>)

commit 0a10f71d3071bae0183cd4277da64d100f6b48eb
Author: Pauli &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">pauli at openssl.org</A>&gt;
Date:   Mon Jan 24 16:22:54 2022 +1100

    pbkdf2: implement ctx dup operation
    
    Reviewed-by: Shane Lontis &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">shane.lontis at oracle.com</A>&gt;
    (Merged from <A HREF="https://github.com/openssl/openssl/pull/17572">https://github.com/openssl/openssl/pull/17572</A>)

commit 6585d3aa7638c8cea2d4bb9f10e7298002f652e5
Author: Pauli &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">pauli at openssl.org</A>&gt;
Date:   Mon Jan 24 16:17:44 2022 +1100

    pbkdf1: implement ctx dup operation
    
    Reviewed-by: Shane Lontis &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">shane.lontis at oracle.com</A>&gt;
    (Merged from <A HREF="https://github.com/openssl/openssl/pull/17572">https://github.com/openssl/openssl/pull/17572</A>)

commit c8adf19d2da318cd7b007753d6c8a7f9dc94d4ed
Author: Pauli &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">pauli at openssl.org</A>&gt;
Date:   Mon Jan 24 16:17:25 2022 +1100

    evp_test: add a ctx dup operation to the KDF tests
    
    Reviewed-by: Shane Lontis &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">shane.lontis at oracle.com</A>&gt;
    (Merged from <A HREF="https://github.com/openssl/openssl/pull/17572">https://github.com/openssl/openssl/pull/17572</A>)

commit 5b030ec0800d4ad6022ecd00e18a19f77ada0b04
Author: Pauli &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">pauli at openssl.org</A>&gt;
Date:   Wed Jan 26 15:21:51 2022 +1100

    prov: add a safe memdup function for context cloning
    
    Reviewed-by: Shane Lontis &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">shane.lontis at oracle.com</A>&gt;
    (Merged from <A HREF="https://github.com/openssl/openssl/pull/17572">https://github.com/openssl/openssl/pull/17572</A>)

-----------------------------------------------------------------------

Summary of changes:
 providers/common/include/prov/provider_util.h |  4 +++
 providers/common/provider_util.c              | 19 +++++++++++++-
 providers/implementations/kdfs/hkdf.c         | 33 +++++++++++++++++++++++
 providers/implementations/kdfs/kbkdf.c        | 32 ++++++++++++++++++++++
 providers/implementations/kdfs/krb5kdf.c      | 23 ++++++++++++++++
 providers/implementations/kdfs/pbkdf1.c       | 24 +++++++++++++++++
 providers/implementations/kdfs/pbkdf2.c       | 38 +++++++++++++++++++++++++--
 providers/implementations/kdfs/pkcs12kdf.c    | 25 ++++++++++++++++++
 providers/implementations/kdfs/pvkkdf.c       | 22 ++++++++++++++++
 providers/implementations/kdfs/scrypt.c       | 35 ++++++++++++++++++++++++
 providers/implementations/kdfs/sshkdf.c       | 26 ++++++++++++++++++
 providers/implementations/kdfs/sskdf.c        | 32 ++++++++++++++++++++++
 providers/implementations/kdfs/tls1_prf.c     | 27 +++++++++++++++++++
 providers/implementations/kdfs/x942kdf.c      | 37 ++++++++++++++++++++++++++
 test/evp_pkey_provided_test.c                 | 15 ++++++-----
 test/evp_test.c                               |  5 ++++
 16 files changed, 387 insertions(+), 10 deletions(-)

diff --git a/providers/common/include/prov/provider_util.h b/providers/common/include/prov/provider_util.h
index dfe91f29bc..0bf7f9c3b1 100644
--- a/providers/common/include/prov/provider_util.h
+++ b/providers/common/include/prov/provider_util.h
@@ -136,3 +136,7 @@ typedef struct ag_capable_st {
  */
 void ossl_prov_cache_exported_algorithms(const OSSL_ALGORITHM_CAPABLE *in,
                                          OSSL_ALGORITHM *out);
+
+/* Duplicate a lump of memory safely */
+int ossl_prov_memdup(const void *src, size_t src_len,
+                     unsigned char **dest, size_t *dest_len);
diff --git a/providers/common/provider_util.c b/providers/common/provider_util.c
index 58d4db3379..c934cfc59b 100644
--- a/providers/common/provider_util.c
+++ b/providers/common/provider_util.c
@@ -165,7 +165,7 @@ int ossl_prov_digest_copy(PROV_DIGEST *dst, const PROV_DIGEST *src)
 }
 
 const EVP_MD *ossl_prov_digest_fetch(PROV_DIGEST *pd, OSSL_LIB_CTX *libctx,
-                           const char *mdname, const char *propquery)
+                                     const char *mdname, const char *propquery)
 {
     EVP_MD_free(pd-&gt;alloc_md);
     pd-&gt;md = pd-&gt;alloc_md = EVP_MD_fetch(libctx, mdname, propquery);
@@ -351,3 +351,20 @@ void ossl_prov_cache_exported_algorithms(const OSSL_ALGORITHM_CAPABLE *in,
         out[j++] = in[i].alg;
     }
 }
+
+/* Duplicate a lump of memory safely */
+int ossl_prov_memdup(const void *src, size_t src_len,
+                     unsigned char **dest, size_t *dest_len)
+{
+    if (src != NULL) {
+        if ((*dest = OPENSSL_memdup(src, src_len)) == NULL) {
+            ERR_raise(ERR_LIB_PROV, ERR_R_MALLOC_FAILURE);
+            return 0;
+        }
+        *dest_len = src_len;
+    } else {
+        *dest = NULL;
+        *dest_len = 0;
+    }
+    return 1;
+}
diff --git a/providers/implementations/kdfs/hkdf.c b/providers/implementations/kdfs/hkdf.c
index 667d5e9619..e014e32d5b 100644
--- a/providers/implementations/kdfs/hkdf.c
+++ b/providers/implementations/kdfs/hkdf.c
@@ -34,6 +34,7 @@
 #define HKDF_MAXBUF 2048
 
 static OSSL_FUNC_kdf_newctx_fn kdf_hkdf_new;
+static OSSL_FUNC_kdf_dupctx_fn kdf_hkdf_dup;
 static OSSL_FUNC_kdf_freectx_fn kdf_hkdf_free;
 static OSSL_FUNC_kdf_reset_fn kdf_hkdf_reset;
 static OSSL_FUNC_kdf_derive_fn kdf_hkdf_derive;
@@ -126,6 +127,36 @@ static void kdf_hkdf_reset(void *vctx)
     ctx-&gt;provctx = provctx;
 }
 
+static void *kdf_hkdf_dup(void *vctx)
+{
+    const KDF_HKDF *src = (const KDF_HKDF *)vctx;
+    KDF_HKDF *dest;
+
+    dest = kdf_hkdf_new(src-&gt;provctx);
+    if (dest != NULL) {
+        if (!ossl_prov_memdup(src-&gt;salt, src-&gt;salt_len, &amp;dest-&gt;salt,
+                              &amp;dest-&gt;salt_len)
+                || !ossl_prov_memdup(src-&gt;key, src-&gt;key_len,
+                                     &amp;dest-&gt;key , &amp;dest-&gt;key_len)
+                || !ossl_prov_memdup(src-&gt;prefix, src-&gt;prefix_len,
+                                     &amp;dest-&gt;prefix, &amp;dest-&gt;prefix_len)
+                || !ossl_prov_memdup(src-&gt;label, src-&gt;label_len,
+                                     &amp;dest-&gt;label, &amp;dest-&gt;label_len)
+                || !ossl_prov_memdup(src-&gt;data, src-&gt;data_len,
+                                     &amp;dest-&gt;data, &amp;dest-&gt;data_len)
+                || !ossl_prov_digest_copy(&amp;dest-&gt;digest, &amp;src-&gt;digest))
+            goto err;
+        memcpy(dest-&gt;info, src-&gt;info, sizeof(dest-&gt;info));
+        dest-&gt;info_len = src-&gt;info_len;
+        dest-&gt;mode = src-&gt;mode;
+    }
+    return dest;
+
+ err:
+    kdf_hkdf_free(dest);
+    return NULL;
+}
+
 static size_t kdf_hkdf_size(KDF_HKDF *ctx)
 {
     int sz;
@@ -313,6 +344,7 @@ static const OSSL_PARAM *kdf_hkdf_gettable_ctx_params(ossl_unused void *ctx,
 
 const OSSL_DISPATCH ossl_kdf_hkdf_functions[] = {
     { OSSL_FUNC_KDF_NEWCTX, (void(*)(void))kdf_hkdf_new },
+    { OSSL_FUNC_KDF_DUPCTX, (void(*)(void))kdf_hkdf_dup },
     { OSSL_FUNC_KDF_FREECTX, (void(*)(void))kdf_hkdf_free },
     { OSSL_FUNC_KDF_RESET, (void(*)(void))kdf_hkdf_reset },
     { OSSL_FUNC_KDF_DERIVE, (void(*)(void))kdf_hkdf_derive },
@@ -728,6 +760,7 @@ static const OSSL_PARAM *kdf_tls1_3_settable_ctx_params(ossl_unused void *ctx,
 
 const OSSL_DISPATCH ossl_kdf_tls1_3_kdf_functions[] = {
     { OSSL_FUNC_KDF_NEWCTX, (void(*)(void))kdf_hkdf_new },
+    { OSSL_FUNC_KDF_DUPCTX, (void(*)(void))kdf_hkdf_dup },
     { OSSL_FUNC_KDF_FREECTX, (void(*)(void))kdf_hkdf_free },
     { OSSL_FUNC_KDF_RESET, (void(*)(void))kdf_hkdf_reset },
     { OSSL_FUNC_KDF_DERIVE, (void(*)(void))kdf_tls1_3_derive },
diff --git a/providers/implementations/kdfs/kbkdf.c b/providers/implementations/kdfs/kbkdf.c
index 22fc7b86ad..fb5c1c022e 100644
--- a/providers/implementations/kdfs/kbkdf.c
+++ b/providers/implementations/kdfs/kbkdf.c
@@ -75,6 +75,7 @@ typedef struct {
 
 /* Definitions needed for typechecking. */
 static OSSL_FUNC_kdf_newctx_fn kbkdf_new;
+static OSSL_FUNC_kdf_newctx_fn kbkdf_dup;
 static OSSL_FUNC_kdf_freectx_fn kbkdf_free;
 static OSSL_FUNC_kdf_reset_fn kbkdf_reset;
 static OSSL_FUNC_kdf_derive_fn kbkdf_derive;
@@ -149,6 +150,36 @@ static void kbkdf_reset(void *vctx)
     init(ctx);
 }
 
+static void *kbkdf_dup(void *vctx)
+{
+    const KBKDF *src = (const KBKDF *)vctx;
+    KBKDF *dest;
+
+    dest = kbkdf_new(src-&gt;provctx);
+    if (dest != NULL) {
+        dest-&gt;ctx_init = EVP_MAC_CTX_dup(src-&gt;ctx_init);
+        if (dest-&gt;ctx_init == NULL
+                || !ossl_prov_memdup(src-&gt;ki, src-&gt;ki_len,
+                                     &amp;dest-&gt;ki, &amp;dest-&gt;ki_len)
+                || !ossl_prov_memdup(src-&gt;label, src-&gt;label_len,
+                                     &amp;dest-&gt;label, &amp;dest-&gt;label_len)
+                || !ossl_prov_memdup(src-&gt;context, src-&gt;context_len,
+                                     &amp;dest-&gt;context, &amp;dest-&gt;context_len)
+                || !ossl_prov_memdup(src-&gt;iv, src-&gt;iv_len,
+                                     &amp;dest-&gt;iv, &amp;dest-&gt;iv_len))
+            goto err;
+        dest-&gt;mode = src-&gt;mode;
+        dest-&gt;r = src-&gt;r;
+        dest-&gt;use_l = src-&gt;use_l;
+        dest-&gt;use_separator = src-&gt;use_separator;
+    }
+    return dest;
+
+ err:
+    kbkdf_free(dest);
+    return NULL;
+}
+
 /* SP800-108 section 5.1 or section 5.2 depending on mode. */
 static int derive(EVP_MAC_CTX *ctx_init, kbkdf_mode mode, unsigned char *iv,
                   size_t iv_len, unsigned char *label, size_t label_len,
@@ -405,6 +436,7 @@ static const OSSL_PARAM *kbkdf_gettable_ctx_params(ossl_unused void *ctx,
 
 const OSSL_DISPATCH ossl_kdf_kbkdf_functions[] = {
     { OSSL_FUNC_KDF_NEWCTX, (void(*)(void))kbkdf_new },
+    { OSSL_FUNC_KDF_DUPCTX, (void(*)(void))kbkdf_dup },
     { OSSL_FUNC_KDF_FREECTX, (void(*)(void))kbkdf_free },
     { OSSL_FUNC_KDF_RESET, (void(*)(void))kbkdf_reset },
     { OSSL_FUNC_KDF_DERIVE, (void(*)(void))kbkdf_derive },
diff --git a/providers/implementations/kdfs/krb5kdf.c b/providers/implementations/kdfs/krb5kdf.c
index 2c887f0eb9..1e86f9a6d7 100644
--- a/providers/implementations/kdfs/krb5kdf.c
+++ b/providers/implementations/kdfs/krb5kdf.c
@@ -34,6 +34,7 @@
 /* KRB5 KDF defined in RFC 3961, Section 5.1 */
 
 static OSSL_FUNC_kdf_newctx_fn krb5kdf_new;
+static OSSL_FUNC_kdf_dupctx_fn krb5kdf_dup;
 static OSSL_FUNC_kdf_freectx_fn krb5kdf_free;
 static OSSL_FUNC_kdf_reset_fn krb5kdf_reset;
 static OSSL_FUNC_kdf_derive_fn krb5kdf_derive;
@@ -102,6 +103,27 @@ static int krb5kdf_set_membuf(unsigned char **dst, size_t *dst_len,
     return OSSL_PARAM_get_octet_string(p, (void **)dst, 0, dst_len);
 }
 
+static void *krb5kdf_dup(void *vctx)
+{
+    const KRB5KDF_CTX *src = (const KRB5KDF_CTX *)vctx;
+    KRB5KDF_CTX *dest;
+
+    dest = krb5kdf_new(src-&gt;provctx);
+    if (dest != NULL) {
+        if (!ossl_prov_memdup(src-&gt;key, src-&gt;key_len,
+                              &amp;dest-&gt;key, &amp;dest-&gt;key_len)
+                || !ossl_prov_memdup(src-&gt;constant, src-&gt;constant_len,
+                                     &amp;dest-&gt;constant , &amp;dest-&gt;constant_len)
+                || !ossl_prov_cipher_copy(&amp;dest-&gt;cipher, &amp;src-&gt;cipher))
+            goto err;
+    }
+    return dest;
+
+ err:
+    krb5kdf_free(dest);
+    return NULL;
+}
+
 static int krb5kdf_derive(void *vctx, unsigned char *key, size_t keylen,
                           const OSSL_PARAM params[])
 {
@@ -198,6 +220,7 @@ static const OSSL_PARAM *krb5kdf_gettable_ctx_params(ossl_unused void *ctx,
 
 const OSSL_DISPATCH ossl_kdf_krb5kdf_functions[] = {
     { OSSL_FUNC_KDF_NEWCTX, (void(*)(void))krb5kdf_new },
+    { OSSL_FUNC_KDF_DUPCTX, (void(*)(void))krb5kdf_dup },
     { OSSL_FUNC_KDF_FREECTX, (void(*)(void))krb5kdf_free },
     { OSSL_FUNC_KDF_RESET, (void(*)(void))krb5kdf_reset },
     { OSSL_FUNC_KDF_DERIVE, (void(*)(void))krb5kdf_derive },
diff --git a/providers/implementations/kdfs/pbkdf1.c b/providers/implementations/kdfs/pbkdf1.c
index b9b164c4e2..986dd25ee3 100644
--- a/providers/implementations/kdfs/pbkdf1.c
+++ b/providers/implementations/kdfs/pbkdf1.c
@@ -24,6 +24,7 @@
 #include &quot;prov/provider_util.h&quot;
 
 static OSSL_FUNC_kdf_newctx_fn kdf_pbkdf1_new;
+static OSSL_FUNC_kdf_dupctx_fn kdf_pbkdf1_dup;
 static OSSL_FUNC_kdf_freectx_fn kdf_pbkdf1_free;
 static OSSL_FUNC_kdf_reset_fn kdf_pbkdf1_reset;
 static OSSL_FUNC_kdf_derive_fn kdf_pbkdf1_derive;
@@ -130,6 +131,28 @@ static void kdf_pbkdf1_reset(void *vctx)
     ctx-&gt;provctx = provctx;
 }
 
+static void *kdf_pbkdf1_dup(void *vctx)
+{
+    const KDF_PBKDF1 *src = (const KDF_PBKDF1 *)vctx;
+    KDF_PBKDF1 *dest;
+
+    dest = kdf_pbkdf1_new(src-&gt;provctx);
+    if (dest != NULL) {
+        if (!ossl_prov_memdup(src-&gt;salt, src-&gt;salt_len,
+                              &amp;dest-&gt;salt, &amp;dest-&gt;salt_len)
+                || !ossl_prov_memdup(src-&gt;pass, src-&gt;pass_len,
+                                     &amp;dest-&gt;pass , &amp;dest-&gt;pass_len)
+                || !ossl_prov_digest_copy(&amp;dest-&gt;digest, &amp;src-&gt;digest))
+            goto err;
+        dest-&gt;iter = src-&gt;iter;
+    }
+    return dest;
+
+ err:
+    kdf_pbkdf1_free(dest);
+    return NULL;
+}
+
 static int kdf_pbkdf1_set_membuf(unsigned char **buffer, size_t *buflen,
                              const OSSL_PARAM *p)
 {
@@ -231,6 +254,7 @@ static const OSSL_PARAM *kdf_pbkdf1_gettable_ctx_params(ossl_unused void *ctx,
 
 const OSSL_DISPATCH ossl_kdf_pbkdf1_functions[] = {
     { OSSL_FUNC_KDF_NEWCTX, (void(*)(void))kdf_pbkdf1_new },
+    { OSSL_FUNC_KDF_DUPCTX, (void(*)(void))kdf_pbkdf1_dup },
     { OSSL_FUNC_KDF_FREECTX, (void(*)(void))kdf_pbkdf1_free },
     { OSSL_FUNC_KDF_RESET, (void(*)(void))kdf_pbkdf1_reset },
     { OSSL_FUNC_KDF_DERIVE, (void(*)(void))kdf_pbkdf1_derive },
diff --git a/providers/implementations/kdfs/pbkdf2.c b/providers/implementations/kdfs/pbkdf2.c
index 4c829a6d1f..79578fb77d 100644
--- a/providers/implementations/kdfs/pbkdf2.c
+++ b/providers/implementations/kdfs/pbkdf2.c
@@ -37,6 +37,7 @@
 #define KDF_PBKDF2_MIN_SALT_LEN   (128 / 8)
 
 static OSSL_FUNC_kdf_newctx_fn kdf_pbkdf2_new;
+static OSSL_FUNC_kdf_dupctx_fn kdf_pbkdf2_dup;
 static OSSL_FUNC_kdf_freectx_fn kdf_pbkdf2_free;
 static OSSL_FUNC_kdf_reset_fn kdf_pbkdf2_reset;
 static OSSL_FUNC_kdf_derive_fn kdf_pbkdf2_derive;
@@ -63,7 +64,7 @@ typedef struct {
 
 static void kdf_pbkdf2_init(KDF_PBKDF2 *ctx);
 
-static void *kdf_pbkdf2_new(void *provctx)
+static void *kdf_pbkdf2_new_no_init(void *provctx)
 {
     KDF_PBKDF2 *ctx;
 
@@ -76,7 +77,15 @@ static void *kdf_pbkdf2_new(void *provctx)
         return NULL;
     }
     ctx-&gt;provctx = provctx;
-    kdf_pbkdf2_init(ctx);
+    return ctx;
+}
+
+static void *kdf_pbkdf2_new(void *provctx)
+{
+    KDF_PBKDF2 *ctx = kdf_pbkdf2_new_no_init(provctx);
+
+    if (ctx != NULL)
+        kdf_pbkdf2_init(ctx);
     return ctx;
 }
 
@@ -108,6 +117,30 @@ static void kdf_pbkdf2_reset(void *vctx)
     kdf_pbkdf2_init(ctx);
 }
 
+static void *kdf_pbkdf2_dup(void *vctx)
+{
+    const KDF_PBKDF2 *src = (const KDF_PBKDF2 *)vctx;
+    KDF_PBKDF2 *dest;
+
+    /* We need a new PBKDF2 object but uninitialised since we're filling it */
+    dest = kdf_pbkdf2_new_no_init(src-&gt;provctx);
+    if (dest != NULL) {
+        if (!ossl_prov_memdup(src-&gt;salt, src-&gt;salt_len,
+                              &amp;dest-&gt;salt, &amp;dest-&gt;salt_len)
+                || !ossl_prov_memdup(src-&gt;pass, src-&gt;pass_len,
+                                     &amp;dest-&gt;pass, &amp;dest-&gt;pass_len)
+                || !ossl_prov_digest_copy(&amp;dest-&gt;digest, &amp;src-&gt;digest))
+            goto err;
+        dest-&gt;iter = src-&gt;iter;
+        dest-&gt;lower_bound_checks = src-&gt;lower_bound_checks;
+    }
+    return dest;
+
+ err:
+    kdf_pbkdf2_free(dest);
+    return NULL;
+}
+
 static void kdf_pbkdf2_init(KDF_PBKDF2 *ctx)
 {
     OSSL_PARAM params[2] = { OSSL_PARAM_END, OSSL_PARAM_END };
@@ -249,6 +282,7 @@ static const OSSL_PARAM *kdf_pbkdf2_gettable_ctx_params(ossl_unused void *ctx,
 
 const OSSL_DISPATCH ossl_kdf_pbkdf2_functions[] = {
     { OSSL_FUNC_KDF_NEWCTX, (void(*)(void))kdf_pbkdf2_new },
+    { OSSL_FUNC_KDF_DUPCTX, (void(*)(void))kdf_pbkdf2_dup },
     { OSSL_FUNC_KDF_FREECTX, (void(*)(void))kdf_pbkdf2_free },
     { OSSL_FUNC_KDF_RESET, (void(*)(void))kdf_pbkdf2_reset },
     { OSSL_FUNC_KDF_DERIVE, (void(*)(void))kdf_pbkdf2_derive },
diff --git a/providers/implementations/kdfs/pkcs12kdf.c b/providers/implementations/kdfs/pkcs12kdf.c
index a29a618ee8..5f8905de13 100644
--- a/providers/implementations/kdfs/pkcs12kdf.c
+++ b/providers/implementations/kdfs/pkcs12kdf.c
@@ -24,6 +24,7 @@
 #include &quot;prov/provider_util.h&quot;
 
 static OSSL_FUNC_kdf_newctx_fn kdf_pkcs12_new;
+static OSSL_FUNC_kdf_dupctx_fn kdf_pkcs12_dup;
 static OSSL_FUNC_kdf_freectx_fn kdf_pkcs12_free;
 static OSSL_FUNC_kdf_reset_fn kdf_pkcs12_reset;
 static OSSL_FUNC_kdf_derive_fn kdf_pkcs12_derive;
@@ -178,6 +179,29 @@ static void kdf_pkcs12_reset(void *vctx)
     ctx-&gt;provctx = provctx;
 }
 
+static void *kdf_pkcs12_dup(void *vctx)
+{
+    const KDF_PKCS12 *src = (const KDF_PKCS12 *)vctx;
+    KDF_PKCS12 *dest;
+
+    dest = kdf_pkcs12_new(src-&gt;provctx);
+    if (dest != NULL) {
+        if (!ossl_prov_memdup(src-&gt;salt, src-&gt;salt_len,
+                              &amp;dest-&gt;salt, &amp;dest-&gt;salt_len)
+                || !ossl_prov_memdup(src-&gt;pass, src-&gt;pass_len,
+                                     &amp;dest-&gt;pass , &amp;dest-&gt;pass_len)
+                || !ossl_prov_digest_copy(&amp;dest-&gt;digest, &amp;src-&gt;digest))
+            goto err;
+        dest-&gt;iter = src-&gt;iter;
+        dest-&gt;id = src-&gt;id;
+    }
+    return dest;
+
+ err:
+    kdf_pkcs12_free(dest);
+    return NULL;
+}
+
 static int pkcs12kdf_set_membuf(unsigned char **buffer, size_t *buflen,
                              const OSSL_PARAM *p)
 {
@@ -287,6 +311,7 @@ static const OSSL_PARAM *kdf_pkcs12_gettable_ctx_params(
 
 const OSSL_DISPATCH ossl_kdf_pkcs12_functions[] = {
     { OSSL_FUNC_KDF_NEWCTX, (void(*)(void))kdf_pkcs12_new },
+    { OSSL_FUNC_KDF_DUPCTX, (void(*)(void))kdf_pkcs12_dup },
     { OSSL_FUNC_KDF_FREECTX, (void(*)(void))kdf_pkcs12_free },
     { OSSL_FUNC_KDF_RESET, (void(*)(void))kdf_pkcs12_reset },
     { OSSL_FUNC_KDF_DERIVE, (void(*)(void))kdf_pkcs12_derive },
diff --git a/providers/implementations/kdfs/pvkkdf.c b/providers/implementations/kdfs/pvkkdf.c
index e953911c83..e96ff29b3b 100644
--- a/providers/implementations/kdfs/pvkkdf.c
+++ b/providers/implementations/kdfs/pvkkdf.c
@@ -17,6 +17,7 @@
 #include &quot;prov/provider_util.h&quot;
 
 static OSSL_FUNC_kdf_newctx_fn kdf_pvk_new;
+static OSSL_FUNC_kdf_dupctx_fn kdf_pvk_dup;
 static OSSL_FUNC_kdf_freectx_fn kdf_pvk_free;
 static OSSL_FUNC_kdf_reset_fn kdf_pvk_reset;
 static OSSL_FUNC_kdf_derive_fn kdf_pvk_derive;
@@ -71,6 +72,26 @@ static void kdf_pvk_free(void *vctx)
     }
 }
 
+static void *kdf_pvk_dup(void *vctx)
+{
+    const KDF_PVK *src = (const KDF_PVK *)vctx;
+    KDF_PVK *dest;
+
+    dest = kdf_pvk_new(src-&gt;provctx);
+    if (dest != NULL)
+        if (!ossl_prov_memdup(src-&gt;salt, src-&gt;salt_len,
+                              &amp;dest-&gt;salt, &amp;dest-&gt;salt_len)
+                || !ossl_prov_memdup(src-&gt;pass, src-&gt;pass_len,
+                                     &amp;dest-&gt;pass , &amp;dest-&gt;pass_len)
+                || !ossl_prov_digest_copy(&amp;dest-&gt;digest, &amp;src-&gt;digest))
+            goto err;
+    return dest;
+
+ err:
+    kdf_pvk_free(dest);
+    return NULL;
+}
+
 static void kdf_pvk_reset(void *vctx)
 {
     KDF_PVK *ctx = (KDF_PVK *)vctx;
@@ -216,6 +237,7 @@ static const OSSL_PARAM *kdf_pvk_gettable_ctx_params(ossl_unused void *ctx,
 
 const OSSL_DISPATCH ossl_kdf_pvk_functions[] = {
     { OSSL_FUNC_KDF_NEWCTX, (void(*)(void))kdf_pvk_new },
+    { OSSL_FUNC_KDF_DUPCTX, (void(*)(void))kdf_pvk_dup },
     { OSSL_FUNC_KDF_FREECTX, (void(*)(void))kdf_pvk_free },
     { OSSL_FUNC_KDF_RESET, (void(*)(void))kdf_pvk_reset },
     { OSSL_FUNC_KDF_DERIVE, (void(*)(void))kdf_pvk_derive },
diff --git a/providers/implementations/kdfs/scrypt.c b/providers/implementations/kdfs/scrypt.c
index a7072f785f..744f87847b 100644
--- a/providers/implementations/kdfs/scrypt.c
+++ b/providers/implementations/kdfs/scrypt.c
@@ -21,10 +21,12 @@
 #include &quot;prov/provider_ctx.h&quot;
 #include &quot;prov/providercommon.h&quot;
 #include &quot;prov/implementations.h&quot;
+#include &quot;prov/provider_util.h&quot;
 
 #ifndef OPENSSL_NO_SCRYPT
 
 static OSSL_FUNC_kdf_newctx_fn kdf_scrypt_new;
+static OSSL_FUNC_kdf_dupctx_fn kdf_scrypt_dup;
 static OSSL_FUNC_kdf_freectx_fn kdf_scrypt_free;
 static OSSL_FUNC_kdf_reset_fn kdf_scrypt_reset;
 static OSSL_FUNC_kdf_derive_fn kdf_scrypt_derive;
@@ -92,6 +94,38 @@ static void kdf_scrypt_reset(void *vctx)
     kdf_scrypt_init(ctx);
 }
 
+static void *kdf_scrypt_dup(void *vctx)
+{
+    const KDF_SCRYPT *src = (const KDF_SCRYPT *)vctx;
+    KDF_SCRYPT *dest;
+
+    dest = kdf_scrypt_new(src-&gt;libctx);
+    if (dest != NULL) {
+        if (src-&gt;sha256 != NULL &amp;&amp; !EVP_MD_up_ref(src-&gt;sha256))
+            goto err;
+        if (src-&gt;propq != NULL) {
+            dest-&gt;propq = OPENSSL_strdup(src-&gt;propq);
+            if (dest-&gt;propq == NULL)
+                goto err;
+        }
+        if (!ossl_prov_memdup(src-&gt;salt, src-&gt;salt_len,
+                              &amp;dest-&gt;salt, &amp;dest-&gt;salt_len)
+                || !ossl_prov_memdup(src-&gt;pass, src-&gt;pass_len,
+                                     &amp;dest-&gt;pass , &amp;dest-&gt;pass_len))
+            goto err;
+        dest-&gt;N = src-&gt;N;
+        dest-&gt;r = src-&gt;r;
+        dest-&gt;p = src-&gt;p;
+        dest-&gt;maxmem_bytes = src-&gt;maxmem_bytes;
+        dest-&gt;sha256 = src-&gt;sha256;
+    }
+    return dest;
+
+ err:
+    kdf_scrypt_free(dest);
+    return NULL;
+}
+
 static void kdf_scrypt_init(KDF_SCRYPT *ctx)
 {
     /* Default values are the most conservative recommendation given in the
@@ -275,6 +309,7 @@ static const OSSL_PARAM *kdf_scrypt_gettable_ctx_params(ossl_unused void *ctx,
 
 const OSSL_DISPATCH ossl_kdf_scrypt_functions[] = {
     { OSSL_FUNC_KDF_NEWCTX, (void(*)(void))kdf_scrypt_new },
+    { OSSL_FUNC_KDF_DUPCTX, (void(*)(void))kdf_scrypt_dup },
     { OSSL_FUNC_KDF_FREECTX, (void(*)(void))kdf_scrypt_free },
     { OSSL_FUNC_KDF_RESET, (void(*)(void))kdf_scrypt_reset },
     { OSSL_FUNC_KDF_DERIVE, (void(*)(void))kdf_scrypt_derive },
diff --git a/providers/implementations/kdfs/sshkdf.c b/providers/implementations/kdfs/sshkdf.c
index be23c2143d..6c1cf7e615 100644
--- a/providers/implementations/kdfs/sshkdf.c
+++ b/providers/implementations/kdfs/sshkdf.c
@@ -24,6 +24,7 @@
 
 /* See RFC 4253, Section 7.2 */
 static OSSL_FUNC_kdf_newctx_fn kdf_sshkdf_new;
+static OSSL_FUNC_kdf_dupctx_fn kdf_sshkdf_dup;
 static OSSL_FUNC_kdf_freectx_fn kdf_sshkdf_free;
 static OSSL_FUNC_kdf_reset_fn kdf_sshkdf_reset;
 static OSSL_FUNC_kdf_derive_fn kdf_sshkdf_derive;
@@ -86,6 +87,30 @@ static void kdf_sshkdf_reset(void *vctx)
     ctx-&gt;provctx = provctx;
 }
 
+static void *kdf_sshkdf_dup(void *vctx)
+{
+    const KDF_SSHKDF *src = (const KDF_SSHKDF *)vctx;
+    KDF_SSHKDF *dest;
+
+    dest = kdf_sshkdf_new(src-&gt;provctx);
+    if (dest != NULL) {
+        if (!ossl_prov_memdup(src-&gt;key, src-&gt;key_len,
+                              &amp;dest-&gt;key, &amp;dest-&gt;key_len)
+                || !ossl_prov_memdup(src-&gt;xcghash, src-&gt;xcghash_len,
+                                     &amp;dest-&gt;xcghash , &amp;dest-&gt;xcghash_len)
+                || !ossl_prov_memdup(src-&gt;session_id, src-&gt;session_id_len,
+                                     &amp;dest-&gt;session_id , &amp;dest-&gt;session_id_len)
+                || !ossl_prov_digest_copy(&amp;dest-&gt;digest, &amp;src-&gt;digest))
+            goto err;
+        dest-&gt;type = src-&gt;type;
+    }
+    return dest;
+
+ err:
+    kdf_sshkdf_free(dest);
+    return NULL;
+}
+
 static int sshkdf_set_membuf(unsigned char **dst, size_t *dst_len,
                              const OSSL_PARAM *p)
 {
@@ -211,6 +236,7 @@ static const OSSL_PARAM *kdf_sshkdf_gettable_ctx_params(ossl_unused void *ctx,
 
 const OSSL_DISPATCH ossl_kdf_sshkdf_functions[] = {
     { OSSL_FUNC_KDF_NEWCTX, (void(*)(void))kdf_sshkdf_new },
+    { OSSL_FUNC_KDF_DUPCTX, (void(*)(void))kdf_sshkdf_dup },
     { OSSL_FUNC_KDF_FREECTX, (void(*)(void))kdf_sshkdf_free },
     { OSSL_FUNC_KDF_RESET, (void(*)(void))kdf_sshkdf_reset },
     { OSSL_FUNC_KDF_DERIVE, (void(*)(void))kdf_sshkdf_derive },
diff --git a/providers/implementations/kdfs/sskdf.c b/providers/implementations/kdfs/sskdf.c
index 297ddcdc2d..e7f1727ba5 100644
--- a/providers/implementations/kdfs/sskdf.c
+++ b/providers/implementations/kdfs/sskdf.c
@@ -72,6 +72,7 @@ typedef struct {
 static const unsigned char kmac_custom_str[] = { 0x4B, 0x44, 0x46 };
 
 static OSSL_FUNC_kdf_newctx_fn sskdf_new;
+static OSSL_FUNC_kdf_dupctx_fn sskdf_dup;
 static OSSL_FUNC_kdf_freectx_fn sskdf_free;
 static OSSL_FUNC_kdf_reset_fn sskdf_reset;
 static OSSL_FUNC_kdf_derive_fn sskdf_derive;
@@ -319,6 +320,35 @@ static void sskdf_free(void *vctx)
     }
 }
 
+static void *sskdf_dup(void *vctx)
+{
+    const KDF_SSKDF *src = (const KDF_SSKDF *)vctx;
+    KDF_SSKDF *dest;
+
+    dest = sskdf_new(src-&gt;provctx);
+    if (dest != NULL) {
+        if (src-&gt;macctx != NULL) {
+            dest-&gt;macctx = EVP_MAC_CTX_dup(src-&gt;macctx);
+            if (dest-&gt;macctx == NULL)
+                goto err;
+        }
+        if (!ossl_prov_memdup(src-&gt;info, src-&gt;info_len,
+                              &amp;dest-&gt;info, &amp;dest-&gt;info_len)
+                || !ossl_prov_memdup(src-&gt;salt, src-&gt;salt_len,
+                                     &amp;dest-&gt;salt , &amp;dest-&gt;salt_len)
+                || !ossl_prov_memdup(src-&gt;secret, src-&gt;secret_len,
+                                     &amp;dest-&gt;secret, &amp;dest-&gt;secret_len)
+                || !ossl_prov_digest_copy(&amp;dest-&gt;digest, &amp;src-&gt;digest))
+            goto err;
+        dest-&gt;out_len = src-&gt;out_len;
+    }
+    return dest;
+
+ err:
+    sskdf_free(dest);
+    return NULL;
+}
+
 static int sskdf_set_buffer(unsigned char **out, size_t *out_len,
                             const OSSL_PARAM *p)
 {
@@ -520,6 +550,7 @@ static const OSSL_PARAM *sskdf_gettable_ctx_params(ossl_unused void *ctx,
 
 const OSSL_DISPATCH ossl_kdf_sskdf_functions[] = {
     { OSSL_FUNC_KDF_NEWCTX, (void(*)(void))sskdf_new },
+    { OSSL_FUNC_KDF_DUPCTX, (void(*)(void))sskdf_dup },
     { OSSL_FUNC_KDF_FREECTX, (void(*)(void))sskdf_free },
     { OSSL_FUNC_KDF_RESET, (void(*)(void))sskdf_reset },
     { OSSL_FUNC_KDF_DERIVE, (void(*)(void))sskdf_derive },
@@ -534,6 +565,7 @@ const OSSL_DISPATCH ossl_kdf_sskdf_functions[] = {
 
 const OSSL_DISPATCH ossl_kdf_x963_kdf_functions[] = {
     { OSSL_FUNC_KDF_NEWCTX, (void(*)(void))sskdf_new },
+    { OSSL_FUNC_KDF_DUPCTX, (void(*)(void))sskdf_dup },
     { OSSL_FUNC_KDF_FREECTX, (void(*)(void))sskdf_free },
     { OSSL_FUNC_KDF_RESET, (void(*)(void))sskdf_reset },
     { OSSL_FUNC_KDF_DERIVE, (void(*)(void))x963kdf_derive },
diff --git a/providers/implementations/kdfs/tls1_prf.c b/providers/implementations/kdfs/tls1_prf.c
index 74a0f7e1f3..23436cf241 100644
--- a/providers/implementations/kdfs/tls1_prf.c
+++ b/providers/implementations/kdfs/tls1_prf.c
@@ -63,6 +63,7 @@
 #include &quot;e_os.h&quot;
 
 static OSSL_FUNC_kdf_newctx_fn kdf_tls1_prf_new;
+static OSSL_FUNC_kdf_dupctx_fn kdf_tls1_prf_dup;
 static OSSL_FUNC_kdf_freectx_fn kdf_tls1_prf_free;
 static OSSL_FUNC_kdf_reset_fn kdf_tls1_prf_reset;
 static OSSL_FUNC_kdf_derive_fn kdf_tls1_prf_derive;
@@ -131,6 +132,31 @@ static void kdf_tls1_prf_reset(void *vctx)
     ctx-&gt;provctx = provctx;
 }
 
+static void *kdf_tls1_prf_dup(void *vctx)
+{
+    const TLS1_PRF *src = (const TLS1_PRF *)vctx;
+    TLS1_PRF *dest;
+
+    dest = kdf_tls1_prf_new(src-&gt;provctx);
+    if (dest != NULL) {
+        if (src-&gt;P_hash != NULL
+                    &amp;&amp; (dest-&gt;P_hash = EVP_MAC_CTX_dup(src-&gt;P_hash)) == NULL)
+            goto err;
+        if (src-&gt;P_sha1 != NULL
+                    &amp;&amp; (dest-&gt;P_sha1 = EVP_MAC_CTX_dup(src-&gt;P_sha1)) == NULL)
+            goto err;
+        if (!ossl_prov_memdup(src-&gt;sec, src-&gt;seclen, &amp;dest-&gt;sec, &amp;dest-&gt;seclen))
+            goto err;
+        memcpy(dest-&gt;seed, src-&gt;seed, src-&gt;seedlen);
+        dest-&gt;seedlen = src-&gt;seedlen;
+    }
+    return dest;
+
+ err:
+    kdf_tls1_prf_free(dest);
+    return NULL;
+}
+
 static int kdf_tls1_prf_derive(void *vctx, unsigned char *key, size_t keylen,
                                const OSSL_PARAM params[])
 {
@@ -248,6 +274,7 @@ static const OSSL_PARAM *kdf_tls1_prf_gettable_ctx_params(
 
 const OSSL_DISPATCH ossl_kdf_tls1_prf_functions[] = {
     { OSSL_FUNC_KDF_NEWCTX, (void(*)(void))kdf_tls1_prf_new },
+    { OSSL_FUNC_KDF_DUPCTX, (void(*)(void))kdf_tls1_prf_dup },
     { OSSL_FUNC_KDF_FREECTX, (void(*)(void))kdf_tls1_prf_free },
     { OSSL_FUNC_KDF_RESET, (void(*)(void))kdf_tls1_prf_reset },
     { OSSL_FUNC_KDF_DERIVE, (void(*)(void))kdf_tls1_prf_derive },
diff --git a/providers/implementations/kdfs/x942kdf.c b/providers/implementations/kdfs/x942kdf.c
index c2cc94a192..4fb71835a2 100644
--- a/providers/implementations/kdfs/x942kdf.c
+++ b/providers/implementations/kdfs/x942kdf.c
@@ -26,6 +26,7 @@
 #define X942KDF_MAX_INLEN (1 &lt;&lt; 30)
 
 static OSSL_FUNC_kdf_newctx_fn x942kdf_new;
+static OSSL_FUNC_kdf_dupctx_fn x942kdf_dup;
 static OSSL_FUNC_kdf_freectx_fn x942kdf_free;
 static OSSL_FUNC_kdf_reset_fn x942kdf_reset;
 static OSSL_FUNC_kdf_derive_fn x942kdf_derive;
@@ -368,6 +369,41 @@ static void x942kdf_free(void *vctx)
     }
 }
 
+static void *x942kdf_dup(void *vctx)
+{
+    const KDF_X942 *src = (const KDF_X942 *)vctx;
+    KDF_X942 *dest;
+
+    dest = x942kdf_new(src-&gt;provctx);
+    if (dest != NULL) {
+        if (!ossl_prov_memdup(src-&gt;secret, src-&gt;secret_len,
+                              &amp;dest-&gt;secret , &amp;dest-&gt;secret_len)
+                || !ossl_prov_memdup(src-&gt;acvpinfo, src-&gt;acvpinfo_len,
+                                     &amp;dest-&gt;acvpinfo , &amp;dest-&gt;acvpinfo_len)
+                || !ossl_prov_memdup(src-&gt;partyuinfo, src-&gt;partyuinfo_len,
+                                     &amp;dest-&gt;partyuinfo , &amp;dest-&gt;partyuinfo_len)
+                || !ossl_prov_memdup(src-&gt;partyvinfo, src-&gt;partyvinfo_len,
+                                     &amp;dest-&gt;partyvinfo , &amp;dest-&gt;partyvinfo_len)
+                || !ossl_prov_memdup(src-&gt;supp_pubinfo, src-&gt;supp_pubinfo_len,
+                                     &amp;dest-&gt;supp_pubinfo,
+                                     &amp;dest-&gt;supp_pubinfo_len)
+                || !ossl_prov_memdup(src-&gt;supp_privinfo, src-&gt;supp_privinfo_len,
+                                     &amp;dest-&gt;supp_privinfo,
+                                     &amp;dest-&gt;supp_privinfo_len)
+                || !ossl_prov_digest_copy(&amp;dest-&gt;digest, &amp;src-&gt;digest))
+            goto err;
+        dest-&gt;cek_oid = src-&gt;cek_oid;
+        dest-&gt;cek_oid_len = src-&gt;cek_oid_len;
+        dest-&gt;dkm_len = src-&gt;dkm_len;
+        dest-&gt;use_keybits = src-&gt;use_keybits;
+    }
+    return dest;
+
+ err:
+    x942kdf_free(dest);
+    return NULL;
+}
+
 static int x942kdf_set_buffer(unsigned char **out, size_t *out_len,
                               const OSSL_PARAM *p)
 {
@@ -579,6 +615,7 @@ static const OSSL_PARAM *x942kdf_gettable_ctx_params(ossl_unused void *ctx,
 
 const OSSL_DISPATCH ossl_kdf_x942_kdf_functions[] = {
     { OSSL_FUNC_KDF_NEWCTX, (void(*)(void))x942kdf_new },
+    { OSSL_FUNC_KDF_DUPCTX, (void(*)(void))x942kdf_dup },
     { OSSL_FUNC_KDF_FREECTX, (void(*)(void))x942kdf_free },
     { OSSL_FUNC_KDF_RESET, (void(*)(void))x942kdf_reset },
     { OSSL_FUNC_KDF_DERIVE, (void(*)(void))x942kdf_derive },
diff --git a/test/evp_pkey_provided_test.c b/test/evp_pkey_provided_test.c
index b4a77f8500..ebd09544df 100644
--- a/test/evp_pkey_provided_test.c
+++ b/test/evp_pkey_provided_test.c
@@ -1693,11 +1693,10 @@ static OSSL_PARAM *do_construct_hkdf_params(char *digest, char *key,
     return params;
 }
 
-/* Test that EVP_PKEY_CTX_dup() fails gracefully for a KDF */
-static int test_evp_pkey_ctx_dup_kdf_fail(void)
+static int test_evp_pkey_ctx_dup_kdf(void)
 {
     int ret = 0;
-    size_t len = 0;
+    size_t len = 0, dlen = 0;
     EVP_PKEY_CTX *pctx = NULL, *dctx = NULL;
     OSSL_PARAM *params = NULL;
 
@@ -1708,10 +1707,12 @@ static int test_evp_pkey_ctx_dup_kdf_fail(void)
         goto err;
     if (!TEST_int_eq(EVP_PKEY_derive_init_ex(pctx, params), 1))
         goto err;
-    if (!TEST_int_eq(EVP_PKEY_derive(pctx, NULL, &amp;len), 1)
-        || !TEST_size_t_eq(len, SHA256_DIGEST_LENGTH))
+    if (!TEST_ptr(dctx = EVP_PKEY_CTX_dup(pctx)))
         goto err;
-    if (!TEST_ptr_null(dctx = EVP_PKEY_CTX_dup(pctx)))
+    if (!TEST_int_eq(EVP_PKEY_derive(pctx, NULL, &amp;len), 1)
+        || !TEST_size_t_eq(len, SHA256_DIGEST_LENGTH)
+        || !TEST_int_eq(EVP_PKEY_derive(dctx, NULL, &amp;dlen), 1)
+        || !TEST_size_t_eq(dlen, SHA256_DIGEST_LENGTH))
         goto err;
     ret = 1;
 err:
@@ -1731,7 +1732,7 @@ int setup_tests(void)
     if (!TEST_ptr(datadir = test_get_argument(0)))
         return 0;
 
-    ADD_TEST(test_evp_pkey_ctx_dup_kdf_fail);
+    ADD_TEST(test_evp_pkey_ctx_dup_kdf);
     ADD_TEST(test_evp_pkey_get_bn_param_large);
     ADD_TEST(test_fromdata_rsa);
 #ifndef OPENSSL_NO_DH
diff --git a/test/evp_test.c b/test/evp_test.c
index 34caec2c5d..5e106c64f0 100644
--- a/test/evp_test.c
+++ b/test/evp_test.c
@@ -2690,6 +2690,7 @@ static int kdf_test_run(EVP_TEST *t)
     KDF_DATA *expected = t-&gt;data;
     unsigned char *got = NULL;
     size_t got_len = expected-&gt;output_len;
+    EVP_KDF_CTX *ctx;
 
     if (!EVP_KDF_CTX_set_params(expected-&gt;ctx, expected-&gt;params)) {
         t-&gt;err = &quot;KDF_CTRL_ERROR&quot;;
@@ -2699,6 +2700,10 @@ static int kdf_test_run(EVP_TEST *t)
         t-&gt;err = &quot;INTERNAL_ERROR&quot;;
         goto err;
     }
+    if ((ctx = EVP_KDF_CTX_dup(expected-&gt;ctx)) != NULL) {
+        EVP_KDF_CTX_free(expected-&gt;ctx);
+        expected-&gt;ctx = ctx;
+    }
     if (EVP_KDF_derive(expected-&gt;ctx, got, got_len, NULL) &lt;= 0) {
         t-&gt;err = &quot;KDF_DERIVE_ERROR&quot;;
         goto err;
</PRE>





























<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="036170.html">[openssl]  master update
</A></li>
	<LI>Next message (by thread): <A HREF="036174.html">[openssl]  master update
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#36172">[ date ]</a>
              <a href="thread.html#36172">[ thread ]</a>
              <a href="subject.html#36172">[ subject ]</a>
              <a href="author.html#36172">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="../../../mailman/listinfo/openssl-commits.html">More information about the openssl-commits
mailing list</a><br>
</body></html>
