<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [openssl]  master update
   </TITLE>
   <LINK REL="Index" HREF="https://mta.openssl.org/pipermail/openssl-commits/2022-February/index.html" >
   <LINK REL="made" HREF="mailto:openssl-commits%40openssl.org?Subject=Re%3A%20%5Bopenssl%5D%20%20master%20update&In-Reply-To=%3C1645509549.039404.2641674.nullmailer%40dev.openssl.org%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="036287.html">
   <LINK REL="Next"  HREF="036292.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[openssl]  master update</H1>
    <B>Dr. Paul Dale</B> 
    <A HREF="mailto:openssl-commits%40openssl.org?Subject=Re%3A%20%5Bopenssl%5D%20%20master%20update&In-Reply-To=%3C1645509549.039404.2641674.nullmailer%40dev.openssl.org%3E"
       TITLE="[openssl]  master update">pauli at openssl.org
       </A><BR>
    <I>Tue Feb 22 05:59:09 UTC 2022</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="036287.html">[openssl]  master update
</A></li>
        <LI>Next message (by thread): <A HREF="036292.html">[openssl]  master update
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#36291">[ date ]</a>
              <a href="thread.html#36291">[ thread ]</a>
              <a href="subject.html#36291">[ subject ]</a>
              <a href="author.html#36291">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>The branch master has been updated
       via  f596bbe4da779b56eea34d96168b557d78e1149a (commit)
      from  7b3041eba1c6e177eede0d6311d53a6b9ff58051 (commit)


- Log -----------------------------------------------------------------
commit f596bbe4da779b56eea34d96168b557d78e1149a
Author: Deepankar Bhattacharjee &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">deepankar.b at in.ibm.com</A>&gt;
Date:   Mon Sep 20 10:45:15 2021 -0400

    chacha20 performance optimizations for ppc64le with 8x lanes,
    Performance increase around 50%.
    
    Co-authored-by: Madhusudhanan Duraisamy &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">madurais at in.ibm.com</A>&gt;
    
    Co-authored-by: Nilamjyoti Goswami &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">nilamgoswami at in.ibm.com</A>&gt;
    
    Co-authored-by: Siva Sundar Anbareeswaran &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">srisivasundar at in.ibm.com</A>&gt;
    
    Reviewed-by: Danny Tsen &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">dtsen at us.ibm.com</A>&gt;
    Tested-by: Danny Tsen &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">dtsen at us.ibm.com</A>&gt;
    Signed-off-by: Danny &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">dtsen at us.ibm.com</A>&gt;
    
    Reviewed-by: Tomas Mraz &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">tomas at openssl.org</A>&gt;
    Reviewed-by: Paul Dale &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">pauli at openssl.org</A>&gt;
    (Merged from <A HREF="https://github.com/openssl/openssl/pull/16637">https://github.com/openssl/openssl/pull/16637</A>)

-----------------------------------------------------------------------

Summary of changes:
 crypto/chacha/asm/chachap10-ppc.pl | 1354 ++++++++++++++++++++++++++++++++++++
 crypto/chacha/build.info           |    3 +-
 crypto/chacha/chacha_ppc.c         |   15 +-
 crypto/perlasm/ppc-xlate.pl        |   17 +
 crypto/ppccap.c                    |    9 +
 crypto/ppccpuid.pl                 |   11 +
 include/crypto/ppc_arch.h          |    1 +
 7 files changed, 1404 insertions(+), 6 deletions(-)
 create mode 100755 crypto/chacha/asm/chachap10-ppc.pl

diff --git a/crypto/chacha/asm/chachap10-ppc.pl b/crypto/chacha/asm/chachap10-ppc.pl
new file mode 100755
index 0000000000..752fc731e2
--- /dev/null
+++ b/crypto/chacha/asm/chachap10-ppc.pl
@@ -0,0 +1,1354 @@
+#! /usr/bin/env perl
+# Copyright 2016-2020 The OpenSSL Project Authors. All Rights Reserved.
+#
+# Licensed under the Apache License 2.0 (the &quot;License&quot;).  You may not use
+# this file except in compliance with the License.  You can obtain a copy
+# in the file LICENSE in the source distribution or at
+# <A HREF="https://www.openssl.org/source/license.html">https://www.openssl.org/source/license.html</A>
+
+#
+# ====================================================================
+# Written by Andy Polyakov &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">appro at openssl.org</A>&gt; for the OpenSSL
+# project. The module is, however, dual licensed under OpenSSL and
+# CRYPTOGAMS licenses depending on where you obtain it. For further
+# details see <A HREF="http://www.openssl.org/~appro/cryptogams/.">http://www.openssl.org/~appro/cryptogams/.</A>
+# ====================================================================
+#
+# October 2015
+#
+# ChaCha20 for PowerPC/AltiVec.
+#
+# June 2018
+#
+# Add VSX 2.07 code path. Original 3xAltiVec+1xIALU is well-suited for
+# processors that can't issue more than one vector instruction per
+# cycle. But POWER8 (and POWER9) can issue a pair, and vector-only 4x
+# interleave would perform better. Incidentally PowerISA 2.07 (first
+# implemented by POWER8) defined new usable instructions, hence 4xVSX
+# code path...
+#
+# Performance in cycles per byte out of large buffer.
+#
+#			IALU/gcc-4.x    3xAltiVec+1xIALU	4xVSX
+#
+# Freescale e300	13.6/+115%	-			-
+# PPC74x0/G4e		6.81/+310%	3.81			-
+# PPC970/G5		9.29/+160%	?			-
+# POWER7		8.62/+61%	3.35			-
+# POWER8		8.70/+51%	2.91			2.09
+# POWER9		8.80/+29%	4.44(*)			2.45(**)
+#
+# (*)	this is trade-off result, it's possible to improve it, but
+#	then it would negatively affect all others;
+# (**)	POWER9 seems to be &quot;allergic&quot; to mixing vector and integer
+#	instructions, which is why switch to vector-only code pays
+#	off that much;
+
+# $output is the last argument if it looks like a file (it has an extension)
+# $flavour is the first argument if it doesn't look like a file
+$output = $#ARGV &gt;= 0 &amp;&amp; $ARGV[$#ARGV] =~ m|\.\w+$| ? pop : undef;
+$flavour = $#ARGV &gt;= 0 &amp;&amp; $ARGV[0] !~ m|\.| ? shift : undef;
+
+if ($flavour =~ /64/) {
+	$SIZE_T	=8;
+	$LRSAVE	=2*$SIZE_T;
+	$STU	=&quot;stdu&quot;;
+	$POP	=&quot;ld&quot;;
+	$PUSH	=&quot;std&quot;;
+	$UCMP	=&quot;cmpld&quot;;
+} elsif ($flavour =~ /32/) {
+	$SIZE_T	=4;
+	$LRSAVE	=$SIZE_T;
+	$STU	=&quot;stwu&quot;;
+	$POP	=&quot;lwz&quot;;
+	$PUSH	=&quot;stw&quot;;
+	$UCMP	=&quot;cmplw&quot;;
+} else { die &quot;nonsense $flavour&quot;; }
+
+$LITTLE_ENDIAN = ($flavour=~/le$/) ? 1 : 0;
+
+$0 =~ m/(.*[\/\\])[^\/\\]+$/; $dir=$1;
+( $xlate=&quot;${dir}ppc-xlate.pl&quot; and -f $xlate ) or
+( $xlate=&quot;${dir}../../perlasm/ppc-xlate.pl&quot; and -f $xlate) or
+die &quot;can't locate ppc-xlate.pl&quot;;
+
+open STDOUT,&quot;| $^X $xlate $flavour \&quot;$output\&quot;&quot;
+    or die &quot;can't call $xlate: $!&quot;;
+
+$LOCALS=6*$SIZE_T;
+$FRAME=$LOCALS+64+18*$SIZE_T;	# 64 is for local variables
+
+sub AUTOLOAD()		# thunk [simplified] x86-style perlasm
+{ my $opcode = $AUTOLOAD; $opcode =~ s/.*:://; $opcode =~ s/_/\./;
+    $code .= &quot;\t$opcode\t&quot;.join(','<A HREF="../../../mailman/listinfo/openssl-commits.html">, at _</A>).&quot;\n&quot;;
+}
+
+my $sp = &quot;r1&quot;;
+
+my ($out,$inp,$len,$key,$ctr) = map(&quot;r$_&quot;,(3..7));
+
+
+{{{
+my ($xa0,$xa1,$xa2,$xa3, $xb0,$xb1,$xb2,$xb3,
+    $xc0,$xc1,$xc2,$xc3, $xd0,$xd1,$xd2,$xd3) = map(&quot;v$_&quot;,(0..15));
+my @K = map(&quot;v$_&quot;,(16..19));
+my $CTR = &quot;v26&quot;;
+my ($xt0,$xt1,$xt2,$xt3) = map(&quot;v$_&quot;,(27..30));
+my ($sixteen,$twelve,$eight,$seven) = ($xt0,$xt1,$xt2,$xt3);
+my $beperm = &quot;v31&quot;;
+
+my ($x00,$x10,$x20,$x30) = (0, map(&quot;r$_&quot;,(8..10)));
+
+my $FRAME=$LOCALS+64+7*16;	# 7*16 is for v26-v31 offload
+
+sub VSX_lane_ROUND_1x {
+my $a=@_[0];
+my $b=@_[1];
+my $c=@_[2];
+my $d=@_[3];
+my $odd=@_[4];
+	vadduwm		($a,$a,$b);
+	vxor		($d,$d,$a);
+	vrlw		($d,$d,$sixteen);
+	vadduwm		($c,$c,$d);
+	vxor		($b,$b,$c);
+	vrlw		($b,$b,$twelve);
+	vadduwm		($a,$a,$b);
+	vxor		($d,$d,$a);
+	vrlw		($d,$d,$eight);
+	vadduwm		($c,$c,$d);
+	vxor		($b,$b,$c);
+	vrlw		($b,$b,$seven);
+	xxsldwi		($c,$c,$c,2);
+	xxsldwi		($b,$b,$b,$odd?3:1);
+	xxsldwi		($d,$d,$d,$odd?1:3);
+}
+
+
+sub VSX_lane_ROUND_4x {
+my ($a0,$b0,$c0,$d0)=@_;
+my ($a1,$b1,$c1,$d1)=map(($_&amp;~3)+(($_+1)&amp;3),($a0,$b0,$c0,$d0));
+my ($a2,$b2,$c2,$d2)=map(($_&amp;~3)+(($_+1)&amp;3),($a1,$b1,$c1,$d1));
+my ($a3,$b3,$c3,$d3)=map(($_&amp;~3)+(($_+1)&amp;3),($a2,$b2,$c2,$d2));
+my @x=map(&quot;\&quot;v$_\&quot;&quot;,(0..15));
+
+	(
+	&quot;&amp;vadduwm	(@x[$a0]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$a0]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$b0])&quot;,	# Q1
+	 &quot;&amp;vadduwm	(@x[$a1]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$a1]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$b1])&quot;,	# Q2
+	  &quot;&amp;vadduwm	(@x[$a2]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$a2]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$b2])&quot;,	# Q3
+	   &quot;&amp;vadduwm	(@x[$a3]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$a3]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$b3])&quot;,	# Q4
+	&quot;&amp;vxor		(@x[$d0]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$d0]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$a0])&quot;,
+	 &quot;&amp;vxor		(@x[$d1]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$d1]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$a1])&quot;,
+	  &quot;&amp;vxor	(@x[$d2]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$d2]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$a2])&quot;,
+	   &quot;&amp;vxor	(@x[$d3]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$d3]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$a3])&quot;,
+	&quot;&amp;vrlw		(@x[$d0]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$d0],'$sixteen')&quot;,
+	 &quot;&amp;vrlw		(@x[$d1]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$d1],'$sixteen')&quot;,
+	  &quot;&amp;vrlw	(@x[$d2]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$d2],'$sixteen')&quot;,
+	   &quot;&amp;vrlw	(@x[$d3]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$d3],'$sixteen')&quot;,
+
+	&quot;&amp;vadduwm	(@x[$c0]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$c0]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$d0])&quot;,
+	 &quot;&amp;vadduwm	(@x[$c1]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$c1]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$d1])&quot;,
+	  &quot;&amp;vadduwm	(@x[$c2]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$c2]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$d2])&quot;,
+	   &quot;&amp;vadduwm	(@x[$c3]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$c3]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$d3])&quot;,
+	&quot;&amp;vxor		(@x[$b0]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$b0]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$c0])&quot;,
+	 &quot;&amp;vxor		(@x[$b1]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$b1]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$c1])&quot;,
+	  &quot;&amp;vxor	(@x[$b2]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$b2]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$c2])&quot;,
+	   &quot;&amp;vxor	(@x[$b3]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$b3]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$c3])&quot;,
+	&quot;&amp;vrlw		(@x[$b0]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$b0],'$twelve')&quot;,
+	 &quot;&amp;vrlw		(@x[$b1]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$b1],'$twelve')&quot;,
+	  &quot;&amp;vrlw	(@x[$b2]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$b2],'$twelve')&quot;,
+	   &quot;&amp;vrlw	(@x[$b3]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$b3],'$twelve')&quot;,
+
+	&quot;&amp;vadduwm	(@x[$a0]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$a0]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$b0])&quot;,
+	 &quot;&amp;vadduwm	(@x[$a1]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$a1]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$b1])&quot;,
+	  &quot;&amp;vadduwm	(@x[$a2]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$a2]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$b2])&quot;,
+	   &quot;&amp;vadduwm	(@x[$a3]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$a3]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$b3])&quot;,
+	&quot;&amp;vxor		(@x[$d0]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$d0]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$a0])&quot;,
+	 &quot;&amp;vxor		(@x[$d1]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$d1]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$a1])&quot;,
+	  &quot;&amp;vxor	(@x[$d2]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$d2]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$a2])&quot;,
+	   &quot;&amp;vxor	(@x[$d3]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$d3]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$a3])&quot;,
+	&quot;&amp;vrlw		(@x[$d0]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$d0],'$eight')&quot;,
+	 &quot;&amp;vrlw		(@x[$d1]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$d1],'$eight')&quot;,
+	  &quot;&amp;vrlw	(@x[$d2]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$d2],'$eight')&quot;,
+	   &quot;&amp;vrlw	(@x[$d3]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$d3],'$eight')&quot;,
+
+	&quot;&amp;vadduwm	(@x[$c0]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$c0]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$d0])&quot;,
+	 &quot;&amp;vadduwm	(@x[$c1]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$c1]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$d1])&quot;,
+	  &quot;&amp;vadduwm	(@x[$c2]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$c2]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$d2])&quot;,
+	   &quot;&amp;vadduwm	(@x[$c3]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$c3]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$d3])&quot;,
+	&quot;&amp;vxor		(@x[$b0]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$b0]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$c0])&quot;,
+	 &quot;&amp;vxor		(@x[$b1]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$b1]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$c1])&quot;,
+	  &quot;&amp;vxor	(@x[$b2]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$b2]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$c2])&quot;,
+	   &quot;&amp;vxor	(@x[$b3]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$b3]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$c3])&quot;,
+	&quot;&amp;vrlw		(@x[$b0]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$b0],'$seven')&quot;,
+	 &quot;&amp;vrlw		(@x[$b1]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$b1],'$seven')&quot;,
+	  &quot;&amp;vrlw	(@x[$b2]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$b2],'$seven')&quot;,
+	   &quot;&amp;vrlw	(@x[$b3]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$b3],'$seven')&quot;
+	);
+}
+
+$code.=&lt;&lt;___;
+
+.globl	.ChaCha20_ctr32_vsx_p10
+.align	5
+.ChaCha20_ctr32_vsx_p10:
+	${UCMP}i $len,256
+	bgt 	ChaCha20_ctr32_vsx_8x
+	$STU	$sp,-$FRAME($sp)
+	mflr	r0
+	li	r10,`15+$LOCALS+64`
+	li	r11,`31+$LOCALS+64`
+	mfspr	r12,256
+	stvx	v26,r10,$sp
+	addi	r10,r10,32
+	stvx	v27,r11,$sp
+	addi	r11,r11,32
+	stvx	v28,r10,$sp
+	addi	r10,r10,32
+	stvx	v29,r11,$sp
+	addi	r11,r11,32
+	stvx	v30,r10,$sp
+	stvx	v31,r11,$sp
+	stw	r12,`$FRAME-4`($sp)		# save vrsave
+	li	r12,-4096+63
+	$PUSH	r0, `$FRAME+$LRSAVE`($sp)
+	mtspr	256,r12				# preserve 29 AltiVec registers
+
+	bl	Lconsts				# returns pointer Lsigma in r12
+	lvx_4w	@K[0],0,r12			# load sigma
+	addi	r12,r12,0x70
+	li	$x10,16
+	li	$x20,32
+	li	$x30,48
+	li	r11,64
+
+	lvx_4w	@K[1],0,$key			# load key
+	lvx_4w	@K[2],$x10,$key
+	lvx_4w	@K[3],0,$ctr			# load counter
+
+	vxor	$xt0,$xt0,$xt0
+	lvx_4w	$xt1,r11,r12
+	vspltw	$<A HREF="../../../mailman/listinfo/openssl-commits.html">CTR, at K</A>[3],0
+	vsldoi	@K[3]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at K</A>[3],$xt0,4
+	vsldoi	@K[3],$<A HREF="../../../mailman/listinfo/openssl-commits.html">xt0, at K</A>[3],12		# clear @K[3].word[0]
+	vadduwm	$CTR,$CTR,$xt1
+
+	be?lvsl	$beperm,0,$x10			# 0x00..0f
+	be?vspltisb $xt0,3			# 0x03..03
+	be?vxor	$beperm,$beperm,$xt0		# swap bytes within words
+
+	li	r0,10				# inner loop counter
+	mtctr	r0
+	b	Loop_outer_vsx
+
+.align	5
+Loop_outer_vsx:
+	lvx	$xa0,$x00,r12			# load [smashed] sigma
+	lvx	$xa1,$x10,r12
+	lvx	$xa2,$x20,r12
+	lvx	$xa3,$x30,r12
+
+	vspltw	$<A HREF="../../../mailman/listinfo/openssl-commits.html">xb0, at K</A>[1],0			# smash the key
+	vspltw	$<A HREF="../../../mailman/listinfo/openssl-commits.html">xb1, at K</A>[1],1
+	vspltw	$<A HREF="../../../mailman/listinfo/openssl-commits.html">xb2, at K</A>[1],2
+	vspltw	$<A HREF="../../../mailman/listinfo/openssl-commits.html">xb3, at K</A>[1],3
+
+	vspltw	$<A HREF="../../../mailman/listinfo/openssl-commits.html">xc0, at K</A>[2],0
+	vspltw	$<A HREF="../../../mailman/listinfo/openssl-commits.html">xc1, at K</A>[2],1
+	vspltw	$<A HREF="../../../mailman/listinfo/openssl-commits.html">xc2, at K</A>[2],2
+	vspltw	$<A HREF="../../../mailman/listinfo/openssl-commits.html">xc3, at K</A>[2],3
+
+	vmr	$xd0,$CTR			# smash the counter
+	vspltw	$<A HREF="../../../mailman/listinfo/openssl-commits.html">xd1, at K</A>[3],1
+	vspltw	$<A HREF="../../../mailman/listinfo/openssl-commits.html">xd2, at K</A>[3],2
+	vspltw	$<A HREF="../../../mailman/listinfo/openssl-commits.html">xd3, at K</A>[3],3
+
+	vspltisw $sixteen,-16			# synthesize constants
+	vspltisw $twelve,12
+	vspltisw $eight,8
+	vspltisw $seven,7
+
+	${UCMP}i $len,64
+	bgt 	Loop_vsx_4x
+
+	vmr	$<A HREF="../../../mailman/listinfo/openssl-commits.html">xa0, at K</A>[0]
+	vmr	$<A HREF="../../../mailman/listinfo/openssl-commits.html">xb0, at K</A>[1]
+	vmr	$<A HREF="../../../mailman/listinfo/openssl-commits.html">xc0, at K</A>[2]
+	vmr 	$<A HREF="../../../mailman/listinfo/openssl-commits.html">xd0, at K</A>[3]
+
+Loop_vsx_1x:
+___
+	VSX_lane_ROUND_1x($xa0, $xb0, $xc0,$xd0,0);
+	VSX_lane_ROUND_1x($xa0, $xb0, $xc0,$xd0,1);
+
+$code.=&lt;&lt;___;
+
+	bdnz	Loop_vsx_1x
+
+	vadduwm $xa0, $xa0, @K[0]
+	vadduwm $xb0, $xb0, @K[1]
+	vadduwm $xc0, $xc0, @K[2]
+	vadduwm $xd0, $xd0, @K[3]
+	${UCMP}i $len,0x40
+	blt	Ltail_vsx
+
+	lvx_4w  $xt0,$x00, $inp
+	lvx_4w  $xt1,$x10, $inp
+	lvx_4w  $xt2,$x20, $inp
+	lvx_4w  $xt3,$x30, $inp
+
+	vxor	$xa0,$xa0,$xt0
+	vxor	$xb0,$xb0,$xt1
+	vxor	$xc0,$xc0,$xt2
+	vxor	$xd0,$xd0,$xt3
+
+	stvx_4w	$xa0,$x00,$out
+	stvx_4w	$xb0,$x10,$out
+	addi	$inp,$inp,0x40
+	stvx_4w	$xc0,$x20,$out
+	subi	$len,$len,0x40
+	stvx_4w	$xd0,$x30,$out
+	addi	$out,$out,0x40
+	beq	Ldone_vsx
+
+Loop_vsx_4x:
+___
+	foreach (&amp;VSX_lane_ROUND_4x(0, 4, 8,12)) { eval; }
+	foreach (&amp;VSX_lane_ROUND_4x(0, 5,10,15)) { eval; }
+$code.=&lt;&lt;___;
+
+	bdnz	Loop_vsx_4x
+
+	vadduwm	$xd0,$xd0,$CTR
+
+	vmrgew	$xt0,$xa0,$xa1			# transpose data
+	vmrgew	$xt1,$xa2,$xa3
+	vmrgow	$xa0,$xa0,$xa1
+	vmrgow	$xa2,$xa2,$xa3
+	vmrgew	$xt2,$xb0,$xb1
+	vmrgew	$xt3,$xb2,$xb3
+	vpermdi	$xa1,$xa0,$xa2,0b00
+	vpermdi	$xa3,$xa0,$xa2,0b11
+	vpermdi	$xa0,$xt0,$xt1,0b00
+	vpermdi	$xa2,$xt0,$xt1,0b11
+
+	vmrgow	$xb0,$xb0,$xb1
+	vmrgow	$xb2,$xb2,$xb3
+	vmrgew	$xt0,$xc0,$xc1
+	vmrgew	$xt1,$xc2,$xc3
+	vpermdi	$xb1,$xb0,$xb2,0b00
+	vpermdi	$xb3,$xb0,$xb2,0b11
+	vpermdi	$xb0,$xt2,$xt3,0b00
+	vpermdi	$xb2,$xt2,$xt3,0b11
+
+	vmrgow	$xc0,$xc0,$xc1
+	vmrgow	$xc2,$xc2,$xc3
+	vmrgew	$xt2,$xd0,$xd1
+	vmrgew	$xt3,$xd2,$xd3
+	vpermdi	$xc1,$xc0,$xc2,0b00
+	vpermdi	$xc3,$xc0,$xc2,0b11
+	vpermdi	$xc0,$xt0,$xt1,0b00
+	vpermdi	$xc2,$xt0,$xt1,0b11
+
+	vmrgow	$xd0,$xd0,$xd1
+	vmrgow	$xd2,$xd2,$xd3
+	vspltisw $xt0,4
+	vadduwm  $CTR,$CTR,$xt0		# next counter value
+	vpermdi	$xd1,$xd0,$xd2,0b00
+	vpermdi	$xd3,$xd0,$xd2,0b11
+	vpermdi	$xd0,$xt2,$xt3,0b00
+	vpermdi	$xd2,$xt2,$xt3,0b11
+
+	vadduwm	$xa0,$<A HREF="../../../mailman/listinfo/openssl-commits.html">xa0, at K</A>[0]
+	vadduwm	$xb0,$<A HREF="../../../mailman/listinfo/openssl-commits.html">xb0, at K</A>[1]
+	vadduwm	$xc0,$<A HREF="../../../mailman/listinfo/openssl-commits.html">xc0, at K</A>[2]
+	vadduwm	$xd0,$<A HREF="../../../mailman/listinfo/openssl-commits.html">xd0, at K</A>[3]
+
+	be?vperm $xa0,$xa0,$xa0,$beperm
+	be?vperm $xb0,$xb0,$xb0,$beperm
+	be?vperm $xc0,$xc0,$xc0,$beperm
+	be?vperm $xd0,$xd0,$xd0,$beperm
+
+	${UCMP}i $len,0x40
+	blt	Ltail_vsx
+
+	lvx_4w	$xt0,$x00,$inp
+	lvx_4w	$xt1,$x10,$inp
+	lvx_4w	$xt2,$x20,$inp
+	lvx_4w	$xt3,$x30,$inp
+
+	vxor	$xt0,$xt0,$xa0
+	vxor	$xt1,$xt1,$xb0
+	vxor	$xt2,$xt2,$xc0
+	vxor	$xt3,$xt3,$xd0
+
+	stvx_4w	$xt0,$x00,$out
+	stvx_4w	$xt1,$x10,$out
+	addi	$inp,$inp,0x40
+	stvx_4w	$xt2,$x20,$out
+	subi	$len,$len,0x40
+	stvx_4w	$xt3,$x30,$out
+	addi	$out,$out,0x40
+	beq	Ldone_vsx
+
+	vadduwm	$xa0,$<A HREF="../../../mailman/listinfo/openssl-commits.html">xa1, at K</A>[0]
+	vadduwm	$xb0,$<A HREF="../../../mailman/listinfo/openssl-commits.html">xb1, at K</A>[1]
+	vadduwm	$xc0,$<A HREF="../../../mailman/listinfo/openssl-commits.html">xc1, at K</A>[2]
+	vadduwm	$xd0,$<A HREF="../../../mailman/listinfo/openssl-commits.html">xd1, at K</A>[3]
+
+	be?vperm $xa0,$xa0,$xa0,$beperm
+	be?vperm $xb0,$xb0,$xb0,$beperm
+	be?vperm $xc0,$xc0,$xc0,$beperm
+	be?vperm $xd0,$xd0,$xd0,$beperm
+
+	${UCMP}i $len,0x40
+	blt	Ltail_vsx
+
+	lvx_4w	$xt0,$x00,$inp
+	lvx_4w	$xt1,$x10,$inp
+	lvx_4w	$xt2,$x20,$inp
+	lvx_4w	$xt3,$x30,$inp
+
+	vxor	$xt0,$xt0,$xa0
+	vxor	$xt1,$xt1,$xb0
+	vxor	$xt2,$xt2,$xc0
+	vxor	$xt3,$xt3,$xd0
+
+	stvx_4w	$xt0,$x00,$out
+	stvx_4w	$xt1,$x10,$out
+	addi	$inp,$inp,0x40
+	stvx_4w	$xt2,$x20,$out
+	subi	$len,$len,0x40
+	stvx_4w	$xt3,$x30,$out
+	addi	$out,$out,0x40
+	beq	Ldone_vsx
+
+	vadduwm	$xa0,$<A HREF="../../../mailman/listinfo/openssl-commits.html">xa2, at K</A>[0]
+	vadduwm	$xb0,$<A HREF="../../../mailman/listinfo/openssl-commits.html">xb2, at K</A>[1]
+	vadduwm	$xc0,$<A HREF="../../../mailman/listinfo/openssl-commits.html">xc2, at K</A>[2]
+	vadduwm	$xd0,$<A HREF="../../../mailman/listinfo/openssl-commits.html">xd2, at K</A>[3]
+
+	be?vperm $xa0,$xa0,$xa0,$beperm
+	be?vperm $xb0,$xb0,$xb0,$beperm
+	be?vperm $xc0,$xc0,$xc0,$beperm
+	be?vperm $xd0,$xd0,$xd0,$beperm
+
+	${UCMP}i $len,0x40
+	blt	Ltail_vsx
+
+	lvx_4w	$xt0,$x00,$inp
+	lvx_4w	$xt1,$x10,$inp
+	lvx_4w	$xt2,$x20,$inp
+	lvx_4w	$xt3,$x30,$inp
+
+	vxor	$xt0,$xt0,$xa0
+	vxor	$xt1,$xt1,$xb0
+	vxor	$xt2,$xt2,$xc0
+	vxor	$xt3,$xt3,$xd0
+
+	stvx_4w	$xt0,$x00,$out
+	stvx_4w	$xt1,$x10,$out
+	addi	$inp,$inp,0x40
+	stvx_4w	$xt2,$x20,$out
+	subi	$len,$len,0x40
+	stvx_4w	$xt3,$x30,$out
+	addi	$out,$out,0x40
+	beq	Ldone_vsx
+
+	vadduwm	$xa0,$<A HREF="../../../mailman/listinfo/openssl-commits.html">xa3, at K</A>[0]
+	vadduwm	$xb0,$<A HREF="../../../mailman/listinfo/openssl-commits.html">xb3, at K</A>[1]
+	vadduwm	$xc0,$<A HREF="../../../mailman/listinfo/openssl-commits.html">xc3, at K</A>[2]
+	vadduwm	$xd0,$<A HREF="../../../mailman/listinfo/openssl-commits.html">xd3, at K</A>[3]
+
+	be?vperm $xa0,$xa0,$xa0,$beperm
+	be?vperm $xb0,$xb0,$xb0,$beperm
+	be?vperm $xc0,$xc0,$xc0,$beperm
+	be?vperm $xd0,$xd0,$xd0,$beperm
+
+	${UCMP}i $len,0x40
+	blt	Ltail_vsx
+
+	lvx_4w	$xt0,$x00,$inp
+	lvx_4w	$xt1,$x10,$inp
+	lvx_4w	$xt2,$x20,$inp
+	lvx_4w	$xt3,$x30,$inp
+
+	vxor	$xt0,$xt0,$xa0
+	vxor	$xt1,$xt1,$xb0
+	vxor	$xt2,$xt2,$xc0
+	vxor	$xt3,$xt3,$xd0
+
+	stvx_4w	$xt0,$x00,$out
+	stvx_4w	$xt1,$x10,$out
+	addi	$inp,$inp,0x40
+	stvx_4w	$xt2,$x20,$out
+	subi	$len,$len,0x40
+	stvx_4w	$xt3,$x30,$out
+	addi	$out,$out,0x40
+	mtctr	r0
+	bne	Loop_outer_vsx
+
+Ldone_vsx:
+	lwz	r12,`$FRAME-4`($sp)		# pull vrsave
+	li	r10,`15+$LOCALS+64`
+	li	r11,`31+$LOCALS+64`
+	$POP	r0, `$FRAME+$LRSAVE`($sp)
+	mtspr	256,r12				# restore vrsave
+	lvx	v26,r10,$sp
+	addi	r10,r10,32
+	lvx	v27,r11,$sp
+	addi	r11,r11,32
+	lvx	v28,r10,$sp
+	addi	r10,r10,32
+	lvx	v29,r11,$sp
+	addi	r11,r11,32
+	lvx	v30,r10,$sp
+	lvx	v31,r11,$sp
+	mtlr	r0
+	addi	$sp,$sp,$FRAME
+	blr
+
+.align	4
+Ltail_vsx:
+	addi	r11,$sp,$LOCALS
+	mtctr	$len
+	stvx_4w	$xa0,$x00,r11			# offload block to stack
+	stvx_4w	$xb0,$x10,r11
+	stvx_4w	$xc0,$x20,r11
+	stvx_4w	$xd0,$x30,r11
+	subi	r12,r11,1			# prepare for *++ptr
+	subi	$inp,$inp,1
+	subi	$out,$out,1
+
+Loop_tail_vsx:
+	lbzu	r6,1(r12)
+	lbzu	r7,1($inp)
+	xor	r6,r6,r7
+	stbu	r6,1($out)
+	bdnz	Loop_tail_vsx
+
+	stvx_4w	$K[0],$x00,r11			# wipe copy of the block
+	stvx_4w	$K[0],$x10,r11
+	stvx_4w	$K[0],$x20,r11
+	stvx_4w	$K[0],$x30,r11
+
+	b	Ldone_vsx
+	.long	0
+	.byte	0,12,0x04,1,0x80,0,5,0
+	.long	0
+.size	.ChaCha20_ctr32_vsx_p10,.-.ChaCha20_ctr32_vsx_p10
+___
+}}}
+
+##This is 8 block in parallel implementation. The heart of chacha round uses vector instruction that has access to 
+# vsr[32+X]. To perform the 8 parallel block we tend to use all 32 register to hold the 8 block info.
+# WE need to store few register value on side, so we can use VSR{32+X} for few vector instructions used in round op and hold intermediate value.
+# WE use the VSR[0]-VSR[31] for holding intermediate value and perform 8 block in parallel.
+#
+{{{
+#### ($out,$inp,$len,$key,$ctr) = map(&quot;r$_&quot;,(3..7));
+my ($xa0,$xa1,$xa2,$xa3, $xb0,$xb1,$xb2,$xb3,
+    $xc0,$xc1,$xc2,$xc3, $xd0,$xd1,$xd2,$xd3,
+    $xa4,$xa5,$xa6,$xa7, $xb4,$xb5,$xb6,$xb7,
+    $xc4,$xc5,$xc6,$xc7, $xd4,$xd5,$xd6,$xd7) = map(&quot;v$_&quot;,(0..31));
+my ($xcn4,$xcn5,$xcn6,$xcn7, $xdn4,$xdn5,$xdn6,$xdn7) = map(&quot;v$_&quot;,(8..15));
+my ($xan0,$xbn0,$xcn0,$xdn0) = map(&quot;v$_&quot;,(0..3));
+my @K = map(&quot;v$_&quot;,27,(24..26));
+my ($xt0,$xt1,$xt2,$xt3,$xt4) = map(&quot;v$_&quot;,23,(28..31));
+my $xr0 = &quot;v4&quot;;
+my $CTR0 = &quot;v22&quot;;
+my $CTR1 = &quot;v5&quot;;
+my $beperm = &quot;v31&quot;;
+my ($x00,$x10,$x20,$x30) = (0, map(&quot;r$_&quot;,(8..10)));
+my ($xv0,$xv1,$xv2,$xv3,$xv4,$xv5,$xv6,$xv7) = map(&quot;v$_&quot;,(0..7));
+my ($xv8,$xv9,$xv10,$xv11,$xv12,$xv13,$xv14,$xv15,$xv16,$xv17) = map(&quot;v$_&quot;,(8..17));
+my ($xv18,$xv19,$xv20,$xv21) = map(&quot;v$_&quot;,(18..21));
+my ($xv22,$xv23,$xv24,$xv25,$xv26) = map(&quot;v$_&quot;,(22..26));
+
+my $FRAME=$LOCALS+64+9*16;	# 8*16 is for v24-v31 offload
+
+sub VSX_lane_ROUND_8x {
+my ($a0,$b0,$c0,$d0,$a4,$b4,$c4,$d4)=@_;
+my ($a1,$b1,$c1,$d1)=map(($_&amp;~3)+(($_+1)&amp;3),($a0,$b0,$c0,$d0));
+my ($a2,$b2,$c2,$d2)=map(($_&amp;~3)+(($_+1)&amp;3),($a1,$b1,$c1,$d1));
+my ($a3,$b3,$c3,$d3)=map(($_&amp;~3)+(($_+1)&amp;3),($a2,$b2,$c2,$d2));
+my ($a5,$b5,$c5,$d5)=map(($_&amp;~3)+(($_+1)&amp;3),($a4,$b4,$c4,$d4));
+my ($a6,$b6,$c6,$d6)=map(($_&amp;~3)+(($_+1)&amp;3),($a5,$b5,$c5,$d5));
+my ($a7,$b7,$c7,$d7)=map(($_&amp;~3)+(($_+1)&amp;3),($a6,$b6,$c6,$d6));
+my ($xv8,$xv9,$xv10,$xv11,$xv12,$xv13,$xv14,$xv15,$xv16,$xv17) = map(&quot;\&quot;v$_\&quot;&quot;,(8..17));
+my @x=map(&quot;\&quot;v$_\&quot;&quot;,(0..31));
+
+	(
+	&quot;&amp;vxxlor        ($xv15 <A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$c7]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$c7])&quot;,      #copy v30 to v13
+	&quot;&amp;vxxlorc       (@x[$c7], $xv9,$xv9)&quot;,
+
+	&quot;&amp;vadduwm	(@x[$a0]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$a0]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$b0])&quot;,	# Q1
+	 &quot;&amp;vadduwm	(@x[$a1]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$a1]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$b1])&quot;,	# Q2
+	  &quot;&amp;vadduwm	(@x[$a2]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$a2]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$b2])&quot;,	# Q3
+	   &quot;&amp;vadduwm	(@x[$a3]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$a3]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$b3])&quot;,	# Q4
+	&quot;&amp;vadduwm	(@x[$a4]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$a4]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$b4])&quot;,	# Q1
+	 &quot;&amp;vadduwm	(@x[$a5]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$a5]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$b5])&quot;,	# Q2
+	  &quot;&amp;vadduwm	(@x[$a6]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$a6]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$b6])&quot;,	# Q3
+	   &quot;&amp;vadduwm	(@x[$a7]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$a7]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$b7])&quot;,	# Q4
+
+	&quot;&amp;vxor		(@x[$d0]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$d0]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$a0])&quot;,
+	 &quot;&amp;vxor		(@x[$d1]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$d1]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$a1])&quot;,
+	  &quot;&amp;vxor	(@x[$d2]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$d2]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$a2])&quot;,
+	   &quot;&amp;vxor	(@x[$d3]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$d3]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$a3])&quot;,
+	&quot;&amp;vxor		(@x[$d4]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$d4]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$a4])&quot;,
+	 &quot;&amp;vxor		(@x[$d5]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$d5]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$a5])&quot;,
+	  &quot;&amp;vxor	(@x[$d6]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$d6]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$a6])&quot;,
+	   &quot;&amp;vxor	(@x[$d7]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$d7]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$a7])&quot;,
+
+	&quot;&amp;vrlw		(@x[$d0]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$d0]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$c7])&quot;,
+	 &quot;&amp;vrlw		(@x[$d1]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$d1]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$c7])&quot;,
+	  &quot;&amp;vrlw	(@x[$d2]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$d2]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$c7])&quot;,
+	   &quot;&amp;vrlw	(@x[$d3]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$d3]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$c7])&quot;,
+	&quot;&amp;vrlw		(@x[$d4]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$d4]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$c7])&quot;,
+	 &quot;&amp;vrlw		(@x[$d5]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$d5]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$c7])&quot;,
+	  &quot;&amp;vrlw	(@x[$d6]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$d6]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$c7])&quot;,
+	   &quot;&amp;vrlw	(@x[$d7]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$d7]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$c7])&quot;,
+
+	&quot;&amp;vxxlor        ($xv13 <A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$a7]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$a7])&quot;,
+	&quot;&amp;vxxlorc       (@x[$c7], $xv15,$xv15)&quot;,
+	&quot;&amp;vxxlorc       (@x[$a7], $xv10,$xv10)&quot;,
+
+	&quot;&amp;vadduwm	(@x[$c0]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$c0]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$d0])&quot;,
+	 &quot;&amp;vadduwm	(@x[$c1]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$c1]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$d1])&quot;,
+	  &quot;&amp;vadduwm	(@x[$c2]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$c2]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$d2])&quot;,
+	   &quot;&amp;vadduwm	(@x[$c3]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$c3]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$d3])&quot;,
+	&quot;&amp;vadduwm	(@x[$c4]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$c4]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$d4])&quot;,
+	 &quot;&amp;vadduwm	(@x[$c5]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$c5]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$d5])&quot;,
+	  &quot;&amp;vadduwm	(@x[$c6]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$c6]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$d6])&quot;,
+	   &quot;&amp;vadduwm	(@x[$c7]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$c7]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$d7])&quot;,
+
+	&quot;&amp;vxor		(@x[$b0]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$b0]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$c0])&quot;,
+	 &quot;&amp;vxor		(@x[$b1]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$b1]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$c1])&quot;,
+	  &quot;&amp;vxor	(@x[$b2]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$b2]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$c2])&quot;,
+	   &quot;&amp;vxor	(@x[$b3]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$b3]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$c3])&quot;,
+	&quot;&amp;vxor		(@x[$b4]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$b4]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$c4])&quot;,
+	 &quot;&amp;vxor		(@x[$b5]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$b5]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$c5])&quot;,
+	  &quot;&amp;vxor	(@x[$b6]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$b6]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$c6])&quot;,
+	   &quot;&amp;vxor	(@x[$b7]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$b7]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$c7])&quot;,
+
+	&quot;&amp;vrlw		(@x[$b0]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$b0]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$a7])&quot;,
+	 &quot;&amp;vrlw		(@x[$b1]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$b1]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$a7])&quot;,
+	  &quot;&amp;vrlw	(@x[$b2]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$b2]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$a7])&quot;,
+	   &quot;&amp;vrlw	(@x[$b3]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$b3]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$a7])&quot;,
+	&quot;&amp;vrlw		(@x[$b4]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$b4]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$a7])&quot;,
+	 &quot;&amp;vrlw		(@x[$b5]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$b5]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$a7])&quot;,
+	  &quot;&amp;vrlw	(@x[$b6]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$b6]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$a7])&quot;,
+	   &quot;&amp;vrlw	(@x[$b7]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$b7]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$a7])&quot;,
+
+	&quot;&amp;vxxlorc       (@x[$a7], $xv13,$xv13)&quot;,
+	&quot;&amp;vxxlor	($xv15 <A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$c7]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$c7])&quot;,                 
+	&quot;&amp;vxxlorc       (@x[$c7], $xv11,$xv11)&quot;,
+
+
+	&quot;&amp;vadduwm	(@x[$a0]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$a0]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$b0])&quot;,
+	 &quot;&amp;vadduwm	(@x[$a1]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$a1]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$b1])&quot;,
+	  &quot;&amp;vadduwm	(@x[$a2]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$a2]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$b2])&quot;,
+	   &quot;&amp;vadduwm	(@x[$a3]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$a3]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$b3])&quot;,
+	&quot;&amp;vadduwm	(@x[$a4]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$a4]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$b4])&quot;,
+	 &quot;&amp;vadduwm	(@x[$a5]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$a5]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$b5])&quot;,
+	  &quot;&amp;vadduwm	(@x[$a6]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$a6]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$b6])&quot;,
+	   &quot;&amp;vadduwm	(@x[$a7]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$a7]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$b7])&quot;,
+
+	&quot;&amp;vxor		(@x[$d0]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$d0]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$a0])&quot;,
+	 &quot;&amp;vxor		(@x[$d1]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$d1]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$a1])&quot;,
+	  &quot;&amp;vxor	(@x[$d2]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$d2]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$a2])&quot;,
+	   &quot;&amp;vxor	(@x[$d3]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$d3]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$a3])&quot;,
+	&quot;&amp;vxor		(@x[$d4]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$d4]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$a4])&quot;,
+	 &quot;&amp;vxor		(@x[$d5]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$d5]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$a5])&quot;,
+	  &quot;&amp;vxor	(@x[$d6]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$d6]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$a6])&quot;,
+	   &quot;&amp;vxor	(@x[$d7]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$d7]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$a7])&quot;,
+
+	&quot;&amp;vrlw		(@x[$d0]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$d0]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$c7])&quot;,
+	 &quot;&amp;vrlw		(@x[$d1]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$d1]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$c7])&quot;,
+	  &quot;&amp;vrlw	(@x[$d2]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$d2]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$c7])&quot;,
+	   &quot;&amp;vrlw	(@x[$d3]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$d3]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$c7])&quot;,
+	&quot;&amp;vrlw		(@x[$d4]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$d4]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$c7])&quot;,
+	 &quot;&amp;vrlw		(@x[$d5]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$d5]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$c7])&quot;,
+	  &quot;&amp;vrlw	(@x[$d6]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$d6]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$c7])&quot;,
+	   &quot;&amp;vrlw	(@x[$d7]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$d7]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$c7])&quot;,
+
+	&quot;&amp;vxxlorc       (@x[$c7], $xv15,$xv15)&quot;,
+	&quot;&amp;vxxlor        ($xv13 <A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$a7]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$a7])&quot;,               
+	&quot;&amp;vxxlorc       (@x[$a7], $xv12,$xv12)&quot;,
+
+	&quot;&amp;vadduwm	(@x[$c0]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$c0]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$d0])&quot;,
+	 &quot;&amp;vadduwm	(@x[$c1]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$c1]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$d1])&quot;,
+	  &quot;&amp;vadduwm	(@x[$c2]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$c2]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$d2])&quot;,
+	   &quot;&amp;vadduwm	(@x[$c3]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$c3]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$d3])&quot;,
+	&quot;&amp;vadduwm	(@x[$c4]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$c4]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$d4])&quot;,
+	 &quot;&amp;vadduwm	(@x[$c5]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$c5]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$d5])&quot;,
+	  &quot;&amp;vadduwm	(@x[$c6]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$c6]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$d6])&quot;,
+	   &quot;&amp;vadduwm	(@x[$c7]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$c7]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$d7])&quot;,
+	&quot;&amp;vxor		(@x[$b0]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$b0]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$c0])&quot;,
+	 &quot;&amp;vxor		(@x[$b1]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$b1]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$c1])&quot;,
+	  &quot;&amp;vxor	(@x[$b2]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$b2]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$c2])&quot;,
+	   &quot;&amp;vxor	(@x[$b3]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$b3]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$c3])&quot;,
+	&quot;&amp;vxor		(@x[$b4]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$b4]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$c4])&quot;,
+	 &quot;&amp;vxor		(@x[$b5]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$b5]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$c5])&quot;,
+	  &quot;&amp;vxor	(@x[$b6]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$b6]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$c6])&quot;,
+	   &quot;&amp;vxor	(@x[$b7]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$b7]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$c7])&quot;,
+	&quot;&amp;vrlw		(@x[$b0]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$b0]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$a7])&quot;,
+	 &quot;&amp;vrlw		(@x[$b1]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$b1]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$a7])&quot;,
+	  &quot;&amp;vrlw	(@x[$b2]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$b2]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$a7])&quot;,
+	   &quot;&amp;vrlw	(@x[$b3]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$b3]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$a7])&quot;,
+	&quot;&amp;vrlw		(@x[$b4]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$b4]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$a7])&quot;,
+	 &quot;&amp;vrlw		(@x[$b5]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$b5]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$a7])&quot;,
+	  &quot;&amp;vrlw	(@x[$b6]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$b6]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$a7])&quot;,
+	   &quot;&amp;vrlw	(@x[$b7]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$b7]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at x</A>[$a7])&quot;,
+
+	&quot;&amp;vxxlorc       (@x[$a7], $xv13,$xv13)&quot;,
+	);
+}
+
+$code.=&lt;&lt;___;
+
+.globl	.ChaCha20_ctr32_vsx_8x
+.align	5
+.ChaCha20_ctr32_vsx_8x:
+	$STU	$sp,-$FRAME($sp)
+	mflr	r0
+	li	r10,`15+$LOCALS+64`
+	li	r11,`31+$LOCALS+64`
+	mfspr	r12,256
+	stvx	v24,r10,$sp
+	addi	r10,r10,32
+	stvx	v25,r11,$sp
+	addi	r11,r11,32
+	stvx	v26,r10,$sp
+	addi	r10,r10,32
+	stvx	v27,r11,$sp
+	addi	r11,r11,32
+	stvx	v28,r10,$sp
+	addi	r10,r10,32
+	stvx	v29,r11,$sp
+	addi	r11,r11,32
+	stvx	v30,r10,$sp
+	stvx	v31,r11,$sp
+	stw	r12,`$FRAME-4`($sp)		# save vrsave
+	li	r12,-4096+63
+	$PUSH	r0, `$FRAME+$LRSAVE`($sp)
+	mtspr	256,r12				# preserve 29 AltiVec registers
+
+	bl	Lconsts				# returns pointer Lsigma in r12
+
+	lvx_4w	@K[0],0,r12			# load sigma
+	addi	r12,r12,0x70
+	li	$x10,16
+	li	$x20,32
+	li	$x30,48
+	li	r11,64
+
+	vspltisw $xa4,-16			# synthesize constants
+	vspltisw $xb4,12			# synthesize constants
+	vspltisw $xc4,8			# synthesize constants
+	vspltisw $xd4,7			# synthesize constants
+
+	lvx	$xa0,$x00,r12			# load [smashed] sigma
+	lvx	$xa1,$x10,r12
+	lvx	$xa2,$x20,r12
+	lvx	$xa3,$x30,r12
+
+	vxxlor	$xv9   ,$xa4,$xa4               #save shift val in vr9-12
+	vxxlor	$xv10  ,$xb4,$xb4
+	vxxlor	$xv11  ,$xc4,$xc4
+	vxxlor	$xv12  ,$xd4,$xd4
+	vxxlor	$xv22  ,$xa0,$xa0               #save sigma in vr22-25
+	vxxlor	$xv23  ,$xa1,$xa1
+	vxxlor	$xv24  ,$xa2,$xa2
+	vxxlor	$xv25  ,$xa3,$xa3
+
+	lvx_4w	@K[1],0,$key			# load key
+	lvx_4w	@K[2],$x10,$key
+	lvx_4w	@K[3],0,$ctr			# load counter
+	vspltisw $xt3,4
+
+
+	vxor	$xt2,$xt2,$xt2
+	lvx_4w	$xt1,r11,r12
+	vspltw	$<A HREF="../../../mailman/listinfo/openssl-commits.html">xa2, at K</A>[3],0			#save the original count after spltw
+	vsldoi	@K[3]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at K</A>[3],$xt2,4
+	vsldoi	@K[3],$<A HREF="../../../mailman/listinfo/openssl-commits.html">xt2, at K</A>[3],12		# clear @K[3].word[0]
+	vadduwm	$xt1,$xa2,$xt1
+	vadduwm $xt3,$xt1,$xt3     		# next counter value
+	vspltw	$<A HREF="../../../mailman/listinfo/openssl-commits.html">xa0, at K</A>[2],2                    # save the K[2] spltw 2 and save v8.
+
+	be?lvsl	  $beperm,0,$x10			# 0x00..0f
+	be?vspltisb $xt0,3			# 0x03..03
+	be?vxor   $beperm,$beperm,$xt0		# swap bytes within words
+	be?vxxlor $xv26 ,$beperm,$beperm
+
+	vxxlor	$xv0 <A HREF="../../../mailman/listinfo/openssl-commits.html">, at K</A>[0]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at K</A>[0]               # K0,k1,k2 to vr0,1,2
+	vxxlor	$xv1 <A HREF="../../../mailman/listinfo/openssl-commits.html">, at K</A>[1]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at K</A>[1]
+	vxxlor	$xv2 <A HREF="../../../mailman/listinfo/openssl-commits.html">, at K</A>[2]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at K</A>[2]
+	vxxlor	$xv3 <A HREF="../../../mailman/listinfo/openssl-commits.html">, at K</A>[3]<A HREF="../../../mailman/listinfo/openssl-commits.html">, at K</A>[3]
+	vxxlor	$xv4 ,$xt1,$xt1                #CTR -&gt;4, CTR+4-&gt; 5
+	vxxlor	$xv5 ,$xt3,$xt3
+	vxxlor	$xv8 ,$xa0,$xa0
+
+	li	r0,10				# inner loop counter
+	mtctr	r0
+	b	Loop_outer_vsx_8x
+
+.align	5
+Loop_outer_vsx_8x:
+	vxxlorc	$xa0,$xv22,$xv22	        # load [smashed] sigma
+	vxxlorc	$xa1,$xv23,$xv23
+	vxxlorc	$xa2,$xv24,$xv24
+	vxxlorc	$xa3,$xv25,$xv25
+	vxxlorc	$xa4,$xv22,$xv22
+	vxxlorc	$xa5,$xv23,$xv23
+	vxxlorc	$xa6,$xv24,$xv24
+	vxxlorc	$xa7,$xv25,$xv25
+
+	vspltw	$<A HREF="../../../mailman/listinfo/openssl-commits.html">xb0, at K</A>[1],0			# smash the key
+	vspltw	$<A HREF="../../../mailman/listinfo/openssl-commits.html">xb1, at K</A>[1],1
+	vspltw	$<A HREF="../../../mailman/listinfo/openssl-commits.html">xb2, at K</A>[1],2
+	vspltw	$<A HREF="../../../mailman/listinfo/openssl-commits.html">xb3, at K</A>[1],3
+	vspltw	$<A HREF="../../../mailman/listinfo/openssl-commits.html">xb4, at K</A>[1],0			# smash the key
+	vspltw	$<A HREF="../../../mailman/listinfo/openssl-commits.html">xb5, at K</A>[1],1
+	vspltw	$<A HREF="../../../mailman/listinfo/openssl-commits.html">xb6, at K</A>[1],2
+	vspltw	$<A HREF="../../../mailman/listinfo/openssl-commits.html">xb7, at K</A>[1],3
+
+	vspltw	$<A HREF="../../../mailman/listinfo/openssl-commits.html">xc0, at K</A>[2],0
+	vspltw	$<A HREF="../../../mailman/listinfo/openssl-commits.html">xc1, at K</A>[2],1
+	vspltw	$<A HREF="../../../mailman/listinfo/openssl-commits.html">xc2, at K</A>[2],2
+	vspltw	$<A HREF="../../../mailman/listinfo/openssl-commits.html">xc3, at K</A>[2],3
+	vspltw	$<A HREF="../../../mailman/listinfo/openssl-commits.html">xc4, at K</A>[2],0
+	vspltw	$<A HREF="../../../mailman/listinfo/openssl-commits.html">xc7, at K</A>[2],3
+	vspltw	$<A HREF="../../../mailman/listinfo/openssl-commits.html">xc5, at K</A>[2],1
+
+	vxxlorc	$xd0,$xv4,$xv4			# smash the counter
+	vspltw	$<A HREF="../../../mailman/listinfo/openssl-commits.html">xd1, at K</A>[3],1
+	vspltw	$<A HREF="../../../mailman/listinfo/openssl-commits.html">xd2, at K</A>[3],2
+	vspltw	$<A HREF="../../../mailman/listinfo/openssl-commits.html">xd3, at K</A>[3],3
+	vxxlorc	$xd4,$xv5,$xv5			# smash the counter
+	vspltw	$<A HREF="../../../mailman/listinfo/openssl-commits.html">xd5, at K</A>[3],1
+	vspltw	$<A HREF="../../../mailman/listinfo/openssl-commits.html">xd6, at K</A>[3],2
+	vspltw	$<A HREF="../../../mailman/listinfo/openssl-commits.html">xd7, at K</A>[3],3
+	vxxlorc	$xc6,$xv8,$xv8                  #copy of vlspt k[2],2 is in v8.v26 -&gt;k[3] so need to wait until k3 is done
+
+Loop_vsx_8x:
+___
+	foreach (&amp;VSX_lane_ROUND_8x(0,4, 8,12,16,20,24,28)) { eval; }
+	foreach (&amp;VSX_lane_ROUND_8x(0,5,10,15,16,21,26,31)) { eval; }
+$code.=&lt;&lt;___;
+
+	bdnz	        Loop_vsx_8x
+	vxxlor	        $xv13 ,$xd4,$xd4                # save the register vr24-31
+	vxxlor	        $xv14 ,$xd5,$xd5                #
+	vxxlor	        $xv15 ,$xd6,$xd6                #
+	vxxlor	        $xv16 ,$xd7,$xd7                #
+
+	vxxlor	        $xv18 ,$xc4,$xc4                #
+	vxxlor	        $xv19 ,$xc5,$xc5                #
+	vxxlor	        $xv20 ,$xc6,$xc6                #
+	vxxlor	        $xv21 ,$xc7,$xc7                #
+
+	vxxlor	        $xv6  ,$xb6,$xb6                # save vr23, so we get 8 regs
+	vxxlor	        $xv7  ,$xb7,$xb7                # save vr23, so we get 8 regs
+	be?vxxlorc      $beperm,$xv26,$xv26             # copy back the the beperm.
+
+	vxxlorc	   @K[0],$xv0,$xv0                #27
+	vxxlorc	   @K[1],$xv1,$xv1 		  #24
+	vxxlorc	   @K[2],$xv2,$xv2		  #25
+	vxxlorc	   @K[3],$xv3,$xv3		  #26
+	vxxlorc	   $CTR0,$xv4,$xv4
+###changing to vertical
+
+	vmrgew	$xt0,$xa0,$xa1			# transpose data
+	vmrgew	$xt1,$xa2,$xa3
+	vmrgow	$xa0,$xa0,$xa1
+	vmrgow	$xa2,$xa2,$xa3
+
+	vmrgew	$xt2,$xb0,$xb1
+	vmrgew	$xt3,$xb2,$xb3
+	vmrgow	$xb0,$xb0,$xb1
+	vmrgow	$xb2,$xb2,$xb3
+
+	vadduwm	$xd0,$xd0,$CTR0
+
+	vpermdi	$xa1,$xa0,$xa2,0b00
+	vpermdi	$xa3,$xa0,$xa2,0b11
+	vpermdi	$xa0,$xt0,$xt1,0b00
+	vpermdi	$xa2,$xt0,$xt1,0b11
+	vpermdi	$xb1,$xb0,$xb2,0b00
+	vpermdi	$xb3,$xb0,$xb2,0b11
+	vpermdi	$xb0,$xt2,$xt3,0b00
+	vpermdi	$xb2,$xt2,$xt3,0b11
+
+	vmrgew	$xt0,$xc0,$xc1
+	vmrgew	$xt1,$xc2,$xc3
+	vmrgow	$xc0,$xc0,$xc1
+	vmrgow	$xc2,$xc2,$xc3
+	vmrgew	$xt2,$xd0,$xd1
+	vmrgew	$xt3,$xd2,$xd3
+	vmrgow	$xd0,$xd0,$xd1
+	vmrgow	$xd2,$xd2,$xd3
+
+	vpermdi	$xc1,$xc0,$xc2,0b00
+	vpermdi	$xc3,$xc0,$xc2,0b11
+	vpermdi	$xc0,$xt0,$xt1,0b00
+	vpermdi	$xc2,$xt0,$xt1,0b11
+	vpermdi	$xd1,$xd0,$xd2,0b00
+	vpermdi	$xd3,$xd0,$xd2,0b11
+	vpermdi	$xd0,$xt2,$xt3,0b00
+	vpermdi	$xd2,$xt2,$xt3,0b11
+
+	vspltisw $xt0,8
+	vadduwm  $CTR0,$CTR0,$xt0		# next counter value
+	vxxlor	 $xv4 ,$CTR0,$CTR0	        #CTR+4-&gt; 5
+
+	vadduwm	$xa0,$<A HREF="../../../mailman/listinfo/openssl-commits.html">xa0, at K</A>[0]
+	vadduwm	$xb0,$<A HREF="../../../mailman/listinfo/openssl-commits.html">xb0, at K</A>[1]
+	vadduwm	$xc0,$<A HREF="../../../mailman/listinfo/openssl-commits.html">xc0, at K</A>[2]
+	vadduwm	$xd0,$<A HREF="../../../mailman/listinfo/openssl-commits.html">xd0, at K</A>[3]
+
+	be?vperm $xa0,$xa0,$xa0,$beperm
+	be?vperm $xb0,$xb0,$xb0,$beperm
+	be?vperm $xc0,$xc0,$xc0,$beperm
+	be?vperm $xd0,$xd0,$xd0,$beperm
+
+	${UCMP}i $len,0x40
+	blt	Ltail_vsx_8x
+
+	lvx_4w	$xt0,$x00,$inp
+	lvx_4w	$xt1,$x10,$inp
+	lvx_4w	$xt2,$x20,$inp
+	lvx_4w	$xt3,$x30,$inp
+
+	vxor	$xt0,$xt0,$xa0
+	vxor	$xt1,$xt1,$xb0
+	vxor	$xt2,$xt2,$xc0
+	vxor	$xt3,$xt3,$xd0
+
+	stvx_4w	$xt0,$x00,$out
+	stvx_4w	$xt1,$x10,$out
+	addi	$inp,$inp,0x40
+	stvx_4w	$xt2,$x20,$out
+	subi	$len,$len,0x40
+	stvx_4w	$xt3,$x30,$out
+	addi	$out,$out,0x40
+	beq	Ldone_vsx_8x
+
+	vadduwm	$xa0,$<A HREF="../../../mailman/listinfo/openssl-commits.html">xa1, at K</A>[0]
+	vadduwm	$xb0,$<A HREF="../../../mailman/listinfo/openssl-commits.html">xb1, at K</A>[1]
+	vadduwm	$xc0,$<A HREF="../../../mailman/listinfo/openssl-commits.html">xc1, at K</A>[2]
+	vadduwm	$xd0,$<A HREF="../../../mailman/listinfo/openssl-commits.html">xd1, at K</A>[3]
+
+	be?vperm $xa0,$xa0,$xa0,$beperm
+	be?vperm $xb0,$xb0,$xb0,$beperm
+	be?vperm $xc0,$xc0,$xc0,$beperm
+	be?vperm $xd0,$xd0,$xd0,$beperm
+
+	${UCMP}i $len,0x40
+	blt	Ltail_vsx_8x
+
+	lvx_4w	$xt0,$x00,$inp
+	lvx_4w	$xt1,$x10,$inp
+	lvx_4w	$xt2,$x20,$inp
+	lvx_4w	$xt3,$x30,$inp
+
+	vxor	$xt0,$xt0,$xa0
+	vxor	$xt1,$xt1,$xb0
+	vxor	$xt2,$xt2,$xc0
+	vxor	$xt3,$xt3,$xd0
+
+	stvx_4w	$xt0,$x00,$out
+	stvx_4w	$xt1,$x10,$out
+	addi	$inp,$inp,0x40
+	stvx_4w	$xt2,$x20,$out
+	subi	$len,$len,0x40
+	stvx_4w	$xt3,$x30,$out
+	addi	$out,$out,0x40
+	beq	Ldone_vsx_8x
+
+	vadduwm	$xa0,$<A HREF="../../../mailman/listinfo/openssl-commits.html">xa2, at K</A>[0]
+	vadduwm	$xb0,$<A HREF="../../../mailman/listinfo/openssl-commits.html">xb2, at K</A>[1]
+	vadduwm	$xc0,$<A HREF="../../../mailman/listinfo/openssl-commits.html">xc2, at K</A>[2]
+	vadduwm	$xd0,$<A HREF="../../../mailman/listinfo/openssl-commits.html">xd2, at K</A>[3]
+
+	be?vperm $xa0,$xa0,$xa0,$beperm
+	be?vperm $xb0,$xb0,$xb0,$beperm
+	be?vperm $xc0,$xc0,$xc0,$beperm
+	be?vperm $xd0,$xd0,$xd0,$beperm
+
+	${UCMP}i $len,0x40
+	blt	Ltail_vsx_8x
+
+	lvx_4w	$xt0,$x00,$inp
+	lvx_4w	$xt1,$x10,$inp
+	lvx_4w	$xt2,$x20,$inp
+	lvx_4w	$xt3,$x30,$inp
+
+	vxor	$xt0,$xt0,$xa0
+	vxor	$xt1,$xt1,$xb0
+	vxor	$xt2,$xt2,$xc0
+	vxor	$xt3,$xt3,$xd0
+
+	stvx_4w	$xt0,$x00,$out
+	stvx_4w	$xt1,$x10,$out
+	addi	$inp,$inp,0x40
+	stvx_4w	$xt2,$x20,$out
+	subi	$len,$len,0x40
+	stvx_4w	$xt3,$x30,$out
+	addi	$out,$out,0x40
+	beq	Ldone_vsx_8x
+
+	vadduwm	$xa0,$<A HREF="../../../mailman/listinfo/openssl-commits.html">xa3, at K</A>[0]
+	vadduwm	$xb0,$<A HREF="../../../mailman/listinfo/openssl-commits.html">xb3, at K</A>[1]
+	vadduwm	$xc0,$<A HREF="../../../mailman/listinfo/openssl-commits.html">xc3, at K</A>[2]
+	vadduwm	$xd0,$<A HREF="../../../mailman/listinfo/openssl-commits.html">xd3, at K</A>[3]
+
+	be?vperm $xa0,$xa0,$xa0,$beperm
+	be?vperm $xb0,$xb0,$xb0,$beperm
+	be?vperm $xc0,$xc0,$xc0,$beperm
+	be?vperm $xd0,$xd0,$xd0,$beperm
+
+	${UCMP}i $len,0x40
+	blt	Ltail_vsx_8x
+
+	lvx_4w	$xt0,$x00,$inp
+	lvx_4w	$xt1,$x10,$inp
+	lvx_4w	$xt2,$x20,$inp
+	lvx_4w	$xt3,$x30,$inp
+
+	vxor	$xt0,$xt0,$xa0
+	vxor	$xt1,$xt1,$xb0
+	vxor	$xt2,$xt2,$xc0
+	vxor	$xt3,$xt3,$xd0
+
+	stvx_4w	$xt0,$x00,$out
+	stvx_4w	$xt1,$x10,$out
+	addi	$inp,$inp,0x40
+	stvx_4w	$xt2,$x20,$out
+	subi	$len,$len,0x40
+	stvx_4w	$xt3,$x30,$out
+	addi	$out,$out,0x40
+	beq	Ldone_vsx_8x
+
+#blk4-7: 24:31 remain the same as we can use the same logic above . Reg a4-b7 remain same.Load c4,d7--&gt; position 8-15.we can reuse vr24-31.
+#VR0-3 : are used to load temp value, vr4 --&gt; as xr0 instead of xt0.
+
+	vxxlorc	   $CTR1 ,$xv5,$xv5
+
+	vxxlorc	   $xcn4 ,$xv18,$xv18
+	vxxlorc	   $xcn5 ,$xv19,$xv19
+	vxxlorc	   $xcn6 ,$xv20,$xv20
+	vxxlorc	   $xcn7 ,$xv21,$xv21
+
+	vxxlorc	   $xdn4 ,$xv13,$xv13
+	vxxlorc	   $xdn5 ,$xv14,$xv14
+	vxxlorc	   $xdn6 ,$xv15,$xv15
+	vxxlorc	   $xdn7 ,$xv16,$xv16
+	vadduwm	   $xdn4,$xdn4,$CTR1
+
+	vxxlorc	   $xb6 ,$xv6,$xv6
+	vxxlorc	   $xb7 ,$xv7,$xv7
+#use xa1-&gt;xr0, as xt0...in the block 4-7
+
+	vmrgew	$xr0,$xa4,$xa5			# transpose data
+	vmrgew	$xt1,$xa6,$xa7
+	vmrgow	$xa4,$xa4,$xa5
+	vmrgow	$xa6,$xa6,$xa7
+	vmrgew	$xt2,$xb4,$xb5
+	vmrgew	$xt3,$xb6,$xb7
+	vmrgow	$xb4,$xb4,$xb5
+	vmrgow	$xb6,$xb6,$xb7
+
+	vpermdi	$xa5,$xa4,$xa6,0b00
+	vpermdi	$xa7,$xa4,$xa6,0b11
+	vpermdi	$xa4,$xr0,$xt1,0b00
+	vpermdi	$xa6,$xr0,$xt1,0b11
+	vpermdi	$xb5,$xb4,$xb6,0b00
+	vpermdi	$xb7,$xb4,$xb6,0b11
+	vpermdi	$xb4,$xt2,$xt3,0b00
+	vpermdi	$xb6,$xt2,$xt3,0b11
+
+	vmrgew	$xr0,$xcn4,$xcn5
+	vmrgew	$xt1,$xcn6,$xcn7
+	vmrgow	$xcn4,$xcn4,$xcn5
+	vmrgow	$xcn6,$xcn6,$xcn7
+	vmrgew	$xt2,$xdn4,$xdn5
+	vmrgew	$xt3,$xdn6,$xdn7
+	vmrgow	$xdn4,$xdn4,$xdn5
+	vmrgow	$xdn6,$xdn6,$xdn7
+
+	vpermdi	$xcn5,$xcn4,$xcn6,0b00
+	vpermdi	$xcn7,$xcn4,$xcn6,0b11
+	vpermdi	$xcn4,$xr0,$xt1,0b00
+	vpermdi	$xcn6,$xr0,$xt1,0b11
+	vpermdi	$xdn5,$xdn4,$xdn6,0b00
+	vpermdi	$xdn7,$xdn4,$xdn6,0b11
+	vpermdi	$xdn4,$xt2,$xt3,0b00
+	vpermdi	$xdn6,$xt2,$xt3,0b11
+
+	vspltisw $xr0,8
+	vadduwm  $CTR1,$CTR1,$xr0		# next counter value
+	vxxlor	 $xv5 ,$CTR1,$CTR1	        #CTR+4-&gt; 5
+
+	vadduwm	$xan0,$<A HREF="../../../mailman/listinfo/openssl-commits.html">xa4, at K</A>[0]
+	vadduwm	$xbn0,$<A HREF="../../../mailman/listinfo/openssl-commits.html">xb4, at K</A>[1]
+	vadduwm	$xcn0,$<A HREF="../../../mailman/listinfo/openssl-commits.html">xcn4, at K</A>[2]
+	vadduwm	$xdn0,$<A HREF="../../../mailman/listinfo/openssl-commits.html">xdn4, at K</A>[3]
+
+	be?vperm $xan0,$xa4,$xa4,$beperm
+	be?vperm $xbn0,$xb4,$xb4,$beperm
+	be?vperm $xcn0,$xcn4,$xcn4,$beperm
+	be?vperm $xdn0,$xdn4,$xdn4,$beperm
+
+	${UCMP}i $len,0x40
+	blt	Ltail_vsx_8x_1
+
+	lvx_4w	$xr0,$x00,$inp
+	lvx_4w	$xt1,$x10,$inp
+	lvx_4w	$xt2,$x20,$inp
+	lvx_4w	$xt3,$x30,$inp
+
+	vxor	$xr0,$xr0,$xan0
+	vxor	$xt1,$xt1,$xbn0
+	vxor	$xt2,$xt2,$xcn0
+	vxor	$xt3,$xt3,$xdn0
+
+	stvx_4w	$xr0,$x00,$out
+	stvx_4w	$xt1,$x10,$out
+	addi	$inp,$inp,0x40
+	stvx_4w	$xt2,$x20,$out
+	subi	$len,$len,0x40
+	stvx_4w	$xt3,$x30,$out
+	addi	$out,$out,0x40
+	beq	Ldone_vsx_8x
+
+	vadduwm	$xan0,$<A HREF="../../../mailman/listinfo/openssl-commits.html">xa5, at K</A>[0]
+	vadduwm	$xbn0,$<A HREF="../../../mailman/listinfo/openssl-commits.html">xb5, at K</A>[1]
+	vadduwm	$xcn0,$<A HREF="../../../mailman/listinfo/openssl-commits.html">xcn5, at K</A>[2]
+	vadduwm	$xdn0,$<A HREF="../../../mailman/listinfo/openssl-commits.html">xdn5, at K</A>[3]
+
+	be?vperm $xan0,$xan0,$xan0,$beperm
+	be?vperm $xbn0,$xbn0,$xbn0,$beperm
+	be?vperm $xcn0,$xcn0,$xcn0,$beperm
+	be?vperm $xdn0,$xdn0,$xdn0,$beperm
+
+	${UCMP}i $len,0x40
+	blt	Ltail_vsx_8x_1
+
+	lvx_4w	$xr0,$x00,$inp
+	lvx_4w	$xt1,$x10,$inp
+	lvx_4w	$xt2,$x20,$inp
+	lvx_4w	$xt3,$x30,$inp
+
+	vxor	$xr0,$xr0,$xan0
+	vxor	$xt1,$xt1,$xbn0
+	vxor	$xt2,$xt2,$xcn0
+	vxor	$xt3,$xt3,$xdn0
+
+	stvx_4w	$xr0,$x00,$out
+	stvx_4w	$xt1,$x10,$out
+	addi	$inp,$inp,0x40
+	stvx_4w	$xt2,$x20,$out
+	subi	$len,$len,0x40
+	stvx_4w	$xt3,$x30,$out
+	addi	$out,$out,0x40
+	beq	Ldone_vsx_8x
+
+	vadduwm	$xan0,$<A HREF="../../../mailman/listinfo/openssl-commits.html">xa6, at K</A>[0]
+	vadduwm	$xbn0,$<A HREF="../../../mailman/listinfo/openssl-commits.html">xb6, at K</A>[1]
+	vadduwm	$xcn0,$<A HREF="../../../mailman/listinfo/openssl-commits.html">xcn6, at K</A>[2]
+	vadduwm	$xdn0,$<A HREF="../../../mailman/listinfo/openssl-commits.html">xdn6, at K</A>[3]
+
+	be?vperm $xan0,$xan0,$xan0,$beperm
+	be?vperm $xbn0,$xbn0,$xbn0,$beperm
+	be?vperm $xcn0,$xcn0,$xcn0,$beperm
+	be?vperm $xdn0,$xdn0,$xdn0,$beperm
+
+	${UCMP}i $len,0x40
+	blt	Ltail_vsx_8x_1
+
+	lvx_4w	$xr0,$x00,$inp
+	lvx_4w	$xt1,$x10,$inp
+	lvx_4w	$xt2,$x20,$inp
+	lvx_4w	$xt3,$x30,$inp
+
+	vxor	$xr0,$xr0,$xan0
+	vxor	$xt1,$xt1,$xbn0
+	vxor	$xt2,$xt2,$xcn0
+	vxor	$xt3,$xt3,$xdn0
+
+	stvx_4w	$xr0,$x00,$out
+	stvx_4w	$xt1,$x10,$out
+	addi	$inp,$inp,0x40
+	stvx_4w	$xt2,$x20,$out
+	subi	$len,$len,0x40
+	stvx_4w	$xt3,$x30,$out
+	addi	$out,$out,0x40
+	beq	Ldone_vsx_8x
+
+	vadduwm	$xan0,$<A HREF="../../../mailman/listinfo/openssl-commits.html">xa7, at K</A>[0]
+	vadduwm	$xbn0,$<A HREF="../../../mailman/listinfo/openssl-commits.html">xb7, at K</A>[1]
+	vadduwm	$xcn0,$<A HREF="../../../mailman/listinfo/openssl-commits.html">xcn7, at K</A>[2]
+	vadduwm	$xdn0,$<A HREF="../../../mailman/listinfo/openssl-commits.html">xdn7, at K</A>[3]
+
+	be?vperm $xan0,$xan0,$xan0,$beperm
+	be?vperm $xbn0,$xbn0,$xbn0,$beperm
+	be?vperm $xcn0,$xcn0,$xcn0,$beperm
+	be?vperm $xdn0,$xdn0,$xdn0,$beperm
+
+	${UCMP}i $len,0x40
+	blt	Ltail_vsx_8x_1
+
+	lvx_4w	$xr0,$x00,$inp
+	lvx_4w	$xt1,$x10,$inp
+	lvx_4w	$xt2,$x20,$inp
+	lvx_4w	$xt3,$x30,$inp
+
+	vxor	$xr0,$xr0,$xan0
+	vxor	$xt1,$xt1,$xbn0
+	vxor	$xt2,$xt2,$xcn0
+	vxor	$xt3,$xt3,$xdn0
+
+	stvx_4w	$xr0,$x00,$out
+	stvx_4w	$xt1,$x10,$out
+	addi	$inp,$inp,0x40
+	stvx_4w	$xt2,$x20,$out
+	subi	$len,$len,0x40
+	stvx_4w	$xt3,$x30,$out
+	addi	$out,$out,0x40
+	beq	Ldone_vsx_8x
+
+	mtctr	r0
+	bne	Loop_outer_vsx_8x
+
+Ldone_vsx_8x:
+	lwz	r12,`$FRAME-4`($sp)		# pull vrsave
+	li	r10,`15+$LOCALS+64`
+	li	r11,`31+$LOCALS+64`
+	$POP	r0, `$FRAME+$LRSAVE`($sp)
+	mtspr	256,r12				# restore vrsave
+	lvx	v24,r10,$sp
+	addi	r10,r10,32
+	lvx	v25,r11,$sp
+	addi	r11,r11,32
+	lvx	v26,r10,$sp
+	addi	r10,r10,32
+	lvx	v27,r11,$sp
+	addi	r11,r11,32
+	lvx	v28,r10,$sp
+	addi	r10,r10,32
+	lvx	v29,r11,$sp
+	addi	r11,r11,32
+	lvx	v30,r10,$sp
+	lvx	v31,r11,$sp
+	mtlr	r0
+	addi	$sp,$sp,$FRAME
+	blr
+
+.align	4
+Ltail_vsx_8x:
+	addi	r11,$sp,$LOCALS
+	mtctr	$len
+	stvx_4w	$xa0,$x00,r11			# offload block to stack
+	stvx_4w	$xb0,$x10,r11
+	stvx_4w	$xc0,$x20,r11
+	stvx_4w	$xd0,$x30,r11
+	subi	r12,r11,1			# prepare for *++ptr
+	subi	$inp,$inp,1
+	subi	$out,$out,1
+	bl      Loop_tail_vsx_8x
+Ltail_vsx_8x_1:
+	addi	r11,$sp,$LOCALS
+	mtctr	$len
+	stvx_4w	$xan0,$x00,r11			# offload block to stack
+	stvx_4w	$xbn0,$x10,r11
+	stvx_4w	$xcn0,$x20,r11
+	stvx_4w	$xdn0,$x30,r11
+	subi	r12,r11,1			# prepare for *++ptr
+	subi	$inp,$inp,1
+	subi	$out,$out,1
+        bl      Loop_tail_vsx_8x
+
+Loop_tail_vsx_8x:
+	lbzu	r6,1(r12)
+	lbzu	r7,1($inp)
+	xor	r6,r6,r7
+	stbu	r6,1($out)
+	bdnz	Loop_tail_vsx_8x
+
+	stvx_4w	$K[0],$x00,r11			# wipe copy of the block
+	stvx_4w	$K[0],$x10,r11
+	stvx_4w	$K[0],$x20,r11
+	stvx_4w	$K[0],$x30,r11
+
+	b	Ldone_vsx_8x
+	.long	0
+	.byte	0,12,0x04,1,0x80,0,5,0
+	.long	0
+.size	.ChaCha20_ctr32_vsx_8x,.-.ChaCha20_ctr32_vsx_8x
+___
+}}}
+
+
+$code.=&lt;&lt;___;
+.align	5
+Lconsts:
+	mflr	r0
+	bcl	20,31,\$+4
+	mflr	r12	#vvvvv &quot;distance between . and Lsigma
+	addi	r12,r12,`64-8`
+	mtlr	r0
+	blr
+	.long	0
+	.byte	0,12,0x14,0,0,0,0,0
+	.space	`64-9*4`
+Lsigma:
+	.long   0x61707865,0x3320646e,0x79622d32,0x6b206574
+	.long	1,0,0,0
+	.long	2,0,0,0
+	.long	3,0,0,0
+	.long	4,0,0,0
+___
+$code.=&lt;&lt;___ 	if ($LITTLE_ENDIAN);
+	.long	0x0e0f0c0d,0x0a0b0809,0x06070405,0x02030001
+	.long	0x0d0e0f0c,0x090a0b08,0x05060704,0x01020300
+___
+$code.=&lt;&lt;___ 	if (!$LITTLE_ENDIAN);	# flipped words
+	.long	0x02030001,0x06070405,0x0a0b0809,0x0e0f0c0d
+	.long	0x01020300,0x05060704,0x090a0b08,0x0d0e0f0c
+___
+$code.=&lt;&lt;___;
+	.long	0x61707865,0x61707865,0x61707865,0x61707865
+	.long	0x3320646e,0x3320646e,0x3320646e,0x3320646e
+	.long	0x79622d32,0x79622d32,0x79622d32,0x79622d32
+	.long	0x6b206574,0x6b206574,0x6b206574,0x6b206574
+	.long	0,1,2,3
+        .long   0x03020100,0x07060504,0x0b0a0908,0x0f0e0d0c
+.asciz  &quot;ChaCha20 for PowerPC/AltiVec, CRYPTOGAMS by &lt;appro\@openssl.org&gt;&quot;
+.align	2
+___
+
+foreach (split(&quot;\n&quot;,$code)) {
+	s/\`([^\`]*)\`/eval $1/ge;
+
+	# instructions prefixed with '?' are endian-specific and need
+	# to be adjusted accordingly...
+	if ($flavour !~ /le$/) {	# big-endian
+	    s/be\?//		or
+	    s/le\?/#le#/	or
+	    s/\?lvsr/lvsl/	or
+	    s/\?lvsl/lvsr/	or
+	    s/\?(vperm\s+v[0-9]+,\s*)(v[0-9]+,\s*)(v[0-9]+,\s*)(v[0-9]+)/$1$3$2$4/ or
+	    s/vrldoi(\s+v[0-9]+,\s*)(v[0-9]+,)\s*([0-9]+)/vsldoi$1$2$2 16-$3/;
+	} else {			# little-endian
+	    s/le\?//		or
+	    s/be\?/#be#/	or
+	    s/\?([a-z]+)/$1/	or
+	    s/vrldoi(\s+v[0-9]+,\s*)(v[0-9]+,)\s*([0-9]+)/vsldoi$1$2$2 $3/;
+	}
+
+	print $_,&quot;\n&quot;;
+}
+
+close STDOUT or die &quot;error closing STDOUT: $!&quot;;
diff --git a/crypto/chacha/build.info b/crypto/chacha/build.info
index c12cb9c201..2a819b2e7a 100644
--- a/crypto/chacha/build.info
+++ b/crypto/chacha/build.info
@@ -12,7 +12,7 @@ IF[{- !$disabled{asm} -}]
   $CHACHAASM_armv4=chacha-armv4.S
   $CHACHAASM_aarch64=chacha-armv8.S
 
-  $CHACHAASM_ppc32=chacha_ppc.c chacha-ppc.s
+  $CHACHAASM_ppc32=chacha_ppc.c chacha-ppc.s chachap10-ppc.s
   $CHACHAASM_ppc64=$CHACHAASM_ppc32
 
   $CHACHAASM_c64xplus=chacha-c64xplus.s
@@ -29,6 +29,7 @@ SOURCE[../../libcrypto]=$CHACHAASM
 GENERATE[chacha-x86.s]=asm/chacha-x86.pl
 GENERATE[chacha-x86_64.s]=asm/chacha-x86_64.pl
 GENERATE[chacha-ppc.s]=asm/chacha-ppc.pl
+GENERATE[chachap10-ppc.s]=asm/chachap10-ppc.pl
 GENERATE[chacha-armv4.S]=asm/chacha-armv4.pl
 INCLUDE[chacha-armv4.o]=..
 GENERATE[chacha-armv8.S]=asm/chacha-armv8.pl
diff --git a/crypto/chacha/chacha_ppc.c b/crypto/chacha/chacha_ppc.c
index 5319040cc1..f99cca8807 100644
--- a/crypto/chacha/chacha_ppc.c
+++ b/crypto/chacha/chacha_ppc.c
@@ -23,13 +23,18 @@ void ChaCha20_ctr32_vmx(unsigned char *out, const unsigned char *inp,
 void ChaCha20_ctr32_vsx(unsigned char *out, const unsigned char *inp,
                         size_t len, const unsigned int key[8],
                         const unsigned int counter[4]);
+void ChaCha20_ctr32_vsx_p10(unsigned char *out, const unsigned char *inp,
+                        size_t len, const unsigned int key[8],
+                        const unsigned int counter[4]);
 void ChaCha20_ctr32(unsigned char *out, const unsigned char *inp,
                     size_t len, const unsigned int key[8],
                     const unsigned int counter[4])
 {
-    OPENSSL_ppccap_P &amp; PPC_CRYPTO207
-        ? ChaCha20_ctr32_vsx(out, inp, len, key, counter)
-        : OPENSSL_ppccap_P &amp; PPC_ALTIVEC
-            ? ChaCha20_ctr32_vmx(out, inp, len, key, counter)
-            : ChaCha20_ctr32_int(out, inp, len, key, counter);
+    OPENSSL_ppccap_P &amp; PPC_BRD31
+        ? ChaCha20_ctr32_vsx_p10(out, inp, len, key, counter)
+        :OPENSSL_ppccap_P &amp; PPC_CRYPTO207
+            ? ChaCha20_ctr32_vsx(out, inp, len, key, counter)
+            : OPENSSL_ppccap_P &amp; PPC_ALTIVEC
+                 ? ChaCha20_ctr32_vmx(out, inp, len, key, counter)
+                 : ChaCha20_ctr32_int(out, inp, len, key, counter);
 }
diff --git a/crypto/perlasm/ppc-xlate.pl b/crypto/perlasm/ppc-xlate.pl
index 2ee444045f..45903407df 100755
--- a/crypto/perlasm/ppc-xlate.pl
+++ b/crypto/perlasm/ppc-xlate.pl
@@ -293,6 +293,14 @@ my $vpermdi	= sub {				# xxpermdi
     $dm = oct($dm) if ($dm =~ /^0/);
     &quot;	.long	&quot;.sprintf &quot;0x%X&quot;,(60&lt;&lt;26)|($vrt&lt;&lt;21)|($vra&lt;&lt;16)|($vrb&lt;&lt;11)|($dm&lt;&lt;8)|(10&lt;&lt;3)|7;
 };
+my $vxxlor	= sub {				# xxlor
+    my ($f, $vrt, $vra, $vrb) = @_;
+    &quot;	.long	&quot;.sprintf &quot;0x%X&quot;,(60&lt;&lt;26)|($vrt&lt;&lt;21)|($vra&lt;&lt;16)|($vrb&lt;&lt;11)|(146&lt;&lt;3)|6;
+};
+my $vxxlorc	= sub {				# xxlor
+    my ($f, $vrt, $vra, $vrb) = @_;
+    &quot;	.long	&quot;.sprintf &quot;0x%X&quot;,(60&lt;&lt;26)|($vrt&lt;&lt;21)|($vra&lt;&lt;16)|($vrb&lt;&lt;11)|(146&lt;&lt;3)|1;
+};
 
 # PowerISA 2.07 stuff
 sub vcrypto_op {
@@ -377,6 +385,15 @@ my $addex = sub {
 };
 my $vmsumudm	= sub { vfour_vsr(@_, 35); };
 
+# PowerISA 3.1 stuff
+my $brd = sub {
+    my ($f, $ra, $rs) = @_;
+    &quot;  .long   &quot;.sprintf &quot;0x%X&quot;,(31&lt;&lt;26)|($rs&lt;&lt;21)|($ra&lt;&lt;16)|(187&lt;&lt;1);
+};
+my $vsrq	= sub { vcrypto_op(@_, 517); };
+
+
+
 while($line=&lt;&gt;) {
 
     $line =~ s|[#!;].*$||;	# get rid of asm-style comments...
diff --git a/crypto/ppccap.c b/crypto/ppccap.c
index da371a5345..664627c1af 100644
--- a/crypto/ppccap.c
+++ b/crypto/ppccap.c
@@ -45,6 +45,7 @@ void OPENSSL_ppc64_probe(void);
 void OPENSSL_altivec_probe(void);
 void OPENSSL_crypto207_probe(void);
 void OPENSSL_madd300_probe(void);
+void OPENSSL_brd31_probe(void);
 
 long OPENSSL_rdtsc_mftb(void);
 long OPENSSL_rdtsc_mfspr268(void);
@@ -131,6 +132,7 @@ static unsigned long getauxval(unsigned long key)
 #endif
 #define HWCAP_VEC_CRYPTO        (1U &lt;&lt; 25)
 #define HWCAP_ARCH_3_00         (1U &lt;&lt; 23)
+#define HWCAP_ARCH_3_1          (1U &lt;&lt; 18)
 
 # if defined(__GNUC__) &amp;&amp; __GNUC__&gt;=2
 __attribute__ ((constructor))
@@ -191,6 +193,9 @@ void OPENSSL_cpuid_setup(void)
     if (__power_set(0xffffffffU&lt;&lt;17))           /* POWER9 and later */
         OPENSSL_ppccap_P |= PPC_MADD300;
 
+    if (__power_set(0xffffffffU&lt;&lt;18))           /* POWER10 and later */
+        OPENSSL_ppccap_P |= PPC_BRD31;
+
     return;
 # endif
 #endif
@@ -246,6 +251,10 @@ void OPENSSL_cpuid_setup(void)
         if (hwcap2 &amp; HWCAP_ARCH_3_00) {
             OPENSSL_ppccap_P |= PPC_MADD300;
         }
+
+        if (hwcap2 &amp; HWCAP_ARCH_3_1) {
+            OPENSSL_ppccap_P |= PPC_BRD31;
+        }
     }
 #endif
 
diff --git a/crypto/ppccpuid.pl b/crypto/ppccpuid.pl
index c6555df5d8..706164adba 100755
--- a/crypto/ppccpuid.pl
+++ b/crypto/ppccpuid.pl
@@ -81,6 +81,17 @@ $code=&lt;&lt;___;
 	.long	0
 	.byte	0,12,0x14,0,0,0,0,0
 
+.globl	.OPENSSL_brd31_probe
+.align	4
+.OPENSSL_brd31_probe:
+	xor	r0,r0,r0
+	brd	r3,r0
+	blr
+	.long	0
+	.byte	0,12,0x14,0,0,0,0,0
+.size	.OPENSSL_brd31_probe,.-.OPENSSL_brd31_probe
+
+
 .globl	.OPENSSL_wipe_cpu
 .align	4
 .OPENSSL_wipe_cpu:
diff --git a/include/crypto/ppc_arch.h b/include/crypto/ppc_arch.h
index 3b3ce4bff5..fcc846c410 100644
--- a/include/crypto/ppc_arch.h
+++ b/include/crypto/ppc_arch.h
@@ -24,5 +24,6 @@ extern unsigned int OPENSSL_ppccap_P;
 # define PPC_MADD300     (1&lt;&lt;4)
 # define PPC_MFTB        (1&lt;&lt;5)
 # define PPC_MFSPR268    (1&lt;&lt;6)
+# define PPC_BRD31       (1&lt;&lt;7)
 
 #endif
</PRE>








<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="036287.html">[openssl]  master update
</A></li>
	<LI>Next message (by thread): <A HREF="036292.html">[openssl]  master update
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#36291">[ date ]</a>
              <a href="thread.html#36291">[ thread ]</a>
              <a href="subject.html#36291">[ subject ]</a>
              <a href="author.html#36291">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="../../../mailman/listinfo/openssl-commits.html">More information about the openssl-commits
mailing list</a><br>
</body></html>
