<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [openssl]  master update
   </TITLE>
   <LINK REL="Index" HREF="https://mta.openssl.org/pipermail/openssl-commits/2021-December/index.html" >
   <LINK REL="made" HREF="mailto:openssl-commits%40openssl.org?Subject=Re%3A%20%5Bopenssl%5D%20%20master%20update&In-Reply-To=%3C1638805146.080472.1457751.nullmailer%40dev.openssl.org%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="035795.html">
   <LINK REL="Next"  HREF="035801.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[openssl]  master update</H1>
    <B>tomas at openssl.org</B> 
    <A HREF="mailto:openssl-commits%40openssl.org?Subject=Re%3A%20%5Bopenssl%5D%20%20master%20update&In-Reply-To=%3C1638805146.080472.1457751.nullmailer%40dev.openssl.org%3E"
       TITLE="[openssl]  master update">tomas at openssl.org
       </A><BR>
    <I>Mon Dec  6 15:39:06 UTC 2021</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="035795.html">[openssl]  master update
</A></li>
        <LI>Next message (by thread): <A HREF="035801.html">[openssl]  master update
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#35799">[ date ]</a>
              <a href="thread.html#35799">[ thread ]</a>
              <a href="subject.html#35799">[ subject ]</a>
              <a href="author.html#35799">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>The branch master has been updated
       via  a44eb8421d0e84c069a5fa55ced796878e6b0966 (commit)
       via  c22b6592135bfba95a315e438ac7bfc6db461407 (commit)
       via  28257d60577932e66934096d0ee8a5dfaca1191e (commit)
       via  baa88d9d170b95fd6f177b3e5f8d8818e024a55d (commit)
      from  3dbf82438004b31258627f324841476c4f586c19 (commit)


- Log -----------------------------------------------------------------
commit a44eb8421d0e84c069a5fa55ced796878e6b0966
Author: Tomas Mraz &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">tomas at openssl.org</A>&gt;
Date:   Thu Dec 2 22:08:25 2021 +0100

    test_rsa: Test for PVK format conversion
    
    Reviewed-by: Tim Hudson &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">tjh at openssl.org</A>&gt;
    Reviewed-by: Richard Levitte &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">levitte at openssl.org</A>&gt;
    Reviewed-by: Paul Dale &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">pauli at openssl.org</A>&gt;
    (Merged from <A HREF="https://github.com/openssl/openssl/pull/17181">https://github.com/openssl/openssl/pull/17181</A>)

commit c22b6592135bfba95a315e438ac7bfc6db461407
Author: Tomas Mraz &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">tomas at openssl.org</A>&gt;
Date:   Thu Dec 2 22:07:38 2021 +0100

    key_to_type_specific_pem_bio_cb: Use passphrase callback from the arguments
    
    Reviewed-by: Tim Hudson &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">tjh at openssl.org</A>&gt;
    Reviewed-by: Richard Levitte &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">levitte at openssl.org</A>&gt;
    Reviewed-by: Paul Dale &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">pauli at openssl.org</A>&gt;
    (Merged from <A HREF="https://github.com/openssl/openssl/pull/17181">https://github.com/openssl/openssl/pull/17181</A>)

commit 28257d60577932e66934096d0ee8a5dfaca1191e
Author: Tomas Mraz &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">tomas at openssl.org</A>&gt;
Date:   Thu Dec 2 22:06:36 2021 +0100

    PVK decoder: prompt for PVK passphrase and not PEM
    
    Reviewed-by: Tim Hudson &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">tjh at openssl.org</A>&gt;
    Reviewed-by: Richard Levitte &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">levitte at openssl.org</A>&gt;
    Reviewed-by: Paul Dale &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">pauli at openssl.org</A>&gt;
    (Merged from <A HREF="https://github.com/openssl/openssl/pull/17181">https://github.com/openssl/openssl/pull/17181</A>)

commit baa88d9d170b95fd6f177b3e5f8d8818e024a55d
Author: Tomas Mraz &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">tomas at openssl.org</A>&gt;
Date:   Thu Dec 2 22:04:21 2021 +0100

    Fix pvk encoder to properly query for the passphrase
    
    The passphrase callback data was not properly initialized.
    
    Fixes #17054
    
    Reviewed-by: Tim Hudson &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">tjh at openssl.org</A>&gt;
    Reviewed-by: Richard Levitte &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">levitte at openssl.org</A>&gt;
    Reviewed-by: Paul Dale &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">pauli at openssl.org</A>&gt;
    (Merged from <A HREF="https://github.com/openssl/openssl/pull/17181">https://github.com/openssl/openssl/pull/17181</A>)

-----------------------------------------------------------------------

Summary of changes:
 crypto/passphrase.c                                  | 15 +++++++++++++--
 include/internal/passphrase.h                        |  1 +
 .../implementations/encode_decode/decode_pvk2key.c   |  2 +-
 .../implementations/encode_decode/encode_key2any.c   |  2 +-
 .../implementations/encode_decode/encode_key2ms.c    | 12 +++++++-----
 test/recipes/15-test_rsa.t                           | 20 +++++++++++++++++---
 test/recipes/tconversion.pl                          |  6 ++++--
 7 files changed, 44 insertions(+), 14 deletions(-)

diff --git a/crypto/passphrase.c b/crypto/passphrase.c
index fb8ea1deb1..d61e249440 100644
--- a/crypto/passphrase.c
+++ b/crypto/passphrase.c
@@ -296,7 +296,8 @@ int ossl_pw_get_passphrase(char *pass, size_t pass_size, size_t *pass_len,
     return ret;
 }
 
-int ossl_pw_pem_password(char *buf, int size, int rwflag, void *userdata)
+static int ossl_pw_get_password(char *buf, int size, int rwflag,
+                                void *userdata, const char *info)
 {
     size_t password_len = 0;
     OSSL_PARAM params[] = {
@@ -304,13 +305,23 @@ int ossl_pw_pem_password(char *buf, int size, int rwflag, void *userdata)
         OSSL_PARAM_END
     };
 
-    params[0].data = &quot;PEM&quot;;
+    params[0].data = (void *)info;
     if (ossl_pw_get_passphrase(buf, (size_t)size, &amp;password_len, params,
                                rwflag, userdata))
         return (int)password_len;
     return -1;
 }
 
+int ossl_pw_pem_password(char *buf, int size, int rwflag, void *userdata)
+{
+    return ossl_pw_get_password(buf, size, rwflag, userdata, &quot;PEM&quot;);
+}
+
+int ossl_pw_pvk_password(char *buf, int size, int rwflag, void *userdata)
+{
+    return ossl_pw_get_password(buf, size, rwflag, userdata, &quot;PVK&quot;);
+}
+
 int ossl_pw_passphrase_callback_enc(char *pass, size_t pass_size,
                                     size_t *pass_len,
                                     const OSSL_PARAM params[], void *arg)
diff --git a/include/internal/passphrase.h b/include/internal/passphrase.h
index ee0be9b128..54d997b0d9 100644
--- a/include/internal/passphrase.h
+++ b/include/internal/passphrase.h
@@ -114,6 +114,7 @@ int ossl_pw_get_passphrase(char *pass, size_t pass_size, size_t *pass_len,
  */
 
 pem_password_cb ossl_pw_pem_password;
+pem_password_cb ossl_pw_pvk_password;
 /* One callback for encoding (verification prompt) and one for decoding */
 OSSL_PASSPHRASE_CALLBACK ossl_pw_passphrase_callback_enc;
 OSSL_PASSPHRASE_CALLBACK ossl_pw_passphrase_callback_dec;
diff --git a/providers/implementations/encode_decode/decode_pvk2key.c b/providers/implementations/encode_decode/decode_pvk2key.c
index 30b42d2097..32206fe84d 100644
--- a/providers/implementations/encode_decode/decode_pvk2key.c
+++ b/providers/implementations/encode_decode/decode_pvk2key.c
@@ -100,7 +100,7 @@ static int pvk2key_decode(void *vctx, OSSL_CORE_BIO *cin, int selection,
         if (!ossl_pw_set_ossl_passphrase_cb(&amp;pwdata, pw_cb, pw_cbarg))
             goto end;
 
-        key = ctx-&gt;desc-&gt;read_private_key(in, ossl_pw_pem_password, &amp;pwdata,
+        key = ctx-&gt;desc-&gt;read_private_key(in, ossl_pw_pvk_password, &amp;pwdata,
                                           PROV_LIBCTX_OF(ctx-&gt;provctx), NULL);
 
         /*
diff --git a/providers/implementations/encode_decode/encode_key2any.c b/providers/implementations/encode_decode/encode_key2any.c
index 7c9716bca9..ae15a5db46 100644
--- a/providers/implementations/encode_decode/encode_key2any.c
+++ b/providers/implementations/encode_decode/encode_key2any.c
@@ -401,7 +401,7 @@ static int key_to_type_specific_pem_bio_cb(BIO *out, const void *key,
 {
     return
         PEM_ASN1_write_bio(k2d, pemname, out, key, ctx-&gt;cipher,
-                           NULL, 0, ossl_pw_pem_password, &amp;ctx-&gt;pwdata) &gt; 0;
+                           NULL, 0, cb, cbarg) &gt; 0;
 }
 
 static int key_to_type_specific_pem_priv_bio(BIO *out, const void *key,
diff --git a/providers/implementations/encode_decode/encode_key2ms.c b/providers/implementations/encode_decode/encode_key2ms.c
index 3933a0d420..81528fefb6 100644
--- a/providers/implementations/encode_decode/encode_key2ms.c
+++ b/providers/implementations/encode_decode/encode_key2ms.c
@@ -47,8 +47,7 @@ static int write_msblob(struct key2ms_ctx_st *ctx, OSSL_CORE_BIO *cout,
 }
 
 static int write_pvk(struct key2ms_ctx_st *ctx, OSSL_CORE_BIO *cout,
-                     EVP_PKEY *pkey,
-                     OSSL_PASSPHRASE_CALLBACK *pw_cb, void *pw_cbarg)
+                     EVP_PKEY *pkey)
 {
     BIO *out = NULL;
     int ret = 0;
@@ -56,7 +55,7 @@ static int write_pvk(struct key2ms_ctx_st *ctx, OSSL_CORE_BIO *cout,
 
     out = ossl_bio_new_from_core_bio(ctx-&gt;provctx, cout);
     ret = i2b_PVK_bio_ex(out, pkey, ctx-&gt;pvk_encr_level,
-                         ossl_pw_pem_password, &amp;ctx-&gt;pwdata, libctx, NULL);
+                         ossl_pw_pvk_password, &amp;ctx-&gt;pwdata, libctx, NULL);
     BIO_free(out);
 
     return ret;
@@ -81,6 +80,7 @@ static void key2ms_freectx(void *vctx)
 {
     struct key2ms_ctx_st *ctx = vctx;
 
+    ossl_pw_clear_passphrase_data(&amp;ctx-&gt;pwdata);
     OPENSSL_free(ctx);
 }
 
@@ -154,8 +154,10 @@ static int key2pvk_encode(void *vctx, const void *key, int selection,
     if ((selection &amp; OSSL_KEYMGMT_SELECT_PRIVATE_KEY) == 0)
         return 0;                /* Error */
 
-    if ((pkey = EVP_PKEY_new()) != NULL &amp;&amp; set1_key(pkey, key))
-        ok = write_pvk(ctx, cout, pkey, pw_cb, pw_cbarg);
+    if ((pkey = EVP_PKEY_new()) != NULL &amp;&amp; set1_key(pkey, key)
+        &amp;&amp; (pw_cb == NULL
+            || ossl_pw_set_ossl_passphrase_cb(&amp;ctx-&gt;pwdata, pw_cb, pw_cbarg)))
+        ok = write_pvk(ctx, cout, pkey);
     EVP_PKEY_free(pkey);
     return ok;
 }
diff --git a/test/recipes/15-test_rsa.t b/test/recipes/15-test_rsa.t
index 301368b69b..420a57f8c1 100644
--- a/test/recipes/15-test_rsa.t
+++ b/test/recipes/15-test_rsa.t
@@ -16,7 +16,7 @@ use OpenSSL::Test::Utils;
 
 setup(&quot;test_rsa&quot;);
 
-plan tests =&gt; 10;
+plan tests =&gt; 12;
 
 require_ok(srctop_file('test', 'recipes', 'tconversion.pl'));
 
@@ -32,7 +32,7 @@ sub run_rsa_tests {
     ok(run(app([ 'openssl', $cmd, '-check', '-in', srctop_file('test', 'testrsa.pem'), '-noout'])),
            &quot;$cmd -check&quot; );
 
-     SKIP: {
+    SKIP: {
          skip &quot;Skipping $cmd conversion test&quot;, 3
              if disabled(&quot;rsa&quot;);
 
@@ -47,7 +47,7 @@ sub run_rsa_tests {
          };
     }
 
-     SKIP: {
+    SKIP: {
          skip &quot;Skipping msblob conversion test&quot;, 1
              if disabled($cmd) || $cmd eq 'pkey';
 
@@ -57,4 +57,18 @@ sub run_rsa_tests {
                           -args =&gt; [&quot;rsa&quot;, &quot;-pubin&quot;, &quot;-pubout&quot;] );
          };
     }
+    SKIP: {
+         skip &quot;Skipping PVK conversion test&quot;, 1
+             if disabled($cmd) || $cmd eq 'pkey' || disabled(&quot;rc4&quot;)
+                || disabled (&quot;legacy&quot;);
+
+         subtest &quot;$cmd conversions -- private key&quot; =&gt; sub {
+             tconversion( -type =&gt; 'pvk', -prefix =&gt; &quot;$cmd-pvk&quot;,
+                          -in =&gt; srctop_file(&quot;test&quot;, &quot;testrsa.pem&quot;),
+                          -args =&gt; [&quot;rsa&quot;, &quot;-passin&quot;, &quot;pass:testpass&quot;,
+                                    &quot;-passout&quot;, &quot;pass:testpass&quot;,
+                                    &quot;-provider&quot;, &quot;default&quot;,
+                                    &quot;-provider&quot;, &quot;legacy&quot;] );
+         };
+    }
 }
diff --git a/test/recipes/tconversion.pl b/test/recipes/tconversion.pl
index f60954c0ba..063be620a3 100644
--- a/test/recipes/tconversion.pl
+++ b/test/recipes/tconversion.pl
@@ -19,6 +19,7 @@ my %conversionforms = (
     # specific test types as key.
     &quot;*&quot;		=&gt; [ &quot;d&quot;, &quot;p&quot; ],
     &quot;msb&quot;	=&gt; [ &quot;d&quot;, &quot;p&quot;, &quot;msblob&quot; ],
+    &quot;pvk&quot;	=&gt; [ &quot;d&quot;, &quot;p&quot;, &quot;pvk&quot; ],
     );
 sub tconversion {
     my %opts = @_;
@@ -45,8 +46,9 @@ sub tconversion {
 	+ $n			# initial conversions from p to all forms (A)
 	+ $n*$n			# conversion from result of A to all forms (B)
 	+ 1			# comparing original test file to p form of A
-	+ $n*($n-1);		# comparing first conversion to each fom in A with B
+	+ $n*($n-1);		# comparing first conversion to each form in A with B
     $totaltests-- if ($testtype eq &quot;p7d&quot;); # no comparison of original test file
+    $totaltests -= $n if ($testtype eq &quot;pvk&quot;); # no comparisons of the pvk form
     plan tests =&gt; $totaltests;
 
     my @cmd = (&quot;openssl&quot;, @openssl_args);
@@ -91,7 +93,7 @@ sub tconversion {
       }
 
       foreach my $to (@conversionforms) {
-	  next if $to eq &quot;d&quot;;
+	  next if $to eq &quot;d&quot; or $to eq &quot;pvk&quot;;
 	  foreach my $from (@conversionforms) {
 	      is(cmp_text(&quot;$prefix-f.$to&quot;, &quot;$prefix-ff.$from$to&quot;), 0,
 		 &quot;comparing $to to $from$to&quot;);
</PRE>












































































<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="035795.html">[openssl]  master update
</A></li>
	<LI>Next message (by thread): <A HREF="035801.html">[openssl]  master update
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#35799">[ date ]</a>
              <a href="thread.html#35799">[ thread ]</a>
              <a href="subject.html#35799">[ subject ]</a>
              <a href="author.html#35799">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="../../../mailman/listinfo/openssl-commits.html">More information about the openssl-commits
mailing list</a><br>
</body></html>
