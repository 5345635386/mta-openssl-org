<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [openssl-commits] [openssl]  master update
   </TITLE>
   <LINK REL="Index" HREF="https://mta.openssl.org/pipermail/openssl-commits/2016-February/index.html" >
   <LINK REL="made" HREF="mailto:openssl-commits%40openssl.org?Subject=Re%3A%20%5Bopenssl-commits%5D%20%5Bopenssl%5D%20%20master%20update&In-Reply-To=%3C1455014674.485988.6595.nullmailer%40dev.openssl.org%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="003782.html">
   <LINK REL="Next"  HREF="003794.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[openssl-commits] [openssl]  master update</H1>
    <B>Richard Levitte</B> 
    <A HREF="mailto:openssl-commits%40openssl.org?Subject=Re%3A%20%5Bopenssl-commits%5D%20%5Bopenssl%5D%20%20master%20update&In-Reply-To=%3C1455014674.485988.6595.nullmailer%40dev.openssl.org%3E"
       TITLE="[openssl-commits] [openssl]  master update">levitte at openssl.org
       </A><BR>
    <I>Tue Feb  9 10:44:34 UTC 2016</I>
    <P><UL>
        <LI>Previous message: <A HREF="003782.html">[openssl-commits] [openssl]  master update
</A></li>
        <LI>Next message: <A HREF="003794.html">[openssl-commits] [openssl]  master update
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3792">[ date ]</a>
              <a href="thread.html#3792">[ thread ]</a>
              <a href="subject.html#3792">[ subject ]</a>
              <a href="author.html#3792">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>The branch master has been updated
       via  42e0ccdfe851c9a153d3e90746a2b8561dc9b1e3 (commit)
       via  d7465918867b107058228938e7f5c9fa032ef708 (commit)
      from  f83133a5ed9757668c12d78256ab91c2ef78a921 (commit)


- Log -----------------------------------------------------------------
commit 42e0ccdfe851c9a153d3e90746a2b8561dc9b1e3
Author: Richard Levitte &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">levitte at openssl.org</A>&gt;
Date:   Sat Jan 30 01:05:33 2016 +0100

    unified build scheme: adjust test framework for out of source build tree
    
    To be able to run tests when we've built in a directory other than
    the source tree, the testing framework needs a few adjustments.
    
    test/testlib/OpenSSL/Test.pm needs to know where it can find
    shlib_wrap.sh, and a number of other tests need to be told a different
    place to find engines than what they may be able to figure out on
    their own.  Relying to $TOP is not enough, $SRCTOP and $BLDTOP can be
    used as an alternative.
    
    As part of this change, top_file and top_dir are removed and
    srctop_file, bldtop_file, srctop_dir and bldtop_dir take their place.
    
    Reviewed-by: Ben Laurie &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">ben at openssl.org</A>&gt;

commit d7465918867b107058228938e7f5c9fa032ef708
Author: Richard Levitte &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">levitte at openssl.org</A>&gt;
Date:   Sat Jan 30 00:03:58 2016 +0100

    unified build scheme: adjust some scripts
    
    util/mkdef.pl and Makefile.shared needs to know about the source and
    the build directories.
    
    Additionally, Makefile.shared needs to know how to build shared
    libraries in a directory other than the current one.
    
    Reviewed-by: Ben Laurie &lt;<A HREF="../../../mailman/listinfo/openssl-commits.html">ben at openssl.org</A>&gt;

-----------------------------------------------------------------------

Summary of changes:
 Makefile.shared                       |  38 +++++----
 test/recipes/00-check_testexes.t      |   8 +-
 test/recipes/01-test_ordinals.t       |   6 +-
 test/recipes/10-test_bn.t             |   4 +-
 test/recipes/15-test_dsa.t            |  10 +--
 test/recipes/15-test_ec.t             |  10 +--
 test/recipes/15-test_rsa.t            |  10 +--
 test/recipes/20-test_enc.t            |   4 +-
 test/recipes/25-test_crl.t            |   6 +-
 test/recipes/25-test_gen.t            |  10 +--
 test/recipes/25-test_pkcs7.t          |   8 +-
 test/recipes/25-test_req.t            |   6 +-
 test/recipes/25-test_sid.t            |   6 +-
 test/recipes/25-test_verify.t         |   8 +-
 test/recipes/25-test_x509.t           |  10 +--
 test/recipes/30-test_evp.t            |   4 +-
 test/recipes/40-test_rehash.t         |   4 +-
 test/recipes/70-test_sslcertstatus.t  |   6 +-
 test/recipes/70-test_sslextension.t   |   6 +-
 test/recipes/70-test_sslsessiontick.t |   6 +-
 test/recipes/70-test_sslskewith0p.t   |   6 +-
 test/recipes/70-test_sslvertol.t      |   6 +-
 test/recipes/70-test_tlsextms.t       |   6 +-
 test/recipes/70-test_verify_extra.t   |   8 +-
 test/recipes/80-test_ca.t             |  11 +--
 test/recipes/80-test_cms.t            |   6 +-
 test/recipes/80-test_dane.t           |   6 +-
 test/recipes/80-test_ocsp.t           |   4 +-
 test/recipes/80-test_ssl.t            |  32 ++++----
 test/recipes/80-test_tsa.t            |   8 +-
 test/recipes/90-test_networking.t     |   8 +-
 test/recipes/tconversion.pl           |   2 +-
 test/run_tests.pl                     |   9 ++-
 test/testlib/OpenSSL/Test.pm          | 143 ++++++++++++++++++++++++----------
 test/testlib/OpenSSL/Test/Utils.pm    |   6 +-
 util/mkdef.pl                         |  13 ++--
 36 files changed, 259 insertions(+), 185 deletions(-)

diff --git a/Makefile.shared b/Makefile.shared
index 13129f8..af2dc8c 100644
--- a/Makefile.shared
+++ b/Makefile.shared
@@ -31,6 +31,12 @@ LIBNAME=
 #APPNAME=foo
 APPNAME=
 
+# DSTDIR is the directory where the built file should end up in.
+DSTDIR=.
+
+# SRCDIR is the top directory of the source tree.
+SRCDIR=.
+
 # OBJECTS contains all the object files to link together into the application.
 # This must contain at least one object file.
 #OBJECTS=foo.o
@@ -109,11 +115,11 @@ LINK_SO=	\
     LIBPATH=`echo $$LIBPATH | sed -e 's/ /:/g'`; \
     echo LD_LIBRARY_PATH=$$LIBPATH:$$LD_LIBRARY_PATH \
          $${SHAREDCMD} $${SHAREDFLAGS} \
-	     -o $$SHLIB$$SHLIB_SOVER$$SHLIB_SUFFIX \
+	     -o $(DSTDIR)/$$SHLIB$$SHLIB_SOVER$$SHLIB_SUFFIX \
 	     $$ALLSYMSFLAGS $$SHOBJECTS $$NOALLSYMSFLAGS $$LIBDEPS; \
     LD_LIBRARY_PATH=$$LIBPATH:$$LD_LIBRARY_PATH \
     $${SHAREDCMD} $${SHAREDFLAGS} \
-	-o $$SHLIB$$SHLIB_SOVER$$SHLIB_SUFFIX \
+	-o $(DSTDIR)/$$SHLIB$$SHLIB_SOVER$$SHLIB_SUFFIX \
 	$$ALLSYMSFLAGS $$SHOBJECTS $$NOALLSYMSFLAGS $$LIBDEPS \
   ) &amp;&amp; $(SYMLINK_SO)
 
@@ -122,30 +128,30 @@ SYMLINK_SO=	\
 		prev=$$SHLIB$$SHLIB_SOVER$$SHLIB_SUFFIX; \
 		if [ -n &quot;$$SHLIB_COMPAT&quot; ]; then \
 			for x in $$SHLIB_COMPAT; do \
-				( $(SET_X); rm -f $$SHLIB$$x$$SHLIB_SUFFIX; \
-				  ln -s $$prev $$SHLIB$$x$$SHLIB_SUFFIX ); \
+				( $(SET_X); rm -f $(DSTDIR)/$$SHLIB$$x$$SHLIB_SUFFIX; \
+				  ln -s $$prev $(DSTDIR)/$$SHLIB$$x$$SHLIB_SUFFIX ); \
 				prev=$$SHLIB$$x$$SHLIB_SUFFIX; \
 			done; \
 		fi; \
 		if [ -n &quot;$$SHLIB_SOVER&quot; ]; then \
-			( $(SET_X); rm -f $$SHLIB$$SHLIB_SUFFIX; \
-			  ln -s $$prev $$SHLIB$$SHLIB_SUFFIX ); \
+			( $(SET_X); rm -f $(DSTDIR)/$$SHLIB$$SHLIB_SUFFIX; \
+			  ln -s $$prev $(DSTDIR)/$$SHLIB$$SHLIB_SUFFIX ); \
 		fi; \
 	fi
 
-LINK_SO_A=	SHOBJECTS=&quot;lib$(LIBNAME).a $(LIBEXTRAS)&quot;; $(LINK_SO)
+LINK_SO_A=	SHOBJECTS=&quot;$(DSTDIR)/lib$(LIBNAME).a $(LIBEXTRAS)&quot;; $(LINK_SO)
 LINK_SO_O=	SHOBJECTS=&quot;$(LIBEXTRAS)&quot;; $(LINK_SO)
 
 LINK_SO_A_VIA_O=	\
-  SHOBJECTS=lib$(LIBNAME).o; \
+  SHOBJECTS=$(DSTDIR)/lib$(LIBNAME).o; \
   ALL=$$ALLSYMSFLAGS; ALLSYMSFLAGS=; NOALLSYMSFLAGS=; \
-  ( echo ld $(LDFLAGS) -r -o lib$(LIBNAME).o $$ALL lib$(LIBNAME).a $(LIBEXTRAS); \
-    ld $(LDFLAGS) -r -o lib$(LIBNAME).o $$ALL lib$(LIBNAME).a $(LIBEXTRAS) ); \
-  $(LINK_SO) &amp;&amp; ( echo rm -f lib$(LIBNAME).o; rm -f lib$(LIBNAME).o )
+  ( echo ld $(LDFLAGS) -r -o $$SHOBJECTS.o $$ALL lib$(LIBNAME).a $(LIBEXTRAS); \
+    ld $(LDFLAGS) -r -o $$SHOBJECTS.o $$ALL $(DSTDIR)/lib$(LIBNAME).a $(LIBEXTRAS) ); \
+  $(LINK_SO) &amp;&amp; ( echo rm -f $$SHOBJECTS; rm -f $$SHOBJECTS )
 
 LINK_SO_A_UNPACKED=	\
   UNPACKDIR=link_tmp.$$$$; rm -rf $$UNPACKDIR; mkdir $$UNPACKDIR; \
-  (cd $$UNPACKDIR; ar x ../lib$(LIBNAME).a) &amp;&amp; \
+  (cd $$UNPACKDIR; ar x ../$(DSTDIR)/lib$(LIBNAME).a) &amp;&amp; \
   ([ -z &quot;$(LIBEXTRAS)&quot; ] || cp $(LIBEXTRAS) $$UNPACKDIR) &amp;&amp; \
   SHOBJECTS=$$UNPACKDIR/*.o; \
   $(LINK_SO) &amp;&amp; rm -rf $$UNPACKDIR
@@ -178,7 +184,7 @@ link_app.gnu:
 
 link_a.linux-shared:
 	@if [ $(LIBNAME) != &quot;crypto&quot; -a $(LIBNAME) != &quot;ssl&quot; ]; then $(DO_GNU_SO); else \
-	$(PERL) util/mkdef.pl $(LIBNAME) linux &gt;$(LIBNAME).map; \
+	$(PERL) $(SRCDIR)/util/mkdef.pl $(LIBNAME) linux &gt;$(LIBNAME).map; \
 	$(CALC_VERSIONS); \
 	SHLIB=lib$(LIBNAME).so; \
 	SHLIB_SUFFIX=; \
@@ -294,7 +300,7 @@ link_a.cygwin:
 		esac; \
 		SHLIB_SOVER=32; \
 		extras=&quot;$(LIBNAME).def&quot;; \
-		$(PERL) util/mkdef.pl 32 $$SHLIB &gt; $$extras; \
+		$(PERL) $(SRCDIR)/util/mkdef.pl 32 $$SHLIB &gt; $$extras; \
 		base=; [ $(LIBNAME) = &quot;crypto&quot; ] &amp;&amp; base=-Wl,--image-base,0x63000000; \
 	fi; \
 	dll_name=$$SHLIB$$SHLIB_SOVER$$SHLIB_SUFFIX; \
@@ -312,7 +318,7 @@ link_a.cygwin:
 	cp -p $$dll_name test/
 link_app.cygwin:
 	@if expr &quot;$(CFLAGS)&quot; : '.*OPENSSL_USE_APPLINK' &gt; /dev/null; then \
-		LIBDEPS=&quot;$(TOP)/crypto/applink.o $${LIBDEPS:-$(LIBDEPS)}&quot;; \
+		LIBDEPS=&quot;$(SRCDIR)/crypto/applink.o $${LIBDEPS:-$(LIBDEPS)}&quot;; \
 		export LIBDEPS; \
 	fi; \
 	$(LINK_APP)
@@ -393,7 +399,7 @@ link_a.solaris:
 		if [ $(LIBNAME) != &quot;crypto&quot; -a $(LIBNAME) != &quot;ssl&quot; ]; then \
 			ALLSYMSFLAGS=&quot;$${MINUSZ}allextract&quot;; \
 		else \
-			$(PERL) util/mkdef.pl $(LIBNAME) linux &gt;$(LIBNAME).map; \
+			$(PERL) $(SRCDIR)/util/mkdef.pl $(LIBNAME) linux &gt;$(LIBNAME).map; \
 			ALLSYMSFLAGS=&quot;$${MINUSZ}allextract,-M,$(LIBNAME).map&quot;; \
 		fi; \
 		NOALLSYMSFLAGS=&quot;$${MINUSZ}defaultextract&quot;; \
diff --git a/test/recipes/00-check_testexes.t b/test/recipes/00-check_testexes.t
index c086f7f..9da85f2 100644
--- a/test/recipes/00-check_testexes.t
+++ b/test/recipes/00-check_testexes.t
@@ -4,19 +4,19 @@ use strict;
 
 use File::Spec::Functions;
 use File::Basename;
-use OpenSSL::Test qw/:DEFAULT top_file/;
+use OpenSSL::Test qw/:DEFAULT bldtop_file/;
 
 setup(&quot;check_testexes&quot;);
 
 my $OpenSSL_ver = &quot;&quot;;
-my $Makefile = top_file(&quot;Makefile&quot;);
+my $Makefile = bldtop_file(&quot;Makefile&quot;);
 if (open(FH, $Makefile)) {
     $OpenSSL_ver =
 	(map { s/\R//; s/^VERSION=([^\s]*)\s*$//; $1 } grep { /^VERSION=/ } &lt;FH&gt;)[0];
     close FH;
 }
 
-my $MINFO = top_file(&quot;MINFO&quot;);
+my $MINFO = bldtop_file(&quot;MINFO&quot;);
 
 plan skip_all =&gt; &quot;because MINFO not found. If you want this test to run, please do 'perl util/mkfiles.pl &gt; MINFO'&quot;
     unless open(FH,$MINFO);
@@ -50,7 +50,7 @@ my @expected_tests =
 plan tests =&gt; scalar @expected_tests;
 
 my @found_tests =
-    map { basename($_) } glob(top_file(&quot;test&quot;, &quot;recipes&quot;, &quot;*.t&quot;));
+    map { basename($_) } glob(bldtop_file(&quot;test&quot;, &quot;recipes&quot;, &quot;*.t&quot;));
 
 foreach my $test (sort @expected_tests) {
     ok(scalar(grep(/^[0-9][0-9]-test_$test\.t$/, @found_tests)),
diff --git a/test/recipes/01-test_ordinals.t b/test/recipes/01-test_ordinals.t
index 6c5efff..ffda0f7 100755
--- a/test/recipes/01-test_ordinals.t
+++ b/test/recipes/01-test_ordinals.t
@@ -53,14 +53,14 @@
 # Hudson (<A HREF="../../../mailman/listinfo/openssl-commits.html">tjh at cryptsoft.com</A>).
 
 use strict;
-use OpenSSL::Test qw/:DEFAULT top_file/;
+use OpenSSL::Test qw/:DEFAULT srctop_file/;
 
 setup(&quot;test_ordinals&quot;);
 
 plan tests =&gt; 2;
 
-ok(testordinals(top_file(&quot;util&quot;, &quot;libeay.num&quot;)), &quot;Test libeay.num&quot;);
-ok(testordinals(top_file(&quot;util&quot;, &quot;ssleay.num&quot;)), &quot;Test ssleay.num&quot;);
+ok(testordinals(srctop_file(&quot;util&quot;, &quot;libeay.num&quot;)), &quot;Test libeay.num&quot;);
+ok(testordinals(srctop_file(&quot;util&quot;, &quot;ssleay.num&quot;)), &quot;Test ssleay.num&quot;);
 
 sub testordinals
 {
diff --git a/test/recipes/10-test_bn.t b/test/recipes/10-test_bn.t
index a01d9bf..7e728f4 100644
--- a/test/recipes/10-test_bn.t
+++ b/test/recipes/10-test_bn.t
@@ -5,13 +5,13 @@ use warnings;
 
 use Math::BigInt;
 
-use OpenSSL::Test qw/:DEFAULT top_file/;
+use OpenSSL::Test qw/:DEFAULT srctop_file/;
 
 setup(&quot;test_bn&quot;);
 
 plan tests =&gt; 3;
 
-require_ok(top_file(&quot;test&quot;,&quot;recipes&quot;,&quot;bc.pl&quot;));
+require_ok(srctop_file(&quot;test&quot;,&quot;recipes&quot;,&quot;bc.pl&quot;));
 
 my $testresults = &quot;tmp.bntest&quot;;
 my $init = ok(run(test([&quot;bntest&quot;], stdout =&gt; $testresults)), 'initialize');
diff --git a/test/recipes/15-test_dsa.t b/test/recipes/15-test_dsa.t
index 5a1917d..22f971c 100644
--- a/test/recipes/15-test_dsa.t
+++ b/test/recipes/15-test_dsa.t
@@ -4,14 +4,14 @@ use strict;
 use warnings;
 
 use File::Spec;
-use OpenSSL::Test qw/:DEFAULT top_file/;
+use OpenSSL::Test qw/:DEFAULT srctop_file/;
 use OpenSSL::Test::Utils;
 
 setup(&quot;test_dsa&quot;);
 
 plan tests =&gt; 6;
 
-require_ok(top_file('test','recipes','tconversion.pl'));
+require_ok(srctop_file('test','recipes','tconversion.pl'));
 
 ok(run(test([&quot;dsatest&quot;])), &quot;running dsatest&quot;);
 ok(run(test([&quot;dsatest&quot;, &quot;-app2_1&quot;])), &quot;running dsatest -app2_1&quot;);
@@ -21,13 +21,13 @@ ok(run(test([&quot;dsatest&quot;, &quot;-app2_1&quot;])), &quot;running dsatest -app2_1&quot;);
 	 if disabled(&quot;dsa&quot;);
 
      subtest 'dsa conversions -- private key' =&gt; sub {
-	 tconversion(&quot;dsa&quot;, top_file(&quot;test&quot;,&quot;testdsa.pem&quot;));
+	 tconversion(&quot;dsa&quot;, srctop_file(&quot;test&quot;,&quot;testdsa.pem&quot;));
      };
      subtest 'dsa conversions -- private key PKCS#8' =&gt; sub {
-	 tconversion(&quot;dsa&quot;, top_file(&quot;test&quot;,&quot;testdsa.pem&quot;), &quot;pkey&quot;);
+	 tconversion(&quot;dsa&quot;, srctop_file(&quot;test&quot;,&quot;testdsa.pem&quot;), &quot;pkey&quot;);
      };
      subtest 'dsa conversions -- public key' =&gt; sub {
-	 tconversion(&quot;dsa&quot;, top_file(&quot;test&quot;,&quot;testdsapub.pem&quot;), &quot;dsa&quot;,
+	 tconversion(&quot;dsa&quot;, srctop_file(&quot;test&quot;,&quot;testdsapub.pem&quot;), &quot;dsa&quot;,
 		     &quot;-pubin&quot;, &quot;-pubout&quot;);
      };
 }
diff --git a/test/recipes/15-test_ec.t b/test/recipes/15-test_ec.t
index 4701dc8..48b8ce8 100644
--- a/test/recipes/15-test_ec.t
+++ b/test/recipes/15-test_ec.t
@@ -4,14 +4,14 @@ use strict;
 use warnings;
 
 use File::Spec;
-use OpenSSL::Test qw/:DEFAULT top_file/;
+use OpenSSL::Test qw/:DEFAULT srctop_file/;
 use OpenSSL::Test::Utils;
 
 setup(&quot;test_ec&quot;);
 
 plan tests =&gt; 5;
 
-require_ok(top_file('test','recipes','tconversion.pl'));
+require_ok(srctop_file('test','recipes','tconversion.pl'));
 
 ok(run(test([&quot;ectest&quot;])), &quot;running ectest&quot;);
 
@@ -20,12 +20,12 @@ ok(run(test([&quot;ectest&quot;])), &quot;running ectest&quot;);
 	 if disabled(&quot;ec&quot;);
 
      subtest 'ec conversions -- private key' =&gt; sub {
-	 tconversion(&quot;ec&quot;, top_file(&quot;test&quot;,&quot;testec-p256.pem&quot;));
+	 tconversion(&quot;ec&quot;, srctop_file(&quot;test&quot;,&quot;testec-p256.pem&quot;));
      };
      subtest 'ec conversions -- private key PKCS#8' =&gt; sub {
-	 tconversion(&quot;ec&quot;, top_file(&quot;test&quot;,&quot;testec-p256.pem&quot;), &quot;pkey&quot;);
+	 tconversion(&quot;ec&quot;, srctop_file(&quot;test&quot;,&quot;testec-p256.pem&quot;), &quot;pkey&quot;);
      };
      subtest 'ec conversions -- public key' =&gt; sub {
-	 tconversion(&quot;ec&quot;, top_file(&quot;test&quot;,&quot;testecpub-p256.pem&quot;), &quot;ec&quot;, &quot;-pubin&quot;, &quot;-pubout&quot;);
+	 tconversion(&quot;ec&quot;, srctop_file(&quot;test&quot;,&quot;testecpub-p256.pem&quot;), &quot;ec&quot;, &quot;-pubin&quot;, &quot;-pubout&quot;);
      };
 }
diff --git a/test/recipes/15-test_rsa.t b/test/recipes/15-test_rsa.t
index 6418ff7..42bba1d 100644
--- a/test/recipes/15-test_rsa.t
+++ b/test/recipes/15-test_rsa.t
@@ -4,14 +4,14 @@ use strict;
 use warnings;
 
 use File::Spec;
-use OpenSSL::Test qw/:DEFAULT top_file/;
+use OpenSSL::Test qw/:DEFAULT srctop_file/;
 use OpenSSL::Test::Utils;
 
 setup(&quot;test_rsa&quot;);
 
 plan tests =&gt; 5;
 
-require_ok(top_file('test','recipes','tconversion.pl'));
+require_ok(srctop_file('test','recipes','tconversion.pl'));
 
 ok(run(test([&quot;rsa_test&quot;])), &quot;running rsatest&quot;);
 
@@ -20,13 +20,13 @@ ok(run(test([&quot;rsa_test&quot;])), &quot;running rsatest&quot;);
 	 if disabled(&quot;rsa&quot;);
 
      subtest 'rsa conversions -- private key' =&gt; sub {
-	 tconversion(&quot;rsa&quot;, top_file(&quot;test&quot;,&quot;testrsa.pem&quot;));
+	 tconversion(&quot;rsa&quot;, srctop_file(&quot;test&quot;,&quot;testrsa.pem&quot;));
      };
      subtest 'rsa conversions -- private key PKCS#8' =&gt; sub {
-	 tconversion(&quot;rsa&quot;, top_file(&quot;test&quot;,&quot;testrsa.pem&quot;), &quot;pkey&quot;);
+	 tconversion(&quot;rsa&quot;, srctop_file(&quot;test&quot;,&quot;testrsa.pem&quot;), &quot;pkey&quot;);
      };
      subtest 'rsa conversions -- public key' =&gt; sub {
-	 tconversion(&quot;rsa&quot;, top_file(&quot;test&quot;,&quot;testrsapub.pem&quot;), &quot;rsa&quot;,
+	 tconversion(&quot;rsa&quot;, srctop_file(&quot;test&quot;,&quot;testrsapub.pem&quot;), &quot;rsa&quot;,
 		     &quot;-pubin&quot;, &quot;-pubout&quot;);
      };
 }
diff --git a/test/recipes/20-test_enc.t b/test/recipes/20-test_enc.t
index 55f3942..2efcf70 100644
--- a/test/recipes/20-test_enc.t
+++ b/test/recipes/20-test_enc.t
@@ -7,14 +7,14 @@ use File::Spec::Functions qw/catfile/;
 use File::Copy;
 use File::Compare qw/compare_text/;
 use File::Basename;
-use OpenSSL::Test qw/:DEFAULT top_file/;
+use OpenSSL::Test qw/:DEFAULT srctop_file/;
 
 setup(&quot;test_enc&quot;);
 
 # We do it this way, because setup() may have moved us around,
 # so the directory portion of $0 might not be correct any more.
 # However, the name hasn't changed.
-my $testsrc = top_file(&quot;test&quot;,&quot;recipes&quot;,basename($0));
+my $testsrc = srctop_file(&quot;test&quot;,&quot;recipes&quot;,basename($0));
 
 my $test = catfile(&quot;.&quot;, &quot;p&quot;);
 
diff --git a/test/recipes/25-test_crl.t b/test/recipes/25-test_crl.t
index 6779a0b..8650bfc 100644
--- a/test/recipes/25-test_crl.t
+++ b/test/recipes/25-test_crl.t
@@ -4,14 +4,14 @@ use strict;
 use warnings;
 
 use File::Spec;
-use OpenSSL::Test qw/:DEFAULT top_file/;
+use OpenSSL::Test qw/:DEFAULT srctop_file/;
 
 setup(&quot;test_crl&quot;);
 
 plan tests =&gt; 2;
 
-require_ok(top_file('test','recipes','tconversion.pl'));
+require_ok(srctop_file('test','recipes','tconversion.pl'));
 
 subtest 'crl conversions' =&gt; sub {
-    tconversion(&quot;crl&quot;, top_file(&quot;test&quot;,&quot;testcrl.pem&quot;));
+    tconversion(&quot;crl&quot;, srctop_file(&quot;test&quot;,&quot;testcrl.pem&quot;));
 };
diff --git a/test/recipes/25-test_gen.t b/test/recipes/25-test_gen.t
index dc8ca6a..ce4a5ee 100644
--- a/test/recipes/25-test_gen.t
+++ b/test/recipes/25-test_gen.t
@@ -4,7 +4,7 @@ use strict;
 use warnings;
 
 use File::Spec;
-use OpenSSL::Test qw/:DEFAULT top_file/;
+use OpenSSL::Test qw/:DEFAULT srctop_file/;
 use OpenSSL::Test::Utils;
 
 setup(&quot;test_gen&quot;);
@@ -13,7 +13,7 @@ plan tests =&gt; 1;
 
 my $T = &quot;testcert&quot;;
 my $KEY = 512;
-my $CA = top_file(&quot;certs&quot;, &quot;testca.pem&quot;);
+my $CA = srctop_file(&quot;certs&quot;, &quot;testca.pem&quot;);
 
 unlink &quot;$T.1&quot;, &quot;$T.2&quot;, &quot;$T.key&quot;;
 open RND, &quot;&gt;&gt;&quot;, &quot;.rnd&quot;;
@@ -23,7 +23,7 @@ close RND;
 subtest &quot;generating certificate requests&quot; =&gt; sub {
     my @req_new;
     if (disabled(&quot;rsa&quot;)) {
-	@req_new = (&quot;-newkey&quot;, &quot;dsa:&quot;.top_file(&quot;apps&quot;, &quot;dsa512.pem&quot;));
+	@req_new = (&quot;-newkey&quot;, &quot;dsa:&quot;.srctop_file(&quot;apps&quot;, &quot;dsa512.pem&quot;));
     } else {
 	@req_new = (&quot;-new&quot;);
 	note(&quot;There should be a 2 sequences of .'s and some +'s.&quot;);
@@ -34,11 +34,11 @@ subtest &quot;generating certificate requests&quot; =&gt; sub {
 
     plan tests =&gt; 2;
 
-    ok(run(app([&quot;openssl&quot;, &quot;req&quot;, &quot;-config&quot;, top_file(&quot;test&quot;, &quot;test.cnf&quot;),
+    ok(run(app([&quot;openssl&quot;, &quot;req&quot;, &quot;-config&quot;, srctop_file(&quot;test&quot;, &quot;test.cnf&quot;),
 		@req_new, &quot;-out&quot;, &quot;testreq.pem&quot;])),
        &quot;Generating request&quot;);
 
-    ok(run(app([&quot;openssl&quot;, &quot;req&quot;, &quot;-config&quot;, top_file(&quot;test&quot;, &quot;test.cnf&quot;),
+    ok(run(app([&quot;openssl&quot;, &quot;req&quot;, &quot;-config&quot;, srctop_file(&quot;test&quot;, &quot;test.cnf&quot;),
 		&quot;-verify&quot;, &quot;-in&quot;, &quot;testreq.pem&quot;, &quot;-noout&quot;])),
        &quot;Verifying signature on request&quot;);
 };
diff --git a/test/recipes/25-test_pkcs7.t b/test/recipes/25-test_pkcs7.t
index 3a4dbb4..6e9b397 100644
--- a/test/recipes/25-test_pkcs7.t
+++ b/test/recipes/25-test_pkcs7.t
@@ -4,17 +4,17 @@ use strict;
 use warnings;
 
 use File::Spec;
-use OpenSSL::Test qw/:DEFAULT top_file/;
+use OpenSSL::Test qw/:DEFAULT srctop_file/;
 
 setup(&quot;test_pkcs7&quot;);
 
 plan tests =&gt; 3;
 
-require_ok(top_file('test','recipes','tconversion.pl'));
+require_ok(srctop_file('test','recipes','tconversion.pl'));
 
 subtest 'pkcs7 conversions -- pkcs7' =&gt; sub {
-    tconversion(&quot;p7&quot;, top_file(&quot;test&quot;, &quot;testp7.pem&quot;), &quot;pkcs7&quot;);
+    tconversion(&quot;p7&quot;, srctop_file(&quot;test&quot;, &quot;testp7.pem&quot;), &quot;pkcs7&quot;);
 };
 subtest 'pkcs7 conversions -- pkcs7d' =&gt; sub {
-    tconversion(&quot;p7d&quot;, top_file(&quot;test&quot;, &quot;pkcs7-1.pem&quot;), &quot;pkcs7&quot;);
+    tconversion(&quot;p7d&quot;, srctop_file(&quot;test&quot;, &quot;pkcs7-1.pem&quot;), &quot;pkcs7&quot;);
 };
diff --git a/test/recipes/25-test_req.t b/test/recipes/25-test_req.t
index ce1f869..fac9771 100644
--- a/test/recipes/25-test_req.t
+++ b/test/recipes/25-test_req.t
@@ -4,15 +4,15 @@ use strict;
 use warnings;
 
 use File::Spec;
-use OpenSSL::Test qw/:DEFAULT top_file/;
+use OpenSSL::Test qw/:DEFAULT srctop_file/;
 
 setup(&quot;test_req&quot;);
 
 plan tests =&gt; 3;
 
-require_ok(top_file('test','recipes','tconversion.pl'));
+require_ok(srctop_file('test','recipes','tconversion.pl'));
 
-my @openssl_args = (&quot;req&quot;, &quot;-config&quot;, &quot;../apps/openssl.cnf&quot;);
+my @openssl_args = (&quot;req&quot;, &quot;-config&quot;, srctop_file(&quot;apps&quot;, &quot;openssl.cnf&quot;));
 
 run_conversion('req conversions',
 	       &quot;testreq.pem&quot;);
diff --git a/test/recipes/25-test_sid.t b/test/recipes/25-test_sid.t
index b223c0d..84444b3 100644
--- a/test/recipes/25-test_sid.t
+++ b/test/recipes/25-test_sid.t
@@ -4,14 +4,14 @@ use strict;
 use warnings;
 
 use File::Spec;
-use OpenSSL::Test qw/:DEFAULT top_file/;
+use OpenSSL::Test qw/:DEFAULT srctop_file/;
 
 setup(&quot;test_sid&quot;);
 
 plan tests =&gt; 2;
 
-require_ok(top_file('test','recipes','tconversion.pl'));
+require_ok(srctop_file('test','recipes','tconversion.pl'));
 
 subtest 'sid conversions' =&gt; sub {
-    tconversion(&quot;sid&quot;, top_file(&quot;test&quot;,&quot;testsid.pem&quot;), &quot;sess_id&quot;);
+    tconversion(&quot;sid&quot;, srctop_file(&quot;test&quot;,&quot;testsid.pem&quot;), &quot;sess_id&quot;);
 };
diff --git a/test/recipes/25-test_verify.t b/test/recipes/25-test_verify.t
index 444f69b..c1d222b 100644
--- a/test/recipes/25-test_verify.t
+++ b/test/recipes/25-test_verify.t
@@ -4,7 +4,7 @@ use strict;
 use warnings;
 
 use File::Spec::Functions qw/canonpath/;
-use OpenSSL::Test qw/:DEFAULT top_file/;
+use OpenSSL::Test qw/:DEFAULT srctop_file/;
 
 setup(&quot;test_verify&quot;);
 
@@ -13,9 +13,9 @@ sub verify {
     my @args = qw(openssl verify -purpose);
     my @path = qw(test certs);
     push(@args, &quot;$purpose&quot;, @opts);
-    for (@$trusted) { push(@args, &quot;-trusted&quot;, top_file(@path, &quot;$_.pem&quot;)) }
-    for (@$untrusted) { push(@args, &quot;-untrusted&quot;, top_file(@path, &quot;$_.pem&quot;)) }
-    push(@args, top_file(@path, &quot;$cert.pem&quot;));
+    for (@$trusted) { push(@args, &quot;-trusted&quot;, srctop_file(@path, &quot;$_.pem&quot;)) }
+    for (@$untrusted) { push(@args, &quot;-untrusted&quot;, srctop_file(@path, &quot;$_.pem&quot;)) }
+    push(@args, srctop_file(@path, &quot;$cert.pem&quot;));
     run(app([@args]));
 }
 
diff --git a/test/recipes/25-test_x509.t b/test/recipes/25-test_x509.t
index e2d795a..1572a06 100644
--- a/test/recipes/25-test_x509.t
+++ b/test/recipes/25-test_x509.t
@@ -4,20 +4,20 @@ use strict;
 use warnings;
 
 use File::Spec;
-use OpenSSL::Test qw/:DEFAULT top_file/;
+use OpenSSL::Test qw/:DEFAULT srctop_file/;
 
 setup(&quot;test_x509&quot;);
 
 plan tests =&gt; 4;
 
-require_ok(top_file('test','recipes','tconversion.pl'));
+require_ok(srctop_file('test','recipes','tconversion.pl'));
 
 subtest 'x509 -- x.509 v1 certificate' =&gt; sub {
-    tconversion(&quot;x509&quot;, top_file(&quot;test&quot;,&quot;testx509.pem&quot;));
+    tconversion(&quot;x509&quot;, srctop_file(&quot;test&quot;,&quot;testx509.pem&quot;));
 };
 subtest 'x509 -- first x.509 v3 certificate' =&gt; sub {
-    tconversion(&quot;x509&quot;, top_file(&quot;test&quot;,&quot;v3-cert1.pem&quot;));
+    tconversion(&quot;x509&quot;, srctop_file(&quot;test&quot;,&quot;v3-cert1.pem&quot;));
 };
 subtest 'x509 -- second x.509 v3 certificate' =&gt; sub {
-    tconversion(&quot;x509&quot;, top_file(&quot;test&quot;,&quot;v3-cert2.pem&quot;));
+    tconversion(&quot;x509&quot;, srctop_file(&quot;test&quot;,&quot;v3-cert2.pem&quot;));
 };
diff --git a/test/recipes/30-test_evp.t b/test/recipes/30-test_evp.t
index 9d5ce6f..9ee24f4 100644
--- a/test/recipes/30-test_evp.t
+++ b/test/recipes/30-test_evp.t
@@ -3,10 +3,10 @@
 use strict;
 use warnings;
 
-use OpenSSL::Test qw/:DEFAULT top_file/;
+use OpenSSL::Test qw/:DEFAULT srctop_file/;
 
 setup(&quot;test_evp&quot;);
 
 plan tests =&gt; 1;
-ok(run(test([&quot;evp_test&quot;, top_file(&quot;test&quot;, &quot;evptests.txt&quot;)])),
+ok(run(test([&quot;evp_test&quot;, srctop_file(&quot;test&quot;, &quot;evptests.txt&quot;)])),
    &quot;running evp_test evptests.txt&quot;);
diff --git a/test/recipes/40-test_rehash.t b/test/recipes/40-test_rehash.t
index c4c6abc..f0a8fae 100644
--- a/test/recipes/40-test_rehash.t
+++ b/test/recipes/40-test_rehash.t
@@ -6,7 +6,7 @@ use warnings;
 use File::Spec::Functions;
 use File::Copy;
 use File::Basename;
-use OpenSSL::Test qw/:DEFAULT top_file/;
+use OpenSSL::Test qw/:DEFAULT bldtop_file/;
 
 setup(&quot;test_rehash&quot;);
 
@@ -51,7 +51,7 @@ indir &quot;rehash.$$&quot; =&gt; sub {
 
 sub prepare {
     my @sourcefiles =
-        sort map { glob(top_file('certs', 'demo', &quot;*.$_&quot;)) } ('pem',
+        sort map { glob(bldtop_file('certs', 'demo', &quot;*.$_&quot;)) } ('pem',
                                                               'crt',
                                                               'cer',
                                                               'crl');
diff --git a/test/recipes/70-test_sslcertstatus.t b/test/recipes/70-test_sslcertstatus.t
index 814ca0a..a7f2d8a 100755
--- a/test/recipes/70-test_sslcertstatus.t
+++ b/test/recipes/70-test_sslcertstatus.t
@@ -53,7 +53,7 @@
 # Hudson (<A HREF="../../../mailman/listinfo/openssl-commits.html">tjh at cryptsoft.com</A>).
 
 use strict;
-use OpenSSL::Test qw/:DEFAULT cmdstr top_file top_dir/;
+use OpenSSL::Test qw/:DEFAULT cmdstr srctop_file bldtop_dir/;
 use OpenSSL::Test::Utils;
 use TLSProxy::Proxy;
 
@@ -69,12 +69,12 @@ plan skip_all =&gt; &quot;$test_name needs the engine feature enabled&quot;
 plan skip_all =&gt; &quot;$test_name can only be performed with OpenSSL configured shared&quot;
     if disabled(&quot;shared&quot;);
 
-$ENV{OPENSSL_ENGINES} = top_dir(&quot;engines&quot;);
+$ENV{OPENSSL_ENGINES} = bldtop_dir(&quot;engines&quot;);
 $ENV{OPENSSL_ia32cap} = '~0x200000200000000';
 my $proxy = TLSProxy::Proxy-&gt;new(
     \&amp;certstatus_filter,
     cmdstr(app([&quot;openssl&quot;])),
-    top_file(&quot;apps&quot;, &quot;server.pem&quot;)
+    srctop_file(&quot;apps&quot;, &quot;server.pem&quot;)
 );
 
 plan tests =&gt; 1;
diff --git a/test/recipes/70-test_sslextension.t b/test/recipes/70-test_sslextension.t
index 3c9caad..f7ac9f4 100755
--- a/test/recipes/70-test_sslextension.t
+++ b/test/recipes/70-test_sslextension.t
@@ -53,7 +53,7 @@
 # Hudson (<A HREF="../../../mailman/listinfo/openssl-commits.html">tjh at cryptsoft.com</A>).
 
 use strict;
-use OpenSSL::Test qw/:DEFAULT cmdstr top_file top_dir/;
+use OpenSSL::Test qw/:DEFAULT cmdstr srctop_file bldtop_dir/;
 use OpenSSL::Test::Utils;
 use TLSProxy::Proxy;
 
@@ -69,12 +69,12 @@ plan skip_all =&gt; &quot;$test_name needs the engine feature enabled&quot;
 plan skip_all =&gt; &quot;$test_name can only be performed with OpenSSL configured shared&quot;
     if disabled(&quot;shared&quot;);
 
-$ENV{OPENSSL_ENGINES} = top_dir(&quot;engines&quot;);
+$ENV{OPENSSL_ENGINES} = bldtop_dir(&quot;engines&quot;);
 $ENV{OPENSSL_ia32cap} = '~0x200000200000000';
 my $proxy = TLSProxy::Proxy-&gt;new(
     \&amp;extension_filter,
     cmdstr(app([&quot;openssl&quot;])),
-    top_file(&quot;apps&quot;, &quot;server.pem&quot;)
+    srctop_file(&quot;apps&quot;, &quot;server.pem&quot;)
 );
 
 plan tests =&gt; 1;
diff --git a/test/recipes/70-test_sslsessiontick.t b/test/recipes/70-test_sslsessiontick.t
index 7e5ccad..f2c00da 100755
--- a/test/recipes/70-test_sslsessiontick.t
+++ b/test/recipes/70-test_sslsessiontick.t
@@ -53,7 +53,7 @@
 # Hudson (<A HREF="../../../mailman/listinfo/openssl-commits.html">tjh at cryptsoft.com</A>).
 
 use strict;
-use OpenSSL::Test qw/:DEFAULT cmdstr top_file top_dir/;
+use OpenSSL::Test qw/:DEFAULT cmdstr srctop_file bldtop_dir/;
 use OpenSSL::Test::Utils;
 use TLSProxy::Proxy;
 use File::Temp qw(tempfile);
@@ -70,7 +70,7 @@ plan skip_all =&gt; &quot;$test_name needs the engine feature enabled&quot;
 plan skip_all =&gt; &quot;$test_name can only be performed with OpenSSL configured shared&quot;
     if disabled(&quot;shared&quot;);
 
-$ENV{OPENSSL_ENGINES} = top_dir(&quot;engines&quot;);
+$ENV{OPENSSL_ENGINES} = bldtop_dir(&quot;engines&quot;);
 $ENV{OPENSSL_ia32cap} = '~0x200000200000000';
 
 sub checkmessages($$$$$$);
@@ -84,7 +84,7 @@ my $ticketseen = 0;
 my $proxy = TLSProxy::Proxy-&gt;new(
     undef,
     cmdstr(app([&quot;openssl&quot;])),
-    top_file(&quot;apps&quot;, &quot;server.pem&quot;)
+    srctop_file(&quot;apps&quot;, &quot;server.pem&quot;)
 );
 
 plan tests =&gt; 8;
diff --git a/test/recipes/70-test_sslskewith0p.t b/test/recipes/70-test_sslskewith0p.t
index 8261238..0e6a780 100755
--- a/test/recipes/70-test_sslskewith0p.t
+++ b/test/recipes/70-test_sslskewith0p.t
@@ -53,7 +53,7 @@
 # Hudson (<A HREF="../../../mailman/listinfo/openssl-commits.html">tjh at cryptsoft.com</A>).
 
 use strict;
-use OpenSSL::Test qw/:DEFAULT cmdstr top_file top_dir/;
+use OpenSSL::Test qw/:DEFAULT cmdstr srctop_file bldtop_dir/;
 use OpenSSL::Test::Utils;
 use TLSProxy::Proxy;
 
@@ -72,12 +72,12 @@ plan skip_all =&gt; &quot;$test_name can only be performed with OpenSSL configured share
 plan skip_all =&gt; &quot;dh is not supported by this OpenSSL build&quot;
     if disabled(&quot;dh&quot;);
 
-$ENV{OPENSSL_ENGINES} = top_dir(&quot;engines&quot;);
+$ENV{OPENSSL_ENGINES} = bldtop_dir(&quot;engines&quot;);
 $ENV{OPENSSL_ia32cap} = '~0x200000200000000';
 my $proxy = TLSProxy::Proxy-&gt;new(
     \&amp;ske_0_p_filter,
     cmdstr(app([&quot;openssl&quot;])),
-    top_file(&quot;apps&quot;, &quot;server.pem&quot;)
+    srctop_file(&quot;apps&quot;, &quot;server.pem&quot;)
 );
 
 plan tests =&gt; 1;
diff --git a/test/recipes/70-test_sslvertol.t b/test/recipes/70-test_sslvertol.t
index e5eef31..b12abee 100755
--- a/test/recipes/70-test_sslvertol.t
+++ b/test/recipes/70-test_sslvertol.t
@@ -53,7 +53,7 @@
 # Hudson (<A HREF="../../../mailman/listinfo/openssl-commits.html">tjh at cryptsoft.com</A>).
 
 use strict;
-use OpenSSL::Test qw/:DEFAULT cmdstr top_file top_dir/;
+use OpenSSL::Test qw/:DEFAULT cmdstr srctop_file bldtop_dir/;
 use OpenSSL::Test::Utils;
 use TLSProxy::Proxy;
 
@@ -69,12 +69,12 @@ plan skip_all =&gt; &quot;$test_name needs the engine feature enabled&quot;
 plan skip_all =&gt; &quot;$test_name can only be performed with OpenSSL configured shared&quot;
     if disabled(&quot;shared&quot;);
 
-$ENV{OPENSSL_ENGINES} = top_dir(&quot;engines&quot;);
+$ENV{OPENSSL_ENGINES} = bldtop_dir(&quot;engines&quot;);
 $ENV{OPENSSL_ia32cap} = '~0x200000200000000';
 my $proxy = TLSProxy::Proxy-&gt;new(
     \&amp;vers_tolerance_filter,
     cmdstr(app([&quot;openssl&quot;])),
-    top_file(&quot;apps&quot;, &quot;server.pem&quot;)
+    srctop_file(&quot;apps&quot;, &quot;server.pem&quot;)
 );
 
 plan tests =&gt; 2;
diff --git a/test/recipes/70-test_tlsextms.t b/test/recipes/70-test_tlsextms.t
index 8e3b414..a4419f5 100644
--- a/test/recipes/70-test_tlsextms.t
+++ b/test/recipes/70-test_tlsextms.t
@@ -53,7 +53,7 @@
 # Hudson (<A HREF="../../../mailman/listinfo/openssl-commits.html">tjh at cryptsoft.com</A>).
 
 use strict;
-use OpenSSL::Test qw/:DEFAULT cmdstr top_file top_dir/;
+use OpenSSL::Test qw/:DEFAULT cmdstr srctop_file bldtop_dir/;
 use OpenSSL::Test::Utils;
 use TLSProxy::Proxy;
 use File::Temp qw(tempfile);
@@ -70,7 +70,7 @@ plan skip_all =&gt; &quot;$test_name needs the engine feature enabled&quot;
 plan skip_all =&gt; &quot;$test_name can only be performed with OpenSSL configured shared&quot;
     if disabled(&quot;shared&quot;);
 
-$ENV{OPENSSL_ENGINES} = top_dir(&quot;engines&quot;);
+$ENV{OPENSSL_ENGINES} = bldtop_dir(&quot;engines&quot;);
 $ENV{OPENSSL_ia32cap} = '~0x200000200000000';
 
 sub checkmessages($$$$$);
@@ -86,7 +86,7 @@ my $fullhand = 0;
 my $proxy = TLSProxy::Proxy-&gt;new(
     \&amp;extms_filter,
     cmdstr(app([&quot;openssl&quot;])),
-    top_file(&quot;apps&quot;, &quot;server.pem&quot;),
+    srctop_file(&quot;apps&quot;, &quot;server.pem&quot;),
     1
 );
 
diff --git a/test/recipes/70-test_verify_extra.t b/test/recipes/70-test_verify_extra.t
index eec8904..8c213e8 100644
--- a/test/recipes/70-test_verify_extra.t
+++ b/test/recipes/70-test_verify_extra.t
@@ -1,12 +1,12 @@
 #! /usr/bin/perl
 
-use OpenSSL::Test qw/:DEFAULT top_file/;
+use OpenSSL::Test qw/:DEFAULT srctop_file/;
 
 setup(&quot;test_verify_extra&quot;);
 
 plan tests =&gt; 1;
 
 ok(run(test([&quot;verify_extra_test&quot;,
-             top_file(&quot;test&quot;, &quot;certs&quot;, &quot;roots.pem&quot;),
-             top_file(&quot;test&quot;, &quot;certs&quot;, &quot;untrusted.pem&quot;),
-             top_file(&quot;test&quot;, &quot;certs&quot;, &quot;bad.pem&quot;)])));
+             srctop_file(&quot;test&quot;, &quot;certs&quot;, &quot;roots.pem&quot;),
+             srctop_file(&quot;test&quot;, &quot;certs&quot;, &quot;untrusted.pem&quot;),
+             srctop_file(&quot;test&quot;, &quot;certs&quot;, &quot;bad.pem&quot;)])));
diff --git a/test/recipes/80-test_ca.t b/test/recipes/80-test_ca.t
index e97a83f..97e44c8 100644
--- a/test/recipes/80-test_ca.t
+++ b/test/recipes/80-test_ca.t
@@ -5,24 +5,24 @@ use warnings;
 
 use POSIX;
 use File::Path 2.00 qw/remove_tree/;
-use OpenSSL::Test qw/:DEFAULT cmdstr top_file/;
+use OpenSSL::Test qw/:DEFAULT cmdstr srctop_file/;
 
 setup(&quot;test_ca&quot;);
 
 $ENV{OPENSSL} = cmdstr(app([&quot;openssl&quot;]));
-my $std_openssl_cnf = $^O eq &quot;VMS&quot;
-    ? top_file(&quot;apps&quot;, &quot;openssl-vms.cnf&quot;) : top_file(&quot;apps&quot;, &quot;openssl.cnf&quot;);
+my $std_openssl_cnf =
+    srctop_file(&quot;apps&quot;, $^O eq &quot;VMS&quot; ? &quot;openssl-vms.cnf&quot; : &quot;openssl.cnf&quot;);
 
 remove_tree(&quot;demoCA&quot;, { safe =&gt; 0 });
 
 plan tests =&gt; 4;
  SKIP: {
-     $ENV{OPENSSL_CONFIG} = &quot;-config &quot;.top_file(&quot;test&quot;, &quot;CAss.cnf&quot;);
+     $ENV{OPENSSL_CONFIG} = &quot;-config &quot;.srctop_file(&quot;test&quot;, &quot;CAss.cnf&quot;);
      skip &quot;failed creating CA structure&quot;, 3
 	 if !ok(run(perlapp([&quot;CA.pl&quot;,&quot;-newca&quot;], stdin =&gt; undef, stderr =&gt; undef)),
 		'creating CA structure');
 
-     $ENV{OPENSSL_CONFIG} = &quot;-config &quot;.top_file(&quot;test&quot;, &quot;Uss.cnf&quot;);
+     $ENV{OPENSSL_CONFIG} = &quot;-config &quot;.srctop_file(&quot;test&quot;, &quot;Uss.cnf&quot;);
      skip &quot;failed creating new certificate request&quot;, 2
 	 if !ok(run(perlapp([&quot;CA.pl&quot;,&quot;-newreq&quot;], stderr =&gt; undef)),
 		'creating CA structure');
@@ -49,3 +49,4 @@ sub yes {
     close PIPE;
     return 0;
 }
+
diff --git a/test/recipes/80-test_cms.t b/test/recipes/80-test_cms.t
index 5445311..e372271 100644
--- a/test/recipes/80-test_cms.t
+++ b/test/recipes/80-test_cms.t
@@ -6,13 +6,13 @@ use warnings;
 use POSIX;
 use File::Spec::Functions qw/catfile/;
 use File::Compare qw/compare_text/;
-use OpenSSL::Test qw/:DEFAULT top_dir top_file/;
+use OpenSSL::Test qw/:DEFAULT srctop_dir srctop_file/;
 use OpenSSL::Test::Utils;
 
 setup(&quot;test_cms&quot;);
 
-my $smdir    = top_dir(&quot;test&quot;, &quot;smime-certs&quot;);
-my $smcont   = top_file(&quot;test&quot;, &quot;smcont.txt&quot;);
+my $smdir    = srctop_dir(&quot;test&quot;, &quot;smime-certs&quot;);
+my $smcont   = srctop_file(&quot;test&quot;, &quot;smcont.txt&quot;);
 my ($no_dh, $no_ec, $no_ec2m, $no_zlib) = disabled qw/dh ec ec2m zlib/;
 
 plan tests =&gt; 4;
diff --git a/test/recipes/80-test_dane.t b/test/recipes/80-test_dane.t
index e0aa524..6436735 100644
--- a/test/recipes/80-test_dane.t
+++ b/test/recipes/80-test_dane.t
@@ -2,7 +2,7 @@
 
 use strict;
 use warnings;
-use OpenSSL::Test qw/:DEFAULT top_dir top_file/;
+use OpenSSL::Test qw/:DEFAULT srctop_file/;
 use OpenSSL::Test::Utils;
 
 setup(&quot;test_dane&quot;);
@@ -13,5 +13,5 @@ plan skip_all =&gt; &quot;test_dane uses ec which is not supported by this OpenSSL build
 plan tests =&gt; 1;                # The number of tests being performed
 
 ok(run(test([&quot;danetest&quot;, &quot;example.com&quot;,
-             top_file(&quot;test&quot;, &quot;danetest.pem&quot;),
-             top_file(&quot;test&quot;, &quot;danetest.in&quot;)])), &quot;dane tests&quot;);
+             srctop_file(&quot;test&quot;, &quot;danetest.pem&quot;),
+             srctop_file(&quot;test&quot;, &quot;danetest.in&quot;)])), &quot;dane tests&quot;);
diff --git a/test/recipes/80-test_ocsp.t b/test/recipes/80-test_ocsp.t
index 6e256c7..43087f9 100644
--- a/test/recipes/80-test_ocsp.t
+++ b/test/recipes/80-test_ocsp.t
@@ -6,11 +6,11 @@ use warnings;
 use POSIX;
 use File::Spec::Functions qw/devnull catfile/;
 use File::Copy;
-use OpenSSL::Test qw/:DEFAULT with pipe top_dir/;
+use OpenSSL::Test qw/:DEFAULT with pipe srctop_dir/;
 
 setup(&quot;test_ocsp&quot;);
 
-my $ocspdir=top_dir(&quot;test&quot;, &quot;ocsp-tests&quot;);
+my $ocspdir=srctop_dir(&quot;test&quot;, &quot;ocsp-tests&quot;);
 # 17 December 2012 so we don't get certificate expiry errors.
 my @check_time=(&quot;-attime&quot;, &quot;1355875200&quot;);
 
diff --git a/test/recipes/80-test_ssl.t b/test/recipes/80-test_ssl.t
index e84d3cc..e0f2fc5 100644
--- a/test/recipes/80-test_ssl.t
+++ b/test/recipes/80-test_ssl.t
@@ -6,7 +6,7 @@ use warnings;
 use POSIX;
 use File::Spec;
 use File::Copy;
-use OpenSSL::Test qw/:DEFAULT with top_file cmdstr/;
+use OpenSSL::Test qw/:DEFAULT with bldtop_file srctop_file cmdstr/;
 use OpenSSL::Test::Utils;
 
 setup(&quot;test_ssl&quot;);
@@ -27,16 +27,16 @@ my $digest = &quot;-sha1&quot;;
 my @reqcmd = (&quot;openssl&quot;, &quot;req&quot;);
 my @x509cmd = (&quot;openssl&quot;, &quot;x509&quot;, $digest);
 my @verifycmd = (&quot;openssl&quot;, &quot;verify&quot;);
-my $dummycnf = top_file(&quot;apps&quot;, &quot;openssl.cnf&quot;);
+my $dummycnf = srctop_file(&quot;apps&quot;, &quot;openssl.cnf&quot;);
 
 my $CAkey = &quot;keyCA.ss&quot;;
 my $CAcert=&quot;certCA.ss&quot;;
 my $CAserial=&quot;certCA.srl&quot;;
 my $CAreq=&quot;reqCA.ss&quot;;
-my $CAconf=top_file(&quot;test&quot;,&quot;CAss.cnf&quot;);
+my $CAconf=srctop_file(&quot;test&quot;,&quot;CAss.cnf&quot;);
 my $CAreq2=&quot;req2CA.ss&quot;;	# temp
 
-my $Uconf=top_file(&quot;test&quot;,&quot;Uss.cnf&quot;);
+my $Uconf=srctop_file(&quot;test&quot;,&quot;Uss.cnf&quot;);
 my $Ukey=&quot;keyU.ss&quot;;
 my $Ureq=&quot;reqU.ss&quot;;
 my $Ucert=&quot;certU.ss&quot;;
@@ -49,13 +49,13 @@ my $Ekey=&quot;keyE.ss&quot;;
 my $Ereq=&quot;reqE.ss&quot;;
 my $Ecert=&quot;certE.ss&quot;;
 
-my $P1conf=top_file(&quot;test&quot;,&quot;P1ss.cnf&quot;);
+my $P1conf=srctop_file(&quot;test&quot;,&quot;P1ss.cnf&quot;);
 my $P1key=&quot;keyP1.ss&quot;;
 my $P1req=&quot;reqP1.ss&quot;;
 my $P1cert=&quot;certP1.ss&quot;;
 my $P1intermediate=&quot;tmp_intP1.ss&quot;;
 
-my $P2conf=top_file(&quot;test&quot;,&quot;P2ss.cnf&quot;);
+my $P2conf=srctop_file(&quot;test&quot;,&quot;P2ss.cnf&quot;);
 my $P2key=&quot;keyP2.ss&quot;;
 my $P2req=&quot;reqP2.ss&quot;;
 my $P2cert=&quot;certP2.ss&quot;;
@@ -105,7 +105,7 @@ sub testss {
     close RND;
 
     my @req_dsa = (&quot;-newkey&quot;,
-                   &quot;dsa:&quot;.File::Spec-&gt;catfile(&quot;..&quot;, &quot;apps&quot;, &quot;dsa1024.pem&quot;));;
+                   &quot;dsa:&quot;.srctop_file(&quot;apps&quot;, &quot;dsa1024.pem&quot;));
     my @req_new;
     if ($no_rsa) {
 	@req_new = @req_dsa;
@@ -306,17 +306,17 @@ sub testss {
 }
 
 sub testssl {
-    my $key = shift || top_file(&quot;apps&quot;,&quot;server.pem&quot;);
-    my $cert = shift || top_file(&quot;apps&quot;,&quot;server.pem&quot;);
+    my $key = shift || bldtop_file(&quot;apps&quot;,&quot;server.pem&quot;);
+    my $cert = shift || bldtop_file(&quot;apps&quot;,&quot;server.pem&quot;);
     my $CAtmp = shift;
-    my @CA = $CAtmp ? (&quot;-CAfile&quot;, $CAtmp) : (&quot;-CApath&quot;, top_dir(&quot;certs&quot;));
+    my @CA = $CAtmp ? (&quot;-CAfile&quot;, $CAtmp) : (&quot;-CApath&quot;, bldtop_dir(&quot;certs&quot;));
     my @extra = @_;
 
     my @ssltest = (&quot;ssltest&quot;,
 		   &quot;-s_key&quot;, $key, &quot;-s_cert&quot;, $cert,
 		   &quot;-c_key&quot;, $key, &quot;-c_cert&quot;, $cert);
 
-    my $serverinfo = top_file(&quot;test&quot;,&quot;serverinfo.pem&quot;);
+    my $serverinfo = srctop_file(&quot;test&quot;,&quot;serverinfo.pem&quot;);
 
     my $dsa_cert = 0;
     if (grep /DSA Public Key/, run(app([&quot;openssl&quot;, &quot;x509&quot;, &quot;-in&quot;, $cert,
@@ -528,13 +528,13 @@ sub testssl {
 	    skip &quot;skipping RSA tests&quot;, 2
 		if $no_rsa;
 
-	    ok(run(test([&quot;ssltest&quot;, &quot;-v&quot;, &quot;-bio_pair&quot;, &quot;-tls1&quot;, &quot;-s_cert&quot;, top_file(&quot;apps&quot;,&quot;server2.pem&quot;), &quot;-no_dhe&quot;, &quot;-no_ecdhe&quot;, &quot;-num&quot;, &quot;10&quot;, &quot;-f&quot;, &quot;-time&quot;, @extra])),
+	    ok(run(test([&quot;ssltest&quot;, &quot;-v&quot;, &quot;-bio_pair&quot;, &quot;-tls1&quot;, &quot;-s_cert&quot;, srctop_file(&quot;apps&quot;,&quot;server2.pem&quot;), &quot;-no_dhe&quot;, &quot;-no_ecdhe&quot;, &quot;-num&quot;, &quot;10&quot;, &quot;-f&quot;, &quot;-time&quot;, @extra])),
 	       'test tlsv1 with 1024bit RSA, no (EC)DHE, multiple handshakes');
 
 	    skip &quot;skipping RSA+DHE tests&quot;, 1
 		if $no_dh;
 
-	    ok(run(test([&quot;ssltest&quot;, &quot;-v&quot;, &quot;-bio_pair&quot;, &quot;-tls1&quot;, &quot;-s_cert&quot;, top_file(&quot;apps&quot;,&quot;server2.pem&quot;), &quot;-dhe1024dsa&quot;, &quot;-num&quot;, &quot;10&quot;, &quot;-f&quot;, &quot;-time&quot;, @extra])),
+	    ok(run(test([&quot;ssltest&quot;, &quot;-v&quot;, &quot;-bio_pair&quot;, &quot;-tls1&quot;, &quot;-s_cert&quot;, srctop_file(&quot;apps&quot;,&quot;server2.pem&quot;), &quot;-dhe1024dsa&quot;, &quot;-num&quot;, &quot;10&quot;, &quot;-f&quot;, &quot;-time&quot;, @extra])),
 	       'test tlsv1 with 1024bit RSA, 1024bit DHE, multiple handshakes');
 	  }
 
@@ -760,10 +760,10 @@ sub testssl {
 }
 
 sub testsslproxy {
-    my $key = shift || top_file(&quot;apps&quot;,&quot;server.pem&quot;);
-    my $cert = shift || top_file(&quot;apps&quot;,&quot;server.pem&quot;);
+    my $key = shift || srctop_file(&quot;apps&quot;,&quot;server.pem&quot;);
+    my $cert = shift || srctop_file(&quot;apps&quot;,&quot;server.pem&quot;);
     my $CAtmp = shift;
-    my @CA = $CAtmp ? (&quot;-CAfile&quot;, $CAtmp) : (&quot;-CApath&quot;, top_dir(&quot;certs&quot;));
+    my @CA = $CAtmp ? (&quot;-CAfile&quot;, $CAtmp) : (&quot;-CApath&quot;, bldtop_dir(&quot;certs&quot;));
     my @extra = @_;
 
     my @ssltest = (&quot;ssltest&quot;,
diff --git a/test/recipes/80-test_tsa.t b/test/recipes/80-test_tsa.t
index 8e02a6b..229f17e 100644
--- a/test/recipes/80-test_tsa.t
+++ b/test/recipes/80-test_tsa.t
@@ -6,7 +6,7 @@ use warnings;
 use POSIX;
 use File::Spec::Functions qw/splitdir curdir catfile/;
 use File::Compare;
-use OpenSSL::Test qw/:DEFAULT cmdstr top_file/;
+use OpenSSL::Test qw/:DEFAULT cmdstr srctop_file/;
 
 setup(&quot;test_tsa&quot;);
 
@@ -72,12 +72,12 @@ plan tests =&gt; 20;
 note &quot;setting up TSA test directory&quot;;
 indir &quot;tsa&quot; =&gt; sub
 {
-    $ENV{OPENSSL_CONF} = top_file(&quot;test&quot;, &quot;CAtsa.cnf&quot;);
+    $ENV{OPENSSL_CONF} = srctop_file(&quot;test&quot;, &quot;CAtsa.cnf&quot;);
     # Because that's what ../apps/CA.pl really looks at
     $ENV{OPENSSL_CONFIG} = &quot;-config &quot;.$ENV{OPENSSL_CONF};
     $ENV{OPENSSL} = cmdstr(app([&quot;openssl&quot;]));
-    $testtsa = top_file(&quot;test&quot;, &quot;recipes&quot;, &quot;80-test_tsa.t&quot;);
-    $CAtsa = top_file(&quot;test&quot;, &quot;CAtsa.cnf&quot;);
+    $testtsa = srctop_file(&quot;test&quot;, &quot;recipes&quot;, &quot;80-test_tsa.t&quot;);
+    $CAtsa = srctop_file(&quot;test&quot;, &quot;CAtsa.cnf&quot;);
 
  SKIP: {
      $ENV{TSDNSECT} = &quot;ts_ca_dn&quot;;
diff --git a/test/recipes/90-test_networking.t b/test/recipes/90-test_networking.t
index f8377c9..fb146dd 100644
--- a/test/recipes/90-test_networking.t
+++ b/test/recipes/90-test_networking.t
@@ -53,7 +53,7 @@
 # Hudson (<A HREF="../../../mailman/listinfo/openssl-commits.html">tjh at cryptsoft.com</A>).
 
 use strict;
-use OpenSSL::Test qw/:DEFAULT cmdstr top_file top_dir/;
+use OpenSSL::Test qw/:DEFAULT cmdstr srctop_file bldtop_file bldtop_dir/;
 use TLSProxy::Proxy;
 
 my $test_name = &quot;test_networking&quot;;
@@ -62,15 +62,15 @@ setup($test_name);
 plan skip_all =&gt; &quot;$test_name can only be performed with OpenSSL configured shared&quot;
     unless (map { s/\R//; s/^SHARED_LIBS=\s*//; $_ }
 	    grep { /^SHARED_LIBS=/ }
-	    do { local @ARGV = ( top_file(&quot;Makefile&quot;) ); &lt;&gt; })[0] ne &quot;&quot;;
+	    do { local @ARGV = ( bldtop_file(&quot;Makefile&quot;) ); &lt;&gt; })[0] ne &quot;&quot;;
 
-$ENV{OPENSSL_ENGINES} = top_dir(&quot;engines&quot;);
+$ENV{OPENSSL_ENGINES} = bldtop_dir(&quot;engines&quot;);
 $ENV{OPENSSL_ia32cap} = '~0x200000200000000';
 
 my $proxy = TLSProxy::Proxy-&gt;new(
     undef,
     cmdstr(app([&quot;openssl&quot;])),
-    top_file(&quot;apps&quot;, &quot;server.pem&quot;)
+    srctop_file(&quot;apps&quot;, &quot;server.pem&quot;)
 );
 
 plan tests =&gt; 2;
diff --git a/test/recipes/tconversion.pl b/test/recipes/tconversion.pl
index 0f9b03b..eeb25d0 100644
--- a/test/recipes/tconversion.pl
+++ b/test/recipes/tconversion.pl
@@ -6,7 +6,7 @@ use warnings;
 use File::Compare qw/compare_text/;
 use File::Copy;
 use lib 'testlib';
-use OpenSSL::Test qw/:DEFAULT top_file/;
+use OpenSSL::Test qw/:DEFAULT/;
 
 my %conversionforms = (
     # Default conversion forms.  Other series may be added with
diff --git a/test/run_tests.pl b/test/run_tests.pl
index c914783..f7bd623 100644
--- a/test/run_tests.pl
+++ b/test/run_tests.pl
@@ -7,10 +7,11 @@ use File::Spec::Functions qw/catdir catfile curdir abs2rel rel2abs/;
 use File::Basename;
 use Test::Harness qw/runtests $switches/;
 
-my $top = $ENV{TOP};
-my $recipesdir = catdir($top, &quot;test&quot;, &quot;recipes&quot;);
-my $testlib = catdir($top, &quot;test&quot;, &quot;testlib&quot;);
-my $utillib = catdir($top, &quot;util&quot;);
+my $srctop = $ENV{SRCTOP} || $ENV{TOP};
+my $bldtop = $ENV{BLDTOP} || $ENV{TOP};
+my $recipesdir = catdir($srctop, &quot;test&quot;, &quot;recipes&quot;);
+my $testlib = catdir($srctop, &quot;test&quot;, &quot;testlib&quot;);
+my $utillib = catdir($srctop, &quot;util&quot;);
 
 # It seems that $switches is getting interpreted with 'eval' or something
 # like that, and that we need to take care of backslashes or they will
diff --git a/test/testlib/OpenSSL/Test.pm b/test/testlib/OpenSSL/Test.pm
index 80b9a2f..47c1bdc 100644
--- a/test/testlib/OpenSSL/Test.pm
+++ b/test/testlib/OpenSSL/Test.pm
@@ -7,11 +7,12 @@ use Test::More 0.96;
 
 use Exporter;
 use vars qw($VERSION @ISA @EXPORT @EXPORT_OK %EXPORT_TAGS);
-$VERSION = &quot;0.7&quot;;
+$VERSION = &quot;0.8&quot;;
 @ISA = qw(Exporter);
 @EXPORT = (@Test::More::EXPORT, qw(setup indir app perlapp test perltest run));
<A HREF="../../../mailman/listinfo/openssl-commits.html">- at EXPORT_OK</A> = (@Test::More::EXPORT_OK, qw(top_dir top_file pipe with cmdstr
-                                         quotify));
<A HREF="../../../mailman/listinfo/openssl-commits.html">+ at EXPORT_OK</A> = (@Test::More::EXPORT_OK, qw(bldtop_dir bldtop_file
+                                         srctop_dir srctop_file
+                                         pipe with cmdstr quotify));
 
 =head1 NAME
 
@@ -37,8 +38,9 @@ In addition to the Test::More functions, it also provides functions that
 easily find the diverse programs within a OpenSSL build tree, as well as
 some other useful functions.
 
-This module I&lt;depends&gt; on the environment variable C&lt;$TOP&gt;.  Without it,
-it refuses to work.  See L&lt;/ENVIRONMENT&gt; below.
+This module I&lt;depends&gt; on the environment variables C&lt;$TOP&gt; or C&lt;$SRCTOP&gt;
+and C&lt;$BLDTOP&gt;.  Without one of the combinations it refuses to work.
+See L&lt;/ENVIRONMENT&gt; below.
 
 =cut
 
@@ -55,7 +57,7 @@ my $test_name = undef;
 
 # Directories we want to keep track of TOP, APPS, TEST and RESULTS are the
 # ones we're interested in, corresponding to the environment variables TOP
-# (mandatory), BIN_D, TEST_D and RESULT_D.
+# (mandatory), BIN_D, TEST_D, UTIL_D and RESULT_D.
 my %directories = ();
 
 # A bool saying if we shall stop all testing if the current recipe has failing
@@ -80,8 +82,10 @@ my %hooks = (
 my $debug = 0;
 
 # Declare some utility functions that are defined at the end
-sub top_file;
-sub top_dir;
+sub bldtop_file;
+sub bldtop_dir;
+sub srctop_file;
+sub srctop_dir;
 sub quotify;
 
 # Declare some private functions that are defined at the end
@@ -108,9 +112,10 @@ If it's not used in a OpenSSL test recipe, the rest of the recipe will
 most likely refuse to run.
 
 C&lt;setup&gt; checks for environment variables (see L&lt;/ENVIRONMENT&gt; below),
-check that C&lt;$TOP/Configure&gt; exists, C&lt;chdir&gt; into the results directory
-(defined by the C&lt;$RESULT_D&gt; environment variable if defined, otherwise
-C&lt;$TEST_D&gt; if defined, otherwise C&lt;$TOP/test&gt;).
+checks that C&lt;$TOP/Configure&gt; or C&lt;$SRCTOP/Configure&gt; exists, C&lt;chdir&gt;
+into the results directory (defined by the C&lt;$RESULT_D&gt; environment
+variable if defined, otherwise C&lt;$BLDTOP/test&gt; or C&lt;$TOP/test&gt;, whichever
+is defined).
 
 =back
 
@@ -120,12 +125,15 @@ sub setup {
     $test_name = shift;
 
     BAIL_OUT(&quot;setup() must receive a name&quot;) unless $test_name;
-    BAIL_OUT(&quot;setup() needs \$TOP to be defined&quot;) unless $ENV{TOP};
+    BAIL_OUT(&quot;setup() needs \$TOP or \$SRCTOP and \$BLDTOP to be defined&quot;)
+        unless $ENV{TOP} || ($ENV{SRCTOP} &amp;&amp; $ENV{BLDTOP});
+    BAIL_OUT(&quot;setup() found both \$TOP and \$SRCTOP or \$BLDTOP...&quot;)
+        if $ENV{TOP} &amp;&amp; ($ENV{SRCTOP} || $ENV{BLDTOP});
 
     __env();
 
     BAIL_OUT(&quot;setup() expects the file Configure in the \$TOP directory&quot;)
-	unless -f top_file(&quot;Configure&quot;);
+	unless -f srctop_file(&quot;Configure&quot;);
 
     __cwd($directories{RESULTS});
 
@@ -203,10 +211,12 @@ Both of these functions take a reference to a list that is a command and
 its arguments, and some additional options (described further on).
 
 C&lt;app&gt; expects to find the given command (the first item in the given list
-reference) as an executable in C&lt;$BIN_D&gt; (if defined, otherwise C&lt;$TOP/apps&gt;).
+reference) as an executable in C&lt;$BIN_D&gt; (if defined, otherwise C&lt;$TOP/apps&gt;
+or C&lt;$BLDTOP/apps&gt;).
 
 C&lt;test&gt; expects to find the given command (the first item in the given list
-reference) as an executable in C&lt;$TEST_D&gt; (if defined, otherwise C&lt;$TOP/test&gt;).
+reference) as an executable in C&lt;$TEST_D&gt; (if defined, otherwise C&lt;$TOP/test&gt;
+or C&lt;$BLDTOP/test&gt;).
 
 Both return a CODEREF to be used by C&lt;run&gt;, C&lt;pipe&gt; or C&lt;cmdstr&gt;.
 
@@ -354,11 +364,11 @@ END {
 
 The following functions are exported on request when using C&lt;OpenSSL::Test&gt;.
 
-  # To only get the top_file function.
-  use OpenSSL::Test qw/top_file/;
+  # To only get the bldtop_file and srctop_file functions.
+  use OpenSSL::Test qw/bldtop_file srctop_file/;
 
-  # To only get the top_file function in addition to the default ones.
-  use OpenSSL::Test qw/:DEFAULT top_file/;
+  # To only get the bldtop_file function in addition to the default ones.
+  use OpenSSL::Test qw/:DEFAULT bldtop_file/;
 
 =cut
 
@@ -366,38 +376,76 @@ The following functions are exported on request when using C&lt;OpenSSL::Test&gt;.
 
 =over 4
 
-=item B&lt;top_dir LIST&gt;
+=item B&lt;bldtop_dir LIST&gt;
 
 LIST is a list of directories that make up a path from the top of the OpenSSL
-source directory (as indicated by the environment variable C&lt;$TOP&gt;).
-C&lt;top_dir&gt; returns the resulting directory as a string, adapted to the local
+build directory (as indicated by the environment variable C&lt;$TOP&gt; or
+C&lt;$BLDTOP&gt;).
+C&lt;bldtop_dir&gt; returns the resulting directory as a string, adapted to the local
 operating system.
 
 =back
 
 =cut
 
-sub top_dir {
-    return __top_dir(@_);	# This caters for operating systems that have
+sub bldtop_dir {
+    return __bldtop_dir(@_);	# This caters for operating systems that have
 				# a very distinct syntax for directories.
 }
 
 =over 4
 
-=item B&lt;top_file LIST, FILENAME&gt;
+=item B&lt;bldtop_file LIST, FILENAME&gt;
 
 LIST is a list of directories that make up a path from the top of the OpenSSL
-source directory (as indicated by the environment variable C&lt;$TOP&gt;) and
-FILENAME is the name of a file located in that directory path.
-C&lt;top_file&gt; returns the resulting file path as a string, adapted to the local
+build directory (as indicated by the environment variable C&lt;$TOP&gt; or
+C&lt;$BLDTOP&gt;) and FILENAME is the name of a file located in that directory path.
+C&lt;bldtop_file&gt; returns the resulting file path as a string, adapted to the local
 operating system.
 
 =back
 
 =cut
 
-sub top_file {
-    return __top_file(@_);
+sub bldtop_file {
+    return __bldtop_file(@_);
+}
+
+=over 4
+
+=item B&lt;srctop_dir LIST&gt;
+
+LIST is a list of directories that make up a path from the top of the OpenSSL
+source directory (as indicated by the environment variable C&lt;$TOP&gt; or
+C&lt;$SRCTOP&gt;).
+C&lt;srctop_dir&gt; returns the resulting directory as a string, adapted to the local
+operating system.
+
+=back
+
+=cut
+
+sub srctop_dir {
+    return __srctop_dir(@_);	# This caters for operating systems that have
+				# a very distinct syntax for directories.
+}
+
+=over 4
+
+=item B&lt;srctop_file LIST, FILENAME&gt;
+
+LIST is a list of directories that make up a path from the top of the OpenSSL
+source directory (as indicated by the environment variable C&lt;$TOP&gt; or
+C&lt;$SRCTOP&gt;) and FILENAME is the name of a file located in that directory path.
+C&lt;srctop_file&gt; returns the resulting file path as a string, adapted to the local
+operating system.
+
+=back
+
+=cut
+
+sub srctop_file {
+    return __srctop_file(@_);
 }
 
 =over 4
@@ -583,25 +631,39 @@ failures will result in a C&lt;BAIL_OUT&gt; at the end of its run.
 =cut
 
 sub __env {
-    $directories{TOP}     = $ENV{TOP},
-    $directories{APPS}    = $ENV{BIN_D}    || catdir($directories{TOP},&quot;apps&quot;);
-    $directories{TEST}    = $ENV{TEST_D}   || catdir($directories{TOP},&quot;test&quot;);
+    $directories{SRCTOP}  = $ENV{SRCTOP} || $ENV{TOP};
+    $directories{BLDTOP}  = $ENV{BLDTOP} || $ENV{TOP};
+    $directories{APPS}    = $ENV{BIN_D}  || __bldtop_dir(&quot;apps&quot;);
+    $directories{TEST}    = $ENV{TEST_D} || __bldtop_dir(&quot;test&quot;);
     $directories{RESULTS} = $ENV{RESULT_D} || $directories{TEST};
 
     $end_with_bailout	  = $ENV{STOPTEST} ? 1 : 0;
 };
 
-sub __top_file {
+sub __srctop_file {
+    BAIL_OUT(&quot;Must run setup() first&quot;) if (! $test_name);
+
+    my $f = pop;
+    return catfile($directories{SRCTOP}<A HREF="../../../mailman/listinfo/openssl-commits.html">, at _</A>,$f);
+}
+
+sub __srctop_dir {
+    BAIL_OUT(&quot;Must run setup() first&quot;) if (! $test_name);
+
+    return catdir($directories{SRCTOP}<A HREF="../../../mailman/listinfo/openssl-commits.html">, at _</A>);
+}
+
+sub __bldtop_file {
     BAIL_OUT(&quot;Must run setup() first&quot;) if (! $test_name);
 
     my $f = pop;
-    return catfile($directories{TOP}<A HREF="../../../mailman/listinfo/openssl-commits.html">, at _</A>,$f);
+    return catfile($directories{BLDTOP}<A HREF="../../../mailman/listinfo/openssl-commits.html">, at _</A>,$f);
 }
 
-sub __top_dir {
+sub __bldtop_dir {
     BAIL_OUT(&quot;Must run setup() first&quot;) if (! $test_name);
 
-    return catdir($directories{TOP}<A HREF="../../../mailman/listinfo/openssl-commits.html">, at _</A>);
+    return catdir($directories{BLDTOP}<A HREF="../../../mailman/listinfo/openssl-commits.html">, at _</A>);
 }
 
 sub __test_file {
@@ -680,7 +742,7 @@ sub __cwd {
     # For each of these directory variables, figure out where they are relative
     # to the directory we want to move to if they aren't absolute (if they are,
     # they don't change!)
-    my @dirtags = (&quot;TOP&quot;, &quot;TEST&quot;, &quot;APPS&quot;, &quot;RESULTS&quot;);
+    my @dirtags = sort keys %directories;
     foreach (@dirtags) {
 	if (!file_name_is_absolute($directories{$_})) {
 	    my $newpath = abs2rel(rel2abs($directories{$_}), rel2abs($dir));
@@ -693,7 +755,8 @@ sub __cwd {
 	print STDERR &quot;  \$directories{TEST}    = \&quot;$directories{TEST}\&quot;\n&quot;;
 	print STDERR &quot;  \$directories{RESULTS} = \&quot;$directories{RESULTS}\&quot;\n&quot;;
 	print STDERR &quot;  \$directories{APPS}    = \&quot;$directories{APPS}\&quot;\n&quot;;
-	print STDERR &quot;  \$directories{TOP}     = \&quot;$directories{TOP}\&quot;\n&quot;;
+	print STDERR &quot;  \$directories{SRCTOP}  = \&quot;$directories{SRCTOP}\&quot;\n&quot;;
+	print STDERR &quot;  \$directories{BLDTOP}  = \&quot;$directories{BLDTOP}\&quot;\n&quot;;
 	print STDERR &quot;  \$test_log             = \&quot;&quot;,__test_log(),&quot;\&quot;\n&quot;;
 	print STDERR &quot;\n&quot;;
 	print STDERR &quot;  current directory is \&quot;&quot;,curdir(),&quot;\&quot;\n&quot;;
@@ -707,7 +770,7 @@ sub __fixup_cmd {
     my $prog = shift;
     my $exe_shell = shift;
 
-    my $prefix = __top_file(&quot;util&quot;, &quot;shlib_wrap.sh&quot;).&quot; &quot;;
+    my $prefix = __bldtop_file(&quot;util&quot;, &quot;shlib_wrap.sh&quot;).&quot; &quot;;
     my $ext = $ENV{&quot;EXE_EXT&quot;} || &quot;&quot;;
 
     if (defined($exe_shell)) {
diff --git a/test/testlib/OpenSSL/Test/Utils.pm b/test/testlib/OpenSSL/Test/Utils.pm
index 4273292..da35b14 100644
--- a/test/testlib/OpenSSL/Test/Utils.pm
+++ b/test/testlib/OpenSSL/Test/Utils.pm
@@ -34,7 +34,7 @@ This module provides utility functions for the testing framework.
 
 =cut
 
-use OpenSSL::Test qw/:DEFAULT top_file/;
+use OpenSSL::Test qw/:DEFAULT bldtop_file/;
 
 =over 4
 
@@ -75,9 +75,9 @@ my $configdata_loaded = 0;
 
 sub load_configdata {
     # We eval it so it doesn't run at compile time of this file.
-    # The latter would have top_dir() complain that setup() hasn't
+    # The latter would have bldtop_file() complain that setup() hasn't
     # been run yet.
-    my $configdata = top_file(&quot;configdata.pm&quot;);
+    my $configdata = bldtop_file(&quot;configdata.pm&quot;);
     eval { require $configdata;
 	   %available_protocols = %configdata::available_protocols;
 	   %disabled = %configdata::disabled;
diff --git a/util/mkdef.pl b/util/mkdef.pl
index 3151800..ff68d86 100755
--- a/util/mkdef.pl
+++ b/util/mkdef.pl
@@ -40,11 +40,12 @@
 
 use lib &quot;.&quot;;
 use configdata;
+use File::Spec::Functions;
 
 my $debug=0;
 
-my $crypto_num= &quot;util/libeay.num&quot;;
-my $ssl_num=    &quot;util/ssleay.num&quot;;
+my $crypto_num= catfile($config{sourcedir},&quot;util&quot;,&quot;libeay.num&quot;);
+my $ssl_num=    catfile($config{sourcedir},&quot;util&quot;,&quot;ssleay.num&quot;);
 my $libname;
 
 my $do_update = 0;
@@ -384,8 +385,9 @@ sub do_defs
 
 	foreach $file (split(/\s+/,$symhacksfile.&quot; &quot;.$files))
 		{
-		print STDERR &quot;DEBUG: starting on $file:\n&quot; if $debug;
-		open(IN,&quot;&lt;$file&quot;) || die &quot;unable to open $file:$!\n&quot;;
+		my $fn = catfile($config{sourcedir},$file);
+		print STDERR &quot;DEBUG: starting on $fn:\n&quot; if $debug;
+		open(IN,&quot;&lt;$fn&quot;) || die &quot;unable to open $fn:$!\n&quot;;
 		my $line = &quot;&quot;, my $def= &quot;&quot;;
 		my %tag = (
 			(map { $_ =&gt; 0 } @known_platforms),
@@ -1552,7 +1554,8 @@ sub count_parens
 #version
 sub get_openssl_version()
 {
-	open (IN, &quot;include/openssl/opensslv.h&quot;) || die &quot;Can't open opensslv.h&quot;;
+	my $fn = catfile($config{sourcedir},&quot;include&quot;,&quot;openssl&quot;,&quot;opensslv.h&quot;);
+	open (IN, &quot;$fn&quot;) || die &quot;Can't open opensslv.h&quot;;
 
 	while(&lt;IN&gt;) {
 		if (/OPENSSL_VERSION_TEXT\s+&quot;OpenSSL (\d\.\d\.)(\d[a-z]*)(-| )/) {
</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="003782.html">[openssl-commits] [openssl]  master update
</A></li>
	<LI>Next message: <A HREF="003794.html">[openssl-commits] [openssl]  master update
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3792">[ date ]</a>
              <a href="thread.html#3792">[ thread ]</a>
              <a href="subject.html#3792">[ subject ]</a>
              <a href="author.html#3792">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="../../../mailman/listinfo/openssl-commits.html">More information about the openssl-commits
mailing list</a><br>
</body></html>
