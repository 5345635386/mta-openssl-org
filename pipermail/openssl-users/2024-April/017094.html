<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> Questions / SSL_accept errors (soliciting client
   </TITLE>
   <LINK REL="Index" HREF="https://mta.openssl.org/pipermail/openssl-users/2024-April/index.html" >
   <LINK REL="made" HREF="mailto:openssl-users%40openssl.org?Subject=Re%3A%20Questions%20/%20SSL_accept%20errors%20%28soliciting%20client&In-Reply-To=%3CPH7PR11MB5863C5FC92667575CCBA8BD9F3062%40PH7PR11MB5863.namprd11.prod.outlook.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="017090.html">
   <LINK REL="Next"  HREF="017096.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>Questions / SSL_accept errors (soliciting client</H1>
    <B>Martin Bonner</B> 
    <A HREF="mailto:openssl-users%40openssl.org?Subject=Re%3A%20Questions%20/%20SSL_accept%20errors%20%28soliciting%20client&In-Reply-To=%3CPH7PR11MB5863C5FC92667575CCBA8BD9F3062%40PH7PR11MB5863.namprd11.prod.outlook.com%3E"
       TITLE="Questions / SSL_accept errors (soliciting client">Martin.Bonner at entrust.com
       </A><BR>
    <I>Wed Apr 10 09:05:10 UTC 2024</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="017090.html">Questions
</A></li>
        <LI>Next message (by thread): <A HREF="017096.html">OpenSSL 3.3.0 ( and others ) fail testsuite due to IPv6 disabled
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#17094">[ date ]</a>
              <a href="thread.html#17094">[ thread ]</a>
              <a href="subject.html#17094">[ subject ]</a>
              <a href="author.html#17094">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>&gt;&gt;<i> And finally, but importantly, what exactly is your use case?  How does
</I>&gt;&gt;<i> the server expect to benefit from (make access and authorisation
</I>&gt;&gt;<i> decisions based on) client certificates?
</I>
&gt;<i> The case is an organization that was initially using passwords
</I>&gt;<i> for authentication.  That worked properly and was easy to setup.
</I>&gt;<i> However, in the process of doing that I discovered that all their
</I>&gt;<i> users had the name of the company as their password.  ...
</I>&gt;<i> I proposed the certificate authentication and management agreed.
</I>
This is off-topic for the OPENSSL list, but it might be worth
reconsidering passwords.  A minimum length of 12/15 characters + reject
anything that is known to have been used as a password in the past
(see <A HREF="https://haveibeenpwned.com/Passwords">https://haveibeenpwned.com/Passwords</A> where to get that list),
then strip non-alphabetic characters and reject anything with the
company name as well, would probably be &quot;good enough&quot;, and it is a
much less pervasive change than switching to client certificates.

Martin Bonner


From: openssl-users &lt;<A HREF="../../../mailman/listinfo/openssl-users.html">openssl-users-bounces at openssl.org</A>&gt; On Behalf Of <A HREF="../../../mailman/listinfo/openssl-users.html">openssl-users-request at openssl.org</A>
Sent: Wednesday, April 10, 2024 1:36 AM
To: <A HREF="../../../mailman/listinfo/openssl-users.html">openssl-users at openssl.org</A>
Subject: [EXTERNAL] openssl-users Digest, Vol 113, Issue 6

Send openssl-users mailing list submissions to openssl-users@&#8202;openssl.&#8202;org To subscribe or unsubscribe via the World Wide Web, visit https:&#8202;//urldefense.&#8202;com/v3/__https:&#8202;//mta.&#8202;openssl.&#8202;org/mailman/listinfo/openssl-users__;!!FJ-Y8qCqXTj2!Z4_OjCVt2ZxN2QfqMULBlr9PruEFLHmdq-wMr8gkIhKkX19e5-opf4Izyob0knUn_Th1ye1EZNYjAhMs0HPhEkPtt7tKjqY$

Send openssl-users mailing list submissions to
        mailto:<A HREF="../../../mailman/listinfo/openssl-users.html">openssl-users at openssl.org</A>

To subscribe or unsubscribe via the World Wide Web, visit
        <A HREF="https://urldefense.com/v3/__https://mta.openssl.org/mailman/listinfo/openssl-users__;!!FJ-Y8qCqXTj2!Z4_OjCVt2ZxN2QfqMULBlr9PruEFLHmdq-wMr8gkIhKkX19e5-opf4Izyob0knUn_Th1ye1EZNYjAhMs0HPhEkPtt7tKjqY$">https://urldefense.com/v3/__https://mta.openssl.org/mailman/listinfo/openssl-users__;!!FJ-Y8qCqXTj2!Z4_OjCVt2ZxN2QfqMULBlr9PruEFLHmdq-wMr8gkIhKkX19e5-opf4Izyob0knUn_Th1ye1EZNYjAhMs0HPhEkPtt7tKjqY$</A>
or, via email, send a message with subject or body 'help' to
        mailto:<A HREF="../../../mailman/listinfo/openssl-users.html">openssl-users-request at openssl.org</A>

You can reach the person managing the list at
        mailto:<A HREF="../../../mailman/listinfo/openssl-users.html">openssl-users-owner at openssl.org</A>

When replying, please edit your Subject line so it is more specific
than &quot;Re: Contents of openssl-users digest...&quot;


Today's Topics:

   1. OpenSSL version 3.3.0 published (OpenSSL)
   2. SSL_accept errors (Doug Hardie)
   3. Questions (Doug Hardie)
   4. Re: Questions / SSL_accept errors (soliciting client
      certificates) (Viktor Dukhovni)
   5. Re: Questions / SSL_accept errors (soliciting client
      certificates) (Doug Hardie)


----------------------------------------------------------------------

Message: 1
Date: Tue, 9 Apr 2024 12:56:00 +0000
From: OpenSSL &lt;mailto:<A HREF="../../../mailman/listinfo/openssl-users.html">openssl at openssl.org</A>&gt;
To: mailto:<A HREF="../../../mailman/listinfo/openssl-users.html">openssl-project at openssl.org</A>, OpenSSL User Support ML
        &lt;mailto:<A HREF="../../../mailman/listinfo/openssl-users.html">openssl-users at openssl.org</A>&gt;, OpenSSL Announce ML
        &lt;mailto:<A HREF="../../../mailman/listinfo/openssl-users.html">openssl-announce at openssl.org</A>&gt;
Subject: OpenSSL version 3.3.0 published
Message-ID: &lt;mailto:<A HREF="../../../mailman/listinfo/openssl-users.html">ZhU64O8mTQOAQpyT at openssl.org</A>&gt;
Content-Type: text/plain; charset=us-ascii

-----BEGIN PGP SIGNED MESSAGE-----
Hash: SHA256


   OpenSSL version 3.3.0 released
   ==============================

   OpenSSL - The Open Source toolkit for SSL/TLS
   <A HREF="https://urldefense.com/v3/__https://www.openssl.org/__;!!FJ-Y8qCqXTj2!Z4_OjCVt2ZxN2QfqMULBlr9PruEFLHmdq-wMr8gkIhKkX19e5-opf4Izyob0knUn_Th1ye1EZNYjAhMs0HPhEkPtXBIVnb0$">https://urldefense.com/v3/__https://www.openssl.org/__;!!FJ-Y8qCqXTj2!Z4_OjCVt2ZxN2QfqMULBlr9PruEFLHmdq-wMr8gkIhKkX19e5-opf4Izyob0knUn_Th1ye1EZNYjAhMs0HPhEkPtXBIVnb0$</A>

   The OpenSSL project team is pleased to announce the release of
   version 3.3.0 of our open source toolkit for SSL/TLS.
   For details of the changes, see the release notes at:

        <A HREF="https://urldefense.com/v3/__https://www.openssl.org/news/openssl-3.3-notes.html__;!!FJ-Y8qCqXTj2!Z4_OjCVt2ZxN2QfqMULBlr9PruEFLHmdq-wMr8gkIhKkX19e5-opf4Izyob0knUn_Th1ye1EZNYjAhMs0HPhEkPtxQZDyXI$">https://urldefense.com/v3/__https://www.openssl.org/news/openssl-3.3-notes.html__;!!FJ-Y8qCqXTj2!Z4_OjCVt2ZxN2QfqMULBlr9PruEFLHmdq-wMr8gkIhKkX19e5-opf4Izyob0knUn_Th1ye1EZNYjAhMs0HPhEkPtxQZDyXI$</A>

   Specific notes on upgrading to OpenSSL 3.3 from previous versions are
   available in the OpenSSL Migration Guide, here:

        <A HREF="https://urldefense.com/v3/__https://www.openssl.org/docs/man3.3/man7/migration_guide.html__;!!FJ-Y8qCqXTj2!Z4_OjCVt2ZxN2QfqMULBlr9PruEFLHmdq-wMr8gkIhKkX19e5-opf4Izyob0knUn_Th1ye1EZNYjAhMs0HPhEkPtU0Ko0RE$">https://urldefense.com/v3/__https://www.openssl.org/docs/man3.3/man7/migration_guide.html__;!!FJ-Y8qCqXTj2!Z4_OjCVt2ZxN2QfqMULBlr9PruEFLHmdq-wMr8gkIhKkX19e5-opf4Izyob0knUn_Th1ye1EZNYjAhMs0HPhEkPtU0Ko0RE$</A>

   The OpenSSL 3.3.0 is available for download at these URLs:

     * <A HREF="https://urldefense.com/v3/__https://www.openssl.org/source/__;!!FJ-Y8qCqXTj2!Z4_OjCVt2ZxN2QfqMULBlr9PruEFLHmdq-wMr8gkIhKkX19e5-opf4Izyob0knUn_Th1ye1EZNYjAhMs0HPhEkPtHWDvDEo$">https://urldefense.com/v3/__https://www.openssl.org/source/__;!!FJ-Y8qCqXTj2!Z4_OjCVt2ZxN2QfqMULBlr9PruEFLHmdq-wMr8gkIhKkX19e5-opf4Izyob0knUn_Th1ye1EZNYjAhMs0HPhEkPtHWDvDEo$</A>
     * <A HREF="https://urldefense.com/v3/__https://github.com/openssl/openssl/releases__;!!FJ-Y8qCqXTj2!Z4_OjCVt2ZxN2QfqMULBlr9PruEFLHmdq-wMr8gkIhKkX19e5-opf4Izyob0knUn_Th1ye1EZNYjAhMs0HPhEkPti5QABDM$">https://urldefense.com/v3/__https://github.com/openssl/openssl/releases__;!!FJ-Y8qCqXTj2!Z4_OjCVt2ZxN2QfqMULBlr9PruEFLHmdq-wMr8gkIhKkX19e5-opf4Izyob0knUn_Th1ye1EZNYjAhMs0HPhEkPti5QABDM$</A>

   The distribution file name is:

    o openssl-3.3.0.tar.gz
      Size: 18038030
      SHA1 checksum:  34cdf3259fd2af83ab2c92ac30c56f79ff5ad59e
      SHA256 checksum:  53e66b043322a606abf0087e7699a0e033a37fa13feb9742df35c3a33b18fb02

   The checksums were calculated using the following commands:

    openssl sha1 openssl-3.3.0.tar.gz
    openssl sha256 openssl-3.3.0.tar.gz

   Yours,

   The OpenSSL Project Team.

-----BEGIN PGP SIGNATURE-----

iQIzBAEBCAAdFiEE78CkZ9YTy4PH7W0w2JTizos9efUFAmYVMMIACgkQ2JTizos9
efUa0g/+JfJ/crbeQCXfnhJUHwWcU/CvuxLcE285jXLwziKWsHfzkq3wECsNhltW
Amkpztqa4D9tGL/Ve2UARFoNMRxnxyLyxt2DgnYxtXUcypHLDE4opKOp3CImW3Ex
GadXBZwxbCuiXJnZITs87pEhTCj3mvbv08ayH0RxJqQGs9E1CGOcJtmvdAnRAF3Q
5iZeFkwh+Bi3/4K04HofSjUHG7K9/WwEOZDv0PGwcuKOMXfMx5L9Xq/cPQ4bk/s/
hGf0hxE/R05r2kfQgXVfNem9CafnA5Ts+pAefDQ/IV/wugUZYjazLMXnm5FxbYoP
jsNnGgo8ZL3NbGAm2MEkgj6qL4NKpWqhbcgMavF2Pk9kwK3wsr52K1Monw3MxyWA
CEzP3fpter9PdH2Lvd56nzzgrQsUozEVHrWrz3EiwOsReq+AFy2VoDjofLNoarLr
OCiSeKm00iHUKq10MReC7seYfVKZRLN04mqu2fsdZ/WgHjcnKS2C3HbOq8jlkHFy
dt6UWdED89/X7ohXUxwfyBDRG6VDj89yxGsVXrIWvBhCEekDe4AVaNFqtZDD+hf1
eKuf27ll4UR/DBQdOeuJ68QM/yP0ik3rk1VVUrNkArLXRSrUP1srmy/cd4sUSkLd
BHVl+iY7NwDq6kiZjboRyBhga5l6rxfhD0AejuHJPu31EqqH95c=
=88+B
-----END PGP SIGNATURE-----


------------------------------

Message: 2
Date: Tue, 9 Apr 2024 08:43:39 -0700
From: Doug Hardie &lt;mailto:<A HREF="../../../mailman/listinfo/openssl-users.html">bc979 at lafn.org</A>&gt;
To: mailto:<A HREF="../../../mailman/listinfo/openssl-users.html">openssl-users at openssl.org</A>
Subject: SSL_accept errors
Message-ID: &lt;mailto:<A HREF="../../../mailman/listinfo/openssl-users.html">A0FFBB91-3F64-433E-86C0-4643F1150F4B at sermon-archive.info</A>&gt;
Content-Type: text/plain;       charset=us-ascii

I have a server that is &quot;working&quot;, but there are several issues with connections.  The server requires client certificates.  If I use openssl s_client and give it the proper certificate, I see one connection that makes the request and returns the response.  There are no errors indicated by the server and the response time is almost instantaneous.  All the involved systems are on the same LAN.

However, if I use one of the various clients to make the same request, the results are quite different.  There are a number of connections made that fail and then finally they make the proper connection and everything works.  The time it takes to get through all of that is quite long - around 5 seconds.  The server is recording the following errors from SSL_accept:

        Connection 1 - session id context uninitialized
        Connection 2 - session id context uninitialized
        Connection 3 - sslv3 alert certificate unknown
        Connection 4 - sslv3 alert certificate unknown

and then Connection 5 sees the proper client certificate, authenticates and produces output.

How can I figure out what is causing these multiple connections and the resulting errors.  I have tcpdump and ssldump output but nothing there gives me any ideas.  I can provide either of those if needed, but they are large.  Unfortunately I have not figured out how to get ssldump to decode the application data.  As best as I can tell, the negotiated cipher cannot be handled by ssldump.

I don't have access to any of the client's source code.  The session id in the error messages indicates that perhaps there is something I need to do with establishing sessions, but I haven't found any examples of what that would entail.  The clients each have the same 2 client certificates.  They ask which one to use, but perhaps they are trying both?  However, it doesn't appear that there are any certificates being passed in either direction for the first 4 sessions.  I see them in the 5th session.

-- Doug



------------------------------

Message: 3
Date: Tue, 9 Apr 2024 08:44:41 -0700
From: Doug Hardie &lt;mailto:<A HREF="../../../mailman/listinfo/openssl-users.html">bc979 at lafn.org</A>&gt;
To: Michael Wojcik via openssl-users &lt;mailto:<A HREF="../../../mailman/listinfo/openssl-users.html">openssl-users at openssl.org</A>&gt;
Subject: Questions
Message-ID: &lt;mailto:<A HREF="../../../mailman/listinfo/openssl-users.html">A2803C77-2B9A-43E0-BA0A-721BC89A0499 at sermon-archive.info</A>&gt;
Content-Type: text/plain;       charset=us-ascii

When using client certificates, how does SSL_accept validate the provided certificate?

If verify_callback is used, is the client certificate validated before the callback is called?

-- Doug



------------------------------

Message: 4
Date: Tue, 9 Apr 2024 13:59:09 -0400
From: Viktor Dukhovni &lt;mailto:<A HREF="../../../mailman/listinfo/openssl-users.html">openssl-users at dukhovni.org</A>&gt;
To: mailto:<A HREF="../../../mailman/listinfo/openssl-users.html">openssl-users at openssl.org</A>
Subject: Re: Questions / SSL_accept errors (soliciting client
        certificates)
Message-ID: &lt;mailto:<A HREF="../../../mailman/listinfo/openssl-users.html">ZhWB7Sq3CStLtoev at chardros.imrryr.org</A>&gt;
Content-Type: text/plain; charset=us-ascii

On Tue, Apr 09, 2024 at 08:44:41AM -0700, Doug Hardie wrote:

&gt;<i> When using client certificates, how does SSL_accept validate the
</I>&gt;<i> provided certificate?
</I>
By building a certificate chain to a local trust-anchor using the
server's configured trust store, and any untrusted intermediate
certificates presented by the remote client.

Note that verification of client certificates DOES NOT typically include
any &quot;identity&quot; checks, rather only the trustworthiness of the chain is
verified.  It is up to the server application to perform access control
on the requested resources based on whatever information the server
independently gleams from the certificate during or after the TLS
handshake.

&gt;<i> If verify_callback is used, is the client certificate validated before
</I>&gt;<i> the callback is called?
</I>
No, if all goes well, the callbacks (one per chain certificate) are
made *as part of* validation, with the &quot;ok&quot; parameter set to &quot;1&quot; if
there's no (new?) problem to report at the level in question.

If the callback returns a non-zero value, the handshake continues, if
zero it is aborted.  A callback that is purely diagnostic should return
the input &quot;ok&quot; value.  If the callback wants to either abort an
otherwise &quot;ok&quot; handshake, or ignore a particular problem, it can return
1 under appropriate conditions even if &quot;ok&quot; was zero.

Note that returning &quot;ok&quot; equal to one does not reset the verification
status for the chain, which can be tested, for e.g. success, via:

    SSL_get_verify_result(ssl) == X509_V_OK

this works even on resumption, because the original validation status is
part of the saved/resumed session.

The callback can (with great care to not ignore any important error
conditions) reset the validation result for less critical conditions,
but then it is necessary to either abort the handshake on the import
conditions, or save away state that an earlier problem was not
ignorable, and reset the error to that, rather than to X509_V_OK.

See X509_STORE_CTX_set_error(3), but tread cautiously, there be dragons.

On Tue, Apr 09, 2024 at 08:43:39AM -0700, Doug Hardie wrote:

&gt;<i> The server requires client certificates.  If I use
</I>&gt;<i> openssl s_client and give it the proper certificate, I see one
</I>&gt;<i> connection that makes the request and returns the response.
</I>
The &quot;s_client&quot; application is liberal in what it accepts:

    - Without non-default options, the handshake completes (with some
      addtional noise) even if the server certificate fails to verufy.

    - It presents the specified client certificate even if the server
      does not solicit its issuer CA (or ultimate trust anchor) in its
      certificate request message, which lists the acceptable CAs.

    - There may of course be subtle differences in various extensions
      used, the SNI extension may be important, the others typically
      less so.

    - Your s_client may be dated, and the issue may only manifest with
      bleeding edge client capabilities, though again your s_client is
      likely not that old (1.1.1, supports TLS 1.3) and you rarely need
      more.

Speculatively, the second item is the most likely source of issues.


&gt;<i> However, if I use one of the various clients to make the same request,
</I>&gt;<i> the results are quite different.  There are a number of connections
</I>&gt;<i> made that fail and then finally they make the proper connection and
</I>&gt;<i> everything works.  The time it takes to get through all of that is
</I>&gt;<i> quite long - around 5 seconds.  The server is recording the following
</I>&gt;<i> errors from SSL_accept:
</I>&gt;<i>
</I>&gt;<i>       Connection 1 - session id context uninitialized
</I>&gt;<i>       Connection 2 - session id context uninitialized
</I>&gt;<i>       Connection 3 - sslv3 alert certificate unknown
</I>&gt;<i>       Connection 4 - sslv3 alert certificate unknown
</I>
Who's sending/receiving the alerts?  The server would typically report
*received* alerts, and it is then perhaps the client that is failing to
validate the server certificate, but without a clear context, it is
difficult to say what happened.

As for session id contexts, your server code needs to set one in order
to support resumption properly, one more difference between s_client
and other clients, is that s_client always starts with no saved
sessions.

The Postfix SMTP server has:

     /*                                                                                                                                                                           * The session_id_context identifies the service that created a session.                                                                                                     * This information is used to distinguish between multiple TLS-based                                                                                                        * servers running on the same server. We use the name of the mail system.                                                                                                   */                                                                                                                                                                        static const char server_session_id_context[] = &quot;Postfix/TLS&quot;;
    ...
    SSL_CTX_set_session_id_context(server_ctx,                                                                                                                                                                 (void *) &amp;server_session_id_context,                                                                                                                                        sizeof(server_session_id_context));

&gt;<i> and then Connection 5 sees the proper client certificate, authenticates and produces output.
</I>
Perhaps the client is no longer attempting resumption?

&gt;<i> How can I figure out what is causing these multiple connections and
</I>&gt;<i> the resulting errors.  I have tcpdump and ssldump output but nothing
</I>&gt;<i> there gives me any ideas.
</I>
The ssldump software is abandoned, use &quot;tcpdump&quot; + &quot;&quot;tshark&quot;, as explained in:

     <A HREF="https://urldefense.com/v3/__https://marc.info/?l=postfix-users&amp;m=166005488423800&amp;w=2__;!!FJ-Y8qCqXTj2!Z4_OjCVt2ZxN2QfqMULBlr9PruEFLHmdq-wMr8gkIhKkX19e5-opf4Izyob0knUn_Th1ye1EZNYjAhMs0HPhEkPtiZQYfRg$">https://urldefense.com/v3/__https://marc.info/?l=postfix-users&amp;m=166005488423800&amp;w=2__;!!FJ-Y8qCqXTj2!Z4_OjCVt2ZxN2QfqMULBlr9PruEFLHmdq-wMr8gkIhKkX19e5-opf4Izyob0knUn_Th1ye1EZNYjAhMs0HPhEkPtiZQYfRg$</A>


&gt;<i> I can provide either of those if needed, but they are large.
</I>

With &quot;tcpdump&quot;, after capturing a bunch of traffic, you extract just a
particular connection of interest, details in the post linked above.
You can then analyse it with &quot;tshark&quot; (same link).

&gt;<i> Unfortunately I have not figured out how to get ssldump to decode the
</I>&gt;<i> application data.  As best as I can tell, the negotiated cipher cannot
</I>&gt;<i> be handled by ssldump.
</I>
Delete &quot;ssldump&quot; you're better off without it.

&gt;<i> The clients each have the same 2 client certificates.  They ask which
</I>&gt;<i> one to use, but perhaps they are trying both?
</I>
A given handshake can only try one client certificate as part of the
normal handshake.  THere's also post-handshake authenticaiton (PHA) in
TLS 1.3, but you probably don't have server code for that.

That the clients are putting up a dialogue does strengthen the
plausibility of the server's client certificate request being part of
the problem.  You may need to carefully tune your server's list of
solicited client CAs.  See the docs for SSL_CTX_set_client_CA_list(3).
Less is more (ideally just one if there's only one CA issuing the
desired certificates).

And finally, but importantly, what exactly is your use case?  How does
the server expect to benefit from (make access and authorisation
decisions based on) client certificates?

--
    Viktor.


------------------------------

Message: 5
Date: Tue, 9 Apr 2024 17:35:53 -0700
From: Doug Hardie &lt;mailto:<A HREF="../../../mailman/listinfo/openssl-users.html">bc979 at lafn.org</A>&gt;
To: mailto:<A HREF="../../../mailman/listinfo/openssl-users.html">openssl-users at openssl.org</A>
Subject: Re: Questions / SSL_accept errors (soliciting client
        certificates)
Message-ID: &lt;mailto:<A HREF="../../../mailman/listinfo/openssl-users.html">89DCA32D-14BA-4734-9DCD-D03E4A8FB7F2 at sermon-archive.info</A>&gt;
Content-Type: text/plain; charset=&quot;us-ascii&quot;

Attached is the result for the first connection:

Nothing stands out that I can see.

-- Doug

&gt;<i> On Apr 9, 2024, at 10:59, Viktor Dukhovni &lt;mailto:<A HREF="../../../mailman/listinfo/openssl-users.html">openssl-users at dukhovni.org</A>&gt; wrote:
</I>&gt;<i>
</I>&gt;<i> On Tue, Apr 09, 2024 at 08:44:41AM -0700, Doug Hardie wrote:
</I>&gt;<i>
</I>&gt;&gt;<i> When using client certificates, how does SSL_accept validate the
</I>&gt;&gt;<i> provided certificate?
</I>&gt;<i>
</I>&gt;<i> By building a certificate chain to a local trust-anchor using the
</I>&gt;<i> server's configured trust store, and any untrusted intermediate
</I>&gt;<i> certificates presented by the remote client.
</I>&gt;<i>
</I>&gt;<i> Note that verification of client certificates DOES NOT typically include
</I>&gt;<i> any &quot;identity&quot; checks, rather only the trustworthiness of the chain is
</I>&gt;<i> verified.  It is up to the server application to perform access control
</I>&gt;<i> on the requested resources based on whatever information the server
</I>&gt;<i> independently gleams from the certificate during or after the TLS
</I>&gt;<i> handshake.
</I>&gt;<i>
</I>&gt;&gt;<i> If verify_callback is used, is the client certificate validated before
</I>&gt;&gt;<i> the callback is called?
</I>&gt;<i>
</I>&gt;<i> No, if all goes well, the callbacks (one per chain certificate) are
</I>&gt;<i> made *as part of* validation, with the &quot;ok&quot; parameter set to &quot;1&quot; if
</I>&gt;<i> there's no (new?) problem to report at the level in question.
</I>&gt;<i>
</I>&gt;<i> If the callback returns a non-zero value, the handshake continues, if
</I>&gt;<i> zero it is aborted.  A callback that is purely diagnostic should return
</I>&gt;<i> the input &quot;ok&quot; value.  If the callback wants to either abort an
</I>&gt;<i> otherwise &quot;ok&quot; handshake, or ignore a particular problem, it can return
</I>&gt;<i> 1 under appropriate conditions even if &quot;ok&quot; was zero.
</I>&gt;<i>
</I>&gt;<i> Note that returning &quot;ok&quot; equal to one does not reset the verification
</I>&gt;<i> status for the chain, which can be tested, for e.g. success, via:
</I>&gt;<i>
</I>&gt;<i>   SSL_get_verify_result(ssl) == X509_V_OK
</I>&gt;<i>
</I>&gt;<i> this works even on resumption, because the original validation status is
</I>&gt;<i> part of the saved/resumed session.
</I>&gt;<i>
</I>&gt;<i> The callback can (with great care to not ignore any important error
</I>&gt;<i> conditions) reset the validation result for less critical conditions,
</I>&gt;<i> but then it is necessary to either abort the handshake on the import
</I>&gt;<i> conditions, or save away state that an earlier problem was not
</I>&gt;<i> ignorable, and reset the error to that, rather than to X509_V_OK.
</I>&gt;<i>
</I>&gt;<i> See X509_STORE_CTX_set_error(3), but tread cautiously, there be dragons.
</I>
Thanks for that explanation.  That would probably be helpful to others if it was included somewhere in the openssl documentation.

&gt;<i>
</I>&gt;<i> On Tue, Apr 09, 2024 at 08:43:39AM -0700, Doug Hardie wrote:
</I>&gt;<i>
</I>&gt;&gt;<i> The server requires client certificates.  If I use
</I>&gt;&gt;<i> openssl s_client and give it the proper certificate, I see one
</I>&gt;&gt;<i> connection that makes the request and returns the response.
</I>&gt;<i>
</I>&gt;<i> The &quot;s_client&quot; application is liberal in what it accepts:
</I>&gt;<i>
</I>&gt;<i>   - Without non-default options, the handshake completes (with some
</I>&gt;<i>     addtional noise) even if the server certificate fails to verufy.
</I>&gt;<i>
</I>&gt;<i>   - It presents the specified client certificate even if the server
</I>&gt;<i>     does not solicit its issuer CA (or ultimate trust anchor) in its
</I>&gt;<i>     certificate request message, which lists the acceptable CAs.
</I>&gt;<i>
</I>&gt;<i>   - There may of course be subtle differences in various extensions
</I>&gt;<i>     used, the SNI extension may be important, the others typically
</I>&gt;<i>     less so.
</I>&gt;<i>
</I>&gt;<i>   - Your s_client may be dated, and the issue may only manifest with
</I>&gt;<i>     bleeding edge client capabilities, though again your s_client is
</I>&gt;<i>     likely not that old (1.1.1, supports TLS 1.3) and you rarely need
</I>&gt;<i>     more.
</I>&gt;<i>
</I>&gt;<i> Speculatively, the second item is the most likely source of issues.
</I>
It should be a fairly new s_client.  The client I used for that testing, and for the server is FreeBSD 14.0.


&gt;<i>
</I>&gt;<i>
</I>&gt;&gt;<i> However, if I use one of the various clients to make the same request,
</I>&gt;&gt;<i> the results are quite different.  There are a number of connections
</I>&gt;&gt;<i> made that fail and then finally they make the proper connection and
</I>&gt;&gt;<i> everything works.  The time it takes to get through all of that is
</I>&gt;&gt;<i> quite long - around 5 seconds.  The server is recording the following
</I>&gt;&gt;<i> errors from SSL_accept:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Connection 1 - session id context uninitialized
</I>&gt;&gt;<i> Connection 2 - session id context uninitialized
</I>&gt;&gt;<i> Connection 3 - sslv3 alert certificate unknown
</I>&gt;&gt;<i> Connection 4 - sslv3 alert certificate unknown
</I>&gt;<i>
</I>&gt;<i> Who's sending/receiving the alerts?  The server would typically report
</I>&gt;<i> *received* alerts, and it is then perhaps the client that is failing to
</I>&gt;<i> validate the server certificate, but without a clear context, it is
</I>&gt;<i> difficult to say what happened.
</I>
All of the logging is on the server side.  I don't really have any ability to do anything with the clients.


&gt;<i>
</I>&gt;<i> As for session id contexts, your server code needs to set one in order
</I>&gt;<i> to support resumption properly, one more difference between s_client
</I>&gt;<i> and other clients, is that s_client always starts with no saved
</I>&gt;<i> sessions.
</I>&gt;<i>
</I>&gt;<i> The Postfix SMTP server has:
</I>&gt;<i>
</I>&gt;<i>    /*                                                                                                                                                                           * The session_id_context identifies the service that created a session.                                                                                                     * This information is used to distinguish between multiple TLS-based                                                                                                        * servers running on the same server. We use the name of the mail system.                                                                                                   */                                                                                                                                                                        static const char server_session_id_context[] = &quot;Postfix/TLS&quot;;
</I>&gt;<i>   ...
</I>&gt;<i>   SSL_CTX_set_session_id_context(server_ctx,                                                                                                                                                                 (void *) &amp;server_session_id_context,                                                                                                                                        sizeof(server_session_id_context));
</I>
I'll have to do that then.


&gt;<i>
</I>&gt;&gt;<i> and then Connection 5 sees the proper client certificate, authenticates and produces output.
</I>&gt;<i>
</I>&gt;<i> Perhaps the client is no longer attempting resumption?
</I>&gt;<i>
</I>&gt;&gt;<i> How can I figure out what is causing these multiple connections and
</I>&gt;&gt;<i> the resulting errors.  I have tcpdump and ssldump output but nothing
</I>&gt;&gt;<i> there gives me any ideas.
</I>&gt;<i>
</I>&gt;<i> The ssldump software is abandoned, use &quot;tcpdump&quot; + &quot;&quot;tshark&quot;, as explained in:
</I>&gt;<i>
</I>&gt;<i>    <A HREF="https://urldefense.com/v3/__https://marc.info/?l=postfix-users&amp;m=166005488423800&amp;w=2__;!!FJ-Y8qCqXTj2!Z4_OjCVt2ZxN2QfqMULBlr9PruEFLHmdq-wMr8gkIhKkX19e5-opf4Izyob0knUn_Th1ye1EZNYjAhMs0HPhEkPtiZQYfRg$">https://urldefense.com/v3/__https://marc.info/?l=postfix-users&amp;m=166005488423800&amp;w=2__;!!FJ-Y8qCqXTj2!Z4_OjCVt2ZxN2QfqMULBlr9PruEFLHmdq-wMr8gkIhKkX19e5-opf4Izyob0knUn_Th1ye1EZNYjAhMs0HPhEkPtiZQYfRg$</A>
</I>
Thanks.   I have tdump available but had not figured out how to use it.

&gt;<i>
</I>&gt;<i>
</I>&gt;&gt;<i> I can provide either of those if needed, but they are large.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> With &quot;tcpdump&quot;, after capturing a bunch of traffic, you extract just a
</I>&gt;<i> particular connection of interest, details in the post linked above.
</I>&gt;<i> You can then analyse it with &quot;tshark&quot; (same link).
</I>&gt;<i>
</I>&gt;&gt;<i> Unfortunately I have not figured out how to get ssldump to decode the
</I>&gt;&gt;<i> application data.  As best as I can tell, the negotiated cipher cannot
</I>&gt;&gt;<i> be handled by ssldump.
</I>&gt;<i>
</I>&gt;<i> Delete &quot;ssldump&quot; you're better off without it.
</I>
So I see.  It's going away after I send this.

&gt;<i>
</I>&gt;&gt;<i> The clients each have the same 2 client certificates.  They ask which
</I>&gt;&gt;<i> one to use, but perhaps they are trying both?
</I>&gt;<i>
</I>&gt;<i> A given handshake can only try one client certificate as part of the
</I>&gt;<i> normal handshake.  THere's also post-handshake authenticaiton (PHA) in
</I>&gt;<i> TLS 1.3, but you probably don't have server code for that.
</I>&gt;<i>
</I>&gt;<i> That the clients are putting up a dialogue does strengthen the
</I>&gt;<i> plausibility of the server's client certificate request being part of
</I>&gt;<i> the problem.  You may need to carefully tune your server's list of
</I>&gt;<i> solicited client CAs.  See the docs for SSL_CTX_set_client_CA_list(3).
</I>&gt;<i> Less is more (ideally just one if there's only one CA issuing the
</I>&gt;<i> desired certificates).
</I>
I only have my root certificate in the chain for authentication.  Your last response to me made that point loud and clear.  Thanks.

&gt;<i>
</I>&gt;<i> And finally, but importantly, what exactly is your use case?  How does
</I>&gt;<i> the server expect to benefit from (make access and authorisation
</I>&gt;<i> decisions based on) client certificates?
</I>
The case is an organization that was initially using passwords for authentication.  That worked properly and was easy to setup.  However, in the process of doing that I discovered that all their users had the name of the company as their password.  Given that the loss of the information that needs to be protected would be a very significant financial loss to the company, that approach is really not a good idea.  I proposed the certificate authentication and management agreed.

-- Doug

-------------- next part --------------
A non-text attachment was scrubbed...
Name: ccc
Type: application/octet-stream
Size: 12898 bytes
Desc: not available
URL: &lt;<A HREF="https://urldefense.com/v3/__https://mta.openssl.org/pipermail/openssl-users/attachments/20240409/adbda02f/attachment.obj__;!!FJ-Y8qCqXTj2!Z4_OjCVt2ZxN2QfqMULBlr9PruEFLHmdq-wMr8gkIhKkX19e5-opf4Izyob0knUn_Th1ye1EZNYjAhMs0HPhEkPtGH5WTLg$">https://urldefense.com/v3/__https://mta.openssl.org/pipermail/openssl-users/attachments/20240409/adbda02f/attachment.obj__;!!FJ-Y8qCqXTj2!Z4_OjCVt2ZxN2QfqMULBlr9PruEFLHmdq-wMr8gkIhKkX19e5-opf4Izyob0knUn_Th1ye1EZNYjAhMs0HPhEkPtGH5WTLg$</A>&gt;

------------------------------

Subject: Digest Footer

_______________________________________________
openssl-users mailing list
mailto:<A HREF="../../../mailman/listinfo/openssl-users.html">openssl-users at openssl.org</A>
<A HREF="https://urldefense.com/v3/__https://mta.openssl.org/mailman/listinfo/openssl-users__;!!FJ-Y8qCqXTj2!Z4_OjCVt2ZxN2QfqMULBlr9PruEFLHmdq-wMr8gkIhKkX19e5-opf4Izyob0knUn_Th1ye1EZNYjAhMs0HPhEkPtt7tKjqY$">https://urldefense.com/v3/__https://mta.openssl.org/mailman/listinfo/openssl-users__;!!FJ-Y8qCqXTj2!Z4_OjCVt2ZxN2QfqMULBlr9PruEFLHmdq-wMr8gkIhKkX19e5-opf4Izyob0knUn_Th1ye1EZNYjAhMs0HPhEkPtt7tKjqY$</A>


------------------------------

End of openssl-users Digest, Vol 113, Issue 6
*********************************************
Any email and files/attachments transmitted with it are intended solely for the use of the individual or entity to whom they are addressed. If this message has been sent to you in error, you must not copy, distribute or disclose of the information it contains. Please notify Entrust immediately and delete the message from your system.
</PRE>













<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="017090.html">Questions
</A></li>
	<LI>Next message (by thread): <A HREF="017096.html">OpenSSL 3.3.0 ( and others ) fail testsuite due to IPv6 disabled
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#17094">[ date ]</a>
              <a href="thread.html#17094">[ thread ]</a>
              <a href="subject.html#17094">[ subject ]</a>
              <a href="author.html#17094">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="../../../mailman/listinfo/openssl-users.html">More information about the openssl-users
mailing list</a><br>
</body></html>
