<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> openssl-users Digest, Vol 94, Issue 24
   </TITLE>
   <LINK REL="Index" HREF="https://mta.openssl.org/pipermail/openssl-users/2022-September/index.html" >
   <LINK REL="made" HREF="mailto:openssl-users%40openssl.org?Subject=Re%3A%20openssl-users%20Digest%2C%20Vol%2094%2C%20Issue%2024&In-Reply-To=%3CPU4P216MB1321AD75B8DFDB33438C690D9A4C9%40PU4P216MB1321.KORP216.PROD.OUTLOOK.COM%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="015414.html">
   <LINK REL="Next"  HREF="015430.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>openssl-users Digest, Vol 94, Issue 24</H1>
    <B>A Z</B> 
    <A HREF="mailto:openssl-users%40openssl.org?Subject=Re%3A%20openssl-users%20Digest%2C%20Vol%2094%2C%20Issue%2024&In-Reply-To=%3CPU4P216MB1321AD75B8DFDB33438C690D9A4C9%40PU4P216MB1321.KORP216.PROD.OUTLOOK.COM%3E"
       TITLE="openssl-users Digest, Vol 94, Issue 24">poweruserm at live.com.au
       </A><BR>
    <I>Tue Sep 20 09:30:25 UTC 2022</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="015414.html">Need Help to check DH_generate_key() functionality
</A></li>
        <LI>Next message (by thread): <A HREF="015430.html">openssl req not working, error is &quot;req: Use -help for summary.&quot;
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#15428">[ date ]</a>
              <a href="thread.html#15428">[ thread ]</a>
              <a href="subject.html#15428">[ subject ]</a>
              <a href="author.html#15428">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Dear OpenSSL Users and Programmers,

I tried running the following command in Windows 64 bit Home edition,
and got the error:

&gt;<i>openssl req -nodes -newkey rsa:4096 -keyout pkey.pem -x509 -out cert.pem -days 36500 -subj -addext &quot;subjectKeyIdentifier=hash&quot;
</I>
req: Use -help for summary.

&gt;<i>openssl version
</I>
OpenSSL 3.0.0 7 sep 2021 (Library: OpenSSL 3.0.0 7 sep 2021)

In the email bundle reply, this line is suggested to generate a private key and a PEM certificate.  How can I get this to run on
the Windows 10 64 bit, even when in Administrator mode?

Sergio Minervini.

________________________________
From: openssl-users &lt;<A HREF="../../../mailman/listinfo/openssl-users.html">openssl-users-bounces at openssl.org</A>&gt; on behalf of <A HREF="../../../mailman/listinfo/openssl-users.html">openssl-users-request at openssl.org</A> &lt;<A HREF="../../../mailman/listinfo/openssl-users.html">openssl-users-request at openssl.org</A>&gt;
Sent: Monday, 19 September 2022 10:00 PM
To: <A HREF="../../../mailman/listinfo/openssl-users.html">openssl-users at openssl.org</A> &lt;<A HREF="../../../mailman/listinfo/openssl-users.html">openssl-users at openssl.org</A>&gt;
Subject: openssl-users Digest, Vol 94, Issue 24

Send openssl-users mailing list submissions to
        <A HREF="../../../mailman/listinfo/openssl-users.html">openssl-users at openssl.org</A>

To subscribe or unsubscribe via the World Wide Web, visit
        <A HREF="../../../mailman/listinfo/openssl-users.html">https://mta.openssl.org/mailman/listinfo/openssl-users</A>
or, via email, send a message with subject or body 'help' to
        <A HREF="../../../mailman/listinfo/openssl-users.html">openssl-users-request at openssl.org</A>

You can reach the person managing the list at
        <A HREF="../../../mailman/listinfo/openssl-users.html">openssl-users-owner at openssl.org</A>

When replying, please edit your Subject line so it is more specific
than &quot;Re: Contents of openssl-users digest...&quot;


Today's Topics:

   1. RE: Best Practices for private key files handling (Michael Wojcik)
   2. Problem with Asymetric, two-key encryption and Certificate
      Requests. (A Z)
   3. Re: Problem with Asymetric, two-key encryption and
      Certificate Requests. (Viktor Dukhovni)


----------------------------------------------------------------------

Message: 1
Date: Sun, 18 Sep 2022 15:06:14 +0000
From: Michael Wojcik &lt;<A HREF="../../../mailman/listinfo/openssl-users.html">Michael.Wojcik at microfocus.com</A>&gt;
To: &quot;<A HREF="../../../mailman/listinfo/openssl-users.html">openssl-users at openssl.org</A>&quot; &lt;<A HREF="../../../mailman/listinfo/openssl-users.html">openssl-users at openssl.org</A>&gt;
Subject: RE: Best Practices for private key files handling
Message-ID:
        &lt;<A HREF="../../../mailman/listinfo/openssl-users.html">DM6PR18MB270078332F7CA93F5EADD7EAF94A9 at DM6PR18MB2700.namprd18.prod.outlook.com</A>&gt;

Content-Type: text/plain; charset=&quot;utf-8&quot;

&gt;<i> From: openssl-users &lt;<A HREF="../../../mailman/listinfo/openssl-users.html">openssl-users-bounces at openssl.org</A>&gt; On Behalf Of Michael
</I>&gt;<i> Str?der via openssl-users
</I>&gt;<i> Sent: Sunday, 18 September, 2022 04:27
</I>&gt;<i>
</I>&gt;<i> On 9/18/22 06:09, Philip Prindeville wrote:
</I>&gt;<i> &gt;&gt; On Sep 15, 2022, at 4:27 PM, Michael Wojcik via openssl-users &lt;openssl-
</I>&gt;<i> <A HREF="../../../mailman/listinfo/openssl-users.html">users at openssl.org</A>&gt; wrote:
</I>&gt;<i> &gt;&gt; You still haven't explained your threat model, or what mitigation
</I>&gt;<i> &gt;&gt; the application can take if this requirement is violated, or why
</I>&gt;<i> &gt;&gt; you think this is a &quot;best practice&quot;.
</I>&gt;<i>
</I>&gt;<i> &gt; The threat model is impersonation, where the legitimate key has been
</I>&gt;<i> &gt; replaced by someone else's key, and the ensuing communication is
</I>&gt;<i> &gt; neither authentic nor private.
</I>&gt;<i>
</I>&gt;<i> Maybe I'm ignorant but shouldn't this be prevented by ensuring the
</I>&gt;<i> authenticity and correct identity mapping of the public key?
</I>
Exactly. In most protocols the public key, not the private key, authenticates the peer.

Relying on file system metadata (!) as the root of trust for authentication, particularly for an application that may be running with elevated privileges (!!), seems a marvelously poor design.

&gt;<i> &gt; Otherwise, the owners of the system can't claim non-repudiation as to
</I>&gt;<i> &gt; the genuine provenance of communication.
</I>
I'm with Peter Gutmann on this. Non-repudiation is essentially meaningless for the vast majority of applications. But in any case, filesystem metadata is a poor foundation for it.

&gt;<i> More information is needed about how you're system is working to comment
</I>&gt;<i> on this.
</I>
Indeed. This is far from clear here.


--
Michael Wojcik

------------------------------

Message: 2
Date: Mon, 19 Sep 2022 01:32:40 +0000
From: A Z &lt;<A HREF="../../../mailman/listinfo/openssl-users.html">poweruserm at live.com.au</A>&gt;
To: &quot;<A HREF="../../../mailman/listinfo/openssl-users.html">openssl-users at openssl.org</A>&quot; &lt;<A HREF="../../../mailman/listinfo/openssl-users.html">openssl-users at openssl.org</A>&gt;
Subject: Problem with Asymetric, two-key encryption and Certificate
        Requests.
Message-ID:
        &lt;<A HREF="../../../mailman/listinfo/openssl-users.html">PU4P216MB1321AE67E6D7FBDA72BDFB859A4D9 at PU4P216MB1321.KORP216.PROD.OUTLOOK.COM</A>&gt;

Content-Type: text/plain; charset=&quot;iso-8859-1&quot;

A#) openssl req -x509 -nodes -newkey rsa:4096 -keyout private.key -out public.key

B#) openssl smime -encrypt -binary -aes-256-cbc -in message.txt -out encrypted.dat -outform DER public.key

C#) openssl smime -decrypt -in encrypted.dat -binary -inform DEM -inkey private.key -out decrypted.txt

How can I complete step A#), so that step B#)  will work, without involving a Certificate Request, which requires
a non-blank two digit nation code,

'You can set an empty issuer/subject DN, or use &quot;-keyid&quot; to avoid copying
these into the CMS message.'

Can someone please update my included A#), B#) or C#) instructions, included above here, to acheive
this suggestion, so that no certificate information is put into 'encrypted.dat', including the nation,
so that 'encrypted.dat' includes no plain text whatsoever, and so that A#) + B#) + C#) all work
as desired, for small, medium and large files, of 'message.txt'?  I am struggling to correct what I
have done so far, so that there are no errors, and so that all the steps work: (generation of a private and public key,
encryption of the file, and decrypt of the file).  ?
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="https://mta.openssl.org/pipermail/openssl-users/attachments/20220919/7e144f00/attachment-0001.htm">https://mta.openssl.org/pipermail/openssl-users/attachments/20220919/7e144f00/attachment-0001.htm</A>&gt;

------------------------------

Message: 3
Date: Sun, 18 Sep 2022 23:16:29 -0400
From: Viktor Dukhovni &lt;<A HREF="../../../mailman/listinfo/openssl-users.html">openssl-users at dukhovni.org</A>&gt;
To: <A HREF="../../../mailman/listinfo/openssl-users.html">openssl-users at openssl.org</A>
Subject: Re: Problem with Asymetric, two-key encryption and
        Certificate Requests.
Message-ID: &lt;<A HREF="../../../mailman/listinfo/openssl-users.html">YyffDSRHabZt1ISd at straasha.imrryr.org</A>&gt;
Content-Type: text/plain; charset=us-ascii

On Mon, Sep 19, 2022 at 01:32:40AM +0000, A Z wrote:

&gt;<i> A#) openssl req -x509 -nodes -newkey rsa:4096 -keyout private.key -out public.key
</I>&gt;<i>
</I>&gt;<i> B#) openssl smime -encrypt -binary -aes-256-cbc -in message.txt -out encrypted.dat -outform DER public.key
</I>&gt;<i>
</I>&gt;<i> C#) openssl smime -decrypt -in encrypted.dat -binary -inform DEM -inkey private.key -out decrypted.txt
</I>&gt;<i>
</I>&gt;<i> How can I complete step A#), so that step B#)  will work, without
</I>&gt;<i> involving a Certificate Request, which requires a non-blank two digit
</I>&gt;<i> nation code,
</I>&gt;<i>
</I>&gt;<i> 'You can set an empty issuer/subject DN, or use &quot;-keyid&quot; to avoid
</I>&gt;<i> copying these into the CMS message.'
</I>&gt;<i>
</I>&gt;<i> Can someone please update my included A#), B#) or C#) instructions,
</I>&gt;<i> included above here, to acheive this suggestion, so that no
</I>&gt;<i> certificate information is put into 'encrypted.dat', including the
</I>&gt;<i> nation, so that 'encrypted.dat' includes no plain text whatsoever, and
</I>&gt;<i> so that A#) + B#) + C#) all work as desired, for small, medium and
</I>&gt;<i> large files, of 'message.txt'?  I am struggling to correct what I have
</I>&gt;<i> done so far, so that there are no errors, and so that all the steps
</I>&gt;<i> work: (generation of a private and public key, encryption of the file,
</I>&gt;<i> and decrypt of the file).  ?
</I>
1.  Generate the self-signed certificate using a configuration that
    sets a subject key id.
2.  Also set an empty subject name via &quot;-subj /&quot;.  The example also
    sets a 100 year expiration time.

    $ openssl req \
        -nodes -newkey rsa:4096 -keyout pkey.pem \
        -x509 -out cert.pem \
        -days 36500 -subj / \
        -addext &quot;subjectKeyIdentifier=hash&quot;

3.  Use &quot;openssl cms&quot; insteadm of &quot;openssl smime&quot;, and set the &quot;-keyid&quot;
    option when encrypting.

    $ openssl cms -keyid -encrypt -binary -aes-256-cbc \
        -in /some/file -out /some/file.cms -outform DER \
        -recip cert.pem

    [ There appears to be a bug in the implementation of the
      &quot;-keyid&quot; option in OpenSSL 1.1.1.  It works with OpenSSL
      3.0.5. ]

!!!! You're not *signing* the content.  It is trivially spoofed, because
     unless the public certificate is also kept secret, anyone can
     encrypt a substitute file, and decryption will later succeed. !!!!

     Instead of worrying about insignificant plaintext metadata, you
     should be worrying about data integrity, and related actually
     relevant issues, some noted below.

4.  Again use &quot;openssl cms&quot; to decrypt.

    $ openssl cms -decrypt -in /some/file.cms -binary -inform DER \
        -inkey pkey.pem -out /some/file.dat

    [ But see above, you have zero guarantee that the file has not
      been tampered with by some with access to the non-secret public
      key. ]

It is rather puzzling why it would be a problem to set some correct or
bogus 2-letter country code.  It in no way compromises the security of
the data.  That said, you can avoid this if it really bugs you.

As to the goal of encrypting &quot;large files&quot;, note that neither CMS, nor
SMIME are particularly well suited in that regard.  Decryption of CMS
messages brings the entire encrypted object into memory, this does not
scale well for &quot;large files&quot;.

For large file encryption you'd ideally want to break the file into
chunks (say 4MB each), separately encrypt and MAC (HMAC is harder to
misuse than AEAD) each block's sequence number and data under a
symmetric key.

Then separately encrypt (and sign!) a data structure with any relevant
file metadata and symmetric key with CMS.  (The metadata should
typically include the file name, modification time, ... so that
malicious substitution of some other file is later easier to detect).

A final &lt; 4MB length block would signal the end of the file.

Decryption needs to verify the signature, decrypt the metadata, recover
the symmetric key, and then decrypt all or some of the blocks, verifying
the sequence numbers, and (if recovering the whole file) that the last
block (possibly empty) is shorter than the chunk size.

Decryption can then proceed one block at a time, with each block
verified independently without having to buffer the entire file.

A proper encrypted backup design requires more care than just naive use
of CMS (or its precursor S/MIME).  You're fixating on entirely the wrong
set of issues.

--
    Viktor.


------------------------------

Subject: Digest Footer

_______________________________________________
openssl-users mailing list
<A HREF="../../../mailman/listinfo/openssl-users.html">openssl-users at openssl.org</A>
<A HREF="../../../mailman/listinfo/openssl-users.html">https://mta.openssl.org/mailman/listinfo/openssl-users</A>


------------------------------

End of openssl-users Digest, Vol 94, Issue 24
*********************************************
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="https://mta.openssl.org/pipermail/openssl-users/attachments/20220920/9d938931/attachment-0001.htm">https://mta.openssl.org/pipermail/openssl-users/attachments/20220920/9d938931/attachment-0001.htm</A>&gt;
</PRE>











<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="015414.html">Need Help to check DH_generate_key() functionality
</A></li>
	<LI>Next message (by thread): <A HREF="015430.html">openssl req not working, error is &quot;req: Use -help for summary.&quot;
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#15428">[ date ]</a>
              <a href="thread.html#15428">[ thread ]</a>
              <a href="subject.html#15428">[ subject ]</a>
              <a href="author.html#15428">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="../../../mailman/listinfo/openssl-users.html">More information about the openssl-users
mailing list</a><br>
</body></html>
