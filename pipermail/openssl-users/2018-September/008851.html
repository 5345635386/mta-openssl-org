<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [openssl-users] Softhsm + engine_pkcs11 + openssl with EC keys fail.
   </TITLE>
   <LINK REL="Index" HREF="https://mta.openssl.org/pipermail/openssl-users/2018-September/index.html" >
   <LINK REL="made" HREF="mailto:openssl-users%40openssl.org?Subject=Re%3A%20%5Bopenssl-users%5D%20Softhsm%20%2B%20engine_pkcs11%20%2B%20openssl%20with%20EC%20keys%0A%20fail.&In-Reply-To=%3C6979011E-FFA2-49D6-AD5A-6706BBF42D50%40ll.mit.edu%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="008850.html">
   <LINK REL="Next"  HREF="008857.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[openssl-users] Softhsm + engine_pkcs11 + openssl with EC keys fail.</H1>
    <B>Blumenthal, Uri - 0553 - MITLL</B> 
    <A HREF="mailto:openssl-users%40openssl.org?Subject=Re%3A%20%5Bopenssl-users%5D%20Softhsm%20%2B%20engine_pkcs11%20%2B%20openssl%20with%20EC%20keys%0A%20fail.&In-Reply-To=%3C6979011E-FFA2-49D6-AD5A-6706BBF42D50%40ll.mit.edu%3E"
       TITLE="[openssl-users] Softhsm + engine_pkcs11 + openssl with EC keys fail.">uri at ll.mit.edu
       </A><BR>
    <I>Fri Sep 21 12:07:03 UTC 2018</I>
    <P><UL>
        <LI>Previous message: <A HREF="008850.html">[openssl-users] Softhsm + engine_pkcs11 + openssl with EC keys fail.
</A></li>
        <LI>Next message: <A HREF="008857.html">[openssl-users] Softhsm + engine_pkcs11 + openssl with EC keys fail.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#8851">[ date ]</a>
              <a href="thread.html#8851">[ thread ]</a>
              <a href="subject.html#8851">[ subject ]</a>
              <a href="author.html#8851">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Note that the key to reproducing this issue is compiling SoftHSMv2 with 1.1.1.  When compiled with 1.0.2p, everything else can be compiled against 1.1.1 and it works ok.

Regards,
Uri

Sent from my iPhone

&gt;<i> On Sep 21, 2018, at 02:09, Paras Shah (parashah) via openssl-users &lt;<A HREF="../../../mailman/listinfo/openssl-users.html">openssl-users at openssl.org</A>&gt; wrote:
</I>&gt;<i> 
</I>&gt;<i> I opened the issue <A HREF="https://github.com/openssl/openssl/issues/7258">https://github.com/openssl/openssl/issues/7258</A>
</I>&gt;<i> Also, opened issue <A HREF="https://github.com/OpenSC/libp11/issues/249">https://github.com/OpenSC/libp11/issues/249</A>
</I>&gt;<i> and <A HREF="https://github.com/opendnssec/SoftHSMv2/issues/417">https://github.com/opendnssec/SoftHSMv2/issues/417</A>
</I>&gt;<i>  
</I>&gt;<i> Found the root cause to be the openssl version 1.1.1 that was used to compile the engine_pkcs11 and SoftHSM.
</I>&gt;<i> When I recompiled with openssl-1.0.2p, it worked fine. See <A HREF="https://github.com/OpenSC/libp11/issues/249">https://github.com/OpenSC/libp11/issues/249</A> for details.
</I>&gt;<i>  
</I>&gt;<i> From: &quot;Paras Shah (parashah)&quot; &lt;<A HREF="../../../mailman/listinfo/openssl-users.html">parashah at cisco.com</A>&gt;
</I>&gt;<i> Date: Tuesday, September 18, 2018 at 10:06 AM
</I>&gt;<i> To: Nicola &lt;<A HREF="../../../mailman/listinfo/openssl-users.html">nic.tuv at gmail.com</A>&gt;, &quot;<A HREF="../../../mailman/listinfo/openssl-users.html">openssl-users at openssl.org</A>&quot; &lt;<A HREF="../../../mailman/listinfo/openssl-users.html">openssl-users at openssl.org</A>&gt;
</I>&gt;<i> Subject: Re: [openssl-users] Softhsm + engine_pkcs11 + openssl with EC keys fail.
</I>&gt;<i>  
</I>&gt;<i> Sure. I will open the issue.
</I>&gt;<i>  
</I>&gt;<i> From: Nicola &lt;<A HREF="../../../mailman/listinfo/openssl-users.html">nic.tuv at gmail.com</A>&gt;
</I>&gt;<i> Date: Monday, September 17, 2018 at 10:05 PM
</I>&gt;<i> To: &quot;Paras Shah (parashah)&quot; &lt;<A HREF="../../../mailman/listinfo/openssl-users.html">parashah at cisco.com</A>&gt;, &quot;<A HREF="../../../mailman/listinfo/openssl-users.html">openssl-users at openssl.org</A>&quot; &lt;<A HREF="../../../mailman/listinfo/openssl-users.html">openssl-users at openssl.org</A>&gt;
</I>&gt;<i> Subject: Re: [openssl-users] Softhsm + engine_pkcs11 + openssl with EC keys fail.
</I>&gt;<i>  
</I>&gt;<i> Would it be possible for you to open this as an issue on Github and include there your first email and the full logs?
</I>&gt;<i>  
</I>&gt;<i> Thanks,
</I>&gt;<i>  
</I>&gt;<i> Nicola Tuveri
</I>&gt;<i>  
</I>&gt;<i> On Tue, 18 Sep 2018 at 01:15, Paras Shah (parashah) via openssl-users &lt;<A HREF="../../../mailman/listinfo/openssl-users.html">openssl-users at openssl.org</A>&gt; wrote:
</I>&gt;<i> That is not it. It results in the same error for the EC key.
</I>&gt;<i> 
</I>&gt;<i>  
</I>&gt;<i> 
</I>&gt;<i> It is not the URL or the ID. Because for a RSA key in the softhsm with id = 3333, it works fine with url containing id=%33%33
</I>&gt;<i> 
</I>&gt;<i>  
</I>&gt;<i> 
</I>&gt;<i> $ openssl pkey -in &quot;pkcs11:model=SoftHSM%20v2;manufacturer=SoftHSM%20project;serial=6a160d52b750862f;token=token%202.5.0-rc1;id=%33%33;object=rsa%20key;type=private&quot; -engine pkcs11 -inform ENGINE
</I>&gt;<i> 
</I>&gt;<i> engine &quot;pkcs11&quot; set.
</I>&gt;<i> 
</I>&gt;<i> Enter PKCS#11 token PIN for token 2.5.0-rc1:
</I>&gt;<i> 
</I>&gt;<i> -----BEGIN PRIVATE KEY-----
</I>&gt;<i> 
</I>&gt;<i> MIIBJwIBADANBgkqhkiG9w0BAQEFAASCAREwggENAgEAAoIBAQDD3378F1XbXJvP
</I>&gt;<i> 
</I>&gt;<i> WP2GtZry0u6sL3eNYktQwJfhDMz5evDG+PahVjCMszV5CZvG+Kvap40xPBJoonqi
</I>&gt;<i> 
</I>&gt;<i> oMAQsoLu7/fTx82aEL3TbdjXNLFnQ2KKYmfG9ymx80sLHMmdmDXpNNE+bEKJz1dp
</I>&gt;<i> 
</I>&gt;<i> t1Q0cVduwmqSfB8JyIE6Udz7JX7HCXaVmxoK7z4Njh3dyHsqhdqKIx0dBuK0hCaq
</I>&gt;<i> 
</I>&gt;<i> 4zPzGP/sORA3G9ZPxxpEvF3gvE/zsXj7ifihqbqr2eIFOpB/lQqAehsgQT5/6Iq+
</I>&gt;<i> 
</I>&gt;<i> 9pAX2LCxNkaUHYYZpMkM8Oi37jzg8PX/FnHdm9HQU2IBqYhoqo7/VsNdUDln2QHN
</I>&gt;<i> 
</I>&gt;<i> dGAUprcbAgMBAAE=
</I>&gt;<i> 
</I>&gt;<i> -----END PRIVATE KEY-----
</I>&gt;<i> 
</I>&gt;<i>  
</I>&gt;<i> 
</I>&gt;<i> Coming back to EC key, looking at the error logs emitted, it does seem to recognize it to be EC (the logs contain EC_routines) somehow but then fails.
</I>&gt;<i> 
</I>&gt;<i>  
</I>&gt;<i> 
</I>&gt;<i> On 9/17/18, 2:22 PM, &quot;openssl-users on behalf of Richard Levitte&quot; &lt;<A HREF="../../../mailman/listinfo/openssl-users.html">openssl-users-bounces at openssl.org</A> on behalf of <A HREF="../../../mailman/listinfo/openssl-users.html">levitte at openssl.org</A>&gt; wrote:
</I>&gt;<i> 
</I>&gt;<i>  
</I>&gt;<i> 
</I>&gt;<i>     In message &lt;<A HREF="../../../mailman/listinfo/openssl-users.html">4AC69FC3-BEC7-46F6-882A-671196FC0156 at contoso.com</A>&gt; on Mon, 17 Sep 2018 20:59:59 +0000, &quot;Paras Shah (parashah)&quot; &lt;<A HREF="../../../mailman/listinfo/openssl-users.html">parashah at cisco.com</A>&gt; said:
</I>&gt;<i> 
</I>&gt;<i>    
</I>&gt;<i> 
</I>&gt;<i>     &gt; 4. Import the key into softhsm
</I>&gt;<i> 
</I>&gt;<i>     &gt;
</I>&gt;<i> 
</I>&gt;<i>     &gt; []:~$ softhsm2-util --import ~/tmp/secp256k1-key.pem.pkcs8 --label &quot;ec key&quot; --id 1111 --token
</I>&gt;<i> 
</I>&gt;<i>     &gt; &quot;token 2.5.0-rc1&quot;
</I>&gt;<i> 
</I>&gt;<i>    
</I>&gt;<i> 
</I>&gt;<i>     Ok, so here, the ID is &quot;1111&quot;
</I>&gt;<i> 
</I>&gt;<i>    
</I>&gt;<i> 
</I>&gt;<i>     &gt; 5. Get the pkcs11 url for the private key
</I>&gt;<i> 
</I>&gt;<i>     &gt;
</I>&gt;<i> 
</I>&gt;<i>     &gt; []:~$ p11tool --login --provider=/usr/local/lib/softhsm/libsofthsm2.so --set-pin=1111 --list-all
</I>&gt;<i> 
</I>&gt;<i>     &gt;
</I>&gt;<i> 
</I>&gt;<i>     &gt; Object 0:
</I>&gt;<i> 
</I>&gt;<i>     &gt;
</I>&gt;<i> 
</I>&gt;<i>     &gt; URL:
</I>&gt;<i> 
</I>&gt;<i>     &gt; pkcs11:model=SoftHSM%20v2;manufacturer=SoftHSM%20project;serial=6a160d52b750862f;token=token%202.5.0-rc1;id=%11%11;object=ec%20key;type=private
</I>&gt;<i> 
</I>&gt;<i>    
</I>&gt;<i> 
</I>&gt;<i>     But here, the ID is &quot;%11%11&quot;, and since those get percent decoded,
</I>&gt;<i> 
</I>&gt;<i>     that's actually two vertical tabs, or with C vector syntax,
</I>&gt;<i> 
</I>&gt;<i>     { 0x0b, 0x0b }
</I>&gt;<i> 
</I>&gt;<i>    
</I>&gt;<i> 
</I>&gt;<i>     I'm not sure what engine-pkcs11 asks of you otherwise, but one guess
</I>&gt;<i> 
</I>&gt;<i>     could be to change 'id=%11%11' to 'id=1111' in that URL and try again.
</I>&gt;<i> 
</I>&gt;<i>    
</I>&gt;<i> 
</I>&gt;<i>     Cheers,
</I>&gt;<i> 
</I>&gt;<i>     Richard
</I>&gt;<i> 
</I>&gt;<i>    
</I>&gt;<i> 
</I>&gt;<i>     --
</I>&gt;<i> 
</I>&gt;<i>     Richard Levitte         <A HREF="../../../mailman/listinfo/openssl-users.html">levitte at openssl.org</A>
</I>&gt;<i> 
</I>&gt;<i>     OpenSSL Project         <A HREF="http://www.openssl.org/~levitte/">http://www.openssl.org/~levitte/</A>
</I>&gt;<i> 
</I>&gt;<i>     --
</I>&gt;<i> 
</I>&gt;<i>     openssl-users mailing list
</I>&gt;<i> 
</I>&gt;<i>     To unsubscribe: <A HREF="../../../mailman/listinfo/openssl-users.html">https://mta.openssl.org/mailman/listinfo/openssl-users</A>
</I>&gt;<i> 
</I>&gt;<i>    
</I>&gt;<i> 
</I>&gt;<i> -- 
</I>&gt;<i> openssl-users mailing list
</I>&gt;<i> To unsubscribe: <A HREF="../../../mailman/listinfo/openssl-users.html">https://mta.openssl.org/mailman/listinfo/openssl-users</A>
</I>&gt;<i> -- 
</I>&gt;<i> openssl-users mailing list
</I>&gt;<i> To unsubscribe: <A HREF="../../../mailman/listinfo/openssl-users.html">https://mta.openssl.org/mailman/listinfo/openssl-users</A>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://mta.openssl.org/pipermail/openssl-users/attachments/20180921/e51ae8be/attachment.html">http://mta.openssl.org/pipermail/openssl-users/attachments/20180921/e51ae8be/attachment.html</A>&gt;
-------------- next part --------------
A non-text attachment was scrubbed...
Name: smime.p7s
Type: application/pkcs7-signature
Size: 5801 bytes
Desc: not available
URL: &lt;<A HREF="http://mta.openssl.org/pipermail/openssl-users/attachments/20180921/e51ae8be/attachment.bin">http://mta.openssl.org/pipermail/openssl-users/attachments/20180921/e51ae8be/attachment.bin</A>&gt;
</PRE>



<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="008850.html">[openssl-users] Softhsm + engine_pkcs11 + openssl with EC keys fail.
</A></li>
	<LI>Next message: <A HREF="008857.html">[openssl-users] Softhsm + engine_pkcs11 + openssl with EC keys fail.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#8851">[ date ]</a>
              <a href="thread.html#8851">[ thread ]</a>
              <a href="subject.html#8851">[ subject ]</a>
              <a href="author.html#8851">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="../../../mailman/listinfo/openssl-users.html">More information about the openssl-users
mailing list</a><br>
</body></html>
