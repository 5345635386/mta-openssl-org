<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [openssl-users] Softhsm + engine_pkcs11 + openssl with EC keys fail.
   </TITLE>
   <LINK REL="Index" HREF="https://mta.openssl.org/pipermail/openssl-users/2018-September/index.html" >
   <LINK REL="made" HREF="mailto:openssl-users%40openssl.org?Subject=Re%3A%20%5Bopenssl-users%5D%20Softhsm%20%2B%20engine_pkcs11%20%2B%20openssl%20with%20EC%20keys%0A%20fail.&In-Reply-To=%3CDD250EF8-C5A3-4DA6-B862-9FFE88432CBD%40cisco.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="008830.html">
   <LINK REL="Next"  HREF="008851.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[openssl-users] Softhsm + engine_pkcs11 + openssl with EC keys fail.</H1>
    <B>Paras Shah (parashah)</B> 
    <A HREF="mailto:openssl-users%40openssl.org?Subject=Re%3A%20%5Bopenssl-users%5D%20Softhsm%20%2B%20engine_pkcs11%20%2B%20openssl%20with%20EC%20keys%0A%20fail.&In-Reply-To=%3CDD250EF8-C5A3-4DA6-B862-9FFE88432CBD%40cisco.com%3E"
       TITLE="[openssl-users] Softhsm + engine_pkcs11 + openssl with EC keys fail.">parashah at cisco.com
       </A><BR>
    <I>Fri Sep 21 06:08:20 UTC 2018</I>
    <P><UL>
        <LI>Previous message: <A HREF="008830.html">[openssl-users] Softhsm + engine_pkcs11 + openssl with EC keys fail.
</A></li>
        <LI>Next message: <A HREF="008851.html">[openssl-users] Softhsm + engine_pkcs11 + openssl with EC keys fail.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#8850">[ date ]</a>
              <a href="thread.html#8850">[ thread ]</a>
              <a href="subject.html#8850">[ subject ]</a>
              <a href="author.html#8850">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>I opened the issue <A HREF="https://github.com/openssl/openssl/issues/7258">https://github.com/openssl/openssl/issues/7258</A>
Also, opened issue <A HREF="https://github.com/OpenSC/libp11/issues/249">https://github.com/OpenSC/libp11/issues/249</A>
and <A HREF="https://github.com/opendnssec/SoftHSMv2/issues/417">https://github.com/opendnssec/SoftHSMv2/issues/417</A>

Found the root cause to be the openssl version 1.1.1 that was used to compile the engine_pkcs11 and SoftHSM.
When I recompiled with openssl-1.0.2p, it worked fine. See <A HREF="https://github.com/OpenSC/libp11/issues/249">https://github.com/OpenSC/libp11/issues/249</A> for details.

From: &quot;Paras Shah (parashah)&quot; &lt;<A HREF="../../../mailman/listinfo/openssl-users.html">parashah at cisco.com</A>&gt;
Date: Tuesday, September 18, 2018 at 10:06 AM
To: Nicola &lt;<A HREF="../../../mailman/listinfo/openssl-users.html">nic.tuv at gmail.com</A>&gt;, &quot;<A HREF="../../../mailman/listinfo/openssl-users.html">openssl-users at openssl.org</A>&quot; &lt;<A HREF="../../../mailman/listinfo/openssl-users.html">openssl-users at openssl.org</A>&gt;
Subject: Re: [openssl-users] Softhsm + engine_pkcs11 + openssl with EC keys fail.

Sure. I will open the issue.

From: Nicola &lt;<A HREF="../../../mailman/listinfo/openssl-users.html">nic.tuv at gmail.com</A>&gt;
Date: Monday, September 17, 2018 at 10:05 PM
To: &quot;Paras Shah (parashah)&quot; &lt;<A HREF="../../../mailman/listinfo/openssl-users.html">parashah at cisco.com</A>&gt;, &quot;<A HREF="../../../mailman/listinfo/openssl-users.html">openssl-users at openssl.org</A>&quot; &lt;<A HREF="../../../mailman/listinfo/openssl-users.html">openssl-users at openssl.org</A>&gt;
Subject: Re: [openssl-users] Softhsm + engine_pkcs11 + openssl with EC keys fail.

Would it be possible for you to open this as an issue on Github and include there your first email and the full logs?

Thanks,

Nicola Tuveri

On Tue, 18 Sep 2018 at 01:15, Paras Shah (parashah) via openssl-users &lt;<A HREF="../../../mailman/listinfo/openssl-users.html">openssl-users at openssl.org</A>&lt;mailto:<A HREF="../../../mailman/listinfo/openssl-users.html">openssl-users at openssl.org</A>&gt;&gt; wrote:

That is not it. It results in the same error for the EC key.



It is not the URL or the ID. Because for a RSA key in the softhsm with id = 3333, it works fine with url containing id=%33%33



$ openssl pkey -in &quot;pkcs11:model=SoftHSM%20v2;manufacturer=SoftHSM%20project;serial=6a160d52b750862f;token=token%202.5.0-rc1;id=%33%33;object=rsa%20key;type=private&quot; -engine pkcs11 -inform ENGINE

engine &quot;pkcs11&quot; set.

Enter PKCS#11 token PIN for token 2.5.0-rc1:

-----BEGIN PRIVATE KEY-----

MIIBJwIBADANBgkqhkiG9w0BAQEFAASCAREwggENAgEAAoIBAQDD3378F1XbXJvP

WP2GtZry0u6sL3eNYktQwJfhDMz5evDG+PahVjCMszV5CZvG+Kvap40xPBJoonqi

oMAQsoLu7/fTx82aEL3TbdjXNLFnQ2KKYmfG9ymx80sLHMmdmDXpNNE+bEKJz1dp

t1Q0cVduwmqSfB8JyIE6Udz7JX7HCXaVmxoK7z4Njh3dyHsqhdqKIx0dBuK0hCaq

4zPzGP/sORA3G9ZPxxpEvF3gvE/zsXj7ifihqbqr2eIFOpB/lQqAehsgQT5/6Iq+

9pAX2LCxNkaUHYYZpMkM8Oi37jzg8PX/FnHdm9HQU2IBqYhoqo7/VsNdUDln2QHN

dGAUprcbAgMBAAE=

-----END PRIVATE KEY-----



Coming back to EC key, looking at the error logs emitted, it does seem to recognize it to be EC (the logs contain EC_routines) somehow but then fails.



On 9/17/18, 2:22 PM, &quot;openssl-users on behalf of Richard Levitte&quot; &lt;<A HREF="../../../mailman/listinfo/openssl-users.html">openssl-users-bounces at openssl.org</A>&lt;mailto:<A HREF="../../../mailman/listinfo/openssl-users.html">openssl-users-bounces at openssl.org</A>&gt; on behalf of <A HREF="../../../mailman/listinfo/openssl-users.html">levitte at openssl.org</A>&lt;mailto:<A HREF="../../../mailman/listinfo/openssl-users.html">levitte at openssl.org</A>&gt;&gt; wrote:



    In message &lt;<A HREF="../../../mailman/listinfo/openssl-users.html">4AC69FC3-BEC7-46F6-882A-671196FC0156 at contoso.com</A>&lt;mailto:<A HREF="../../../mailman/listinfo/openssl-users.html">4AC69FC3-BEC7-46F6-882A-671196FC0156 at contoso.com</A>&gt;&gt; on Mon, 17 Sep 2018 20:59:59 +0000, &quot;Paras Shah (parashah)&quot; &lt;<A HREF="../../../mailman/listinfo/openssl-users.html">parashah at cisco.com</A>&lt;mailto:<A HREF="../../../mailman/listinfo/openssl-users.html">parashah at cisco.com</A>&gt;&gt; said:



    &gt; 4. Import the key into softhsm

    &gt;

    &gt; []:~$ softhsm2-util --import ~/tmp/secp256k1-key.pem.pkcs8 --label &quot;ec key&quot; --id 1111 --token

    &gt; &quot;token 2.5.0-rc1&quot;



    Ok, so here, the ID is &quot;1111&quot;



    &gt; 5. Get the pkcs11 url for the private key

    &gt;

    &gt; []:~$ p11tool --login --provider=/usr/local/lib/softhsm/libsofthsm2.so --set-pin=1111 --list-all

    &gt;

    &gt; Object 0:

    &gt;

    &gt; URL:

    &gt; pkcs11:model=SoftHSM%20v2;manufacturer=SoftHSM%20project;serial=6a160d52b750862f;token=token%202.5.0-rc1;id=%11%11;object=ec%20key;type=private



    But here, the ID is &quot;%11%11&quot;, and since those get percent decoded,

    that's actually two vertical tabs, or with C vector syntax,

    { 0x0b, 0x0b }



    I'm not sure what engine-pkcs11 asks of you otherwise, but one guess

    could be to change 'id=%11%11' to 'id=1111' in that URL and try again.



    Cheers,

    Richard



    --

    Richard Levitte         <A HREF="../../../mailman/listinfo/openssl-users.html">levitte at openssl.org</A>&lt;mailto:<A HREF="../../../mailman/listinfo/openssl-users.html">levitte at openssl.org</A>&gt;

    OpenSSL Project         <A HREF="http://www.openssl.org/~levitte/">http://www.openssl.org/~levitte/</A>

    --

    openssl-users mailing list

    To unsubscribe: <A HREF="../../../mailman/listinfo/openssl-users.html">https://mta.openssl.org/mailman/listinfo/openssl-users</A>


--
openssl-users mailing list
To unsubscribe: <A HREF="../../../mailman/listinfo/openssl-users.html">https://mta.openssl.org/mailman/listinfo/openssl-users</A>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://mta.openssl.org/pipermail/openssl-users/attachments/20180921/044e8ddc/attachment-0001.html">http://mta.openssl.org/pipermail/openssl-users/attachments/20180921/044e8ddc/attachment-0001.html</A>&gt;
</PRE>



<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="008830.html">[openssl-users] Softhsm + engine_pkcs11 + openssl with EC keys fail.
</A></li>
	<LI>Next message: <A HREF="008851.html">[openssl-users] Softhsm + engine_pkcs11 + openssl with EC keys fail.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#8850">[ date ]</a>
              <a href="thread.html#8850">[ thread ]</a>
              <a href="subject.html#8850">[ subject ]</a>
              <a href="author.html#8850">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="../../../mailman/listinfo/openssl-users.html">More information about the openssl-users
mailing list</a><br>
</body></html>
