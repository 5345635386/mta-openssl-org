<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> memory leak debug options
   </TITLE>
   <LINK REL="Index" HREF="https://mta.openssl.org/pipermail/openssl-users/2021-April/index.html" >
   <LINK REL="made" HREF="mailto:openssl-users%40openssl.org?Subject=Re%3A%20memory%20leak%20debug%20options&In-Reply-To=%3Cd230379d347042b9add1849239392f1d%40jp.adit-jv.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="013729.html">
   <LINK REL="Next"  HREF="013735.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>memory leak debug options</H1>
    <B>Chetan, Sethi (Sasken; LEADER ; ADITJ/SWG)</B> 
    <A HREF="mailto:openssl-users%40openssl.org?Subject=Re%3A%20memory%20leak%20debug%20options&In-Reply-To=%3Cd230379d347042b9add1849239392f1d%40jp.adit-jv.com%3E"
       TITLE="memory leak debug options">external.schetan at jp.adit-jv.com
       </A><BR>
    <I>Wed Apr 28 02:37:12 UTC 2021</I>
    <P><UL>
        <LI>Previous message: <A HREF="013729.html">configuration options 'fips' and 'makedepend' disbled by default on master
</A></li>
        <LI>Next message: <A HREF="013735.html">configuration options 'fips' and 'makedepend' disabled by default on master
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#13730">[ date ]</a>
              <a href="thread.html#13730">[ thread ]</a>
              <a href="subject.html#13730">[ subject ]</a>
              <a href="author.html#13730">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hello,

Currently we are seeing below 3 patterns of memory leak issue with Openssl 1.1.1i and 1.1.1k version using address santizer option as below:
Direct leak of 208 byte(s) in 2 object(s) allocated from:
    #0 0x9ef57b in __interceptor_malloc (/usr/local/bin/autoai/custom_binary+0x9ef57b)
    #1 0xffffac627743 in BN_MONT_CTX_new (/usr/lib64/libcrypto.so.1.1+0xaf743)
    #2 0xffffac627baf in BN_MONT_CTX_set_locked (/usr/lib64/libcrypto.so.1.1+0xafbaf)
    #3 0xffffac6ec77b  (/usr/lib64/libcrypto.so.1.1+0x17477b) rsa_ossl_public_decrypt
    #4 0xffffac6f0577  (/usr/lib64/libcrypto.so.1.1+0x178577) RSA_verify_ASN1_OCTET_STRING
    #5 0xffffac6eef1b  (/usr/lib64/libcrypto.so.1.1+0x176f1b) pkey_rsa_verify
    #6 0xffffac6b44cf in EVP_DigestVerifyFinal (/usr/lib64/libcrypto.so.1.1+0x13c4cf)
    #7 0xffffac8d95c7  (/usr/lib64/libssl.so.1.1+0x515c7) tls_process_key_exchange -&gt;EVP_DigestVerify-&gt;EVP_DigestVerifyFinal
    #8 0xffffac8d9b33  (/usr/lib64/libssl.so.1.1+0x51b33) ossl_statem_client_process_message
    #9 0xffffac8d3acb  (/usr/lib64/libssl.so.1.1+0x4bacb) state_machine -&gt; read_state_machine -&gt; *process_change-&gt;ossl_statem_client_process_message
    #10 0xffffac8c01fb in SSL_do_handshake (/usr/lib64/libssl.so.1.1+0x381fb) via SSL_connect
    #11 0xffffac858f3b  (/usr/lib64/libcurl.so.4+0x4ff3b) ossl_connect_step2
    #12 0xffffac85afeb  (/usr/lib64/libcurl.so.4+0x51feb) ossl_connect_common
    #13 0xffffac85c1ef  (/usr/lib64/libcurl.so.4+0x531ef) Curl_ssl_connect_nonblocking
    #14 0xffffac82c96f  (/usr/lib64/libcurl.so.4+0x2396f) https_connecting

Indirect leak of 2064 byte(s) in 2 object(s) allocated from:
    #0 0x9ef57b in __interceptor_malloc (/usr/local/bin/autoai/custom_binary+0x9ef57b)
    #1 0xffffac6bf173 in CRYPTO_zalloc (/usr/lib64/libcrypto.so.1.1+0x147173)
    #2 0xffffac625fd7  (/usr/lib64/libcrypto.so.1.1+0xadfd7)bn_expand2
    #3 0xffffac6262af in BN_set_bit (/usr/lib64/libcrypto.so.1.1+0xae2af)
    #4 0xffffac627a0b in BN_MONT_CTX_set (/usr/lib64/libcrypto.so.1.1+0xafa0b)
    #5 0xffffac627bc3 in BN_MONT_CTX_set_locked (/usr/lib64/libcrypto.so.1.1+0xafbc3)
&lt;Curl backtrace is same as above&gt;

Indirect leak of 1536 byte(s) in 5 object(s) allocated from:
    #0 0x9ef57b in __interceptor_malloc (/usr/local/bin/autoai/custom_binary+0x9ef57b)
    #1 0xffffac6bf173 in CRYPTO_zalloc (/usr/lib64/libcrypto.so.1.1+0x147173)
    #2 0xffffac625fd7  (/usr/lib64/libcrypto.so.1.1+0xadfd7) bn_expand2
    #3 0xffffac626143 in BN_copy (/usr/lib64/libcrypto.so.1.1+0xae143)
    #4 0xffffac6278a3 in BN_MONT_CTX_set (/usr/lib64/libcrypto.so.1.1+0xaf8a3)
    #5 0xffffac627bc3 in BN_MONT_CTX_set_locked (/usr/lib64/libcrypto.so.1.1+0xafbc3)
&lt;Curl backtrace is same as above&gt;

After statical analysis we noted that the crypto_malloc and crypto_free functions are further called.
In these functions we could see debug flags OPENSSL_NO_CRYPTO_MDEBUG and OPENSSL_NO_CRYPTO_MDEBUG_BACKTRACE which might provide useful information in debugging this leak issue.

In this regard we have below queries:-
1. Could you please let us know how to enable/check the logs generated by above debug flags ?
2. We tried one experiment wherein we have disabled flags RSA_FLAG_CACHE_PUBLIC, RSA_FLAG_CACHE_PRIVATE from rsa_ossl_init() function and we can see that above leak does not happen.
   In this regards, are there any known issue/fixes available which we could try.
2. Any other suggesstion for debugging this memory leak from openssl point of view, would be welcome.

Regards,
Chetan
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="https://mta.openssl.org/pipermail/openssl-users/attachments/20210428/6dd4a2a1/attachment.html">https://mta.openssl.org/pipermail/openssl-users/attachments/20210428/6dd4a2a1/attachment.html</A>&gt;
</PRE>






<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="013729.html">configuration options 'fips' and 'makedepend' disbled by default on master
</A></li>
	<LI>Next message: <A HREF="013735.html">configuration options 'fips' and 'makedepend' disabled by default on master
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#13730">[ date ]</a>
              <a href="thread.html#13730">[ thread ]</a>
              <a href="subject.html#13730">[ subject ]</a>
              <a href="author.html#13730">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="../../../mailman/listinfo/openssl-users.html">More information about the openssl-users
mailing list</a><br>
</body></html>
