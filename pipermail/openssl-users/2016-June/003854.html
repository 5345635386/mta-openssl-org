<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [openssl-users] Fwd: issue with dtls failure during openssl upgrade from 1.0.1m to q
   </TITLE>
   <LINK REL="Index" HREF="https://mta.openssl.org/pipermail/openssl-users/2016-June/index.html" >
   <LINK REL="made" HREF="mailto:openssl-users%40openssl.org?Subject=Re%3A%20%5Bopenssl-users%5D%20Fwd%3A%20issue%20with%20dtls%20failure%20during%20openssl%0A%20upgrade%20from%201.0.1m%20to%20q&In-Reply-To=%3CCAP_%3DhLRxy6ORs-YwLjCzu7FNhPqP8ffD7_q433a%3D6QGoJyf6_w%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="003848.html">
   <LINK REL="Next"  HREF="003855.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[openssl-users] Fwd: issue with dtls failure during openssl upgrade from 1.0.1m to q</H1>
    <B>Test ssl</B> 
    <A HREF="mailto:openssl-users%40openssl.org?Subject=Re%3A%20%5Bopenssl-users%5D%20Fwd%3A%20issue%20with%20dtls%20failure%20during%20openssl%0A%20upgrade%20from%201.0.1m%20to%20q&In-Reply-To=%3CCAP_%3DhLRxy6ORs-YwLjCzu7FNhPqP8ffD7_q433a%3D6QGoJyf6_w%40mail.gmail.com%3E"
       TITLE="[openssl-users] Fwd: issue with dtls failure during openssl upgrade from 1.0.1m to q">testossl2016 at gmail.com
       </A><BR>
    <I>Sun Jun 19 13:47:48 UTC 2016</I>
    <P><UL>
        <LI>Previous message: <A HREF="003848.html">[openssl-users] Fwd: issue with dtls failure during openssl upgrade from 1.0.1m to q
</A></li>
        <LI>Next message: <A HREF="003855.html">[openssl-users] Fwd: issue with dtls failure during openssl upgrade from 1.0.1m to q
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3854">[ date ]</a>
              <a href="thread.html#3854">[ thread ]</a>
              <a href="subject.html#3854">[ subject ]</a>
              <a href="author.html#3854">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi Matt,

This is a DTLSv1.0 connection, so the hosts on both sides will connect to
each other acting as both TLS client and TLS server.

We think the dtls failure is due to cipher suites. But we are not able to
understand why it works for 1.0.1m with same certificate.

Please help us.

Regards,

On Fri, Jun 17, 2016 at 10:05 PM, Matt Caswell &lt;<A HREF="../../../mailman/listinfo/openssl-users.html">matt at openssl.org</A>&gt; wrote:

&gt;<i>
</I>&gt;<i>
</I>&gt;<i> On 17/06/16 17:29, Test ssl wrote:
</I>&gt;<i> &gt; Hi Matt,
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; With same application code and openssl1.0.1m we are not facing &quot;Alert
</I>&gt;<i> &gt; (Handshake Failure)&quot; but in case of 1.0.1q we are facing it.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; That is what we are not able to understand that what is the reason for
</I>&gt;<i> &gt; this &quot;Alert (Handshake Failure)&quot;.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Please help us on this, which part of functionality we can modify in the
</I>&gt;<i> &gt; application code to overcome this DTLS handshake failure.
</I>&gt;<i>
</I>&gt;<i> Well to have a chance of answering that I need to understand why your
</I>&gt;<i> application is behaving in the way I described below. If your
</I>&gt;<i> application is doing something weird and unexpected it may well be that
</I>&gt;<i> it just happened to work by accident in 1.0.1m, but something under the
</I>&gt;<i> hood changed, and it doesn't any more.
</I>&gt;<i>
</I>&gt;<i> Why do we see this strange double handshake in your application where
</I>&gt;<i> the client/server apparently switch roles? Is there something about your
</I>&gt;<i> application design that could explain it? Is it intentional?
</I>&gt;<i>
</I>&gt;<i> Matt
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Regards,
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; On Fri, Jun 17, 2016 at 5:55 PM, Matt Caswell &lt;<A HREF="../../../mailman/listinfo/openssl-users.html">matt at openssl.org</A>
</I>&gt;<i> &gt; &lt;mailto:<A HREF="../../../mailman/listinfo/openssl-users.html">matt at openssl.org</A>&gt;&gt; wrote:
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;     Hello
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;     On 17/06/16 12:04, Test ssl wrote:
</I>&gt;<i> &gt;     &gt; We are facing an issue with DTLS failure during the Openssl
</I>&gt;<i> upgrade from
</I>&gt;<i> &gt;     &gt; 1.0.1m to 1.0.1q. We have attached the network trace file in
</I>&gt;<i> attachment
</I>&gt;<i> &gt;     &gt; with good (1.0.1m) and fail (1.0.1q) case.
</I>&gt;<i> &gt;     &gt;
</I>&gt;<i> &gt;     &gt; The test scenario is that we are trying to connect a cisco based
</I>&gt;<i> &gt;     &gt; Endpoint device to a Video conference server, where our code
</I>&gt;<i> resides.
</I>&gt;<i> &gt;     &gt;
</I>&gt;<i> &gt;     &gt; Please help us with this DTLS failure scenario which we are not
</I>&gt;<i> able to
</I>&gt;<i> &gt;     &gt; understand that what wrong we did in our application code in using
</I>&gt;<i> &gt;     &gt; Openssl APIs.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;     This looks like quite a strange trace in both the success and
</I>&gt;<i> &gt;     failure cases.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;     The traces are slightly confusing because it looks like you are
</I>&gt;<i> making
</I>&gt;<i> &gt;     multiple connections from different ports. To simplify things in the
</I>&gt;<i> &gt;     success case I filtered wireshark to only show me the port 22602 &lt;-&gt;
</I>&gt;<i> &gt;     port 49164 communication.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;     This showed me the following interaction
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;     Client                     Server
</I>&gt;<i> &gt;     ======                     ======
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;     ClientHello
</I>&gt;<i> &gt;                                ServerHello
</I>&gt;<i> &gt;                                Certificate
</I>&gt;<i> &gt;                                ServerHelloDone
</I>&gt;<i> &gt;     ClientKeyExchange
</I>&gt;<i> &gt;     ChangeCipherSpec
</I>&gt;<i> &gt;     EncryptedHandshakeMessage
</I>&gt;<i> &gt;                                ChangeCipherSpec
</I>&gt;<i> &gt;                                EncryptedHandshakeMessage
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;     So far so good. This looks like a normal successful handshake. The
</I>&gt;<i> &gt;     EncryptedHandshakeMessages at the end of these exchanges are the
</I>&gt;<i> &gt;     Finished messages indicating that the handshake was successful. I
</I>&gt;<i> would
</I>&gt;<i> &gt;     then expect to see Application Data being exchanged. Instead I see
</I>&gt;<i> this:
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;     Client                     Server
</I>&gt;<i> &gt;     ======                     ======
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;                                ClientHello
</I>&gt;<i> &gt;     ServerHello
</I>&gt;<i> &gt;     Certificate
</I>&gt;<i> &gt;     ServerKeyExchange
</I>&gt;<i> &gt;     CertificateRequest
</I>&gt;<i> &gt;     ServerHelloDone
</I>&gt;<i> &gt;                                Certificate
</I>&gt;<i> &gt;                                ClientKeyExchange
</I>&gt;<i> &gt;                                CertificateVerify
</I>&gt;<i> &gt;                                ChangeCipherSpec
</I>&gt;<i> &gt;                                EncryptedHandshakeMessage
</I>&gt;<i> &gt;     ChangeCipherSpec
</I>&gt;<i> &gt;     EncryptedHandshakeMessage
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;     So AFAICT the client and server appear to have swapped roles!!! The
</I>&gt;<i> &gt;     server is sending Client message and the client is sending server
</I>&gt;<i> &gt;     messages. Not only that but the connection previously established
</I>&gt;<i> seems
</I>&gt;<i> &gt;     to have been thrown away and they are starting from scratch (i.e.
</I>&gt;<i> &gt;     unencrypted) without having first shutdown the previous connection or
</I>&gt;<i> &gt;     having sent any application data.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;     The failure case is similar. The client and server apparently
</I>&gt;<i> &gt;     successfully complete a handshake. They then seem to swap roles
</I>&gt;<i> &gt;     (starting from scratch again, without any app data being sent),
</I>&gt;<i> except
</I>&gt;<i> &gt;     this time we see:
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;     Client                     Server
</I>&gt;<i> &gt;     ======                     ======
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;                                ClientHello
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;     ServerHello
</I>&gt;<i> &gt;     Certificate
</I>&gt;<i> &gt;     ServerKeyExchange
</I>&gt;<i> &gt;     CertificateRequest
</I>&gt;<i> &gt;     ServerHelloDone
</I>&gt;<i> &gt;                                Alert (Handshake Failure)
</I>&gt;<i> &gt;                                ClientHello
</I>&gt;<i> &gt;     ServerHello
</I>&gt;<i> &gt;     Certificate
</I>&gt;<i> &gt;     ServerKeyExchange
</I>&gt;<i> &gt;     CertificateRequest
</I>&gt;<i> &gt;     ServerHelloDone
</I>&gt;<i> &gt;                                Alert (Decrypt Error)
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;     So here we see the &quot;server&quot;, that seems to have forgotten it is the
</I>&gt;<i> &gt;     server and is now acting as the client attempt to initiate a
</I>&gt;<i> handshake
</I>&gt;<i> &gt;     (forgetting all about the previous connection). It then fails with a
</I>&gt;<i> &gt;     Handshake Failure (I'm not surprised), and apparently decides to have
</I>&gt;<i> &gt;     another go. This time we see a DecryptError which suggests the
</I>&gt;<i> &quot;server&quot;
</I>&gt;<i> &gt;     (acting as a client) is expecting to receive encrypted data, but the
</I>&gt;<i> &gt;     client (acting as a server) is still sending unencrypted data.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;     You need to try and figure out why the two ends of the communication
</I>&gt;<i> are
</I>&gt;<i> &gt;     so confused about what role they are playing (or is there something
</I>&gt;<i> you
</I>&gt;<i> &gt;     haven't told me about the way your application works?).
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;     Matt
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;     --
</I>&gt;<i> &gt;     openssl-users mailing list
</I>&gt;<i> &gt;     To unsubscribe:
</I>&gt;<i> <A HREF="../../../mailman/listinfo/openssl-users.html">https://mta.openssl.org/mailman/listinfo/openssl-users</A>
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> --
</I>&gt;<i> openssl-users mailing list
</I>&gt;<i> To unsubscribe: <A HREF="../../../mailman/listinfo/openssl-users.html">https://mta.openssl.org/mailman/listinfo/openssl-users</A>
</I>&gt;<i>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://mta.openssl.org/pipermail/openssl-users/attachments/20160619/88cb9fa9/attachment-0001.html">http://mta.openssl.org/pipermail/openssl-users/attachments/20160619/88cb9fa9/attachment-0001.html</A>&gt;
</PRE>



<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="003848.html">[openssl-users] Fwd: issue with dtls failure during openssl upgrade from 1.0.1m to q
</A></li>
	<LI>Next message: <A HREF="003855.html">[openssl-users] Fwd: issue with dtls failure during openssl upgrade from 1.0.1m to q
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3854">[ date ]</a>
              <a href="thread.html#3854">[ thread ]</a>
              <a href="subject.html#3854">[ subject ]</a>
              <a href="author.html#3854">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="../../../mailman/listinfo/openssl-users.html">More information about the openssl-users
mailing list</a><br>
</body></html>
