<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [openssl-users] openssl commandline client use
   </TITLE>
   <LINK REL="Index" HREF="https://mta.openssl.org/pipermail/openssl-users/2018-October/index.html" >
   <LINK REL="made" HREF="mailto:openssl-users%40openssl.org?Subject=Re%3A%20%5Bopenssl-users%5D%20openssl%20commandline%20client%20use&In-Reply-To=%3C07d605e3-11c0-09d6-acdd-20187a42a7f0%40wisemo.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="008991.html">
   <LINK REL="Next"  HREF="008990.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[openssl-users] openssl commandline client use</H1>
    <B>Jakob Bohm</B> 
    <A HREF="mailto:openssl-users%40openssl.org?Subject=Re%3A%20%5Bopenssl-users%5D%20openssl%20commandline%20client%20use&In-Reply-To=%3C07d605e3-11c0-09d6-acdd-20187a42a7f0%40wisemo.com%3E"
       TITLE="[openssl-users] openssl commandline client use">jb-openssl at wisemo.com
       </A><BR>
    <I>Fri Oct 12 02:31:43 UTC 2018</I>
    <P><UL>
        <LI>Previous message: <A HREF="008991.html">[openssl-users] openssl commandline client use
</A></li>
        <LI>Next message: <A HREF="008990.html">[openssl-users] openssl commandline client use
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#8997">[ date ]</a>
              <a href="thread.html#8997">[ thread ]</a>
              <a href="subject.html#8997">[ subject ]</a>
              <a href="author.html#8997">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 11/10/2018 06:44, Paul Chubb wrote:
&gt;<i> Hi thanks for the responses. I try not to do crypto for the very 
</I>&gt;<i> reasons you raise - i simply don't know enough and your (good) pointed 
</I>&gt;<i> questions have demonstrated that.
</I>&gt;<i>
</I>&gt;<i> &#160;Context:
</I>&gt;<i>
</I>&gt;<i> We are trying for GDPR and other privacy law compliance. We probably 
</I>&gt;<i> need to meet GDPR, US requirements, Australian requirements, Japanese 
</I>&gt;<i> requirements and UK requirements. The data is not hugely critical. It 
</I>&gt;<i> contains names and exercise metrics. It doesn't contain credit card 
</I>&gt;<i> details or anything above the level of names. I don't think it 
</I>&gt;<i> contains addresses but probably does contain names of recognizable 
</I>&gt;<i> organisations which could provide a tuple for identification purposes 
</I>&gt;<i> if the data was compromised.
</I>&gt;<i>
</I>&gt;<i> A mysqldump of the db in production at present is around 170Gb however 
</I>&gt;<i> that is text based and we are using a binary solution based on percola 
</I>&gt;<i> xtrabackup so the final size should be smaller for the current time. 
</I>&gt;<i> The documentation on this by the backup software provider is very 
</I>&gt;<i> simplistic and simply pipes the stream of data through openssl and 
</I>&gt;<i> then gzip:
</I>&gt;<i>
</I>&gt;<i> mariabackup --user=root --backup --stream=xbstream | gzip | openssl  enc -aes-256-cbc -k mypass &gt; backup.xb.gz.enc
</I>&gt;<i> There are thousands of posts that do similar and in non-crypto circles 
</I>&gt;<i> it is the accepted way of doing things. That was my starting point.
</I>&gt;<i>
</I>&gt;<i> I am&#160; not using a password but generating keys. The symetric key is 
</I>&gt;<i> generated by &quot;openssl rand -hex 32&quot; which I have read is suitable. The 
</I>&gt;<i> Nonce or IV is generated&#160; by &quot;openssl rand -hex 16&quot;. These values are 
</I>&gt;<i> used once and then kept for decryption of that file. They in turn are 
</I>&gt;<i> encrypted before storing - see below.
</I>&gt;<i>
</I>&gt;<i> The two keys are held in ram while the backup occurs. They are applied 
</I>&gt;<i> to openssl using the -K and -iv switches. They are then written out to 
</I>&gt;<i> disk. encrypted with a list of public RSA keys and the original 
</I>&gt;<i> deleted from disk. I then package it all up and delete the intervening 
</I>&gt;<i> encrypted files leaving me with an archive with the encrypted backup 
</I>&gt;<i> and several copies of the nonce and key each encrypted by different 
</I>&gt;<i> people's public keys.
</I>&gt;<i>
</I>&gt;<i> The backup regime has not been decided as yet. I expect it will be 
</I>&gt;<i> something like a full backup per week and then either incrementals or 
</I>&gt;<i> differentials on the other days. I expect that the fulls will be kept 
</I>&gt;<i> for 30 days and the deltas for 14days. The database backups will sit 
</I>&gt;<i> on a secured server disk which in turn will be backed up by the 
</I>&gt;<i> hosting provider with whatever process and rotation they use.
</I>&gt;<i>
</I>&gt;<i> I would expect that headers in the backup stream would be predictable, 
</I>&gt;<i> whether they provide a good enough attack surface I don't know. In 
</I>&gt;<i> addition the clients of course know their data that may also provide 
</I>&gt;<i> an attack surface. Finally I have included an encrypted file with a 
</I>&gt;<i> known plain text phrase. Based on your comments, this will probably 
</I>&gt;<i> not get into production but provides an easy way for testing and 
</I>&gt;<i> debugging to check that things are encrypted or not.
</I>&gt;<i>
</I>&gt;<i> The kind of statements that prompted my question was: 
</I>&gt;<i> <A HREF="https://security.stackexchange.com/questions/182277/is-openssl-aes-256-cbc-encryption-safe-for-offsite-backup">https://security.stackexchange.com/questions/182277/is-openssl-aes-256-cbc-encryption-safe-for-offsite-backup</A> 
</I>&gt;<i> whose comments suggest that openssl should never be used for 
</I>&gt;<i> production purposes.Their suggestion was GnuPG which isn't suitable 
</I>&gt;<i> for this purpose because it does password/key management that assumes 
</I>&gt;<i> a desktop/laptop environment and manual process. I also looked at 
</I>&gt;<i> ccrypt and mcrypt but then went back to openssl.
</I>&gt;<i>
</I>&gt;<i> Cheers Paul
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> On Thu, Oct 11, 2018 at 2:12 PM Viktor Dukhovni 
</I>&gt;<i> &lt;<A HREF="../../../mailman/listinfo/openssl-users.html">openssl-users at dukhovni.org</A> &lt;mailto:<A HREF="../../../mailman/listinfo/openssl-users.html">openssl-users at dukhovni.org</A>&gt;&gt; wrote:
</I>&gt;<i>
</I>&gt;<i>     On Thu, Oct 11, 2018 at 01:23:41AM +0000, Michael Wojcik wrote:
</I>&gt;<i>
</I>&gt;<i>     &gt; - Data recovery from an encrypted backup is tough. With CBC, one
</I>&gt;<i>     bit goes
</I>&gt;<i>     &gt; astray and you've lost everything after that.
</I>&gt;<i>
</I>&gt;<i>     No, a 1 bit error in CBC ciphertext breaks only the current block,
</I>&gt;<i>     and introduces a 1 bit error into the plaintext of the next block.
</I>&gt;<i>     After that, you're back in sync.
</I>&gt;<i>
</I>&gt;<i>     But yes, indeed &quot;openssl enc&quot; offers little integrity protection.
</I>&gt;<i>     One should probably break the data into chunks and encrypt and MAC
</I>&gt;<i>     each chunk with the MAC covering the chunk sequence number, and
</I>&gt;<i>     whether it is the last chunk.
</I>&gt;<i>
</I>
I have not tested it with your huge data sizes, but I have had a lot of
success with the following pipeline which avoids a number of security
pitfalls by using higher levelOpenSSL commandline features:

BackupCmd | \
 &#160; openssl smime -sign -binary -nodetach -signer SomeDir/mycert.pem \
 &#160;&#160;&#160; -inkey SomeDir/mycert.key -outform DER | \
 &#160; gzip -n -9 | \
 &#160; openssl smime -encrypt -binary -out backup.enc -outform DER -aes256 \
SomeDir/restorecert.pem

Where mycert.pem is a certificate issued to the system being backed up
by an internal company CA (also used for intranet https servers) and
restorecert.pem is another such certificate where the private key is
available only to restore procedures.

A feature of this pipeline is that backups can be reencrypted with a
different key / mechanism without ruining the integrity signature, and
can also be recompressed with a better compression algorithm in the same
way.

Another feature is that the server being backed up does not need to know
the decryption key (restorecert.key), while the server doing restores or
backup verifications does not need to know the integrity signing key
(mycert.key).

Dealing with the risk of not being able to decrypt a corrupted backup is
handled by having more than one backup, just like the risk of completely
loosing a backup (fire, flood, ...).

Special note: Because the openssl smime (and openssl cms) signature
verify commands do not have an option to verify signatures as of some
past date (such as the date a backup was made) my restore scripts have
to run openssl under the &quot;faketime&quot; utility to make openssl think it is
being run on the day the backup was made.

Enjoy

Jakob
-- 
Jakob Bohm, CIO, Partner, WiseMo A/S.  <A HREF="https://www.wisemo.com">https://www.wisemo.com</A>
Transformervej 29, 2860 S&#248;borg, Denmark.  Direct +45 31 13 16 10
This public discussion message is non-binding and may contain errors.
WiseMo - Remote Service Management for PCs, Phones and Embedded

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="008991.html">[openssl-users] openssl commandline client use
</A></li>
	<LI>Next message: <A HREF="008990.html">[openssl-users] openssl commandline client use
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#8997">[ date ]</a>
              <a href="thread.html#8997">[ thread ]</a>
              <a href="subject.html#8997">[ subject ]</a>
              <a href="author.html#8997">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="../../../mailman/listinfo/openssl-users.html">More information about the openssl-users
mailing list</a><br>
</body></html>
