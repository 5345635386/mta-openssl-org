<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> Application accessing 'ex_kusage'
   </TITLE>
   <LINK REL="Index" HREF="https://mta.openssl.org/pipermail/openssl-users/2020-November/index.html" >
   <LINK REL="made" HREF="mailto:openssl-users%40openssl.org?Subject=Re%3A%20Application%20accessing%20%27ex_kusage%27&In-Reply-To=%3CSN6PR03MB40610B1131D4DB4764434799B0E00%40SN6PR03MB4061.namprd03.prod.outlook.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="013161.html">
   <LINK REL="Next"  HREF="013163.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>Application accessing 'ex_kusage'</H1>
    <B>Narayana, Sunil Kumar</B> 
    <A HREF="mailto:openssl-users%40openssl.org?Subject=Re%3A%20Application%20accessing%20%27ex_kusage%27&In-Reply-To=%3CSN6PR03MB40610B1131D4DB4764434799B0E00%40SN6PR03MB4061.namprd03.prod.outlook.com%3E"
       TITLE="Application accessing 'ex_kusage'">sanarayana at rbbn.com
       </A><BR>
    <I>Thu Nov 19 16:24:38 UTC 2020</I>
    <P><UL>
        <LI>Previous message: <A HREF="013161.html">Fwd: Re: openssl s_client connection fails
</A></li>
        <LI>Next message: <A HREF="013163.html">set/get utilities are not available  to access  variable 'num' of structure bio_st
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#13162">[ date ]</a>
              <a href="thread.html#13162">[ thread ]</a>
              <a href="subject.html#13162">[ subject ]</a>
              <a href="author.html#13162">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi Matt,
                Thanks for the response, the application code has been around a very long time and no one knows the rationale behind it
As I understand from your reply that the application need not have to do these operations internally, so we will go ahead and stub it out for now

Regards,
Sunil

From: openssl-users &lt;<A HREF="../../../mailman/listinfo/openssl-users.html">openssl-users-bounces at openssl.org</A>&gt; On Behalf Of <A HREF="../../../mailman/listinfo/openssl-users.html">openssl-users-request at openssl.org</A>
Sent: 17 November 2020 08:44
To: <A HREF="../../../mailman/listinfo/openssl-users.html">openssl-users at openssl.org</A>
Subject: openssl-users Digest, Vol 72, Issue 14

________________________________
NOTICE: This email was received from an EXTERNAL sender
________________________________

Send openssl-users mailing list submissions to
<A HREF="../../../mailman/listinfo/openssl-users.html">openssl-users at openssl.org</A>&lt;mailto:<A HREF="../../../mailman/listinfo/openssl-users.html">openssl-users at openssl.org</A>&gt;

To subscribe or unsubscribe via the World Wide Web, visit
<A HREF="https://mta.openssl.org/mailman/listinfo/openssl-users&lt;https://mta.openssl.org/mailman/listinfo/openssl-users">https://mta.openssl.org/mailman/listinfo/openssl-users&lt;https://mta.openssl.org/mailman/listinfo/openssl-users</A>&gt;
or, via email, send a message with subject or body 'help' to
<A HREF="../../../mailman/listinfo/openssl-users.html">openssl-users-request at openssl.org</A>&lt;mailto:<A HREF="../../../mailman/listinfo/openssl-users.html">openssl-users-request at openssl.org</A>&gt;

You can reach the person managing the list at
<A HREF="../../../mailman/listinfo/openssl-users.html">openssl-users-owner at openssl.org</A>&lt;mailto:<A HREF="../../../mailman/listinfo/openssl-users.html">openssl-users-owner at openssl.org</A>&gt;

When replying, please edit your Subject line so it is more specific
than &quot;Re: Contents of openssl-users digest...&quot;


Today's Topics:

1. Re: ## Application accessing 'ex_kusage' ## (Matt Caswell)
2. Re: RAND_bytes() thread safety (Matt Caswell)
3. Re: test cases failed after enabling ktls (Matt Caswell)
4. Handling BIO errors (Jo?o Santos)
5. Re: test cases failed after enabling ktls (rui zang)
6. Re: Server application hangs on SS_read, even when client
disconnects (Jakob Bohm)


----------------------------------------------------------------------

Message: 1
Date: Mon, 16 Nov 2020 10:16:24 +0000
From: Matt Caswell &lt;<A HREF="../../../mailman/listinfo/openssl-users.html">matt at openssl.org</A>&lt;mailto:<A HREF="../../../mailman/listinfo/openssl-users.html">matt at openssl.org</A>&gt;&gt;
To: <A HREF="../../../mailman/listinfo/openssl-users.html">openssl-users at openssl.org</A>&lt;mailto:<A HREF="../../../mailman/listinfo/openssl-users.html">openssl-users at openssl.org</A>&gt;
Subject: Re: ## Application accessing 'ex_kusage' ##
Message-ID: &lt;<A HREF="../../../mailman/listinfo/openssl-users.html">b854f116-568a-d795-9186-098a6d8f4281 at openssl.org</A>&lt;mailto:<A HREF="../../../mailman/listinfo/openssl-users.html">b854f116-568a-d795-9186-098a6d8f4281 at openssl.org</A>&gt;&gt;
Content-Type: text/plain; charset=utf-8



On 13/11/2020 19:10, Narayana, Sunil Kumar wrote:
&gt;<i> Hi ,
</I>&gt;<i>
</I>&gt;<i> ??????????????? We are porting our Application from ?openssl 1.0.1 to
</I>&gt;<i> openssl 3.0. in related to this activity we require to access the
</I>&gt;<i> variable ?*ex_kusage*? pointed by *X509*
</I>&gt;<i>
</I>&gt;<i> But there are no set utilities available to access this variable. Only
</I>&gt;<i> ?X509_get_key_usage Is available.
</I>&gt;<i>
</I>&gt;<i> ?
</I>&gt;<i>
</I>&gt;<i> Our code for 1.0.1 is as below. Please suggest the right way to achieve
</I>&gt;<i> this.
</I>
I'd like to ask why you feel you need to do this at all. It seems to me
like you are replicating libcrypto internal code in your own
application. This is code in libcrypto:

/* Handle (basic) key usage */
if ((usage = X509_get_ext_d2i(x, NID_key_usage, &amp;i, NULL)) != NULL) {
x-&gt;ex_kusage = 0;
if (usage-&gt;length &gt; 0) {
x-&gt;ex_kusage = usage-&gt;data[0];
if (usage-&gt;length &gt; 1)
x-&gt;ex_kusage |= usage-&gt;data[1] &lt;&lt; 8;
}
x-&gt;ex_flags |= EXFLAG_KUSAGE;
ASN1_BIT_STRING_free(usage);
/* Check for empty key usage according to RFC 5280 section
4.2.1.3&lt;<A HREF="http://4.2.1.3">http://4.2.1.3</A>&gt; */
if (x-&gt;ex_kusage == 0) {
ERR_raise(ERR_LIB_X509, X509V3_R_EMPTY_KEY_USAGE);
x-&gt;ex_flags |= EXFLAG_INVALID;
}
} else if (i != -1) {
x-&gt;ex_flags |= EXFLAG_INVALID;
}

So it seems very similar to what you are trying to do, and I guess some
earlier version of this code was the original source of what is in your
application now.

The purpose of this code is to decode the key usage extension and cache
it in the internal `ex_flags` value. This code gets called in numerous
code paths whenever we need to query extension data - including if you
were to call X509_get_key_usage().

Your application seems to want to manage for itself when libcrypto does
this caching. It should not need to do so - it's entirely internal. My
guess is that, perhaps, in some older version of OpenSSL the caching
didn't happen when it was supposed to and you implemented this
workaround?? Or possibly the workaround is still needed due to a bug in
OpenSSL that still doesn't do the caching when needed? If so I'd like to
understand the circumstances behind that.

Matt



------------------------------

Message: 2
Date: Mon, 16 Nov 2020 10:35:06 +0000
From: Matt Caswell &lt;<A HREF="../../../mailman/listinfo/openssl-users.html">matt at openssl.org</A>&lt;mailto:<A HREF="../../../mailman/listinfo/openssl-users.html">matt at openssl.org</A>&gt;&gt;
To: <A HREF="../../../mailman/listinfo/openssl-users.html">openssl-users at openssl.org</A>&lt;mailto:<A HREF="../../../mailman/listinfo/openssl-users.html">openssl-users at openssl.org</A>&gt;
Subject: Re: RAND_bytes() thread safety
Message-ID: &lt;<A HREF="../../../mailman/listinfo/openssl-users.html">f84a0efa-0a0b-d118-8430-18ea43957251 at openssl.org</A>&lt;mailto:<A HREF="../../../mailman/listinfo/openssl-users.html">f84a0efa-0a0b-d118-8430-18ea43957251 at openssl.org</A>&gt;&gt;
Content-Type: text/plain; charset=utf-8



On 14/11/2020 11:00, Rahul Godbole wrote:
&gt;<i> Is OpenSSL function RAND_bytes () thread safe?
</I>
Short answer: Yes

Longer answer: Yes assuming that:
- you are using &gt;= OpenSSL 1.1.0
or
- you are using OpenSSL 1.0.2 or below and you have set up the locking
callbacks

AND

- You have not compiled OpenSSL with &quot;no-threads&quot;

Matt



------------------------------

Message: 3
Date: Mon, 16 Nov 2020 11:45:20 +0000
From: Matt Caswell &lt;<A HREF="../../../mailman/listinfo/openssl-users.html">matt at openssl.org</A>&lt;mailto:<A HREF="../../../mailman/listinfo/openssl-users.html">matt at openssl.org</A>&gt;&gt;
To: <A HREF="../../../mailman/listinfo/openssl-users.html">openssl-users at openssl.org</A>&lt;mailto:<A HREF="../../../mailman/listinfo/openssl-users.html">openssl-users at openssl.org</A>&gt;
Subject: Re: test cases failed after enabling ktls
Message-ID: &lt;<A HREF="../../../mailman/listinfo/openssl-users.html">749b7676-2c84-1b63-9b75-575f903e14f7 at openssl.org</A>&lt;mailto:<A HREF="../../../mailman/listinfo/openssl-users.html">749b7676-2c84-1b63-9b75-575f903e14f7 at openssl.org</A>&gt;&gt;
Content-Type: text/plain; charset=utf-8


On 16/11/2020 07:56, rui zang wrote:
&gt;<i> Resend in plain text.
</I>&gt;<i> ======================================
</I>&gt;<i>
</I>&gt;<i> Greetings,
</I>&gt;<i>
</I>&gt;<i> I am trying openssl+ktls on ubuntu 20.04.
</I>&gt;<i> I have tried openssl-3.0.0-alpha8 from <A HREF="https://www.openssl.org/source/openssl-3.0.0-alpha8.tar.gz&lt;https://www.openssl.org/source/openssl-3.0.0-alpha8.tar.gz">https://www.openssl.org/source/openssl-3.0.0-alpha8.tar.gz&lt;https://www.openssl.org/source/openssl-3.0.0-alpha8.tar.gz</A>&gt;
</I>&gt;<i> and also the current master branch from the github repo.
</I>&gt;<i> The kernels I have tried are v5.9 and v5.9.8.
</I>&gt;<i> On every combination, same group of test case could not pass.
</I>

Please can you open this as a github issue?

Thanks

Matt


&gt;<i>
</I>&gt;<i> Test Summary Report
</I>&gt;<i> -------------------
</I>&gt;<i> 70-test_key_share.t (Wstat: 1536 Tests: 22 Failed: 6)
</I>&gt;<i> Failed tests: 1, 4, 6-7, 13-14
</I>&gt;<i> Non-zero exit status: 6
</I>&gt;<i> 70-test_sslextension.t (Wstat: 256 Tests: 8 Failed: 1)
</I>&gt;<i> Failed test: 8
</I>&gt;<i> Non-zero exit status: 1
</I>&gt;<i> 70-test_sslrecords.t (Wstat: 768 Tests: 20 Failed: 3)
</I>&gt;<i> Failed tests: 18-20
</I>&gt;<i> Non-zero exit status: 3
</I>&gt;<i> 70-test_sslsigalgs.t (Wstat: 1536 Tests: 26 Failed: 6)
</I>&gt;<i> Failed tests: 1, 6, 22-23, 25-26
</I>&gt;<i> Non-zero exit status: 6
</I>&gt;<i> 70-test_sslsignature.t (Wstat: 256 Tests: 4 Failed: 1)
</I>&gt;<i> Failed test: 1
</I>&gt;<i> Non-zero exit status: 1
</I>&gt;<i> 70-test_sslversions.t (Wstat: 512 Tests: 8 Failed: 2)
</I>&gt;<i> Failed tests: 5, 7
</I>&gt;<i> Non-zero exit status: 2
</I>&gt;<i> 70-test_tls13cookie.t (Wstat: 512 Tests: 2 Failed: 2)
</I>&gt;<i> Failed tests: 1-2
</I>&gt;<i> Non-zero exit status: 2
</I>&gt;<i> 70-test_tls13downgrade.t (Wstat: 256 Tests: 6 Failed: 1)
</I>&gt;<i> Failed test: 6
</I>&gt;<i> Non-zero exit status: 1
</I>&gt;<i> 70-test_tls13kexmodes.t (Wstat: 7424 Tests: 1 Failed: 1)
</I>&gt;<i> Failed test: 1
</I>&gt;<i> Non-zero exit status: 29
</I>&gt;<i> Parse errors: Bad plan. You planned 11 tests but ran 1.
</I>&gt;<i> 70-test_tls13messages.t (Wstat: 7424 Tests: 1 Failed: 0)
</I>&gt;<i> Non-zero exit status: 29
</I>&gt;<i> Parse errors: Bad plan. You planned 17 tests but ran 1.
</I>&gt;<i> 70-test_tls13psk.t (Wstat: 7424 Tests: 1 Failed: 1)
</I>&gt;<i> Failed test: 1
</I>&gt;<i> Non-zero exit status: 29
</I>&gt;<i> Parse errors: Bad plan. You planned 5 tests but ran 1.
</I>&gt;<i> 70-test_tlsextms.t (Wstat: 256 Tests: 10 Failed: 1)
</I>&gt;<i> Failed test: 10
</I>&gt;<i> Non-zero exit status: 1
</I>&gt;<i> Files=223, Tests=3571, 615 wallclock secs (11.00 usr 0.93 sys + 343.65 cusr 84.69 csys = 440.27 CPU)
</I>&gt;<i> Result: FAIL
</I>&gt;<i> make[1]: *** [Makefile:3197: _tests] Error 1
</I>&gt;<i> make[1]: Leaving directory '/home/ubuntu/openssl'
</I>&gt;<i> make: *** [Makefile:3194: tests] Error 2
</I>&gt;<i>
</I>&gt;<i> Complete `make test` output (kernel v5.9.8 + openssl master) is copied here <A HREF="https://cl1p.net/openssl_ktls_make_test_failure&lt;https://cl1p.net/openssl_ktls_make_test_failure">https://cl1p.net/openssl_ktls_make_test_failure&lt;https://cl1p.net/openssl_ktls_make_test_failure</A>&gt; (due to the 100K limit of this mailing list)
</I>&gt;<i> I am sure that the kernel tls module is loaded correctly since /proc/net/tls_stat is exposed correctly and I can see the counters increasing while doing `make test`.
</I>&gt;<i> So is this supposed to happen? What should I do to make ktls work?
</I>&gt;<i>
</I>&gt;<i> Thanks,
</I>&gt;<i> Rui Zang
</I>&gt;<i>
</I>

------------------------------

Message: 4
Date: Tue, 17 Nov 2020 02:33:30 +0000
From: Jo?o Santos &lt;<A HREF="../../../mailman/listinfo/openssl-users.html">jps at xce.pt</A>&lt;mailto:<A HREF="../../../mailman/listinfo/openssl-users.html">jps at xce.pt</A>&gt;&gt;
To: <A HREF="../../../mailman/listinfo/openssl-users.html">openssl-users at openssl.org</A>&lt;mailto:<A HREF="../../../mailman/listinfo/openssl-users.html">openssl-users at openssl.org</A>&gt;
Subject: Handling BIO errors
Message-ID: &lt;<A HREF="../../../mailman/listinfo/openssl-users.html">009450BD-7D9B-47D7-A1D2-8A4476EE52BE at xce.pt</A>&lt;mailto:<A HREF="../../../mailman/listinfo/openssl-users.html">009450BD-7D9B-47D7-A1D2-8A4476EE52BE at xce.pt</A>&gt;&gt;
Content-Type: text/plain; charset=us-ascii

I'm writing a daemon that talks to a server using HTTP/2 over TLS 1.2+ and leveraging OpenSSL 1.1.1h to provide the TLS support.

At the moment I think that I have the whole TLS part figured, and I could probably have the project running by now if I used SSL_set_fd to assign a connected socket to the underlying BIO of an SSL object, but I want to simplify the code as much as possible by using the highest level interfaces at my disposal, which in the case of OpenSSL means using BIO objects.

Unfortunately I'm having a problem which is that I can't figure out how to convert error codes returned by ERR_get_error and split by ERR_GET_LIB, ERR_GET_FUNC, and ERR_GET_REASON into constants that I can use in a switch statement to react to BIO errors. This is not a problem for SSL filter BIOs since those have their own error reporting functions, but is a problem for Internet socket source BIOs since BIO_do_connect in particular can fail due to a system call error, a DNS error,, or even an error generated by lower level OpenSSL functions and other BIOs in the chain, and I cannot find any manual pages documenting these error constants, if they even exist.

Here's a small working example that illustrates the problem that I'm having:

#include &lt;stdio.h&gt;
#include &lt;openssl/bio.h&gt;
#include &lt;openssl/err.h&gt;

int main(void) {
ERR_load_ERR_strings();
BIO *bio = BIO_new_connect(&quot;<A HREF="http://wwx.google.com:80&lt;http://wwx.google.com:80">http://wwx.google.com:80&lt;http://wwx.google.com:80</A>&gt;&quot;);
printf(&quot;Connected: %ld\n&quot;, BIO_do_connect(bio));
ERR_print_errors_fp(stderr);
return 0;
}

Running this code, which has a misspelled hostname on purpose so that it can fail, results in the following printed out to the console:

Connected: -1
4667342272:error:2008F002:BIO routines:BIO_lookup_ex:system lib:crypto/bio/b_addr.c:726:nodename nor servname provided, or not known

What could I do in that code to use a switch statement on the kind of information printed by ERR_print_errors_fp? I know that, in this example, the error is from getaddrinfo, since I recognize the error message, but assuming that I want to handle that specific error, what can I match the library, function, and reason error codes against?

Thanks in advance!

------------------------------

Message: 5
Date: Tue, 17 Nov 2020 11:08:27 +0800
From: rui zang &lt;<A HREF="../../../mailman/listinfo/openssl-users.html">rui.zang at yandex.com</A>&lt;mailto:<A HREF="../../../mailman/listinfo/openssl-users.html">rui.zang at yandex.com</A>&gt;&gt;
To: Matt Caswell &lt;<A HREF="../../../mailman/listinfo/openssl-users.html">matt at openssl.org</A>&lt;mailto:<A HREF="../../../mailman/listinfo/openssl-users.html">matt at openssl.org</A>&gt;&gt;, &quot;<A HREF="../../../mailman/listinfo/openssl-users.html">openssl-users at openssl.org</A>&lt;mailto:<A HREF="../../../mailman/listinfo/openssl-users.html">openssl-users at openssl.org</A>&gt;&quot;
&lt;<A HREF="../../../mailman/listinfo/openssl-users.html">openssl-users at openssl.org</A>&lt;mailto:<A HREF="../../../mailman/listinfo/openssl-users.html">openssl-users at openssl.org</A>&gt;&gt;
Subject: Re: test cases failed after enabling ktls
Message-ID: &lt;<A HREF="../../../mailman/listinfo/openssl-users.html">1089471605582408 at mail.yandex.com</A>&lt;mailto:<A HREF="../../../mailman/listinfo/openssl-users.html">1089471605582408 at mail.yandex.com</A>&gt;&gt;
Content-Type: text/plain; charset=utf-8

Thanks, please check out <A HREF="https://github.com/openssl/openssl/issues/13424&lt;https://github.com/openssl/openssl/issues/13424">https://github.com/openssl/openssl/issues/13424&lt;https://github.com/openssl/openssl/issues/13424</A>&gt;

Regards,
Rui Zang


16.11.2020, 19:45, &quot;Matt Caswell&quot; &lt;<A HREF="../../../mailman/listinfo/openssl-users.html">matt at openssl.org</A>&lt;mailto:<A HREF="../../../mailman/listinfo/openssl-users.html">matt at openssl.org</A>&gt;&gt;:
&gt;<i> On 16/11/2020 07:56, rui zang wrote:
</I>&gt;&gt;<i> ?Resend in plain text.
</I>&gt;&gt;<i> ?======================================
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> ?Greetings,
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> ?I am trying openssl+ktls on ubuntu 20.04.
</I>&gt;&gt;<i> ?I have tried openssl-3.0.0-alpha8 from <A HREF="https://www.openssl.org/source/openssl-3.0.0-alpha8.tar.gz&lt;https://www.openssl.org/source/openssl-3.0.0-alpha8.tar.gz">https://www.openssl.org/source/openssl-3.0.0-alpha8.tar.gz&lt;https://www.openssl.org/source/openssl-3.0.0-alpha8.tar.gz</A>&gt;
</I>&gt;&gt;<i> ?and also the current master branch from the github repo.
</I>&gt;&gt;<i> ?The kernels I have tried are v5.9 and v5.9.8.
</I>&gt;&gt;<i> ?On every combination, same group of test case could not pass.
</I>&gt;<i>
</I>&gt;<i> Please can you open this as a github issue?
</I>&gt;<i>
</I>&gt;<i> Thanks
</I>&gt;<i>
</I>&gt;<i> Matt
</I>&gt;<i>
</I>&gt;&gt;<i> ?Test Summary Report
</I>&gt;&gt;<i> ?-------------------
</I>&gt;&gt;<i> ?70-test_key_share.t (Wstat: 1536 Tests: 22 Failed: 6)
</I>&gt;&gt;<i> ???Failed tests: 1, 4, 6-7, 13-14
</I>&gt;&gt;<i> ???Non-zero exit status: 6
</I>&gt;&gt;<i> ?70-test_sslextension.t (Wstat: 256 Tests: 8 Failed: 1)
</I>&gt;&gt;<i> ???Failed test: 8
</I>&gt;&gt;<i> ???Non-zero exit status: 1
</I>&gt;&gt;<i> ?70-test_sslrecords.t (Wstat: 768 Tests: 20 Failed: 3)
</I>&gt;&gt;<i> ???Failed tests: 18-20
</I>&gt;&gt;<i> ???Non-zero exit status: 3
</I>&gt;&gt;<i> ?70-test_sslsigalgs.t (Wstat: 1536 Tests: 26 Failed: 6)
</I>&gt;&gt;<i> ???Failed tests: 1, 6, 22-23, 25-26
</I>&gt;&gt;<i> ???Non-zero exit status: 6
</I>&gt;&gt;<i> ?70-test_sslsignature.t (Wstat: 256 Tests: 4 Failed: 1)
</I>&gt;&gt;<i> ???Failed test: 1
</I>&gt;&gt;<i> ???Non-zero exit status: 1
</I>&gt;&gt;<i> ?70-test_sslversions.t (Wstat: 512 Tests: 8 Failed: 2)
</I>&gt;&gt;<i> ???Failed tests: 5, 7
</I>&gt;&gt;<i> ???Non-zero exit status: 2
</I>&gt;&gt;<i> ?70-test_tls13cookie.t (Wstat: 512 Tests: 2 Failed: 2)
</I>&gt;&gt;<i> ???Failed tests: 1-2
</I>&gt;&gt;<i> ???Non-zero exit status: 2
</I>&gt;&gt;<i> ?70-test_tls13downgrade.t (Wstat: 256 Tests: 6 Failed: 1)
</I>&gt;&gt;<i> ???Failed test: 6
</I>&gt;&gt;<i> ???Non-zero exit status: 1
</I>&gt;&gt;<i> ?70-test_tls13kexmodes.t (Wstat: 7424 Tests: 1 Failed: 1)
</I>&gt;&gt;<i> ???Failed test: 1
</I>&gt;&gt;<i> ???Non-zero exit status: 29
</I>&gt;&gt;<i> ???Parse errors: Bad plan. You planned 11 tests but ran 1.
</I>&gt;&gt;<i> ?70-test_tls13messages.t (Wstat: 7424 Tests: 1 Failed: 0)
</I>&gt;&gt;<i> ???Non-zero exit status: 29
</I>&gt;&gt;<i> ???Parse errors: Bad plan. You planned 17 tests but ran 1.
</I>&gt;&gt;<i> ?70-test_tls13psk.t (Wstat: 7424 Tests: 1 Failed: 1)
</I>&gt;&gt;<i> ???Failed test: 1
</I>&gt;&gt;<i> ???Non-zero exit status: 29
</I>&gt;&gt;<i> ???Parse errors: Bad plan. You planned 5 tests but ran 1.
</I>&gt;&gt;<i> ?70-test_tlsextms.t (Wstat: 256 Tests: 10 Failed: 1)
</I>&gt;&gt;<i> ???Failed test: 10
</I>&gt;&gt;<i> ???Non-zero exit status: 1
</I>&gt;&gt;<i> ?Files=223, Tests=3571, 615 wallclock secs (11.00 usr 0.93 sys + 343.65 cusr 84.69 csys = 440.27 CPU)
</I>&gt;&gt;<i> ?Result: FAIL
</I>&gt;&gt;<i> ?make[1]: *** [Makefile:3197: _tests] Error 1
</I>&gt;&gt;<i> ?make[1]: Leaving directory '/home/ubuntu/openssl'
</I>&gt;&gt;<i> ?make: *** [Makefile:3194: tests] Error 2
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> ?Complete `make test` output (kernel v5.9.8 + openssl master) is copied here <A HREF="https://cl1p.net/openssl_ktls_make_test_failure&lt;https://cl1p.net/openssl_ktls_make_test_failure">https://cl1p.net/openssl_ktls_make_test_failure&lt;https://cl1p.net/openssl_ktls_make_test_failure</A>&gt; (due to the 100K limit of this mailing list)
</I>&gt;&gt;<i> ?I am sure that the kernel tls module is loaded correctly since /proc/net/tls_stat is exposed correctly and I can see the counters increasing while doing `make test`.
</I>&gt;&gt;<i> ?So is this supposed to happen? What should I do to make ktls work?
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> ?Thanks,
</I>&gt;&gt;<i> ?Rui Zang
</I>

------------------------------

Message: 6
Date: Tue, 17 Nov 2020 04:13:54 +0100
From: Jakob Bohm &lt;<A HREF="../../../mailman/listinfo/openssl-users.html">jb-openssl at wisemo.com</A>&lt;mailto:<A HREF="../../../mailman/listinfo/openssl-users.html">jb-openssl at wisemo.com</A>&gt;&gt;
To: <A HREF="../../../mailman/listinfo/openssl-users.html">openssl-users at openssl.org</A>&lt;mailto:<A HREF="../../../mailman/listinfo/openssl-users.html">openssl-users at openssl.org</A>&gt;
Subject: Re: Server application hangs on SS_read, even when client
disconnects
Message-ID: &lt;<A HREF="../../../mailman/listinfo/openssl-users.html">66c3b7e7-871f-b0c0-3e4c-1968c8d6b91c at wisemo.com</A>&lt;mailto:<A HREF="../../../mailman/listinfo/openssl-users.html">66c3b7e7-871f-b0c0-3e4c-1968c8d6b91c at wisemo.com</A>&gt;&gt;
Content-Type: text/plain; charset=utf-8; format=flowed

(Top posting to match what Mr. Andr? does):

TCP without keepalive will time out the connection a few minutes after
sending any data that doesn't get a response.

TCP without keepalive with no outstanding send (so only a blocking
recv) and nothing outstanding at the other end will probably hang
almost forever as there is nothing indicating that there is actual
data lost in transit.

On 2020-11-13 17:13, Brice Andr? wrote:
&gt;<i> Hello,
</I>&gt;<i>
</I>&gt;<i> And many thanks for the answer.
</I>&gt;<i>
</I>&gt;<i> &quot;Does the server parent process close its copy of the conversation
</I>&gt;<i> socket?&quot; : I checked in my code, but it seems that no. Is it needed? ?
</I>&gt;<i> May it explain my problem ?
</I>&gt;<i>
</I>&gt;<i> &quot; Do you have keepalives enabled?&quot; To be honest, I did not know it was
</I>&gt;<i> possible to not enable them. I checked with command &quot;netstat -tnope&quot;
</I>&gt;<i> and it tells me that it is not enabled.
</I>&gt;<i>
</I>&gt;<i> I suppose that, if for some reason, the communication with the client
</I>&gt;<i> is lost (crash of client, loss of network, etc.) and keepalive is not
</I>&gt;<i> enabled, this may fully explain my problem ?
</I>&gt;<i>
</I>&gt;<i> If yes, do you have an idea of why keepalive is not enabled ? I
</I>&gt;<i> thought that by default on linux it was ?
</I>&gt;<i>
</I>&gt;<i> Many thanks,
</I>&gt;<i> Brice
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Le?ven. 13 nov. 2020 ??15:43, Michael Wojcik
</I>&gt;<i> &lt;<A HREF="../../../mailman/listinfo/openssl-users.html">Michael.Wojcik at microfocus.com</A> &lt;mailto:<A HREF="../../../mailman/listinfo/openssl-users.html">Michael.Wojcik at microfocus.com</A>&lt;mailto:<A HREF="../../../mailman/listinfo/openssl-users.html">Michael.Wojcik at microfocus.com</A>%20%3cmailto:<A HREF="../../../mailman/listinfo/openssl-users.html">Michael.Wojcik at microfocus.com</A>&gt;&gt;&gt;
</I>&gt;<i> a ?crit?:
</I>&gt;<i>
</I>&gt;<i> &gt; From: openssl-users &lt;<A HREF="../../../mailman/listinfo/openssl-users.html">openssl-users-bounces at openssl.org</A>
</I>&lt;mailto:<A HREF="../../../mailman/listinfo/openssl-users.html">openssl-users-bounces at openssl.org</A>%0b&gt;&gt; &lt;mailto:<A HREF="../../../mailman/listinfo/openssl-users.html">openssl-users-bounces at openssl.org</A>&gt;&gt; On Behalf Of Brice Andr?
&gt;<i> &gt; Sent: Friday, 13 November, 2020 05:06
</I>&gt;<i>
</I>&gt;<i> &gt; ... it seems that in some rare execution cases, the server
</I>&gt;<i> performs a SSL_read,
</I>&gt;<i> &gt; the client disconnects in the meantime, and the server never
</I>&gt;<i> detects the
</I>&gt;<i> &gt; disconnection and remains stuck in the SSL_read operation.
</I>&gt;<i>
</I>&gt;<i> ...
</I>&gt;<i>
</I>&gt;<i> &gt; #0? 0x00007f836575d210 in __read_nocancel () from
</I>&gt;<i> /lib/x86_64-linux-gnu/libpthread.so.0
</I>&gt;<i> &gt; #1? 0x00007f8365c8ccec in ?? () from
</I>&gt;<i> /usr/lib/x86_64-linux-gnu/libcrypto.so.1.1
</I>&gt;<i> &gt; #2? 0x00007f8365c8772b in BIO_read () from
</I>&gt;<i> /usr/lib/x86_64-linux-gnu/libcrypto.so.1.1
</I>&gt;<i>
</I>&gt;<i> So OpenSSL is in a blocking read of the socket descriptor.
</I>&gt;<i>
</I>&gt;<i> &gt; tcp? ? ? ? 0? ? ? 0 <A HREF="http://5.196.111.132:5413&lt;http://5.196.111.132:5413">http://5.196.111.132:5413&lt;http://5.196.111.132:5413</A>&gt;
</I>&gt;<i> &lt;<A HREF="http://5.196.111.132:5413&lt;http://5.196.111.132:5413">http://5.196.111.132:5413&lt;http://5.196.111.132:5413</A>&gt;&gt; <A HREF="http://85.27.92.8:25856&lt;http://85.27.92.8:25856">http://85.27.92.8:25856&lt;http://85.27.92.8:25856</A>&gt;
</I>&gt;<i> &lt;<A HREF="http://85.27.92.8:25856&lt;http://85.27.92.8:25856">http://85.27.92.8:25856&lt;http://85.27.92.8:25856</A>&gt;&gt; ? ? ? ESTABLISHED 19218/./MabeeServer
</I>&gt;<i> &gt; tcp? ? ? ? 0? ? ? 0 <A HREF="http://5.196.111.132:5412&lt;http://5.196.111.132:5412">http://5.196.111.132:5412&lt;http://5.196.111.132:5412</A>&gt;
</I>&gt;<i> &lt;<A HREF="http://5.196.111.132:5412&lt;http://5.196.111.132:5412">http://5.196.111.132:5412&lt;http://5.196.111.132:5412</A>&gt;&gt; <A HREF="http://85.27.92.8:26305&lt;http://85.27.92.8:26305">http://85.27.92.8:26305&lt;http://85.27.92.8:26305</A>&gt;
</I>&gt;<i> &lt;<A HREF="http://85.27.92.8:26305&lt;http://85.27.92.8:26305">http://85.27.92.8:26305&lt;http://85.27.92.8:26305</A>&gt;&gt; ? ? ? ESTABLISHED 19218/./MabeeServer
</I>&gt;<i>
</I>&gt;<i> &gt; From this log, I can see that I have two established connections
</I>&gt;<i> with remote
</I>&gt;<i> &gt; client machine on IP 109.133.193.70&lt;<A HREF="http://109.133.193.70">http://109.133.193.70</A>&gt;. Note that it's normal to
</I>&gt;<i> have two connexions
</I>&gt;<i> &gt; because my client-server protocol relies on two distinct TCP
</I>&gt;<i> connexions.
</I>&gt;<i>
</I>&gt;<i> So the client has not, in fact, disconnected.
</I>&gt;<i>
</I>&gt;<i> When a system closes one end of a TCP connection, the stack will
</I>&gt;<i> send a TCP packet
</I>&gt;<i> with either the FIN or the RST flag set. (Which one you get
</I>&gt;<i> depends on whether the
</I>&gt;<i> stack on the closing side was holding data for the conversation
</I>&gt;<i> which the application
</I>&gt;<i> hadn't read.)
</I>&gt;<i>
</I>&gt;<i> The sockets are still in ESTABLISHED state; therefore, no FIN or
</I>&gt;<i> RST has been
</I>&gt;<i> received by the local stack.
</I>&gt;<i>
</I>&gt;<i> There are various possibilities:
</I>&gt;<i>
</I>&gt;<i> - The client system has not in fact closed its end of the
</I>&gt;<i> conversation. Sometimes
</I>&gt;<i> this happens for reasons that aren't immediately apparent; for
</I>&gt;<i> example, if the
</I>&gt;<i> client forked and allowed the descriptor for the conversation
</I>&gt;<i> socket to be inherited
</I>&gt;<i> by the child, and the child still has it open.
</I>&gt;<i>
</I>&gt;<i> - The client system shut down suddenly (crashed) and so couldn't
</I>&gt;<i> send the FIN/RST.
</I>&gt;<i>
</I>&gt;<i> - There was a failure in network connectivity between the two
</I>&gt;<i> systems, and consequently
</I>&gt;<i> the FIN/RST couldn't be received by the local system.
</I>&gt;<i>
</I>&gt;<i> - The connection is in a state where the peer can't send the
</I>&gt;<i> FIN/RST, for example
</I>&gt;<i> because the local side's receive window is zero. That shouldn't be
</I>&gt;<i> the case, since
</I>&gt;<i> OpenSSL is (apparently) blocked in a receive on the connection.
</I>&gt;<i> but as I don't have
</I>&gt;<i> the complete picture I can't rule it out.
</I>&gt;<i>
</I>&gt;<i> &gt; This let me think that the connexion on which the SSL_read is
</I>&gt;<i> listening is
</I>&gt;<i> &gt; definitively dead (no more TCP keepalive)
</I>&gt;<i>
</I>&gt;<i> &quot;definitely dead&quot; doesn't have any meaning in TCP. That's not one
</I>&gt;<i> of the TCP states,
</I>&gt;<i> or part of the other TCP or IP metadata associated with the local
</I>&gt;<i> port (which is
</I>&gt;<i> what matters).
</I>&gt;<i>
</I>&gt;<i> Do you have keepalives enabled?
</I>&gt;<i>
</I>&gt;<i> &gt; and that, for a reason I do not understand, the SSL_read keeps
</I>&gt;<i> blocked into it.
</I>&gt;<i>
</I>&gt;<i> The reason is simple: The connection is still established, but
</I>&gt;<i> there's no data to
</I>&gt;<i> receive. The question isn't why SSL_read is blocking; it's why you
</I>&gt;<i> think the
</I>&gt;<i> connection is gone, but the stack thinks otherwise.
</I>&gt;<i>
</I>&gt;<i> &gt; Note that the normal behavior of my application is : client
</I>&gt;<i> connects, server
</I>&gt;<i> &gt; daemon forks a new instance,
</I>&gt;<i>
</I>&gt;<i> Does the server parent process close its copy of the conversation
</I>&gt;<i> socket?
</I>&gt;<i>
</I>&gt;<i>
</I>

Enjoy

Jakob
--
Jakob Bohm, CIO, Partner, WiseMo A/S. <A HREF="https://www.wisemo.com&lt;https://www.wisemo.com">https://www.wisemo.com&lt;https://www.wisemo.com</A>&gt;
Transformervej 29, 2860 S?borg, Denmark. Direct +45 31 13 16 10
This public discussion message is non-binding and may contain errors.
WiseMo - Remote Service Management for PCs, Phones and Embedded



------------------------------

Subject: Digest Footer

_______________________________________________
openssl-users mailing list
<A HREF="../../../mailman/listinfo/openssl-users.html">openssl-users at openssl.org</A>&lt;mailto:<A HREF="../../../mailman/listinfo/openssl-users.html">openssl-users at openssl.org</A>&gt;
<A HREF="https://mta.openssl.org/mailman/listinfo/openssl-users&lt;https://mta.openssl.org/mailman/listinfo/openssl-users">https://mta.openssl.org/mailman/listinfo/openssl-users&lt;https://mta.openssl.org/mailman/listinfo/openssl-users</A>&gt;


------------------------------

End of openssl-users Digest, Vol 72, Issue 14
*********************************************


-----------------------------------------------------------------------------------------------------------------------
Notice: This e-mail together with any attachments may contain information of Ribbon Communications Inc. that
is confidential and/or proprietary for the sole use of the intended recipient.  Any review, disclosure, reliance or
distribution by others or forwarding without express permission is strictly prohibited.  If you are not the intended
recipient, please notify the sender immediately and then delete all copies, including any attachments.
-----------------------------------------------------------------------------------------------------------------------
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="https://mta.openssl.org/pipermail/openssl-users/attachments/20201119/fe612648/attachment-0001.html">https://mta.openssl.org/pipermail/openssl-users/attachments/20201119/fe612648/attachment-0001.html</A>&gt;
</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="013161.html">Fwd: Re: openssl s_client connection fails
</A></li>
	<LI>Next message: <A HREF="013163.html">set/get utilities are not available  to access  variable 'num' of structure bio_st
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#13162">[ date ]</a>
              <a href="thread.html#13162">[ thread ]</a>
              <a href="subject.html#13162">[ subject ]</a>
              <a href="author.html#13162">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="../../../mailman/listinfo/openssl-users.html">More information about the openssl-users
mailing list</a><br>
</body></html>
