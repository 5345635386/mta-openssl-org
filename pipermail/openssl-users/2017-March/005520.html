<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [openssl-users] how to implement functions for STACK OF custom type?
   </TITLE>
   <LINK REL="Index" HREF="https://mta.openssl.org/pipermail/openssl-users/2017-March/index.html" >
   <LINK REL="made" HREF="mailto:openssl-users%40openssl.org?Subject=Re%3A%20%5Bopenssl-users%5D%20how%20to%20implement%20functions%20for%20STACK%20OF%20custom%0A%20type%3F&In-Reply-To=%3Cba05b59f-f3b9-df98-e034-fe0f71304c06%40rustichelli.net%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="005509.html">
   <LINK REL="Next"  HREF="005472.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[openssl-users] how to implement functions for STACK OF custom type?</H1>
    <B>lists</B> 
    <A HREF="mailto:openssl-users%40openssl.org?Subject=Re%3A%20%5Bopenssl-users%5D%20how%20to%20implement%20functions%20for%20STACK%20OF%20custom%0A%20type%3F&In-Reply-To=%3Cba05b59f-f3b9-df98-e034-fe0f71304c06%40rustichelli.net%3E"
       TITLE="[openssl-users] how to implement functions for STACK OF custom type?">lists at rustichelli.net
       </A><BR>
    <I>Wed Mar 29 10:05:38 UTC 2017</I>
    <P><UL>
        <LI>Previous message: <A HREF="005509.html">[openssl-users] how to implement functions for STACK OF custom type?
</A></li>
        <LI>Next message: <A HREF="005472.html">[openssl-users] regarding memory cleanup at end of each DTLS session
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#5520">[ date ]</a>
              <a href="thread.html#5520">[ thread ]</a>
              <a href="subject.html#5520">[ subject ]</a>
              <a href="author.html#5520">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 03/24/2017 06:46 PM, Dr. Stephen Henson wrote:
&gt;<i> On Tue, Mar 21, 2017, lists wrote:
</I>&gt;<i>
</I> &gt; On Tue, Mar 21, 2017, lists wrote:
 &gt;
 &gt;&gt; [...]
 &gt;&gt; I am exploring my options with OpenSSL and specifically I am trying 
to manage the stacks for some custom objects.
 &gt;&gt; [...]
 &gt;&gt; What am I doing wrong here?
 &gt;
 &gt; [...]
 &gt;
 &gt; For OpenSSL versions before 1.1.0 it's a bit messier. The type specific
 &gt; STACK_OF functions are actually macros which are generated by the 
mkstack.pl
 &gt; script and appear in the safestack.h header file. If you want to 
create your
 &gt; own one way is to extract a type specific section from safestack.h, 
copy it
 &gt; to your own header file and do a search/replace for the new type.
 &gt;
 &gt; So for example extract the sk_OPENSSL_BLOCK macros and replace 
OPENSSL_BLOCK
 &gt; with FOO.
 &gt;
 &gt; Steve.
 &gt; --
 &gt; Dr Stephen N. Henson. OpenSSL project core developer.
 &gt; Commercial tech support now available see: <A HREF="http://www.openssl.org">http://www.openssl.org</A>

Sorry but it seems I still got something wrong, now that I am more 
practically addressing qcStatements (as in RFC 3039, for the moment, not 
yet RFC 3739). I put here almost all of the code because it may be 
useful to some other who want to cover this attribute.
Question number one: is there a document/tutorial about ASN.1 to OpenSSL 
macros mapping?
Question number two: why does the code that I add in the end of the 
message miserably fails when I execute

     const unsigned char *tmpMovingPt = oneExt-&gt;value-&gt;data;
     // d2i_UC_qcStatements returns NULL here! It cannot parse it?
     // Is X509_EXTENSION *oneExt-&gt;value-&gt;data the right thing to pass here?
     qcstt = d2i_UC_qcStatements(NULL, &amp;tmpMovingPt, oneExt-&gt;value-&gt;length);

and I know for sure that X509_EXTENSION *oneExt is qcStatements?
Specifically, the qcStatements should be RFC 3039-compliant because all 
of the entries only have statementId and statementInfo.

Here the rest of the code for OpenSSL 1.0, something must be wrong or 
maybe I have to implement something more:

(.h)

// -- QCStatement

// I use this odd name to avoid confusion with qcStatements (with the 
&quot;s&quot;), for the moment
typedef struct UC_QcsAtom_st
{
     // statementId OBJECT IDENTIFIER
     ASN1_OBJECT *statementId;
     // statementInfo ANY DEFINED BY statementId OPTIONAL
     ASN1_TYPE *statementInfo;
}
     UC_QcsAtom;

DECLARE_STACK_OF(UC_QcsAtom)
DECLARE_ASN1_ITEM(UC_QcsAtom)
DECLARE_ASN1_FUNCTIONS(UC_QcsAtom)

#define sk_UC_QcsAtom_new(cmp) SKM_sk_new(UC_QcsAtom, (cmp))
#define sk_UC_QcsAtom_new_null() SKM_sk_new_null(UC_QcsAtom)
#define sk_UC_QcsAtom_free(st) SKM_sk_free(UC_QcsAtom, (st))
#define sk_UC_QcsAtom_num(st) SKM_sk_num(UC_QcsAtom, (st))
#define sk_UC_QcsAtom_value(st, i) SKM_sk_value(UC_QcsAtom, (st), (i))
#define sk_UC_QcsAtom_set(st, i, val) SKM_sk_set(UC_QcsAtom, (st), (i), 
(val))
[...many more...]

// -- QCStatements

typedef struct UC_qcStatements_st
{
     // SEQUENCE OF QCStatement
     STACK_OF(UC_QcsAtom) *statements_sk;
}
     UC_qcStatements;

DECLARE_ASN1_FUNCTIONS(UC_qcStatements)

(.c)

// -- QCStatament aka UC_QcsAtom

ASN1_SEQUENCE(UC_QcsAtom) = {
     ASN1_SIMPLE(UC_QcsAtom, statementId, ASN1_OBJECT),
     ASN1_OPT(UC_QcsAtom, statementInfo, ASN1_ANY)
} ASN1_SEQUENCE_END(UC_QcsAtom)

IMPLEMENT_ASN1_FUNCTIONS(UC_QcsAtom)
IMPLEMENT_ASN1_DUP_FUNCTION(UC_QcsAtom)
IMPLEMENT_STACK_OF(UC_QcsAtom)

// -- qcStataments aka QCStatements aka UC_qcStatements

ASN1_SEQUENCE(UC_qcStatements) = {
     ASN1_SEQUENCE_OF(UC_qcStatements, statements_sk, UC_QcsAtom)
} ASN1_SEQUENCE_END(UC_qcStatements)

IMPLEMENT_ASN1_FUNCTIONS(UC_qcStatements)
IMPLEMENT_ASN1_DUP_FUNCTION(UC_qcStatements)

/* ...is it required to implement something like this?...:

     UC_QcsAtom *d2i_UC_QcsAtom_bio(BIO *bp, UC_QcsAtom **a)
     {
         return ASN1_d2i_bio_of(UC_QcsAtom, UC_QcsAtom_new, 
d2i_UC_QcsAtom, bp, a);
     }

     etc.?
*/

</PRE>




<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="005509.html">[openssl-users] how to implement functions for STACK OF custom type?
</A></li>
	<LI>Next message: <A HREF="005472.html">[openssl-users] regarding memory cleanup at end of each DTLS session
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#5520">[ date ]</a>
              <a href="thread.html#5520">[ thread ]</a>
              <a href="subject.html#5520">[ subject ]</a>
              <a href="author.html#5520">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="../../../mailman/listinfo/openssl-users.html">More information about the openssl-users
mailing list</a><br>
</body></html>
