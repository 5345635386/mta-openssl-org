<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> DH_generate_key
   </TITLE>
   <LINK REL="Index" HREF="https://mta.openssl.org/pipermail/openssl-users/2020-December/index.html" >
   <LINK REL="made" HREF="mailto:openssl-users%40openssl.org?Subject=Re%3A%20DH_generate_key&In-Reply-To=%3CBL0PR03MB40528EC6462F1AFA540FC1B6B0CB0%40BL0PR03MB4052.namprd03.prod.outlook.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="013213.html">
   <LINK REL="Next"  HREF="013216.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>DH_generate_key</H1>
    <B>Narayana, Sunil Kumar</B> 
    <A HREF="mailto:openssl-users%40openssl.org?Subject=Re%3A%20DH_generate_key&In-Reply-To=%3CBL0PR03MB40528EC6462F1AFA540FC1B6B0CB0%40BL0PR03MB4052.namprd03.prod.outlook.com%3E"
       TITLE="DH_generate_key">sanarayana at rbbn.com
       </A><BR>
    <I>Thu Dec 10 16:14:03 UTC 2020</I>
    <P><UL>
        <LI>Previous message: <A HREF="013213.html">DH_generate_key
</A></li>
        <LI>Next message: <A HREF="013216.html">DH_generate_key
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#13215">[ date ]</a>
              <a href="thread.html#13215">[ thread ]</a>
              <a href="subject.html#13215">[ subject ]</a>
              <a href="author.html#13215">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi Matt,
                Thanks for the code sample. we understood the end to end flow to generate the DH key.
I wanted to understand one more aspect here, In our application we were obtaining two keys (pub_key/ priv_key) from the DH_generate_key() with single values of  dh-&gt;p/ dh-&gt;g.
But now in 3.0 equivalent, I guess we can get only one key from the p/g params right ? how to get equivalent pub_key / priv_key ? please suggest.


Regards,
Sunil
From: openssl-users &lt;<A HREF="../../../mailman/listinfo/openssl-users.html">openssl-users-bounces at openssl.org</A>&gt; On Behalf Of <A HREF="../../../mailman/listinfo/openssl-users.html">openssl-users-request at openssl.org</A>
Sent: 10 December 2020 17:46
To: <A HREF="../../../mailman/listinfo/openssl-users.html">openssl-users at openssl.org</A>
Subject: openssl-users Digest, Vol 73, Issue 9

________________________________
NOTICE: This email was received from an EXTERNAL sender
________________________________

Send openssl-users mailing list submissions to
<A HREF="../../../mailman/listinfo/openssl-users.html">openssl-users at openssl.org</A>&lt;mailto:<A HREF="../../../mailman/listinfo/openssl-users.html">openssl-users at openssl.org</A>&gt;

To subscribe or unsubscribe via the World Wide Web, visit
<A HREF="https://mta.openssl.org/mailman/listinfo/openssl-users&lt;https://mta.openssl.org/mailman/listinfo/openssl-users">https://mta.openssl.org/mailman/listinfo/openssl-users&lt;https://mta.openssl.org/mailman/listinfo/openssl-users</A>&gt;
or, via email, send a message with subject or body 'help' to
<A HREF="../../../mailman/listinfo/openssl-users.html">openssl-users-request at openssl.org</A>&lt;mailto:<A HREF="../../../mailman/listinfo/openssl-users.html">openssl-users-request at openssl.org</A>&gt;

You can reach the person managing the list at
<A HREF="../../../mailman/listinfo/openssl-users.html">openssl-users-owner at openssl.org</A>&lt;mailto:<A HREF="../../../mailman/listinfo/openssl-users.html">openssl-users-owner at openssl.org</A>&gt;

When replying, please edit your Subject line so it is more specific
than &quot;Re: Contents of openssl-users digest...&quot;


Today's Topics:

1. Re: DH_generate_key (Matt Caswell)
2. Re: creating certificate by code / problems to load via
openssl x509 / pem format (Andreas Tengicki)
3. Re: creating certificate by code / problems to load via
openssl x509 / pem format (Tomas Mraz)
4. Re: DH_generate_key (Matt Caswell)


----------------------------------------------------------------------

Message: 1
Date: Wed, 9 Dec 2020 15:31:51 +0000
From: Matt Caswell &lt;<A HREF="../../../mailman/listinfo/openssl-users.html">matt at openssl.org</A>&lt;mailto:<A HREF="../../../mailman/listinfo/openssl-users.html">matt at openssl.org</A>&gt;&gt;
To: &quot;Narayana, Sunil Kumar&quot; &lt;<A HREF="../../../mailman/listinfo/openssl-users.html">sanarayana at rbbn.com</A>&lt;mailto:<A HREF="../../../mailman/listinfo/openssl-users.html">sanarayana at rbbn.com</A>&gt;&gt;,
&quot;<A HREF="../../../mailman/listinfo/openssl-users.html">openssl-users at openssl.org</A>&lt;mailto:<A HREF="../../../mailman/listinfo/openssl-users.html">openssl-users at openssl.org</A>&gt;&quot; &lt;<A HREF="../../../mailman/listinfo/openssl-users.html">openssl-users at openssl.org</A>&lt;mailto:<A HREF="../../../mailman/listinfo/openssl-users.html">openssl-users at openssl.org</A>&gt;&gt;
Subject: Re: DH_generate_key
Message-ID: &lt;<A HREF="../../../mailman/listinfo/openssl-users.html">72867e9d-4e91-faa0-d329-1f92ed723b0e at openssl.org</A>&lt;mailto:<A HREF="../../../mailman/listinfo/openssl-users.html">72867e9d-4e91-faa0-d329-1f92ed723b0e at openssl.org</A>&gt;&gt;
Content-Type: text/plain; charset=utf-8



On 08/12/2020 17:43, Narayana, Sunil Kumar wrote:
&gt;<i> Dear openssl team,
</I>&gt;<i>
</I>&gt;<i> ?
</I>&gt;<i>
</I>&gt;<i> ??????????????? While migrating from 1.0.2 to 3.0, ?we found that
</I>&gt;<i> DH_generate_key() has be deprecated. And as per the man page, it is
</I>&gt;<i> advised to use EVP_PKEY_derive_init
</I>&gt;<i> &lt;<A HREF="https://www.openssl.org/docs/manmaster/man3/EVP_PKEY_derive_init.html&lt;https://www.openssl.org/docs/manmaster/man3/EVP_PKEY_derive_init.html">https://www.openssl.org/docs/manmaster/man3/EVP_PKEY_derive_init.html&lt;https://www.openssl.org/docs/manmaster/man3/EVP_PKEY_derive_init.html</A>&gt;&gt;
</I>&gt;<i> ?&amp; EVP_PKEY_derive
</I>&gt;<i> &lt;<A HREF="https://www.openssl.org/docs/manmaster/man3/EVP_PKEY_derive.html&lt;https://www.openssl.org/docs/manmaster/man3/EVP_PKEY_derive.html">https://www.openssl.org/docs/manmaster/man3/EVP_PKEY_derive.html&lt;https://www.openssl.org/docs/manmaster/man3/EVP_PKEY_derive.html</A>&gt;&gt;
</I>&gt;<i>
</I>
The reference to EVP_PKEY_derive_init/EVP_PKEY_derive is a bit
misleading, because those are replacements for DH_compute_key() not
DH_generate_key().

The equivalents for DH_generate_key() are EVP_PKEY_keygen_init() and
EVP_PKEY_gen().

<A HREF="https://www.openssl.org/docs/manmaster/man3/EVP_PKEY_gen.html&lt;https://www.openssl.org/docs/manmaster/man3/EVP_PKEY_gen.html">https://www.openssl.org/docs/manmaster/man3/EVP_PKEY_gen.html&lt;https://www.openssl.org/docs/manmaster/man3/EVP_PKEY_gen.html</A>&gt;



&gt;<i> our application creates a new DH and using DH_generate_key()
</I>
How do you set up the DH parameters? Do you load them from a file or
generate them in your application? Or some other way? Will it break your
application if you swap to using different parameters, or must you
retain support for the old ones?

The first step is to create an EVP_PKEY object containing the DH
parameters. How to do that depends on the answers to the above questions.


&gt;<i> creates
</I>&gt;<i> pub_key/priv_key and uses it. how can we replace this exactly with EVP.
</I>&gt;<i>
</I>

As noted by Daniel in this response to your question there are examples
on the EVP_PKEY-DH manual page.

<A HREF="https://www.openssl.org/docs/manmaster/man7/EVP_PKEY-DH.html&lt;https://www.openssl.org/docs/manmaster/man7/EVP_PKEY-DH.html">https://www.openssl.org/docs/manmaster/man7/EVP_PKEY-DH.html&lt;https://www.openssl.org/docs/manmaster/man7/EVP_PKEY-DH.html</A>&gt;

Assuming you have set up the parameters in an EVP_PKEY object
(param_key) then this is the relevant example:


EVP_PKEY *key = NULL;
EVP_PKEY_CTX *gctx = EVP_PKEY_CTX_new_from_pkey(NULL, param_key, NULL);

EVP_PKEY_keygen_init(gctx);
EVP_PKEY_gen(gctx, &amp;key);
EVP_PKEY_print_private(bio_out, key, 0, NULL);
...
EVP_PKEY_free(key);
EVP_PKEY_CTX_free(gctx);


This gives you a generated DH key in the &quot;key&quot; object.


Matt


&gt;<i> And please suggest what EVP API?s should we use to generate pub/priv keys ?
</I>&gt;<i>
</I>&gt;<i> ?
</I>&gt;<i>
</I>&gt;<i> _Application code_
</I>&gt;<i>
</I>&gt;<i> _?_
</I>&gt;<i>
</I>&gt;<i> ??? dh = DH_new();
</I>&gt;<i>
</I>&gt;<i> ??? dh-&gt;p = BN_bin2bn(modSize, octet_len, NULL);
</I>&gt;<i>
</I>&gt;<i> ??? dh-&gt;g = BN_bin2bn(H235Bits_generator, H235Bits_generator_len / 8, NULL);
</I>&gt;<i>
</I>&gt;<i> ?
</I>&gt;<i>
</I>&gt;<i> ??? if ( ! DH_generate_key(dh) )
</I>&gt;<i>
</I>&gt;<i> ??? {
</I>&gt;<i>
</I>&gt;<i> ??????? return FAILURE;
</I>&gt;<i>
</I>&gt;<i> ??? }
</I>&gt;<i>
</I>&gt;<i> ??? n = (unsigned) BN_num_bytes(dh-&gt;pub_key);
</I>&gt;<i>
</I>&gt;<i> ??
</I>&gt;<i>
</I>&gt;<i> ????BN_bn2bin(dh-&gt;pub_key, p);
</I>&gt;<i>
</I>&gt;<i> ??? n = (unsigned) BN_num_bytes(dh-&gt;priv_key);
</I>&gt;<i>
</I>&gt;<i> ?
</I>&gt;<i>
</I>&gt;<i> ?
</I>&gt;<i>
</I>&gt;<i> Instead above logic can we do this ? is derive generated pub/priv keys ?
</I>&gt;<i>
</I>&gt;<i> ?
</I>&gt;<i>
</I>&gt;<i> //create ctx
</I>&gt;<i>
</I>&gt;<i> Ctx = EVP_PKEY_CTX_new_from_name (NULL, ?DM?, NULL);
</I>&gt;<i>
</I>&gt;<i> EVP_PKEY_derive_init (ctx)
</I>&gt;<i>
</I>&gt;<i> ?
</I>&gt;<i>
</I>&gt;<i> ?
</I>&gt;<i>
</I>&gt;<i> Regards,
</I>&gt;<i>
</I>&gt;<i> Sunil
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> ------------------------------------------------------------------------
</I>&gt;<i> Notice: This e-mail together with any attachments may contain
</I>&gt;<i> information of Ribbon Communications Inc. that is confidential and/or
</I>&gt;<i> proprietary for the sole use of the intended recipient. Any review,
</I>&gt;<i> disclosure, reliance or distribution by others or forwarding without
</I>&gt;<i> express permission is strictly prohibited. If you are not the intended
</I>&gt;<i> recipient, please notify the sender immediately and then delete all
</I>&gt;<i> copies, including any attachments.
</I>&gt;<i> ------------------------------------------------------------------------
</I>

------------------------------

Message: 2
Date: Thu, 10 Dec 2020 10:39:06 +0100
From: Andreas Tengicki &lt;<A HREF="../../../mailman/listinfo/openssl-users.html">tengicki at autopoll.de</A>&lt;mailto:<A HREF="../../../mailman/listinfo/openssl-users.html">tengicki at autopoll.de</A>&gt;&gt;
To: <A HREF="../../../mailman/listinfo/openssl-users.html">openssl-users at openssl.org</A>&lt;mailto:<A HREF="../../../mailman/listinfo/openssl-users.html">openssl-users at openssl.org</A>&gt;
Subject: Re: creating certificate by code / problems to load via
openssl x509 / pem format
Message-ID: &lt;<A HREF="../../../mailman/listinfo/openssl-users.html">009adab4-57a9-4132-f6f5-43d60946faf4 at autopoll.de</A>&lt;mailto:<A HREF="../../../mailman/listinfo/openssl-users.html">009adab4-57a9-4132-f6f5-43d60946faf4 at autopoll.de</A>&gt;&gt;
Content-Type: text/plain; charset=&quot;utf-8&quot;; Format=&quot;flowed&quot;

The solution was to choice a EVP by signing the certificate

i = X509_sign(x, CApkey, EVP_sha256());

Best regards

? Andreas

Am 09.07.2020 um 11:09 schrieb Andreas Tengicki:
&gt;<i>
</I>&gt;<i> Hello,
</I>&gt;<i>
</I>&gt;<i> your first help in this project, helps much, but now some weeks later,
</I>&gt;<i> there is a new problem, and I cannot find any tipps via google.
</I>&gt;<i>
</I>&gt;<i> For all the coding a have looked into the openssl examples.
</I>&gt;<i>
</I>&gt;<i> I create a private key per code, the &quot;openssl rsa -in
</I>&gt;<i> test_privatekey.pem -check&quot; is fine
</I>&gt;<i>
</I>&gt;<i> I create a certificate request per code, &quot;openssl req -text -noout
</I>&gt;<i> -verify -in test_request.pem&quot; is fine
</I>&gt;<i>
</I>&gt;<i> I create a certifcate via this reqeust and store it with
</I>&gt;<i> &quot;PEM_write_bio_X509(out, crt);&quot; like the others. (some more code below)
</I>&gt;<i>
</I>&gt;<i> Perhaps there is something wrong, but to detect this, I will use the
</I>&gt;<i> validation, but it cannot load the certificate to validate it:
</I>&gt;<i>
</I>&gt;<i> &gt;&gt; openssl x509 -in test_certificate.pem -text
</I>&gt;<i> unable to load certificate
</I>&gt;<i> 140180222239872:error:0D07209B:asn1 encoding
</I>&gt;<i> routines:ASN1_get_object:too long:../crypto/asn1/asn1_lib.c:91:
</I>&gt;<i> 140180222239872:error:0D068066:asn1 encoding
</I>&gt;<i> routines:asn1_check_tlen:bad object header:../crypto/asn1/tasn_dec.c:1118:
</I>&gt;<i> 140180222239872:error:0D07803A:asn1 encoding
</I>&gt;<i> routines:asn1_item_embed_d2i:nested asn1
</I>&gt;<i> error:../crypto/asn1/tasn_dec.c:190:Type=ASN1_TIME
</I>&gt;<i> 140180222239872:error:0D08303A:asn1 encoding
</I>&gt;<i> routines:asn1_template_noexp_d2i:nested asn1
</I>&gt;<i> error:../crypto/asn1/tasn_dec.c:627:Field=notBefore, Type=X509_VAL
</I>&gt;<i> 140180222239872:error:0D08303A:asn1 encoding
</I>&gt;<i> routines:asn1_template_noexp_d2i:nested asn1
</I>&gt;<i> error:../crypto/asn1/tasn_dec.c:627:Field=validity, Type=X509_CINF
</I>&gt;<i> 140180222239872:error:0D08303A:asn1 encoding
</I>&gt;<i> routines:asn1_template_noexp_d2i:nested asn1
</I>&gt;<i> error:../crypto/asn1/tasn_dec.c:627:Field=cert_info, Type=X509
</I>&gt;<i> 140180222239872:error:0906700D:PEM routines:PEM_ASN1_read_bio:ASN1
</I>&gt;<i> lib:../crypto/pem/pem_oth.c:33:
</I>&gt;<i>
</I>&gt;<i> Thanks for any help.
</I>&gt;<i>
</I>&gt;<i> Best regards
</I>&gt;<i>
</I>&gt;<i> ? Andreas
</I>&gt;<i>
</I>&gt;<i> ----
</I>&gt;<i>
</I>&gt;<i> ErrorHandling should be added in a second step, first debug outputs (I
</I>&gt;<i> have deleted for here) says everything is created
</I>&gt;<i>
</I>&gt;<i> X509* certificate_create(const X509_REQ* req)
</I>&gt;<i> {
</I>&gt;<i> ? //openssl x509 -req -days 365 -sha256 -in server.csr -CA ca.crt
</I>&gt;<i> -CAkey ca.key -CAcreateserial -out server.crt
</I>&gt;<i>
</I>&gt;<i> ? if ((crt = X509_new()) == NULL);
</I>&gt;<i> ? //xca = load_cert(CAfile, CAformat, &quot;CA Certificate&quot;);
</I>&gt;<i> ? BIO *bio = NULL;
</I>&gt;<i> ? bio = BIO_new_file(CAfile, &quot;r&quot;);
</I>&gt;<i> ? xca = PEM_read_bio_X509_AUX(bio, NULL, NULL, NULL);
</I>&gt;<i> ? BIO_free(bio);
</I>&gt;<i>
</I>&gt;<i> ? upkey = X509_get0_pubkey(xca);
</I>&gt;<i>
</I>&gt;<i> ? char CAkeyile[] = &quot;ca.key&quot;;
</I>&gt;<i> ? int CAkeyformat = 5; //FORMAT_PEM
</I>&gt;<i> ? char passin[] = &quot;xyz&quot;;
</I>&gt;<i>
</I>&gt;<i> ? ENGINE *e = NULL;
</I>&gt;<i> ? EVP_PKEY * CApkey = NULL;
</I>&gt;<i> ? //CApkey = load_key(CAkeyfile, CAkeyformat, 0, passin, e, &quot;CA
</I>&gt;<i> Private Key&quot;);
</I>&gt;<i> ? bio = BIO_new_file(CAkeyile, &quot;r&quot;);
</I>&gt;<i> ? CApkey = PEM_read_bio_PrivateKey(bio, NULL, NULL, passin);
</I>&gt;<i> ? BIO_free(bio);
</I>&gt;<i>
</I>&gt;<i> ? EVP_PKEY_copy_parameters(upkey, CApkey);
</I>&gt;<i>
</I>&gt;<i> ? X509_STORE *ctx = NULL;
</I>&gt;<i> ? ctx = X509_STORE_new();
</I>&gt;<i>
</I>&gt;<i> ? X509_STORE_CTX *xsc = NULL;
</I>&gt;<i> ? xsc = X509_STORE_CTX_new();
</I>&gt;<i> ? if (xsc == NULL || !X509_STORE_CTX_init(xsc, ctx, crt, NULL));
</I>&gt;<i>
</I>&gt;<i> ? ASN1_INTEGER *serialno = NULL;
</I>&gt;<i> ? serialno = ASN1_INTEGER_new();
</I>&gt;<i> ? BIGNUM *btmp = NULL;
</I>&gt;<i> ? btmp = BN_new();
</I>&gt;<i>
</I>&gt;<i> ? # define SERIAL_RAND_BITS??????? 159
</I>&gt;<i> ? if (!BN_rand(btmp, SERIAL_RAND_BITS, BN_RAND_TOP_ANY,
</I>&gt;<i> BN_RAND_BOTTOM_ANY));
</I>&gt;<i> ? if (!BN_to_ASN1_INTEGER(btmp, serialno));
</I>&gt;<i> ? BN_free(btmp);
</I>&gt;<i>
</I>&gt;<i> X509_STORE_CTX_set_cert(xsc, crt);
</I>&gt;<i> ? X509_STORE_CTX_set_flags(xsc, X509_V_FLAG_CHECK_SS_SIGNATURE);
</I>&gt;<i>
</I>&gt;<i> ? if (!X509_check_private_key(xca, CApkey)) ;
</I>&gt;<i>
</I>&gt;<i> ? if (!X509_set_issuer_name(crt, X509_get_subject_name(xca)));
</I>&gt;<i> ? if (!X509_set_serialNumber(crt, serialno));
</I>&gt;<i>
</I>&gt;<i> ? int days = 365;
</I>&gt;<i> ? if (X509_time_adj_ex(X509_getm_notAfter(crt), days, 0, NULL) == NULL);
</I>&gt;<i>
</I>&gt;<i> ? const char digestname[] = &quot;sha256&quot;;
</I>&gt;<i> ? const EVP_MD* md = EVP_get_digestbyname(digestname);
</I>&gt;<i> ? EVP_MD_CTX *mctx = EVP_MD_CTX_new();
</I>&gt;<i> ? EVP_PKEY_CTX *pkctx = NULL;
</I>&gt;<i> ? EVP_DigestSignInit(mctx, &amp;pkctx, md, NULL, CApkey); //ist CApkey
</I>&gt;<i> hier der richtige private Key? sollte eigentlich
</I>&gt;<i> ? int rv = (X509_sign_ctx(crt, mctx) &gt; 0);
</I>&gt;<i> ? EVP_MD_CTX_free(mctx);
</I>&gt;<i>
</I>&gt;<i> ? BIO *out = NULL;
</I>&gt;<i> ? out = BIO_new_file(&quot;test_certificate.pem&quot;, &quot;w&quot;);
</I>&gt;<i> ? PEM_write_bio_X509(out, crt);
</I>&gt;<i> ? BIO_free_all(out);
</I>&gt;<i>
</I>&gt;<i> ? ...some more frees ...
</I>&gt;<i> ? return crt;
</I>&gt;<i> }
</I>&gt;<i>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="https://mta.openssl.org/pipermail/openssl-users/attachments/20201210/897e5d1b/attachment-0001.html&lt;https://mta.openssl.org/pipermail/openssl-users/attachments/20201210/897e5d1b/attachment-0001.html">https://mta.openssl.org/pipermail/openssl-users/attachments/20201210/897e5d1b/attachment-0001.html&lt;https://mta.openssl.org/pipermail/openssl-users/attachments/20201210/897e5d1b/attachment-0001.html</A>&gt;&gt;

------------------------------

Message: 3
Date: Thu, 10 Dec 2020 11:42:37 +0100
From: Tomas Mraz &lt;<A HREF="../../../mailman/listinfo/openssl-users.html">tmraz at redhat.com</A>&lt;mailto:<A HREF="../../../mailman/listinfo/openssl-users.html">tmraz at redhat.com</A>&gt;&gt;
To: Andreas Tengicki &lt;<A HREF="../../../mailman/listinfo/openssl-users.html">tengicki at autopoll.de</A>&lt;mailto:<A HREF="../../../mailman/listinfo/openssl-users.html">tengicki at autopoll.de</A>&gt;&gt;, <A HREF="../../../mailman/listinfo/openssl-users.html">openssl-users at openssl.org</A>&lt;mailto:<A HREF="../../../mailman/listinfo/openssl-users.html">openssl-users at openssl.org</A>&gt;
Subject: Re: creating certificate by code / problems to load via
openssl x509 / pem format
Message-ID:
&lt;<A HREF="../../../mailman/listinfo/openssl-users.html">a5196a1bd4dcd8175448e8689d6396231d23097a.camel at redhat.com</A>&lt;mailto:<A HREF="../../../mailman/listinfo/openssl-users.html">a5196a1bd4dcd8175448e8689d6396231d23097a.camel at redhat.com</A>&gt;&gt;
Content-Type: text/plain; charset=&quot;UTF-8&quot;

On Thu, 2020-12-10 at 10:39 +0100, Andreas Tengicki wrote:
&gt;<i> The solution was to choice a EVP by signing the certificate
</I>&gt;<i>
</I>&gt;<i> i = X509_sign(x, CApkey, EVP_sha256());
</I>
I do not really think this was the problem. In the code below you do
not set the notBefore time which is actually indicated by the parsing
errors when you try to load the invalid certificate.

&gt;<i> Best regards
</I>&gt;<i>
</I>&gt;<i> Andreas
</I>&gt;<i>
</I>&gt;<i> Am 09.07.2020 um 11:09 schrieb Andreas Tengicki:
</I>&gt;<i> &gt; Hello,
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; your first help in this project, helps much, but now some weeks
</I>&gt;<i> &gt; later, there is a new problem, and I cannot find any tipps via
</I>&gt;<i> &gt; google.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; For all the coding a have looked into the openssl examples.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; I create a private key per code, the &quot;openssl rsa -in
</I>&gt;<i> &gt; test_privatekey.pem -check&quot; is fine
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; I create a certificate request per code, &quot;openssl req -text -noout
</I>&gt;<i> &gt; -verify -in test_request.pem&quot; is fine
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; I create a certifcate via this reqeust and store it with
</I>&gt;<i> &gt; &quot;PEM_write_bio_X509(out, crt);&quot; like the others. (some more code
</I>&gt;<i> &gt; below)
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Perhaps there is something wrong, but to detect this, I will use
</I>&gt;<i> &gt; the validation, but it cannot load the certificate to validate it:
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; &gt;&gt; openssl x509 -in test_certificate.pem -text
</I>&gt;<i> &gt; unable to load certificate
</I>&gt;<i> &gt; 140180222239872:error:0D07209B:asn1 encoding
</I>&gt;<i> &gt; routines:ASN1_get_object:too long:../crypto/asn1/asn1_lib.c:91:
</I>&gt;<i> &gt; 140180222239872:error:0D068066:asn1 encoding
</I>&gt;<i> &gt; routines:asn1_check_tlen:bad object
</I>&gt;<i> &gt; header:../crypto/asn1/tasn_dec.c:1118:
</I>&gt;<i> &gt; 140180222239872:error:0D07803A:asn1 encoding
</I>&gt;<i> &gt; routines:asn1_item_embed_d2i:nested asn1
</I>&gt;<i> &gt; error:../crypto/asn1/tasn_dec.c:190:Type=ASN1_TIME
</I>&gt;<i> &gt; 140180222239872:error:0D08303A:asn1 encoding
</I>&gt;<i> &gt; routines:asn1_template_noexp_d2i:nested asn1
</I>&gt;<i> &gt; error:../crypto/asn1/tasn_dec.c:627:Field=notBefore, Type=X509_VAL
</I>&gt;<i> &gt; 140180222239872:error:0D08303A:asn1 encoding
</I>&gt;<i> &gt; routines:asn1_template_noexp_d2i:nested asn1
</I>&gt;<i> &gt; error:../crypto/asn1/tasn_dec.c:627:Field=validity, Type=X509_CINF
</I>&gt;<i> &gt; 140180222239872:error:0D08303A:asn1 encoding
</I>&gt;<i> &gt; routines:asn1_template_noexp_d2i:nested asn1
</I>&gt;<i> &gt; error:../crypto/asn1/tasn_dec.c:627:Field=cert_info, Type=X509
</I>&gt;<i> &gt; 140180222239872:error:0906700D:PEM routines:PEM_ASN1_read_bio:ASN1
</I>&gt;<i> &gt; lib:../crypto/pem/pem_oth.c:33:
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Thanks for any help.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Best regards
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Andreas
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; ----
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; ErrorHandling should be added in a second step, first debug outputs
</I>&gt;<i> &gt; (I have deleted for here) says everything is created
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; X509* certificate_create(const X509_REQ* req)
</I>&gt;<i> &gt; {
</I>&gt;<i> &gt; //openssl x509 -req -days 365 -sha256 -in server.csr -CA ca.crt
</I>&gt;<i> &gt; -CAkey ca.key -CAcreateserial -out server.crt
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; if ((crt = X509_new()) == NULL);
</I>&gt;<i> &gt; //xca = load_cert(CAfile, CAformat, &quot;CA Certificate&quot;);
</I>&gt;<i> &gt; BIO *bio = NULL;
</I>&gt;<i> &gt; bio = BIO_new_file(CAfile, &quot;r&quot;);
</I>&gt;<i> &gt; xca = PEM_read_bio_X509_AUX(bio, NULL, NULL, NULL);
</I>&gt;<i> &gt; BIO_free(bio);
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; upkey = X509_get0_pubkey(xca);
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; char CAkeyile[] = &quot;ca.key&quot;;
</I>&gt;<i> &gt; int CAkeyformat = 5; //FORMAT_PEM
</I>&gt;<i> &gt; char passin[] = &quot;xyz&quot;;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; ENGINE *e = NULL;
</I>&gt;<i> &gt; EVP_PKEY * CApkey = NULL;
</I>&gt;<i> &gt; //CApkey = load_key(CAkeyfile, CAkeyformat, 0, passin, e, &quot;CA
</I>&gt;<i> &gt; Private Key&quot;);
</I>&gt;<i> &gt; bio = BIO_new_file(CAkeyile, &quot;r&quot;);
</I>&gt;<i> &gt; CApkey = PEM_read_bio_PrivateKey(bio, NULL, NULL, passin);
</I>&gt;<i> &gt; BIO_free(bio);
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; EVP_PKEY_copy_parameters(upkey, CApkey);
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; X509_STORE *ctx = NULL;
</I>&gt;<i> &gt; ctx = X509_STORE_new();
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; X509_STORE_CTX *xsc = NULL;
</I>&gt;<i> &gt; xsc = X509_STORE_CTX_new();
</I>&gt;<i> &gt; if (xsc == NULL || !X509_STORE_CTX_init(xsc, ctx, crt, NULL));
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; ASN1_INTEGER *serialno = NULL;
</I>&gt;<i> &gt; serialno = ASN1_INTEGER_new();
</I>&gt;<i> &gt; BIGNUM *btmp = NULL;
</I>&gt;<i> &gt; btmp = BN_new();
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; # define SERIAL_RAND_BITS 159
</I>&gt;<i> &gt; if (!BN_rand(btmp, SERIAL_RAND_BITS, BN_RAND_TOP_ANY,
</I>&gt;<i> &gt; BN_RAND_BOTTOM_ANY));
</I>&gt;<i> &gt; if (!BN_to_ASN1_INTEGER(btmp, serialno));
</I>&gt;<i> &gt; BN_free(btmp);
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; X509_STORE_CTX_set_cert(xsc, crt);
</I>&gt;<i> &gt; X509_STORE_CTX_set_flags(xsc, X509_V_FLAG_CHECK_SS_SIGNATURE);
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; if (!X509_check_private_key(xca, CApkey)) ;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; if (!X509_set_issuer_name(crt, X509_get_subject_name(xca)));
</I>&gt;<i> &gt; if (!X509_set_serialNumber(crt, serialno));
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; int days = 365;
</I>&gt;<i> &gt; if (X509_time_adj_ex(X509_getm_notAfter(crt), days, 0, NULL) ==
</I>&gt;<i> &gt; NULL);
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; const char digestname[] = &quot;sha256&quot;;
</I>&gt;<i> &gt; const EVP_MD* md = EVP_get_digestbyname(digestname);
</I>&gt;<i> &gt; EVP_MD_CTX *mctx = EVP_MD_CTX_new();
</I>&gt;<i> &gt; EVP_PKEY_CTX *pkctx = NULL;
</I>&gt;<i> &gt; EVP_DigestSignInit(mctx, &amp;pkctx, md, NULL, CApkey); //ist CApkey
</I>&gt;<i> &gt; hier der richtige private Key? sollte eigentlich
</I>&gt;<i> &gt; int rv = (X509_sign_ctx(crt, mctx) &gt; 0);
</I>&gt;<i> &gt; EVP_MD_CTX_free(mctx);
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; BIO *out = NULL;
</I>&gt;<i> &gt; out = BIO_new_file(&quot;test_certificate.pem&quot;, &quot;w&quot;);
</I>&gt;<i> &gt; PEM_write_bio_X509(out, crt);
</I>&gt;<i> &gt; BIO_free_all(out);
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; ...some more frees ...
</I>&gt;<i> &gt; return crt;
</I>&gt;<i> &gt; }
</I>&gt;<i> &gt;
</I>--
Tom?? Mr?z
No matter how far down the wrong road you've gone, turn back.
Turkish proverb
[You'll know whether the road is wrong if you carefully listen to your
conscience.]




------------------------------

Message: 4
Date: Thu, 10 Dec 2020 12:16:11 +0000
From: Matt Caswell &lt;<A HREF="../../../mailman/listinfo/openssl-users.html">matt at openssl.org</A>&lt;mailto:<A HREF="../../../mailman/listinfo/openssl-users.html">matt at openssl.org</A>&gt;&gt;
To: &quot;Narayana, Sunil Kumar&quot; &lt;<A HREF="../../../mailman/listinfo/openssl-users.html">sanarayana at rbbn.com</A>&lt;mailto:<A HREF="../../../mailman/listinfo/openssl-users.html">sanarayana at rbbn.com</A>&gt;&gt;,
&quot;<A HREF="../../../mailman/listinfo/openssl-users.html">openssl-users at openssl.org</A>&lt;mailto:<A HREF="../../../mailman/listinfo/openssl-users.html">openssl-users at openssl.org</A>&gt;&quot; &lt;<A HREF="../../../mailman/listinfo/openssl-users.html">openssl-users at openssl.org</A>&lt;mailto:<A HREF="../../../mailman/listinfo/openssl-users.html">openssl-users at openssl.org</A>&gt;&gt;
Subject: Re: DH_generate_key
Message-ID: &lt;<A HREF="../../../mailman/listinfo/openssl-users.html">0d2eb472-d8d8-0272-e992-8e5c37082f0e at openssl.org</A>&lt;mailto:<A HREF="../../../mailman/listinfo/openssl-users.html">0d2eb472-d8d8-0272-e992-8e5c37082f0e at openssl.org</A>&gt;&gt;
Content-Type: text/plain; charset=utf-8



On 09/12/2020 15:31, Matt Caswell wrote:
&gt;&gt;<i> our application creates a new DH and using DH_generate_key()
</I>&gt;<i>
</I>&gt;<i> How do you set up the DH parameters? Do you load them from a file or
</I>&gt;<i> generate them in your application? Or some other way? Will it break your
</I>&gt;<i> application if you swap to using different parameters, or must you
</I>&gt;<i> retain support for the old ones?
</I>&gt;<i>
</I>&gt;<i> The first step is to create an EVP_PKEY object containing the DH
</I>&gt;<i> parameters. How to do that depends on the answers to the above questions.
</I>
Sunil emailed me directly (off list) and provided some code samples.

So you have some fixed &quot;p&quot; and &quot;g&quot; parameter values defined as static
unsigned char arrays, which you are currently converting to BIGNUMs
using &quot;BN_bin2bn&quot;, and then assigning to &quot;dh-&gt;p&quot; and &quot;dh-&gt;g&quot; respectively.

The &quot;g&quot; value is just &quot;2&quot;, so in the 3.0 equivalent you don't need to
convert that to a BIGNUM first. Some equivalent code to construct a DH
params object (called &quot;param_key&quot; in the code below) is:


EVP_PKEY_CTX *pctx = EVP_PKEY_CTX_new_from_name(NULL, &quot;DH&quot;, NULL);
OSSL_PARAM_BLD *tmpl = NULL;
OSSL_PARAM *params = NULL;
EVP_PKEY *param_key = NULL;

if (pctx == NULL || !EVP_PKEY_key_fromdata_init(pctx))
goto err;

if ((tmpl = OSSL_PARAM_BLD_new()) == NULL
||<i> !OSSL_PARAM_BLD_push_BN(tmpl, OSSL_PKEY_PARAM_FFC_P, p)
</I>||<i> !OSSL_PARAM_BLD_push_uint(tmpl, OSSL_PKEY_PARAM_FFC_G, 2))
</I>goto err;

params = OSSL_PARAM_BLD_to_param(tmpl);
if (params == NULL || !EVP_PKEY_fromdata(pctx, &amp;param_key, params))
goto err;
err:
EVP_PKEY_CTX_free(pctx);
OSSL_PARAM_BLD_free_params(params);
OSSL_PARAM_BLD_free(tmpl);


You can then generate the key using the code sample I gave in my
previous email:

EVP_PKEY *key = NULL;
EVP_PKEY_CTX *gctx = EVP_PKEY_CTX_new_from_pkey(NULL, param_key, NULL);

EVP_PKEY_keygen_init(gctx);
EVP_PKEY_gen(gctx, &amp;key);
EVP_PKEY_print_private(bio_out, key, 0, NULL);
...
EVP_PKEY_free(key);
EVP_PKEY_CTX_free(gctx);



Hope that helps,

Matt


------------------------------

Subject: Digest Footer

_______________________________________________
openssl-users mailing list
<A HREF="../../../mailman/listinfo/openssl-users.html">openssl-users at openssl.org</A>&lt;mailto:<A HREF="../../../mailman/listinfo/openssl-users.html">openssl-users at openssl.org</A>&gt;
<A HREF="https://mta.openssl.org/mailman/listinfo/openssl-users&lt;https://mta.openssl.org/mailman/listinfo/openssl-users">https://mta.openssl.org/mailman/listinfo/openssl-users&lt;https://mta.openssl.org/mailman/listinfo/openssl-users</A>&gt;


------------------------------

End of openssl-users Digest, Vol 73, Issue 9
********************************************


-----------------------------------------------------------------------------------------------------------------------
Notice: This e-mail together with any attachments may contain information of Ribbon Communications Inc. that
is confidential and/or proprietary for the sole use of the intended recipient.  Any review, disclosure, reliance or
distribution by others or forwarding without express permission is strictly prohibited.  If you are not the intended
recipient, please notify the sender immediately and then delete all copies, including any attachments.
-----------------------------------------------------------------------------------------------------------------------
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="https://mta.openssl.org/pipermail/openssl-users/attachments/20201210/8a336b83/attachment-0001.html">https://mta.openssl.org/pipermail/openssl-users/attachments/20201210/8a336b83/attachment-0001.html</A>&gt;
</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="013213.html">DH_generate_key
</A></li>
	<LI>Next message: <A HREF="013216.html">DH_generate_key
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#13215">[ date ]</a>
              <a href="thread.html#13215">[ thread ]</a>
              <a href="subject.html#13215">[ subject ]</a>
              <a href="author.html#13215">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="../../../mailman/listinfo/openssl-users.html">More information about the openssl-users
mailing list</a><br>
</body></html>
