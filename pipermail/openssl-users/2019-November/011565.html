<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> CMS with ECC Keys is incompatibel to Windows CMS / Outlook
   </TITLE>
   <LINK REL="Index" HREF="https://mta.openssl.org/pipermail/openssl-users/2019-November/index.html" >
   <LINK REL="made" HREF="mailto:openssl-users%40openssl.org?Subject=Re%3A%20CMS%20with%20ECC%20Keys%20is%20incompatibel%20to%20Windows%20CMS%20/%20Outlook&In-Reply-To=%3CF16E8E15-3F7C-42FD-A0A7-44856FB4CA18%40gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="011564.html">
   <LINK REL="Next"  HREF="011566.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>CMS with ECC Keys is incompatibel to Windows CMS / Outlook</H1>
    <B>Meik Kreyenkoetter</B> 
    <A HREF="mailto:openssl-users%40openssl.org?Subject=Re%3A%20CMS%20with%20ECC%20Keys%20is%20incompatibel%20to%20Windows%20CMS%20/%20Outlook&In-Reply-To=%3CF16E8E15-3F7C-42FD-A0A7-44856FB4CA18%40gmail.com%3E"
       TITLE="CMS with ECC Keys is incompatibel to Windows CMS / Outlook">meikkr at gmail.com
       </A><BR>
    <I>Fri Nov 15 16:11:20 UTC 2019</I>
    <P><UL>
        <LI>Previous message: <A HREF="011564.html">CMS with ECC Keys is incompatibel to Windows CMS / Outlook
</A></li>
        <LI>Next message: <A HREF="011566.html">How do I turn off EC point formats from showing up in TLS 1.3 client hello?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#11565">[ date ]</a>
              <a href="thread.html#11565">[ thread ]</a>
              <a href="subject.html#11565">[ subject ]</a>
              <a href="author.html#11565">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hello again,

maybe i have found the difference in the CMSes generated by OpenSSL and Windows.

This is the keyEncryptionAlgorithm in kari generated on Windows:

keyEncryptionAlgorithm:
          algorithm: dhSinglePass-stdDH-sha1kdf-scheme (1.3.133.16.840.63.0.2)
          parameter: SEQUENCE:
    0:d=0  hl=2 l=  13 cons: SEQUENCE
    2:d=1  hl=2 l=   9 prim:  OBJECT            :id-aes256-wrap
   13:d=1  hl=2 l=   0 prim:  NULL
        recipientEncryptedKeys:

This is the keyEncryptionAlgorithm in kari generated with OpenSSL:

keyEncryptionAlgorithm:
          algorithm: dhSinglePass-stdDH-sha1kdf-scheme (1.3.133.16.840.63.0.2)
          parameter: SEQUENCE:
    0:d=0  hl=2 l=  11 cons: SEQUENCE
    2:d=1  hl=2 l=   9 prim:  OBJECT            :id-aes256-wrap
        recipientEncryptedKeys:

As one can see, there is a NULL at the end of the parameter sequence generated on Windows. CMS output from BouncyCaste is like OpenSSL:

keyEncryptionAlgorithm:
          algorithm: dhSinglePass-stdDH-sha1kdf-scheme (1.3.133.16.840.63.0.2)
          parameter: SEQUENCE:
    0:d=0  hl=2 l=  11 cons: SEQUENCE
    2:d=1  hl=2 l=   9 prim:  OBJECT            :id-aes128-wrap


The BouncyCaste output is not decryptable on Windows. Is there a way generate a CMS with ECC compatible with Windows?

Meik



&gt;<i> On 15. Nov 2019, at 12:18, Meik Kreyenkoetter &lt;<A HREF="../../../mailman/listinfo/openssl-users.html">meikkr at gmail.com</A>&gt; wrote:
</I>&gt;<i> 
</I>&gt;<i> Hello,
</I>&gt;<i> 
</I>&gt;<i> when generating a CMS with OpenSSL 1.1.1d or OpenSSL 1.0.2g using only ECC Keys, Windows 10 is unable to decrypt the CMS.
</I>&gt;<i> All Passwords for keys is &quot;test&quot;.
</I>&gt;<i> 
</I>&gt;<i> Encrypting:
</I>&gt;<i> 
</I>&gt;<i> openssl cms -encrypt -outform PEM -recip bob.pem -in Test.eml -out opensslencrypted.cms -aes256 -aes128-wrap
</I>&gt;<i> 
</I>&gt;<i> Decryption on Windows 10 (with installed Keys in Store):
</I>&gt;<i> 
</I>&gt;<i> Unprotect-CmsMessage -Path .\opensslencrypted.cms
</I>&gt;<i> 
</I>&gt;<i> Unprotect-CmsMessage : Die Daten sind unzul&#228;ssig.
</I>&gt;<i> In Zeile:1 Zeichen:1
</I>&gt;<i> + Unprotect-CmsMessage -Path .\opensslencrypted.cms
</I>&gt;<i> + ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
</I>&gt;<i>    + CategoryInfo          : NotSpecified: (:) [Unprotect-CmsMessage], CryptographicException
</I>&gt;<i>    + FullyQualifiedErrorId : System.Security.Cryptography.CryptographicException,Microsoft.PowerShell.Commands.Unprot
</I>&gt;<i>   ectCmsMessageCommand
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> The file outlookencrypted.cms contains a CMS with ECC keys generated on Windows 10. It's decryptable by Windows and OpenSSL.
</I>&gt;<i> 
</I>&gt;<i> Inspecting the Windows and Openssl generated CMS, they both look ok. The only difference if have seen in CMS -print output is parameter absent in openssl generated and NULL in Windows generated:
</I>&gt;<i> 
</I>&gt;<i> OpenSSL, openssl cms -in opensslencrypted.cms -cmsout -print -inform PEM:
</I>&gt;<i> 
</I>&gt;<i>    recipientInfos:
</I>&gt;<i>      d.kari:
</I>&gt;<i>        version: 3
</I>&gt;<i>        d.originatorKey:
</I>&gt;<i>          algorithm:
</I>&gt;<i>            algorithm: id-ecPublicKey (1.2.840.10045.2.1)
</I>&gt;<i>            parameter: &lt;ABSENT&gt;
</I>&gt;<i>          publicKey:  (0 unused bits)
</I>&gt;<i> 
</I>&gt;<i> Windows generated, openssl cms -in outlookencrypted.cms -cmsout -print -inform PEM:
</I>&gt;<i> 
</I>&gt;<i> recipientInfos:
</I>&gt;<i>      d.kari:
</I>&gt;<i>        version: 3
</I>&gt;<i>        d.originatorKey:
</I>&gt;<i>          algorithm:
</I>&gt;<i>            algorithm: id-ecPublicKey (1.2.840.10045.2.1)
</I>&gt;<i>            parameter: NULL
</I>&gt;<i>          publicKey:  (0 unused bits)
</I>&gt;<i> 
</I>&gt;<i> I have changed the OpenSSL sources to include &quot;parameter: NULL&quot; in CMS generation, but that makes no difference. The CMS with changed sources is decryptable by OpenSSL, but not on Windows:
</I>&gt;<i> 
</I>&gt;<i> openssl cms -decrypt -in opensslencrypted_changed_sources.cms -inform PEM -recip bob.pem
</I>&gt;<i> 
</I>&gt;<i> I have attached all keys and output.
</I>&gt;<i> 
</I>&gt;<i> Anything i am missing here?
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> Meik
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> &lt;opensslencrypted_changed_sources.cms&gt;&lt;outlookencrypted.cms&gt;&lt;opensslencrypted.cms&gt;&lt;cacert.crt&gt;&lt;<A HREF="../../../mailman/listinfo/openssl-users.html">bob at external.com.p12</A>&gt;&lt;bob.pem&gt;&lt;bob.cer&gt;&lt;<A HREF="../../../mailman/listinfo/openssl-users.html">alice at internal.com.p12</A>&gt;&lt;alice.pem&gt;&lt;alice.cer&gt;&lt;Test.eml&gt;
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>
</PRE>




<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="011564.html">CMS with ECC Keys is incompatibel to Windows CMS / Outlook
</A></li>
	<LI>Next message: <A HREF="011566.html">How do I turn off EC point formats from showing up in TLS 1.3 client hello?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#11565">[ date ]</a>
              <a href="thread.html#11565">[ thread ]</a>
              <a href="subject.html#11565">[ subject ]</a>
              <a href="author.html#11565">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="../../../mailman/listinfo/openssl-users.html">More information about the openssl-users
mailing list</a><br>
</body></html>
