<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> openssl-users Digest, Vol 97, Issue 15
   </TITLE>
   <LINK REL="Index" HREF="https://mta.openssl.org/pipermail/openssl-users/2022-December/index.html" >
   <LINK REL="made" HREF="mailto:openssl-users%40openssl.org?Subject=Re%3A%20openssl-users%20Digest%2C%20Vol%2097%2C%20Issue%2015&In-Reply-To=%3CCACTRa%3DsZdRR9bGHesCpt%3DALcg-UC6TMqDHtTWovjkA6Q5QMn7A%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="015741.html">
   <LINK REL="Next"  HREF="015743.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>openssl-users Digest, Vol 97, Issue 15</H1>
    <B>Pierre-Luc Boily</B> 
    <A HREF="mailto:openssl-users%40openssl.org?Subject=Re%3A%20openssl-users%20Digest%2C%20Vol%2097%2C%20Issue%2015&In-Reply-To=%3CCACTRa%3DsZdRR9bGHesCpt%3DALcg-UC6TMqDHtTWovjkA6Q5QMn7A%40mail.gmail.com%3E"
       TITLE="openssl-users Digest, Vol 97, Issue 15">pierreluc.boily at gmail.com
       </A><BR>
    <I>Tue Dec 20 14:06:58 UTC 2022</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="015741.html">undefined reference to `__atomic_is_lock_free'
</A></li>
        <LI>Next message (by thread): <A HREF="015743.html">Using OpenSSL with Kernel TLS
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#15742">[ date ]</a>
              <a href="thread.html#15742">[ thread ]</a>
              <a href="subject.html#15742">[ subject ]</a>
              <a href="author.html#15742">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hello Micheal,

Thank you very much for answering all my questions.  I clearly need to go
back one step and learn more about TLS/SSL.  I quickly followed a guide to
create my key/crt/pem, while not understanding what I did..  We got the
book from Ivan Ristic at my work.  If I still have questions in a couple of
weeks, I'll come here! :)

Regards,

Pierre-Luc

Le lun. 19 d&#233;c. 2022, &#224; 03 h 01, &lt;<A HREF="../../../mailman/listinfo/openssl-users.html">openssl-users-request at openssl.org</A>&gt; a
&#233;crit :

&gt;<i> Send openssl-users mailing list submissions to
</I>&gt;<i>         <A HREF="../../../mailman/listinfo/openssl-users.html">openssl-users at openssl.org</A>
</I>&gt;<i>
</I>&gt;<i> To subscribe or unsubscribe via the World Wide Web, visit
</I>&gt;<i>         <A HREF="../../../mailman/listinfo/openssl-users.html">https://mta.openssl.org/mailman/listinfo/openssl-users</A>
</I>&gt;<i> or, via email, send a message with subject or body 'help' to
</I>&gt;<i>         <A HREF="../../../mailman/listinfo/openssl-users.html">openssl-users-request at openssl.org</A>
</I>&gt;<i>
</I>&gt;<i> You can reach the person managing the list at
</I>&gt;<i>         <A HREF="../../../mailman/listinfo/openssl-users.html">openssl-users-owner at openssl.org</A>
</I>&gt;<i>
</I>&gt;<i> When replying, please edit your Subject line so it is more specific
</I>&gt;<i> than &quot;Re: Contents of openssl-users digest...&quot;
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Today's Topics:
</I>&gt;<i>
</I>&gt;<i>    1. RE: How to fix &quot;OpenSSL failed - error:0A000086:SSL
</I>&gt;<i>       routines::certificate verify failed&quot; (Michael Wojcik)
</I>&gt;<i>    2. Re: How to fix &quot;OpenSSL failed - error:0A000086:SSL
</I>&gt;<i>       routines::certificate verify failed&quot; (von Oheimb, David)
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> ----------------------------------------------------------------------
</I>&gt;<i>
</I>&gt;<i> Message: 1
</I>&gt;<i> Date: Sun, 18 Dec 2022 19:46:51 +0000
</I>&gt;<i> From: Michael Wojcik &lt;<A HREF="../../../mailman/listinfo/openssl-users.html">Michael.Wojcik at microfocus.com</A>&gt;
</I>&gt;<i> To: &quot;<A HREF="../../../mailman/listinfo/openssl-users.html">openssl-users at openssl.org</A>&quot; &lt;<A HREF="../../../mailman/listinfo/openssl-users.html">openssl-users at openssl.org</A>&gt;
</I>&gt;<i> Cc: Pierre-Luc Boily &lt;<A HREF="../../../mailman/listinfo/openssl-users.html">pierreluc.boily at gmail.com</A>&gt;
</I>&gt;<i> Subject: RE: How to fix &quot;OpenSSL failed - error:0A000086:SSL
</I>&gt;<i>         routines::certificate verify failed&quot;
</I>&gt;<i> Message-ID:
</I>&gt;<i>         &lt;
</I>&gt;<i> <A HREF="../../../mailman/listinfo/openssl-users.html">DM6PR18MB2700C219E4ACA7C14164A37AF9E49 at DM6PR18MB2700.namprd18.prod.outlook.com</A>
</I>&gt;<i> &gt;
</I>&gt;<i>
</I>&gt;<i> Content-Type: text/plain; charset=&quot;utf-8&quot;
</I>&gt;<i>
</I>&gt;<i> Please send replies to the list, not to me directly, as a courtesy to
</I>&gt;<i> other people reading the thread and to allow them to reply to your
</I>&gt;<i> questions.
</I>&gt;<i>
</I>&gt;<i> &gt; From: Pierre-Luc Boily &lt;<A HREF="../../../mailman/listinfo/openssl-users.html">pierreluc.boily at gmail.com</A>&gt;
</I>&gt;<i> &gt; Sent: Friday, 16 December, 2022 21:10
</I>&gt;<i>
</I>&gt;<i> &gt; &gt; Your questions suggest you're not a TLS expert.
</I>&gt;<i>
</I>&gt;<i> &gt; I humbly confess that I am a total beginner!.? Reading the books you
</I>&gt;<i> proposed is absolutely
</I>&gt;<i> &gt; something we will do.? But before becoming an expert on this topic (this
</I>&gt;<i> will take some time
</I>&gt;<i> &gt; I guess), I'd like to have my c++ client working well with openSSL for
</I>&gt;<i> demo purposes
</I>&gt;<i>
</I>&gt;<i> I understand, but it may be faster to at least gain more understanding of
</I>&gt;<i> how TLS works in common cases than spend a lot of time trying to get your
</I>&gt;<i> demonstration working.
</I>&gt;<i>
</I>&gt;<i> &gt; Our project needs a key/certificate because it uses WebRTC on
</I>&gt;<i> browsers?such as chrome and
</I>&gt;<i> &gt; edge and? WebRTC is not available on a non-secure browser. We also need
</I>&gt;<i> a https/websocket
</I>&gt;<i> &gt; server.
</I>&gt;<i>
</I>&gt;<i> Is this also the server for the WebRTC connection? If not, do you have
</I>&gt;<i> control of that server, or is it a third-party server?
</I>&gt;<i>
</I>&gt;<i> &gt; As a first step, I quickly created an https/websocket server with
</I>&gt;<i> nodejs, and a React front end.?
</I>&gt;<i> &gt; I created my own SSL Certificate Authority ...  I have a .key, a .crt
</I>&gt;<i> and a .pem(my root certificate).
</I>&gt;<i>
</I>&gt;<i> Note that &quot;.key&quot; and &quot;.crt&quot; are generic file extensions which doesn't tell
</I>&gt;<i> us anything about the file format. A &quot;.key&quot; file might be PKCS#8, possibly
</I>&gt;<i> PEM-encoded, or various other things. Most often a .crt is a DER-encoded
</I>&gt;<i> certificate in PEM format (so a Base64-encoded representation of the DER
</I>&gt;<i> data, with PEM header/footer lines, and possibly other text which will be
</I>&gt;<i> ignored by decoders), but it could be binary DER or something else.
</I>&gt;<i>
</I>&gt;<i> Presumably you have a key for the root certificate you created, and a key
</I>&gt;<i> for your entity (server) certificate. Are there any intermediate
</I>&gt;<i> certificates for your CA? Viktor mentioned this in his reply but it may not
</I>&gt;<i> be clear to you. Conventional CAs do not sign entity certificates with
</I>&gt;<i> their root certificates. They sign an intermediate certificate, which may
</I>&gt;<i> be used to sign entity certificates or other intermediates.
</I>&gt;<i>
</I>&gt;<i> The &quot;certificate chain&quot; that an entity sends should usually be its entity
</I>&gt;<i> certificates plus any required intermediates, and optionally the root.
</I>&gt;<i> (Sending the root doesn't help the peer validate the certificate, because
</I>&gt;<i> the peer has to already trust the root certificate; but it can help with
</I>&gt;<i> problem investigation and resolution.)
</I>&gt;<i>
</I>&gt;<i> &gt;? I added the .pem into windows, and .key and .crt are used in my nodejs
</I>&gt;<i> server and on my html server as well.
</I>&gt;<i>
</I>&gt;<i> An entity certificate identifies the entity. Do you know your two servers
</I>&gt;<i> can both use that certificate? Are they running on the same host? Or is it
</I>&gt;<i> a wildcard certificate?
</I>&gt;<i>
</I>&gt;<i> &gt; The second step is that we have a c++ webrtc client and this client has
</I>&gt;<i> to talk with the nodejs
</I>&gt;<i> &gt; https/websocket server.? I thought that using the same key/crt would do
</I>&gt;<i> the trick.? But I have
</I>&gt;<i> &gt; the error mentioned in my first email.
</I>&gt;<i>
</I>&gt;<i> Without seeing the certificate chain and knowing how the client is trying
</I>&gt;<i> to connect, we can't do much to diagnose this. Viktor mentioned some common
</I>&gt;<i> problems. Since you control the servers, my guess is that SNI is not at
</I>&gt;<i> issue, but telling OpenSSL what you're connecting to and ensuring that
</I>&gt;<i> matches what the certificate identifies is a common problem.
</I>&gt;<i>
</I>&gt;<i> The client has to receive a certificate that matches the name it tells
</I>&gt;<i> OpenSSL it expects for the server. That means the certificate needs to have
</I>&gt;<i> a Subject Alternative Name extension that matches what the client tells
</I>&gt;<i> OpenSSL. (If the certificate lacks Subject Alternative Names, the CN of the
</I>&gt;<i> Subject DN is used, but that's deprecated.)
</I>&gt;<i>
</I>&gt;<i> Then there are quite a number of other checks which are performed,
</I>&gt;<i> including building the chain to a trust anchor (root). Your application
</I>&gt;<i> tells OpenSSL what roots it trusts, and OpenSSL needs to be able to create
</I>&gt;<i> a chain of valid certificates from the server's entity certificate to one
</I>&gt;<i> of those roots. Each certificate along the chain has to be not only the
</I>&gt;<i> appropriate certificate (i.e. sign the one before and be signed by the one
</I>&gt;<i> after, as determined by subject/issuer names or key IDs *and* by a valid
</I>&gt;<i> signature), but also be valid and have the required key-usage values and so
</I>&gt;<i> on. The full set of rules is large.
</I>&gt;<i>
</I>&gt;<i> &gt; I have 4 things I am wondering :?
</I>&gt;<i> &gt; 1. The interface I use, IXWebSockect, has?SSL_OP_NO_TLSv1_3?defined.? If
</I>&gt;<i> I understand, it means
</I>&gt;<i> &gt; OpenSSL TLS1.3.? Is this correct?? I am suspicious...
</I>&gt;<i>
</I>&gt;<i> TLSv1.3 is not an OpenSSL thing; it's a public standard. I'm not sure what
</I>&gt;<i> you mean by &quot;defined&quot;. SSL_OP_NO_TLSv1_3 is an object-type macro defined by
</I>&gt;<i> the OpenSSL API, which a caller can use to disable TLSv1.3 support for a
</I>&gt;<i> connection. Is the API you're calling actually passing that to OpenSSL
</I>&gt;<i> (e.g. with SSL_CTX_set_options)?
</I>&gt;<i>
</I>&gt;<i> In any case, it's unlikely your server only supports TLSv1.3, and the
</I>&gt;<i> error you're getting doesn't indicate a lack of matching TLS protocol
</I>&gt;<i> versions, so this doesn't appear to be an issue.
</I>&gt;<i>
</I>&gt;<i> &gt; 2. No matter the path of the key/crt I give to OpenSSL, I have the same
</I>&gt;<i> error message.? If the path doesn't exist,
</I>&gt;<i> &gt; should I expect an error message like &quot;file not found&quot;?? If yes, my
</I>&gt;<i> problem could be elsewhere...
</I>&gt;<i>
</I>&gt;<i> This is the server certificate and key? Why are you specifying those to
</I>&gt;<i> OpenSSL at all? The client does not programmatically set anything regarding
</I>&gt;<i> the server's certificate (which it normally doesn't know until the server
</I>&gt;<i> sends it), and should not have a copy of the server's key.
</I>&gt;<i>
</I>&gt;<i> &gt; 3. You used the terminology &quot;collection of trust anchors&quot;.? Is this the
</I>&gt;<i> .pem, .key and .crt???
</I>&gt;<i>
</I>&gt;<i> In your case, it's just what's in the .pem file: the root for your test
</I>&gt;<i> CA. Trust anchors are the roots you trust to &quot;anchor&quot; (terminate) a chain,
</I>&gt;<i> and possibly some intermediates that chain to some of those roots so you
</I>&gt;<i> can verify certificates that aren't sent with their complete chains.
</I>&gt;<i>
</I>&gt;<i> &gt; 4. If SSL_VERIFY_PEER is the value expected, I guess &quot;i&quot; shall be 1.?
</I>&gt;<i> So, I decided to check why i == 0,
</I>&gt;<i> &gt; and I found this in x509_vfy.c line 206:
</I>&gt;<i>
</I>&gt;<i> In my opinion, debugging into the OpenSSL implementation is very much the
</I>&gt;<i> wrong way to go. The OpenSSL implementation is not particularly easy to
</I>&gt;<i> understand, and you really want a thorough understanding of TLS, PKIX, and
</I>&gt;<i> related matters before trying to figure out what it's doing and why.
</I>&gt;<i>
</I>&gt;<i> ...
</I>&gt;<i>
</I>&gt;<i> &gt; And build_chain(ctx) bring me there (line 3166, x509_vfy.c) :?
</I>&gt;<i>
</I>&gt;<i> Have you confirmed (in the debugger) that this is the point at which
</I>&gt;<i> OpenSSL decides to reject the peer certificate? Guessing at causes by
</I>&gt;<i> looking at the code is going to be extremely inefficient.
</I>&gt;<i>
</I>&gt;<i> &gt; &quot;Untrust mimic&quot; sounds suspicious!
</I>&gt;<i>
</I>&gt;<i> &quot;Suspicious&quot; describes essentially every failed certificate check. That's
</I>&gt;<i> pretty much the entire point of TLS, and indeed all security mechanisms: to
</I>&gt;<i> be suspicious.
</I>&gt;<i>
</I>&gt;<i> --
</I>&gt;<i> Michael Wojcik
</I>&gt;<i>
</I>&gt;<i> ------------------------------
</I>&gt;<i>
</I>&gt;<i> Message: 2
</I>&gt;<i> Date: Mon, 19 Dec 2022 08:00:16 +0000
</I>&gt;<i> From: &quot;von Oheimb, David&quot; &lt;<A HREF="../../../mailman/listinfo/openssl-users.html">david.von.oheimb at siemens.com</A>&gt;
</I>&gt;<i> To: &quot;<A HREF="../../../mailman/listinfo/openssl-users.html">openssl-users at openssl.org</A>&quot; &lt;<A HREF="../../../mailman/listinfo/openssl-users.html">openssl-users at openssl.org</A>&gt;,
</I>&gt;<i>         &quot;<A HREF="../../../mailman/listinfo/openssl-users.html">Michael.Wojcik at microfocus.com</A>&quot; &lt;<A HREF="../../../mailman/listinfo/openssl-users.html">Michael.Wojcik at microfocus.com</A>&gt;,
</I>&gt;<i>         &quot;<A HREF="../../../mailman/listinfo/openssl-users.html">pierreluc.boily at gmail.com</A>&quot; &lt;<A HREF="../../../mailman/listinfo/openssl-users.html">pierreluc.boily at gmail.com</A>&gt;
</I>&gt;<i> Subject: Re: How to fix &quot;OpenSSL failed - error:0A000086:SSL
</I>&gt;<i>         routines::certificate verify failed&quot;
</I>&gt;<i> Message-ID:
</I>&gt;<i>         &lt;<A HREF="../../../mailman/listinfo/openssl-users.html">39346621914932292ce26ff0d2ea7cfff9a49b5d.camel at siemens.com</A>&gt;
</I>&gt;<i> Content-Type: text/plain; charset=&quot;utf-8&quot;
</I>&gt;<i>
</I>&gt;<i> Certificate chain building, which is part of cert chain validation, is
</I>&gt;<i> notoriously hard to debug and get right because there are so many implicit
</I>&gt;<i> things that may go wrong.
</I>&gt;<i> This holds in particular for TLS connection setup, but also for most other
</I>&gt;<i> use cases like checking at application level the signature on a document or
</I>&gt;<i> message received.
</I>&gt;<i> Unfortunately, the error messages by OpenSSL and similar libraries when
</I>&gt;<i> the chain construction fails are typically not very helpful to find out
</I>&gt;<i> where the problem(s) is/are.
</I>&gt;<i>
</I>&gt;<i> For this reason, I proposed a chain building trace feature for OpenSSL at
</I>&gt;<i> <A HREF="https://github.com/openssl/openssl/pull/18761">https://github.com/openssl/openssl/pull/18761</A> about half a year ago.
</I>&gt;<i> It shows which candidate certificates are tried at which points in which
</I>&gt;<i> order, and at which points which candidate gets ruled out for which reasons.
</I>&gt;<i> Yet the further handling got stuck because it requires some code
</I>&gt;<i> refactoring, and the respective PR
</I>&gt;<i> <A HREF="https://github.com/openssl/openssl/pull/18762">https://github.com/openssl/openssl/pull/18762</A> is still awaiting review.
</I>&gt;<i> Nevertheless, those who are able to compile OpenSSL themselves from a
</I>&gt;<i> specific branch, namely the branch given in PR 18761&lt;
</I>&gt;<i> <A HREF="https://github.com/siemens/openssl/tree/x509_trace_chain_building">https://github.com/siemens/openssl/tree/x509_trace_chain_building</A>&gt;, may
</I>&gt;<i> already make use of this.
</I>&gt;<i>
</I>&gt;<i> David
</I>&gt;<i>
</I>&gt;<i> On Sun, 2022-12-18 at 19:46 +0000, Michael Wojcik via openssl-users wrote:
</I>&gt;<i> Please send replies to the list, not to me directly, as a courtesy to
</I>&gt;<i> other people reading the thread and to allow them to reply to your
</I>&gt;<i> questions.
</I>&gt;<i>
</I>&gt;<i> From: Pierre-Luc Boily &lt;<A HREF="../../../mailman/listinfo/openssl-users.html">pierreluc.boily at gmail.com</A>&lt;mailto:
</I>&gt;<i> <A HREF="../../../mailman/listinfo/openssl-users.html">pierreluc.boily at gmail.com</A>&gt;&gt;
</I>&gt;<i> Sent: Friday, 16 December, 2022 21:10
</I>&gt;<i>
</I>&gt;<i> Your questions suggest you're not a TLS expert.
</I>&gt;<i>
</I>&gt;<i> I humbly confess that I am a total beginner!.  Reading the books you
</I>&gt;<i> proposed is absolutely
</I>&gt;<i> something we will do.  But before becoming an expert on this topic (this
</I>&gt;<i> will take some time
</I>&gt;<i> I guess), I'd like to have my c++ client working well with openSSL for
</I>&gt;<i> demo purposes
</I>&gt;<i>
</I>&gt;<i> I understand, but it may be faster to at least gain more understanding of
</I>&gt;<i> how TLS works in common cases than spend a lot of time trying to get your
</I>&gt;<i> demonstration working.
</I>&gt;<i>
</I>&gt;<i> Our project needs a key/certificate because it uses WebRTC on browsers
</I>&gt;<i> such as chrome and
</I>&gt;<i> edge and  WebRTC is not available on a non-secure browser. We also need a
</I>&gt;<i> https/websocket
</I>&gt;<i> server.
</I>&gt;<i>
</I>&gt;<i> Is this also the server for the WebRTC connection? If not, do you have
</I>&gt;<i> control of that server, or is it a third-party server?
</I>&gt;<i>
</I>&gt;<i> As a first step, I quickly created an https/websocket server with nodejs,
</I>&gt;<i> and a React front end.
</I>&gt;<i> I created my own SSL Certificate Authority ...  I have a .key, a .crt and
</I>&gt;<i> a .pem(my root certificate).
</I>&gt;<i>
</I>&gt;<i> Note that &quot;.key&quot; and &quot;.crt&quot; are generic file extensions which doesn't tell
</I>&gt;<i> us anything about the file format. A &quot;.key&quot; file might be PKCS#8, possibly
</I>&gt;<i> PEM-encoded, or various other things. Most often a .crt is a DER-encoded
</I>&gt;<i> certificate in PEM format (so a Base64-encoded representation of the DER
</I>&gt;<i> data, with PEM header/footer lines, and possibly other text which will be
</I>&gt;<i> ignored by decoders), but it could be binary DER or something else.
</I>&gt;<i>
</I>&gt;<i> Presumably you have a key for the root certificate you created, and a key
</I>&gt;<i> for your entity (server) certificate. Are there any intermediate
</I>&gt;<i> certificates for your CA? Viktor mentioned this in his reply but it may not
</I>&gt;<i> be clear to you. Conventional CAs do not sign entity certificates with
</I>&gt;<i> their root certificates. They sign an intermediate certificate, which may
</I>&gt;<i> be used to sign entity certificates or other intermediates.
</I>&gt;<i>
</I>&gt;<i> The &quot;certificate chain&quot; that an entity sends should usually be its entity
</I>&gt;<i> certificates plus any required intermediates, and optionally the root.
</I>&gt;<i> (Sending the root doesn't help the peer validate the certificate, because
</I>&gt;<i> the peer has to already trust the root certificate; but it can help with
</I>&gt;<i> problem investigation and resolution.)
</I>&gt;<i>
</I>&gt;<i>   I added the .pem into windows, and .key and .crt are used in my nodejs
</I>&gt;<i> server and on my html server as well.
</I>&gt;<i>
</I>&gt;<i> An entity certificate identifies the entity. Do you know your two servers
</I>&gt;<i> can both use that certificate? Are they running on the same host? Or is it
</I>&gt;<i> a wildcard certificate?
</I>&gt;<i>
</I>&gt;<i> The second step is that we have a c++ webrtc client and this client has to
</I>&gt;<i> talk with the nodejs
</I>&gt;<i> https/websocket server.  I thought that using the same key/crt would do
</I>&gt;<i> the trick.  But I have
</I>&gt;<i> the error mentioned in my first email.
</I>&gt;<i>
</I>&gt;<i> Without seeing the certificate chain and knowing how the client is trying
</I>&gt;<i> to connect, we can't do much to diagnose this. Viktor mentioned some common
</I>&gt;<i> problems. Since you control the servers, my guess is that SNI is not at
</I>&gt;<i> issue, but telling OpenSSL what you're connecting to and ensuring that
</I>&gt;<i> matches what the certificate identifies is a common problem.
</I>&gt;<i>
</I>&gt;<i> The client has to receive a certificate that matches the name it tells
</I>&gt;<i> OpenSSL it expects for the server. That means the certificate needs to have
</I>&gt;<i> a Subject Alternative Name extension that matches what the client tells
</I>&gt;<i> OpenSSL. (If the certificate lacks Subject Alternative Names, the CN of the
</I>&gt;<i> Subject DN is used, but that's deprecated.)
</I>&gt;<i>
</I>&gt;<i> Then there are quite a number of other checks which are performed,
</I>&gt;<i> including building the chain to a trust anchor (root). Your application
</I>&gt;<i> tells OpenSSL what roots it trusts, and OpenSSL needs to be able to create
</I>&gt;<i> a chain of valid certificates from the server's entity certificate to one
</I>&gt;<i> of those roots. Each certificate along the chain has to be not only the
</I>&gt;<i> appropriate certificate (i.e. sign the one before and be signed by the one
</I>&gt;<i> after, as determined by subject/issuer names or key IDs *and* by a valid
</I>&gt;<i> signature), but also be valid and have the required key-usage values and so
</I>&gt;<i> on. The full set of rules is large.
</I>&gt;<i>
</I>&gt;<i> I have 4 things I am wondering :
</I>&gt;<i> 1. The interface I use, IXWebSockect, has SSL_OP_NO_TLSv1_3 defined.  If I
</I>&gt;<i> understand, it means
</I>&gt;<i> OpenSSL TLS1.3.  Is this correct?  I am suspicious...
</I>&gt;<i>
</I>&gt;<i> TLSv1.3 is not an OpenSSL thing; it's a public standard. I'm not sure what
</I>&gt;<i> you mean by &quot;defined&quot;. SSL_OP_NO_TLSv1_3 is an object-type macro defined by
</I>&gt;<i> the OpenSSL API, which a caller can use to disable TLSv1.3 support for a
</I>&gt;<i> connection. Is the API you're calling actually passing that to OpenSSL
</I>&gt;<i> (e.g. with SSL_CTX_set_options)?
</I>&gt;<i>
</I>&gt;<i> In any case, it's unlikely your server only supports TLSv1.3, and the
</I>&gt;<i> error you're getting doesn't indicate a lack of matching TLS protocol
</I>&gt;<i> versions, so this doesn't appear to be an issue.
</I>&gt;<i>
</I>&gt;<i> 2. No matter the path of the key/crt I give to OpenSSL, I have the same
</I>&gt;<i> error message.  If the path doesn't exist,
</I>&gt;<i> should I expect an error message like &quot;file not found&quot;?  If yes, my
</I>&gt;<i> problem could be elsewhere...
</I>&gt;<i>
</I>&gt;<i> This is the server certificate and key? Why are you specifying those to
</I>&gt;<i> OpenSSL at all? The client does not programmatically set anything regarding
</I>&gt;<i> the server's certificate (which it normally doesn't know until the server
</I>&gt;<i> sends it), and should not have a copy of the server's key.
</I>&gt;<i>
</I>&gt;<i> 3. You used the terminology &quot;collection of trust anchors&quot;.  Is this the
</I>&gt;<i> .pem, .key and .crt?
</I>&gt;<i>
</I>&gt;<i> In your case, it's just what's in the .pem file: the root for your test
</I>&gt;<i> CA. Trust anchors are the roots you trust to &quot;anchor&quot; (terminate) a chain,
</I>&gt;<i> and possibly some intermediates that chain to some of those roots so you
</I>&gt;<i> can verify certificates that aren't sent with their complete chains.
</I>&gt;<i>
</I>&gt;<i> 4. If SSL_VERIFY_PEER is the value expected, I guess &quot;i&quot; shall be 1.  So,
</I>&gt;<i> I decided to check why i == 0,
</I>&gt;<i> and I found this in x509_vfy.c line 206:
</I>&gt;<i>
</I>&gt;<i> In my opinion, debugging into the OpenSSL implementation is very much the
</I>&gt;<i> wrong way to go. The OpenSSL implementation is not particularly easy to
</I>&gt;<i> understand, and you really want a thorough understanding of TLS, PKIX, and
</I>&gt;<i> related matters before trying to figure out what it's doing and why.
</I>&gt;<i>
</I>&gt;<i> ...
</I>&gt;<i>
</I>&gt;<i> And build_chain(ctx) bring me there (line 3166, x509_vfy.c) :
</I>&gt;<i>
</I>&gt;<i> Have you confirmed (in the debugger) that this is the point at which
</I>&gt;<i> OpenSSL decides to reject the peer certificate? Guessing at causes by
</I>&gt;<i> looking at the code is going to be extremely inefficient.
</I>&gt;<i>
</I>&gt;<i> &quot;Untrust mimic&quot; sounds suspicious!
</I>&gt;<i>
</I>&gt;<i> &quot;Suspicious&quot; describes essentially every failed certificate check. That's
</I>&gt;<i> pretty much the entire point of TLS, and indeed all security mechanisms: to
</I>&gt;<i> be suspicious.
</I>&gt;<i>
</I>&gt;<i> --
</I>&gt;<i> Michael Wojcik
</I>&gt;<i> -------------- next part --------------
</I>&gt;<i> An HTML attachment was scrubbed...
</I>&gt;<i> URL: &lt;
</I>&gt;<i> <A HREF="https://mta.openssl.org/pipermail/openssl-users/attachments/20221219/978d73ee/attachment.htm">https://mta.openssl.org/pipermail/openssl-users/attachments/20221219/978d73ee/attachment.htm</A>
</I>&gt;<i> &gt;
</I>&gt;<i>
</I>&gt;<i> ------------------------------
</I>&gt;<i>
</I>&gt;<i> Subject: Digest Footer
</I>&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> openssl-users mailing list
</I>&gt;<i> <A HREF="../../../mailman/listinfo/openssl-users.html">openssl-users at openssl.org</A>
</I>&gt;<i> <A HREF="../../../mailman/listinfo/openssl-users.html">https://mta.openssl.org/mailman/listinfo/openssl-users</A>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> ------------------------------
</I>&gt;<i>
</I>&gt;<i> End of openssl-users Digest, Vol 97, Issue 15
</I>&gt;<i> *********************************************
</I>&gt;<i>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="https://mta.openssl.org/pipermail/openssl-users/attachments/20221220/4e68cb28/attachment-0001.htm">https://mta.openssl.org/pipermail/openssl-users/attachments/20221220/4e68cb28/attachment-0001.htm</A>&gt;
</PRE>



<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="015741.html">undefined reference to `__atomic_is_lock_free'
</A></li>
	<LI>Next message (by thread): <A HREF="015743.html">Using OpenSSL with Kernel TLS
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#15742">[ date ]</a>
              <a href="thread.html#15742">[ thread ]</a>
              <a href="subject.html#15742">[ subject ]</a>
              <a href="author.html#15742">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="../../../mailman/listinfo/openssl-users.html">More information about the openssl-users
mailing list</a><br>
</body></html>
