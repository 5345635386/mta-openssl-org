<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [openssl-users] &#22238;&#22797;&#65306; [help]SSL_CTX_use_certificate_file failed!
   </TITLE>
   <LINK REL="Index" HREF="https://mta.openssl.org/pipermail/openssl-users/2016-September/index.html" >
   <LINK REL="made" HREF="mailto:openssl-users%40openssl.org?Subject=Re%3A%20%5Bopenssl-users%5D%20%3D%3Futf-8%3Fb%3F5Zue5aSN77yaIFtoZWxwXVNTTF9DVFhfdXNl%3F%3D%0A%20%3D%3Futf-8%3Fq%3F%3D5Fcertificate%3D5Ffile_failed%21%3F%3D&In-Reply-To=%3Cc5feac89-486c-4560-b9a3-62c6d7f1ab2e.zy_chongqing%40aliyun.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="004431.html">
   <LINK REL="Next"  HREF="004434.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[openssl-users] &#22238;&#22797;&#65306; [help]SSL_CTX_use_certificate_file failed!</H1>
    <B>zy_chongqing</B> 
    <A HREF="mailto:openssl-users%40openssl.org?Subject=Re%3A%20%5Bopenssl-users%5D%20%3D%3Futf-8%3Fb%3F5Zue5aSN77yaIFtoZWxwXVNTTF9DVFhfdXNl%3F%3D%0A%20%3D%3Futf-8%3Fq%3F%3D5Fcertificate%3D5Ffile_failed%21%3F%3D&In-Reply-To=%3Cc5feac89-486c-4560-b9a3-62c6d7f1ab2e.zy_chongqing%40aliyun.com%3E"
       TITLE="[openssl-users] &#22238;&#22797;&#65306; [help]SSL_CTX_use_certificate_file failed!">zy_chongqing at aliyun.com
       </A><BR>
    <I>Tue Sep 13 14:53:57 UTC 2016</I>
    <P><UL>
        <LI>Previous message: <A HREF="004431.html">[openssl-users] [help]SSL_CTX_use_certificate_file failed!
</A></li>
        <LI>Next message: <A HREF="004434.html">[openssl-users] &#22238;&#22797;&#65306; &#22238;&#22797;&#65306; [help]SSL_CTX_use_certificate_file failed!
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#4432">[ date ]</a>
              <a href="thread.html#4432">[ thread ]</a>
              <a href="subject.html#4432">[ subject ]</a>
              <a href="author.html#4432">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi Matt,
thanks for your reply. please kindly find the attached to get the certificate.
actually after i set the security level to 0, some times the result is to get the error code you read before, but some times the programe will crash directly. I checked the stack information as below:
[2016-09-13&#160;11:52:03][crash&#160;signal&#160;number:11]
0&#160;./MemoSrv()&#160;[0x808031e]
1&#160;linux-gate.so.1(__kernel_sigreturn+0)&#160;[0xb7734400]
2&#160;/lib/libpthread.so.0(pthread_rwlock_wrlock+0xf)&#160;[0xb74f45ff]
3&#160;./MemoSrv(CRYPTO_THREAD_write_lock+0x1b)&#160;[0x81783cb]
4&#160;./MemoSrv(X509_check_purpose+0x66)&#160;[0x8237756]
5&#160;./MemoSrv(X509_get_extension_flags+0x2c)&#160;[0x823794c]
6&#160;/usr/local/lib/libssl.so.1.1(+0x4dd65)&#160;[0xb76a2d65]
7&#160;/usr/local/lib/libssl.so.1.1(SSL_CTX_use_certificate+0x41)&#160;[0xb76853c1]
8&#160;/usr/local/lib/libssl.so.1.1(SSL_CTX_use_certificate_file+0xed)&#160;[0xb768553d]
9&#160;./MemoSrv()&#160;[0x80bc93b]
10&#160;./MemoSrv()&#160;[0x80bd32a]
11&#160;./MemoSrv()&#160;[0x8088dc2]
12&#160;./MemoSrv()&#160;[0x80805e8]
13&#160;/lib/libc.so.6(__libc_start_main+0xf3)&#160;[0xb738a6e3]
14&#160;./MemoSrv()&#160;[0x808010d]
If you need additional information or operation, please let me know.thanks!------------------------------------------------------------------&#21457;&#20214;&#20154;&#65306;Matt Caswell &lt;<A HREF="../../../mailman/listinfo/openssl-users.html">matt at openssl.org</A>&gt;&#21457;&#36865;&#26102;&#38388;&#65306;2016&#24180;9&#26376;13&#26085;(&#26143;&#26399;&#20108;) 22:07&#25910;&#20214;&#20154;&#65306;openssl-users &lt;<A HREF="../../../mailman/listinfo/openssl-users.html">openssl-users at openssl.org</A>&gt;&#20027;&#12288;&#39064;&#65306;Re: [openssl-users] [help]SSL_CTX_use_certificate_file failed!
Comments&#160;inserted...

On&#160;13/09/16&#160;14:17,&#160;zy_chongqing&#160;wrote:
&gt;<i>&#160;Hi,
</I>&gt;<i>&#160;
</I>&gt;<i>&#160;I&#160;have&#160;a&#160;big&#160;problem&#160;about&#160;the&#160;OpenSSL&#160;usage,&#160;please&#160;help.
</I>&gt;<i>&#160;OS:&#160;Linux&#160;version&#160;3.7.10-1.1-desktop&#160;(<A HREF="../../../mailman/listinfo/openssl-users.html">geeko at buildhost</A>)&#160;(gcc&#160;version&#160;4.7.2&#160;20130108&#160;[gcc-4_7-branch&#160;revision&#160;195012]&#160;(SUSE&#160;Linux)&#160;)&#160;#1&#160;SMP&#160;PREEMPT&#160;Thu&#160;Feb&#160;28&#160;15:06:29&#160;UTC&#160;2013&#160;(82d3f21)
</I>&gt;<i>&#160;OpenSSL&#160;version:&#160;OpenSSL&#160;1.1.0&#160;&#160;25&#160;Aug&#160;2016
</I>&gt;<i>&#160;
</I>&gt;<i>&#160;I&#160;create&#160;a&#160;OpenSSL&#160;client&#160;for&#160;iOS&#160;APNs&#160;client,&#160;the&#160;SSL&#160;initial&#160;function
</I>&gt;<i>&#160;as&#160;below:
</I>&gt;<i>&#160;#define&#160;CA_CERT_PATH&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&quot;./pem&quot;
</I>&gt;<i>&#160;#define&#160;RSA_CLIENT_CERT&#160;&#160;&#160;&#160;&#160;&quot;./pem/PushChatCert.pem&quot;
</I>&gt;<i>&#160;#define&#160;RSA_CLIENT_KEY&#160;&#160;&#160;&#160;&#160;&#160;&#160;&quot;./pem/PushChatKey.pem&quot;
</I>&gt;<i>&#160;bool&#160;CAPNSClient::InitAPNSClient()
</I>&gt;<i>&#160;{
</I>&gt;<i>&#160;&#160;&#160;&#160;&#160;SSL_library_init();
</I>&gt;<i>&#160;&#160;&#160;&#160;&#160;SSL_load_error_strings();
</I>&gt;<i>&#160;&#160;&#160;&#160;&#160;ERR_clear_error();
</I>&gt;<i>&#160;&#160;&#160;&#160;&#160;OpenSSL_add_all_algorithms();
</I>
None&#160;of&#160;the&#160;above&#160;4&#160;function&#160;calls&#160;are&#160;required&#160;in&#160;OpenSSL&#160;1.1.0.&#160;They
can&#160;be&#160;removed.&#160;That's&#160;not&#160;your&#160;problem&#160;though...


&gt;<i>&#160;&#160;
</I>&gt;<i>&#160;&#160;&#160;&#160;&#160;m_pMeth&#160;=&#160;TLS_client_method();
</I>&gt;<i>&#160;
</I>&gt;<i>&#160;&#160;&#160;&#160;&#160;m_pCtx&#160;=&#160;SSL_CTX_new(m_pMeth);
</I>&gt;<i>&#160;&#160;&#160;&#160;&#160;if(NULL&#160;==&#160;m_pCtx)
</I>&gt;<i>&#160;&#160;&#160;&#160;&#160;{
</I>&gt;<i>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;ERRLOG(&quot;Could&#160;not&#160;get&#160;SSL&#160;Context&quot;);
</I>&gt;<i>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;return&#160;false;
</I>&gt;<i>&#160;&#160;&#160;&#160;&#160;}
</I>&gt;<i>&#160;
</I>&gt;<i>&#160;&#160;&#160;&#160;&#160;if(0&#160;==&#160;SSL_CTX_load_verify_locations(m_pCtx,&#160;NULL,&#160;CA_CERT_PATH))
</I>&gt;<i>&#160;&#160;&#160;&#160;&#160;{
</I>&gt;<i>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;/*&#160;Handle&#160;failed&#160;load&#160;here&#160;*/
</I>&gt;<i>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;ERRLOG(&quot;Failed&#160;to&#160;set&#160;CA&#160;location:%s&quot;,&#160;ERR_error_string(&#160;ERR_get_error(),&#160;NULL&#160;));
</I>&gt;<i>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;return&#160;false;
</I>&gt;<i>&#160;&#160;&#160;&#160;&#160;}
</I>&gt;<i>&#160;
</I>&gt;<i>&#160;&#160;&#160;&#160;&#160;if&#160;(0&#160;==&#160;SSL_CTX_use_certificate_file(m_pCtx,&#160;RSA_CLIENT_CERT,&#160;SSL_FILETYPE_PEM))
</I>&gt;<i>&#160;&#160;&#160;&#160;&#160;{
</I>&gt;<i>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;ERRLOG(&quot;Cannot&#160;use&#160;Certificate&#160;File:%s&quot;,&#160;ERR_error_string(&#160;ERR_get_error(),&#160;NULL&#160;));
</I>&gt;<i>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;return&#160;false;
</I>&gt;<i>&#160;&#160;&#160;&#160;&#160;}
</I>&gt;<i>&#160;
</I>&gt;<i>&#160;&#160;&#160;&#160;&#160;SSL_CTX_set_default_passwd_cb_userdata(m_pCtx,&#160;(void*)&quot;XXXX&quot;);
</I>&gt;<i>&#160;
</I>&gt;<i>&#160;&#160;&#160;&#160;&#160;if&#160;(0&#160;==&#160;SSL_CTX_use_PrivateKey_file(m_pCtx,&#160;RSA_CLIENT_KEY,&#160;SSL_FILETYPE_PEM))
</I>&gt;<i>&#160;&#160;&#160;&#160;&#160;{
</I>&gt;<i>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;ERRLOG(&quot;Cannot&#160;use&#160;Private&#160;Key:%s&quot;,&#160;ERR_error_string(&#160;ERR_get_error(),&#160;NULL&#160;));
</I>&gt;<i>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;return&#160;false;
</I>&gt;<i>&#160;&#160;&#160;&#160;&#160;}
</I>&gt;<i>&#160;
</I>&gt;<i>&#160;&#160;&#160;&#160;&#160;if&#160;(0&#160;==&#160;SSL_CTX_check_private_key(m_pCtx))
</I>&gt;<i>&#160;&#160;&#160;&#160;&#160;{
</I>&gt;<i>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;ERRLOG(&quot;Private&#160;key&#160;does&#160;not&#160;match&#160;the&#160;certificate&#160;public&#160;key&quot;);
</I>&gt;<i>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;return&#160;false;
</I>&gt;<i>&#160;&#160;&#160;&#160;&#160;}
</I>&gt;<i>&#160;
</I>&gt;<i>&#160;&#160;&#160;&#160;&#160;return&#160;true;
</I>&gt;<i>&#160;}
</I>&gt;<i>&#160;
</I>&gt;<i>&#160;when&#160;the&#160;programe&#160;run,&#160;the&#160;SSL_CTX_use_certificate_file&#160;failed&#160;when&#160;load
</I>&gt;<i>&#160;the&#160;certificate&#160;as&#160;attached!&#160;the&#160;error&#160;information
</I>&gt;<i>&#160;is:&#160;&#160;error:140AB18F:SSL&#160;routines:SSL_CTX_use_certificate:ee&#160;key&#160;too&#160;small
</I>&gt;<i>&#160;
</I>&gt;<i>&#160;as&#160;the&#160;suggestion&#160;from&#160;<A HREF="../../../mailman/listinfo/openssl-users.html">rt at openssl.org</A>&#160;last&#160;night,&#160;I
</I>&gt;<i>&#160;use&#160;SSL_CTX_set_security_level(m_pCtx,&#160;0)&#160;switch&#160;the&#160;security&#160;level&#160;from
</I>&gt;<i>&#160;1&#160;to&#160;0.&#160;&#160;But&#160;SSL_CTX_use_certificate_file&#160;still&#160;failed!&#160;the&#160;log&#160;chang
</I>&gt;<i>&#160;to:&#160;error:140BF10C:SSL&#160;routines:ssl_set_cert:x509&#160;lib
</I>
As&#160;far&#160;as&#160;I&#160;can&#160;determine&#160;from&#160;the&#160;errors&#160;you&#160;are&#160;seeing,
SSL_CTX_use_certificate_file()&#160;has&#160;successfully&#160;read&#160;the&#160;certificate
file&#160;and&#160;returned&#160;a&#160;non&#160;NULL&#160;X509&#160;object&#160;(otherwise&#160;you&#160;would&#160;have&#160;seen
a&#160;different&#160;error).

Once&#160;SSL_CTX_use_certificate_file()&#160;has&#160;got&#160;an&#160;X509&#160;object&#160;it&#160;then&#160;calls
SSL_CTX_use_certificate().

This&#160;calls&#160;an&#160;internal&#160;function&#160;ssl_security_cert(),&#160;which&#160;in&#160;turn&#160;calls
ssl_security_cert_key(),&#160;which&#160;calls&#160;X509_get0_pubkey()&#160;on&#160;the&#160;supplied
X509&#160;object.&#160;*If&#160;this&#160;returns&#160;NULL*&#160;then&#160;an&#160;internal&#160;variable&#160;secbits
which&#160;represents&#160;the&#160;number&#160;of&#160;security&#160;bits&#160;in&#160;the&#160;public&#160;key&#160;is&#160;set&#160;to
-1.&#160;Subsequently&#160;various&#160;calls&#160;take&#160;place&#160;and&#160;if&#160;the&#160;number&#160;of&#160;security
bits&#160;is&#160;too&#160;small&#160;(which&#160;presumably&#160;-1&#160;is)&#160;then&#160;you&#160;get&#160;the&#160;&quot;ee&#160;key&#160;too
small&quot;&#160;error.

By&#160;setting&#160;the&#160;security&#160;level&#160;to&#160;0,&#160;the&#160;above&#160;is&#160;avoided&#160;and&#160;processing
gets&#160;further.&#160;SSL_CTX_use_certificate()&#160;next&#160;calls&#160;an&#160;internal&#160;function
ssl_set_cert().

The&#160;first&#160;thing&#160;ssl_set_cert()&#160;does&#160;is&#160;call&#160;X509_get0_pubkey()&#160;again.&#160;If
this&#160;return&#160;NULL&#160;then&#160;you&#160;get&#160;the&#160;&quot;x509&#160;lib&quot;&#160;error.

Therefore,&#160;I&#160;believe&#160;there&#160;is&#160;a&#160;problem&#160;with&#160;the&#160;X509_get0_pubkey()
call,&#160;such&#160;that&#160;it&#160;is&#160;always&#160;returning&#160;NULL&#160;for&#160;your&#160;particular
certificate.&#160;The&#160;question&#160;is&#160;why?&#160;Are&#160;you&#160;able&#160;to&#160;share&#160;the&#160;certificate
file?&#160;&#160;Are&#160;there&#160;any&#160;other&#160;errors&#160;on&#160;the&#160;error&#160;queue&#160;besides&#160;these&#160;ones?
There&#160;are&#160;a&#160;few&#160;different&#160;things&#160;that&#160;could&#160;cause&#160;this&#160;and&#160;a&#160;number&#160;of
them&#160;would&#160;add&#160;additional&#160;errors&#160;to&#160;the&#160;error&#160;queue.

Matt


--&#160;
openssl-users&#160;mailing&#160;list
To&#160;unsubscribe:&#160;<A HREF="../../../mailman/listinfo/openssl-users.html">https://mta.openssl.org/mailman/listinfo/openssl-users</A>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://mta.openssl.org/pipermail/openssl-users/attachments/20160913/be3e9f02/attachment-0001.html">http://mta.openssl.org/pipermail/openssl-users/attachments/20160913/be3e9f02/attachment-0001.html</A>&gt;
-------------- next part --------------
A non-text attachment was scrubbed...
Name: PushChatCert.pem
Type: application/octet-stream
Size: 2139 bytes
Desc: not available
URL: &lt;<A HREF="http://mta.openssl.org/pipermail/openssl-users/attachments/20160913/be3e9f02/attachment-0001.obj">http://mta.openssl.org/pipermail/openssl-users/attachments/20160913/be3e9f02/attachment-0001.obj</A>&gt;
</PRE>









<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="004431.html">[openssl-users] [help]SSL_CTX_use_certificate_file failed!
</A></li>
	<LI>Next message: <A HREF="004434.html">[openssl-users] &#22238;&#22797;&#65306; &#22238;&#22797;&#65306; [help]SSL_CTX_use_certificate_file failed!
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#4432">[ date ]</a>
              <a href="thread.html#4432">[ thread ]</a>
              <a href="subject.html#4432">[ subject ]</a>
              <a href="author.html#4432">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="../../../mailman/listinfo/openssl-users.html">More information about the openssl-users
mailing list</a><br>
</body></html>
